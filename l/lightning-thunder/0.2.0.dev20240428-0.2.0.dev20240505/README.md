# Comparing `tmp/lightning_thunder-0.2.0.dev20240428.tar.gz` & `tmp/lightning_thunder-0.2.0.dev20240505.tar.gz`

## filetype from file(1)

```diff
@@ -1 +1 @@
-gzip compressed data, was "lightning_thunder-0.2.0.dev20240428.tar", last modified: Sun Apr 28 00:20:49 2024, max compression
+gzip compressed data, was "lightning_thunder-0.2.0.dev20240505.tar", last modified: Sun May  5 00:20:32 2024, max compression
```

## Comparing `lightning_thunder-0.2.0.dev20240428.tar` & `lightning_thunder-0.2.0.dev20240505.tar`

### file list

```diff
@@ -1,101 +1,101 @@
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-04-28 00:20:49.709705 lightning_thunder-0.2.0.dev20240428/
--rw-r--r--   0 runner    (1001) docker     (127)    11357 2024-04-28 00:20:47.000000 lightning_thunder-0.2.0.dev20240428/LICENSE
--rw-r--r--   0 runner    (1001) docker     (127)      760 2024-04-28 00:20:47.000000 lightning_thunder-0.2.0.dev20240428/MANIFEST.in
--rw-r--r--   0 runner    (1001) docker     (127)    12652 2024-04-28 00:20:49.709705 lightning_thunder-0.2.0.dev20240428/PKG-INFO
--rw-r--r--   0 runner    (1001) docker     (127)     9728 2024-04-28 00:20:47.000000 lightning_thunder-0.2.0.dev20240428/README.md
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-04-28 00:20:49.705705 lightning_thunder-0.2.0.dev20240428/lightning_thunder.egg-info/
--rw-r--r--   0 runner    (1001) docker     (127)    12652 2024-04-28 00:20:49.000000 lightning_thunder-0.2.0.dev20240428/lightning_thunder.egg-info/PKG-INFO
--rw-r--r--   0 runner    (1001) docker     (127)     2438 2024-04-28 00:20:49.000000 lightning_thunder-0.2.0.dev20240428/lightning_thunder.egg-info/SOURCES.txt
--rw-r--r--   0 runner    (1001) docker     (127)        1 2024-04-28 00:20:49.000000 lightning_thunder-0.2.0.dev20240428/lightning_thunder.egg-info/dependency_links.txt
--rw-r--r--   0 runner    (1001) docker     (127)        1 2024-04-28 00:20:49.000000 lightning_thunder-0.2.0.dev20240428/lightning_thunder.egg-info/not-zip-safe
--rw-r--r--   0 runner    (1001) docker     (127)      538 2024-04-28 00:20:49.000000 lightning_thunder-0.2.0.dev20240428/lightning_thunder.egg-info/requires.txt
--rw-r--r--   0 runner    (1001) docker     (127)        8 2024-04-28 00:20:49.000000 lightning_thunder-0.2.0.dev20240428/lightning_thunder.egg-info/top_level.txt
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-04-28 00:20:49.689705 lightning_thunder-0.2.0.dev20240428/requirements/
--rw-r--r--   0 runner    (1001) docker     (127)      239 2024-04-28 00:20:47.000000 lightning_thunder-0.2.0.dev20240428/requirements/base.txt
--rw-r--r--   0 runner    (1001) docker     (127)       12 2024-04-28 00:20:47.000000 lightning_thunder-0.2.0.dev20240428/requirements/devel.txt
--rw-r--r--   0 runner    (1001) docker     (127)      485 2024-04-28 00:20:47.000000 lightning_thunder-0.2.0.dev20240428/requirements/docs.txt
--rw-r--r--   0 runner    (1001) docker     (127)      130 2024-04-28 00:20:47.000000 lightning_thunder-0.2.0.dev20240428/requirements/notebooks.txt
--rw-r--r--   0 runner    (1001) docker     (127)      836 2024-04-28 00:20:47.000000 lightning_thunder-0.2.0.dev20240428/requirements/test.txt
--rw-r--r--   0 runner    (1001) docker     (127)       38 2024-04-28 00:20:49.709705 lightning_thunder-0.2.0.dev20240428/setup.cfg
--rwxr-xr-x   0 runner    (1001) docker     (127)     5871 2024-04-28 00:20:47.000000 lightning_thunder-0.2.0.dev20240428/setup.py
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-04-28 00:20:49.689705 lightning_thunder-0.2.0.dev20240428/thunder/
--rw-r--r--   0 runner    (1001) docker     (127)      436 2024-04-28 00:20:49.000000 lightning_thunder-0.2.0.dev20240428/thunder/__about__.py
--rw-r--r--   0 runner    (1001) docker     (127)    35925 2024-04-28 00:20:47.000000 lightning_thunder-0.2.0.dev20240428/thunder/__init__.py
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-04-28 00:20:49.689705 lightning_thunder-0.2.0.dev20240428/thunder/benchmarks/
--rw-r--r--   0 runner    (1001) docker     (127)   102957 2024-04-28 00:20:47.000000 lightning_thunder-0.2.0.dev20240428/thunder/benchmarks/__init__.py
--rw-r--r--   0 runner    (1001) docker     (127)    20786 2024-04-28 00:20:47.000000 lightning_thunder-0.2.0.dev20240428/thunder/benchmarks/benchmark_litgpt.py
--rw-r--r--   0 runner    (1001) docker     (127)    20006 2024-04-28 00:20:47.000000 lightning_thunder-0.2.0.dev20240428/thunder/benchmarks/distributed.py
--rw-r--r--   0 runner    (1001) docker     (127)     3726 2024-04-28 00:20:47.000000 lightning_thunder-0.2.0.dev20240428/thunder/benchmarks/einsum.py
--rw-r--r--   0 runner    (1001) docker     (127)    28558 2024-04-28 00:20:47.000000 lightning_thunder-0.2.0.dev20240428/thunder/benchmarks/targets.py
--rw-r--r--   0 runner    (1001) docker     (127)    11181 2024-04-28 00:20:47.000000 lightning_thunder-0.2.0.dev20240428/thunder/benchmarks/test_benchmark_litgpt.py
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-04-28 00:20:49.689705 lightning_thunder-0.2.0.dev20240428/thunder/clang/
--rw-r--r--   0 runner    (1001) docker     (127)    63993 2024-04-28 00:20:47.000000 lightning_thunder-0.2.0.dev20240428/thunder/clang/__init__.py
--rw-r--r--   0 runner    (1001) docker     (127)     2516 2024-04-28 00:20:47.000000 lightning_thunder-0.2.0.dev20240428/thunder/clang/langctx.py
--rw-r--r--   0 runner    (1001) docker     (127)    30802 2024-04-28 00:20:47.000000 lightning_thunder-0.2.0.dev20240428/thunder/common.py
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-04-28 00:20:49.697705 lightning_thunder-0.2.0.dev20240428/thunder/core/
--rw-r--r--   0 runner    (1001) docker     (127)        0 2024-04-28 00:20:47.000000 lightning_thunder-0.2.0.dev20240428/thunder/core/__init__.py
--rw-r--r--   0 runner    (1001) docker     (127)    14981 2024-04-28 00:20:47.000000 lightning_thunder-0.2.0.dev20240428/thunder/core/baseutils.py
--rw-r--r--   0 runner    (1001) docker     (127)    13335 2024-04-28 00:20:47.000000 lightning_thunder-0.2.0.dev20240428/thunder/core/codeutils.py
--rw-r--r--   0 runner    (1001) docker     (127)     2139 2024-04-28 00:20:47.000000 lightning_thunder-0.2.0.dev20240428/thunder/core/compile_data.py
--rw-r--r--   0 runner    (1001) docker     (127)     6058 2024-04-28 00:20:47.000000 lightning_thunder-0.2.0.dev20240428/thunder/core/devices.py
--rw-r--r--   0 runner    (1001) docker     (127)    17106 2024-04-28 00:20:47.000000 lightning_thunder-0.2.0.dev20240428/thunder/core/dtypes.py
--rw-r--r--   0 runner    (1001) docker     (127)   256121 2024-04-28 00:20:47.000000 lightning_thunder-0.2.0.dev20240428/thunder/core/interpreter.py
--rw-r--r--   0 runner    (1001) docker     (127)    57373 2024-04-28 00:20:47.000000 lightning_thunder-0.2.0.dev20240428/thunder/core/jit_ext.py
--rw-r--r--   0 runner    (1001) docker     (127)     4146 2024-04-28 00:20:47.000000 lightning_thunder-0.2.0.dev20240428/thunder/core/langctxs.py
--rw-r--r--   0 runner    (1001) docker     (127)     7046 2024-04-28 00:20:47.000000 lightning_thunder-0.2.0.dev20240428/thunder/core/options.py
--rw-r--r--   0 runner    (1001) docker     (127)    14058 2024-04-28 00:20:47.000000 lightning_thunder-0.2.0.dev20240428/thunder/core/patterns.py
--rw-r--r--   0 runner    (1001) docker     (127)   118947 2024-04-28 00:20:47.000000 lightning_thunder-0.2.0.dev20240428/thunder/core/prims.py
--rw-r--r--   0 runner    (1001) docker     (127)      629 2024-04-28 00:20:47.000000 lightning_thunder-0.2.0.dev20240428/thunder/core/profile.py
--rw-r--r--   0 runner    (1001) docker     (127)    48867 2024-04-28 00:20:47.000000 lightning_thunder-0.2.0.dev20240428/thunder/core/proxies.py
--rw-r--r--   0 runner    (1001) docker     (127)      731 2024-04-28 00:20:47.000000 lightning_thunder-0.2.0.dev20240428/thunder/core/pytree.py
--rw-r--r--   0 runner    (1001) docker     (127)    28170 2024-04-28 00:20:47.000000 lightning_thunder-0.2.0.dev20240428/thunder/core/rematerialization.py
--rw-r--r--   0 runner    (1001) docker     (127)    25979 2024-04-28 00:20:47.000000 lightning_thunder-0.2.0.dev20240428/thunder/core/symbol.py
--rw-r--r--   0 runner    (1001) docker     (127)    20436 2024-04-28 00:20:47.000000 lightning_thunder-0.2.0.dev20240428/thunder/core/trace.py
--rw-r--r--   0 runner    (1001) docker     (127)    10446 2024-04-28 00:20:47.000000 lightning_thunder-0.2.0.dev20240428/thunder/core/transform_common.py
--rw-r--r--   0 runner    (1001) docker     (127)   140414 2024-04-28 00:20:47.000000 lightning_thunder-0.2.0.dev20240428/thunder/core/transforms.py
--rw-r--r--   0 runner    (1001) docker     (127)    37010 2024-04-28 00:20:47.000000 lightning_thunder-0.2.0.dev20240428/thunder/core/utils.py
--rw-r--r--   0 runner    (1001) docker     (127)     7708 2024-04-28 00:20:47.000000 lightning_thunder-0.2.0.dev20240428/thunder/core/vjp_utils.py
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-04-28 00:20:49.697705 lightning_thunder-0.2.0.dev20240428/thunder/cudagraphs/
--rw-r--r--   0 runner    (1001) docker     (127)     5265 2024-04-28 00:20:47.000000 lightning_thunder-0.2.0.dev20240428/thunder/cudagraphs/__init__.py
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-04-28 00:20:49.697705 lightning_thunder-0.2.0.dev20240428/thunder/distributed/
--rw-r--r--   0 runner    (1001) docker     (127)    17879 2024-04-28 00:20:47.000000 lightning_thunder-0.2.0.dev20240428/thunder/distributed/__init__.py
--rw-r--r--   0 runner    (1001) docker     (127)     7100 2024-04-28 00:20:47.000000 lightning_thunder-0.2.0.dev20240428/thunder/distributed/bucketing.py
--rw-r--r--   0 runner    (1001) docker     (127)     9307 2024-04-28 00:20:47.000000 lightning_thunder-0.2.0.dev20240428/thunder/distributed/checkpoint.py
--rw-r--r--   0 runner    (1001) docker     (127)    10906 2024-04-28 00:20:47.000000 lightning_thunder-0.2.0.dev20240428/thunder/distributed/prims.py
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-04-28 00:20:49.697705 lightning_thunder-0.2.0.dev20240428/thunder/distributed/transforms/
--rw-r--r--   0 runner    (1001) docker     (127)      310 2024-04-28 00:20:47.000000 lightning_thunder-0.2.0.dev20240428/thunder/distributed/transforms/__init__.py
--rw-r--r--   0 runner    (1001) docker     (127)     8449 2024-04-28 00:20:47.000000 lightning_thunder-0.2.0.dev20240428/thunder/distributed/transforms/ddp.py
--rw-r--r--   0 runner    (1001) docker     (127)    28416 2024-04-28 00:20:47.000000 lightning_thunder-0.2.0.dev20240428/thunder/distributed/transforms/fsdp.py
--rw-r--r--   0 runner    (1001) docker     (127)    10897 2024-04-28 00:20:47.000000 lightning_thunder-0.2.0.dev20240428/thunder/distributed/utils.py
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-04-28 00:20:49.697705 lightning_thunder-0.2.0.dev20240428/thunder/examine/
--rw-r--r--   0 runner    (1001) docker     (127)     8681 2024-04-28 00:20:47.000000 lightning_thunder-0.2.0.dev20240428/thunder/examine/__init__.py
--rw-r--r--   0 runner    (1001) docker     (127)     5761 2024-04-28 00:20:47.000000 lightning_thunder-0.2.0.dev20240428/thunder/examine/memory_caculation.py
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-04-28 00:20:49.701705 lightning_thunder-0.2.0.dev20240428/thunder/executors/
--rw-r--r--   0 runner    (1001) docker     (127)      598 2024-04-28 00:20:47.000000 lightning_thunder-0.2.0.dev20240428/thunder/executors/__init__.py
--rw-r--r--   0 runner    (1001) docker     (127)     7092 2024-04-28 00:20:47.000000 lightning_thunder-0.2.0.dev20240428/thunder/executors/apex_entropyex.py
--rw-r--r--   0 runner    (1001) docker     (127)     4558 2024-04-28 00:20:47.000000 lightning_thunder-0.2.0.dev20240428/thunder/executors/cudnn_layernormex.py
--rw-r--r--   0 runner    (1001) docker     (127)    24237 2024-04-28 00:20:47.000000 lightning_thunder-0.2.0.dev20240428/thunder/executors/cudnnex.py
--rw-r--r--   0 runner    (1001) docker     (127)    10546 2024-04-28 00:20:47.000000 lightning_thunder-0.2.0.dev20240428/thunder/executors/data_dependent_partition.py
--rw-r--r--   0 runner    (1001) docker     (127)     1085 2024-04-28 00:20:47.000000 lightning_thunder-0.2.0.dev20240428/thunder/executors/nvfuserex.py
--rw-r--r--   0 runner    (1001) docker     (127)    74208 2024-04-28 00:20:47.000000 lightning_thunder-0.2.0.dev20240428/thunder/executors/nvfuserex_impl.py
--rw-r--r--   0 runner    (1001) docker     (127)    10861 2024-04-28 00:20:47.000000 lightning_thunder-0.2.0.dev20240428/thunder/executors/passes.py
--rw-r--r--   0 runner    (1001) docker     (127)    13938 2024-04-28 00:20:47.000000 lightning_thunder-0.2.0.dev20240428/thunder/executors/pythonex.py
--rw-r--r--   0 runner    (1001) docker     (127)    26538 2024-04-28 00:20:47.000000 lightning_thunder-0.2.0.dev20240428/thunder/executors/sdpaex.py
--rw-r--r--   0 runner    (1001) docker     (127)    10395 2024-04-28 00:20:47.000000 lightning_thunder-0.2.0.dev20240428/thunder/executors/torch_autograd.py
--rw-r--r--   0 runner    (1001) docker     (127)     8420 2024-04-28 00:20:47.000000 lightning_thunder-0.2.0.dev20240428/thunder/executors/torch_compile.py
--rw-r--r--   0 runner    (1001) docker     (127)    82438 2024-04-28 00:20:47.000000 lightning_thunder-0.2.0.dev20240428/thunder/executors/torchex.py
--rw-r--r--   0 runner    (1001) docker     (127)    25646 2024-04-28 00:20:47.000000 lightning_thunder-0.2.0.dev20240428/thunder/executors/transformer_engineex.py
--rw-r--r--   0 runner    (1001) docker     (127)      326 2024-04-28 00:20:47.000000 lightning_thunder-0.2.0.dev20240428/thunder/executors/triton_crossentropy.py
--rw-r--r--   0 runner    (1001) docker     (127)    19675 2024-04-28 00:20:47.000000 lightning_thunder-0.2.0.dev20240428/thunder/executors/triton_crossentropy_impl.py
--rw-r--r--   0 runner    (1001) docker     (127)      443 2024-04-28 00:20:47.000000 lightning_thunder-0.2.0.dev20240428/thunder/executors/triton_utils.py
--rw-r--r--   0 runner    (1001) docker     (127)     2646 2024-04-28 00:20:47.000000 lightning_thunder-0.2.0.dev20240428/thunder/executors/utils.py
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-04-28 00:20:49.701705 lightning_thunder-0.2.0.dev20240428/thunder/extend/
--rw-r--r--   0 runner    (1001) docker     (127)    15699 2024-04-28 00:20:47.000000 lightning_thunder-0.2.0.dev20240428/thunder/extend/__init__.py
--rw-r--r--   0 runner    (1001) docker     (127)    17149 2024-04-28 00:20:47.000000 lightning_thunder-0.2.0.dev20240428/thunder/functional.py
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-04-28 00:20:49.705705 lightning_thunder-0.2.0.dev20240428/thunder/numpy/
--rw-r--r--   0 runner    (1001) docker     (127)     1652 2024-04-28 00:20:47.000000 lightning_thunder-0.2.0.dev20240428/thunder/numpy/__init__.py
--rw-r--r--   0 runner    (1001) docker     (127)     2554 2024-04-28 00:20:47.000000 lightning_thunder-0.2.0.dev20240428/thunder/numpy/langctx.py
--rw-r--r--   0 runner    (1001) docker     (127)        0 2024-04-28 00:20:47.000000 lightning_thunder-0.2.0.dev20240428/thunder/py.typed
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-04-28 00:20:49.705705 lightning_thunder-0.2.0.dev20240428/thunder/torch/
--rw-r--r--   0 runner    (1001) docker     (127)   153180 2024-04-28 00:20:47.000000 lightning_thunder-0.2.0.dev20240428/thunder/torch/__init__.py
--rw-r--r--   0 runner    (1001) docker     (127)     2879 2024-04-28 00:20:47.000000 lightning_thunder-0.2.0.dev20240428/thunder/torch/langctx.py
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-05 00:20:32.278033 lightning_thunder-0.2.0.dev20240505/
+-rw-r--r--   0 runner    (1001) docker     (127)    11357 2024-05-05 00:20:25.000000 lightning_thunder-0.2.0.dev20240505/LICENSE
+-rw-r--r--   0 runner    (1001) docker     (127)      760 2024-05-05 00:20:25.000000 lightning_thunder-0.2.0.dev20240505/MANIFEST.in
+-rw-r--r--   0 runner    (1001) docker     (127)    12652 2024-05-05 00:20:32.278033 lightning_thunder-0.2.0.dev20240505/PKG-INFO
+-rw-r--r--   0 runner    (1001) docker     (127)     9728 2024-05-05 00:20:25.000000 lightning_thunder-0.2.0.dev20240505/README.md
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-05 00:20:32.274033 lightning_thunder-0.2.0.dev20240505/lightning_thunder.egg-info/
+-rw-r--r--   0 runner    (1001) docker     (127)    12652 2024-05-05 00:20:32.000000 lightning_thunder-0.2.0.dev20240505/lightning_thunder.egg-info/PKG-INFO
+-rw-r--r--   0 runner    (1001) docker     (127)     2438 2024-05-05 00:20:32.000000 lightning_thunder-0.2.0.dev20240505/lightning_thunder.egg-info/SOURCES.txt
+-rw-r--r--   0 runner    (1001) docker     (127)        1 2024-05-05 00:20:32.000000 lightning_thunder-0.2.0.dev20240505/lightning_thunder.egg-info/dependency_links.txt
+-rw-r--r--   0 runner    (1001) docker     (127)        1 2024-05-05 00:20:32.000000 lightning_thunder-0.2.0.dev20240505/lightning_thunder.egg-info/not-zip-safe
+-rw-r--r--   0 runner    (1001) docker     (127)      538 2024-05-05 00:20:32.000000 lightning_thunder-0.2.0.dev20240505/lightning_thunder.egg-info/requires.txt
+-rw-r--r--   0 runner    (1001) docker     (127)        8 2024-05-05 00:20:32.000000 lightning_thunder-0.2.0.dev20240505/lightning_thunder.egg-info/top_level.txt
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-05 00:20:32.262033 lightning_thunder-0.2.0.dev20240505/requirements/
+-rw-r--r--   0 runner    (1001) docker     (127)      239 2024-05-05 00:20:25.000000 lightning_thunder-0.2.0.dev20240505/requirements/base.txt
+-rw-r--r--   0 runner    (1001) docker     (127)       12 2024-05-05 00:20:25.000000 lightning_thunder-0.2.0.dev20240505/requirements/devel.txt
+-rw-r--r--   0 runner    (1001) docker     (127)      485 2024-05-05 00:20:25.000000 lightning_thunder-0.2.0.dev20240505/requirements/docs.txt
+-rw-r--r--   0 runner    (1001) docker     (127)      130 2024-05-05 00:20:25.000000 lightning_thunder-0.2.0.dev20240505/requirements/notebooks.txt
+-rw-r--r--   0 runner    (1001) docker     (127)      836 2024-05-05 00:20:25.000000 lightning_thunder-0.2.0.dev20240505/requirements/test.txt
+-rw-r--r--   0 runner    (1001) docker     (127)       38 2024-05-05 00:20:32.278033 lightning_thunder-0.2.0.dev20240505/setup.cfg
+-rwxr-xr-x   0 runner    (1001) docker     (127)     5871 2024-05-05 00:20:25.000000 lightning_thunder-0.2.0.dev20240505/setup.py
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-05 00:20:32.262033 lightning_thunder-0.2.0.dev20240505/thunder/
+-rw-r--r--   0 runner    (1001) docker     (127)      436 2024-05-05 00:20:32.000000 lightning_thunder-0.2.0.dev20240505/thunder/__about__.py
+-rw-r--r--   0 runner    (1001) docker     (127)    36220 2024-05-05 00:20:25.000000 lightning_thunder-0.2.0.dev20240505/thunder/__init__.py
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-05 00:20:32.266033 lightning_thunder-0.2.0.dev20240505/thunder/benchmarks/
+-rw-r--r--   0 runner    (1001) docker     (127)   102663 2024-05-05 00:20:25.000000 lightning_thunder-0.2.0.dev20240505/thunder/benchmarks/__init__.py
+-rw-r--r--   0 runner    (1001) docker     (127)    21472 2024-05-05 00:20:25.000000 lightning_thunder-0.2.0.dev20240505/thunder/benchmarks/benchmark_litgpt.py
+-rw-r--r--   0 runner    (1001) docker     (127)    20006 2024-05-05 00:20:25.000000 lightning_thunder-0.2.0.dev20240505/thunder/benchmarks/distributed.py
+-rw-r--r--   0 runner    (1001) docker     (127)     3730 2024-05-05 00:20:25.000000 lightning_thunder-0.2.0.dev20240505/thunder/benchmarks/einsum.py
+-rw-r--r--   0 runner    (1001) docker     (127)    28582 2024-05-05 00:20:25.000000 lightning_thunder-0.2.0.dev20240505/thunder/benchmarks/targets.py
+-rw-r--r--   0 runner    (1001) docker     (127)    11181 2024-05-05 00:20:25.000000 lightning_thunder-0.2.0.dev20240505/thunder/benchmarks/test_benchmark_litgpt.py
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-05 00:20:32.266033 lightning_thunder-0.2.0.dev20240505/thunder/clang/
+-rw-r--r--   0 runner    (1001) docker     (127)    63993 2024-05-05 00:20:25.000000 lightning_thunder-0.2.0.dev20240505/thunder/clang/__init__.py
+-rw-r--r--   0 runner    (1001) docker     (127)     2516 2024-05-05 00:20:25.000000 lightning_thunder-0.2.0.dev20240505/thunder/clang/langctx.py
+-rw-r--r--   0 runner    (1001) docker     (127)    30602 2024-05-05 00:20:25.000000 lightning_thunder-0.2.0.dev20240505/thunder/common.py
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-05 00:20:32.270033 lightning_thunder-0.2.0.dev20240505/thunder/core/
+-rw-r--r--   0 runner    (1001) docker     (127)        0 2024-05-05 00:20:25.000000 lightning_thunder-0.2.0.dev20240505/thunder/core/__init__.py
+-rw-r--r--   0 runner    (1001) docker     (127)    14981 2024-05-05 00:20:25.000000 lightning_thunder-0.2.0.dev20240505/thunder/core/baseutils.py
+-rw-r--r--   0 runner    (1001) docker     (127)    13335 2024-05-05 00:20:25.000000 lightning_thunder-0.2.0.dev20240505/thunder/core/codeutils.py
+-rw-r--r--   0 runner    (1001) docker     (127)     2139 2024-05-05 00:20:25.000000 lightning_thunder-0.2.0.dev20240505/thunder/core/compile_data.py
+-rw-r--r--   0 runner    (1001) docker     (127)     6058 2024-05-05 00:20:25.000000 lightning_thunder-0.2.0.dev20240505/thunder/core/devices.py
+-rw-r--r--   0 runner    (1001) docker     (127)    17106 2024-05-05 00:20:25.000000 lightning_thunder-0.2.0.dev20240505/thunder/core/dtypes.py
+-rw-r--r--   0 runner    (1001) docker     (127)   256121 2024-05-05 00:20:25.000000 lightning_thunder-0.2.0.dev20240505/thunder/core/interpreter.py
+-rw-r--r--   0 runner    (1001) docker     (127)    56936 2024-05-05 00:20:25.000000 lightning_thunder-0.2.0.dev20240505/thunder/core/jit_ext.py
+-rw-r--r--   0 runner    (1001) docker     (127)     4146 2024-05-05 00:20:25.000000 lightning_thunder-0.2.0.dev20240505/thunder/core/langctxs.py
+-rw-r--r--   0 runner    (1001) docker     (127)     7046 2024-05-05 00:20:25.000000 lightning_thunder-0.2.0.dev20240505/thunder/core/options.py
+-rw-r--r--   0 runner    (1001) docker     (127)    14058 2024-05-05 00:20:25.000000 lightning_thunder-0.2.0.dev20240505/thunder/core/patterns.py
+-rw-r--r--   0 runner    (1001) docker     (127)   118947 2024-05-05 00:20:25.000000 lightning_thunder-0.2.0.dev20240505/thunder/core/prims.py
+-rw-r--r--   0 runner    (1001) docker     (127)      629 2024-05-05 00:20:25.000000 lightning_thunder-0.2.0.dev20240505/thunder/core/profile.py
+-rw-r--r--   0 runner    (1001) docker     (127)    48867 2024-05-05 00:20:25.000000 lightning_thunder-0.2.0.dev20240505/thunder/core/proxies.py
+-rw-r--r--   0 runner    (1001) docker     (127)      731 2024-05-05 00:20:25.000000 lightning_thunder-0.2.0.dev20240505/thunder/core/pytree.py
+-rw-r--r--   0 runner    (1001) docker     (127)    28189 2024-05-05 00:20:25.000000 lightning_thunder-0.2.0.dev20240505/thunder/core/rematerialization.py
+-rw-r--r--   0 runner    (1001) docker     (127)    25979 2024-05-05 00:20:25.000000 lightning_thunder-0.2.0.dev20240505/thunder/core/symbol.py
+-rw-r--r--   0 runner    (1001) docker     (127)    20436 2024-05-05 00:20:25.000000 lightning_thunder-0.2.0.dev20240505/thunder/core/trace.py
+-rw-r--r--   0 runner    (1001) docker     (127)    10446 2024-05-05 00:20:25.000000 lightning_thunder-0.2.0.dev20240505/thunder/core/transform_common.py
+-rw-r--r--   0 runner    (1001) docker     (127)   140193 2024-05-05 00:20:25.000000 lightning_thunder-0.2.0.dev20240505/thunder/core/transforms.py
+-rw-r--r--   0 runner    (1001) docker     (127)    37010 2024-05-05 00:20:25.000000 lightning_thunder-0.2.0.dev20240505/thunder/core/utils.py
+-rw-r--r--   0 runner    (1001) docker     (127)     7708 2024-05-05 00:20:25.000000 lightning_thunder-0.2.0.dev20240505/thunder/core/vjp_utils.py
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-05 00:20:32.270033 lightning_thunder-0.2.0.dev20240505/thunder/cudagraphs/
+-rw-r--r--   0 runner    (1001) docker     (127)     5265 2024-05-05 00:20:25.000000 lightning_thunder-0.2.0.dev20240505/thunder/cudagraphs/__init__.py
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-05 00:20:32.270033 lightning_thunder-0.2.0.dev20240505/thunder/distributed/
+-rw-r--r--   0 runner    (1001) docker     (127)    19356 2024-05-05 00:20:25.000000 lightning_thunder-0.2.0.dev20240505/thunder/distributed/__init__.py
+-rw-r--r--   0 runner    (1001) docker     (127)     7100 2024-05-05 00:20:25.000000 lightning_thunder-0.2.0.dev20240505/thunder/distributed/bucketing.py
+-rw-r--r--   0 runner    (1001) docker     (127)     9307 2024-05-05 00:20:25.000000 lightning_thunder-0.2.0.dev20240505/thunder/distributed/checkpoint.py
+-rw-r--r--   0 runner    (1001) docker     (127)    11709 2024-05-05 00:20:25.000000 lightning_thunder-0.2.0.dev20240505/thunder/distributed/prims.py
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-05 00:20:32.270033 lightning_thunder-0.2.0.dev20240505/thunder/distributed/transforms/
+-rw-r--r--   0 runner    (1001) docker     (127)      310 2024-05-05 00:20:25.000000 lightning_thunder-0.2.0.dev20240505/thunder/distributed/transforms/__init__.py
+-rw-r--r--   0 runner    (1001) docker     (127)    10320 2024-05-05 00:20:25.000000 lightning_thunder-0.2.0.dev20240505/thunder/distributed/transforms/ddp.py
+-rw-r--r--   0 runner    (1001) docker     (127)    33925 2024-05-05 00:20:25.000000 lightning_thunder-0.2.0.dev20240505/thunder/distributed/transforms/fsdp.py
+-rw-r--r--   0 runner    (1001) docker     (127)    10897 2024-05-05 00:20:25.000000 lightning_thunder-0.2.0.dev20240505/thunder/distributed/utils.py
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-05 00:20:32.270033 lightning_thunder-0.2.0.dev20240505/thunder/examine/
+-rw-r--r--   0 runner    (1001) docker     (127)     8681 2024-05-05 00:20:25.000000 lightning_thunder-0.2.0.dev20240505/thunder/examine/__init__.py
+-rw-r--r--   0 runner    (1001) docker     (127)     5761 2024-05-05 00:20:25.000000 lightning_thunder-0.2.0.dev20240505/thunder/examine/memory_caculation.py
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-05 00:20:32.274033 lightning_thunder-0.2.0.dev20240505/thunder/executors/
+-rw-r--r--   0 runner    (1001) docker     (127)      598 2024-05-05 00:20:25.000000 lightning_thunder-0.2.0.dev20240505/thunder/executors/__init__.py
+-rw-r--r--   0 runner    (1001) docker     (127)     7092 2024-05-05 00:20:25.000000 lightning_thunder-0.2.0.dev20240505/thunder/executors/apex_entropyex.py
+-rw-r--r--   0 runner    (1001) docker     (127)     4558 2024-05-05 00:20:25.000000 lightning_thunder-0.2.0.dev20240505/thunder/executors/cudnn_layernormex.py
+-rw-r--r--   0 runner    (1001) docker     (127)    24237 2024-05-05 00:20:25.000000 lightning_thunder-0.2.0.dev20240505/thunder/executors/cudnnex.py
+-rw-r--r--   0 runner    (1001) docker     (127)    10546 2024-05-05 00:20:25.000000 lightning_thunder-0.2.0.dev20240505/thunder/executors/data_dependent_partition.py
+-rw-r--r--   0 runner    (1001) docker     (127)     1086 2024-05-05 00:20:25.000000 lightning_thunder-0.2.0.dev20240505/thunder/executors/nvfuserex.py
+-rw-r--r--   0 runner    (1001) docker     (127)    75941 2024-05-05 00:20:25.000000 lightning_thunder-0.2.0.dev20240505/thunder/executors/nvfuserex_impl.py
+-rw-r--r--   0 runner    (1001) docker     (127)    10861 2024-05-05 00:20:25.000000 lightning_thunder-0.2.0.dev20240505/thunder/executors/passes.py
+-rw-r--r--   0 runner    (1001) docker     (127)    13938 2024-05-05 00:20:25.000000 lightning_thunder-0.2.0.dev20240505/thunder/executors/pythonex.py
+-rw-r--r--   0 runner    (1001) docker     (127)    26538 2024-05-05 00:20:25.000000 lightning_thunder-0.2.0.dev20240505/thunder/executors/sdpaex.py
+-rw-r--r--   0 runner    (1001) docker     (127)    11133 2024-05-05 00:20:25.000000 lightning_thunder-0.2.0.dev20240505/thunder/executors/torch_autograd.py
+-rw-r--r--   0 runner    (1001) docker     (127)     9587 2024-05-05 00:20:25.000000 lightning_thunder-0.2.0.dev20240505/thunder/executors/torch_compile.py
+-rw-r--r--   0 runner    (1001) docker     (127)    83372 2024-05-05 00:20:25.000000 lightning_thunder-0.2.0.dev20240505/thunder/executors/torchex.py
+-rw-r--r--   0 runner    (1001) docker     (127)    25646 2024-05-05 00:20:25.000000 lightning_thunder-0.2.0.dev20240505/thunder/executors/transformer_engineex.py
+-rw-r--r--   0 runner    (1001) docker     (127)      326 2024-05-05 00:20:25.000000 lightning_thunder-0.2.0.dev20240505/thunder/executors/triton_crossentropy.py
+-rw-r--r--   0 runner    (1001) docker     (127)    19675 2024-05-05 00:20:25.000000 lightning_thunder-0.2.0.dev20240505/thunder/executors/triton_crossentropy_impl.py
+-rw-r--r--   0 runner    (1001) docker     (127)      443 2024-05-05 00:20:25.000000 lightning_thunder-0.2.0.dev20240505/thunder/executors/triton_utils.py
+-rw-r--r--   0 runner    (1001) docker     (127)     2646 2024-05-05 00:20:25.000000 lightning_thunder-0.2.0.dev20240505/thunder/executors/utils.py
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-05 00:20:32.274033 lightning_thunder-0.2.0.dev20240505/thunder/extend/
+-rw-r--r--   0 runner    (1001) docker     (127)    15579 2024-05-05 00:20:25.000000 lightning_thunder-0.2.0.dev20240505/thunder/extend/__init__.py
+-rw-r--r--   0 runner    (1001) docker     (127)    17149 2024-05-05 00:20:25.000000 lightning_thunder-0.2.0.dev20240505/thunder/functional.py
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-05 00:20:32.274033 lightning_thunder-0.2.0.dev20240505/thunder/numpy/
+-rw-r--r--   0 runner    (1001) docker     (127)     1652 2024-05-05 00:20:25.000000 lightning_thunder-0.2.0.dev20240505/thunder/numpy/__init__.py
+-rw-r--r--   0 runner    (1001) docker     (127)     2554 2024-05-05 00:20:25.000000 lightning_thunder-0.2.0.dev20240505/thunder/numpy/langctx.py
+-rw-r--r--   0 runner    (1001) docker     (127)        0 2024-05-05 00:20:25.000000 lightning_thunder-0.2.0.dev20240505/thunder/py.typed
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-05 00:20:32.274033 lightning_thunder-0.2.0.dev20240505/thunder/torch/
+-rw-r--r--   0 runner    (1001) docker     (127)   153180 2024-05-05 00:20:25.000000 lightning_thunder-0.2.0.dev20240505/thunder/torch/__init__.py
+-rw-r--r--   0 runner    (1001) docker     (127)     2879 2024-05-05 00:20:25.000000 lightning_thunder-0.2.0.dev20240505/thunder/torch/langctx.py
```

### Comparing `lightning_thunder-0.2.0.dev20240428/LICENSE` & `lightning_thunder-0.2.0.dev20240505/LICENSE`

 * *Files identical despite different names*

### Comparing `lightning_thunder-0.2.0.dev20240428/MANIFEST.in` & `lightning_thunder-0.2.0.dev20240505/MANIFEST.in`

 * *Files identical despite different names*

### Comparing `lightning_thunder-0.2.0.dev20240428/PKG-INFO` & `lightning_thunder-0.2.0.dev20240505/PKG-INFO`

 * *Files 2% similar despite different names*

```diff
@@ -1,10 +1,10 @@
 Metadata-Version: 2.1
 Name: lightning-thunder
-Version: 0.2.0.dev20240428
+Version: 0.2.0.dev20240505
 Summary: Lightning Thunder project.
 Home-page: https://github.com/Lightning-AI/lightning-thunder
 Download-URL: https://github.com/Lightning-AI/lightning-thunder
 Author: Lightning-AI et al
 Author-email: community@lightning.ai
 License: Apache 2.0
 Project-URL: Bug Tracker, https://github.com/Lightning-AI/lightning-thunder/issues
@@ -54,16 +54,16 @@
 Requires-Dist: pytest==8.1.1; extra == "test"
 Requires-Dist: xlsxwriter; extra == "test"
 Provides-Extra: notebooks
 Requires-Dist: cuda-python; extra == "notebooks"
 Requires-Dist: ipython[all]==8.23.0; extra == "notebooks"
 
 <div align="center">
-<img alt="Thunder" src="https://github.com/Lightning-AI/lightning-thunder/raw/0.2.0.dev20240428/docs/source/_static/images/LightningThunderLightModewByline.png#gh-light-mode-only" width="400px" style="max-width: 100%;">
-<img alt="Thunder" src="https://github.com/Lightning-AI/lightning-thunder/raw/0.2.0.dev20240428/docs/source/_static/images/LightningThunderDarkModewByline.png#gh-dark-mode-only" width="400px" style="max-width: 100%;">
+<img alt="Thunder" src="https://github.com/Lightning-AI/lightning-thunder/raw/0.2.0.dev20240505/docs/source/_static/images/LightningThunderLightModewByline.png#gh-light-mode-only" width="400px" style="max-width: 100%;">
+<img alt="Thunder" src="https://github.com/Lightning-AI/lightning-thunder/raw/0.2.0.dev20240505/docs/source/_static/images/LightningThunderDarkModewByline.png#gh-dark-mode-only" width="400px" style="max-width: 100%;">
     <br/>
 <br/>
 
 **Make PyTorch models Lightning fast.**
 
 ______________________________________________________________________
 
@@ -103,27 +103,27 @@
 &#160;
 
 ## Single-GPU performance
 
 Thunder can achieve significant speedups over standard non-compiled PyTorch code ("PyTorch eager"), through the compounding effects of optimizations and the use of best-in-class executors. The figure below shows the pretraining throughput for Llama 2 7B as implemented in [LitGPT](https://github.com/Lightning-AI/litgpt).
 
 <div align="center">
-<img alt="Thunder" src="https://github.com/Lightning-AI/lightning-thunder/raw/0.2.0.dev20240428/docs/source/_static/images/training_throughput_single.png" width="800px" style="max-width: 100%;">
+<img alt="Thunder" src="https://github.com/Lightning-AI/lightning-thunder/raw/0.2.0.dev20240505/docs/source/_static/images/training_throughput_single.png" width="800px" style="max-width: 100%;">
 </div>
 
 As shown in the plot above, Thunder achieves a 40% speedup in training throughput compared to eager code on H100 using a combination of executors including nvFuser, torch.compile, cuDNN, and TransformerEngine FP8.
 
 &#160;
 
 ## Multi-GPU performance
 
 Thunder also supports distributed strategies such as DDP and FSDP for training models on multiple GPUs. The following plot displays the normalized throughput measured for Llama 2 7B without FP8 mixed precision; support for FSDP is in progress.
 
 <div align="center">
-<img alt="Thunder" src="https://github.com/Lightning-AI/lightning-thunder/raw/0.2.0.dev20240428/docs/source/_static/images/normalized_training_throughput_zero2.png" width="800px" style="max-width: 100%;">
+<img alt="Thunder" src="https://github.com/Lightning-AI/lightning-thunder/raw/0.2.0.dev20240505/docs/source/_static/images/normalized_training_throughput_zero2.png" width="800px" style="max-width: 100%;">
 </div>
 
 &#160;
 
 ## Get started
 
 The easiest way to get started with Thunder, requiring no extra installations or setups, is by using our [Zero to Thunder Tutorial Studio](https://lightning.ai/lightning-ai/studios/zero-to-thunder-tutorial).
```

#### html2text {}

```diff
@@ -1,8 +1,8 @@
-Metadata-Version: 2.1 Name: lightning-thunder Version: 0.2.0.dev20240428
+Metadata-Version: 2.1 Name: lightning-thunder Version: 0.2.0.dev20240505
 Summary: Lightning Thunder project. Home-page: https://github.com/Lightning-AI/
 lightning-thunder Download-URL: https://github.com/Lightning-AI/lightning-
 thunder Author: Lightning-AI et al Author-email: community@lightning.ai
 License: Apache 2.0 Project-URL: Bug Tracker, https://github.com/Lightning-AI/
 lightning-thunder/issues Project-URL: Documentation, https://lightning-
 thunder.rtfd.io/en/latest/ Project-URL: Source Code, https://github.com/
 Lightning-AI/lightning-thunder Keywords: deep learning,AI Classifier:
```

### Comparing `lightning_thunder-0.2.0.dev20240428/README.md` & `lightning_thunder-0.2.0.dev20240505/README.md`

 * *Files identical despite different names*

### Comparing `lightning_thunder-0.2.0.dev20240428/lightning_thunder.egg-info/PKG-INFO` & `lightning_thunder-0.2.0.dev20240505/lightning_thunder.egg-info/PKG-INFO`

 * *Files 2% similar despite different names*

```diff
@@ -1,10 +1,10 @@
 Metadata-Version: 2.1
 Name: lightning-thunder
-Version: 0.2.0.dev20240428
+Version: 0.2.0.dev20240505
 Summary: Lightning Thunder project.
 Home-page: https://github.com/Lightning-AI/lightning-thunder
 Download-URL: https://github.com/Lightning-AI/lightning-thunder
 Author: Lightning-AI et al
 Author-email: community@lightning.ai
 License: Apache 2.0
 Project-URL: Bug Tracker, https://github.com/Lightning-AI/lightning-thunder/issues
@@ -54,16 +54,16 @@
 Requires-Dist: pytest==8.1.1; extra == "test"
 Requires-Dist: xlsxwriter; extra == "test"
 Provides-Extra: notebooks
 Requires-Dist: cuda-python; extra == "notebooks"
 Requires-Dist: ipython[all]==8.23.0; extra == "notebooks"
 
 <div align="center">
-<img alt="Thunder" src="https://github.com/Lightning-AI/lightning-thunder/raw/0.2.0.dev20240428/docs/source/_static/images/LightningThunderLightModewByline.png#gh-light-mode-only" width="400px" style="max-width: 100%;">
-<img alt="Thunder" src="https://github.com/Lightning-AI/lightning-thunder/raw/0.2.0.dev20240428/docs/source/_static/images/LightningThunderDarkModewByline.png#gh-dark-mode-only" width="400px" style="max-width: 100%;">
+<img alt="Thunder" src="https://github.com/Lightning-AI/lightning-thunder/raw/0.2.0.dev20240505/docs/source/_static/images/LightningThunderLightModewByline.png#gh-light-mode-only" width="400px" style="max-width: 100%;">
+<img alt="Thunder" src="https://github.com/Lightning-AI/lightning-thunder/raw/0.2.0.dev20240505/docs/source/_static/images/LightningThunderDarkModewByline.png#gh-dark-mode-only" width="400px" style="max-width: 100%;">
     <br/>
 <br/>
 
 **Make PyTorch models Lightning fast.**
 
 ______________________________________________________________________
 
@@ -103,27 +103,27 @@
 &#160;
 
 ## Single-GPU performance
 
 Thunder can achieve significant speedups over standard non-compiled PyTorch code ("PyTorch eager"), through the compounding effects of optimizations and the use of best-in-class executors. The figure below shows the pretraining throughput for Llama 2 7B as implemented in [LitGPT](https://github.com/Lightning-AI/litgpt).
 
 <div align="center">
-<img alt="Thunder" src="https://github.com/Lightning-AI/lightning-thunder/raw/0.2.0.dev20240428/docs/source/_static/images/training_throughput_single.png" width="800px" style="max-width: 100%;">
+<img alt="Thunder" src="https://github.com/Lightning-AI/lightning-thunder/raw/0.2.0.dev20240505/docs/source/_static/images/training_throughput_single.png" width="800px" style="max-width: 100%;">
 </div>
 
 As shown in the plot above, Thunder achieves a 40% speedup in training throughput compared to eager code on H100 using a combination of executors including nvFuser, torch.compile, cuDNN, and TransformerEngine FP8.
 
 &#160;
 
 ## Multi-GPU performance
 
 Thunder also supports distributed strategies such as DDP and FSDP for training models on multiple GPUs. The following plot displays the normalized throughput measured for Llama 2 7B without FP8 mixed precision; support for FSDP is in progress.
 
 <div align="center">
-<img alt="Thunder" src="https://github.com/Lightning-AI/lightning-thunder/raw/0.2.0.dev20240428/docs/source/_static/images/normalized_training_throughput_zero2.png" width="800px" style="max-width: 100%;">
+<img alt="Thunder" src="https://github.com/Lightning-AI/lightning-thunder/raw/0.2.0.dev20240505/docs/source/_static/images/normalized_training_throughput_zero2.png" width="800px" style="max-width: 100%;">
 </div>
 
 &#160;
 
 ## Get started
 
 The easiest way to get started with Thunder, requiring no extra installations or setups, is by using our [Zero to Thunder Tutorial Studio](https://lightning.ai/lightning-ai/studios/zero-to-thunder-tutorial).
```

#### html2text {}

```diff
@@ -1,8 +1,8 @@
-Metadata-Version: 2.1 Name: lightning-thunder Version: 0.2.0.dev20240428
+Metadata-Version: 2.1 Name: lightning-thunder Version: 0.2.0.dev20240505
 Summary: Lightning Thunder project. Home-page: https://github.com/Lightning-AI/
 lightning-thunder Download-URL: https://github.com/Lightning-AI/lightning-
 thunder Author: Lightning-AI et al Author-email: community@lightning.ai
 License: Apache 2.0 Project-URL: Bug Tracker, https://github.com/Lightning-AI/
 lightning-thunder/issues Project-URL: Documentation, https://lightning-
 thunder.rtfd.io/en/latest/ Project-URL: Source Code, https://github.com/
 Lightning-AI/lightning-thunder Keywords: deep learning,AI Classifier:
```

### Comparing `lightning_thunder-0.2.0.dev20240428/lightning_thunder.egg-info/SOURCES.txt` & `lightning_thunder-0.2.0.dev20240505/lightning_thunder.egg-info/SOURCES.txt`

 * *Files identical despite different names*

### Comparing `lightning_thunder-0.2.0.dev20240428/lightning_thunder.egg-info/requires.txt` & `lightning_thunder-0.2.0.dev20240505/lightning_thunder.egg-info/requires.txt`

 * *Files identical despite different names*

### Comparing `lightning_thunder-0.2.0.dev20240428/requirements/test.txt` & `lightning_thunder-0.2.0.dev20240505/requirements/test.txt`

 * *Files identical despite different names*

### Comparing `lightning_thunder-0.2.0.dev20240428/setup.py` & `lightning_thunder-0.2.0.dev20240505/setup.py`

 * *Files identical despite different names*

### Comparing `lightning_thunder-0.2.0.dev20240428/thunder/__init__.py` & `lightning_thunder-0.2.0.dev20240505/thunder/__init__.py`

 * *Files 1% similar despite different names*

```diff
@@ -313,14 +313,15 @@
         "prologue_traces",
         "computation_fn",
         "computation_traces",
         "epilogue_fn",
         "epilogue_traces",
         "backward_fn",
         "backward_traces",
+        "return_none_instead_of_grads",
     ],
 )
 
 
 # This function will replace compile() (below) before RC1
 # TODO RC1 Consider adding a debug_log parameter to control debug printing
 # TODO RC1 Consider renaming compile_options to additional_compile_options
@@ -393,15 +394,14 @@
         fn=fn,
         langctx=langctx,
         executors_list=executors,
         cache_option=cache,
         sharp_edges=sharp_edges,
         using_jit=True,
         use_cudagraphs=False,
-        use_torch_compile=False,
         disable_torch_autograd_support=disable_torch_autograd,
         use_rematerialization=False,
         only_execute_prims=False,
         disable_preprocessing=True,
         compile_options=compile_options,
         executor_lookasides=executor_lookasides,
     )
@@ -429,22 +429,23 @@
                 autocast_gpu_dtype=str(autocast_gpu_dtype),
                 autocast_cpu_dtype=str(autocast_cpu_dtype),
             )
             autocast_thunder_dtype = autocast_cpu_dtype if pytorch.is_autocast_cpu_enabled() else autocast_gpu_dtype
 
         cache_info["is_autocast_enabled"] = is_autocast_enabled
 
-        # TODO(crcrpar): support FSDP as well
         is_ddp_enabled = getattr(fn, "use_ddp", False)
+        is_fsdp_enabled = getattr(fn, "use_fsdp", False)
         no_grad_sync = False
-        if is_ddp_enabled:
+        if is_ddp_enabled or is_fsdp_enabled:
             from thunder.distributed import get_skip_data_parallel_grad_sync
 
             no_grad_sync = get_skip_data_parallel_grad_sync()
         cache_info["no_grad_sync"] = no_grad_sync
+        return_none_instead_of_grads = is_fsdp_enabled and no_grad_sync
 
         # TODO RC1 Add module and function checks to prologue (make it a compile option)
 
         # Checks cache
         cs.last_trace_cache_start = time.time_ns()
         if (cd.cache_option is CACHE_OPTIONS.CONSTANT_VALUES) or (cd.cache_option is CACHE_OPTIONS.SYMBOLIC_VALUES):
             for cache_entry in reversed(cs.interpreter_cache):
@@ -453,14 +454,15 @@
                     pro_traces,
                     comp,
                     comp_traces,
                     epilogue,
                     epilogue_traces,
                     backward_fn,
                     backward_traces,
+                    _return_none_instead_of_grads,
                 ) = cache_entry
                 try:
                     cs.last_prologue_execution_start = time.time_ns()
                     if epilogue:
                         inps, pro_to_epi = pro(*args, **kwargs)
                     else:
                         inps = pro(*args, **kwargs)
@@ -631,15 +633,23 @@
             if backward_trc is not None:
                 backward_fn = backward_trc.python_callable()
             else:
                 backward_fn = None
 
             # TODO RC1 Update the cache
             cache_entry = CacheEntry(
-                pro, protraces, comp, extraces, epilogue, epilogue_traces, backward_fn, backward_traces
+                pro,
+                protraces,
+                comp,
+                extraces,
+                epilogue,
+                epilogue_traces,
+                backward_fn,
+                backward_traces,
+                return_none_instead_of_grads,
             )
             if cd.cache_option is not CACHE_OPTIONS.NO_CACHING:
                 cs.interpreter_cache.append(cache_entry)
 
             cs.last_traces += extraces
             cs.last_prologue_traces = [prologue_trc] + protraces
             cs.last_prologue = pro
@@ -665,14 +675,15 @@
 
         if cache_entry.backward_fn:
             # Run the compiled forward function
             data_for_autograd, (saved_tensors, saved_other) = result
 
             # Connect produced tensors with PyTorch's autograd graph
             ThunderFunction.apply(
+                cache_entry.return_none_instead_of_grads,
                 cache_entry.backward_fn,
                 saved_tensors,
                 saved_other,
                 data_for_autograd["flat_output"],
                 *data_for_autograd["flat_args"],
             )
             result = data_for_autograd["output"]
@@ -705,28 +716,26 @@
 def compile(
     fn: Callable,
     *,
     langctx: None | Any = None,
     executors_list: None | Sequence[Executor] = None,
     cache_mode: None | str | CACHE_OPTIONS = None,
     use_cudagraphs: bool = False,
-    use_torch_compile: bool = False,
     disable_torch_autograd_support: bool = False,
     use_rematerialization: bool = False,
     only_execute_prims: bool = False,
     disable_preprocessing: bool = False,
     **kwargs,
 ) -> Callable:
     cd = CompileData(
         fn=fn,
         langctx=langctx,
         executors_list=executors_list,
         cache_option=cache_mode,
         use_cudagraphs=use_cudagraphs,
-        use_torch_compile=use_torch_compile,
         disable_torch_autograd_support=disable_torch_autograd_support,
         use_rematerialization=use_rematerialization,
         only_execute_prims=only_execute_prims,
         disable_preprocessing=disable_preprocessing,
         compile_options=kwargs,
     )
```

### Comparing `lightning_thunder-0.2.0.dev20240428/thunder/benchmarks/__init__.py` & `lightning_thunder-0.2.0.dev20240505/thunder/benchmarks/__init__.py`

 * *Files 1% similar despite different names*

```diff
@@ -1,36 +1,39 @@
 import dataclasses
-from typing import Any
+import sys
+import tempfile
+import textwrap
+import time
 from collections.abc import Callable
 from collections.abc import Sequence
-import time
+from dataclasses import dataclass
 from functools import partial
-import textwrap
 from numbers import Number
-import sys
-from dataclasses import dataclass
-import tempfile
-
-
-from lightning_utilities.core.imports import package_available
+from typing import Any
 
 import torch
+import torch.multiprocessing as mp
 import torch.nn as nn
+from lightning_utilities.core.imports import package_available
 from torch.testing import make_tensor
-import torch.multiprocessing as mp
 
 import thunder
-import thunder.torch as ltorch
-import thunder.core.dtypes as dtypes
 import thunder.core.devices as Devices
-from thunder.core.transforms import grad, clear_grads, populate_grads
+import thunder.core.dtypes as dtypes
 import thunder.executors as executors
+import thunder.torch as ltorch
+from thunder.core.transforms import grad, clear_grads, populate_grads
+from thunder.executors.apex_entropyex import apex_ex, apex_available
+from thunder.executors.cudnn_layernormex import cudnn_layernorm_ex
+from thunder.executors.cudnnex import cudnn_ex, cudnn_available
+from thunder.executors.sdpaex import sdpa_ex
+from thunder.executors.torch_compile import torch_compile_cat_ex, torch_compile_ex
 from thunder.tests import nanogpt_model, hf_bart_self_attn, litgpt_model
-from thunder.tests.make_tensor import make_tensor, make_tensor_like
 from thunder.tests.litgpt_model import Config as LitGPTConfig
+from thunder.tests.make_tensor import make_tensor, make_tensor_like
 
 # List of all benchmarks
 benchmarks: list = []
 
 
 # Prints the benchmarks in alphabetical order (either by classname or the benchmark's "name" attribute)
 def list_benchmarks(use_classname: bool = True) -> None:
@@ -710,35 +713,30 @@
 def thunder_torch_executor(fn: Callable) -> Callable:
     torch.backends.cuda.matmul.allow_tf32 = True
     return thunder.jit(fn, executors=[thunder.pytorch_executor])
 
 
 def thunder_torch_compile_executor(fn: Callable) -> Callable:
     torch.backends.cuda.matmul.allow_tf32 = True
-    return thunder.jit(fn, exec[thunder.pytorch_executor], use_torch_compile=True)
+    return thunder.jit(fn, executors=[torch_compile_ex])
 
 
-from thunder.executors.apex_entropyex import apex_ex, apex_available
-
 thunder_apex_executor: None | Callable = None
 thunder_apex_nvfuser_executor: None | Callable = None
 if apex_available():
 
     def thunder_apex_executor(fn: Callable) -> Callable:
         torch.backends.cuda.matmul.allow_tf32 = True
         return thunder.jit(fn, executors=[apex_ex])
 
     def thunder_apex_nvfuser_executor(fn: Callable) -> Callable:
         torch.backends.cuda.matmul.allow_tf32 = True
         return thunder.jit(fn, executors=[apex_ex, thunder.nvfuser_executor])
 
 
-from thunder.executors.cudnnex import cudnn_ex, cudnn_available
-from thunder.executors.cudnn_layernormex import cudnn_layernorm_ex
-
 thunder_cudnn_executor: None | Callable = None
 thunder_cudnn_nvfuser_executor: None | Callable = None
 thunder_cudnn_layer_norm_executor: None | Callable = None
 thunder_cudnn_layer_norm_nvfuser_executor: None | Callable = None
 if cudnn_available():
 
     def thunder_cudnn_executor(fn: Callable) -> Callable:
@@ -754,28 +752,22 @@
         return thunder.jit(fn, executors=[cudnn_layernorm_ex])
 
     def thunder_cudnn_layer_norm_nvfuser_executor(fn: Callable) -> Callable:
         torch.backends.cuda.matmul.allow_tf32 = True
         return thunder.jit(fn, executors=[cudnn_layernorm_ex, thunder.nvfuser_executor])
 
 
-from thunder.executors.sdpaex import sdpa_ex
-
-
 def thunder_sdpa_executor(fn: Callable) -> Callable:
     torch.backends.cuda.matmul.allow_tf32 = True
     return thunder.jit(fn, executors=[sdpa_ex])
 
 
-from thunder.executors.torch_compile import torch_compile_executor as torch_compile_ex
-
-
 def thunder_sdpa_torch_compile_nvfuser_executor(fn: Callable) -> Callable:
     torch.backends.cuda.matmul.allow_tf32 = True
-    return thunder.jit(fn, executors=[sdpa_ex, torch_compile_ex, thunder.nvfuser_executor])
+    return thunder.jit(fn, executors=[sdpa_ex, torch_compile_cat_ex, thunder.nvfuser_executor])
 
 
 def default_torch_ddp_executor(_) -> Callable:
     def func(fn: Callable) -> Callable:
         torch.backends.cuda.matmul.allow_tf32 = True
         return torch.nn.parallel.DistributedDataParallel(fn)
 
@@ -841,24 +833,22 @@
 
 @dataclass(frozen=True)
 class get_default_thunder_ddp_dynamic_strides_executor:
     bucket_size_in_mb: float = 25
 
     def __call__(self, _) -> Callable:
         from thunder.distributed import ddp
-        from thunder.executors.torch_compile import torch_compile_executor
-        from thunder.executors.sdpaex import sdpa_ex
 
         def func(fn: Callable) -> Callable:
             torch.backends.cuda.matmul.allow_tf32 = True
             return thunder.jit(
                 ddp(fn, bucket_size_in_mb=self.bucket_size_in_mb),
                 executors=[
                     sdpa_ex,
-                    torch_compile_executor,
+                    torch_compile_cat_ex,
                     thunder.nvfuser_executor,
                 ],
             )
 
         return func
 
 
@@ -868,28 +858,26 @@
     from thunder.distributed import FSDPType
 
     bucketing_strategy: FSDPBucketingStrategy
     sharding_strategy: FSDPType
 
     def __call__(self, _) -> Callable:
         from thunder.distributed import fsdp
-        from thunder.executors.torch_compile import torch_compile_executor
-        from thunder.executors.sdpaex import sdpa_ex
 
         def func(fn: Callable) -> Callable:
             torch.backends.cuda.matmul.allow_tf32 = True
             return thunder.jit(
                 fsdp(
                     fn,
                     bucketing_strategy=self.bucketing_strategy,
                     sharding_strategy=self.sharding_strategy,
                 ),
                 executors=[
                     sdpa_ex,
-                    torch_compile_executor,
+                    torch_compile_cat_ex,
                     thunder.nvfuser_executor,
                 ],
             )
 
         return func
```

### Comparing `lightning_thunder-0.2.0.dev20240428/thunder/benchmarks/benchmark_litgpt.py` & `lightning_thunder-0.2.0.dev20240505/thunder/benchmarks/benchmark_litgpt.py`

 * *Files 10% similar despite different names*

```diff
@@ -1,9 +1,10 @@
 import os
 import time
+from typing import Any
 
 import torch
 import functools
 from torch.utils.data import DataLoader, IterableDataset
 import torch.distributed as torch_dist
 from torch.distributed.device_mesh import init_device_mesh
 
@@ -31,14 +32,30 @@
     use_fused = fused_available and device_type == "cuda"
     optimizer = torch.optim.AdamW(
         model.parameters(), lr=learning_rate, weight_decay=weight_decay, betas=betas, fused=use_fused
     )
     return optimizer
 
 
+def run_fwd_bwd_one_microbatch(
+    model: torch.nn.Module,
+    input_ids: torch.Tensor,
+    targets: torch.Tensor,
+    gradient_accumulation_steps: int,
+    te_ctx: Any,
+) -> torch.Tensor:
+    with te_ctx():
+        logits = model(input_ids)
+    logits = logits.reshape(-1, logits.size(-1))
+    targets = targets.reshape(-1)
+    loss = torch.nn.functional.cross_entropy(logits, targets, ignore_index=-1) / gradient_accumulation_steps
+    loss.backward()
+    return loss
+
+
 class Benchmark_litGPT:
     def __init__(
         self,
         compile: str = "eager",
         dynamic: bool = False,
         nsys_enabled: bool = False,
         distributed_mode: str = "none",
@@ -49,14 +66,15 @@
         bucketing_mode: str = "none",
         sharding_size: int | None = None,
         ddp_bucket_size: float = 256.0,
         fsdp_bucket_params: float | None = None,
         n_layers: int | None = None,
         profiler_start: int = 15,
         profiler_stop: int = 15,
+        skip_data_sync: bool = False,
     ):
         seed = 1337
         torch.manual_seed(seed)
         torch.cuda.manual_seed(seed)
         torch.backends.cuda.matmul.allow_tf32 = True  # allow tf32 on matmul
         torch.backends.cudnn.allow_tf32 = True  # allow tf32 on cudnn
         learning_rate = 5e-4  # max learning rate
@@ -128,19 +146,15 @@
         ), f"Global Batch Size {self.global_batch_size} should be a multiple of Micro Batch Size {self.micro_batch_size}."
         self.gradient_accumulation_steps = int(self.global_batch_size / self.micro_batch_size)
         if world_size:
             self.gradient_accumulation_steps = int(self.gradient_accumulation_steps / world_size)
             assert (
                 self.global_batch_size % self.micro_batch_size * world_size == 0
             ), f"Global Batch Size {self.global_batch_size} should be a multiple Micro Batch Size {self.micro_batch_size} * World Size {world_size}."
-            # TODO: Remove when gradient accumulation is ready for benchmarking.
-            if self.gradient_accumulation_steps > 1:
-                print(
-                    f"[WARNING] Gradient Accumulation is not fully supported yet. Benchmarking results may not be accurate. Gradient Accumulation Steps = {self.gradient_accumulation_steps}"
-                )
+        self.skip_data_sync = skip_data_sync
 
         # Profiling Args
         self.nsys_enabled = nsys_enabled
         self.profiler_start = profiler_start
         self.profiler_stop = profiler_stop
 
         if n_layers is not None:
@@ -198,17 +212,19 @@
                     broadcast_from=0,
                     bucket_size_in_mb=self.ddp_bucket_size,
                 )
             elif self.distributed_mode == "fsdp":
                 from thunder.distributed import fsdp, FSDPType, FSDPBucketingStrategy
 
                 sharding_strategy = {"zero2": FSDPType.ZERO2, "zero3": FSDPType.ZERO3}[self.shard_mode]
-                bucketing_strategy = {"none": FSDPBucketingStrategy.NONE, "block": FSDPBucketingStrategy.BLOCK}[
-                    self.bucketing_mode
-                ]
+                bucketing_strategy = {
+                    "none": FSDPBucketingStrategy.NONE,
+                    "block": FSDPBucketingStrategy.BLOCK,
+                    "layer": FSDPBucketingStrategy.LAYER,
+                }[self.bucketing_mode]
                 model = fsdp(
                     model,
                     broadcast_from=None,
                     sharding_strategy=sharding_strategy,
                     bucketing_strategy=bucketing_strategy,
                 )
         else:
@@ -262,16 +278,20 @@
             print("Resetting cache size for torch.compile")
             import torch._dynamo.config as dynamo_config
 
             dynamo_config.cache_size_limit = 64
             model = torch.compile(model)
         elif "thunder" in self.compile:
             executors = [thunder.nvfuser_executor, thunder.pytorch_executor]
-            if "inductor" in self.compile:
-                from thunder.executors.torch_compile import torch_compile_executor as torch_compile_ex
+            if "inductor_cat" in self.compile:
+                from thunder.executors.torch_compile import torch_compile_cat_ex as torch_compile_ex
+
+                executors.insert(0, torch_compile_ex)
+            elif "inductor" in self.compile:
+                from thunder.executors.torch_compile import torch_compile_ex
 
                 executors.insert(0, torch_compile_ex)
             if "cudnn" in self.compile:
                 from thunder.executors.cudnnex import cudnn_ex
 
                 executors.insert(0, cudnn_ex)
             else:
@@ -327,53 +347,59 @@
         t0 = None
         if global_rank in [0, None]:
             # Calculate the model FLOPs
             self.calculate_model_flops()
             # Setup throughput Collection
             self.throughput = Throughput(window_size=self.max_iters - self.warmup_iter, world_size=world_size)
 
+        if "transformerengine" in self.compile:
+            import transformer_engine.pytorch as te
+
+            te_ctx = te.fp8_autocast
+        else:
+            from contextlib import nullcontext
+
+            te_ctx = nullcontext
+
+        if self.skip_data_sync:
+            data_sync_ctx = self.model.no_sync
+        else:
+            data_sync_ctx = nullcontext
+
         for i in range(self.max_iters):
             iter_t0 = time.perf_counter()
             if i == self.warmup_iter:  # warmup
                 t0 = iter_t0
 
-            for step_idx in range(self.gradient_accumulation_steps):
-                input_ids, targets = next(self.train_data_iter)
-                input_ids = input_ids.to(device=self.device)
-                targets = targets.to(device=self.device)
-
-                if self.nsys_enabled and i == self.profiler_start and global_rank in [0, None] and step_idx == 0:
-                    print("=====Start NSYS Profiling======")
-                    torch.cuda.cudart().cudaProfilerStart()
-
-                logits = self.model(input_ids)
-
-                logits = logits.reshape(-1, logits.size(-1))
-                targets = targets.reshape(-1)
-                loss = (
-                    torch.nn.functional.cross_entropy(logits, targets, ignore_index=-1)
-                    / self.gradient_accumulation_steps
-                )
-
-                loss.backward()
-
-                # Simple Gradient Accumulation Implementation
-                if (step_idx + 1) % self.gradient_accumulation_steps == 0:
-                    self.optimizer.step()
-                    self.optimizer.zero_grad(set_to_none=True)
-
-                # torch.cuda.synchronize()
-                if (
-                    self.nsys_enabled
-                    and i == self.profiler_stop
-                    and global_rank in [0, None]
-                    and ((step_idx + 1) % self.gradient_accumulation_steps == 0)
-                ):
-                    print("=====Stop NSYS Profiling======")
-                    torch.cuda.cudart().cudaProfilerStop()
+            with data_sync_ctx():
+                for step_idx in range(self.gradient_accumulation_steps - 1):
+                    input_ids, targets = next(self.train_data_iter)
+                    input_ids = input_ids.to(device=self.device)
+                    targets = targets.to(device=self.device)
+
+                    if self.nsys_enabled and i == self.profiler_start and global_rank in [0, None] and step_idx == 0:
+                        print("=====Start NSYS Profiling======")
+                        torch.cuda.cudart().cudaProfilerStart()
+
+                    loss = run_fwd_bwd_one_microbatch(
+                        self.model, input_ids, targets, self.gradient_accumulation_steps, te_ctx
+                    )
+
+            input_ids, targets = next(self.train_data_iter)
+            input_ids = input_ids.to(device=self.device)
+            targets = targets.to(device=self.device)
+            loss = run_fwd_bwd_one_microbatch(self.model, input_ids, targets, self.gradient_accumulation_steps, te_ctx)
+
+            # Simple Gradient Accumulation Implementation
+            self.optimizer.step()
+            self.optimizer.zero_grad(set_to_none=True)
+
+            if self.nsys_enabled and i == self.profiler_stop and global_rank in [0, None]:
+                print("=====Stop NSYS Profiling======")
+                torch.cuda.cudart().cudaProfilerStop()
 
             loss_item = loss.item()  # synchronization
             t1 = time.perf_counter()
             if global_rank in [0, None]:
                 print(
                     f"iter {i}: loss {loss_item:.4f}, iter time: {(t1 - iter_t0) * 1000:.2f}ms, t: {input_ids.size(1)}"
                 )
```

### Comparing `lightning_thunder-0.2.0.dev20240428/thunder/benchmarks/distributed.py` & `lightning_thunder-0.2.0.dev20240505/thunder/benchmarks/distributed.py`

 * *Files identical despite different names*

### Comparing `lightning_thunder-0.2.0.dev20240428/thunder/benchmarks/einsum.py` & `lightning_thunder-0.2.0.dev20240505/thunder/benchmarks/einsum.py`

 * *Files 2% similar despite different names*

```diff
@@ -96,15 +96,15 @@
             *sample_gen(size, left_broadcasts), executor=executor, requires_grad=False
         )
         benchmark.pedantic(fn, setup=setup, rounds=20, warmup_rounds=1)
 
     @pytest.mark.parametrize(
         "executor,",
         [ge for ge in grad_executors if ge not in (thunder_gradv1, thunder_torchcompile_gradv1)],
-        ids=[gei for gei in grad_executors_ids if gei not in ("thunder-gradv1", "thunder+torchcompile-gradv1")],
+        ids=[gei for gei in grad_executors_ids if gei not in ("thunder-gradv1", "thunder+torchcompile_cat-gradv1")],
     )
     @pytest.mark.parametrize(
         "size,",
         _test_size_map.keys(),
     )
     @pytest.mark.parametrize(
         "sample_gen,", (single_dim_contraction_cases, multidim_contraction_cases), ids=("singledim", "multidim")
```

### Comparing `lightning_thunder-0.2.0.dev20240428/thunder/benchmarks/targets.py` & `lightning_thunder-0.2.0.dev20240505/thunder/benchmarks/targets.py`

 * *Files 0% similar despite different names*

```diff
@@ -287,15 +287,15 @@
             result.backward(torch.ones_like(result))
         return result
 
     return wrapper
 
 
 # To compare with PyTorch and raw torch.compile (i.e. not through thunder). The
-# latter can help us isolate whether it's something we need to fix ourself or
+# latter can help us isolate whether it's something we need to fix ourselves or
 # report upstream.
 torch_fwd_bwd = partial(thunder_fwd_bwd, compile_fn=torch_executor)
 torchcompile_fwd_bwd = partial(thunder_fwd_bwd, compile_fn=torch_compile_executor)
 
 # Executing with just PyTorch
 thunder_torch_grad = partial(thunder_grad_transform, compile_fn=thunder_torch_executor)
 thunder_torch_gradv1 = partial(thunder_grad_transform_v1, compile_fn=thunder_torch_executor)
@@ -304,15 +304,15 @@
 # Default thunder configs
 thunder_fwd = partial(thunder_fwd, compile_fn=thunder_executor)
 thunder_fwd_bwd = partial(thunder_fwd_bwd, compile_fn=thunder_executor)
 thunder_grad = partial(thunder_grad_transform, compile_fn=thunder_executor)
 thunder_gradv1 = partial(thunder_grad_transform_v1, compile_fn=thunder_executor)
 thunder_value_and_grad = partial(thunder_value_and_grad_transform, compile_fn=thunder_executor)
 
-# Executing with torchcompile
+# Executing with torchcompile as a Thunder executor
 thunder_torchcompile_fwd = partial(thunder_fwd, compile_fn=thunder_torch_compile_executor)
 thunder_torchcompile_grad = partial(thunder_grad_transform, compile_fn=thunder_torch_compile_executor)
 thunder_torchcompile_gradv1 = partial(thunder_grad_transform_v1, compile_fn=thunder_torch_compile_executor)
 thunder_torchcompile_value_and_grad = partial(
     thunder_value_and_grad_transform, compile_fn=thunder_torch_compile_executor
 )
```

### Comparing `lightning_thunder-0.2.0.dev20240428/thunder/benchmarks/test_benchmark_litgpt.py` & `lightning_thunder-0.2.0.dev20240505/thunder/benchmarks/test_benchmark_litgpt.py`

 * *Files identical despite different names*

### Comparing `lightning_thunder-0.2.0.dev20240428/thunder/clang/__init__.py` & `lightning_thunder-0.2.0.dev20240505/thunder/clang/__init__.py`

 * *Files identical despite different names*

### Comparing `lightning_thunder-0.2.0.dev20240428/thunder/clang/langctx.py` & `lightning_thunder-0.2.0.dev20240505/thunder/clang/langctx.py`

 * *Files identical despite different names*

### Comparing `lightning_thunder-0.2.0.dev20240428/thunder/common.py` & `lightning_thunder-0.2.0.dev20240505/thunder/common.py`

 * *Files 2% similar despite different names*

```diff
@@ -145,15 +145,14 @@
         executors_list: None | tuple[Executor, ...] = None,
         cache_option: None | str | CACHE_OPTIONS = None,
         sharp_edges: None | SHARP_EDGES_OPTIONS | str = None,
         using_jit: bool = False,
         only_execute_prims: bool = False,
         disable_preprocessing: bool = False,
         use_cudagraphs: bool = False,
-        use_torch_compile: bool = False,
         disable_torch_autograd_support: bool = False,
         use_rematerialization: bool = False,
         debug_log: None | StringIO = None,
         compile_options: dict[str, Any] = {},
         get_computation_and_inputs: Callable | None = None,
         executor_lookasides: dict[Callable, Callable] | None = None,
     ):
@@ -204,15 +203,14 @@
         self.sharp_edges = resolve_sharp_edges_option(sharp_edges)
 
         self.fn = fn
         self.only_execute_prims = only_execute_prims
         self.disable_preprocessing = disable_preprocessing
         self.use_rematerialization = use_rematerialization
         self.use_cudagraphs = use_cudagraphs
-        self.use_torch_compile = use_torch_compile
         self.disable_torch_autograd_support = disable_torch_autograd_support
         self.debug_log = debug_log
 
         # TODO Consider validating that this dict has exclusively string keys
         self.compile_options = compile_options
 
         self.is_module = isinstance(self.fn, torch.nn.Module)
@@ -616,18 +614,14 @@
     for transform in post_optimization_transforms:
         extrace = transform(extrace)
         extraces.append(extrace)
 
     # Constructs the Python callable
     c = extrace.python_callable()
 
-    # TODO RC1 Remove this option (by using the torch.compile executor)
-    if compile_data.use_torch_compile:
-        c = torch.compile(c)
-
     # TODO RC1 Mark this option as experimental
     if compile_data.use_cudagraphs:
         c = CUDAGraphExecutor(c, num_constant_args=compile_data.num_constant_args)
 
     # Executes the operation
     result: Any = c(*args, **kwargs)
 
@@ -670,18 +664,18 @@
             autocast_gpu_dtype = to_dtype(torch.get_autocast_gpu_dtype())
             autocast_cpu_dtype = to_dtype(torch.get_autocast_cpu_dtype())
             autocast_key = _make_autocast_cache_key(
                 torch.is_autocast_enabled(), torch.is_autocast_cpu_enabled(), autocast_gpu_dtype, autocast_cpu_dtype
             )
             autocast_thunder_dtype = autocast_cpu_dtype if torch.is_autocast_cpu_enabled() else autocast_gpu_dtype
 
-        # TODO(crcrpar): support FSDP as well
         is_ddp_enabled = getattr(cd.fn, "use_ddp", False)
+        is_fsdp_enabled = getattr(cd.fn, "use_fsdp", False)
         no_grad_sync = False
-        if is_ddp_enabled:
+        if is_ddp_enabled or is_fsdp_enabled:
             from thunder.distributed import get_skip_data_parallel_grad_sync
 
             no_grad_sync = get_skip_data_parallel_grad_sync()
         distributed_key = _make_distributed_cache_key(no_grad_sync)
 
         # Tries to lookup a callable in a cache
         # TODO Return the previous traces when caching
```

### Comparing `lightning_thunder-0.2.0.dev20240428/thunder/core/baseutils.py` & `lightning_thunder-0.2.0.dev20240505/thunder/core/baseutils.py`

 * *Files identical despite different names*

### Comparing `lightning_thunder-0.2.0.dev20240428/thunder/core/codeutils.py` & `lightning_thunder-0.2.0.dev20240505/thunder/core/codeutils.py`

 * *Files identical despite different names*

### Comparing `lightning_thunder-0.2.0.dev20240428/thunder/core/compile_data.py` & `lightning_thunder-0.2.0.dev20240505/thunder/core/compile_data.py`

 * *Files identical despite different names*

### Comparing `lightning_thunder-0.2.0.dev20240428/thunder/core/devices.py` & `lightning_thunder-0.2.0.dev20240505/thunder/core/devices.py`

 * *Files identical despite different names*

### Comparing `lightning_thunder-0.2.0.dev20240428/thunder/core/dtypes.py` & `lightning_thunder-0.2.0.dev20240505/thunder/core/dtypes.py`

 * *Files identical despite different names*

### Comparing `lightning_thunder-0.2.0.dev20240428/thunder/core/interpreter.py` & `lightning_thunder-0.2.0.dev20240505/thunder/core/interpreter.py`

 * *Files identical despite different names*

### Comparing `lightning_thunder-0.2.0.dev20240428/thunder/core/jit_ext.py` & `lightning_thunder-0.2.0.dev20240505/thunder/core/jit_ext.py`

 * *Files 1% similar despite different names*

```diff
@@ -570,25 +570,15 @@
                 name = None
 
             p = proxy(uvalue, name=name, history=value.provenance)
 
             # TensorProxy attributes should be considered derived quantities, so we flag TensorProxies here
             value.provenance.ext_flag |= EXT_FLAG_IS_TENSOR_PROXY
 
-            from thunder.core import utils
-            from thunder.distributed import get_skip_data_parallel_grad_sync
-
-            no_sync = get_skip_data_parallel_grad_sync()
-            compile_data = get_compile_data()
-            utils.check(
-                not (no_sync and getattr(compile_data, "use_fsdp", False)),
-                lambda: "`thunder.distributed.fsdp` does not support `no_sync`",
-            )
-
-            if not no_sync and isinstance(p, TensorProxy) and p.ddp_type in (DDPType.REPLICATED, DDPType.FULLY_SHARDED):
+            if isinstance(p, TensorProxy) and p.ddp_type in (DDPType.REPLICATED, DDPType.FULLY_SHARDED):
                 p_new = thunder.distributed.prims.synchronize(p, self._process_group_for_ddp)
                 p_orig = p
                 p = p_new
             else:
                 p_orig = p
             if p is not uvalue:
                 value.register_proxy(p)
```

### Comparing `lightning_thunder-0.2.0.dev20240428/thunder/core/langctxs.py` & `lightning_thunder-0.2.0.dev20240505/thunder/core/langctxs.py`

 * *Files identical despite different names*

### Comparing `lightning_thunder-0.2.0.dev20240428/thunder/core/options.py` & `lightning_thunder-0.2.0.dev20240505/thunder/core/options.py`

 * *Files identical despite different names*

### Comparing `lightning_thunder-0.2.0.dev20240428/thunder/core/patterns.py` & `lightning_thunder-0.2.0.dev20240505/thunder/core/patterns.py`

 * *Files identical despite different names*

### Comparing `lightning_thunder-0.2.0.dev20240428/thunder/core/prims.py` & `lightning_thunder-0.2.0.dev20240505/thunder/core/prims.py`

 * *Files identical despite different names*

### Comparing `lightning_thunder-0.2.0.dev20240428/thunder/core/profile.py` & `lightning_thunder-0.2.0.dev20240505/thunder/core/profile.py`

 * *Files identical despite different names*

### Comparing `lightning_thunder-0.2.0.dev20240428/thunder/core/proxies.py` & `lightning_thunder-0.2.0.dev20240505/thunder/core/proxies.py`

 * *Files identical despite different names*

### Comparing `lightning_thunder-0.2.0.dev20240428/thunder/core/pytree.py` & `lightning_thunder-0.2.0.dev20240505/thunder/core/pytree.py`

 * *Files identical despite different names*

### Comparing `lightning_thunder-0.2.0.dev20240428/thunder/core/rematerialization.py` & `lightning_thunder-0.2.0.dev20240505/thunder/core/rematerialization.py`

 * *Files 0% similar despite different names*

```diff
@@ -374,16 +374,16 @@
     cut = g.mincut(source, sink, "capacity").cut
     cut_nodes = set()
     for cut_edge_id in cut:
         u, v = g_edges[cut_edge_id]
         node_in, node_out = id_to_name[u], id_to_name[v]
         if node_out == "sink":
             continue
-        assert node_in.endswith("_in")
-        assert node_out.endswith("_out")
+        assert node_in.endswith("_in"), node_in
+        assert node_out.endswith("_out"), node_out
         assert node_in[:-3] == node_out[:-4]
         var_name = node_in[:-3]
         cut_nodes.add(var_name)
     return tuple(sorted(cut_nodes))
 
 
 def rematerialize_all_gather(fw_trace: TraceCtx, bw_trace: TraceCtx) -> tuple[TraceCtx, TraceCtx]:
```

### Comparing `lightning_thunder-0.2.0.dev20240428/thunder/core/symbol.py` & `lightning_thunder-0.2.0.dev20240505/thunder/core/symbol.py`

 * *Files identical despite different names*

### Comparing `lightning_thunder-0.2.0.dev20240428/thunder/core/trace.py` & `lightning_thunder-0.2.0.dev20240505/thunder/core/trace.py`

 * *Files identical despite different names*

### Comparing `lightning_thunder-0.2.0.dev20240428/thunder/core/transform_common.py` & `lightning_thunder-0.2.0.dev20240505/thunder/core/transform_common.py`

 * *Files identical despite different names*

### Comparing `lightning_thunder-0.2.0.dev20240428/thunder/core/transforms.py` & `lightning_thunder-0.2.0.dev20240505/thunder/core/transforms.py`

 * *Files 1% similar despite different names*

```diff
@@ -1196,7581 +1196,7568 @@
 00004ab0: 3a0a 2020 2020 2020 2020 6966 2073 686f  :.        if sho
 00004ac0: 756c 645f 666c 6174 7465 6e28 6273 796d  uld_flatten(bsym
 00004ad0: 293a 0a20 2020 2020 2020 2020 2020 2063  ):.            c
 00004ae0: 6865 636b 280a 2020 2020 2020 2020 2020  heck(.          
 00004af0: 2020 2020 2020 6c65 6e28 6273 796d 2e73        len(bsym.s
 00004b00: 7562 7379 6d62 6f6c 7329 203e 2030 2c0a  ubsymbols) > 0,.
 00004b10: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00004b20: 6c61 6d62 6461 3a20 6622 5472 7969 6e67  lambda: f"Trying
-00004b30: 2074 6f20 666c 6174 7465 6e20 7b62 7379   to flatten {bsy
-00004b40: 6d7d 2074 6f20 6372 6561 7465 2061 2067  m} to create a g
-00004b50: 7261 6420 666f 726d 756c 612c 2062 7574  rad formula, but
-00004b60: 2069 7420 6861 7320 6e6f 2073 7562 7379   it has no subsy
-00004b70: 6d62 6f6c 7322 2c0a 2020 2020 2020 2020  mbols",.        
-00004b80: 2020 2020 290a 2020 2020 2020 2020 2020      ).          
-00004b90: 2020 666f 7220 7362 7379 6d20 696e 2062    for sbsym in b
-00004ba0: 7379 6d2e 7375 6273 796d 626f 6c73 3a0a  sym.subsymbols:.
-00004bb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00004bc0: 5f66 6c61 7474 656e 2873 6273 796d 290a  _flatten(sbsym).
-00004bd0: 2020 2020 2020 2020 656c 7365 3a0a 2020          else:.  
-00004be0: 2020 2020 2020 2020 2020 666c 6174 7465            flatte
-00004bf0: 6e65 642e 6170 7065 6e64 2862 7379 6d29  ned.append(bsym)
-00004c00: 0a0a 2020 2020 666f 7220 6273 796d 2069  ..    for bsym i
-00004c10: 6e20 6273 796d 733a 0a20 2020 2020 2020  n bsyms:.       
-00004c20: 205f 666c 6174 7465 6e28 6273 796d 290a   _flatten(bsym).
-00004c30: 0a20 2020 2072 6574 7572 6e20 666c 6174  .    return flat
-00004c40: 7465 6e65 640a 0a0a 230a 2320 5068 616e  tened...#.# Phan
-00004c50: 746f 6d20 6772 6164 2074 7261 6e73 666f  tom grad transfo
-00004c60: 726d 0a23 0a0a 230a 2320 4675 6e63 7469  rm.#..#.# Functi
-00004c70: 6f6e 7320 7265 6c61 7465 6420 746f 2066  ons related to f
-00004c80: 756e 6374 696f 6e61 6c69 7a69 6e67 2054  unctionalizing T
-00004c90: 6875 6e64 6572 4f70 7469 6d69 7a65 644d  hunderOptimizedM
-00004ca0: 6f64 756c 6573 0a23 0a0a 0a23 2054 4f44  odules.#...# TOD
-00004cb0: 4f20 5465 7374 2077 6974 6820 6275 6666  O Test with buff
-00004cc0: 6572 730a 6465 6620 706f 7075 6c61 7465  ers.def populate
-00004cd0: 5f67 7261 6473 2867 7261 6473 3a20 6c69  _grads(grads: li
-00004ce0: 7374 5b54 656e 736f 7250 726f 7879 5d2c  st[TensorProxy],
-00004cf0: 2074 6f6d 3a20 4e6f 6e65 207c 2074 6f72   tom: None | tor
-00004d00: 6368 2e6e 6e2e 4d6f 6475 6c65 203d 204e  ch.nn.Module = N
-00004d10: 6f6e 652c 2061 7267 733d 4e6f 6e65 2c20  one, args=None, 
-00004d20: 6b77 6172 6773 3d4e 6f6e 6529 202d 3e20  kwargs=None) -> 
-00004d30: 4e6f 6e65 3a0a 2020 2020 6964 783a 2069  None:.    idx: i
-00004d40: 6e74 203d 2030 0a20 2020 2066 726f 6d20  nt = 0.    from 
-00004d50: 7468 756e 6465 7220 696d 706f 7274 2054  thunder import T
-00004d60: 6875 6e64 6572 4d6f 6475 6c65 2c20 636f  hunderModule, co
-00004d70: 6d70 696c 655f 6461 7461 0a0a 2020 2020  mpile_data..    
-00004d80: 6966 2069 7369 6e73 7461 6e63 6528 746f  if isinstance(to
-00004d90: 6d2c 2054 6875 6e64 6572 4d6f 6475 6c65  m, ThunderModule
-00004da0: 2920 6f72 2063 6f6d 7069 6c65 5f64 6174  ) or compile_dat
-00004db0: 6128 746f 6d29 2e75 7369 6e67 5f6a 6974  a(tom).using_jit
-00004dc0: 3a0a 2020 2020 2020 2020 6173 7365 7274  :.        assert
-00004dd0: 2061 7267 7320 6973 206e 6f74 204e 6f6e   args is not Non
-00004de0: 652c 2022 706f 7075 6c61 7465 2067 7261  e, "populate gra
-00004df0: 6420 6e65 6564 7320 6172 6773 2028 616e  d needs args (an
-00004e00: 6420 706f 7373 6962 6c79 206b 7761 7267  d possibly kwarg
-00004e10: 7329 2074 6f20 776f 726b 2077 6974 6820  s) to work with 
-00004e20: 5468 756e 6465 724d 6f64 756c 6573 220a  ThunderModules".
-00004e30: 2020 2020 2020 2020 6966 206b 7761 7267          if kwarg
-00004e40: 7320 6973 204e 6f6e 653a 0a20 2020 2020  s is None:.     
-00004e50: 2020 2020 2020 206b 7761 7267 7320 3d20         kwargs = 
-00004e60: 7b7d 0a20 2020 2020 2020 205f 2c20 636f  {}.        _, co
-00004e70: 6d70 7574 6174 696f 6e5f 696e 7075 7473  mputation_inputs
-00004e80: 2c20 5f20 3d20 636f 6d70 696c 655f 6461  , _ = compile_da
-00004e90: 7461 2874 6f6d 292e 6765 745f 636f 6d70  ta(tom).get_comp
-00004ea0: 7574 6174 696f 6e5f 616e 645f 696e 7075  utation_and_inpu
-00004eb0: 7473 282a 6172 6773 2c20 2a2a 6b77 6172  ts(*args, **kwar
-00004ec0: 6773 290a 2020 2020 2020 2020 666f 7220  gs).        for 
-00004ed0: 7020 696e 2063 6f6d 7075 7461 7469 6f6e  p in computation
-00004ee0: 5f69 6e70 7574 733a 0a20 2020 2020 2020  _inputs:.       
-00004ef0: 2020 2020 2069 6620 6973 696e 7374 616e       if isinstan
-00004f00: 6365 2870 2c20 746f 7263 682e 5465 6e73  ce(p, torch.Tens
-00004f10: 6f72 2920 616e 6420 702e 7265 7175 6972  or) and p.requir
-00004f20: 6573 5f67 7261 643a 0a20 2020 2020 2020  es_grad:.       
-00004f30: 2020 2020 2020 2020 2023 2053 7570 706f           # Suppo
-00004f40: 7274 7320 6772 6164 2061 6363 756d 756c  rts grad accumul
-00004f50: 6174 696f 6e20 286c 696b 6520 7768 656e  ation (like when
-00004f60: 2077 6569 6768 7420 7479 696e 6729 0a20   weight tying). 
-00004f70: 2020 2020 2020 2020 2020 2020 2020 2069                 i
-00004f80: 6620 702e 6772 6164 2069 7320 6e6f 7420  f p.grad is not 
-00004f90: 4e6f 6e65 3a0a 2020 2020 2020 2020 2020  None:.          
-00004fa0: 2020 2020 2020 2020 2020 702e 6772 6164            p.grad
-00004fb0: 202b 3d20 6772 6164 735b 6964 785d 0a20   += grads[idx]. 
-00004fc0: 2020 2020 2020 2020 2020 2020 2020 2065                 e
-00004fd0: 6c73 653a 0a20 2020 2020 2020 2020 2020  lse:.           
-00004fe0: 2020 2020 2020 2020 2070 2e67 7261 6420           p.grad 
-00004ff0: 3d20 6772 6164 735b 6964 785d 0a20 2020  = grads[idx].   
-00005000: 2020 2020 2020 2020 2020 2020 2069 6478               idx
-00005010: 202b 3d20 310a 2020 2020 2020 2020 7265   += 1.        re
-00005020: 7475 726e 0a0a 2020 2020 2320 5368 6f72  turn..    # Shor
-00005030: 742d 6369 7263 7569 7473 2069 6620 7468  t-circuits if th
-00005040: 6572 6520 6172 6520 6e6f 2061 7267 7320  ere are no args 
-00005050: 6f72 206b 7761 7267 730a 2020 2020 6966  or kwargs.    if
-00005060: 2061 7267 7320 6973 204e 6f6e 6520 616e   args is None an
-00005070: 6420 6b77 6172 6773 2069 7320 4e6f 6e65  d kwargs is None
-00005080: 3a0a 2020 2020 2020 2020 7265 7475 726e  :.        return
-00005090: 0a0a 2020 2020 666c 6174 732c 205f 203d  ..    flats, _ =
-000050a0: 2074 7265 655f 666c 6174 7465 6e28 2861   tree_flatten((a
-000050b0: 7267 732c 206b 7761 7267 7329 290a 2020  rgs, kwargs)).  
-000050c0: 2020 666f 7220 6620 696e 2066 6c61 7473    for f in flats
-000050d0: 3a0a 2020 2020 2020 2020 6966 2069 7369  :.        if isi
-000050e0: 6e73 7461 6e63 6528 662c 2074 6f72 6368  nstance(f, torch
-000050f0: 2e54 656e 736f 7229 2061 6e64 2066 2e72  .Tensor) and f.r
-00005100: 6571 7569 7265 735f 6772 6164 3a0a 2020  equires_grad:.  
-00005110: 2020 2020 2020 2020 2020 662e 6772 6164            f.grad
-00005120: 203d 2067 7261 6473 5b69 6478 5d0a 2020   = grads[idx].  
-00005130: 2020 2020 2020 2020 2020 6964 7820 2b3d            idx +=
-00005140: 2031 0a0a 0a64 6566 2065 7874 7261 6374   1...def extract
-00005150: 5f67 7261 6473 286d 6f64 756c 653a 2074  _grads(module: t
-00005160: 6f72 6368 2e6e 6e2e 4d6f 6475 6c65 2920  orch.nn.Module) 
-00005170: 2d3e 2074 7570 6c65 5b74 6f72 6368 2e54  -> tuple[torch.T
-00005180: 656e 736f 722c 202e 2e2e 5d3a 0a20 2020  ensor, ...]:.   
-00005190: 2067 7261 6473 203d 2074 7570 6c65 280a   grads = tuple(.
-000051a0: 2020 2020 2020 2020 662e 6772 6164 0a20          f.grad. 
-000051b0: 2020 2020 2020 2066 6f72 2066 2069 6e20         for f in 
-000051c0: 6368 6169 6e28 6d6f 6475 6c65 2e70 6172  chain(module.par
-000051d0: 616d 6574 6572 7328 292c 206d 6f64 756c  ameters(), modul
-000051e0: 652e 6275 6666 6572 7328 2929 0a20 2020  e.buffers()).   
-000051f0: 2020 2020 2069 6620 6973 696e 7374 616e       if isinstan
-00005200: 6365 2866 2c20 746f 7263 682e 5465 6e73  ce(f, torch.Tens
-00005210: 6f72 2920 616e 6420 662e 7265 7175 6972  or) and f.requir
-00005220: 6573 5f67 7261 6420 616e 6420 662e 6772  es_grad and f.gr
-00005230: 6164 2069 7320 6e6f 7420 4e6f 6e65 0a20  ad is not None. 
-00005240: 2020 2029 0a20 2020 2072 6574 7572 6e20     ).    return 
-00005250: 6772 6164 730a 0a0a 6465 6620 636c 6561  grads...def clea
-00005260: 725f 6772 6164 7328 6d6f 6475 6c65 3a20  r_grads(module: 
-00005270: 746f 7263 682e 6e6e 2e4d 6f64 756c 6529  torch.nn.Module)
-00005280: 202d 3e20 4e6f 6e65 3a0a 2020 2020 6966   -> None:.    if
-00005290: 206e 6f74 2069 7369 6e73 7461 6e63 6528   not isinstance(
-000052a0: 6d6f 6475 6c65 2c20 746f 7263 682e 6e6e  module, torch.nn
-000052b0: 2e4d 6f64 756c 6529 3a0a 2020 2020 2020  .Module):.      
-000052c0: 2020 7265 7475 726e 0a0a 2020 2020 666f    return..    fo
-000052d0: 7220 7020 696e 206d 6f64 756c 652e 7061  r p in module.pa
-000052e0: 7261 6d65 7465 7273 2829 3a0a 2020 2020  rameters():.    
-000052f0: 2020 2020 702e 6772 6164 203d 204e 6f6e      p.grad = Non
-00005300: 650a 2020 2020 666f 7220 6220 696e 206d  e.    for b in m
-00005310: 6f64 756c 652e 6275 6666 6572 7328 293a  odule.buffers():
-00005320: 0a20 2020 2020 2020 2062 2e67 7261 6420  .        b.grad 
-00005330: 3d20 4e6f 6e65 0a0a 0a66 726f 6d20 7468  = None...from th
-00005340: 756e 6465 722e 636f 7265 2e69 6e74 6572  under.core.inter
-00005350: 7072 6574 6572 2069 6d70 6f72 7420 6d61  preter import ma
-00005360: 6b65 5f6f 7061 7175 650a 6672 6f6d 2074  ke_opaque.from t
-00005370: 6875 6e64 6572 2e63 6f72 652e 6c61 6e67  hunder.core.lang
-00005380: 6374 7873 2069 6d70 6f72 7420 6c61 6e67  ctxs import lang
-00005390: 6374 782c 204c 616e 6775 6167 6573 0a0a  ctx, Languages..
-000053a0: 0a23 2054 4f44 4f20 5243 3120 5265 706c  .# TODO RC1 Repl
-000053b0: 6163 6520 7769 7468 206c 616e 6763 7478  ace with langctx
-000053c0: 0a64 6566 2074 6f72 6368 6374 7828 666e  .def torchctx(fn
-000053d0: 293a 0a20 2020 205f 666e 203d 206c 616e  ):.    _fn = lan
-000053e0: 6763 7478 284c 616e 6775 6167 6573 2e54  gctx(Languages.T
-000053f0: 4f52 4348 2928 666e 290a 2020 2020 7265  ORCH)(fn).    re
-00005400: 7475 726e 206d 616b 655f 6f70 6171 7565  turn make_opaque
-00005410: 285f 666e 290a 0a0a 5f67 7261 645f 666e  (_fn)..._grad_fn
-00005420: 5f6d 6170 3a20 6469 6374 5b41 6e79 2c20  _map: dict[Any, 
-00005430: 4361 6c6c 6162 6c65 5d20 3d20 7b7d 0a0a  Callable] = {}..
-00005440: 0a64 6566 2072 6567 6973 7465 725f 6772  .def register_gr
-00005450: 6164 2873 796d 5f6f 725f 6964 3a20 5379  ad(sym_or_id: Sy
-00005460: 6d62 6f6c 207c 2041 6e79 2c20 6772 6164  mbol | Any, grad
-00005470: 666e 3a20 4361 6c6c 6162 6c65 2920 2d3e  fn: Callable) ->
-00005480: 204e 6f6e 653a 0a20 2020 2069 643a 2041   None:.    id: A
-00005490: 6e79 203d 2073 796d 5f6f 725f 6964 0a20  ny = sym_or_id. 
-000054a0: 2020 2069 6620 6973 696e 7374 616e 6365     if isinstance
-000054b0: 2873 796d 5f6f 725f 6964 2c20 5379 6d62  (sym_or_id, Symb
-000054c0: 6f6c 293a 0a20 2020 2020 2020 2069 6420  ol):.        id 
-000054d0: 3d20 7379 6d5f 6f72 5f69 642e 6964 0a20  = sym_or_id.id. 
-000054e0: 2020 205f 6772 6164 5f66 6e5f 6d61 705b     _grad_fn_map[
-000054f0: 6964 5d20 3d20 6772 6164 666e 0a0a 0a23  id] = gradfn...#
-00005500: 2047 7261 6420 6675 6e63 7469 6f6e 7320   Grad functions 
-00005510: 666f 7220 7072 696d 730a 6672 6f6d 2074  for prims.from t
-00005520: 6875 6e64 6572 2e63 6f72 652e 7072 696d  hunder.core.prim
-00005530: 7320 696d 706f 7274 2050 7269 6d49 4473  s import PrimIDs
-00005540: 2061 7320 7069 6473 2c20 6765 745f 6772   as pids, get_gr
-00005550: 6164 2c20 7075 745f 6772 6164 0a0a 0a23  ad, put_grad...#
-00005560: 2041 2067 656e 6572 616c 697a 6174 696f   A generalizatio
-00005570: 6e20 6f66 2070 7269 6d73 2e70 7574 5f67  n of prims.put_g
-00005580: 7261 6420 746f 2070 7974 7265 6573 0a23  rad to pytrees.#
-00005590: 2054 4f44 4f20 436f 6e73 6964 6572 2076   TODO Consider v
-000055a0: 616c 6964 6174 696e 6720 7468 6174 2074  alidating that t
-000055b0: 6865 2073 7065 6373 2061 7265 2074 6865  he specs are the
-000055c0: 2073 616d 650a 2320 544f 444f 2043 6f6e   same.# TODO Con
-000055d0: 7369 6465 7220 7661 6c69 6461 7469 6e67  sider validating
-000055e0: 2074 6861 7420 7468 6174 206f 626a 6563   that that objec
-000055f0: 7420 7265 7175 6972 6573 2067 7261 6420  t requires grad 
-00005600: 2861 6e64 2066 696c 7465 7269 6e67 206f  (and filtering o
-00005610: 2e77 2e29 0a64 6566 2070 7574 5f67 7261  .w.).def put_gra
-00005620: 6473 2861 2c20 6729 3a0a 2020 2020 666c  ds(a, g):.    fl
-00005630: 6174 732c 205f 203d 2074 7265 655f 666c  ats, _ = tree_fl
-00005640: 6174 7465 6e28 6129 0a20 2020 2066 6c61  atten(a).    fla
-00005650: 7467 7261 6473 2c20 5f20 3d20 7472 6565  tgrads, _ = tree
-00005660: 5f66 6c61 7474 656e 2867 290a 0a20 2020  _flatten(g)..   
-00005670: 2066 6f72 2066 2c20 6667 2069 6e20 7a69   for f, fg in zi
-00005680: 7028 666c 6174 732c 2066 6c61 7467 7261  p(flats, flatgra
-00005690: 6473 293a 0a20 2020 2020 2020 2069 6620  ds):.        if 
-000056a0: 6973 696e 7374 616e 6365 2866 2c20 5465  isinstance(f, Te
-000056b0: 6e73 6f72 5072 6f78 7929 2061 6e64 2069  nsorProxy) and i
-000056c0: 7369 6e73 7461 6e63 6528 6667 2c20 5465  sinstance(fg, Te
-000056d0: 6e73 6f72 5072 6f78 7929 3a0a 2020 2020  nsorProxy):.    
-000056e0: 2020 2020 2020 2020 7075 745f 6772 6164          put_grad
-000056f0: 2866 2c20 6667 290a 0a0a 230a 2320 556e  (f, fg)...#.# Un
-00005700: 7061 636b 696e 6720 6f70 6572 6174 6f72  packing operator
-00005710: 2067 7261 6473 0a23 0a0a 2320 4e4f 5445   grads.#..# NOTE
-00005720: 2070 7269 6d73 2e75 6e70 6163 6b5f 656d   prims.unpack_em
-00005730: 7074 795f 6469 6374 2063 7265 6174 6573  pty_dict creates
-00005740: 206e 6f20 6772 6164 2061 7373 6f63 6961   no grad associa
-00005750: 7469 6f6e 730a 7265 6769 7374 6572 5f67  tions.register_g
-00005760: 7261 6428 7069 6473 2e55 4e50 4143 4b5f  rad(pids.UNPACK_
-00005770: 454d 5054 595f 4449 4354 2c20 7072 696d  EMPTY_DICT, prim
-00005780: 732e 756e 7061 636b 5f65 6d70 7479 5f64  s.unpack_empty_d
-00005790: 6963 7429 0a0a 2320 4e4f 5445 2070 7269  ict)..# NOTE pri
-000057a0: 6d73 2e75 6e70 6163 6b5f 6b65 7920 6372  ms.unpack_key cr
-000057b0: 6561 7465 7320 6e6f 2067 7261 6420 6173  eates no grad as
-000057c0: 736f 6369 6174 696f 6e73 0a72 6567 6973  sociations.regis
-000057d0: 7465 725f 6772 6164 2870 6964 732e 554e  ter_grad(pids.UN
-000057e0: 5041 434b 5f4b 4559 2c20 7072 696d 732e  PACK_KEY, prims.
-000057f0: 756e 7061 636b 5f6b 6579 290a 0a23 204e  unpack_key)..# N
-00005800: 4f54 4520 7072 696d 732e 756e 7061 636b  OTE prims.unpack
-00005810: 5f73 6571 7565 6e63 6520 6372 6561 7465  _sequence create
-00005820: 7320 6e6f 2067 7261 6420 6173 736f 6369  s no grad associ
-00005830: 6174 696f 6e73 0a72 6567 6973 7465 725f  ations.register_
-00005840: 6772 6164 2870 6964 732e 554e 5041 434b  grad(pids.UNPACK
-00005850: 5f53 4551 5545 4e43 452c 2070 7269 6d73  _SEQUENCE, prims
-00005860: 2e75 6e70 6163 6b5f 7365 7175 656e 6365  .unpack_sequence
-00005870: 290a 0a0a 230a 2320 4461 7461 206d 6f76  )...#.# Data mov
-00005880: 656d 656e 7420 616e 6420 7472 616e 7366  ement and transf
-00005890: 6f72 6d61 7469 6f6e 206f 7065 7261 746f  ormation operato
-000058a0: 7220 6772 6164 730a 230a 4074 6f72 6368  r grads.#.@torch
-000058b0: 6374 780a 6465 6620 5f63 6f6e 7665 7274  ctx.def _convert
-000058c0: 5f65 6c65 6d65 6e74 5f74 7970 655f 7072  _element_type_pr
-000058d0: 696d 5f67 7261 6428 613a 204e 756d 6265  im_grad(a: Numbe
-000058e0: 7220 7c20 5465 6e73 6f72 5072 6f78 792c  r | TensorProxy,
-000058f0: 2064 7479 7065 3a20 7479 7065 207c 2064   dtype: type | d
-00005900: 7479 7065 732e 6474 7970 6529 202d 3e20  types.dtype) -> 
-00005910: 4e75 6d62 6572 207c 2054 656e 736f 7250  Number | TensorP
-00005920: 726f 7879 3a0a 2020 2020 6677 6420 3d20  roxy:.    fwd = 
-00005930: 7072 696d 732e 636f 6e76 6572 745f 656c  prims.convert_el
-00005940: 656d 656e 745f 7479 7065 2861 2c20 6474  ement_type(a, dt
-00005950: 7970 6529 0a0a 2020 2020 6720 3d20 6765  ype)..    g = ge
-00005960: 745f 6772 6164 2866 7764 290a 2020 2020  t_grad(fwd).    
-00005970: 675f 636f 6e76 6572 7465 6420 3d20 7072  g_converted = pr
-00005980: 696d 732e 636f 6e76 6572 745f 656c 656d  ims.convert_elem
-00005990: 656e 745f 7479 7065 2867 2c20 6474 7970  ent_type(g, dtyp
-000059a0: 6573 2e74 6f5f 6474 7970 6528 6129 290a  es.to_dtype(a)).
-000059b0: 2020 2020 7075 745f 6772 6164 2861 2c20      put_grad(a, 
-000059c0: 675f 636f 6e76 6572 7465 6429 0a0a 2020  g_converted)..  
-000059d0: 2020 7265 7475 726e 2066 7764 0a0a 0a72    return fwd...r
-000059e0: 6567 6973 7465 725f 6772 6164 2870 6964  egister_grad(pid
-000059f0: 732e 434f 4e56 4552 545f 454c 454d 454e  s.CONVERT_ELEMEN
-00005a00: 545f 5459 5045 2c20 5f63 6f6e 7665 7274  T_TYPE, _convert
-00005a10: 5f65 6c65 6d65 6e74 5f74 7970 655f 7072  _element_type_pr
-00005a20: 696d 5f67 7261 6429 0a0a 230a 2320 5465  im_grad)..#.# Te
-00005a30: 6e73 6f72 2063 7265 6174 696f 6e20 6f70  nsor creation op
-00005a40: 6572 6174 6f72 2067 7261 6473 0a23 0a0a  erator grads.#..
-00005a50: 2320 4e4f 5445 2070 7269 6d73 2e66 756c  # NOTE prims.ful
-00005a60: 6c20 6372 6561 7465 7320 6e6f 2067 7261  l creates no gra
-00005a70: 6420 6173 736f 6369 6174 696f 6e73 0a72  d associations.r
-00005a80: 6567 6973 7465 725f 6772 6164 2870 6964  egister_grad(pid
-00005a90: 732e 4655 4c4c 2c20 7072 696d 732e 6675  s.FULL, prims.fu
-00005aa0: 6c6c 290a 0a23 204e 4f54 4520 7072 696d  ll)..# NOTE prim
-00005ab0: 732e 696f 7461 2063 7265 6174 6573 206e  s.iota creates n
-00005ac0: 6f20 6772 6164 2061 7373 6f63 6961 7469  o grad associati
-00005ad0: 6f6e 730a 7265 6769 7374 6572 5f67 7261  ons.register_gra
-00005ae0: 6428 7069 6473 2e49 4f54 412c 2070 7269  d(pids.IOTA, pri
-00005af0: 6d73 2e69 6f74 6129 0a0a 0a64 6566 205f  ms.iota)...def _
-00005b00: 756e 6966 6f72 6d5f 6772 6164 2873 6861  uniform_grad(sha
-00005b10: 7065 2c20 6d69 6e76 616c 2c20 6d61 7876  pe, minval, maxv
-00005b20: 616c 2c20 2a2c 2064 6576 6963 652c 2064  al, *, device, d
-00005b30: 7479 7065 293a 0a20 2020 2066 7764 2c20  type):.    fwd, 
-00005b40: 7361 7665 6420 3d20 756e 6966 6f72 6d5f  saved = uniform_
-00005b50: 6175 675f 6677 6428 7368 6170 652c 206d  aug_fwd(shape, m
-00005b60: 696e 7661 6c2c 206d 6178 7661 6c2c 2064  inval, maxval, d
-00005b70: 6576 6963 653d 6465 7669 6365 2c20 6474  evice=device, dt
-00005b80: 7970 653d 6474 7970 6529 0a20 2020 2067  ype=dtype).    g
-00005b90: 203d 2067 6574 5f67 7261 6428 6677 6429   = get_grad(fwd)
-00005ba0: 0a20 2020 205f 2c20 676d 696e 7661 6c2c  .    _, gminval,
-00005bb0: 2067 6d61 7876 616c 203d 2075 6e69 666f   gmaxval = unifo
-00005bc0: 726d 5f62 6163 6b77 6172 6428 2a73 6176  rm_backward(*sav
-00005bd0: 6564 2c20 6729 0a20 2020 2070 7574 5f67  ed, g).    put_g
-00005be0: 7261 6473 2828 6d69 6e76 616c 2c20 6d61  rads((minval, ma
-00005bf0: 7876 616c 292c 2028 676d 696e 7661 6c2c  xval), (gminval,
-00005c00: 2067 6d61 7876 616c 2929 0a20 2020 2072   gmaxval)).    r
-00005c10: 6574 7572 6e20 6677 640a 0a0a 7265 6769  eturn fwd...regi
-00005c20: 7374 6572 5f67 7261 6428 7069 6473 2e55  ster_grad(pids.U
-00005c30: 4e49 464f 524d 2c20 5f75 6e69 666f 726d  NIFORM, _uniform
-00005c40: 5f67 7261 6429 0a0a 230a 2320 5265 7368  _grad)..#.# Resh
-00005c50: 6170 696e 6720 616e 6420 7065 726d 7574  aping and permut
-00005c60: 696e 6720 6f70 6572 6174 6f72 2067 7261  ing operator gra
-00005c70: 6473 0a23 0a0a 0a40 746f 7263 6863 7478  ds.#...@torchctx
-00005c80: 0a64 6566 205f 6272 6f61 6463 6173 745f  .def _broadcast_
-00005c90: 696e 5f64 696d 5f70 7269 6d5f 6772 6164  in_dim_prim_grad
-00005ca0: 280a 2020 2020 613a 2054 656e 736f 7250  (.    a: TensorP
-00005cb0: 726f 7879 2c20 7368 6170 653a 2053 6571  roxy, shape: Seq
-00005cc0: 7565 6e63 655b 696e 745d 2c20 6272 6f61  uence[int], broa
-00005cd0: 6463 6173 745f 6469 6d65 6e73 696f 6e73  dcast_dimensions
-00005ce0: 3a20 5365 7175 656e 6365 5b69 6e74 5d0a  : Sequence[int].
-00005cf0: 2920 2d3e 2054 656e 736f 7250 726f 7879  ) -> TensorProxy
-00005d00: 3a0a 2020 2020 6677 6420 3d20 7072 696d  :.    fwd = prim
-00005d10: 732e 6272 6f61 6463 6173 745f 696e 5f64  s.broadcast_in_d
-00005d20: 696d 2861 2c20 7368 6170 652c 2062 726f  im(a, shape, bro
-00005d30: 6164 6361 7374 5f64 696d 656e 7369 6f6e  adcast_dimension
-00005d40: 7329 0a0a 2020 2020 6720 3d20 6765 745f  s)..    g = get_
-00005d50: 6772 6164 2866 7764 290a 0a20 2020 2075  grad(fwd)..    u
-00005d60: 6e69 745f 6469 6d73 203d 2074 7570 6c65  nit_dims = tuple
-00005d70: 2869 2066 6f72 2069 2c20 7320 696e 2065  (i for i, s in e
-00005d80: 6e75 6d65 7261 7465 2861 2e73 6861 7065  numerate(a.shape
-00005d90: 2920 6966 2073 203d 3d20 3129 0a20 2020  ) if s == 1).   
-00005da0: 2062 6361 7374 5f64 696d 7320 3d20 7475   bcast_dims = tu
-00005db0: 706c 6528 6220 666f 7220 692c 2062 2069  ple(b for i, b i
-00005dc0: 6e20 656e 756d 6572 6174 6528 6272 6f61  n enumerate(broa
-00005dd0: 6463 6173 745f 6469 6d65 6e73 696f 6e73  dcast_dimensions
-00005de0: 2920 6966 2069 206e 6f74 2069 6e20 756e  ) if i not in un
-00005df0: 6974 5f64 696d 7329 0a20 2020 2072 6564  it_dims).    red
-00005e00: 7563 655f 6469 6d73 203d 2074 7570 6c65  uce_dims = tuple
-00005e10: 2873 2066 6f72 2069 2c20 7320 696e 2065  (s for i, s in e
-00005e20: 6e75 6d65 7261 7465 2872 616e 6765 286c  numerate(range(l
-00005e30: 656e 2873 6861 7065 2929 2920 6966 2069  en(shape))) if i
-00005e40: 206e 6f74 2069 6e20 6263 6173 745f 6469   not in bcast_di
-00005e50: 6d73 290a 0a20 2020 2067 203d 206c 746f  ms)..    g = lto
-00005e60: 7263 682e 7375 6d28 672c 2072 6564 7563  rch.sum(g, reduc
-00005e70: 655f 6469 6d73 290a 0a20 2020 2023 204e  e_dims)..    # N
-00005e80: 4f54 4520 5468 6973 206d 7573 7420 6265  OTE This must be
-00005e90: 2063 6c61 6e67 2e75 6e73 7175 6565 7a65   clang.unsqueeze
-00005ea0: 2062 6563 6175 7365 2074 6f72 6368 2e75   because torch.u
-00005eb0: 6e73 7175 6565 7a65 2c20 756e 6c69 6b65  nsqueeze, unlike
-00005ec0: 2063 6c61 6e67 2e75 6e73 7175 6565 7a65   clang.unsqueeze
-00005ed0: 2c20 6f6e 6c79 2061 6363 6570 7473 2061  , only accepts a
-00005ee0: 6e20 696e 7465 6765 720a 2020 2020 2320  n integer.    # 
-00005ef0: 2020 2870 7574 2061 6e6f 7468 6572 2077    (put another w
-00005f00: 6179 2c20 746f 7263 6820 6f6e 6c79 2061  ay, torch only a
-00005f10: 6c6c 6f77 7320 6f6e 6520 756e 7371 7565  llows one unsque
-00005f20: 657a 6520 6174 2061 2074 696d 6529 0a20  eze at a time). 
-00005f30: 2020 2067 203d 2063 6c61 6e67 2e75 6e73     g = clang.uns
-00005f40: 7175 6565 7a65 2867 2c20 756e 6974 5f64  queeze(g, unit_d
-00005f50: 696d 7329 0a0a 2020 2020 7075 745f 6772  ims)..    put_gr
-00005f60: 6164 2861 2c20 6729 0a0a 2020 2020 7265  ad(a, g)..    re
-00005f70: 7475 726e 2066 7764 0a0a 0a72 6567 6973  turn fwd...regis
-00005f80: 7465 725f 6772 6164 2870 6964 732e 4252  ter_grad(pids.BR
-00005f90: 4f41 4443 4153 545f 494e 5f44 494d 2c20  OADCAST_IN_DIM, 
-00005fa0: 5f62 726f 6164 6361 7374 5f69 6e5f 6469  _broadcast_in_di
-00005fb0: 6d5f 7072 696d 5f67 7261 6429 0a0a 0a40  m_prim_grad)...@
-00005fc0: 746f 7263 6863 7478 0a64 6566 205f 6361  torchctx.def _ca
-00005fd0: 745f 7072 696d 5f67 7261 6428 7465 6e73  t_prim_grad(tens
-00005fe0: 6f72 733a 206c 6973 745b 5465 6e73 6f72  ors: list[Tensor
-00005ff0: 5072 6f78 795d 2c20 2f2c 2064 696d 3a20  Proxy], /, dim: 
-00006000: 696e 7429 202d 3e20 5465 6e73 6f72 5072  int) -> TensorPr
-00006010: 6f78 793a 0a20 2020 2066 7764 203d 2070  oxy:.    fwd = p
-00006020: 7269 6d73 2e63 6174 2874 656e 736f 7273  rims.cat(tensors
-00006030: 2c20 6469 6d29 0a0a 2020 2020 6720 3d20  , dim)..    g = 
-00006040: 6765 745f 6772 6164 2866 7764 290a 0a20  get_grad(fwd).. 
-00006050: 2020 2073 6c69 6365 5f73 7461 7274 3a20     slice_start: 
-00006060: 696e 7420 3d20 300a 2020 2020 743a 2054  int = 0.    t: T
-00006070: 656e 736f 7250 726f 7879 0a20 2020 2066  ensorProxy.    f
-00006080: 6f72 2074 2069 6e20 7465 6e73 6f72 733a  or t in tensors:
-00006090: 0a20 2020 2020 2020 2064 696d 5f6c 656e  .        dim_len
-000060a0: 3a20 696e 7420 3d20 742e 7368 6170 655b  : int = t.shape[
-000060b0: 6469 6d5d 0a20 2020 2020 2020 2073 6c69  dim].        sli
-000060c0: 6365 5f65 6e64 3a20 696e 7420 3d20 736c  ce_end: int = sl
-000060d0: 6963 655f 7374 6172 7420 2b20 6469 6d5f  ice_start + dim_
-000060e0: 6c65 6e0a 2020 2020 2020 2020 675f 736c  len.        g_sl
-000060f0: 6963 653a 2054 656e 736f 7250 726f 7879  ice: TensorProxy
-00006100: 203d 2063 6c61 6e67 2e73 6c69 6365 5f69   = clang.slice_i
-00006110: 6e5f 6469 6d28 672c 2073 6c69 6365 5f73  n_dim(g, slice_s
-00006120: 7461 7274 2c20 736c 6963 655f 656e 642c  tart, slice_end,
-00006130: 2064 696d 3d64 696d 290a 2020 2020 2020   dim=dim).      
-00006140: 2020 736c 6963 655f 7374 6172 7420 3d20    slice_start = 
-00006150: 736c 6963 655f 656e 640a 2020 2020 2020  slice_end.      
-00006160: 2020 7075 745f 6772 6164 2874 2c20 675f    put_grad(t, g_
-00006170: 736c 6963 6529 0a0a 2020 2020 7265 7475  slice)..    retu
-00006180: 726e 2066 7764 0a0a 0a72 6567 6973 7465  rn fwd...registe
-00006190: 725f 6772 6164 2870 6964 732e 4341 542c  r_grad(pids.CAT,
-000061a0: 205f 6361 745f 7072 696d 5f67 7261 6429   _cat_prim_grad)
-000061b0: 0a0a 0a64 6566 205f 7265 7368 6170 655f  ...def _reshape_
-000061c0: 7072 696d 5f67 7261 6428 613a 2054 656e  prim_grad(a: Ten
-000061d0: 736f 7250 726f 7879 2c20 7368 6170 653a  sorProxy, shape:
-000061e0: 2074 7570 6c65 5b69 6e74 2c20 2e2e 2e5d   tuple[int, ...]
-000061f0: 2920 2d3e 2054 656e 736f 7250 726f 7879  ) -> TensorProxy
-00006200: 3a0a 2020 2020 6677 6420 3d20 7072 696d  :.    fwd = prim
-00006210: 732e 7265 7368 6170 6528 612c 2073 6861  s.reshape(a, sha
-00006220: 7065 290a 0a20 2020 2067 203d 2067 6574  pe)..    g = get
-00006230: 5f67 7261 6428 6677 6429 0a0a 2020 2020  _grad(fwd)..    
-00006240: 615f 6772 6164 203d 2070 7269 6d73 2e72  a_grad = prims.r
-00006250: 6573 6861 7065 2867 2c20 612e 7368 6170  eshape(g, a.shap
-00006260: 6529 0a20 2020 2070 7574 5f67 7261 6428  e).    put_grad(
-00006270: 612c 2061 5f67 7261 6429 0a0a 2020 2020  a, a_grad)..    
-00006280: 7265 7475 726e 2066 7764 0a0a 0a72 6567  return fwd...reg
-00006290: 6973 7465 725f 6772 6164 2870 6964 732e  ister_grad(pids.
-000062a0: 5245 5348 4150 452c 205f 7265 7368 6170  RESHAPE, _reshap
-000062b0: 655f 7072 696d 5f67 7261 6429 0a0a 0a40  e_prim_grad)...@
-000062c0: 746f 7263 6863 7478 0a64 6566 205f 736c  torchctx.def _sl
-000062d0: 6963 655f 7072 696d 5f67 7261 6428 0a20  ice_prim_grad(. 
-000062e0: 2020 2061 3a20 5465 6e73 6f72 5072 6f78     a: TensorProx
-000062f0: 792c 2073 7461 7274 5f69 6e64 6963 6573  y, start_indices
-00006300: 3a20 5365 7175 656e 6365 5b69 6e74 5d2c  : Sequence[int],
-00006310: 2065 6e64 5f69 6e64 6963 6573 3a20 5365   end_indices: Se
-00006320: 7175 656e 6365 5b69 6e74 5d2c 2073 7472  quence[int], str
-00006330: 6964 6573 3a20 4e6f 6e65 207c 2053 6571  ides: None | Seq
-00006340: 7565 6e63 655b 696e 745d 203d 204e 6f6e  uence[int] = Non
-00006350: 650a 2920 2d3e 2054 656e 736f 7250 726f  e.) -> TensorPro
-00006360: 7879 3a0a 2020 2020 6677 6420 3d20 7072  xy:.    fwd = pr
-00006370: 696d 732e 736c 6963 655f 7072 696d 2861  ims.slice_prim(a
-00006380: 2c20 7374 6172 745f 696e 6469 6365 732c  , start_indices,
-00006390: 2065 6e64 5f69 6e64 6963 6573 2c20 7374   end_indices, st
-000063a0: 7269 6465 7329 0a0a 2020 2020 6720 3d20  rides)..    g = 
-000063b0: 6765 745f 6772 6164 2866 7764 290a 0a20  get_grad(fwd).. 
-000063c0: 2020 2070 6164 6469 6e67 203d 204e 6f6e     padding = Non
-000063d0: 650a 2020 2020 6966 2073 7472 6964 6573  e.    if strides
-000063e0: 2069 7320 4e6f 6e65 206f 7220 6e70 2e61   is None or np.a
-000063f0: 6c6c 286e 702e 6571 7561 6c28 7374 7269  ll(np.equal(stri
-00006400: 6465 732c 2031 2929 3a0a 2020 2020 2020  des, 1)):.      
-00006410: 2020 7061 6464 696e 6720 3d20 7475 706c    padding = tupl
-00006420: 6528 7a69 7028 7374 6172 745f 696e 6469  e(zip(start_indi
-00006430: 6365 732c 206e 702e 7375 6274 7261 6374  ces, np.subtract
-00006440: 2861 2e73 6861 7065 2c20 656e 645f 696e  (a.shape, end_in
-00006450: 6469 6365 7329 2c20 2830 2c29 202a 206c  dices), (0,) * l
-00006460: 656e 2873 7461 7274 5f69 6e64 6963 6573  en(start_indices
-00006470: 2929 290a 2020 2020 656c 7365 3a0a 2020  ))).    else:.  
-00006480: 2020 2020 2020 7265 616c 5f6c 696d 6974        real_limit
-00006490: 7320 3d20 6e70 2e61 6464 280a 2020 2020  s = np.add(.    
-000064a0: 2020 2020 2020 2020 7374 6172 745f 696e          start_in
-000064b0: 6469 6365 732c 0a20 2020 2020 2020 2020  dices,.         
-000064c0: 2020 206e 702e 7768 6572 6528 6e70 2e65     np.where(np.e
-000064d0: 7175 616c 2867 2e73 6861 7065 2c20 3029  qual(g.shape, 0)
-000064e0: 2c20 302c 206e 702e 6164 6428 312c 206e  , 0, np.add(1, n
-000064f0: 702e 6d75 6c74 6970 6c79 286e 702e 7375  p.multiply(np.su
-00006500: 6274 7261 6374 2867 2e73 6861 7065 2c20  btract(g.shape, 
-00006510: 3129 2c20 7374 7269 6465 7329 2929 2c0a  1), strides))),.
-00006520: 2020 2020 2020 2020 290a 2020 2020 2020          ).      
-00006530: 2020 7061 6464 696e 6720 3d20 7475 706c    padding = tupl
-00006540: 6528 7a69 7028 7374 6172 745f 696e 6469  e(zip(start_indi
-00006550: 6365 732c 206e 702e 7375 6274 7261 6374  ces, np.subtract
-00006560: 2861 2e73 6861 7065 2c20 7265 616c 5f6c  (a.shape, real_l
-00006570: 696d 6974 7329 2c20 6e70 2e73 7562 7472  imits), np.subtr
-00006580: 6163 7428 7374 7269 6465 732c 2031 2929  act(strides, 1))
-00006590: 290a 0a20 2020 2023 2043 6f6e 7665 7274  )..    # Convert
-000065a0: 7320 4e75 6d50 7920 6e75 6d62 6572 7320  s NumPy numbers 
-000065b0: 746f 2050 7974 686f 6e20 696e 7473 0a20  to Python ints. 
-000065c0: 2020 2023 2054 4f44 4f20 5368 6f75 6c64     # TODO Should
-000065d0: 2077 6520 7375 7070 6f72 7420 4e75 6d50   we support NumP
-000065e0: 7920 6e75 6d62 6572 7320 6265 7474 6572  y numbers better
-000065f0: 3f0a 2020 2020 7061 6464 696e 6720 3d20  ?.    padding = 
-00006600: 7472 6565 5f6d 6170 2869 6e74 2c20 7061  tree_map(int, pa
-00006610: 6464 696e 6729 0a20 2020 2061 5f67 7261  dding).    a_gra
-00006620: 6420 3d20 7072 696d 732e 7061 6428 672c  d = prims.pad(g,
-00006630: 2063 6f6e 7374 5f61 7328 302c 2067 2e64   const_as(0, g.d
-00006640: 7479 7065 292c 2070 6164 6469 6e67 290a  type), padding).
-00006650: 2020 2020 7075 745f 6772 6164 2861 2c20      put_grad(a, 
-00006660: 615f 6772 6164 290a 0a20 2020 2072 6574  a_grad)..    ret
-00006670: 7572 6e20 6677 640a 0a0a 7265 6769 7374  urn fwd...regist
-00006680: 6572 5f67 7261 6428 7069 6473 2e53 4c49  er_grad(pids.SLI
-00006690: 4345 2c20 5f73 6c69 6365 5f70 7269 6d5f  CE, _slice_prim_
-000066a0: 6772 6164 290a 0a0a 4074 6f72 6368 6374  grad)...@torchct
-000066b0: 780a 6465 6620 5f73 7175 6565 7a65 5f70  x.def _squeeze_p
-000066c0: 7269 6d5f 6772 6164 2861 3a20 5465 6e73  rim_grad(a: Tens
-000066d0: 6f72 5072 6f78 792c 202f 2c20 6469 6d73  orProxy, /, dims
-000066e0: 3a20 7475 706c 655b 696e 742c 202e 2e2e  : tuple[int, ...
-000066f0: 5d29 202d 3e20 5465 6e73 6f72 5072 6f78  ]) -> TensorProx
-00006700: 793a 0a20 2020 2066 7764 203d 2070 7269  y:.    fwd = pri
-00006710: 6d73 2e73 7175 6565 7a65 2861 2c20 7475  ms.squeeze(a, tu
-00006720: 706c 6528 6469 6d73 2929 0a0a 2020 2020  ple(dims))..    
-00006730: 6720 3d20 6765 745f 6772 6164 2866 7764  g = get_grad(fwd
-00006740: 290a 2020 2020 2320 4e4f 5445 2054 6869  ).    # NOTE Thi
-00006750: 7320 6361 6c6c 7320 636c 616e 672e 756e  s calls clang.un
-00006760: 7371 7565 657a 652c 2061 6e64 206e 6f74  squeeze, and not
-00006770: 2074 6f72 6368 2e75 6e73 7175 6565 7a65   torch.unsqueeze
-00006780: 2c20 6265 6361 7573 6520 746f 7263 682e  , because torch.
-00006790: 756e 7371 7565 657a 6520 6f6e 6c79 2073  unsqueeze only s
-000067a0: 7570 706f 7274 730a 2020 2020 2320 2020  upports.    #   
-000067b0: 756e 7371 7565 657a 696e 6720 6120 7369  unsqueezing a si
-000067c0: 6e67 6c65 2064 696d 656e 7369 6f6e 0a20  ngle dimension. 
-000067d0: 2020 2061 5f67 7261 6420 3d20 636c 616e     a_grad = clan
-000067e0: 672e 756e 7371 7565 657a 6528 672c 2064  g.unsqueeze(g, d
-000067f0: 696d 7329 0a20 2020 2070 7574 5f67 7261  ims).    put_gra
-00006800: 6428 612c 2061 5f67 7261 6429 0a0a 2020  d(a, a_grad)..  
-00006810: 2020 7265 7475 726e 2066 7764 0a0a 0a72    return fwd...r
-00006820: 6567 6973 7465 725f 6772 6164 2870 6964  egister_grad(pid
-00006830: 732e 5351 5545 455a 452c 205f 7371 7565  s.SQUEEZE, _sque
-00006840: 657a 655f 7072 696d 5f67 7261 6429 0a0a  eze_prim_grad)..
-00006850: 0a40 746f 7263 6863 7478 0a64 6566 205f  .@torchctx.def _
-00006860: 7461 6b65 5f70 7269 6d5f 6772 6164 2861  take_prim_grad(a
-00006870: 3a20 5465 6e73 6f72 5072 6f78 792c 2069  : TensorProxy, i
-00006880: 6e64 6578 3a20 5465 6e73 6f72 5072 6f78  ndex: TensorProx
-00006890: 792c 2064 696d 3a20 696e 7429 202d 3e20  y, dim: int) -> 
-000068a0: 5465 6e73 6f72 5072 6f78 793a 0a20 2020  TensorProxy:.   
-000068b0: 2066 7764 203d 2070 7269 6d73 2e74 616b   fwd = prims.tak
-000068c0: 6528 612c 2069 6e64 6578 2c20 6469 6d29  e(a, index, dim)
-000068d0: 0a0a 2020 2020 6720 3d20 6765 745f 6772  ..    g = get_gr
-000068e0: 6164 2866 7764 290a 0a20 2020 2023 2054  ad(fwd)..    # T
-000068f0: 4f44 4f20 5377 6974 6368 2074 6f20 6c74  ODO Switch to lt
-00006900: 6f72 6368 2e69 6e64 6578 5f61 6464 3f0a  orch.index_add?.
-00006910: 2020 2020 2320 4e4f 5445 2049 6e74 656e      # NOTE Inten
-00006920: 7469 6f6e 616c 6c79 206e 6f74 2063 616c  tionally not cal
-00006930: 6c69 6e67 207a 6572 6f73 5f6c 696b 6520  ling zeros_like 
-00006940: 746f 2061 766f 6964 2070 7265 7365 7276  to avoid preserv
-00006950: 696e 6720 610a 2020 2020 2320 544f 444f  ing a.    # TODO
-00006960: 2055 7064 6174 6520 746f 2063 616c 6c20   Update to call 
-00006970: 6c74 6f72 6368 2e7a 6572 6f73 0a20 2020  ltorch.zeros.   
-00006980: 207a 6572 6f73 203d 2070 7269 6d73 2e66   zeros = prims.f
-00006990: 756c 6c28 612e 7368 6170 652c 2066 696c  ull(a.shape, fil
-000069a0: 6c5f 7661 6c75 653d 302c 2064 6576 6963  l_value=0, devic
-000069b0: 653d 612e 6465 7669 6365 2c20 6474 7970  e=a.device, dtyp
-000069c0: 653d 612e 6474 7970 6529 0a20 2020 2061  e=a.dtype).    a
-000069d0: 5f67 7261 6420 3d20 7072 696d 732e 696e  _grad = prims.in
-000069e0: 6465 785f 6164 6428 7a65 726f 732c 2069  dex_add(zeros, i
-000069f0: 6e64 6578 2c20 672c 2064 696d 290a 2020  ndex, g, dim).  
-00006a00: 2020 7075 745f 6772 6164 2861 2c20 615f    put_grad(a, a_
-00006a10: 6772 6164 290a 0a20 2020 2072 6574 7572  grad)..    retur
-00006a20: 6e20 6677 640a 0a0a 7265 6769 7374 6572  n fwd...register
-00006a30: 5f67 7261 6428 7069 6473 2e54 414b 452c  _grad(pids.TAKE,
-00006a40: 205f 7461 6b65 5f70 7269 6d5f 6772 6164   _take_prim_grad
-00006a50: 290a 0a0a 4074 6f72 6368 6374 780a 6465  )...@torchctx.de
-00006a60: 6620 5f67 6174 6865 725f 7072 696d 5f67  f _gather_prim_g
-00006a70: 7261 6428 613a 2054 656e 736f 7250 726f  rad(a: TensorPro
-00006a80: 7879 2c20 696e 6465 783a 2054 656e 736f  xy, index: Tenso
-00006a90: 7250 726f 7879 2c20 6469 6d3a 2069 6e74  rProxy, dim: int
-00006aa0: 2920 2d3e 2054 656e 736f 7250 726f 7879  ) -> TensorProxy
-00006ab0: 3a0a 2020 2020 6677 6420 3d20 7072 696d  :.    fwd = prim
-00006ac0: 732e 6761 7468 6572 2861 2c20 696e 6465  s.gather(a, inde
-00006ad0: 782c 2064 696d 290a 0a20 2020 2067 203d  x, dim)..    g =
-00006ae0: 2067 6574 5f67 7261 6428 6677 6429 0a20   get_grad(fwd). 
-00006af0: 2020 2023 204e 4f54 4520 496e 7465 6e74     # NOTE Intent
-00006b00: 696f 6e61 6c6c 7920 6e6f 7420 6361 6c6c  ionally not call
-00006b10: 696e 6720 7a65 726f 735f 6c69 6b65 2074  ing zeros_like t
-00006b20: 6f20 6176 6f69 6420 7072 6573 6572 7669  o avoid preservi
-00006b30: 6e67 2054 656e 736f 7250 726f 7879 2061  ng TensorProxy a
-00006b40: 2e0a 2020 2020 2320 544f 444f 2055 7064  ..    # TODO Upd
-00006b50: 6174 6520 746f 2063 616c 6c20 6c74 6f72  ate to call ltor
-00006b60: 6368 2e7a 6572 6f73 0a20 2020 207a 6572  ch.zeros.    zer
-00006b70: 6f73 203d 2070 7269 6d73 2e66 756c 6c28  os = prims.full(
-00006b80: 612e 7368 6170 652c 2066 696c 6c5f 7661  a.shape, fill_va
-00006b90: 6c75 653d 302c 2064 6576 6963 653d 612e  lue=0, device=a.
-00006ba0: 6465 7669 6365 2c20 6474 7970 653d 612e  device, dtype=a.
-00006bb0: 6474 7970 6529 0a20 2020 2061 5f67 7261  dtype).    a_gra
-00006bc0: 6420 3d20 7072 696d 732e 7363 6174 7465  d = prims.scatte
-00006bd0: 725f 6164 6428 7a65 726f 732c 2069 6e64  r_add(zeros, ind
-00006be0: 6578 2c20 672c 2064 696d 290a 2020 2020  ex, g, dim).    
-00006bf0: 7075 745f 6772 6164 2861 2c20 615f 6772  put_grad(a, a_gr
-00006c00: 6164 290a 0a20 2020 2072 6574 7572 6e20  ad)..    return 
-00006c10: 6677 640a 0a0a 7265 6769 7374 6572 5f67  fwd...register_g
-00006c20: 7261 6428 7069 6473 2e47 4154 4845 522c  rad(pids.GATHER,
-00006c30: 205f 6761 7468 6572 5f70 7269 6d5f 6772   _gather_prim_gr
-00006c40: 6164 290a 0a0a 4074 6f72 6368 6374 780a  ad)...@torchctx.
-00006c50: 6465 6620 5f74 616b 655f 616c 6f6e 675f  def _take_along_
-00006c60: 6178 6973 5f70 7269 6d5f 6772 6164 2861  axis_prim_grad(a
-00006c70: 3a20 5465 6e73 6f72 5072 6f78 792c 2069  : TensorProxy, i
-00006c80: 6e64 6578 3a20 5465 6e73 6f72 5072 6f78  ndex: TensorProx
-00006c90: 792c 2064 696d 3a20 696e 7429 202d 3e20  y, dim: int) -> 
-00006ca0: 5465 6e73 6f72 5072 6f78 793a 0a20 2020  TensorProxy:.   
-00006cb0: 2066 7764 203d 2070 7269 6d73 2e74 616b   fwd = prims.tak
-00006cc0: 655f 616c 6f6e 675f 6178 6973 2861 2c20  e_along_axis(a, 
-00006cd0: 696e 6465 782c 2064 696d 290a 0a20 2020  index, dim)..   
-00006ce0: 2067 203d 2067 6574 5f67 7261 6428 6677   g = get_grad(fw
-00006cf0: 6429 0a20 2020 2023 204e 4f54 4520 496e  d).    # NOTE In
-00006d00: 7465 6e74 696f 6e61 6c6c 7920 6e6f 7420  tentionally not 
-00006d10: 6361 6c6c 696e 6720 7a65 726f 735f 6c69  calling zeros_li
-00006d20: 6b65 2074 6f20 6176 6f69 6420 7072 6573  ke to avoid pres
-00006d30: 6572 7669 6e67 2054 656e 736f 7250 726f  erving TensorPro
-00006d40: 7879 2061 2e0a 2020 2020 2320 544f 444f  xy a..    # TODO
-00006d50: 2055 7064 6174 6520 746f 2063 616c 6c20   Update to call 
-00006d60: 6c74 6f72 6368 2e7a 6572 6f73 0a20 2020  ltorch.zeros.   
-00006d70: 207a 6572 6f73 203d 2070 7269 6d73 2e66   zeros = prims.f
-00006d80: 756c 6c28 612e 7368 6170 652c 2066 696c  ull(a.shape, fil
-00006d90: 6c5f 7661 6c75 653d 302c 2064 6576 6963  l_value=0, devic
-00006da0: 653d 612e 6465 7669 6365 2c20 6474 7970  e=a.device, dtyp
-00006db0: 653d 612e 6474 7970 6529 0a20 2020 2061  e=a.dtype).    a
-00006dc0: 5f67 7261 6420 3d20 7072 696d 732e 7363  _grad = prims.sc
-00006dd0: 6174 7465 725f 6164 6428 7a65 726f 732c  atter_add(zeros,
-00006de0: 2069 6e64 6578 2c20 672c 2064 696d 290a   index, g, dim).
-00006df0: 2020 2020 7075 745f 6772 6164 2861 2c20      put_grad(a, 
-00006e00: 615f 6772 6164 290a 0a20 2020 2072 6574  a_grad)..    ret
-00006e10: 7572 6e20 6677 640a 0a0a 7265 6769 7374  urn fwd...regist
-00006e20: 6572 5f67 7261 6428 7069 6473 2e54 414b  er_grad(pids.TAK
-00006e30: 455f 414c 4f4e 475f 4158 4953 2c20 5f74  E_ALONG_AXIS, _t
-00006e40: 616b 655f 616c 6f6e 675f 6178 6973 5f70  ake_along_axis_p
-00006e50: 7269 6d5f 6772 6164 290a 0a0a 4074 6f72  rim_grad)...@tor
-00006e60: 6368 6374 780a 6465 6620 5f74 7261 6e73  chctx.def _trans
-00006e70: 706f 7365 5f70 7269 6d5f 6772 6164 2861  pose_prim_grad(a
-00006e80: 3a20 5465 6e73 6f72 5072 6f78 792c 2070  : TensorProxy, p
-00006e90: 6572 6d75 7461 7469 6f6e 3a20 7475 706c  ermutation: tupl
-00006ea0: 655b 696e 742c 202e 2e2e 5d29 202d 3e20  e[int, ...]) -> 
-00006eb0: 5465 6e73 6f72 5072 6f78 793a 0a20 2020  TensorProxy:.   
-00006ec0: 2066 7764 203d 2070 7269 6d73 2e74 7261   fwd = prims.tra
-00006ed0: 6e73 706f 7365 2861 2c20 7475 706c 6528  nspose(a, tuple(
-00006ee0: 7065 726d 7574 6174 696f 6e29 290a 0a20  permutation)).. 
-00006ef0: 2020 2067 203d 2067 6574 5f67 7261 6428     g = get_grad(
-00006f00: 6677 6429 0a20 2020 2075 6e64 6f20 3d20  fwd).    undo = 
-00006f10: 5f61 7267 736f 7274 2870 6572 6d75 7461  _argsort(permuta
-00006f20: 7469 6f6e 290a 2020 2020 615f 6772 6164  tion).    a_grad
-00006f30: 203d 2070 7269 6d73 2e74 7261 6e73 706f   = prims.transpo
-00006f40: 7365 2867 2c20 7475 706c 6528 756e 646f  se(g, tuple(undo
-00006f50: 2929 0a20 2020 2070 7574 5f67 7261 6428  )).    put_grad(
-00006f60: 612c 2061 5f67 7261 6429 0a0a 2020 2020  a, a_grad)..    
-00006f70: 7265 7475 726e 2066 7764 0a0a 0a72 6567  return fwd...reg
-00006f80: 6973 7465 725f 6772 6164 2870 6964 732e  ister_grad(pids.
-00006f90: 5452 414e 5350 4f53 452c 205f 7472 616e  TRANSPOSE, _tran
-00006fa0: 7370 6f73 655f 7072 696d 5f67 7261 6429  spose_prim_grad)
-00006fb0: 0a0a 230a 2320 4d65 6d6f 7279 206c 6179  ..#.# Memory lay
-00006fc0: 6f75 7420 6f70 6572 6174 6f72 2067 7261  out operator gra
-00006fd0: 6473 0a23 0a0a 0a40 746f 7263 6863 7478  ds.#...@torchctx
-00006fe0: 0a64 6566 205f 7374 7269 6465 5f6f 7264  .def _stride_ord
-00006ff0: 6572 5f70 7269 6d5f 6772 6164 2861 3a20  er_prim_grad(a: 
-00007000: 5465 6e73 6f72 5072 6f78 792c 202f 2c20  TensorProxy, /, 
-00007010: 6f72 6465 723a 2053 6571 7565 6e63 655b  order: Sequence[
-00007020: 696e 745d 2920 2d3e 2054 656e 736f 7250  int]) -> TensorP
-00007030: 726f 7879 3a0a 2020 2020 6677 6420 3d20  roxy:.    fwd = 
-00007040: 7072 696d 732e 7374 7269 6465 5f6f 7264  prims.stride_ord
-00007050: 6572 2861 2c20 6f72 6465 7229 0a0a 2020  er(a, order)..  
-00007060: 2020 6720 3d20 6765 745f 6772 6164 2866    g = get_grad(f
-00007070: 7764 290a 2020 2020 7075 745f 6772 6164  wd).    put_grad
-00007080: 2861 2c20 6729 0a0a 2020 2020 7265 7475  (a, g)..    retu
-00007090: 726e 2066 7764 0a0a 0a72 6567 6973 7465  rn fwd...registe
-000070a0: 725f 6772 6164 2870 6964 732e 5354 5249  r_grad(pids.STRI
-000070b0: 4445 5f4f 5244 4552 2c20 5f73 7472 6964  DE_ORDER, _strid
-000070c0: 655f 6f72 6465 725f 7072 696d 5f67 7261  e_order_prim_gra
-000070d0: 6429 0a0a 0a23 0a23 2045 6c65 6d65 6e74  d)...#.# Element
-000070e0: 7769 7365 2075 6e61 7279 206f 7065 7261  wise unary opera
-000070f0: 746f 7220 6772 6164 730a 230a 4074 6f72  tor grads.#.@tor
-00007100: 6368 6374 780a 6465 6620 5f61 6273 5f70  chctx.def _abs_p
-00007110: 7269 6d5f 6772 6164 2861 3a20 4e75 6d62  rim_grad(a: Numb
-00007120: 6572 207c 2054 656e 736f 7250 726f 7879  er | TensorProxy
-00007130: 2920 2d3e 204e 756d 6265 7220 7c20 5465  ) -> Number | Te
-00007140: 6e73 6f72 5072 6f78 793a 0a20 2020 2066  nsorProxy:.    f
-00007150: 7764 203d 2070 7269 6d73 2e61 6273 2861  wd = prims.abs(a
-00007160: 290a 0a20 2020 2067 203d 2067 6574 5f67  )..    g = get_g
-00007170: 7261 6428 6677 6429 0a20 2020 2070 7574  rad(fwd).    put
-00007180: 5f67 7261 6428 612c 2067 202a 206c 746f  _grad(a, g * lto
-00007190: 7263 682e 7369 676e 2861 2929 0a0a 2020  rch.sign(a))..  
-000071a0: 2020 7265 7475 726e 2066 7764 0a0a 0a72    return fwd...r
-000071b0: 6567 6973 7465 725f 6772 6164 2870 6964  egister_grad(pid
-000071c0: 732e 4142 532c 205f 6162 735f 7072 696d  s.ABS, _abs_prim
-000071d0: 5f67 7261 6429 0a0a 0a64 6566 205f 636f  _grad)...def _co
-000071e0: 735f 7072 696d 5f67 7261 6428 613a 204e  s_prim_grad(a: N
-000071f0: 756d 6265 7220 7c20 5465 6e73 6f72 5072  umber | TensorPr
-00007200: 6f78 7929 202d 3e20 4e75 6d62 6572 207c  oxy) -> Number |
-00007210: 2054 656e 736f 7250 726f 7879 3a0a 2020   TensorProxy:.  
-00007220: 2020 6677 6420 3d20 7072 696d 732e 636f    fwd = prims.co
-00007230: 7328 6129 0a0a 2020 2020 6720 3d20 6765  s(a)..    g = ge
-00007240: 745f 6772 6164 2866 7764 290a 2020 2020  t_grad(fwd).    
-00007250: 7075 745f 6772 6164 2861 2c20 6720 2a20  put_grad(a, g * 
-00007260: 282d 7072 696d 732e 7369 6e28 6129 2929  (-prims.sin(a)))
-00007270: 0a0a 2020 2020 7265 7475 726e 2066 7764  ..    return fwd
-00007280: 0a0a 0a72 6567 6973 7465 725f 6772 6164  ...register_grad
-00007290: 2870 6964 732e 434f 532c 205f 636f 735f  (pids.COS, _cos_
-000072a0: 7072 696d 5f67 7261 6429 0a0a 0a40 746f  prim_grad)...@to
-000072b0: 7263 6863 7478 0a64 6566 205f 6572 665f  rchctx.def _erf_
-000072c0: 7072 696d 5f67 7261 6428 613a 204e 756d  prim_grad(a: Num
-000072d0: 6265 7220 7c20 5465 6e73 6f72 5072 6f78  ber | TensorProx
-000072e0: 7929 202d 3e20 4e75 6d62 6572 207c 2054  y) -> Number | T
-000072f0: 656e 736f 7250 726f 7879 3a0a 2020 2020  ensorProxy:.    
-00007300: 6677 6420 3d20 7072 696d 732e 6572 6628  fwd = prims.erf(
-00007310: 6129 0a0a 2020 2020 6720 3d20 6765 745f  a)..    g = get_
-00007320: 6772 6164 2866 7764 290a 2020 2020 615f  grad(fwd).    a_
-00007330: 6772 6164 203d 2032 202f 206d 6174 682e  grad = 2 / math.
-00007340: 7371 7274 286d 6174 682e 7069 2920 2a20  sqrt(math.pi) * 
-00007350: 6c74 6f72 6368 2e65 7870 282d 2861 2a2a  ltorch.exp(-(a**
-00007360: 3229 2920 2a20 670a 2020 2020 7075 745f  2)) * g.    put_
-00007370: 6772 6164 2861 2c20 615f 6772 6164 290a  grad(a, a_grad).
-00007380: 0a20 2020 2072 6574 7572 6e20 6677 640a  .    return fwd.
-00007390: 0a0a 7265 6769 7374 6572 5f67 7261 6428  ..register_grad(
-000073a0: 7069 6473 2e45 5246 2c20 5f65 7266 5f70  pids.ERF, _erf_p
-000073b0: 7269 6d5f 6772 6164 290a 0a0a 4074 6f72  rim_grad)...@tor
-000073c0: 6368 6374 780a 6465 6620 5f65 7870 5f70  chctx.def _exp_p
-000073d0: 7269 6d5f 6772 6164 2861 3a20 4e75 6d62  rim_grad(a: Numb
-000073e0: 6572 207c 2054 656e 736f 7250 726f 7879  er | TensorProxy
-000073f0: 2920 2d3e 204e 756d 6265 7220 7c20 5465  ) -> Number | Te
-00007400: 6e73 6f72 5072 6f78 793a 0a20 2020 2066  nsorProxy:.    f
-00007410: 7764 203d 2070 7269 6d73 2e65 7870 2861  wd = prims.exp(a
-00007420: 290a 0a20 2020 2067 203d 2067 6574 5f67  )..    g = get_g
-00007430: 7261 6428 6677 6429 0a20 2020 2061 5f67  rad(fwd).    a_g
-00007440: 7261 6420 3d20 6720 2a20 6677 640a 2020  rad = g * fwd.  
-00007450: 2020 7075 745f 6772 6164 2861 2c20 615f    put_grad(a, a_
-00007460: 6772 6164 290a 0a20 2020 2072 6574 7572  grad)..    retur
-00007470: 6e20 6677 640a 0a0a 7265 6769 7374 6572  n fwd...register
-00007480: 5f67 7261 6428 7069 6473 2e45 5850 2c20  _grad(pids.EXP, 
-00007490: 5f65 7870 5f70 7269 6d5f 6772 6164 290a  _exp_prim_grad).
-000074a0: 0a0a 4074 6f72 6368 6374 780a 6465 6620  ..@torchctx.def 
-000074b0: 5f6c 6f67 5f70 7269 6d5f 6772 6164 2861  _log_prim_grad(a
-000074c0: 3a20 4e75 6d62 6572 207c 2054 656e 736f  : Number | Tenso
-000074d0: 7250 726f 7879 2920 2d3e 204e 756d 6265  rProxy) -> Numbe
-000074e0: 7220 7c20 5465 6e73 6f72 5072 6f78 793a  r | TensorProxy:
-000074f0: 0a20 2020 2066 7764 203d 2070 7269 6d73  .    fwd = prims
-00007500: 2e6c 6f67 2861 290a 0a20 2020 2067 203d  .log(a)..    g =
-00007510: 2067 6574 5f67 7261 6428 6677 6429 0a20   get_grad(fwd). 
-00007520: 2020 2061 5f67 7261 6420 3d20 6720 2f20     a_grad = g / 
-00007530: 610a 2020 2020 7075 745f 6772 6164 2861  a.    put_grad(a
-00007540: 2c20 615f 6772 6164 290a 0a20 2020 2072  , a_grad)..    r
-00007550: 6574 7572 6e20 6677 640a 0a0a 7265 6769  eturn fwd...regi
-00007560: 7374 6572 5f67 7261 6428 7069 6473 2e4c  ster_grad(pids.L
-00007570: 4f47 2c20 5f6c 6f67 5f70 7269 6d5f 6772  OG, _log_prim_gr
-00007580: 6164 290a 0a0a 4074 6f72 6368 6374 780a  ad)...@torchctx.
-00007590: 6465 6620 5f6e 6567 5f70 7269 6d5f 6772  def _neg_prim_gr
-000075a0: 6164 2861 3a20 4e75 6d62 6572 207c 2054  ad(a: Number | T
-000075b0: 656e 736f 7250 726f 7879 2920 2d3e 204e  ensorProxy) -> N
-000075c0: 756d 6265 7220 7c20 5465 6e73 6f72 5072  umber | TensorPr
-000075d0: 6f78 793a 0a20 2020 2066 7764 203d 2070  oxy:.    fwd = p
-000075e0: 7269 6d73 2e6e 6567 2861 290a 0a20 2020  rims.neg(a)..   
-000075f0: 2067 203d 2067 6574 5f67 7261 6428 6677   g = get_grad(fw
-00007600: 6429 0a20 2020 2070 7574 5f67 7261 6428  d).    put_grad(
-00007610: 612c 202d 6729 0a0a 2020 2020 7265 7475  a, -g)..    retu
-00007620: 726e 2066 7764 0a0a 0a72 6567 6973 7465  rn fwd...registe
-00007630: 725f 6772 6164 2870 6964 732e 4e45 472c  r_grad(pids.NEG,
-00007640: 205f 6e65 675f 7072 696d 5f67 7261 6429   _neg_prim_grad)
-00007650: 0a0a 0a40 746f 7263 6863 7478 0a64 6566  ...@torchctx.def
-00007660: 205f 7273 7172 745f 7072 696d 5f67 7261   _rsqrt_prim_gra
-00007670: 6428 613a 204e 756d 6265 7220 7c20 5465  d(a: Number | Te
-00007680: 6e73 6f72 5072 6f78 792c 202f 2920 2d3e  nsorProxy, /) ->
-00007690: 204e 756d 6265 7220 7c20 5465 6e73 6f72   Number | Tensor
-000076a0: 5072 6f78 793a 0a20 2020 2066 7764 203d  Proxy:.    fwd =
-000076b0: 2070 7269 6d73 2e72 7371 7274 2861 290a   prims.rsqrt(a).
-000076c0: 0a20 2020 2067 203d 2067 6574 5f67 7261  .    g = get_gra
-000076d0: 6428 6677 6429 0a20 2020 2023 2041 6e20  d(fwd).    # An 
-000076e0: 616c 7465 726e 6174 6976 6520 6465 7269  alternative deri
-000076f0: 7661 7469 6f6e 2075 7365 6420 6279 204a  vation used by J
-00007700: 4158 2069 7320 2d30 2e35 202a 2067 202a  AX is -0.5 * g *
-00007710: 2072 7371 7274 2878 2920 2f20 780a 2020   rsqrt(x) / x.  
-00007720: 2020 2320 7768 6572 6520 7273 7172 7428    # where rsqrt(
-00007730: 7829 2061 6e64 2078 2061 7265 2073 6176  x) and x are sav
-00007740: 6564 2066 6f72 2074 6865 2062 6163 6b77  ed for the backw
-00007750: 6172 6473 2070 6173 732e 0a20 2020 2023  ards pass..    #
-00007760: 2054 6869 7320 6465 7269 7661 7469 6f6e   This derivation
-00007770: 2077 6173 2073 656c 6563 7465 6420 6265   was selected be
-00007780: 6361 7573 6520 6974 2061 766f 6964 7320  cause it avoids 
-00007790: 7361 7669 6e67 2074 6865 2069 6e70 7574  saving the input
-000077a0: 2074 656e 736f 722e 0a20 2020 2061 5f67   tensor..    a_g
-000077b0: 7261 6420 3d20 2d30 2e35 202a 2067 202a  rad = -0.5 * g *
-000077c0: 2066 7764 2a2a 332e 300a 2020 2020 7075   fwd**3.0.    pu
-000077d0: 745f 6772 6164 2861 2c20 615f 6772 6164  t_grad(a, a_grad
-000077e0: 290a 0a20 2020 2072 6574 7572 6e20 6677  )..    return fw
-000077f0: 640a 0a0a 7265 6769 7374 6572 5f67 7261  d...register_gra
-00007800: 6428 7069 6473 2e52 5351 5254 2c20 5f72  d(pids.RSQRT, _r
-00007810: 7371 7274 5f70 7269 6d5f 6772 6164 290a  sqrt_prim_grad).
-00007820: 0a0a 6465 6620 5f73 696e 5f70 7269 6d5f  ..def _sin_prim_
-00007830: 6772 6164 2861 3a20 4e75 6d62 6572 207c  grad(a: Number |
-00007840: 2054 656e 736f 7250 726f 7879 2920 2d3e   TensorProxy) ->
-00007850: 204e 756d 6265 7220 7c20 5465 6e73 6f72   Number | Tensor
-00007860: 5072 6f78 793a 0a20 2020 2066 7764 203d  Proxy:.    fwd =
-00007870: 2070 7269 6d73 2e73 696e 2861 290a 0a20   prims.sin(a).. 
-00007880: 2020 2067 203d 2067 6574 5f67 7261 6428     g = get_grad(
-00007890: 6677 6429 0a20 2020 2070 7574 5f67 7261  fwd).    put_gra
-000078a0: 6428 612c 2067 202a 2070 7269 6d73 2e63  d(a, g * prims.c
-000078b0: 6f73 2861 2929 0a0a 2020 2020 7265 7475  os(a))..    retu
-000078c0: 726e 2066 7764 0a0a 0a72 6567 6973 7465  rn fwd...registe
-000078d0: 725f 6772 6164 2870 6964 732e 5349 4e2c  r_grad(pids.SIN,
-000078e0: 205f 7369 6e5f 7072 696d 5f67 7261 6429   _sin_prim_grad)
-000078f0: 0a0a 0a40 746f 7263 6863 7478 0a64 6566  ...@torchctx.def
-00007900: 205f 7461 6e68 5f70 7269 6d5f 6772 6164   _tanh_prim_grad
-00007910: 2861 3a20 4e75 6d62 6572 207c 2054 656e  (a: Number | Ten
-00007920: 736f 7250 726f 7879 2c20 2f29 202d 3e20  sorProxy, /) -> 
-00007930: 4e75 6d62 6572 207c 2054 656e 736f 7250  Number | TensorP
-00007940: 726f 7879 3a0a 2020 2020 6677 6420 3d20  roxy:.    fwd = 
-00007950: 7072 696d 732e 7461 6e68 2861 290a 0a20  prims.tanh(a).. 
-00007960: 2020 2067 203d 2067 6574 5f67 7261 6428     g = get_grad(
-00007970: 6677 6429 0a20 2020 2061 5f67 7261 6420  fwd).    a_grad 
-00007980: 3d20 6720 2a20 2831 202d 2066 7764 202a  = g * (1 - fwd *
-00007990: 2066 7764 290a 2020 2020 7075 745f 6772   fwd).    put_gr
-000079a0: 6164 2861 2c20 615f 6772 6164 290a 0a20  ad(a, a_grad).. 
-000079b0: 2020 2072 6574 7572 6e20 6677 640a 0a0a     return fwd...
-000079c0: 7265 6769 7374 6572 5f67 7261 6428 7069  register_grad(pi
-000079d0: 6473 2e54 414e 482c 205f 7461 6e68 5f70  ds.TANH, _tanh_p
-000079e0: 7269 6d5f 6772 6164 290a 0a23 0a23 2045  rim_grad)..#.# E
-000079f0: 6c65 6d65 6e74 7769 7365 2062 696e 6172  lementwise binar
-00007a00: 7920 6f70 6572 6174 6f72 2067 7261 6473  y operator grads
-00007a10: 0a23 0a0a 0a40 746f 7263 6863 7478 0a64  .#...@torchctx.d
-00007a20: 6566 205f 6164 645f 7072 696d 5f67 7261  ef _add_prim_gra
-00007a30: 6428 613a 204e 756d 6265 7220 7c20 5465  d(a: Number | Te
-00007a40: 6e73 6f72 5072 6f78 792c 2062 3a20 4e75  nsorProxy, b: Nu
-00007a50: 6d62 6572 207c 2054 656e 736f 7250 726f  mber | TensorPro
-00007a60: 7879 2c20 2f29 202d 3e20 4e75 6d62 6572  xy, /) -> Number
-00007a70: 207c 2054 656e 736f 7250 726f 7879 3a0a   | TensorProxy:.
-00007a80: 2020 2020 6677 6420 3d20 6120 2b20 620a      fwd = a + b.
-00007a90: 0a20 2020 2067 203d 2067 6574 5f67 7261  .    g = get_gra
-00007aa0: 6428 6677 6429 0a20 2020 2061 5f67 7261  d(fwd).    a_gra
-00007ab0: 6420 3d20 670a 2020 2020 625f 6772 6164  d = g.    b_grad
-00007ac0: 203d 2067 0a20 2020 2070 7574 5f67 7261   = g.    put_gra
-00007ad0: 6473 2828 612c 2062 292c 2028 615f 6772  ds((a, b), (a_gr
-00007ae0: 6164 2c20 625f 6772 6164 2929 0a0a 2020  ad, b_grad))..  
-00007af0: 2020 7265 7475 726e 2066 7764 0a0a 0a72    return fwd...r
-00007b00: 6567 6973 7465 725f 6772 6164 2870 6964  egister_grad(pid
-00007b10: 732e 4144 442c 205f 6164 645f 7072 696d  s.ADD, _add_prim
-00007b20: 5f67 7261 6429 0a0a 0a23 204e 4f54 4520  _grad)...# NOTE 
-00007b30: 5468 6520 666f 6c6c 6f77 696e 6720 6772  The following gr
-00007b40: 6164 2064 6566 696e 6974 696f 6e20 7265  ad definition re
-00007b50: 6c69 6573 206f 6e20 7468 6520 6661 6374  lies on the fact
-00007b60: 2074 6861 7420 6f6e 6c79 2069 6e65 7861   that only inexa
-00007b70: 6374 2064 7479 7065 7320 6172 6520 6469  ct dtypes are di
-00007b80: 6666 6572 656e 7469 6162 6c65 2c0a 2320  fferentiable,.# 
-00007b90: 2020 616e 6420 746f 7263 6827 7320 7472    and torch's tr
-00007ba0: 7565 2064 6976 6973 696f 6e20 6f70 6572  ue division oper
-00007bb0: 6174 6f72 2061 6e64 2074 6865 2064 6976  ator and the div
-00007bc0: 6973 696f 6e20 7072 696d 6974 6976 6520  ision primitive 
-00007bd0: 6167 7265 6520 6f6e 2074 686f 7365 2074  agree on those t
-00007be0: 7970 6573 0a40 746f 7263 6863 7478 0a64  ypes.@torchctx.d
-00007bf0: 6566 205f 6469 765f 7072 696d 5f67 7261  ef _div_prim_gra
-00007c00: 6428 613a 204e 756d 6265 7220 7c20 5465  d(a: Number | Te
-00007c10: 6e73 6f72 5072 6f78 792c 2062 3a20 4e75  nsorProxy, b: Nu
-00007c20: 6d62 6572 207c 2054 656e 736f 7250 726f  mber | TensorPro
-00007c30: 7879 2c20 2f29 202d 3e20 4e75 6d62 6572  xy, /) -> Number
-00007c40: 207c 2054 656e 736f 7250 726f 7879 3a0a   | TensorProxy:.
-00007c50: 2020 2020 6677 6420 3d20 6120 2f20 620a      fwd = a / b.
-00007c60: 0a20 2020 2067 203d 2067 6574 5f67 7261  .    g = get_gra
-00007c70: 6428 6677 6429 0a20 2020 2061 5f67 7261  d(fwd).    a_gra
-00007c80: 6420 3d20 6720 2f20 620a 2020 2020 625f  d = g / b.    b_
-00007c90: 6772 6164 203d 202d 6720 2a20 2828 6120  grad = -g * ((a 
-00007ca0: 2f20 6229 202f 2062 290a 2020 2020 7075  / b) / b).    pu
-00007cb0: 745f 6772 6164 7328 2861 2c20 6229 2c20  t_grads((a, b), 
-00007cc0: 2861 5f67 7261 642c 2062 5f67 7261 6429  (a_grad, b_grad)
-00007cd0: 290a 0a20 2020 2072 6574 7572 6e20 6677  )..    return fw
-00007ce0: 640a 0a0a 7265 6769 7374 6572 5f67 7261  d...register_gra
-00007cf0: 6428 7069 6473 2e44 4956 2c20 5f64 6976  d(pids.DIV, _div
-00007d00: 5f70 7269 6d5f 6772 6164 290a 0a23 2043  _prim_grad)..# C
-00007d10: 6f6d 7061 7269 736f 6e20 6f70 6572 6174  omparison operat
-00007d20: 6f72 7320 2d2d 2074 6865 7365 2063 7265  ors -- these cre
-00007d30: 6174 6520 6e6f 2067 7261 6420 6173 736f  ate no grad asso
-00007d40: 6369 6174 696f 6e73 0a72 6567 6973 7465  ciations.registe
-00007d50: 725f 6772 6164 2870 6964 732e 4551 2c20  r_grad(pids.EQ, 
-00007d60: 7072 696d 732e 6571 290a 7265 6769 7374  prims.eq).regist
-00007d70: 6572 5f67 7261 6428 7069 6473 2e47 452c  er_grad(pids.GE,
-00007d80: 2070 7269 6d73 2e67 6529 0a72 6567 6973   prims.ge).regis
-00007d90: 7465 725f 6772 6164 2870 6964 732e 4c54  ter_grad(pids.LT
-00007da0: 2c20 7072 696d 732e 6c74 290a 0a0a 4074  , prims.lt)...@t
-00007db0: 6f72 6368 6374 780a 6465 6620 5f6d 756c  orchctx.def _mul
-00007dc0: 5f70 7269 6d5f 6772 6164 2861 3a20 4e75  _prim_grad(a: Nu
-00007dd0: 6d62 6572 207c 2054 656e 736f 7250 726f  mber | TensorPro
-00007de0: 7879 2c20 623a 204e 756d 6265 7220 7c20  xy, b: Number | 
-00007df0: 5465 6e73 6f72 5072 6f78 792c 202f 2920  TensorProxy, /) 
-00007e00: 2d3e 204e 756d 6265 7220 7c20 5465 6e73  -> Number | Tens
-00007e10: 6f72 5072 6f78 793a 0a20 2020 2066 7764  orProxy:.    fwd
-00007e20: 203d 2061 202a 2062 0a0a 2020 2020 6720   = a * b..    g 
-00007e30: 3d20 6765 745f 6772 6164 2866 7764 290a  = get_grad(fwd).
-00007e40: 2020 2020 615f 6772 6164 203d 2062 202a      a_grad = b *
-00007e50: 2067 0a20 2020 2062 5f67 7261 6420 3d20   g.    b_grad = 
-00007e60: 6120 2a20 670a 2020 2020 7075 745f 6772  a * g.    put_gr
-00007e70: 6164 7328 2861 2c20 6229 2c20 2861 5f67  ads((a, b), (a_g
-00007e80: 7261 642c 2062 5f67 7261 6429 290a 0a20  rad, b_grad)).. 
-00007e90: 2020 2072 6574 7572 6e20 6677 640a 0a0a     return fwd...
-00007ea0: 7265 6769 7374 6572 5f67 7261 6428 7069  register_grad(pi
-00007eb0: 6473 2e4d 554c 2c20 5f6d 756c 5f70 7269  ds.MUL, _mul_pri
-00007ec0: 6d5f 6772 6164 290a 0a0a 4074 6f72 6368  m_grad)...@torch
-00007ed0: 6374 780a 6465 6620 5f73 7562 5f70 7269  ctx.def _sub_pri
-00007ee0: 6d5f 6772 6164 2861 3a20 4e75 6d62 6572  m_grad(a: Number
-00007ef0: 207c 2054 656e 736f 7250 726f 7879 2c20   | TensorProxy, 
-00007f00: 623a 204e 756d 6265 7220 7c20 5465 6e73  b: Number | Tens
-00007f10: 6f72 5072 6f78 7929 202d 3e20 4e75 6d62  orProxy) -> Numb
-00007f20: 6572 207c 2054 656e 736f 7250 726f 7879  er | TensorProxy
-00007f30: 3a0a 2020 2020 6677 6420 3d20 6120 2d20  :.    fwd = a - 
-00007f40: 620a 0a20 2020 2067 203d 2067 6574 5f67  b..    g = get_g
-00007f50: 7261 6428 6677 6429 0a20 2020 2061 5f67  rad(fwd).    a_g
-00007f60: 7261 6420 3d20 670a 2020 2020 625f 6772  rad = g.    b_gr
-00007f70: 6164 203d 202d 670a 2020 2020 7075 745f  ad = -g.    put_
-00007f80: 6772 6164 7328 2861 2c20 6229 2c20 2861  grads((a, b), (a
-00007f90: 5f67 7261 642c 2062 5f67 7261 6429 290a  _grad, b_grad)).
-00007fa0: 0a20 2020 2072 6574 7572 6e20 6677 640a  .    return fwd.
-00007fb0: 0a0a 7265 6769 7374 6572 5f67 7261 6428  ..register_grad(
-00007fc0: 7069 6473 2e53 5542 2c20 5f73 7562 5f70  pids.SUB, _sub_p
-00007fd0: 7269 6d5f 6772 6164 290a 0a0a 230a 2320  rim_grad)...#.# 
-00007fe0: 436f 6e64 6974 696f 6e61 6c20 6f70 6572  Conditional oper
-00007ff0: 6174 6f72 2067 7261 6473 0a23 0a0a 0a64  ator grads.#...d
-00008000: 6566 205f 7768 6572 655f 7072 696d 5f67  ef _where_prim_g
-00008010: 7261 6428 7072 6564 3a20 4e75 6d62 6572  rad(pred: Number
-00008020: 207c 2054 656e 736f 7250 726f 7879 2c20   | TensorProxy, 
-00008030: 613a 204e 756d 6265 7220 7c20 5465 6e73  a: Number | Tens
-00008040: 6f72 5072 6f78 792c 2062 3a20 4e75 6d62  orProxy, b: Numb
-00008050: 6572 207c 2054 656e 736f 7250 726f 7879  er | TensorProxy
-00008060: 2920 2d3e 2054 656e 736f 7250 726f 7879  ) -> TensorProxy
-00008070: 3a0a 2020 2020 6677 6420 3d20 7072 696d  :.    fwd = prim
-00008080: 732e 7768 6572 6528 7072 6564 2c20 612c  s.where(pred, a,
-00008090: 2062 290a 0a20 2020 2067 203d 2067 6574   b)..    g = get
-000080a0: 5f67 7261 6428 6677 6429 0a20 2020 2061  _grad(fwd).    a
-000080b0: 5f67 7261 6420 3d20 6c74 6f72 6368 2e77  _grad = ltorch.w
-000080c0: 6865 7265 2870 7265 642c 2067 2c20 3029  here(pred, g, 0)
-000080d0: 0a20 2020 2062 5f67 7261 6420 3d20 6c74  .    b_grad = lt
-000080e0: 6f72 6368 2e77 6865 7265 2870 7265 642c  orch.where(pred,
-000080f0: 2030 2c20 6729 0a20 2020 2070 7574 5f67   0, g).    put_g
-00008100: 7261 6473 2828 612c 2062 292c 2028 615f  rads((a, b), (a_
-00008110: 6772 6164 2c20 625f 6772 6164 2929 0a0a  grad, b_grad))..
-00008120: 2020 2020 7265 7475 726e 2066 7764 0a0a      return fwd..
-00008130: 0a72 6567 6973 7465 725f 6772 6164 2870  .register_grad(p
-00008140: 6964 732e 5748 4552 452c 205f 7768 6572  ids.WHERE, _wher
-00008150: 655f 7072 696d 5f67 7261 6429 0a0a 230a  e_prim_grad)..#.
-00008160: 2320 5265 6475 6374 696f 6e20 6f70 6572  # Reduction oper
-00008170: 6174 6f72 2067 7261 6473 0a23 0a0a 0a23  ator grads.#...#
-00008180: 2054 4f44 4f20 5265 7669 6577 2074 7765   TODO Review twe
-00008190: 616b 696e 6720 6772 6164 5f63 686f 6f73  aking grad_choos
-000081a0: 6572 5f70 756c 6c62 6163 6b20 696e 7465  er_pullback inte
-000081b0: 7266 6163 650a 6465 6620 5f61 6d61 785f  rface.def _amax_
-000081c0: 7072 696d 5f67 7261 6428 613a 2054 656e  prim_grad(a: Ten
-000081d0: 736f 7250 726f 7879 2c20 2f2c 2064 696d  sorProxy, /, dim
-000081e0: 733a 2053 6571 7565 6e63 655b 696e 745d  s: Sequence[int]
-000081f0: 2920 2d3e 2054 656e 736f 7250 726f 7879  ) -> TensorProxy
-00008200: 3a0a 2020 2020 6677 6420 3d20 7072 696d  :.    fwd = prim
-00008210: 732e 616d 6178 2861 2c20 6469 6d73 290a  s.amax(a, dims).
-00008220: 0a20 2020 2067 203d 2067 6574 5f67 7261  .    g = get_gra
-00008230: 6428 6677 6429 0a20 2020 2061 5f67 7261  d(fwd).    a_gra
-00008240: 6420 3d20 6772 6164 5f63 686f 6f73 6572  d = grad_chooser
-00008250: 5f62 6163 6b77 6172 6428 6677 642c 2061  _backward(fwd, a
-00008260: 2c20 612e 7368 6170 652c 2064 696d 732c  , a.shape, dims,
-00008270: 2067 290a 2020 2020 7075 745f 6772 6164   g).    put_grad
-00008280: 2861 2c20 615f 6772 6164 290a 0a20 2020  (a, a_grad)..   
-00008290: 2072 6574 7572 6e20 6677 640a 0a0a 7265   return fwd...re
-000082a0: 6769 7374 6572 5f67 7261 6428 7069 6473  gister_grad(pids
-000082b0: 2e41 4d41 582c 205f 616d 6178 5f70 7269  .AMAX, _amax_pri
-000082c0: 6d5f 6772 6164 290a 0a0a 6465 6620 5f73  m_grad)...def _s
-000082d0: 756d 5f70 7269 6d5f 6772 6164 2861 3a20  um_prim_grad(a: 
-000082e0: 5465 6e73 6f72 5072 6f78 792c 202f 2c20  TensorProxy, /, 
-000082f0: 6469 6d73 3a20 5365 7175 656e 6365 5b69  dims: Sequence[i
-00008300: 6e74 5d29 202d 3e20 5465 6e73 6f72 5072  nt]) -> TensorPr
-00008310: 6f78 793a 0a20 2020 2066 7764 203d 2070  oxy:.    fwd = p
-00008320: 7269 6d73 2e73 756d 2861 2c20 6469 6d73  rims.sum(a, dims
-00008330: 290a 0a20 2020 2067 203d 2067 6574 5f67  )..    g = get_g
-00008340: 7261 6428 6677 6429 0a20 2020 2061 5f67  rad(fwd).    a_g
-00008350: 7261 6420 3d20 7265 7374 6f72 655f 7265  rad = restore_re
-00008360: 6475 6365 645f 6469 6d73 2867 2c20 6469  duced_dims(g, di
-00008370: 6d73 2c20 612e 7368 6170 6529 0a20 2020  ms, a.shape).   
-00008380: 2070 7574 5f67 7261 6428 612c 2061 5f67   put_grad(a, a_g
-00008390: 7261 6429 0a0a 2020 2020 7265 7475 726e  rad)..    return
-000083a0: 2066 7764 0a0a 0a72 6567 6973 7465 725f   fwd...register_
-000083b0: 6772 6164 2870 6964 732e 5355 4d2c 205f  grad(pids.SUM, _
-000083c0: 7375 6d5f 7072 696d 5f67 7261 6429 0a0a  sum_prim_grad)..
-000083d0: 0a40 746f 7263 6863 7478 0a64 6566 205f  .@torchctx.def _
-000083e0: 746f 706b 5f70 7269 6d5f 6772 6164 280a  topk_prim_grad(.
-000083f0: 2020 2020 613a 2054 656e 736f 7250 726f      a: TensorPro
-00008400: 7879 2c20 2f2c 206b 3a20 696e 742c 2064  xy, /, k: int, d
-00008410: 696d 3a20 4e6f 6e65 207c 2069 6e74 203d  im: None | int =
-00008420: 204e 6f6e 652c 206c 6172 6765 7374 3a20   None, largest: 
-00008430: 626f 6f6c 203d 2054 7275 652c 2073 6f72  bool = True, sor
-00008440: 7465 643a 2062 6f6f 6c20 3d20 5472 7565  ted: bool = True
-00008450: 2c20 2a2c 206f 7574 3d4e 6f6e 650a 293a  , *, out=None.):
-00008460: 0a20 2020 2066 7764 203d 2070 7269 6d73  .    fwd = prims
-00008470: 2e74 6f70 6b28 612c 206b 2c20 6469 6d2c  .topk(a, k, dim,
-00008480: 206c 6172 6765 7374 2c20 736f 7274 6564   largest, sorted
-00008490: 2c20 6f75 743d 6f75 7429 0a20 2020 2076  , out=out).    v
-000084a0: 616c 2c20 6964 7820 3d20 6677 640a 0a20  al, idx = fwd.. 
-000084b0: 2020 2076 616c 5f67 7261 6420 3d20 6765     val_grad = ge
-000084c0: 745f 6772 6164 2876 616c 290a 0a20 2020  t_grad(val)..   
-000084d0: 2061 5f67 7261 6420 3d20 6c74 6f72 6368   a_grad = ltorch
-000084e0: 2e7a 6572 6f73 5f6c 696b 6528 6129 0a20  .zeros_like(a). 
-000084f0: 2020 2023 2054 4f44 4f3a 2072 6570 6c61     # TODO: repla
-00008500: 6365 2077 6974 6820 7363 6174 7465 7220  ce with scatter 
-00008510: 6f6e 6365 2077 6520 6861 7665 2069 742e  once we have it.
-00008520: 0a20 2020 2023 2073 6361 7474 6572 5f61  .    # scatter_a
-00008530: 6464 2069 7320 6120 7072 696d 2061 6e64  dd is a prim and
-00008540: 2069 7420 7265 6c69 6573 206f 6e20 6174   it relies on at
-00008550: 6f6d 6963 206f 7073 2e0a 2020 2020 615f  omic ops..    a_
-00008560: 6772 6164 203d 206c 746f 7263 682e 7363  grad = ltorch.sc
-00008570: 6174 7465 725f 6164 6428 615f 6772 6164  atter_add(a_grad
-00008580: 2c20 6469 6d2c 2069 6478 2c20 7661 6c5f  , dim, idx, val_
-00008590: 6772 6164 290a 2020 2020 7075 745f 6772  grad).    put_gr
-000085a0: 6164 2861 2c20 615f 6772 6164 290a 0a20  ad(a, a_grad).. 
-000085b0: 2020 2072 6574 7572 6e20 6677 640a 0a0a     return fwd...
-000085c0: 7265 6769 7374 6572 5f67 7261 6428 7069  register_grad(pi
-000085d0: 6473 2e54 4f50 4b2c 205f 746f 706b 5f70  ds.TOPK, _topk_p
-000085e0: 7269 6d5f 6772 6164 290a 0a0a 2320 544f  rim_grad)...# TO
-000085f0: 444f 2046 6978 2064 6976 6973 696f 6e20  DO Fix division 
-00008600: 6279 207a 6572 6f20 7768 656e 206e 5f65  by zero when n_e
-00008610: 6c65 6d5f 7265 6475 6365 6420 3d3d 2030  lem_reduced == 0
-00008620: 206f 7220 7768 656e 206d 6561 6e2e 6e75   or when mean.nu
-00008630: 6d65 6c20 3d3d 2030 0a23 2020 2062 7920  mel == 0.#   by 
-00008640: 7265 7475 726e 696e 6720 7a65 726f 735f  returning zeros_
-00008650: 6c69 6b65 2861 2920 6f72 2073 696d 696c  like(a) or simil
-00008660: 6172 2e0a 2320 544f 444f 2046 6978 2067  ar..# TODO Fix g
-00008670: 7261 6420 7768 656e 2063 6f72 7265 6374  rad when correct
-00008680: 696f 6e20 3e20 6e5f 656c 656d 5f72 6564  ion > n_elem_red
-00008690: 7563 6564 2e0a 4074 6f72 6368 6374 780a  uced..@torchctx.
-000086a0: 6465 6620 5f76 6172 5f6d 6561 6e5f 7072  def _var_mean_pr
-000086b0: 696d 5f67 7261 6428 613a 2054 656e 736f  im_grad(a: Tenso
-000086c0: 7250 726f 7879 2c20 2f2c 2064 696d 733a  rProxy, /, dims:
-000086d0: 2053 6571 7565 6e63 655b 696e 745d 2c20   Sequence[int], 
-000086e0: 2a2c 2063 6f72 7265 6374 696f 6e3a 204e  *, correction: N
-000086f0: 756d 6265 7229 202d 3e20 5465 6e73 6f72  umber) -> Tensor
-00008700: 5072 6f78 793a 0a20 2020 2076 2c20 6d20  Proxy:.    v, m 
-00008710: 3d20 7072 696d 732e 7661 725f 6d65 616e  = prims.var_mean
-00008720: 2861 2c20 6469 6d73 2c20 636f 7272 6563  (a, dims, correc
-00008730: 7469 6f6e 3d63 6f72 7265 6374 696f 6e29  tion=correction)
-00008740: 0a0a 2020 2020 6776 203d 2067 6574 5f67  ..    gv = get_g
-00008750: 7261 6428 7629 0a20 2020 2067 6d20 3d20  rad(v).    gm = 
-00008760: 6765 745f 6772 6164 286d 290a 0a20 2020  get_grad(m)..   
-00008770: 206e 5f65 6c65 6d5f 7265 6475 6365 6420   n_elem_reduced 
-00008780: 3d20 612e 6e75 6d65 6c20 2f2f 206d 2e6e  = a.numel // m.n
-00008790: 756d 656c 2069 6620 612e 6e75 6d65 6c20  umel if a.numel 
-000087a0: 213d 2030 2065 6c73 6520 310a 0a20 2020  != 0 else 1..   
-000087b0: 2023 2043 6f6d 7075 7465 7320 6d65 616e   # Computes mean
-000087c0: 2062 7764 0a20 2020 206d 6561 6e5f 7363   bwd.    mean_sc
-000087d0: 616c 6520 3d20 312e 3020 2f20 6e5f 656c  ale = 1.0 / n_el
-000087e0: 656d 5f72 6564 7563 6564 0a20 2020 206d  em_reduced.    m
-000087f0: 6561 6e5f 6772 6164 203d 206d 6561 6e5f  ean_grad = mean_
-00008800: 7363 616c 6520 2a20 7265 7374 6f72 655f  scale * restore_
-00008810: 7265 6475 6365 645f 6469 6d73 2867 6d2c  reduced_dims(gm,
-00008820: 2064 696d 732c 2061 2e73 6861 7065 290a   dims, a.shape).
-00008830: 0a20 2020 2023 2043 6f6d 7075 7465 7320  .    # Computes 
-00008840: 7661 7220 6277 640a 2020 2020 6e6f 726d  var bwd.    norm
-00008850: 616c 697a 6174 696f 6e5f 7363 616c 6172  alization_scalar
-00008860: 203d 206e 5f65 6c65 6d5f 7265 6475 6365   = n_elem_reduce
-00008870: 6420 2d20 636f 7272 6563 7469 6f6e 0a20  d - correction. 
-00008880: 2020 2072 6573 746f 7265 645f 6776 203d     restored_gv =
-00008890: 2072 6573 746f 7265 5f72 6564 7563 6564   restore_reduced
-000088a0: 5f64 696d 7328 6776 2c20 6469 6d73 2c20  _dims(gv, dims, 
-000088b0: 612e 7368 6170 6529 0a20 2020 2023 2049  a.shape).    # I
-000088c0: 6e73 6572 7469 6e67 2061 2063 6f6e 7665  nserting a conve
-000088d0: 7273 696f 6e20 746f 2074 6865 2073 616d  rsion to the sam
-000088e0: 6520 6474 7970 6520 746f 2064 6973 6162  e dtype to disab
-000088f0: 6c65 206e 7646 7573 6572 2065 7865 6375  le nvFuser execu
-00008900: 746f 7273 2773 0a20 2020 2023 2062 6f6f  tors's.    # boo
-00008910: 6b65 6e64 206f 7074 696d 697a 6174 696f  kend optimizatio
-00008920: 6e20 286e 765f 656e 6162 6c65 5f62 6f6f  n (nv_enable_boo
-00008930: 6b65 6e64 292c 2077 6869 6368 2063 616e  kend), which can
-00008940: 2063 6175 7365 2074 6865 2062 6163 6b77   cause the backw
-00008950: 6172 640a 2020 2020 2320 7061 7373 2074  ard.    # pass t
-00008960: 6f20 6765 6e65 7261 7465 2074 776f 206b  o generate two k
-00008970: 6572 6e65 6c73 0a20 2020 206d 6561 6e5f  ernels.    mean_
-00008980: 6d64 7479 7065 203d 2070 7269 6d73 2e63  mdtype = prims.c
-00008990: 6f6e 7665 7274 5f65 6c65 6d65 6e74 5f74  onvert_element_t
-000089a0: 7970 6528 6d2c 206d 2e64 7479 7065 290a  ype(m, m.dtype).
-000089b0: 2020 2020 7265 7374 6f72 6564 5f6d 6561      restored_mea
-000089c0: 6e20 3d20 7265 7374 6f72 655f 7265 6475  n = restore_redu
-000089d0: 6365 645f 6469 6d73 286d 6561 6e5f 6d64  ced_dims(mean_md
-000089e0: 7479 7065 2c20 6469 6d73 2c20 612e 7368  type, dims, a.sh
-000089f0: 6170 6529 0a20 2020 2076 6172 5f67 7261  ape).    var_gra
-00008a00: 6420 3d20 2832 202a 2072 6573 746f 7265  d = (2 * restore
-00008a10: 645f 6776 202a 2028 6120 2d20 7265 7374  d_gv * (a - rest
-00008a20: 6f72 6564 5f6d 6561 6e29 2920 2f20 6e6f  ored_mean)) / no
-00008a30: 726d 616c 697a 6174 696f 6e5f 7363 616c  rmalization_scal
-00008a40: 6172 0a0a 2020 2020 7075 745f 6772 6164  ar..    put_grad
-00008a50: 2861 2c20 6d65 616e 5f67 7261 6420 2b20  (a, mean_grad + 
-00008a60: 7661 725f 6772 6164 290a 0a20 2020 2072  var_grad)..    r
-00008a70: 6574 7572 6e20 762c 206d 0a0a 0a72 6567  eturn v, m...reg
-00008a80: 6973 7465 725f 6772 6164 2870 6964 732e  ister_grad(pids.
-00008a90: 5641 525f 4d45 414e 2c20 5f76 6172 5f6d  VAR_MEAN, _var_m
-00008aa0: 6561 6e5f 7072 696d 5f67 7261 6429 0a0a  ean_prim_grad)..
-00008ab0: 0a23 0a23 204c 696e 6561 7220 616c 6765  .#.# Linear alge
-00008ac0: 6272 6120 6f70 6572 6174 6f72 2067 7261  bra operator gra
-00008ad0: 6473 0a23 0a40 746f 7263 6863 7478 0a64  ds.#.@torchctx.d
-00008ae0: 6566 205f 6c69 6e65 6172 5f70 7269 6d5f  ef _linear_prim_
-00008af0: 6772 6164 2861 3a20 5465 6e73 6f72 5072  grad(a: TensorPr
-00008b00: 6f78 792c 2077 3a20 5465 6e73 6f72 5072  oxy, w: TensorPr
-00008b10: 6f78 792c 2062 6961 733a 204e 6f6e 6520  oxy, bias: None 
-00008b20: 7c20 5465 6e73 6f72 5072 6f78 7929 202d  | TensorProxy) -
-00008b30: 3e20 5465 6e73 6f72 5072 6f78 793a 0a20  > TensorProxy:. 
-00008b40: 2020 2066 7764 203d 2070 7269 6d73 2e6c     fwd = prims.l
-00008b50: 696e 6561 7228 612c 2077 2c20 6269 6173  inear(a, w, bias
-00008b60: 290a 0a20 2020 2067 203d 2067 6574 5f67  )..    g = get_g
-00008b70: 7261 6428 6677 6429 0a0a 2020 2020 6669  rad(fwd)..    fi
-00008b80: 7273 745f 6469 6d20 3d20 2d32 0a20 2020  rst_dim = -2.   
-00008b90: 2067 7261 645f 6120 3d20 6c74 6f72 6368   grad_a = ltorch
-00008ba0: 2e6d 6174 6d75 6c28 672e 7265 7368 6170  .matmul(g.reshap
-00008bb0: 6528 2d31 2c20 672e 7368 6170 655b 2d31  e(-1, g.shape[-1
-00008bc0: 5d29 2c20 7729 2e72 6573 6861 7065 2861  ]), w).reshape(a
-00008bd0: 2e73 6861 7065 290a 0a20 2020 2067 7261  .shape)..    gra
-00008be0: 645f 773a 2054 656e 736f 7250 726f 7879  d_w: TensorProxy
-00008bf0: 0a20 2020 2069 6620 612e 6e64 696d 203d  .    if a.ndim =
-00008c00: 3d20 313a 0a20 2020 2020 2020 2067 7261  = 1:.        gra
-00008c10: 645f 7720 3d20 6c74 6f72 6368 2e6d 6174  d_w = ltorch.mat
-00008c20: 6d75 6c28 672e 756e 7371 7565 657a 6528  mul(g.unsqueeze(
-00008c30: 6669 7273 745f 6469 6d29 2e6d 542c 2061  first_dim).mT, a
-00008c40: 2e75 6e73 7175 6565 7a65 2866 6972 7374  .unsqueeze(first
-00008c50: 5f64 696d 2929 0a20 2020 2065 6c73 653a  _dim)).    else:
-00008c60: 0a20 2020 2020 2020 2067 7261 645f 7720  .        grad_w 
-00008c70: 3d20 6c74 6f72 6368 2e6d 6174 6d75 6c28  = ltorch.matmul(
-00008c80: 672e 7265 7368 6170 6528 2d31 2c20 672e  g.reshape(-1, g.
-00008c90: 7368 6170 655b 2d31 5d29 2e6d 542c 2061  shape[-1]).mT, a
-00008ca0: 2e72 6573 6861 7065 282d 312c 2061 2e73  .reshape(-1, a.s
-00008cb0: 6861 7065 5b2d 315d 2929 0a0a 2020 2020  hape[-1]))..    
-00008cc0: 7075 745f 6772 6164 7328 2861 2c20 7729  put_grads((a, w)
-00008cd0: 2c20 2867 7261 645f 612c 2067 7261 645f  , (grad_a, grad_
-00008ce0: 7729 290a 0a20 2020 2069 6620 6269 6173  w))..    if bias
-00008cf0: 2069 7320 6e6f 7420 4e6f 6e65 3a0a 2020   is not None:.  
-00008d00: 2020 2020 2020 6966 2067 2e6e 6469 6d20        if g.ndim 
-00008d10: 3e20 313a 0a20 2020 2020 2020 2020 2020  > 1:.           
-00008d20: 2067 7261 645f 6269 6173 203d 206c 746f   grad_bias = lto
-00008d30: 7263 682e 7375 6d28 672c 2074 7570 6c65  rch.sum(g, tuple
-00008d40: 2872 616e 6765 2867 2e6e 6469 6d20 2d20  (range(g.ndim - 
-00008d50: 3129 2929 0a20 2020 2020 2020 2065 6c73  1))).        els
-00008d60: 653a 0a20 2020 2020 2020 2020 2020 2067  e:.            g
-00008d70: 7261 645f 6269 6173 203d 2067 0a20 2020  rad_bias = g.   
-00008d80: 2020 2020 2070 7574 5f67 7261 6428 6269       put_grad(bi
-00008d90: 6173 2c20 6772 6164 5f62 6961 7329 0a0a  as, grad_bias)..
-00008da0: 2020 2020 7265 7475 726e 2066 7764 0a0a      return fwd..
-00008db0: 0a72 6567 6973 7465 725f 6772 6164 2870  .register_grad(p
-00008dc0: 6964 732e 4c49 4e45 4152 2c20 5f6c 696e  ids.LINEAR, _lin
-00008dd0: 6561 725f 7072 696d 5f67 7261 6429 0a0a  ear_prim_grad)..
-00008de0: 0a23 2054 4f44 4f20 4164 6420 6578 706c  .# TODO Add expl
-00008df0: 6963 6974 206c 746f 7263 6820 7673 2063  icit ltorch vs c
-00008e00: 6c61 6e67 206d 6f64 756c 6520 746f 2074  lang module to t
-00008e10: 6865 2074 656e 736f 7220 6f70 6572 6174  he tensor operat
-00008e20: 696f 6e73 2062 656c 6f77 0a23 2054 4f44  ions below.# TOD
-00008e30: 4f20 636f 756c 6420 7765 2067 6574 2072  O could we get r
-00008e40: 6964 206f 6620 7468 6520 6669 6e61 6c20  id of the final 
-00008e50: 7371 7565 657a 6573 2069 6e20 7468 6520  squeezes in the 
-00008e60: 622e 6e64 696d 203d 3d20 3120 6361 7365  b.ndim == 1 case
-00008e70: 2061 6e64 2074 6865 2061 2e6e 6469 6d20   and the a.ndim 
-00008e80: 3d3d 2031 2063 6173 653f 0a40 746f 7263  == 1 case?.@torc
-00008e90: 6863 7478 0a64 6566 205f 6d61 746d 756c  hctx.def _matmul
-00008ea0: 5f70 7269 6d5f 6772 6164 2861 3a20 5465  _prim_grad(a: Te
-00008eb0: 6e73 6f72 5072 6f78 792c 2062 3a20 5465  nsorProxy, b: Te
-00008ec0: 6e73 6f72 5072 6f78 792c 202f 2920 2d3e  nsorProxy, /) ->
-00008ed0: 2054 656e 736f 7250 726f 7879 3a0a 2020   TensorProxy:.  
-00008ee0: 2020 6677 6420 3d20 7072 696d 732e 6d61    fwd = prims.ma
-00008ef0: 746d 756c 2861 2c20 6229 0a20 2020 2067  tmul(a, b).    g
-00008f00: 203d 2067 6574 5f67 7261 6428 6677 6429   = get_grad(fwd)
-00008f10: 0a0a 2020 2020 6c61 7374 5f64 696d 203d  ..    last_dim =
-00008f20: 2028 2d31 2c29 0a20 2020 2066 6972 7374   (-1,).    first
-00008f30: 5f64 696d 203d 2028 2d32 2c29 0a20 2020  _dim = (-2,).   
-00008f40: 2069 6620 612e 6e64 696d 203d 3d20 3120   if a.ndim == 1 
-00008f50: 616e 6420 622e 6e64 696d 203d 3d20 313a  and b.ndim == 1:
-00008f60: 0a20 2020 2020 2020 2070 7574 5f67 7261  .        put_gra
-00008f70: 6473 2828 612c 2062 292c 2028 6720 2a20  ds((a, b), (g * 
-00008f80: 622c 2067 202a 2061 2929 0a20 2020 2065  b, g * a)).    e
-00008f90: 6c69 6620 622e 6e64 696d 203d 3d20 313a  lif b.ndim == 1:
-00008fa0: 0a20 2020 2020 2020 2067 6120 3d20 756e  .        ga = un
-00008fb0: 7371 7565 657a 6528 672c 206c 6173 745f  squeeze(g, last_
-00008fc0: 6469 6d29 2040 2075 6e73 7175 6565 7a65  dim) @ unsqueeze
-00008fd0: 2862 2c20 6c61 7374 5f64 696d 292e 6d54  (b, last_dim).mT
-00008fe0: 0a20 2020 2020 2020 2067 6220 3d20 612e  .        gb = a.
-00008ff0: 6d54 2040 2075 6e73 7175 6565 7a65 2867  mT @ unsqueeze(g
-00009000: 2c20 6c61 7374 5f64 696d 290a 2020 2020  , last_dim).    
-00009010: 2020 2020 6966 2067 2e6e 6469 6d20 3e20      if g.ndim > 
-00009020: 313a 0a20 2020 2020 2020 2020 2020 2067  1:.            g
-00009030: 6220 3d20 7371 7565 657a 6528 6762 2c20  b = squeeze(gb, 
-00009040: 6c61 7374 5f64 696d 290a 2020 2020 2020  last_dim).      
-00009050: 2020 2020 2020 6762 203d 206c 746f 7263        gb = ltorc
-00009060: 682e 7375 6d28 6762 2c20 7475 706c 6528  h.sum(gb, tuple(
-00009070: 7261 6e67 6528 6762 2e6e 6469 6d20 2d20  range(gb.ndim - 
-00009080: 3129 2929 0a20 2020 2020 2020 2070 7574  1))).        put
-00009090: 5f67 7261 6473 2828 612c 2062 292c 2028  _grads((a, b), (
-000090a0: 6761 2c20 6762 2e73 7175 6565 7a65 2829  ga, gb.squeeze()
-000090b0: 2929 0a20 2020 2065 6c69 6620 612e 6e64  )).    elif a.nd
-000090c0: 696d 203d 3d20 313a 0a20 2020 2020 2020  im == 1:.       
-000090d0: 2067 6120 3d20 756e 7371 7565 657a 6528   ga = unsqueeze(
-000090e0: 672c 2066 6972 7374 5f64 696d 2920 4020  g, first_dim) @ 
-000090f0: 622e 6d54 0a20 2020 2020 2020 2069 6620  b.mT.        if 
-00009100: 672e 6e64 696d 203e 2031 3a0a 2020 2020  g.ndim > 1:.    
-00009110: 2020 2020 2020 2020 6761 203d 206c 746f          ga = lto
-00009120: 7263 682e 7375 6d28 6761 2c20 7475 706c  rch.sum(ga, tupl
-00009130: 6528 7261 6e67 6528 6761 2e6e 6469 6d20  e(range(ga.ndim 
-00009140: 2d20 3129 2929 0a20 2020 2020 2020 2067  - 1))).        g
-00009150: 6220 3d20 756e 7371 7565 657a 6528 612c  b = unsqueeze(a,
-00009160: 2066 6972 7374 5f64 696d 292e 6d54 2040   first_dim).mT @
-00009170: 2075 6e73 7175 6565 7a65 2867 2c20 6669   unsqueeze(g, fi
-00009180: 7273 745f 6469 6d29 0a20 2020 2020 2020  rst_dim).       
-00009190: 2070 7574 5f67 7261 6473 2828 612c 2062   put_grads((a, b
-000091a0: 292c 2028 6761 2e73 7175 6565 7a65 2829  ), (ga.squeeze()
-000091b0: 2c20 6762 2929 0a20 2020 2065 6c73 653a  , gb)).    else:
-000091c0: 0a20 2020 2020 2020 2070 7574 5f67 7261  .        put_gra
-000091d0: 6473 2828 612c 2062 292c 2028 6720 4020  ds((a, b), (g @ 
-000091e0: 622e 6d54 2c20 612e 6d54 2040 2067 2929  b.mT, a.mT @ g))
-000091f0: 0a0a 2020 2020 7265 7475 726e 2066 7764  ..    return fwd
-00009200: 0a0a 0a72 6567 6973 7465 725f 6772 6164  ...register_grad
-00009210: 2870 6964 732e 4d41 544d 554c 2c20 5f6d  (pids.MATMUL, _m
-00009220: 6174 6d75 6c5f 7072 696d 5f67 7261 6429  atmul_prim_grad)
-00009230: 0a0a 230a 2320 4e4e 206f 7065 7261 746f  ..#.# NN operato
-00009240: 7220 6772 6164 730a 230a 0a0a 4074 6f72  r grads.#...@tor
-00009250: 6368 6374 780a 6465 6620 5f65 6d62 6564  chctx.def _embed
-00009260: 6469 6e67 5f70 7269 6d5f 6772 6164 280a  ding_prim_grad(.
-00009270: 2020 2020 613a 2054 656e 736f 7250 726f      a: TensorPro
-00009280: 7879 2c20 2f2c 2077 6569 6768 742c 202a  xy, /, weight, *
-00009290: 2c20 7061 6464 696e 675f 6964 783d 2d31  , padding_idx=-1
-000092a0: 2c20 6d61 785f 6e6f 726d 3d4e 6f6e 652c  , max_norm=None,
-000092b0: 206e 6f72 6d5f 7479 7065 3d32 2e30 2c20   norm_type=2.0, 
-000092c0: 7363 616c 655f 6772 6164 5f62 795f 6672  scale_grad_by_fr
-000092d0: 6571 3d46 616c 7365 2c20 7370 6172 7365  eq=False, sparse
-000092e0: 3d46 616c 7365 0a29 202d 3e20 5465 6e73  =False.) -> Tens
-000092f0: 6f72 5072 6f78 793a 0a20 2020 2066 7764  orProxy:.    fwd
-00009300: 203d 2070 7269 6d73 2e65 6d62 6564 6469   = prims.embeddi
-00009310: 6e67 280a 2020 2020 2020 2020 612c 0a20  ng(.        a,. 
-00009320: 2020 2020 2020 2077 6569 6768 742c 0a20         weight,. 
-00009330: 2020 2020 2020 2070 6164 6469 6e67 5f69         padding_i
-00009340: 6478 3d70 6164 6469 6e67 5f69 6478 2c0a  dx=padding_idx,.
-00009350: 2020 2020 2020 2020 6d61 785f 6e6f 726d          max_norm
-00009360: 3d6d 6178 5f6e 6f72 6d2c 0a20 2020 2020  =max_norm,.     
-00009370: 2020 206e 6f72 6d5f 7479 7065 3d6e 6f72     norm_type=nor
-00009380: 6d5f 7479 7065 2c0a 2020 2020 2020 2020  m_type,.        
-00009390: 7363 616c 655f 6772 6164 5f62 795f 6672  scale_grad_by_fr
-000093a0: 6571 3d73 6361 6c65 5f67 7261 645f 6279  eq=scale_grad_by
-000093b0: 5f66 7265 712c 0a20 2020 2020 2020 2073  _freq,.        s
-000093c0: 7061 7273 653d 7370 6172 7365 2c0a 2020  parse=sparse,.  
-000093d0: 2020 290a 0a20 2020 2067 203d 2067 6574    )..    g = get
-000093e0: 5f67 7261 6428 6677 6429 0a20 2020 2061  _grad(fwd).    a
-000093f0: 5f67 7261 6420 3d20 7072 696d 732e 656d  _grad = prims.em
-00009400: 6265 6464 696e 675f 6261 636b 7761 7264  bedding_backward
-00009410: 2867 2c20 612c 2077 6569 6768 742e 7368  (g, a, weight.sh
-00009420: 6170 655b 305d 2c20 7061 6464 696e 675f  ape[0], padding_
-00009430: 6964 782c 2073 6361 6c65 5f67 7261 645f  idx, scale_grad_
-00009440: 6279 5f66 7265 712c 2073 7061 7273 6529  by_freq, sparse)
-00009450: 0a20 2020 2070 7574 5f67 7261 6428 612c  .    put_grad(a,
-00009460: 2061 5f67 7261 6429 0a0a 2020 2020 7265   a_grad)..    re
-00009470: 7475 726e 2066 7764 0a0a 0a72 6567 6973  turn fwd...regis
-00009480: 7465 725f 6772 6164 2870 6964 732e 454d  ter_grad(pids.EM
-00009490: 4245 4444 494e 472c 205f 656d 6265 6464  BEDDING, _embedd
-000094a0: 696e 675f 7072 696d 5f67 7261 6429 0a0a  ing_prim_grad)..
-000094b0: 230a 2320 5068 616e 746f 6d20 6772 6164  #.# Phantom grad
-000094c0: 2074 7261 6e73 666f 726d 2068 656c 7065   transform helpe
-000094d0: 7273 0a23 0a0a 0a64 6566 205f 6765 745f  rs.#...def _get_
-000094e0: 6772 6164 666e 5f61 6e64 5f65 7865 6375  gradfn_and_execu
-000094f0: 746f 7228 0a20 2020 2062 7379 6d3a 2042  tor(.    bsym: B
-00009500: 6f75 6e64 5379 6d62 6f6c 2c20 2a2c 2065  oundSymbol, *, e
-00009510: 7865 6375 746f 7273 5f6c 6973 743a 2053  xecutors_list: S
-00009520: 6571 7565 6e63 655b 416e 795d 203d 2074  equence[Any] = t
-00009530: 7570 6c65 2829 0a29 202d 3e20 7475 706c  uple().) -> tupl
-00009540: 655b 4361 6c6c 6162 6c65 207c 204e 6f6e  e[Callable | Non
-00009550: 652c 2045 7865 6375 746f 7220 7c20 4e6f  e, Executor | No
-00009560: 6e65 5d3a 0a20 2020 2063 6420 3d20 6765  ne]:.    cd = ge
-00009570: 745f 636f 6d70 696c 655f 6461 7461 2829  t_compile_data()
-00009580: 0a20 2020 2065 7865 6375 746f 7273 5f6c  .    executors_l
-00009590: 6973 7420 3d20 6364 2e65 7865 6375 746f  ist = cd.executo
-000095a0: 7273 5f6c 6973 7420 6966 2063 6420 6973  rs_list if cd is
-000095b0: 206e 6f74 204e 6f6e 6520 656c 7365 2065   not None else e
-000095c0: 7865 6375 746f 7273 5f6c 6973 740a 2020  xecutors_list.  
-000095d0: 2020 2320 4368 6563 6b73 2069 6620 7468    # Checks if th
-000095e0: 6520 6578 6563 7574 6f72 2077 6869 6368  e executor which
-000095f0: 2068 6173 2070 7269 6f72 6974 7920 666f   has priority fo
-00009600: 7220 7468 6973 206f 7065 7261 7469 6f6e  r this operation
-00009610: 2068 6173 2061 2073 7065 6369 6669 6320   has a specific 
-00009620: 6772 6164 2074 7261 6e73 666f 726d 2066  grad transform f
-00009630: 6f72 2069 740a 2020 2020 666f 7220 6578  or it.    for ex
-00009640: 2069 6e20 6578 6563 7574 6f72 735f 6c69   in executors_li
-00009650: 7374 3a0a 2020 2020 2020 2020 6966 2065  st:.        if e
-00009660: 782e 6361 6e5f 6578 6563 7574 655f 6f72  x.can_execute_or
-00009670: 5f66 7573 6528 6273 796d 293a 0a20 2020  _fuse(bsym):.   
-00009680: 2020 2020 2020 2020 2065 785f 6772 6164           ex_grad
-00009690: 5f74 7261 6e73 666f 726d 3a20 4e6f 6e65  _transform: None
-000096a0: 207c 2043 616c 6c61 626c 6520 3d20 6578   | Callable = ex
-000096b0: 2e67 6574 5f67 7261 645f 7472 616e 7366  .get_grad_transf
-000096c0: 6f72 6d28 6273 796d 2e73 796d 290a 2020  orm(bsym.sym).  
-000096d0: 2020 2020 2020 2020 2020 6966 2065 785f            if ex_
-000096e0: 6772 6164 5f74 7261 6e73 666f 726d 2069  grad_transform i
-000096f0: 7320 6e6f 7420 4e6f 6e65 3a0a 2020 2020  s not None:.    
-00009700: 2020 2020 2020 2020 2020 2020 7265 7475              retu
-00009710: 726e 2065 785f 6772 6164 5f74 7261 6e73  rn ex_grad_trans
-00009720: 666f 726d 2c20 6578 0a20 2020 2020 2020  form, ex.       
-00009730: 2020 2020 2062 7265 616b 0a0a 2020 2020       break..    
-00009740: 2320 4966 2074 6865 2065 7865 6375 746f  # If the executo
-00009750: 7220 646f 6573 6e27 7420 6465 6669 6e65  r doesn't define
-00009760: 2069 7473 206f 776e 2067 7261 6420 7472   its own grad tr
-00009770: 616e 7366 6f72 6d2c 2074 6869 7320 6a75  ansform, this ju
-00009780: 7374 2072 6574 7572 6e73 2074 6865 2064  st returns the d
-00009790: 6566 6175 6c74 2067 7261 6420 7472 616e  efault grad tran
-000097a0: 7366 6f72 6d20 666f 7220 7468 6520 6273  sform for the bs
-000097b0: 796d 0a20 2020 2067 7261 6466 6e20 3d20  ym.    gradfn = 
-000097c0: 5f67 7261 645f 666e 5f6d 6170 2e67 6574  _grad_fn_map.get
-000097d0: 2862 7379 6d2e 7379 6d2e 6964 2c20 4e6f  (bsym.sym.id, No
-000097e0: 6e65 290a 2020 2020 7265 7475 726e 2067  ne).    return g
-000097f0: 7261 6466 6e2c 204e 6f6e 650a 0a0a 2320  radfn, None...# 
-00009800: 5468 6520 6465 6661 756c 7420 6772 6164  The default grad
-00009810: 2073 7065 6369 6669 6572 2066 6f72 2074   specifier for t
-00009820: 6865 2067 7261 6420 7472 616e 7366 6f72  he grad transfor
-00009830: 6d0a 2320 2020 466f 7220 6561 6368 2074  m.#   For each t
-00009840: 656e 736f 7220 6f75 7470 7574 2022 6f22  ensor output "o"
-00009850: 2072 6571 7569 7269 6e67 2067 7261 642c   requiring grad,
-00009860: 2073 7065 6369 6669 6573 2061 2067 7261   specifies a gra
-00009870: 6420 6f66 206f 6e65 735f 6c69 6b65 286f  d of ones_like(o
-00009880: 290a 6465 6620 5f67 7261 645f 7370 6563  ).def _grad_spec
-00009890: 6966 6965 725f 6465 6661 756c 7428 7079  ifier_default(py
-000098a0: 7472 6565 3a20 416e 7929 202d 3e20 4e6f  tree: Any) -> No
-000098b0: 6e65 3a0a 2020 2020 666c 6174 732c 205f  ne:.    flats, _
-000098c0: 203d 2074 7265 655f 666c 6174 7465 6e28   = tree_flatten(
-000098d0: 7079 7472 6565 290a 0a20 2020 2066 6f72  pytree)..    for
-000098e0: 2066 2069 6e20 666c 6174 733a 0a20 2020   f in flats:.   
-000098f0: 2020 2020 2069 6620 6973 696e 7374 616e       if isinstan
-00009900: 6365 2866 2c20 5465 6e73 6f72 5072 6f78  ce(f, TensorProx
-00009910: 7929 2061 6e64 2066 2e72 6571 7569 7265  y) and f.require
-00009920: 735f 6772 6164 3a0a 2020 2020 2020 2020  s_grad:.        
-00009930: 2020 2020 2320 4e4f 5445 2054 6869 7320      # NOTE This 
-00009940: 7573 6573 2063 6c61 6e67 2e6f 6e65 735f  uses clang.ones_
-00009950: 6c69 6b65 2066 6f72 206e 6f77 2062 6563  like for now bec
-00009960: 6175 7365 206c 746f 7263 682e 6f6e 6573  ause ltorch.ones
-00009970: 5f6c 696b 6520 7769 6c6c 2065 7874 656e  _like will exten
-00009980: 6420 7468 650a 2020 2020 2020 2020 2020  d the.          
-00009990: 2020 2320 2020 6c69 6665 7469 6d65 206f    #   lifetime o
-000099a0: 6620 662c 2077 6869 6c65 2063 6c61 6e67  f f, while clang
-000099b0: 2e6f 6e65 735f 6c69 6b65 2077 696c 6c20  .ones_like will 
-000099c0: 6578 7472 6163 7420 7468 6520 6d65 7461  extract the meta
-000099d0: 6461 7461 206f 6620 6620 6174 2074 7261  data of f at tra
-000099e0: 6365 2074 696d 650a 2020 2020 2020 2020  ce time.        
-000099f0: 2020 2020 7072 696d 732e 7075 745f 6772      prims.put_gr
-00009a00: 6164 2866 2c20 636c 616e 672e 6675 6c6c  ad(f, clang.full
-00009a10: 5f6c 696b 6528 662c 2031 2e30 2929 0a0a  _like(f, 1.0))..
-00009a20: 0a23 2054 4f44 4f20 5465 7374 2077 6974  .# TODO Test wit
-00009a30: 6820 6275 6666 6572 730a 6465 6620 5f67  h buffers.def _g
-00009a40: 7261 645f 6f75 745f 7370 6563 6966 6965  rad_out_specifie
-00009a50: 725f 6465 6661 756c 7428 7079 7472 6565  r_default(pytree
-00009a60: 3a20 416e 7929 202d 3e20 6c69 7374 5b54  : Any) -> list[T
-00009a70: 656e 736f 7250 726f 7879 5d3a 0a20 2020  ensorProxy]:.   
-00009a80: 2066 6c61 7473 2c20 5f20 3d20 7472 6565   flats, _ = tree
-00009a90: 5f66 6c61 7474 656e 2870 7974 7265 6529  _flatten(pytree)
-00009aa0: 0a20 2020 2067 7261 6473 203d 206c 6973  .    grads = lis
-00009ab0: 7428 5b70 7269 6d73 2e67 6574 5f67 7261  t([prims.get_gra
-00009ac0: 6428 6629 2066 6f72 2066 2069 6e20 666c  d(f) for f in fl
-00009ad0: 6174 7320 6966 2069 7369 6e73 7461 6e63  ats if isinstanc
-00009ae0: 6528 662c 2054 656e 736f 7250 726f 7879  e(f, TensorProxy
-00009af0: 2920 616e 6420 662e 7265 7175 6972 6573  ) and f.requires
-00009b00: 5f67 7261 645d 290a 2020 2020 7265 7475  _grad]).    retu
-00009b10: 726e 2067 7261 6473 0a0a 0a23 2054 4f44  rn grads...# TOD
-00009b20: 4f20 466f 726d 616c 6c79 2064 6566 696e  O Formally defin
-00009b30: 6520 7468 6520 2267 7261 6469 656e 7422  e the "gradient"
-00009b40: 206f 6620 6120 7465 6e73 6f72 0a23 2054   of a tensor.# T
-00009b50: 4f44 4f20 4966 206e 6f6e 6520 6f66 2074  ODO If none of t
-00009b60: 6865 2069 6e70 7574 7320 746f 2061 6e20  he inputs to an 
-00009b70: 6f70 6572 6174 696f 6e20 7265 7175 6972  operation requir
-00009b80: 6520 6772 6164 2c20 7468 656e 2077 6520  e grad, then we 
-00009b90: 636f 756c 6420 6c65 6176 6520 7468 6174  could leave that
-00009ba0: 206f 7065 7261 7469 6f6e 2061 6c6f 6e65   operation alone
-00009bb0: 0a23 2020 2054 6869 7320 636f 756c 6420  .#   This could 
-00009bc0: 6163 7475 616c 6c79 2069 6d70 726f 7665  actually improve
-00009bd0: 2070 6572 666f 726d 616e 6365 2069 6620   performance if 
-00009be0: 7468 6520 6f70 6572 6174 696f 6e20 7065  the operation pe
-00009bf0: 7266 6f72 6d73 2065 7874 7261 2063 6f6d  rforms extra com
-00009c00: 7075 7461 7469 6f6e 7320 696e 2069 7473  putations in its
-00009c10: 2067 7261 6420 7472 616e 7366 6f72 6d0a   grad transform.
-00009c20: 2320 2020 4120 776f 726b 6172 6f75 6e64  #   A workaround
-00009c30: 2066 6f72 2074 6869 7320 776f 756c 6420   for this would 
-00009c40: 6265 2066 6f72 2074 6865 206f 7065 7261  be for the opera
-00009c50: 7469 6f6e 2069 7473 656c 6620 746f 2063  tion itself to c
-00009c60: 6865 636b 2069 6620 6974 7320 696e 7075  heck if its inpu
-00009c70: 7420 7265 7175 6972 6573 2067 7261 6420  t requires grad 
-00009c80: 6f72 206e 6f74 0a23 2054 7261 6e73 666f  or not.# Transfo
-00009c90: 726d 7320 6120 6675 6e63 7469 6f6e 2074  rms a function t
-00009ca0: 6f20 636f 6d70 7574 6520 7468 6520 2267  o compute the "g
-00009cb0: 7261 6469 656e 7422 206f 6620 6974 7320  radient" of its 
-00009cc0: 696e 7075 7473 2072 6571 7569 7269 6e67  inputs requiring
-00009cd0: 2067 7261 642c 2070 6f73 7369 626c 790a   grad, possibly.
-00009ce0: 2320 2020 6d6f 6469 6669 6564 2062 7920  #   modified by 
-00009cf0: 7468 6520 6772 6164 2073 7065 6369 6669  the grad specifi
-00009d00: 6572 7320 2873 6565 2062 656c 6f77 292e  ers (see below).
-00009d10: 0a23 2054 6865 206f 7074 696f 6e61 6c20  .# The optional 
-00009d20: 6772 6164 5f73 7065 6369 6669 6572 2061  grad_specifier a
-00009d30: 7267 756d 656e 7420 6163 6365 7074 7320  rgument accepts 
-00009d40: 7468 6520 6675 6e63 7469 6f6e 2773 206f  the function's o
-00009d50: 7574 7075 742c 2072 756e 7320 696e 2061  utput, runs in a
-00009d60: 206e 6f2d 6772 6164 2063 6f6e 7465 7874   no-grad context
-00009d70: 2c0a 2320 2020 616e 6420 6361 6e20 7075  ,.#   and can pu
-00009d80: 7420 6772 6164 7320 2875 7369 6e67 2070  t grads (using p
-00009d90: 7269 6d73 2e70 7574 5f67 7261 6428 2929  rims.put_grad())
-00009da0: 2066 6f72 2074 656e 736f 7273 2e20 4279   for tensors. By
-00009db0: 2064 6566 6175 6c74 2c20 666f 7220 6576   default, for ev
-00009dc0: 6572 7920 7465 6e73 6f72 206f 7574 7075  ery tensor outpu
-00009dd0: 7420 226f 220a 2320 2020 7468 6174 2072  t "o".#   that r
-00009de0: 6571 7569 7265 7320 6772 6164 2c20 6120  equires grad, a 
-00009df0: 6772 6164 206f 6620 6f6e 6573 5f6c 696b  grad of ones_lik
-00009e00: 6528 6f29 2069 7320 7075 742e 0a23 2054  e(o) is put..# T
-00009e10: 6865 206f 7074 696f 6e61 6c20 6772 6164  he optional grad
-00009e20: 5f6f 7574 5f73 7065 6369 6669 6572 2061  _out_specifier a
-00009e30: 6363 6570 7473 2074 6865 2066 756e 6374  ccepts the funct
-00009e40: 696f 6e27 7320 696e 7075 7420 616e 6420  ion's input and 
-00009e50: 6361 6e20 6361 6c6c 2070 7269 6d73 2e67  can call prims.g
-00009e60: 6574 5f67 7261 6428 2920 746f 0a23 2020  et_grad() to.#  
-00009e70: 2061 6371 7569 7265 2061 6e64 2072 6574   acquire and ret
-00009e80: 7572 6e20 6772 6164 6965 6e74 7320 6173  urn gradients as
-00009e90: 2064 6573 6972 6564 2e20 4279 2064 6566   desired. By def
-00009ea0: 6175 6c74 2c20 7468 6520 696e 7075 7420  ault, the input 
-00009eb0: 6973 2066 6c61 7474 656e 6564 0a23 2020  is flattened.#  
-00009ec0: 2028 7472 6565 5f66 6c61 7474 656e 2861   (tree_flatten(a
-00009ed0: 7267 732c 206b 7761 7267 7329 2920 616e  rgs, kwargs)) an
-00009ee0: 6420 6120 666c 6174 206c 6973 7420 6f66  d a flat list of
-00009ef0: 2067 7261 6473 2066 6f72 2061 6c6c 2074   grads for all t
-00009f00: 656e 736f 7273 2072 6571 7569 7269 6e67  ensors requiring
-00009f10: 2067 7261 640a 2320 2020 616e 6420 4e6f   grad.#   and No
-00009f20: 6e65 2066 6f72 206f 7468 6572 2069 6e70  ne for other inp
-00009f30: 7574 7320 6973 2072 6574 7572 6e65 642e  uts is returned.
-00009f40: 0a23 2054 6865 2061 6c67 6f72 6974 686d  .# The algorithm
-00009f50: 2066 6f72 206d 6f64 6966 7969 6e67 2074   for modifying t
-00009f60: 6865 2070 726f 6772 616d 2068 6173 2074  he program has t
-00009f70: 6865 2066 6f6c 6c6f 7769 6e67 2073 7465  he following ste
-00009f80: 7073 3a0a 2320 2020 3129 2046 6c61 7474  ps:.#   1) Flatt
-00009f90: 656e 7320 7468 6520 6f72 6967 696e 616c  ens the original
-00009fa0: 2074 7261 6365 2066 6f72 2074 6865 2067   trace for the g
-00009fb0: 7261 6420 7472 616e 7366 6f72 6d20 2d2d  rad transform --
-00009fc0: 2065 6e73 7569 6e67 2074 6861 7420 616c   ensuing that al
-00009fd0: 6c20 746f 702d 6c65 7665 6c20 7379 6d62  l top-level symb
-00009fe0: 6f6c 7320 6861 7665 0a23 2020 2020 2020  ols have.#      
-00009ff0: 2061 2067 7261 6420 6675 6e63 7469 6f6e   a grad function
-0000a000: 2e0a 6465 6620 6772 6164 280a 2020 2020  ..def grad(.    
-0000a010: 6366 6e2c 2067 7261 645f 7370 6563 6966  cfn, grad_specif
-0000a020: 6965 723a 2043 616c 6c61 626c 6520 3d20  ier: Callable = 
-0000a030: 5f67 7261 645f 7370 6563 6966 6965 725f  _grad_specifier_
-0000a040: 6465 6661 756c 742c 2067 7261 645f 6f75  default, grad_ou
-0000a050: 745f 7370 6563 6966 6965 723a 2043 616c  t_specifier: Cal
-0000a060: 6c61 626c 6520 3d20 5f67 7261 645f 6f75  lable = _grad_ou
-0000a070: 745f 7370 6563 6966 6965 725f 6465 6661  t_specifier_defa
-0000a080: 756c 740a 2920 2d3e 2043 616c 6c61 626c  ult.) -> Callabl
-0000a090: 653a 0a20 2020 2023 2043 7265 6174 6573  e:.    # Creates
-0000a0a0: 2061 2063 7573 746f 6d20 7472 616e 7366   a custom transf
-0000a0b0: 6f72 6d20 6361 6c6c 6162 6c65 2074 6861  orm callable tha
-0000a0c0: 7420 6269 6e64 7320 7468 6520 6164 6469  t binds the addi
-0000a0d0: 7469 6f6e 616c 2061 7267 756d 656e 7473  tional arguments
-0000a0e0: 2074 6f20 7468 6520 6772 6164 2074 7261   to the grad tra
-0000a0f0: 6e73 666f 726d 0a20 2020 2040 6c61 6e67  nsform.    @lang
-0000a100: 6374 7828 4c61 6e67 7561 6765 732e 434c  ctx(Languages.CL
-0000a110: 414e 4729 0a20 2020 2064 6566 205f 6772  ANG).    def _gr
-0000a120: 6164 5f74 7261 6e73 666f 726d 2874 7263  ad_transform(trc
-0000a130: 3a20 5472 6163 652c 202a 2c20 6578 6563  : Trace, *, exec
-0000a140: 7574 6f72 735f 6c69 7374 3a20 5365 7175  utors_list: Sequ
-0000a150: 656e 6365 5b41 6e79 5d29 202d 3e20 5472  ence[Any]) -> Tr
-0000a160: 6163 653a 0a20 2020 2020 2020 2073 7461  ace:.        sta
-0000a170: 7274 5f74 696d 655f 6e73 203d 2074 696d  rt_time_ns = tim
-0000a180: 652e 7469 6d65 5f6e 7328 290a 0a20 2020  e.time_ns()..   
-0000a190: 2020 2020 2023 2053 5445 5020 4f4e 4520       # STEP ONE 
-0000a1a0: 2d2d 2046 6c61 7474 656e 7320 616e 6420  -- Flattens and 
-0000a1b0: 6463 6573 0a0a 2020 2020 2020 2020 2320  dces..        # 
-0000a1c0: 5265 7475 726e 7320 5472 7565 2069 6620  Returns True if 
-0000a1d0: 7468 6520 6273 796d 2068 6173 206e 6f20  the bsym has no 
-0000a1e0: 6772 6164 2066 756e 6374 696f 6e2c 2061  grad function, a
-0000a1f0: 6e64 2073 6f20 6d75 7374 2062 6520 666c  nd so must be fl
-0000a200: 6174 7465 6e65 6420 666f 7220 7468 6520  attened for the 
-0000a210: 6772 6164 2074 7261 6e73 666f 726d 0a20  grad transform. 
-0000a220: 2020 2020 2020 206e 6576 6572 5f66 6c61         never_fla
-0000a230: 7474 656e 3a20 7365 745b 4861 7368 6162  tten: set[Hashab
-0000a240: 6c65 5d20 3d20 7b70 7269 6d73 2e50 7269  le] = {prims.Pri
-0000a250: 6d49 4473 2e52 4554 5552 4e2c 2070 7269  mIDs.RETURN, pri
-0000a260: 6d73 2e50 7269 6d49 4473 2e55 4e50 4143  ms.PrimIDs.UNPAC
-0000a270: 4b5f 5452 4956 4941 4c7d 0a0a 2020 2020  K_TRIVIAL}..    
-0000a280: 2020 2020 6465 6620 7368 6f75 6c64 5f66      def should_f
-0000a290: 6c61 7474 656e 5f66 6f72 5f67 7261 6428  latten_for_grad(
-0000a2a0: 6273 796d 3a20 426f 756e 6453 796d 626f  bsym: BoundSymbo
-0000a2b0: 6c29 202d 3e20 626f 6f6c 3a0a 2020 2020  l) -> bool:.    
-0000a2c0: 2020 2020 2020 2020 6966 2062 7379 6d2e          if bsym.
-0000a2d0: 7379 6d2e 6964 2069 6e20 6e65 7665 725f  sym.id in never_
-0000a2e0: 666c 6174 7465 6e3a 0a20 2020 2020 2020  flatten:.       
-0000a2f0: 2020 2020 2020 2020 2072 6574 7572 6e20           return 
-0000a300: 4661 6c73 650a 0a20 2020 2020 2020 2020  False..         
-0000a310: 2020 2067 7261 6466 6e3a 204e 6f6e 6520     gradfn: None 
-0000a320: 7c20 4361 6c6c 6162 6c65 0a20 2020 2020  | Callable.     
-0000a330: 2020 2020 2020 2067 7261 6466 6e2c 205f         gradfn, _
-0000a340: 203d 205f 6765 745f 6772 6164 666e 5f61   = _get_gradfn_a
-0000a350: 6e64 5f65 7865 6375 746f 7228 6273 796d  nd_executor(bsym
-0000a360: 2c20 6578 6563 7574 6f72 735f 6c69 7374  , executors_list
-0000a370: 3d65 7865 6375 746f 7273 5f6c 6973 7429  =executors_list)
-0000a380: 0a20 2020 2020 2020 2020 2020 2072 6574  .            ret
-0000a390: 7572 6e20 6772 6164 666e 2069 7320 4e6f  urn gradfn is No
-0000a3a0: 6e65 0a0a 2020 2020 2020 2020 2320 544f  ne..        # TO
-0000a3b0: 444f 2052 4331 3a20 6d61 7962 6520 6d6f  DO RC1: maybe mo
-0000a3c0: 7665 2074 6f20 7072 6f64 7563 6520 7468  ve to produce th
-0000a3d0: 6573 6520 616c 7761 7973 206f 6e20 6372  ese always on cr
-0000a3e0: 6561 7469 6f6e 0a20 2020 2020 2020 2069  eation.        i
-0000a3f0: 6620 7472 632e 6b77 6172 6773 2069 7320  f trc.kwargs is 
-0000a400: 4e6f 6e65 3a0a 2020 2020 2020 2020 2020  None:.          
-0000a410: 2020 7472 632e 6b77 6172 6773 203d 207b    trc.kwargs = {
-0000a420: 7d0a 2020 2020 2020 2020 6966 2074 7263  }.        if trc
-0000a430: 2e66 6e20 6973 204e 6f6e 653a 0a20 2020  .fn is None:.   
-0000a440: 2020 2020 2020 2020 2074 7263 2e66 6e20           trc.fn 
-0000a450: 3d20 7472 632e 7079 7468 6f6e 5f63 616c  = trc.python_cal
-0000a460: 6c61 626c 6528 290a 0a20 2020 2020 2020  lable()..       
-0000a470: 2067 7261 6474 7263 203d 2066 726f 6d5f   gradtrc = from_
-0000a480: 7472 6163 6528 7472 6329 0a20 2020 2020  trace(trc).     
-0000a490: 2020 2066 6c61 7474 656e 6564 5f62 7379     flattened_bsy
-0000a4a0: 6d73 3a20 6c69 7374 5b42 6f75 6e64 5379  ms: list[BoundSy
-0000a4b0: 6d62 6f6c 5d20 3d20 666c 6174 7465 6e5f  mbol] = flatten_
-0000a4c0: 666f 725f 7472 616e 7366 6f72 6d28 7368  for_transform(sh
-0000a4d0: 6f75 6c64 5f66 6c61 7474 656e 5f66 6f72  ould_flatten_for
-0000a4e0: 5f67 7261 642c 2074 7263 2e62 6f75 6e64  _grad, trc.bound
-0000a4f0: 5f73 796d 626f 6c73 290a 2020 2020 2020  _symbols).      
-0000a500: 2020 6772 6164 7472 632e 626f 756e 645f    gradtrc.bound_
-0000a510: 7379 6d62 6f6c 7320 3d20 666c 6174 7465  symbols = flatte
-0000a520: 6e65 645f 6273 796d 730a 2020 2020 2020  ned_bsyms.      
-0000a530: 2020 6772 6164 7472 6320 3d20 6463 6528    gradtrc = dce(
-0000a540: 6772 6164 7472 6329 0a0a 2020 2020 2020  gradtrc)..      
-0000a550: 2020 2320 5354 4550 2054 574f 202d 2d20    # STEP TWO -- 
-0000a560: 5265 706c 6163 6573 206f 7269 6769 6e61  Replaces origina
-0000a570: 6c20 6361 6c6c 7320 7769 7468 2067 7261  l calls with gra
-0000a580: 6420 6361 6c6c 730a 0a20 2020 2020 2020  d calls..       
-0000a590: 2023 2044 6566 696e 6573 2074 6865 2076   # Defines the v
-0000a5a0: 6973 6974 6f72 2070 6174 7465 726e 2066  isitor pattern f
-0000a5b0: 6f72 2074 6865 2066 6972 7374 2070 6173  or the first pas
-0000a5c0: 7320 6f66 2074 6865 2067 7261 6420 7472  s of the grad tr
-0000a5d0: 616e 7366 6f72 6d2c 0a20 2020 2020 2020  ansform,.       
-0000a5e0: 2023 2020 2077 6869 6368 2073 7761 7073   #   which swaps
-0000a5f0: 2042 6f75 6e64 5379 6d62 6f6c 7320 7769   BoundSymbols wi
-0000a600: 7468 2074 6865 6972 2067 7261 6420 6675  th their grad fu
-0000a610: 6e63 7469 6f6e 730a 2020 2020 2020 2020  nctions.        
-0000a620: 6465 6620 7669 7369 745f 2862 7379 6d3a  def visit_(bsym:
-0000a630: 2042 6f75 6e64 5379 6d62 6f6c 2920 2d3e   BoundSymbol) ->
-0000a640: 2043 616c 6c61 626c 653a 0a20 2020 2020   Callable:.     
-0000a650: 2020 2020 2020 2067 7261 6466 6e3a 204e         gradfn: N
-0000a660: 6f6e 6520 7c20 4361 6c6c 6162 6c65 0a20  one | Callable. 
-0000a670: 2020 2020 2020 2020 2020 2067 7261 6466             gradf
-0000a680: 6e2c 205f 203d 205f 6765 745f 6772 6164  n, _ = _get_grad
-0000a690: 666e 5f61 6e64 5f65 7865 6375 746f 7228  fn_and_executor(
-0000a6a0: 6273 796d 2c20 6578 6563 7574 6f72 735f  bsym, executors_
-0000a6b0: 6c69 7374 3d65 7865 6375 746f 7273 5f6c  list=executors_l
-0000a6c0: 6973 7429 0a20 2020 2020 2020 2020 2020  ist).           
-0000a6d0: 2063 6865 636b 280a 2020 2020 2020 2020   check(.        
-0000a6e0: 2020 2020 2020 2020 6772 6164 666e 2069          gradfn i
-0000a6f0: 7320 6e6f 7420 4e6f 6e65 2c0a 2020 2020  s not None,.    
-0000a700: 2020 2020 2020 2020 2020 2020 6c61 6d62              lamb
-0000a710: 6461 3a20 6622 4661 696c 6564 2074 6f20  da: f"Failed to 
-0000a720: 6669 6e64 2061 2067 7261 6466 6e20 666f  find a gradfn fo
-0000a730: 7220 7b62 7379 6d3d 7d20 6166 7465 7220  r {bsym=} after 
-0000a740: 666c 6174 7465 6e69 6e67 222c 0a20 2020  flattening",.   
-0000a750: 2020 2020 2020 2020 2020 2020 2065 7863               exc
-0000a760: 6570 7469 6f6e 5f74 7970 653d 4173 7365  eption_type=Asse
-0000a770: 7274 696f 6e45 7272 6f72 2c0a 2020 2020  rtionError,.    
-0000a780: 2020 2020 2020 2020 290a 2020 2020 2020          ).      
-0000a790: 2020 2020 2020 7265 7475 726e 2067 7261        return gra
-0000a7a0: 6466 6e0a 0a20 2020 2020 2020 2040 7772  dfn..        @wr
-0000a7b0: 6170 7328 7472 632e 666e 2e6d 6574 6120  aps(trc.fn.meta 
-0000a7c0: 6966 2069 7369 6e73 7461 6e63 6528 7472  if isinstance(tr
-0000a7d0: 632e 666e 2c20 5379 6d62 6f6c 2920 656c  c.fn, Symbol) el
-0000a7e0: 7365 2074 7263 2e66 6e29 0a20 2020 2020  se trc.fn).     
-0000a7f0: 2020 2064 6566 2069 6e74 6572 7072 6574     def interpret
-0000a800: 696e 675f 666e 282a 6172 6773 2c20 2a2a  ing_fn(*args, **
-0000a810: 6b77 6172 6773 293a 0a20 2020 2020 2020  kwargs):.       
-0000a820: 2020 2020 2072 6573 756c 7420 3d20 6576       result = ev
-0000a830: 616c 5f74 7261 6365 2867 7261 6474 7263  al_trace(gradtrc
-0000a840: 2c20 2a61 7267 732c 2073 796d 626f 6c5f  , *args, symbol_
-0000a850: 6d61 7070 6572 3d76 6973 6974 5f2c 202a  mapper=visit_, *
-0000a860: 2a6b 7761 7267 7329 0a20 2020 2020 2020  *kwargs).       
-0000a870: 2020 2020 2023 2053 6574 7320 6772 6164       # Sets grad
-0000a880: 7320 666f 7220 6f75 7470 7574 0a20 2020  s for output.   
-0000a890: 2020 2020 2020 2020 2023 2054 4f44 4f20           # TODO 
-0000a8a0: 5468 6973 2065 6666 6563 7469 7665 6c79  This effectively
-0000a8b0: 2072 756e 7320 696e 2061 206e 6f20 6772   runs in a no gr
-0000a8c0: 6164 2063 6f6e 7465 7874 202d 2d20 7368  ad context -- sh
-0000a8d0: 6f75 6c64 2069 7420 7275 6e20 696e 2061  ould it run in a
-0000a8e0: 2067 7261 6420 636f 6e74 6578 742c 0a20   grad context,. 
-0000a8f0: 2020 2020 2020 2020 2020 2023 2020 206f             #   o
-0000a900: 7220 7368 6f75 6c64 2074 6865 7265 2062  r should there b
-0000a910: 6520 7468 6520 6f70 7469 6f6e 2074 6f20  e the option to 
-0000a920: 7275 6e20 6974 2069 6e20 6120 6772 6164  run it in a grad
-0000a930: 2063 6f6e 7465 7874 3f0a 2020 2020 2020   context?.      
-0000a940: 2020 2020 2020 6772 6164 5f73 7065 6369        grad_speci
-0000a950: 6669 6572 2872 6573 756c 7429 0a20 2020  fier(result).   
-0000a960: 2020 2020 2020 2020 2023 2043 6f6e 7374           # Const
-0000a970: 7275 6374 7320 7265 7475 726e 2076 616c  ructs return val
-0000a980: 7565 0a20 2020 2020 2020 2020 2020 2066  ue.            f
-0000a990: 6c61 745f 6772 6164 7320 3d20 6772 6164  lat_grads = grad
-0000a9a0: 5f6f 7574 5f73 7065 6369 6669 6572 2828  _out_specifier((
-0000a9b0: 6172 6773 2c20 6b77 6172 6773 2929 0a20  args, kwargs)). 
-0000a9c0: 2020 2020 2020 2020 2020 2072 6574 7572             retur
-0000a9d0: 6e20 666c 6174 5f67 7261 6473 0a0a 2020  n flat_grads..  
-0000a9e0: 2020 2020 2020 2320 4e4f 5445 2041 6674        # NOTE Aft
-0000a9f0: 6572 2074 6869 7320 6361 6c6c 2074 6865  er this call the
-0000aa00: 2067 7261 6474 7263 2069 7320 696e 7661   gradtrc is inva
-0000aa10: 6c69 642c 2062 6563 6175 7365 3a0a 2020  lid, because:.  
-0000aa20: 2020 2020 2020 2320 2020 3129 2054 6865        #   1) The
-0000aa30: 206e 6f6e 2d65 7865 6375 7461 626c 6520   non-executable 
-0000aa40: 7075 745f 6772 6164 206f 7065 7261 7469  put_grad operati
-0000aa50: 6f6e 7320 6172 6520 7374 696c 6c20 696e  ons are still in
-0000aa60: 2074 6865 2074 7261 6365 2c20 616e 6420   the trace, and 
-0000aa70: 6d75 6c74 6970 6c65 2063 616c 6c73 2074  multiple calls t
-0000aa80: 6f20 7075 7420 6772 6164 2061 7265 206e  o put grad are n
-0000aa90: 6f74 2061 6363 756d 756c 6174 6564 0a20  ot accumulated. 
-0000aaa0: 2020 2020 2020 2023 2020 2032 2920 5468         #   2) Th
-0000aab0: 6520 6e6f 6e2d 6578 6563 7574 6162 6c65  e non-executable
-0000aac0: 2067 6574 5f67 7261 6420 6f70 6572 6174   get_grad operat
-0000aad0: 696f 6e73 2061 7265 2073 7469 6c6c 2069  ions are still i
-0000aae0: 6e20 7468 6520 7472 6163 652c 2061 6e64  n the trace, and
-0000aaf0: 2074 6865 7920 6d61 7920 7072 6f64 7563   they may produc
-0000ab00: 6520 6469 6666 6572 656e 7420 7072 6f78  e different prox
-0000ab10: 6965 7320 7768 656e 0a20 2020 2020 2020  ies when.       
-0000ab20: 2023 2020 2020 2020 2063 616c 6c65 6420   #       called 
-0000ab30: 6f6e 2074 6865 2073 616d 6520 696e 7075  on the same inpu
-0000ab40: 7473 0a20 2020 2020 2020 2023 2020 2033  ts.        #   3
-0000ab50: 2920 5468 6520 6f70 6572 6174 696f 6e73  ) The operations
-0000ab60: 2061 7265 206e 6f74 2069 6e20 6120 7661   are not in a va
-0000ab70: 6c69 6420 6f72 6465 720a 2020 2020 2020  lid order.      
-0000ab80: 2020 6772 6164 7472 6320 3d20 636f 6e73    gradtrc = cons
-0000ab90: 7472 7563 745f 7472 6163 6528 0a20 2020  truct_trace(.   
-0000aba0: 2020 2020 2020 2020 2072 656e 616d 655f           rename_
-0000abb0: 7072 6f78 6965 733d 4661 6c73 652c 0a20  proxies=False,. 
-0000abc0: 2020 2020 2020 2020 2020 2075 7365 5f64             use_d
-0000abd0: 6365 3d46 616c 7365 2c0a 2020 2020 2020  ce=False,.      
-0000abe0: 2020 2928 696e 7465 7270 7265 7469 6e67    )(interpreting
-0000abf0: 5f66 6e2c 202a 6772 6164 7472 632e 6172  _fn, *gradtrc.ar
-0000ac00: 6773 2c20 2a2a 6772 6164 7472 632e 6b77  gs, **gradtrc.kw
-0000ac10: 6172 6773 290a 2020 2020 2020 2020 6772  args).        gr
-0000ac20: 6164 7472 632e 7363 6f70 6573 203d 205b  adtrc.scopes = [
-0000ac30: 6772 6164 7472 632e 626f 756e 645f 7379  gradtrc.bound_sy
-0000ac40: 6d62 6f6c 735d 0a20 2020 2020 2020 2067  mbols].        g
-0000ac50: 7261 6474 7263 2e5f 636f 6d70 6c65 7465  radtrc._complete
-0000ac60: 203d 2046 616c 7365 0a0a 2020 2020 2020   = False..      
-0000ac70: 2020 2320 5354 4550 2054 4852 4545 202d    # STEP THREE -
-0000ac80: 2d20 4861 6e64 6c65 7320 7075 745f 6772  - Handles put_gr
-0000ac90: 6164 2061 6e64 2067 6574 5f67 7261 6420  ad and get_grad 
-0000aca0: 6f70 6572 6174 696f 6e73 2061 6e64 2061  operations and a
-0000acb0: 6363 756d 756c 6174 6573 2067 7261 6469  ccumulates gradi
-0000acc0: 656e 7473 0a0a 2020 2020 2020 2020 2320  ents..        # 
-0000acd0: 4163 6375 6d75 6c61 7465 7320 6772 6164  Accumulates grad
-0000ace0: 6965 6e74 732c 2063 7265 6174 696e 6720  ients, creating 
-0000acf0: 7468 6520 7072 696d 616c 202d 3e20 6163  the primal -> ac
-0000ad00: 6375 6d75 6c61 7465 6420 6772 6164 206d  cumulated grad m
-0000ad10: 6170 7069 6e67 0a20 2020 2020 2020 2023  apping.        #
-0000ad20: 2053 6574 7320 7468 6520 7472 6163 696e   Sets the tracin
-0000ad30: 6720 636f 6e74 6578 7420 736f 2061 6363  g context so acc
-0000ad40: 756d 756c 6174 696f 6e20 6f70 6572 6174  umulation operat
-0000ad50: 696f 6e73 2061 7265 2072 6563 6f72 6465  ions are recorde
-0000ad60: 6420 696e 746f 2074 6865 2074 7261 6365  d into the trace
-0000ad70: 0a20 2020 2020 2020 2074 7279 3a0a 2020  .        try:.  
-0000ad80: 2020 2020 2020 2020 2020 7472 6163 6563            tracec
-0000ad90: 7478 5f74 6f6b 203d 2073 6574 5f74 7261  tx_tok = set_tra
-0000ada0: 6365 6374 7828 6772 6164 7472 6329 0a0a  cectx(gradtrc)..
-0000adb0: 2020 2020 2020 2020 2020 2020 2320 4d61              # Ma
-0000adc0: 7073 2070 7269 6d61 6c73 2074 6f20 7468  ps primals to th
-0000add0: 6569 7220 6772 6164 6965 6e74 7320 2877  eir gradients (w
-0000ade0: 6869 6368 2061 7265 2072 6574 7572 6e65  hich are returne
-0000adf0: 6420 6672 6f6d 2063 616c 6c69 6e67 2067  d from calling g
-0000ae00: 6574 5f67 7261 6420 6f6e 2074 6865 2070  et_grad on the p
-0000ae10: 7269 6d61 6c29 0a20 2020 2020 2020 2020  rimal).         
-0000ae20: 2020 2070 7269 6d61 6c73 5f74 6f5f 6769     primals_to_gi
-0000ae30: 6e70 7574 5f6d 6170 3a20 6469 6374 5b56  nput_map: dict[V
-0000ae40: 6172 6961 626c 652c 2054 656e 736f 7250  ariable, TensorP
-0000ae50: 726f 7879 5d20 3d20 7b7d 0a0a 2020 2020  roxy] = {}..    
-0000ae60: 2020 2020 2020 2020 2320 4861 6e64 6c65          # Handle
-0000ae70: 7320 7075 745f 6772 6164 206f 7065 7261  s put_grad opera
-0000ae80: 7469 6f6e 730a 2020 2020 2020 2020 2020  tions.          
-0000ae90: 2020 2320 4e4f 5445 2054 6869 7320 6d6f    # NOTE This mo
-0000aea0: 6469 6669 6573 2061 206c 6973 7420 7468  difies a list th
-0000aeb0: 6174 2069 7320 6265 696e 6720 656e 756d  at is being enum
-0000aec0: 6572 6174 6564 206f 7665 722c 2062 7574  erated over, but
-0000aed0: 2069 7427 7320 4f4b 2062 6563 6175 7365   it's OK because
-0000aee0: 2077 6527 7265 206f 6e6c 790a 2020 2020   we're only.    
-0000aef0: 2020 2020 2020 2020 2320 2020 6170 7065          #   appe
-0000af00: 6e64 696e 6720 746f 2074 6865 2065 6e64  nding to the end
-0000af10: 206f 6620 7468 6520 6c69 7374 0a20 2020   of the list.   
-0000af20: 2020 2020 2020 2020 2062 7379 6d3a 2042           bsym: B
-0000af30: 6f75 6e64 5379 6d62 6f6c 0a20 2020 2020  oundSymbol.     
-0000af40: 2020 2020 2020 2066 6f72 2062 7379 6d20         for bsym 
-0000af50: 696e 2067 7261 6474 7263 2e62 6f75 6e64  in gradtrc.bound
-0000af60: 5f73 796d 626f 6c73 3a0a 2020 2020 2020  _symbols:.      
-0000af70: 2020 2020 2020 2020 2020 6964 3a20 4861            id: Ha
-0000af80: 7368 6162 6c65 203d 2062 7379 6d2e 7379  shable = bsym.sy
-0000af90: 6d2e 6964 0a20 2020 2020 2020 2020 2020  m.id.           
-0000afa0: 2020 2020 2069 6620 6964 2069 7320 7069       if id is pi
-0000afb0: 6473 2e50 5554 5f47 5241 443a 0a20 2020  ds.PUT_GRAD:.   
-0000afc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000afd0: 2070 7269 6d61 6c3a 204e 756d 6265 7220   primal: Number 
-0000afe0: 7c20 5465 6e73 6f72 5072 6f78 790a 2020  | TensorProxy.  
-0000aff0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000b000: 2020 6772 6164 3a20 4e75 6d62 6572 207c    grad: Number |
-0000b010: 2054 656e 736f 7250 726f 7879 0a20 2020   TensorProxy.   
-0000b020: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000b030: 2070 7269 6d61 6c2c 2067 7261 6420 3d20   primal, grad = 
-0000b040: 6273 796d 2e66 6c61 745f 6172 6773 0a0a  bsym.flat_args..
-0000b050: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000b060: 2020 2020 2320 544f 444f 2053 7570 706f      # TODO Suppo
-0000b070: 7274 2061 7574 6f67 7261 6420 6f6e 206e  rt autograd on n
-0000b080: 756d 6265 7273 0a20 2020 2020 2020 2020  umbers.         
-0000b090: 2020 2020 2020 2020 2020 2023 2046 696c             # Fil
-0000b0a0: 7465 7273 2063 616c 6c73 2074 6f20 7075  ters calls to pu
-0000b0b0: 745f 6772 6164 2074 6861 7420 776f 756c  t_grad that woul
-0000b0c0: 6420 7075 7420 6120 6772 6164 206f 6e20  d put a grad on 
-0000b0d0: 6120 6e6f 6e2d 7465 6e73 6f72 206f 7220  a non-tensor or 
-0000b0e0: 6120 7465 6e73 6f72 2074 6861 7420 646f  a tensor that do
-0000b0f0: 6573 6e27 7420 7265 7175 6972 6520 6772  esn't require gr
-0000b100: 6164 0a20 2020 2020 2020 2020 2020 2020  ad.             
-0000b110: 2020 2020 2020 2069 6620 6e6f 7420 6973         if not is
-0000b120: 696e 7374 616e 6365 2870 7269 6d61 6c2c  instance(primal,
-0000b130: 2054 656e 736f 7250 726f 7879 2920 6f72   TensorProxy) or
-0000b140: 206e 6f74 2070 7269 6d61 6c2e 7265 7175   not primal.requ
-0000b150: 6972 6573 5f67 7261 643a 0a20 2020 2020  ires_grad:.     
-0000b160: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000b170: 2020 2063 6f6e 7469 6e75 650a 0a20 2020     continue..   
-0000b180: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000b190: 2023 2054 4f44 4f20 5375 7070 6f72 7420   # TODO Support 
-0000b1a0: 636f 6d70 6c65 7820 6175 746f 6772 6164  complex autograd
-0000b1b0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0000b1c0: 2020 2020 2063 6865 636b 280a 2020 2020       check(.    
-0000b1d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000b1e0: 2020 2020 6e6f 7420 6474 7970 6573 2e69      not dtypes.i
-0000b1f0: 735f 636f 6d70 6c65 785f 6474 7970 6528  s_complex_dtype(
-0000b200: 6474 7970 6573 2e74 6f5f 6474 7970 6528  dtypes.to_dtype(
-0000b210: 7072 696d 616c 2929 2c0a 2020 2020 2020  primal)),.      
-0000b220: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000b230: 2020 6c61 6d62 6461 3a20 6622 436f 6d70    lambda: f"Comp
-0000b240: 6c65 7820 6772 6164 2069 7320 6e6f 7420  lex grad is not 
-0000b250: 7375 7070 6f72 7465 6420 7965 7422 2c0a  supported yet",.
-0000b260: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000b270: 2020 2020 290a 0a20 2020 2020 2020 2020      )..         
-0000b280: 2020 2020 2020 2020 2020 2076 7072 696d             vprim
-0000b290: 616c 3a20 5661 7269 6162 6c65 203d 2076  al: Variable = v
-0000b2a0: 6172 6961 626c 6569 6679 2870 7269 6d61  ariableify(prima
-0000b2b0: 6c29 0a20 2020 2020 2020 2020 2020 2020  l).             
-0000b2c0: 2020 2020 2020 2061 6363 756d 3a20 4e6f         accum: No
-0000b2d0: 6e65 207c 2054 656e 736f 7250 726f 7879  ne | TensorProxy
-0000b2e0: 203d 2070 7269 6d61 6c73 5f74 6f5f 6769   = primals_to_gi
-0000b2f0: 6e70 7574 5f6d 6170 2e67 6574 2876 7072  nput_map.get(vpr
-0000b300: 696d 616c 2c20 4e6f 6e65 290a 0a20 2020  imal, None)..   
-0000b310: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000b320: 2069 6620 6163 6375 6d20 6973 204e 6f6e   if accum is Non
-0000b330: 653a 0a20 2020 2020 2020 2020 2020 2020  e:.             
-0000b340: 2020 2020 2020 2020 2020 2070 7269 6d61             prima
-0000b350: 6c73 5f74 6f5f 6769 6e70 7574 5f6d 6170  ls_to_ginput_map
-0000b360: 5b76 7072 696d 616c 5d20 3d20 6772 6164  [vprimal] = grad
-0000b370: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0000b380: 2020 2020 2065 6c73 653a 0a20 2020 2020       else:.     
-0000b390: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000b3a0: 2020 2061 6363 756d 203d 2061 6363 756d     accum = accum
-0000b3b0: 202b 2067 7261 640a 2020 2020 2020 2020   + grad.        
-0000b3c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000b3d0: 7072 696d 616c 735f 746f 5f67 696e 7075  primals_to_ginpu
-0000b3e0: 745f 6d61 705b 7670 7269 6d61 6c5d 203d  t_map[vprimal] =
-0000b3f0: 2061 6363 756d 0a0a 2020 2020 2020 2020   accum..        
-0000b400: 2020 2020 2320 4861 6e64 6c65 7320 6765      # Handles ge
-0000b410: 745f 6772 6164 206f 7065 7261 7469 6f6e  t_grad operation
-0000b420: 730a 0a20 2020 2020 2020 2020 2020 2023  s..            #
-0000b430: 2052 6573 6574 7320 7468 6520 7377 6170   Resets the swap
-0000b440: 6d61 7020 666f 7220 6772 6164 730a 2020  map for grads.  
-0000b450: 2020 2020 2020 2020 2020 7377 6170 6d61            swapma
-0000b460: 703a 2064 6963 745b 5661 7269 6162 6c65  p: dict[Variable
-0000b470: 2c20 5072 6f78 795d 203d 207b 7d0a 0a20  , Proxy] = {}.. 
-0000b480: 2020 2020 2020 2020 2020 2066 6f72 2062             for b
-0000b490: 7379 6d20 696e 2067 7261 6474 7263 2e62  sym in gradtrc.b
-0000b4a0: 6f75 6e64 5f73 796d 626f 6c73 3a0a 2020  ound_symbols:.  
-0000b4b0: 2020 2020 2020 2020 2020 2020 2020 6964                id
-0000b4c0: 3a20 4861 7368 6162 6c65 203d 2062 7379  : Hashable = bsy
-0000b4d0: 6d2e 7379 6d2e 6964 0a20 2020 2020 2020  m.sym.id.       
-0000b4e0: 2020 2020 2020 2020 2069 6620 6964 2069           if id i
-0000b4f0: 7320 7069 6473 2e47 4554 5f47 5241 443a  s pids.GET_GRAD:
-0000b500: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0000b510: 2020 2020 2070 7269 6d61 6c3a 204e 756d       primal: Num
-0000b520: 6265 7220 7c20 5465 6e73 6f72 5072 6f78  ber | TensorProx
-0000b530: 790a 2020 2020 2020 2020 2020 2020 2020  y.              
-0000b540: 2020 2020 2020 2870 7269 6d61 6c2c 2920        (primal,) 
-0000b550: 3d20 6273 796d 2e66 6c61 745f 6172 6773  = bsym.flat_args
-0000b560: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0000b570: 2020 2020 2067 7261 643a 204e 756d 6265       grad: Numbe
-0000b580: 7220 7c20 5465 6e73 6f72 5072 6f78 7920  r | TensorProxy 
-0000b590: 3d20 6273 796d 2e6f 7574 7075 740a 0a20  = bsym.output.. 
+00004b20: 6c61 6d62 6461 3a20 6622 4e6f 2067 7261  lambda: f"No gra
+00004b30: 6420 7275 6c65 2066 6f75 6e64 2066 6f72  d rule found for
+00004b40: 207b 6273 796d 7d20 616e 6420 6e6f 2073   {bsym} and no s
+00004b50: 7562 7379 6d62 6f6c 7320 696e 7369 6465  ubsymbols inside
+00004b60: 2069 7420 746f 2063 7265 6174 6520 6120   it to create a 
+00004b70: 6772 6164 2066 6f72 6d75 6c61 222c 0a20  grad formula",. 
+00004b80: 2020 2020 2020 2020 2020 2029 0a20 2020             ).   
+00004b90: 2020 2020 2020 2020 2066 6f72 2073 6273           for sbs
+00004ba0: 796d 2069 6e20 6273 796d 2e73 7562 7379  ym in bsym.subsy
+00004bb0: 6d62 6f6c 733a 0a20 2020 2020 2020 2020  mbols:.         
+00004bc0: 2020 2020 2020 205f 666c 6174 7465 6e28         _flatten(
+00004bd0: 7362 7379 6d29 0a20 2020 2020 2020 2065  sbsym).        e
+00004be0: 6c73 653a 0a20 2020 2020 2020 2020 2020  lse:.           
+00004bf0: 2066 6c61 7474 656e 6564 2e61 7070 656e   flattened.appen
+00004c00: 6428 6273 796d 290a 0a20 2020 2066 6f72  d(bsym)..    for
+00004c10: 2062 7379 6d20 696e 2062 7379 6d73 3a0a   bsym in bsyms:.
+00004c20: 2020 2020 2020 2020 5f66 6c61 7474 656e          _flatten
+00004c30: 2862 7379 6d29 0a0a 2020 2020 7265 7475  (bsym)..    retu
+00004c40: 726e 2066 6c61 7474 656e 6564 0a0a 0a23  rn flattened...#
+00004c50: 0a23 2050 6861 6e74 6f6d 2067 7261 6420  .# Phantom grad 
+00004c60: 7472 616e 7366 6f72 6d0a 230a 0a23 0a23  transform.#..#.#
+00004c70: 2046 756e 6374 696f 6e73 2072 656c 6174   Functions relat
+00004c80: 6564 2074 6f20 6675 6e63 7469 6f6e 616c  ed to functional
+00004c90: 697a 696e 6720 5468 756e 6465 724f 7074  izing ThunderOpt
+00004ca0: 696d 697a 6564 4d6f 6475 6c65 730a 230a  imizedModules.#.
+00004cb0: 0a0a 2320 544f 444f 2054 6573 7420 7769  ..# TODO Test wi
+00004cc0: 7468 2062 7566 6665 7273 0a64 6566 2070  th buffers.def p
+00004cd0: 6f70 756c 6174 655f 6772 6164 7328 6772  opulate_grads(gr
+00004ce0: 6164 733a 206c 6973 745b 5465 6e73 6f72  ads: list[Tensor
+00004cf0: 5072 6f78 795d 2c20 746f 6d3a 204e 6f6e  Proxy], tom: Non
+00004d00: 6520 7c20 746f 7263 682e 6e6e 2e4d 6f64  e | torch.nn.Mod
+00004d10: 756c 6520 3d20 4e6f 6e65 2c20 6172 6773  ule = None, args
+00004d20: 3d4e 6f6e 652c 206b 7761 7267 733d 4e6f  =None, kwargs=No
+00004d30: 6e65 2920 2d3e 204e 6f6e 653a 0a20 2020  ne) -> None:.   
+00004d40: 2069 6478 3a20 696e 7420 3d20 300a 2020   idx: int = 0.  
+00004d50: 2020 6672 6f6d 2074 6875 6e64 6572 2069    from thunder i
+00004d60: 6d70 6f72 7420 5468 756e 6465 724d 6f64  mport ThunderMod
+00004d70: 756c 652c 2063 6f6d 7069 6c65 5f64 6174  ule, compile_dat
+00004d80: 610a 0a20 2020 2069 6620 6973 696e 7374  a..    if isinst
+00004d90: 616e 6365 2874 6f6d 2c20 5468 756e 6465  ance(tom, Thunde
+00004da0: 724d 6f64 756c 6529 206f 7220 636f 6d70  rModule) or comp
+00004db0: 696c 655f 6461 7461 2874 6f6d 292e 7573  ile_data(tom).us
+00004dc0: 696e 675f 6a69 743a 0a20 2020 2020 2020  ing_jit:.       
+00004dd0: 2061 7373 6572 7420 6172 6773 2069 7320   assert args is 
+00004de0: 6e6f 7420 4e6f 6e65 2c20 2270 6f70 756c  not None, "popul
+00004df0: 6174 6520 6772 6164 206e 6565 6473 2061  ate grad needs a
+00004e00: 7267 7320 2861 6e64 2070 6f73 7369 626c  rgs (and possibl
+00004e10: 7920 6b77 6172 6773 2920 746f 2077 6f72  y kwargs) to wor
+00004e20: 6b20 7769 7468 2054 6875 6e64 6572 4d6f  k with ThunderMo
+00004e30: 6475 6c65 7322 0a20 2020 2020 2020 2069  dules".        i
+00004e40: 6620 6b77 6172 6773 2069 7320 4e6f 6e65  f kwargs is None
+00004e50: 3a0a 2020 2020 2020 2020 2020 2020 6b77  :.            kw
+00004e60: 6172 6773 203d 207b 7d0a 2020 2020 2020  args = {}.      
+00004e70: 2020 5f2c 2063 6f6d 7075 7461 7469 6f6e    _, computation
+00004e80: 5f69 6e70 7574 732c 205f 203d 2063 6f6d  _inputs, _ = com
+00004e90: 7069 6c65 5f64 6174 6128 746f 6d29 2e67  pile_data(tom).g
+00004ea0: 6574 5f63 6f6d 7075 7461 7469 6f6e 5f61  et_computation_a
+00004eb0: 6e64 5f69 6e70 7574 7328 2a61 7267 732c  nd_inputs(*args,
+00004ec0: 202a 2a6b 7761 7267 7329 0a20 2020 2020   **kwargs).     
+00004ed0: 2020 2066 6f72 2070 2069 6e20 636f 6d70     for p in comp
+00004ee0: 7574 6174 696f 6e5f 696e 7075 7473 3a0a  utation_inputs:.
+00004ef0: 2020 2020 2020 2020 2020 2020 6966 2069              if i
+00004f00: 7369 6e73 7461 6e63 6528 702c 2074 6f72  sinstance(p, tor
+00004f10: 6368 2e54 656e 736f 7229 2061 6e64 2070  ch.Tensor) and p
+00004f20: 2e72 6571 7569 7265 735f 6772 6164 3a0a  .requires_grad:.
+00004f30: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00004f40: 2320 5375 7070 6f72 7473 2067 7261 6420  # Supports grad 
+00004f50: 6163 6375 6d75 6c61 7469 6f6e 2028 6c69  accumulation (li
+00004f60: 6b65 2077 6865 6e20 7765 6967 6874 2074  ke when weight t
+00004f70: 7969 6e67 290a 2020 2020 2020 2020 2020  ying).          
+00004f80: 2020 2020 2020 6966 2070 2e67 7261 6420        if p.grad 
+00004f90: 6973 206e 6f74 204e 6f6e 653a 0a20 2020  is not None:.   
+00004fa0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00004fb0: 2070 2e67 7261 6420 2b3d 2067 7261 6473   p.grad += grads
+00004fc0: 5b69 6478 5d0a 2020 2020 2020 2020 2020  [idx].          
+00004fd0: 2020 2020 2020 656c 7365 3a0a 2020 2020        else:.    
+00004fe0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00004ff0: 702e 6772 6164 203d 2067 7261 6473 5b69  p.grad = grads[i
+00005000: 6478 5d0a 2020 2020 2020 2020 2020 2020  dx].            
+00005010: 2020 2020 6964 7820 2b3d 2031 0a20 2020      idx += 1.   
+00005020: 2020 2020 2072 6574 7572 6e0a 0a20 2020       return..   
+00005030: 2023 2053 686f 7274 2d63 6972 6375 6974   # Short-circuit
+00005040: 7320 6966 2074 6865 7265 2061 7265 206e  s if there are n
+00005050: 6f20 6172 6773 206f 7220 6b77 6172 6773  o args or kwargs
+00005060: 0a20 2020 2069 6620 6172 6773 2069 7320  .    if args is 
+00005070: 4e6f 6e65 2061 6e64 206b 7761 7267 7320  None and kwargs 
+00005080: 6973 204e 6f6e 653a 0a20 2020 2020 2020  is None:.       
+00005090: 2072 6574 7572 6e0a 0a20 2020 2066 6c61   return..    fla
+000050a0: 7473 2c20 5f20 3d20 7472 6565 5f66 6c61  ts, _ = tree_fla
+000050b0: 7474 656e 2828 6172 6773 2c20 6b77 6172  tten((args, kwar
+000050c0: 6773 2929 0a20 2020 2066 6f72 2066 2069  gs)).    for f i
+000050d0: 6e20 666c 6174 733a 0a20 2020 2020 2020  n flats:.       
+000050e0: 2069 6620 6973 696e 7374 616e 6365 2866   if isinstance(f
+000050f0: 2c20 746f 7263 682e 5465 6e73 6f72 2920  , torch.Tensor) 
+00005100: 616e 6420 662e 7265 7175 6972 6573 5f67  and f.requires_g
+00005110: 7261 643a 0a20 2020 2020 2020 2020 2020  rad:.           
+00005120: 2066 2e67 7261 6420 3d20 6772 6164 735b   f.grad = grads[
+00005130: 6964 785d 0a20 2020 2020 2020 2020 2020  idx].           
+00005140: 2069 6478 202b 3d20 310a 0a0a 6465 6620   idx += 1...def 
+00005150: 6578 7472 6163 745f 6772 6164 7328 6d6f  extract_grads(mo
+00005160: 6475 6c65 3a20 746f 7263 682e 6e6e 2e4d  dule: torch.nn.M
+00005170: 6f64 756c 6529 202d 3e20 7475 706c 655b  odule) -> tuple[
+00005180: 746f 7263 682e 5465 6e73 6f72 2c20 2e2e  torch.Tensor, ..
+00005190: 2e5d 3a0a 2020 2020 6772 6164 7320 3d20  .]:.    grads = 
+000051a0: 7475 706c 6528 0a20 2020 2020 2020 2066  tuple(.        f
+000051b0: 2e67 7261 640a 2020 2020 2020 2020 666f  .grad.        fo
+000051c0: 7220 6620 696e 2063 6861 696e 286d 6f64  r f in chain(mod
+000051d0: 756c 652e 7061 7261 6d65 7465 7273 2829  ule.parameters()
+000051e0: 2c20 6d6f 6475 6c65 2e62 7566 6665 7273  , module.buffers
+000051f0: 2829 290a 2020 2020 2020 2020 6966 2069  ()).        if i
+00005200: 7369 6e73 7461 6e63 6528 662c 2074 6f72  sinstance(f, tor
+00005210: 6368 2e54 656e 736f 7229 2061 6e64 2066  ch.Tensor) and f
+00005220: 2e72 6571 7569 7265 735f 6772 6164 2061  .requires_grad a
+00005230: 6e64 2066 2e67 7261 6420 6973 206e 6f74  nd f.grad is not
+00005240: 204e 6f6e 650a 2020 2020 290a 2020 2020   None.    ).    
+00005250: 7265 7475 726e 2067 7261 6473 0a0a 0a64  return grads...d
+00005260: 6566 2063 6c65 6172 5f67 7261 6473 286d  ef clear_grads(m
+00005270: 6f64 756c 653a 2074 6f72 6368 2e6e 6e2e  odule: torch.nn.
+00005280: 4d6f 6475 6c65 2920 2d3e 204e 6f6e 653a  Module) -> None:
+00005290: 0a20 2020 2069 6620 6e6f 7420 6973 696e  .    if not isin
+000052a0: 7374 616e 6365 286d 6f64 756c 652c 2074  stance(module, t
+000052b0: 6f72 6368 2e6e 6e2e 4d6f 6475 6c65 293a  orch.nn.Module):
+000052c0: 0a20 2020 2020 2020 2072 6574 7572 6e0a  .        return.
+000052d0: 0a20 2020 2066 6f72 2070 2069 6e20 6d6f  .    for p in mo
+000052e0: 6475 6c65 2e70 6172 616d 6574 6572 7328  dule.parameters(
+000052f0: 293a 0a20 2020 2020 2020 2070 2e67 7261  ):.        p.gra
+00005300: 6420 3d20 4e6f 6e65 0a20 2020 2066 6f72  d = None.    for
+00005310: 2062 2069 6e20 6d6f 6475 6c65 2e62 7566   b in module.buf
+00005320: 6665 7273 2829 3a0a 2020 2020 2020 2020  fers():.        
+00005330: 622e 6772 6164 203d 204e 6f6e 650a 0a0a  b.grad = None...
+00005340: 6672 6f6d 2074 6875 6e64 6572 2e63 6f72  from thunder.cor
+00005350: 652e 696e 7465 7270 7265 7465 7220 696d  e.interpreter im
+00005360: 706f 7274 206d 616b 655f 6f70 6171 7565  port make_opaque
+00005370: 0a66 726f 6d20 7468 756e 6465 722e 636f  .from thunder.co
+00005380: 7265 2e6c 616e 6763 7478 7320 696d 706f  re.langctxs impo
+00005390: 7274 206c 616e 6763 7478 2c20 4c61 6e67  rt langctx, Lang
+000053a0: 7561 6765 730a 0a0a 2320 544f 444f 2052  uages...# TODO R
+000053b0: 4331 2052 6570 6c61 6365 2077 6974 6820  C1 Replace with 
+000053c0: 6c61 6e67 6374 780a 6465 6620 746f 7263  langctx.def torc
+000053d0: 6863 7478 2866 6e29 3a0a 2020 2020 5f66  hctx(fn):.    _f
+000053e0: 6e20 3d20 6c61 6e67 6374 7828 4c61 6e67  n = langctx(Lang
+000053f0: 7561 6765 732e 544f 5243 4829 2866 6e29  uages.TORCH)(fn)
+00005400: 0a20 2020 2072 6574 7572 6e20 6d61 6b65  .    return make
+00005410: 5f6f 7061 7175 6528 5f66 6e29 0a0a 0a5f  _opaque(_fn)..._
+00005420: 6772 6164 5f66 6e5f 6d61 703a 2064 6963  grad_fn_map: dic
+00005430: 745b 416e 792c 2043 616c 6c61 626c 655d  t[Any, Callable]
+00005440: 203d 207b 7d0a 0a0a 6465 6620 7265 6769   = {}...def regi
+00005450: 7374 6572 5f67 7261 6428 7379 6d5f 6f72  ster_grad(sym_or
+00005460: 5f69 643a 2053 796d 626f 6c20 7c20 416e  _id: Symbol | An
+00005470: 792c 2067 7261 6466 6e3a 2043 616c 6c61  y, gradfn: Calla
+00005480: 626c 6529 202d 3e20 4e6f 6e65 3a0a 2020  ble) -> None:.  
+00005490: 2020 6964 3a20 416e 7920 3d20 7379 6d5f    id: Any = sym_
+000054a0: 6f72 5f69 640a 2020 2020 6966 2069 7369  or_id.    if isi
+000054b0: 6e73 7461 6e63 6528 7379 6d5f 6f72 5f69  nstance(sym_or_i
+000054c0: 642c 2053 796d 626f 6c29 3a0a 2020 2020  d, Symbol):.    
+000054d0: 2020 2020 6964 203d 2073 796d 5f6f 725f      id = sym_or_
+000054e0: 6964 2e69 640a 2020 2020 5f67 7261 645f  id.id.    _grad_
+000054f0: 666e 5f6d 6170 5b69 645d 203d 2067 7261  fn_map[id] = gra
+00005500: 6466 6e0a 0a0a 2320 4772 6164 2066 756e  dfn...# Grad fun
+00005510: 6374 696f 6e73 2066 6f72 2070 7269 6d73  ctions for prims
+00005520: 0a66 726f 6d20 7468 756e 6465 722e 636f  .from thunder.co
+00005530: 7265 2e70 7269 6d73 2069 6d70 6f72 7420  re.prims import 
+00005540: 5072 696d 4944 7320 6173 2070 6964 732c  PrimIDs as pids,
+00005550: 2067 6574 5f67 7261 642c 2070 7574 5f67   get_grad, put_g
+00005560: 7261 640a 0a0a 2320 4120 6765 6e65 7261  rad...# A genera
+00005570: 6c69 7a61 7469 6f6e 206f 6620 7072 696d  lization of prim
+00005580: 732e 7075 745f 6772 6164 2074 6f20 7079  s.put_grad to py
+00005590: 7472 6565 730a 2320 544f 444f 2043 6f6e  trees.# TODO Con
+000055a0: 7369 6465 7220 7661 6c69 6461 7469 6e67  sider validating
+000055b0: 2074 6861 7420 7468 6520 7370 6563 7320   that the specs 
+000055c0: 6172 6520 7468 6520 7361 6d65 0a23 2054  are the same.# T
+000055d0: 4f44 4f20 436f 6e73 6964 6572 2076 616c  ODO Consider val
+000055e0: 6964 6174 696e 6720 7468 6174 2074 6861  idating that tha
+000055f0: 7420 6f62 6a65 6374 2072 6571 7569 7265  t object require
+00005600: 7320 6772 6164 2028 616e 6420 6669 6c74  s grad (and filt
+00005610: 6572 696e 6720 6f2e 772e 290a 6465 6620  ering o.w.).def 
+00005620: 7075 745f 6772 6164 7328 612c 2067 293a  put_grads(a, g):
+00005630: 0a20 2020 2066 6c61 7473 2c20 5f20 3d20  .    flats, _ = 
+00005640: 7472 6565 5f66 6c61 7474 656e 2861 290a  tree_flatten(a).
+00005650: 2020 2020 666c 6174 6772 6164 732c 205f      flatgrads, _
+00005660: 203d 2074 7265 655f 666c 6174 7465 6e28   = tree_flatten(
+00005670: 6729 0a0a 2020 2020 666f 7220 662c 2066  g)..    for f, f
+00005680: 6720 696e 207a 6970 2866 6c61 7473 2c20  g in zip(flats, 
+00005690: 666c 6174 6772 6164 7329 3a0a 2020 2020  flatgrads):.    
+000056a0: 2020 2020 6966 2069 7369 6e73 7461 6e63      if isinstanc
+000056b0: 6528 662c 2054 656e 736f 7250 726f 7879  e(f, TensorProxy
+000056c0: 2920 616e 6420 6973 696e 7374 616e 6365  ) and isinstance
+000056d0: 2866 672c 2054 656e 736f 7250 726f 7879  (fg, TensorProxy
+000056e0: 293a 0a20 2020 2020 2020 2020 2020 2070  ):.            p
+000056f0: 7574 5f67 7261 6428 662c 2066 6729 0a0a  ut_grad(f, fg)..
+00005700: 0a23 0a23 2055 6e70 6163 6b69 6e67 206f  .#.# Unpacking o
+00005710: 7065 7261 746f 7220 6772 6164 730a 230a  perator grads.#.
+00005720: 0a23 204e 4f54 4520 7072 696d 732e 756e  .# NOTE prims.un
+00005730: 7061 636b 5f65 6d70 7479 5f64 6963 7420  pack_empty_dict 
+00005740: 6372 6561 7465 7320 6e6f 2067 7261 6420  creates no grad 
+00005750: 6173 736f 6369 6174 696f 6e73 0a72 6567  associations.reg
+00005760: 6973 7465 725f 6772 6164 2870 6964 732e  ister_grad(pids.
+00005770: 554e 5041 434b 5f45 4d50 5459 5f44 4943  UNPACK_EMPTY_DIC
+00005780: 542c 2070 7269 6d73 2e75 6e70 6163 6b5f  T, prims.unpack_
+00005790: 656d 7074 795f 6469 6374 290a 0a23 204e  empty_dict)..# N
+000057a0: 4f54 4520 7072 696d 732e 756e 7061 636b  OTE prims.unpack
+000057b0: 5f6b 6579 2063 7265 6174 6573 206e 6f20  _key creates no 
+000057c0: 6772 6164 2061 7373 6f63 6961 7469 6f6e  grad association
+000057d0: 730a 7265 6769 7374 6572 5f67 7261 6428  s.register_grad(
+000057e0: 7069 6473 2e55 4e50 4143 4b5f 4b45 592c  pids.UNPACK_KEY,
+000057f0: 2070 7269 6d73 2e75 6e70 6163 6b5f 6b65   prims.unpack_ke
+00005800: 7929 0a0a 2320 4e4f 5445 2070 7269 6d73  y)..# NOTE prims
+00005810: 2e75 6e70 6163 6b5f 7365 7175 656e 6365  .unpack_sequence
+00005820: 2063 7265 6174 6573 206e 6f20 6772 6164   creates no grad
+00005830: 2061 7373 6f63 6961 7469 6f6e 730a 7265   associations.re
+00005840: 6769 7374 6572 5f67 7261 6428 7069 6473  gister_grad(pids
+00005850: 2e55 4e50 4143 4b5f 5345 5155 454e 4345  .UNPACK_SEQUENCE
+00005860: 2c20 7072 696d 732e 756e 7061 636b 5f73  , prims.unpack_s
+00005870: 6571 7565 6e63 6529 0a0a 0a23 0a23 2044  equence)...#.# D
+00005880: 6174 6120 6d6f 7665 6d65 6e74 2061 6e64  ata movement and
+00005890: 2074 7261 6e73 666f 726d 6174 696f 6e20   transformation 
+000058a0: 6f70 6572 6174 6f72 2067 7261 6473 0a23  operator grads.#
+000058b0: 0a40 746f 7263 6863 7478 0a64 6566 205f  .@torchctx.def _
+000058c0: 636f 6e76 6572 745f 656c 656d 656e 745f  convert_element_
+000058d0: 7479 7065 5f70 7269 6d5f 6772 6164 2861  type_prim_grad(a
+000058e0: 3a20 4e75 6d62 6572 207c 2054 656e 736f  : Number | Tenso
+000058f0: 7250 726f 7879 2c20 6474 7970 653a 2074  rProxy, dtype: t
+00005900: 7970 6520 7c20 6474 7970 6573 2e64 7479  ype | dtypes.dty
+00005910: 7065 2920 2d3e 204e 756d 6265 7220 7c20  pe) -> Number | 
+00005920: 5465 6e73 6f72 5072 6f78 793a 0a20 2020  TensorProxy:.   
+00005930: 2066 7764 203d 2070 7269 6d73 2e63 6f6e   fwd = prims.con
+00005940: 7665 7274 5f65 6c65 6d65 6e74 5f74 7970  vert_element_typ
+00005950: 6528 612c 2064 7479 7065 290a 0a20 2020  e(a, dtype)..   
+00005960: 2067 203d 2067 6574 5f67 7261 6428 6677   g = get_grad(fw
+00005970: 6429 0a20 2020 2067 5f63 6f6e 7665 7274  d).    g_convert
+00005980: 6564 203d 2070 7269 6d73 2e63 6f6e 7665  ed = prims.conve
+00005990: 7274 5f65 6c65 6d65 6e74 5f74 7970 6528  rt_element_type(
+000059a0: 672c 2064 7479 7065 732e 746f 5f64 7479  g, dtypes.to_dty
+000059b0: 7065 2861 2929 0a20 2020 2070 7574 5f67  pe(a)).    put_g
+000059c0: 7261 6428 612c 2067 5f63 6f6e 7665 7274  rad(a, g_convert
+000059d0: 6564 290a 0a20 2020 2072 6574 7572 6e20  ed)..    return 
+000059e0: 6677 640a 0a0a 7265 6769 7374 6572 5f67  fwd...register_g
+000059f0: 7261 6428 7069 6473 2e43 4f4e 5645 5254  rad(pids.CONVERT
+00005a00: 5f45 4c45 4d45 4e54 5f54 5950 452c 205f  _ELEMENT_TYPE, _
+00005a10: 636f 6e76 6572 745f 656c 656d 656e 745f  convert_element_
+00005a20: 7479 7065 5f70 7269 6d5f 6772 6164 290a  type_prim_grad).
+00005a30: 0a23 0a23 2054 656e 736f 7220 6372 6561  .#.# Tensor crea
+00005a40: 7469 6f6e 206f 7065 7261 746f 7220 6772  tion operator gr
+00005a50: 6164 730a 230a 0a23 204e 4f54 4520 7072  ads.#..# NOTE pr
+00005a60: 696d 732e 6675 6c6c 2063 7265 6174 6573  ims.full creates
+00005a70: 206e 6f20 6772 6164 2061 7373 6f63 6961   no grad associa
+00005a80: 7469 6f6e 730a 7265 6769 7374 6572 5f67  tions.register_g
+00005a90: 7261 6428 7069 6473 2e46 554c 4c2c 2070  rad(pids.FULL, p
+00005aa0: 7269 6d73 2e66 756c 6c29 0a0a 2320 4e4f  rims.full)..# NO
+00005ab0: 5445 2070 7269 6d73 2e69 6f74 6120 6372  TE prims.iota cr
+00005ac0: 6561 7465 7320 6e6f 2067 7261 6420 6173  eates no grad as
+00005ad0: 736f 6369 6174 696f 6e73 0a72 6567 6973  sociations.regis
+00005ae0: 7465 725f 6772 6164 2870 6964 732e 494f  ter_grad(pids.IO
+00005af0: 5441 2c20 7072 696d 732e 696f 7461 290a  TA, prims.iota).
+00005b00: 0a0a 6465 6620 5f75 6e69 666f 726d 5f67  ..def _uniform_g
+00005b10: 7261 6428 7368 6170 652c 206d 696e 7661  rad(shape, minva
+00005b20: 6c2c 206d 6178 7661 6c2c 202a 2c20 6465  l, maxval, *, de
+00005b30: 7669 6365 2c20 6474 7970 6529 3a0a 2020  vice, dtype):.  
+00005b40: 2020 6677 642c 2073 6176 6564 203d 2075    fwd, saved = u
+00005b50: 6e69 666f 726d 5f61 7567 5f66 7764 2873  niform_aug_fwd(s
+00005b60: 6861 7065 2c20 6d69 6e76 616c 2c20 6d61  hape, minval, ma
+00005b70: 7876 616c 2c20 6465 7669 6365 3d64 6576  xval, device=dev
+00005b80: 6963 652c 2064 7479 7065 3d64 7479 7065  ice, dtype=dtype
+00005b90: 290a 2020 2020 6720 3d20 6765 745f 6772  ).    g = get_gr
+00005ba0: 6164 2866 7764 290a 2020 2020 5f2c 2067  ad(fwd).    _, g
+00005bb0: 6d69 6e76 616c 2c20 676d 6178 7661 6c20  minval, gmaxval 
+00005bc0: 3d20 756e 6966 6f72 6d5f 6261 636b 7761  = uniform_backwa
+00005bd0: 7264 282a 7361 7665 642c 2067 290a 2020  rd(*saved, g).  
+00005be0: 2020 7075 745f 6772 6164 7328 286d 696e    put_grads((min
+00005bf0: 7661 6c2c 206d 6178 7661 6c29 2c20 2867  val, maxval), (g
+00005c00: 6d69 6e76 616c 2c20 676d 6178 7661 6c29  minval, gmaxval)
+00005c10: 290a 2020 2020 7265 7475 726e 2066 7764  ).    return fwd
+00005c20: 0a0a 0a72 6567 6973 7465 725f 6772 6164  ...register_grad
+00005c30: 2870 6964 732e 554e 4946 4f52 4d2c 205f  (pids.UNIFORM, _
+00005c40: 756e 6966 6f72 6d5f 6772 6164 290a 0a23  uniform_grad)..#
+00005c50: 0a23 2052 6573 6861 7069 6e67 2061 6e64  .# Reshaping and
+00005c60: 2070 6572 6d75 7469 6e67 206f 7065 7261   permuting opera
+00005c70: 746f 7220 6772 6164 730a 230a 0a0a 4074  tor grads.#...@t
+00005c80: 6f72 6368 6374 780a 6465 6620 5f62 726f  orchctx.def _bro
+00005c90: 6164 6361 7374 5f69 6e5f 6469 6d5f 7072  adcast_in_dim_pr
+00005ca0: 696d 5f67 7261 6428 0a20 2020 2061 3a20  im_grad(.    a: 
+00005cb0: 5465 6e73 6f72 5072 6f78 792c 2073 6861  TensorProxy, sha
+00005cc0: 7065 3a20 5365 7175 656e 6365 5b69 6e74  pe: Sequence[int
+00005cd0: 5d2c 2062 726f 6164 6361 7374 5f64 696d  ], broadcast_dim
+00005ce0: 656e 7369 6f6e 733a 2053 6571 7565 6e63  ensions: Sequenc
+00005cf0: 655b 696e 745d 0a29 202d 3e20 5465 6e73  e[int].) -> Tens
+00005d00: 6f72 5072 6f78 793a 0a20 2020 2066 7764  orProxy:.    fwd
+00005d10: 203d 2070 7269 6d73 2e62 726f 6164 6361   = prims.broadca
+00005d20: 7374 5f69 6e5f 6469 6d28 612c 2073 6861  st_in_dim(a, sha
+00005d30: 7065 2c20 6272 6f61 6463 6173 745f 6469  pe, broadcast_di
+00005d40: 6d65 6e73 696f 6e73 290a 0a20 2020 2067  mensions)..    g
+00005d50: 203d 2067 6574 5f67 7261 6428 6677 6429   = get_grad(fwd)
+00005d60: 0a0a 2020 2020 756e 6974 5f64 696d 7320  ..    unit_dims 
+00005d70: 3d20 7475 706c 6528 6920 666f 7220 692c  = tuple(i for i,
+00005d80: 2073 2069 6e20 656e 756d 6572 6174 6528   s in enumerate(
+00005d90: 612e 7368 6170 6529 2069 6620 7320 3d3d  a.shape) if s ==
+00005da0: 2031 290a 2020 2020 6263 6173 745f 6469   1).    bcast_di
+00005db0: 6d73 203d 2074 7570 6c65 2862 2066 6f72  ms = tuple(b for
+00005dc0: 2069 2c20 6220 696e 2065 6e75 6d65 7261   i, b in enumera
+00005dd0: 7465 2862 726f 6164 6361 7374 5f64 696d  te(broadcast_dim
+00005de0: 656e 7369 6f6e 7329 2069 6620 6920 6e6f  ensions) if i no
+00005df0: 7420 696e 2075 6e69 745f 6469 6d73 290a  t in unit_dims).
+00005e00: 2020 2020 7265 6475 6365 5f64 696d 7320      reduce_dims 
+00005e10: 3d20 7475 706c 6528 7320 666f 7220 692c  = tuple(s for i,
+00005e20: 2073 2069 6e20 656e 756d 6572 6174 6528   s in enumerate(
+00005e30: 7261 6e67 6528 6c65 6e28 7368 6170 6529  range(len(shape)
+00005e40: 2929 2069 6620 6920 6e6f 7420 696e 2062  )) if i not in b
+00005e50: 6361 7374 5f64 696d 7329 0a0a 2020 2020  cast_dims)..    
+00005e60: 6720 3d20 6c74 6f72 6368 2e73 756d 2867  g = ltorch.sum(g
+00005e70: 2c20 7265 6475 6365 5f64 696d 7329 0a0a  , reduce_dims)..
+00005e80: 2020 2020 2320 4e4f 5445 2054 6869 7320      # NOTE This 
+00005e90: 6d75 7374 2062 6520 636c 616e 672e 756e  must be clang.un
+00005ea0: 7371 7565 657a 6520 6265 6361 7573 6520  squeeze because 
+00005eb0: 746f 7263 682e 756e 7371 7565 657a 652c  torch.unsqueeze,
+00005ec0: 2075 6e6c 696b 6520 636c 616e 672e 756e   unlike clang.un
+00005ed0: 7371 7565 657a 652c 206f 6e6c 7920 6163  squeeze, only ac
+00005ee0: 6365 7074 7320 616e 2069 6e74 6567 6572  cepts an integer
+00005ef0: 0a20 2020 2023 2020 2028 7075 7420 616e  .    #   (put an
+00005f00: 6f74 6865 7220 7761 792c 2074 6f72 6368  other way, torch
+00005f10: 206f 6e6c 7920 616c 6c6f 7773 206f 6e65   only allows one
+00005f20: 2075 6e73 7175 6565 7a65 2061 7420 6120   unsqueeze at a 
+00005f30: 7469 6d65 290a 2020 2020 6720 3d20 636c  time).    g = cl
+00005f40: 616e 672e 756e 7371 7565 657a 6528 672c  ang.unsqueeze(g,
+00005f50: 2075 6e69 745f 6469 6d73 290a 0a20 2020   unit_dims)..   
+00005f60: 2070 7574 5f67 7261 6428 612c 2067 290a   put_grad(a, g).
+00005f70: 0a20 2020 2072 6574 7572 6e20 6677 640a  .    return fwd.
+00005f80: 0a0a 7265 6769 7374 6572 5f67 7261 6428  ..register_grad(
+00005f90: 7069 6473 2e42 524f 4144 4341 5354 5f49  pids.BROADCAST_I
+00005fa0: 4e5f 4449 4d2c 205f 6272 6f61 6463 6173  N_DIM, _broadcas
+00005fb0: 745f 696e 5f64 696d 5f70 7269 6d5f 6772  t_in_dim_prim_gr
+00005fc0: 6164 290a 0a0a 4074 6f72 6368 6374 780a  ad)...@torchctx.
+00005fd0: 6465 6620 5f63 6174 5f70 7269 6d5f 6772  def _cat_prim_gr
+00005fe0: 6164 2874 656e 736f 7273 3a20 6c69 7374  ad(tensors: list
+00005ff0: 5b54 656e 736f 7250 726f 7879 5d2c 202f  [TensorProxy], /
+00006000: 2c20 6469 6d3a 2069 6e74 2920 2d3e 2054  , dim: int) -> T
+00006010: 656e 736f 7250 726f 7879 3a0a 2020 2020  ensorProxy:.    
+00006020: 6677 6420 3d20 7072 696d 732e 6361 7428  fwd = prims.cat(
+00006030: 7465 6e73 6f72 732c 2064 696d 290a 0a20  tensors, dim).. 
+00006040: 2020 2067 203d 2067 6574 5f67 7261 6428     g = get_grad(
+00006050: 6677 6429 0a0a 2020 2020 736c 6963 655f  fwd)..    slice_
+00006060: 7374 6172 743a 2069 6e74 203d 2030 0a20  start: int = 0. 
+00006070: 2020 2074 3a20 5465 6e73 6f72 5072 6f78     t: TensorProx
+00006080: 790a 2020 2020 666f 7220 7420 696e 2074  y.    for t in t
+00006090: 656e 736f 7273 3a0a 2020 2020 2020 2020  ensors:.        
+000060a0: 6469 6d5f 6c65 6e3a 2069 6e74 203d 2074  dim_len: int = t
+000060b0: 2e73 6861 7065 5b64 696d 5d0a 2020 2020  .shape[dim].    
+000060c0: 2020 2020 736c 6963 655f 656e 643a 2069      slice_end: i
+000060d0: 6e74 203d 2073 6c69 6365 5f73 7461 7274  nt = slice_start
+000060e0: 202b 2064 696d 5f6c 656e 0a20 2020 2020   + dim_len.     
+000060f0: 2020 2067 5f73 6c69 6365 3a20 5465 6e73     g_slice: Tens
+00006100: 6f72 5072 6f78 7920 3d20 636c 616e 672e  orProxy = clang.
+00006110: 736c 6963 655f 696e 5f64 696d 2867 2c20  slice_in_dim(g, 
+00006120: 736c 6963 655f 7374 6172 742c 2073 6c69  slice_start, sli
+00006130: 6365 5f65 6e64 2c20 6469 6d3d 6469 6d29  ce_end, dim=dim)
+00006140: 0a20 2020 2020 2020 2073 6c69 6365 5f73  .        slice_s
+00006150: 7461 7274 203d 2073 6c69 6365 5f65 6e64  tart = slice_end
+00006160: 0a20 2020 2020 2020 2070 7574 5f67 7261  .        put_gra
+00006170: 6428 742c 2067 5f73 6c69 6365 290a 0a20  d(t, g_slice).. 
+00006180: 2020 2072 6574 7572 6e20 6677 640a 0a0a     return fwd...
+00006190: 7265 6769 7374 6572 5f67 7261 6428 7069  register_grad(pi
+000061a0: 6473 2e43 4154 2c20 5f63 6174 5f70 7269  ds.CAT, _cat_pri
+000061b0: 6d5f 6772 6164 290a 0a0a 6465 6620 5f72  m_grad)...def _r
+000061c0: 6573 6861 7065 5f70 7269 6d5f 6772 6164  eshape_prim_grad
+000061d0: 2861 3a20 5465 6e73 6f72 5072 6f78 792c  (a: TensorProxy,
+000061e0: 2073 6861 7065 3a20 7475 706c 655b 696e   shape: tuple[in
+000061f0: 742c 202e 2e2e 5d29 202d 3e20 5465 6e73  t, ...]) -> Tens
+00006200: 6f72 5072 6f78 793a 0a20 2020 2066 7764  orProxy:.    fwd
+00006210: 203d 2070 7269 6d73 2e72 6573 6861 7065   = prims.reshape
+00006220: 2861 2c20 7368 6170 6529 0a0a 2020 2020  (a, shape)..    
+00006230: 6720 3d20 6765 745f 6772 6164 2866 7764  g = get_grad(fwd
+00006240: 290a 0a20 2020 2061 5f67 7261 6420 3d20  )..    a_grad = 
+00006250: 7072 696d 732e 7265 7368 6170 6528 672c  prims.reshape(g,
+00006260: 2061 2e73 6861 7065 290a 2020 2020 7075   a.shape).    pu
+00006270: 745f 6772 6164 2861 2c20 615f 6772 6164  t_grad(a, a_grad
+00006280: 290a 0a20 2020 2072 6574 7572 6e20 6677  )..    return fw
+00006290: 640a 0a0a 7265 6769 7374 6572 5f67 7261  d...register_gra
+000062a0: 6428 7069 6473 2e52 4553 4841 5045 2c20  d(pids.RESHAPE, 
+000062b0: 5f72 6573 6861 7065 5f70 7269 6d5f 6772  _reshape_prim_gr
+000062c0: 6164 290a 0a0a 4074 6f72 6368 6374 780a  ad)...@torchctx.
+000062d0: 6465 6620 5f73 6c69 6365 5f70 7269 6d5f  def _slice_prim_
+000062e0: 6772 6164 280a 2020 2020 613a 2054 656e  grad(.    a: Ten
+000062f0: 736f 7250 726f 7879 2c20 7374 6172 745f  sorProxy, start_
+00006300: 696e 6469 6365 733a 2053 6571 7565 6e63  indices: Sequenc
+00006310: 655b 696e 745d 2c20 656e 645f 696e 6469  e[int], end_indi
+00006320: 6365 733a 2053 6571 7565 6e63 655b 696e  ces: Sequence[in
+00006330: 745d 2c20 7374 7269 6465 733a 204e 6f6e  t], strides: Non
+00006340: 6520 7c20 5365 7175 656e 6365 5b69 6e74  e | Sequence[int
+00006350: 5d20 3d20 4e6f 6e65 0a29 202d 3e20 5465  ] = None.) -> Te
+00006360: 6e73 6f72 5072 6f78 793a 0a20 2020 2066  nsorProxy:.    f
+00006370: 7764 203d 2070 7269 6d73 2e73 6c69 6365  wd = prims.slice
+00006380: 5f70 7269 6d28 612c 2073 7461 7274 5f69  _prim(a, start_i
+00006390: 6e64 6963 6573 2c20 656e 645f 696e 6469  ndices, end_indi
+000063a0: 6365 732c 2073 7472 6964 6573 290a 0a20  ces, strides).. 
+000063b0: 2020 2067 203d 2067 6574 5f67 7261 6428     g = get_grad(
+000063c0: 6677 6429 0a0a 2020 2020 7061 6464 696e  fwd)..    paddin
+000063d0: 6720 3d20 4e6f 6e65 0a20 2020 2069 6620  g = None.    if 
+000063e0: 7374 7269 6465 7320 6973 204e 6f6e 6520  strides is None 
+000063f0: 6f72 206e 702e 616c 6c28 6e70 2e65 7175  or np.all(np.equ
+00006400: 616c 2873 7472 6964 6573 2c20 3129 293a  al(strides, 1)):
+00006410: 0a20 2020 2020 2020 2070 6164 6469 6e67  .        padding
+00006420: 203d 2074 7570 6c65 287a 6970 2873 7461   = tuple(zip(sta
+00006430: 7274 5f69 6e64 6963 6573 2c20 6e70 2e73  rt_indices, np.s
+00006440: 7562 7472 6163 7428 612e 7368 6170 652c  ubtract(a.shape,
+00006450: 2065 6e64 5f69 6e64 6963 6573 292c 2028   end_indices), (
+00006460: 302c 2920 2a20 6c65 6e28 7374 6172 745f  0,) * len(start_
+00006470: 696e 6469 6365 7329 2929 0a20 2020 2065  indices))).    e
+00006480: 6c73 653a 0a20 2020 2020 2020 2072 6561  lse:.        rea
+00006490: 6c5f 6c69 6d69 7473 203d 206e 702e 6164  l_limits = np.ad
+000064a0: 6428 0a20 2020 2020 2020 2020 2020 2073  d(.            s
+000064b0: 7461 7274 5f69 6e64 6963 6573 2c0a 2020  tart_indices,.  
+000064c0: 2020 2020 2020 2020 2020 6e70 2e77 6865            np.whe
+000064d0: 7265 286e 702e 6571 7561 6c28 672e 7368  re(np.equal(g.sh
+000064e0: 6170 652c 2030 292c 2030 2c20 6e70 2e61  ape, 0), 0, np.a
+000064f0: 6464 2831 2c20 6e70 2e6d 756c 7469 706c  dd(1, np.multipl
+00006500: 7928 6e70 2e73 7562 7472 6163 7428 672e  y(np.subtract(g.
+00006510: 7368 6170 652c 2031 292c 2073 7472 6964  shape, 1), strid
+00006520: 6573 2929 292c 0a20 2020 2020 2020 2029  es))),.        )
+00006530: 0a20 2020 2020 2020 2070 6164 6469 6e67  .        padding
+00006540: 203d 2074 7570 6c65 287a 6970 2873 7461   = tuple(zip(sta
+00006550: 7274 5f69 6e64 6963 6573 2c20 6e70 2e73  rt_indices, np.s
+00006560: 7562 7472 6163 7428 612e 7368 6170 652c  ubtract(a.shape,
+00006570: 2072 6561 6c5f 6c69 6d69 7473 292c 206e   real_limits), n
+00006580: 702e 7375 6274 7261 6374 2873 7472 6964  p.subtract(strid
+00006590: 6573 2c20 3129 2929 0a0a 2020 2020 2320  es, 1)))..    # 
+000065a0: 436f 6e76 6572 7473 204e 756d 5079 206e  Converts NumPy n
+000065b0: 756d 6265 7273 2074 6f20 5079 7468 6f6e  umbers to Python
+000065c0: 2069 6e74 730a 2020 2020 2320 544f 444f   ints.    # TODO
+000065d0: 2053 686f 756c 6420 7765 2073 7570 706f   Should we suppo
+000065e0: 7274 204e 756d 5079 206e 756d 6265 7273  rt NumPy numbers
+000065f0: 2062 6574 7465 723f 0a20 2020 2070 6164   better?.    pad
+00006600: 6469 6e67 203d 2074 7265 655f 6d61 7028  ding = tree_map(
+00006610: 696e 742c 2070 6164 6469 6e67 290a 2020  int, padding).  
+00006620: 2020 615f 6772 6164 203d 2070 7269 6d73    a_grad = prims
+00006630: 2e70 6164 2867 2c20 636f 6e73 745f 6173  .pad(g, const_as
+00006640: 2830 2c20 672e 6474 7970 6529 2c20 7061  (0, g.dtype), pa
+00006650: 6464 696e 6729 0a20 2020 2070 7574 5f67  dding).    put_g
+00006660: 7261 6428 612c 2061 5f67 7261 6429 0a0a  rad(a, a_grad)..
+00006670: 2020 2020 7265 7475 726e 2066 7764 0a0a      return fwd..
+00006680: 0a72 6567 6973 7465 725f 6772 6164 2870  .register_grad(p
+00006690: 6964 732e 534c 4943 452c 205f 736c 6963  ids.SLICE, _slic
+000066a0: 655f 7072 696d 5f67 7261 6429 0a0a 0a40  e_prim_grad)...@
+000066b0: 746f 7263 6863 7478 0a64 6566 205f 7371  torchctx.def _sq
+000066c0: 7565 657a 655f 7072 696d 5f67 7261 6428  ueeze_prim_grad(
+000066d0: 613a 2054 656e 736f 7250 726f 7879 2c20  a: TensorProxy, 
+000066e0: 2f2c 2064 696d 733a 2074 7570 6c65 5b69  /, dims: tuple[i
+000066f0: 6e74 2c20 2e2e 2e5d 2920 2d3e 2054 656e  nt, ...]) -> Ten
+00006700: 736f 7250 726f 7879 3a0a 2020 2020 6677  sorProxy:.    fw
+00006710: 6420 3d20 7072 696d 732e 7371 7565 657a  d = prims.squeez
+00006720: 6528 612c 2074 7570 6c65 2864 696d 7329  e(a, tuple(dims)
+00006730: 290a 0a20 2020 2067 203d 2067 6574 5f67  )..    g = get_g
+00006740: 7261 6428 6677 6429 0a20 2020 2023 204e  rad(fwd).    # N
+00006750: 4f54 4520 5468 6973 2063 616c 6c73 2063  OTE This calls c
+00006760: 6c61 6e67 2e75 6e73 7175 6565 7a65 2c20  lang.unsqueeze, 
+00006770: 616e 6420 6e6f 7420 746f 7263 682e 756e  and not torch.un
+00006780: 7371 7565 657a 652c 2062 6563 6175 7365  squeeze, because
+00006790: 2074 6f72 6368 2e75 6e73 7175 6565 7a65   torch.unsqueeze
+000067a0: 206f 6e6c 7920 7375 7070 6f72 7473 0a20   only supports. 
+000067b0: 2020 2023 2020 2075 6e73 7175 6565 7a69     #   unsqueezi
+000067c0: 6e67 2061 2073 696e 676c 6520 6469 6d65  ng a single dime
+000067d0: 6e73 696f 6e0a 2020 2020 615f 6772 6164  nsion.    a_grad
+000067e0: 203d 2063 6c61 6e67 2e75 6e73 7175 6565   = clang.unsquee
+000067f0: 7a65 2867 2c20 6469 6d73 290a 2020 2020  ze(g, dims).    
+00006800: 7075 745f 6772 6164 2861 2c20 615f 6772  put_grad(a, a_gr
+00006810: 6164 290a 0a20 2020 2072 6574 7572 6e20  ad)..    return 
+00006820: 6677 640a 0a0a 7265 6769 7374 6572 5f67  fwd...register_g
+00006830: 7261 6428 7069 6473 2e53 5155 4545 5a45  rad(pids.SQUEEZE
+00006840: 2c20 5f73 7175 6565 7a65 5f70 7269 6d5f  , _squeeze_prim_
+00006850: 6772 6164 290a 0a0a 4074 6f72 6368 6374  grad)...@torchct
+00006860: 780a 6465 6620 5f74 616b 655f 7072 696d  x.def _take_prim
+00006870: 5f67 7261 6428 613a 2054 656e 736f 7250  _grad(a: TensorP
+00006880: 726f 7879 2c20 696e 6465 783a 2054 656e  roxy, index: Ten
+00006890: 736f 7250 726f 7879 2c20 6469 6d3a 2069  sorProxy, dim: i
+000068a0: 6e74 2920 2d3e 2054 656e 736f 7250 726f  nt) -> TensorPro
+000068b0: 7879 3a0a 2020 2020 6677 6420 3d20 7072  xy:.    fwd = pr
+000068c0: 696d 732e 7461 6b65 2861 2c20 696e 6465  ims.take(a, inde
+000068d0: 782c 2064 696d 290a 0a20 2020 2067 203d  x, dim)..    g =
+000068e0: 2067 6574 5f67 7261 6428 6677 6429 0a0a   get_grad(fwd)..
+000068f0: 2020 2020 2320 544f 444f 2053 7769 7463      # TODO Switc
+00006900: 6820 746f 206c 746f 7263 682e 696e 6465  h to ltorch.inde
+00006910: 785f 6164 643f 0a20 2020 2023 204e 4f54  x_add?.    # NOT
+00006920: 4520 496e 7465 6e74 696f 6e61 6c6c 7920  E Intentionally 
+00006930: 6e6f 7420 6361 6c6c 696e 6720 7a65 726f  not calling zero
+00006940: 735f 6c69 6b65 2074 6f20 6176 6f69 6420  s_like to avoid 
+00006950: 7072 6573 6572 7669 6e67 2061 0a20 2020  preserving a.   
+00006960: 2023 2054 4f44 4f20 5570 6461 7465 2074   # TODO Update t
+00006970: 6f20 6361 6c6c 206c 746f 7263 682e 7a65  o call ltorch.ze
+00006980: 726f 730a 2020 2020 7a65 726f 7320 3d20  ros.    zeros = 
+00006990: 7072 696d 732e 6675 6c6c 2861 2e73 6861  prims.full(a.sha
+000069a0: 7065 2c20 6669 6c6c 5f76 616c 7565 3d30  pe, fill_value=0
+000069b0: 2c20 6465 7669 6365 3d61 2e64 6576 6963  , device=a.devic
+000069c0: 652c 2064 7479 7065 3d61 2e64 7479 7065  e, dtype=a.dtype
+000069d0: 290a 2020 2020 615f 6772 6164 203d 2070  ).    a_grad = p
+000069e0: 7269 6d73 2e69 6e64 6578 5f61 6464 287a  rims.index_add(z
+000069f0: 6572 6f73 2c20 696e 6465 782c 2067 2c20  eros, index, g, 
+00006a00: 6469 6d29 0a20 2020 2070 7574 5f67 7261  dim).    put_gra
+00006a10: 6428 612c 2061 5f67 7261 6429 0a0a 2020  d(a, a_grad)..  
+00006a20: 2020 7265 7475 726e 2066 7764 0a0a 0a72    return fwd...r
+00006a30: 6567 6973 7465 725f 6772 6164 2870 6964  egister_grad(pid
+00006a40: 732e 5441 4b45 2c20 5f74 616b 655f 7072  s.TAKE, _take_pr
+00006a50: 696d 5f67 7261 6429 0a0a 0a40 746f 7263  im_grad)...@torc
+00006a60: 6863 7478 0a64 6566 205f 6761 7468 6572  hctx.def _gather
+00006a70: 5f70 7269 6d5f 6772 6164 2861 3a20 5465  _prim_grad(a: Te
+00006a80: 6e73 6f72 5072 6f78 792c 2069 6e64 6578  nsorProxy, index
+00006a90: 3a20 5465 6e73 6f72 5072 6f78 792c 2064  : TensorProxy, d
+00006aa0: 696d 3a20 696e 7429 202d 3e20 5465 6e73  im: int) -> Tens
+00006ab0: 6f72 5072 6f78 793a 0a20 2020 2066 7764  orProxy:.    fwd
+00006ac0: 203d 2070 7269 6d73 2e67 6174 6865 7228   = prims.gather(
+00006ad0: 612c 2069 6e64 6578 2c20 6469 6d29 0a0a  a, index, dim)..
+00006ae0: 2020 2020 6720 3d20 6765 745f 6772 6164      g = get_grad
+00006af0: 2866 7764 290a 2020 2020 2320 4e4f 5445  (fwd).    # NOTE
+00006b00: 2049 6e74 656e 7469 6f6e 616c 6c79 206e   Intentionally n
+00006b10: 6f74 2063 616c 6c69 6e67 207a 6572 6f73  ot calling zeros
+00006b20: 5f6c 696b 6520 746f 2061 766f 6964 2070  _like to avoid p
+00006b30: 7265 7365 7276 696e 6720 5465 6e73 6f72  reserving Tensor
+00006b40: 5072 6f78 7920 612e 0a20 2020 2023 2054  Proxy a..    # T
+00006b50: 4f44 4f20 5570 6461 7465 2074 6f20 6361  ODO Update to ca
+00006b60: 6c6c 206c 746f 7263 682e 7a65 726f 730a  ll ltorch.zeros.
+00006b70: 2020 2020 7a65 726f 7320 3d20 7072 696d      zeros = prim
+00006b80: 732e 6675 6c6c 2861 2e73 6861 7065 2c20  s.full(a.shape, 
+00006b90: 6669 6c6c 5f76 616c 7565 3d30 2c20 6465  fill_value=0, de
+00006ba0: 7669 6365 3d61 2e64 6576 6963 652c 2064  vice=a.device, d
+00006bb0: 7479 7065 3d61 2e64 7479 7065 290a 2020  type=a.dtype).  
+00006bc0: 2020 615f 6772 6164 203d 2070 7269 6d73    a_grad = prims
+00006bd0: 2e73 6361 7474 6572 5f61 6464 287a 6572  .scatter_add(zer
+00006be0: 6f73 2c20 696e 6465 782c 2067 2c20 6469  os, index, g, di
+00006bf0: 6d29 0a20 2020 2070 7574 5f67 7261 6428  m).    put_grad(
+00006c00: 612c 2061 5f67 7261 6429 0a0a 2020 2020  a, a_grad)..    
+00006c10: 7265 7475 726e 2066 7764 0a0a 0a72 6567  return fwd...reg
+00006c20: 6973 7465 725f 6772 6164 2870 6964 732e  ister_grad(pids.
+00006c30: 4741 5448 4552 2c20 5f67 6174 6865 725f  GATHER, _gather_
+00006c40: 7072 696d 5f67 7261 6429 0a0a 0a40 746f  prim_grad)...@to
+00006c50: 7263 6863 7478 0a64 6566 205f 7461 6b65  rchctx.def _take
+00006c60: 5f61 6c6f 6e67 5f61 7869 735f 7072 696d  _along_axis_prim
+00006c70: 5f67 7261 6428 613a 2054 656e 736f 7250  _grad(a: TensorP
+00006c80: 726f 7879 2c20 696e 6465 783a 2054 656e  roxy, index: Ten
+00006c90: 736f 7250 726f 7879 2c20 6469 6d3a 2069  sorProxy, dim: i
+00006ca0: 6e74 2920 2d3e 2054 656e 736f 7250 726f  nt) -> TensorPro
+00006cb0: 7879 3a0a 2020 2020 6677 6420 3d20 7072  xy:.    fwd = pr
+00006cc0: 696d 732e 7461 6b65 5f61 6c6f 6e67 5f61  ims.take_along_a
+00006cd0: 7869 7328 612c 2069 6e64 6578 2c20 6469  xis(a, index, di
+00006ce0: 6d29 0a0a 2020 2020 6720 3d20 6765 745f  m)..    g = get_
+00006cf0: 6772 6164 2866 7764 290a 2020 2020 2320  grad(fwd).    # 
+00006d00: 4e4f 5445 2049 6e74 656e 7469 6f6e 616c  NOTE Intentional
+00006d10: 6c79 206e 6f74 2063 616c 6c69 6e67 207a  ly not calling z
+00006d20: 6572 6f73 5f6c 696b 6520 746f 2061 766f  eros_like to avo
+00006d30: 6964 2070 7265 7365 7276 696e 6720 5465  id preserving Te
+00006d40: 6e73 6f72 5072 6f78 7920 612e 0a20 2020  nsorProxy a..   
+00006d50: 2023 2054 4f44 4f20 5570 6461 7465 2074   # TODO Update t
+00006d60: 6f20 6361 6c6c 206c 746f 7263 682e 7a65  o call ltorch.ze
+00006d70: 726f 730a 2020 2020 7a65 726f 7320 3d20  ros.    zeros = 
+00006d80: 7072 696d 732e 6675 6c6c 2861 2e73 6861  prims.full(a.sha
+00006d90: 7065 2c20 6669 6c6c 5f76 616c 7565 3d30  pe, fill_value=0
+00006da0: 2c20 6465 7669 6365 3d61 2e64 6576 6963  , device=a.devic
+00006db0: 652c 2064 7479 7065 3d61 2e64 7479 7065  e, dtype=a.dtype
+00006dc0: 290a 2020 2020 615f 6772 6164 203d 2070  ).    a_grad = p
+00006dd0: 7269 6d73 2e73 6361 7474 6572 5f61 6464  rims.scatter_add
+00006de0: 287a 6572 6f73 2c20 696e 6465 782c 2067  (zeros, index, g
+00006df0: 2c20 6469 6d29 0a20 2020 2070 7574 5f67  , dim).    put_g
+00006e00: 7261 6428 612c 2061 5f67 7261 6429 0a0a  rad(a, a_grad)..
+00006e10: 2020 2020 7265 7475 726e 2066 7764 0a0a      return fwd..
+00006e20: 0a72 6567 6973 7465 725f 6772 6164 2870  .register_grad(p
+00006e30: 6964 732e 5441 4b45 5f41 4c4f 4e47 5f41  ids.TAKE_ALONG_A
+00006e40: 5849 532c 205f 7461 6b65 5f61 6c6f 6e67  XIS, _take_along
+00006e50: 5f61 7869 735f 7072 696d 5f67 7261 6429  _axis_prim_grad)
+00006e60: 0a0a 0a40 746f 7263 6863 7478 0a64 6566  ...@torchctx.def
+00006e70: 205f 7472 616e 7370 6f73 655f 7072 696d   _transpose_prim
+00006e80: 5f67 7261 6428 613a 2054 656e 736f 7250  _grad(a: TensorP
+00006e90: 726f 7879 2c20 7065 726d 7574 6174 696f  roxy, permutatio
+00006ea0: 6e3a 2074 7570 6c65 5b69 6e74 2c20 2e2e  n: tuple[int, ..
+00006eb0: 2e5d 2920 2d3e 2054 656e 736f 7250 726f  .]) -> TensorPro
+00006ec0: 7879 3a0a 2020 2020 6677 6420 3d20 7072  xy:.    fwd = pr
+00006ed0: 696d 732e 7472 616e 7370 6f73 6528 612c  ims.transpose(a,
+00006ee0: 2074 7570 6c65 2870 6572 6d75 7461 7469   tuple(permutati
+00006ef0: 6f6e 2929 0a0a 2020 2020 6720 3d20 6765  on))..    g = ge
+00006f00: 745f 6772 6164 2866 7764 290a 2020 2020  t_grad(fwd).    
+00006f10: 756e 646f 203d 205f 6172 6773 6f72 7428  undo = _argsort(
+00006f20: 7065 726d 7574 6174 696f 6e29 0a20 2020  permutation).   
+00006f30: 2061 5f67 7261 6420 3d20 7072 696d 732e   a_grad = prims.
+00006f40: 7472 616e 7370 6f73 6528 672c 2074 7570  transpose(g, tup
+00006f50: 6c65 2875 6e64 6f29 290a 2020 2020 7075  le(undo)).    pu
+00006f60: 745f 6772 6164 2861 2c20 615f 6772 6164  t_grad(a, a_grad
+00006f70: 290a 0a20 2020 2072 6574 7572 6e20 6677  )..    return fw
+00006f80: 640a 0a0a 7265 6769 7374 6572 5f67 7261  d...register_gra
+00006f90: 6428 7069 6473 2e54 5241 4e53 504f 5345  d(pids.TRANSPOSE
+00006fa0: 2c20 5f74 7261 6e73 706f 7365 5f70 7269  , _transpose_pri
+00006fb0: 6d5f 6772 6164 290a 0a23 0a23 204d 656d  m_grad)..#.# Mem
+00006fc0: 6f72 7920 6c61 796f 7574 206f 7065 7261  ory layout opera
+00006fd0: 746f 7220 6772 6164 730a 230a 0a0a 4074  tor grads.#...@t
+00006fe0: 6f72 6368 6374 780a 6465 6620 5f73 7472  orchctx.def _str
+00006ff0: 6964 655f 6f72 6465 725f 7072 696d 5f67  ide_order_prim_g
+00007000: 7261 6428 613a 2054 656e 736f 7250 726f  rad(a: TensorPro
+00007010: 7879 2c20 2f2c 206f 7264 6572 3a20 5365  xy, /, order: Se
+00007020: 7175 656e 6365 5b69 6e74 5d29 202d 3e20  quence[int]) -> 
+00007030: 5465 6e73 6f72 5072 6f78 793a 0a20 2020  TensorProxy:.   
+00007040: 2066 7764 203d 2070 7269 6d73 2e73 7472   fwd = prims.str
+00007050: 6964 655f 6f72 6465 7228 612c 206f 7264  ide_order(a, ord
+00007060: 6572 290a 0a20 2020 2067 203d 2067 6574  er)..    g = get
+00007070: 5f67 7261 6428 6677 6429 0a20 2020 2070  _grad(fwd).    p
+00007080: 7574 5f67 7261 6428 612c 2067 290a 0a20  ut_grad(a, g).. 
+00007090: 2020 2072 6574 7572 6e20 6677 640a 0a0a     return fwd...
+000070a0: 7265 6769 7374 6572 5f67 7261 6428 7069  register_grad(pi
+000070b0: 6473 2e53 5452 4944 455f 4f52 4445 522c  ds.STRIDE_ORDER,
+000070c0: 205f 7374 7269 6465 5f6f 7264 6572 5f70   _stride_order_p
+000070d0: 7269 6d5f 6772 6164 290a 0a0a 230a 2320  rim_grad)...#.# 
+000070e0: 456c 656d 656e 7477 6973 6520 756e 6172  Elementwise unar
+000070f0: 7920 6f70 6572 6174 6f72 2067 7261 6473  y operator grads
+00007100: 0a23 0a40 746f 7263 6863 7478 0a64 6566  .#.@torchctx.def
+00007110: 205f 6162 735f 7072 696d 5f67 7261 6428   _abs_prim_grad(
+00007120: 613a 204e 756d 6265 7220 7c20 5465 6e73  a: Number | Tens
+00007130: 6f72 5072 6f78 7929 202d 3e20 4e75 6d62  orProxy) -> Numb
+00007140: 6572 207c 2054 656e 736f 7250 726f 7879  er | TensorProxy
+00007150: 3a0a 2020 2020 6677 6420 3d20 7072 696d  :.    fwd = prim
+00007160: 732e 6162 7328 6129 0a0a 2020 2020 6720  s.abs(a)..    g 
+00007170: 3d20 6765 745f 6772 6164 2866 7764 290a  = get_grad(fwd).
+00007180: 2020 2020 7075 745f 6772 6164 2861 2c20      put_grad(a, 
+00007190: 6720 2a20 6c74 6f72 6368 2e73 6967 6e28  g * ltorch.sign(
+000071a0: 6129 290a 0a20 2020 2072 6574 7572 6e20  a))..    return 
+000071b0: 6677 640a 0a0a 7265 6769 7374 6572 5f67  fwd...register_g
+000071c0: 7261 6428 7069 6473 2e41 4253 2c20 5f61  rad(pids.ABS, _a
+000071d0: 6273 5f70 7269 6d5f 6772 6164 290a 0a0a  bs_prim_grad)...
+000071e0: 6465 6620 5f63 6f73 5f70 7269 6d5f 6772  def _cos_prim_gr
+000071f0: 6164 2861 3a20 4e75 6d62 6572 207c 2054  ad(a: Number | T
+00007200: 656e 736f 7250 726f 7879 2920 2d3e 204e  ensorProxy) -> N
+00007210: 756d 6265 7220 7c20 5465 6e73 6f72 5072  umber | TensorPr
+00007220: 6f78 793a 0a20 2020 2066 7764 203d 2070  oxy:.    fwd = p
+00007230: 7269 6d73 2e63 6f73 2861 290a 0a20 2020  rims.cos(a)..   
+00007240: 2067 203d 2067 6574 5f67 7261 6428 6677   g = get_grad(fw
+00007250: 6429 0a20 2020 2070 7574 5f67 7261 6428  d).    put_grad(
+00007260: 612c 2067 202a 2028 2d70 7269 6d73 2e73  a, g * (-prims.s
+00007270: 696e 2861 2929 290a 0a20 2020 2072 6574  in(a)))..    ret
+00007280: 7572 6e20 6677 640a 0a0a 7265 6769 7374  urn fwd...regist
+00007290: 6572 5f67 7261 6428 7069 6473 2e43 4f53  er_grad(pids.COS
+000072a0: 2c20 5f63 6f73 5f70 7269 6d5f 6772 6164  , _cos_prim_grad
+000072b0: 290a 0a0a 4074 6f72 6368 6374 780a 6465  )...@torchctx.de
+000072c0: 6620 5f65 7266 5f70 7269 6d5f 6772 6164  f _erf_prim_grad
+000072d0: 2861 3a20 4e75 6d62 6572 207c 2054 656e  (a: Number | Ten
+000072e0: 736f 7250 726f 7879 2920 2d3e 204e 756d  sorProxy) -> Num
+000072f0: 6265 7220 7c20 5465 6e73 6f72 5072 6f78  ber | TensorProx
+00007300: 793a 0a20 2020 2066 7764 203d 2070 7269  y:.    fwd = pri
+00007310: 6d73 2e65 7266 2861 290a 0a20 2020 2067  ms.erf(a)..    g
+00007320: 203d 2067 6574 5f67 7261 6428 6677 6429   = get_grad(fwd)
+00007330: 0a20 2020 2061 5f67 7261 6420 3d20 3220  .    a_grad = 2 
+00007340: 2f20 6d61 7468 2e73 7172 7428 6d61 7468  / math.sqrt(math
+00007350: 2e70 6929 202a 206c 746f 7263 682e 6578  .pi) * ltorch.ex
+00007360: 7028 2d28 612a 2a32 2929 202a 2067 0a20  p(-(a**2)) * g. 
+00007370: 2020 2070 7574 5f67 7261 6428 612c 2061     put_grad(a, a
+00007380: 5f67 7261 6429 0a0a 2020 2020 7265 7475  _grad)..    retu
+00007390: 726e 2066 7764 0a0a 0a72 6567 6973 7465  rn fwd...registe
+000073a0: 725f 6772 6164 2870 6964 732e 4552 462c  r_grad(pids.ERF,
+000073b0: 205f 6572 665f 7072 696d 5f67 7261 6429   _erf_prim_grad)
+000073c0: 0a0a 0a40 746f 7263 6863 7478 0a64 6566  ...@torchctx.def
+000073d0: 205f 6578 705f 7072 696d 5f67 7261 6428   _exp_prim_grad(
+000073e0: 613a 204e 756d 6265 7220 7c20 5465 6e73  a: Number | Tens
+000073f0: 6f72 5072 6f78 7929 202d 3e20 4e75 6d62  orProxy) -> Numb
+00007400: 6572 207c 2054 656e 736f 7250 726f 7879  er | TensorProxy
+00007410: 3a0a 2020 2020 6677 6420 3d20 7072 696d  :.    fwd = prim
+00007420: 732e 6578 7028 6129 0a0a 2020 2020 6720  s.exp(a)..    g 
+00007430: 3d20 6765 745f 6772 6164 2866 7764 290a  = get_grad(fwd).
+00007440: 2020 2020 615f 6772 6164 203d 2067 202a      a_grad = g *
+00007450: 2066 7764 0a20 2020 2070 7574 5f67 7261   fwd.    put_gra
+00007460: 6428 612c 2061 5f67 7261 6429 0a0a 2020  d(a, a_grad)..  
+00007470: 2020 7265 7475 726e 2066 7764 0a0a 0a72    return fwd...r
+00007480: 6567 6973 7465 725f 6772 6164 2870 6964  egister_grad(pid
+00007490: 732e 4558 502c 205f 6578 705f 7072 696d  s.EXP, _exp_prim
+000074a0: 5f67 7261 6429 0a0a 0a40 746f 7263 6863  _grad)...@torchc
+000074b0: 7478 0a64 6566 205f 6c6f 675f 7072 696d  tx.def _log_prim
+000074c0: 5f67 7261 6428 613a 204e 756d 6265 7220  _grad(a: Number 
+000074d0: 7c20 5465 6e73 6f72 5072 6f78 7929 202d  | TensorProxy) -
+000074e0: 3e20 4e75 6d62 6572 207c 2054 656e 736f  > Number | Tenso
+000074f0: 7250 726f 7879 3a0a 2020 2020 6677 6420  rProxy:.    fwd 
+00007500: 3d20 7072 696d 732e 6c6f 6728 6129 0a0a  = prims.log(a)..
+00007510: 2020 2020 6720 3d20 6765 745f 6772 6164      g = get_grad
+00007520: 2866 7764 290a 2020 2020 615f 6772 6164  (fwd).    a_grad
+00007530: 203d 2067 202f 2061 0a20 2020 2070 7574   = g / a.    put
+00007540: 5f67 7261 6428 612c 2061 5f67 7261 6429  _grad(a, a_grad)
+00007550: 0a0a 2020 2020 7265 7475 726e 2066 7764  ..    return fwd
+00007560: 0a0a 0a72 6567 6973 7465 725f 6772 6164  ...register_grad
+00007570: 2870 6964 732e 4c4f 472c 205f 6c6f 675f  (pids.LOG, _log_
+00007580: 7072 696d 5f67 7261 6429 0a0a 0a40 746f  prim_grad)...@to
+00007590: 7263 6863 7478 0a64 6566 205f 6e65 675f  rchctx.def _neg_
+000075a0: 7072 696d 5f67 7261 6428 613a 204e 756d  prim_grad(a: Num
+000075b0: 6265 7220 7c20 5465 6e73 6f72 5072 6f78  ber | TensorProx
+000075c0: 7929 202d 3e20 4e75 6d62 6572 207c 2054  y) -> Number | T
+000075d0: 656e 736f 7250 726f 7879 3a0a 2020 2020  ensorProxy:.    
+000075e0: 6677 6420 3d20 7072 696d 732e 6e65 6728  fwd = prims.neg(
+000075f0: 6129 0a0a 2020 2020 6720 3d20 6765 745f  a)..    g = get_
+00007600: 6772 6164 2866 7764 290a 2020 2020 7075  grad(fwd).    pu
+00007610: 745f 6772 6164 2861 2c20 2d67 290a 0a20  t_grad(a, -g).. 
+00007620: 2020 2072 6574 7572 6e20 6677 640a 0a0a     return fwd...
+00007630: 7265 6769 7374 6572 5f67 7261 6428 7069  register_grad(pi
+00007640: 6473 2e4e 4547 2c20 5f6e 6567 5f70 7269  ds.NEG, _neg_pri
+00007650: 6d5f 6772 6164 290a 0a0a 4074 6f72 6368  m_grad)...@torch
+00007660: 6374 780a 6465 6620 5f72 7371 7274 5f70  ctx.def _rsqrt_p
+00007670: 7269 6d5f 6772 6164 2861 3a20 4e75 6d62  rim_grad(a: Numb
+00007680: 6572 207c 2054 656e 736f 7250 726f 7879  er | TensorProxy
+00007690: 2c20 2f29 202d 3e20 4e75 6d62 6572 207c  , /) -> Number |
+000076a0: 2054 656e 736f 7250 726f 7879 3a0a 2020   TensorProxy:.  
+000076b0: 2020 6677 6420 3d20 7072 696d 732e 7273    fwd = prims.rs
+000076c0: 7172 7428 6129 0a0a 2020 2020 6720 3d20  qrt(a)..    g = 
+000076d0: 6765 745f 6772 6164 2866 7764 290a 2020  get_grad(fwd).  
+000076e0: 2020 2320 416e 2061 6c74 6572 6e61 7469    # An alternati
+000076f0: 7665 2064 6572 6976 6174 696f 6e20 7573  ve derivation us
+00007700: 6564 2062 7920 4a41 5820 6973 202d 302e  ed by JAX is -0.
+00007710: 3520 2a20 6720 2a20 7273 7172 7428 7829  5 * g * rsqrt(x)
+00007720: 202f 2078 0a20 2020 2023 2077 6865 7265   / x.    # where
+00007730: 2072 7371 7274 2878 2920 616e 6420 7820   rsqrt(x) and x 
+00007740: 6172 6520 7361 7665 6420 666f 7220 7468  are saved for th
+00007750: 6520 6261 636b 7761 7264 7320 7061 7373  e backwards pass
+00007760: 2e0a 2020 2020 2320 5468 6973 2064 6572  ..    # This der
+00007770: 6976 6174 696f 6e20 7761 7320 7365 6c65  ivation was sele
+00007780: 6374 6564 2062 6563 6175 7365 2069 7420  cted because it 
+00007790: 6176 6f69 6473 2073 6176 696e 6720 7468  avoids saving th
+000077a0: 6520 696e 7075 7420 7465 6e73 6f72 2e0a  e input tensor..
+000077b0: 2020 2020 615f 6772 6164 203d 202d 302e      a_grad = -0.
+000077c0: 3520 2a20 6720 2a20 6677 642a 2a33 2e30  5 * g * fwd**3.0
+000077d0: 0a20 2020 2070 7574 5f67 7261 6428 612c  .    put_grad(a,
+000077e0: 2061 5f67 7261 6429 0a0a 2020 2020 7265   a_grad)..    re
+000077f0: 7475 726e 2066 7764 0a0a 0a72 6567 6973  turn fwd...regis
+00007800: 7465 725f 6772 6164 2870 6964 732e 5253  ter_grad(pids.RS
+00007810: 5152 542c 205f 7273 7172 745f 7072 696d  QRT, _rsqrt_prim
+00007820: 5f67 7261 6429 0a0a 0a64 6566 205f 7369  _grad)...def _si
+00007830: 6e5f 7072 696d 5f67 7261 6428 613a 204e  n_prim_grad(a: N
+00007840: 756d 6265 7220 7c20 5465 6e73 6f72 5072  umber | TensorPr
+00007850: 6f78 7929 202d 3e20 4e75 6d62 6572 207c  oxy) -> Number |
+00007860: 2054 656e 736f 7250 726f 7879 3a0a 2020   TensorProxy:.  
+00007870: 2020 6677 6420 3d20 7072 696d 732e 7369    fwd = prims.si
+00007880: 6e28 6129 0a0a 2020 2020 6720 3d20 6765  n(a)..    g = ge
+00007890: 745f 6772 6164 2866 7764 290a 2020 2020  t_grad(fwd).    
+000078a0: 7075 745f 6772 6164 2861 2c20 6720 2a20  put_grad(a, g * 
+000078b0: 7072 696d 732e 636f 7328 6129 290a 0a20  prims.cos(a)).. 
+000078c0: 2020 2072 6574 7572 6e20 6677 640a 0a0a     return fwd...
+000078d0: 7265 6769 7374 6572 5f67 7261 6428 7069  register_grad(pi
+000078e0: 6473 2e53 494e 2c20 5f73 696e 5f70 7269  ds.SIN, _sin_pri
+000078f0: 6d5f 6772 6164 290a 0a0a 4074 6f72 6368  m_grad)...@torch
+00007900: 6374 780a 6465 6620 5f74 616e 685f 7072  ctx.def _tanh_pr
+00007910: 696d 5f67 7261 6428 613a 204e 756d 6265  im_grad(a: Numbe
+00007920: 7220 7c20 5465 6e73 6f72 5072 6f78 792c  r | TensorProxy,
+00007930: 202f 2920 2d3e 204e 756d 6265 7220 7c20   /) -> Number | 
+00007940: 5465 6e73 6f72 5072 6f78 793a 0a20 2020  TensorProxy:.   
+00007950: 2066 7764 203d 2070 7269 6d73 2e74 616e   fwd = prims.tan
+00007960: 6828 6129 0a0a 2020 2020 6720 3d20 6765  h(a)..    g = ge
+00007970: 745f 6772 6164 2866 7764 290a 2020 2020  t_grad(fwd).    
+00007980: 615f 6772 6164 203d 2067 202a 2028 3120  a_grad = g * (1 
+00007990: 2d20 6677 6420 2a20 6677 6429 0a20 2020  - fwd * fwd).   
+000079a0: 2070 7574 5f67 7261 6428 612c 2061 5f67   put_grad(a, a_g
+000079b0: 7261 6429 0a0a 2020 2020 7265 7475 726e  rad)..    return
+000079c0: 2066 7764 0a0a 0a72 6567 6973 7465 725f   fwd...register_
+000079d0: 6772 6164 2870 6964 732e 5441 4e48 2c20  grad(pids.TANH, 
+000079e0: 5f74 616e 685f 7072 696d 5f67 7261 6429  _tanh_prim_grad)
+000079f0: 0a0a 230a 2320 456c 656d 656e 7477 6973  ..#.# Elementwis
+00007a00: 6520 6269 6e61 7279 206f 7065 7261 746f  e binary operato
+00007a10: 7220 6772 6164 730a 230a 0a0a 4074 6f72  r grads.#...@tor
+00007a20: 6368 6374 780a 6465 6620 5f61 6464 5f70  chctx.def _add_p
+00007a30: 7269 6d5f 6772 6164 2861 3a20 4e75 6d62  rim_grad(a: Numb
+00007a40: 6572 207c 2054 656e 736f 7250 726f 7879  er | TensorProxy
+00007a50: 2c20 623a 204e 756d 6265 7220 7c20 5465  , b: Number | Te
+00007a60: 6e73 6f72 5072 6f78 792c 202f 2920 2d3e  nsorProxy, /) ->
+00007a70: 204e 756d 6265 7220 7c20 5465 6e73 6f72   Number | Tensor
+00007a80: 5072 6f78 793a 0a20 2020 2066 7764 203d  Proxy:.    fwd =
+00007a90: 2061 202b 2062 0a0a 2020 2020 6720 3d20   a + b..    g = 
+00007aa0: 6765 745f 6772 6164 2866 7764 290a 2020  get_grad(fwd).  
+00007ab0: 2020 615f 6772 6164 203d 2067 0a20 2020    a_grad = g.   
+00007ac0: 2062 5f67 7261 6420 3d20 670a 2020 2020   b_grad = g.    
+00007ad0: 7075 745f 6772 6164 7328 2861 2c20 6229  put_grads((a, b)
+00007ae0: 2c20 2861 5f67 7261 642c 2062 5f67 7261  , (a_grad, b_gra
+00007af0: 6429 290a 0a20 2020 2072 6574 7572 6e20  d))..    return 
+00007b00: 6677 640a 0a0a 7265 6769 7374 6572 5f67  fwd...register_g
+00007b10: 7261 6428 7069 6473 2e41 4444 2c20 5f61  rad(pids.ADD, _a
+00007b20: 6464 5f70 7269 6d5f 6772 6164 290a 0a0a  dd_prim_grad)...
+00007b30: 2320 4e4f 5445 2054 6865 2066 6f6c 6c6f  # NOTE The follo
+00007b40: 7769 6e67 2067 7261 6420 6465 6669 6e69  wing grad defini
+00007b50: 7469 6f6e 2072 656c 6965 7320 6f6e 2074  tion relies on t
+00007b60: 6865 2066 6163 7420 7468 6174 206f 6e6c  he fact that onl
+00007b70: 7920 696e 6578 6163 7420 6474 7970 6573  y inexact dtypes
+00007b80: 2061 7265 2064 6966 6665 7265 6e74 6961   are differentia
+00007b90: 626c 652c 0a23 2020 2061 6e64 2074 6f72  ble,.#   and tor
+00007ba0: 6368 2773 2074 7275 6520 6469 7669 7369  ch's true divisi
+00007bb0: 6f6e 206f 7065 7261 746f 7220 616e 6420  on operator and 
+00007bc0: 7468 6520 6469 7669 7369 6f6e 2070 7269  the division pri
+00007bd0: 6d69 7469 7665 2061 6772 6565 206f 6e20  mitive agree on 
+00007be0: 7468 6f73 6520 7479 7065 730a 4074 6f72  those types.@tor
+00007bf0: 6368 6374 780a 6465 6620 5f64 6976 5f70  chctx.def _div_p
+00007c00: 7269 6d5f 6772 6164 2861 3a20 4e75 6d62  rim_grad(a: Numb
+00007c10: 6572 207c 2054 656e 736f 7250 726f 7879  er | TensorProxy
+00007c20: 2c20 623a 204e 756d 6265 7220 7c20 5465  , b: Number | Te
+00007c30: 6e73 6f72 5072 6f78 792c 202f 2920 2d3e  nsorProxy, /) ->
+00007c40: 204e 756d 6265 7220 7c20 5465 6e73 6f72   Number | Tensor
+00007c50: 5072 6f78 793a 0a20 2020 2066 7764 203d  Proxy:.    fwd =
+00007c60: 2061 202f 2062 0a0a 2020 2020 6720 3d20   a / b..    g = 
+00007c70: 6765 745f 6772 6164 2866 7764 290a 2020  get_grad(fwd).  
+00007c80: 2020 615f 6772 6164 203d 2067 202f 2062    a_grad = g / b
+00007c90: 0a20 2020 2062 5f67 7261 6420 3d20 2d67  .    b_grad = -g
+00007ca0: 202a 2028 2861 202f 2062 2920 2f20 6229   * ((a / b) / b)
+00007cb0: 0a20 2020 2070 7574 5f67 7261 6473 2828  .    put_grads((
+00007cc0: 612c 2062 292c 2028 615f 6772 6164 2c20  a, b), (a_grad, 
+00007cd0: 625f 6772 6164 2929 0a0a 2020 2020 7265  b_grad))..    re
+00007ce0: 7475 726e 2066 7764 0a0a 0a72 6567 6973  turn fwd...regis
+00007cf0: 7465 725f 6772 6164 2870 6964 732e 4449  ter_grad(pids.DI
+00007d00: 562c 205f 6469 765f 7072 696d 5f67 7261  V, _div_prim_gra
+00007d10: 6429 0a0a 2320 436f 6d70 6172 6973 6f6e  d)..# Comparison
+00007d20: 206f 7065 7261 746f 7273 202d 2d20 7468   operators -- th
+00007d30: 6573 6520 6372 6561 7465 206e 6f20 6772  ese create no gr
+00007d40: 6164 2061 7373 6f63 6961 7469 6f6e 730a  ad associations.
+00007d50: 7265 6769 7374 6572 5f67 7261 6428 7069  register_grad(pi
+00007d60: 6473 2e45 512c 2070 7269 6d73 2e65 7129  ds.EQ, prims.eq)
+00007d70: 0a72 6567 6973 7465 725f 6772 6164 2870  .register_grad(p
+00007d80: 6964 732e 4745 2c20 7072 696d 732e 6765  ids.GE, prims.ge
+00007d90: 290a 7265 6769 7374 6572 5f67 7261 6428  ).register_grad(
+00007da0: 7069 6473 2e4c 542c 2070 7269 6d73 2e6c  pids.LT, prims.l
+00007db0: 7429 0a72 6567 6973 7465 725f 6772 6164  t).register_grad
+00007dc0: 2870 6964 732e 4e45 2c20 7072 696d 732e  (pids.NE, prims.
+00007dd0: 6e65 290a 7265 6769 7374 6572 5f67 7261  ne).register_gra
+00007de0: 6428 7069 6473 2e47 542c 2070 7269 6d73  d(pids.GT, prims
+00007df0: 2e67 7429 0a72 6567 6973 7465 725f 6772  .gt).register_gr
+00007e00: 6164 2870 6964 732e 4c45 2c20 7072 696d  ad(pids.LE, prim
+00007e10: 732e 6c65 290a 0a0a 4074 6f72 6368 6374  s.le)...@torchct
+00007e20: 780a 6465 6620 5f6d 756c 5f70 7269 6d5f  x.def _mul_prim_
+00007e30: 6772 6164 2861 3a20 4e75 6d62 6572 207c  grad(a: Number |
+00007e40: 2054 656e 736f 7250 726f 7879 2c20 623a   TensorProxy, b:
+00007e50: 204e 756d 6265 7220 7c20 5465 6e73 6f72   Number | Tensor
+00007e60: 5072 6f78 792c 202f 2920 2d3e 204e 756d  Proxy, /) -> Num
+00007e70: 6265 7220 7c20 5465 6e73 6f72 5072 6f78  ber | TensorProx
+00007e80: 793a 0a20 2020 2066 7764 203d 2061 202a  y:.    fwd = a *
+00007e90: 2062 0a0a 2020 2020 6720 3d20 6765 745f   b..    g = get_
+00007ea0: 6772 6164 2866 7764 290a 2020 2020 615f  grad(fwd).    a_
+00007eb0: 6772 6164 203d 2062 202a 2067 0a20 2020  grad = b * g.   
+00007ec0: 2062 5f67 7261 6420 3d20 6120 2a20 670a   b_grad = a * g.
+00007ed0: 2020 2020 7075 745f 6772 6164 7328 2861      put_grads((a
+00007ee0: 2c20 6229 2c20 2861 5f67 7261 642c 2062  , b), (a_grad, b
+00007ef0: 5f67 7261 6429 290a 0a20 2020 2072 6574  _grad))..    ret
+00007f00: 7572 6e20 6677 640a 0a0a 7265 6769 7374  urn fwd...regist
+00007f10: 6572 5f67 7261 6428 7069 6473 2e4d 554c  er_grad(pids.MUL
+00007f20: 2c20 5f6d 756c 5f70 7269 6d5f 6772 6164  , _mul_prim_grad
+00007f30: 290a 0a0a 4074 6f72 6368 6374 780a 6465  )...@torchctx.de
+00007f40: 6620 5f73 7562 5f70 7269 6d5f 6772 6164  f _sub_prim_grad
+00007f50: 2861 3a20 4e75 6d62 6572 207c 2054 656e  (a: Number | Ten
+00007f60: 736f 7250 726f 7879 2c20 623a 204e 756d  sorProxy, b: Num
+00007f70: 6265 7220 7c20 5465 6e73 6f72 5072 6f78  ber | TensorProx
+00007f80: 7929 202d 3e20 4e75 6d62 6572 207c 2054  y) -> Number | T
+00007f90: 656e 736f 7250 726f 7879 3a0a 2020 2020  ensorProxy:.    
+00007fa0: 6677 6420 3d20 6120 2d20 620a 0a20 2020  fwd = a - b..   
+00007fb0: 2067 203d 2067 6574 5f67 7261 6428 6677   g = get_grad(fw
+00007fc0: 6429 0a20 2020 2061 5f67 7261 6420 3d20  d).    a_grad = 
+00007fd0: 670a 2020 2020 625f 6772 6164 203d 202d  g.    b_grad = -
+00007fe0: 670a 2020 2020 7075 745f 6772 6164 7328  g.    put_grads(
+00007ff0: 2861 2c20 6229 2c20 2861 5f67 7261 642c  (a, b), (a_grad,
+00008000: 2062 5f67 7261 6429 290a 0a20 2020 2072   b_grad))..    r
+00008010: 6574 7572 6e20 6677 640a 0a0a 7265 6769  eturn fwd...regi
+00008020: 7374 6572 5f67 7261 6428 7069 6473 2e53  ster_grad(pids.S
+00008030: 5542 2c20 5f73 7562 5f70 7269 6d5f 6772  UB, _sub_prim_gr
+00008040: 6164 290a 0a0a 230a 2320 436f 6e64 6974  ad)...#.# Condit
+00008050: 696f 6e61 6c20 6f70 6572 6174 6f72 2067  ional operator g
+00008060: 7261 6473 0a23 0a0a 0a64 6566 205f 7768  rads.#...def _wh
+00008070: 6572 655f 7072 696d 5f67 7261 6428 7072  ere_prim_grad(pr
+00008080: 6564 3a20 4e75 6d62 6572 207c 2054 656e  ed: Number | Ten
+00008090: 736f 7250 726f 7879 2c20 613a 204e 756d  sorProxy, a: Num
+000080a0: 6265 7220 7c20 5465 6e73 6f72 5072 6f78  ber | TensorProx
+000080b0: 792c 2062 3a20 4e75 6d62 6572 207c 2054  y, b: Number | T
+000080c0: 656e 736f 7250 726f 7879 2920 2d3e 2054  ensorProxy) -> T
+000080d0: 656e 736f 7250 726f 7879 3a0a 2020 2020  ensorProxy:.    
+000080e0: 6677 6420 3d20 7072 696d 732e 7768 6572  fwd = prims.wher
+000080f0: 6528 7072 6564 2c20 612c 2062 290a 0a20  e(pred, a, b).. 
+00008100: 2020 2067 203d 2067 6574 5f67 7261 6428     g = get_grad(
+00008110: 6677 6429 0a20 2020 2061 5f67 7261 6420  fwd).    a_grad 
+00008120: 3d20 6c74 6f72 6368 2e77 6865 7265 2870  = ltorch.where(p
+00008130: 7265 642c 2067 2c20 3029 0a20 2020 2062  red, g, 0).    b
+00008140: 5f67 7261 6420 3d20 6c74 6f72 6368 2e77  _grad = ltorch.w
+00008150: 6865 7265 2870 7265 642c 2030 2c20 6729  here(pred, 0, g)
+00008160: 0a20 2020 2070 7574 5f67 7261 6473 2828  .    put_grads((
+00008170: 612c 2062 292c 2028 615f 6772 6164 2c20  a, b), (a_grad, 
+00008180: 625f 6772 6164 2929 0a0a 2020 2020 7265  b_grad))..    re
+00008190: 7475 726e 2066 7764 0a0a 0a72 6567 6973  turn fwd...regis
+000081a0: 7465 725f 6772 6164 2870 6964 732e 5748  ter_grad(pids.WH
+000081b0: 4552 452c 205f 7768 6572 655f 7072 696d  ERE, _where_prim
+000081c0: 5f67 7261 6429 0a0a 230a 2320 5265 6475  _grad)..#.# Redu
+000081d0: 6374 696f 6e20 6f70 6572 6174 6f72 2067  ction operator g
+000081e0: 7261 6473 0a23 0a0a 0a23 2054 4f44 4f20  rads.#...# TODO 
+000081f0: 5265 7669 6577 2074 7765 616b 696e 6720  Review tweaking 
+00008200: 6772 6164 5f63 686f 6f73 6572 5f70 756c  grad_chooser_pul
+00008210: 6c62 6163 6b20 696e 7465 7266 6163 650a  lback interface.
+00008220: 6465 6620 5f61 6d61 785f 7072 696d 5f67  def _amax_prim_g
+00008230: 7261 6428 613a 2054 656e 736f 7250 726f  rad(a: TensorPro
+00008240: 7879 2c20 2f2c 2064 696d 733a 2053 6571  xy, /, dims: Seq
+00008250: 7565 6e63 655b 696e 745d 2920 2d3e 2054  uence[int]) -> T
+00008260: 656e 736f 7250 726f 7879 3a0a 2020 2020  ensorProxy:.    
+00008270: 6677 6420 3d20 7072 696d 732e 616d 6178  fwd = prims.amax
+00008280: 2861 2c20 6469 6d73 290a 0a20 2020 2067  (a, dims)..    g
+00008290: 203d 2067 6574 5f67 7261 6428 6677 6429   = get_grad(fwd)
+000082a0: 0a20 2020 2061 5f67 7261 6420 3d20 6772  .    a_grad = gr
+000082b0: 6164 5f63 686f 6f73 6572 5f62 6163 6b77  ad_chooser_backw
+000082c0: 6172 6428 6677 642c 2061 2c20 612e 7368  ard(fwd, a, a.sh
+000082d0: 6170 652c 2064 696d 732c 2067 290a 2020  ape, dims, g).  
+000082e0: 2020 7075 745f 6772 6164 2861 2c20 615f    put_grad(a, a_
+000082f0: 6772 6164 290a 0a20 2020 2072 6574 7572  grad)..    retur
+00008300: 6e20 6677 640a 0a0a 7265 6769 7374 6572  n fwd...register
+00008310: 5f67 7261 6428 7069 6473 2e41 4d41 582c  _grad(pids.AMAX,
+00008320: 205f 616d 6178 5f70 7269 6d5f 6772 6164   _amax_prim_grad
+00008330: 290a 0a0a 6465 6620 5f73 756d 5f70 7269  )...def _sum_pri
+00008340: 6d5f 6772 6164 2861 3a20 5465 6e73 6f72  m_grad(a: Tensor
+00008350: 5072 6f78 792c 202f 2c20 6469 6d73 3a20  Proxy, /, dims: 
+00008360: 5365 7175 656e 6365 5b69 6e74 5d29 202d  Sequence[int]) -
+00008370: 3e20 5465 6e73 6f72 5072 6f78 793a 0a20  > TensorProxy:. 
+00008380: 2020 2066 7764 203d 2070 7269 6d73 2e73     fwd = prims.s
+00008390: 756d 2861 2c20 6469 6d73 290a 0a20 2020  um(a, dims)..   
+000083a0: 2067 203d 2067 6574 5f67 7261 6428 6677   g = get_grad(fw
+000083b0: 6429 0a20 2020 2061 5f67 7261 6420 3d20  d).    a_grad = 
+000083c0: 7265 7374 6f72 655f 7265 6475 6365 645f  restore_reduced_
+000083d0: 6469 6d73 2867 2c20 6469 6d73 2c20 612e  dims(g, dims, a.
+000083e0: 7368 6170 6529 0a20 2020 2070 7574 5f67  shape).    put_g
+000083f0: 7261 6428 612c 2061 5f67 7261 6429 0a0a  rad(a, a_grad)..
+00008400: 2020 2020 7265 7475 726e 2066 7764 0a0a      return fwd..
+00008410: 0a72 6567 6973 7465 725f 6772 6164 2870  .register_grad(p
+00008420: 6964 732e 5355 4d2c 205f 7375 6d5f 7072  ids.SUM, _sum_pr
+00008430: 696d 5f67 7261 6429 0a0a 0a40 746f 7263  im_grad)...@torc
+00008440: 6863 7478 0a64 6566 205f 746f 706b 5f70  hctx.def _topk_p
+00008450: 7269 6d5f 6772 6164 280a 2020 2020 613a  rim_grad(.    a:
+00008460: 2054 656e 736f 7250 726f 7879 2c20 2f2c   TensorProxy, /,
+00008470: 206b 3a20 696e 742c 2064 696d 3a20 4e6f   k: int, dim: No
+00008480: 6e65 207c 2069 6e74 203d 204e 6f6e 652c  ne | int = None,
+00008490: 206c 6172 6765 7374 3a20 626f 6f6c 203d   largest: bool =
+000084a0: 2054 7275 652c 2073 6f72 7465 643a 2062   True, sorted: b
+000084b0: 6f6f 6c20 3d20 5472 7565 2c20 2a2c 206f  ool = True, *, o
+000084c0: 7574 3d4e 6f6e 650a 293a 0a20 2020 2066  ut=None.):.    f
+000084d0: 7764 203d 2070 7269 6d73 2e74 6f70 6b28  wd = prims.topk(
+000084e0: 612c 206b 2c20 6469 6d2c 206c 6172 6765  a, k, dim, large
+000084f0: 7374 2c20 736f 7274 6564 2c20 6f75 743d  st, sorted, out=
+00008500: 6f75 7429 0a20 2020 2076 616c 2c20 6964  out).    val, id
+00008510: 7820 3d20 6677 640a 0a20 2020 2076 616c  x = fwd..    val
+00008520: 5f67 7261 6420 3d20 6765 745f 6772 6164  _grad = get_grad
+00008530: 2876 616c 290a 0a20 2020 2061 5f67 7261  (val)..    a_gra
+00008540: 6420 3d20 6c74 6f72 6368 2e7a 6572 6f73  d = ltorch.zeros
+00008550: 5f6c 696b 6528 6129 0a20 2020 2023 2054  _like(a).    # T
+00008560: 4f44 4f3a 2072 6570 6c61 6365 2077 6974  ODO: replace wit
+00008570: 6820 7363 6174 7465 7220 6f6e 6365 2077  h scatter once w
+00008580: 6520 6861 7665 2069 742e 0a20 2020 2023  e have it..    #
+00008590: 2073 6361 7474 6572 5f61 6464 2069 7320   scatter_add is 
+000085a0: 6120 7072 696d 2061 6e64 2069 7420 7265  a prim and it re
+000085b0: 6c69 6573 206f 6e20 6174 6f6d 6963 206f  lies on atomic o
+000085c0: 7073 2e0a 2020 2020 615f 6772 6164 203d  ps..    a_grad =
+000085d0: 206c 746f 7263 682e 7363 6174 7465 725f   ltorch.scatter_
+000085e0: 6164 6428 615f 6772 6164 2c20 6469 6d2c  add(a_grad, dim,
+000085f0: 2069 6478 2c20 7661 6c5f 6772 6164 290a   idx, val_grad).
+00008600: 2020 2020 7075 745f 6772 6164 2861 2c20      put_grad(a, 
+00008610: 615f 6772 6164 290a 0a20 2020 2072 6574  a_grad)..    ret
+00008620: 7572 6e20 6677 640a 0a0a 7265 6769 7374  urn fwd...regist
+00008630: 6572 5f67 7261 6428 7069 6473 2e54 4f50  er_grad(pids.TOP
+00008640: 4b2c 205f 746f 706b 5f70 7269 6d5f 6772  K, _topk_prim_gr
+00008650: 6164 290a 0a0a 2320 544f 444f 2046 6978  ad)...# TODO Fix
+00008660: 2064 6976 6973 696f 6e20 6279 207a 6572   division by zer
+00008670: 6f20 7768 656e 206e 5f65 6c65 6d5f 7265  o when n_elem_re
+00008680: 6475 6365 6420 3d3d 2030 206f 7220 7768  duced == 0 or wh
+00008690: 656e 206d 6561 6e2e 6e75 6d65 6c20 3d3d  en mean.numel ==
+000086a0: 2030 0a23 2020 2062 7920 7265 7475 726e   0.#   by return
+000086b0: 696e 6720 7a65 726f 735f 6c69 6b65 2861  ing zeros_like(a
+000086c0: 2920 6f72 2073 696d 696c 6172 2e0a 2320  ) or similar..# 
+000086d0: 544f 444f 2046 6978 2067 7261 6420 7768  TODO Fix grad wh
+000086e0: 656e 2063 6f72 7265 6374 696f 6e20 3e20  en correction > 
+000086f0: 6e5f 656c 656d 5f72 6564 7563 6564 2e0a  n_elem_reduced..
+00008700: 4074 6f72 6368 6374 780a 6465 6620 5f76  @torchctx.def _v
+00008710: 6172 5f6d 6561 6e5f 7072 696d 5f67 7261  ar_mean_prim_gra
+00008720: 6428 613a 2054 656e 736f 7250 726f 7879  d(a: TensorProxy
+00008730: 2c20 2f2c 2064 696d 733a 2053 6571 7565  , /, dims: Seque
+00008740: 6e63 655b 696e 745d 2c20 2a2c 2063 6f72  nce[int], *, cor
+00008750: 7265 6374 696f 6e3a 204e 756d 6265 7229  rection: Number)
+00008760: 202d 3e20 5465 6e73 6f72 5072 6f78 793a   -> TensorProxy:
+00008770: 0a20 2020 2076 2c20 6d20 3d20 7072 696d  .    v, m = prim
+00008780: 732e 7661 725f 6d65 616e 2861 2c20 6469  s.var_mean(a, di
+00008790: 6d73 2c20 636f 7272 6563 7469 6f6e 3d63  ms, correction=c
+000087a0: 6f72 7265 6374 696f 6e29 0a0a 2020 2020  orrection)..    
+000087b0: 6776 203d 2067 6574 5f67 7261 6428 7629  gv = get_grad(v)
+000087c0: 0a20 2020 2067 6d20 3d20 6765 745f 6772  .    gm = get_gr
+000087d0: 6164 286d 290a 0a20 2020 206e 5f65 6c65  ad(m)..    n_ele
+000087e0: 6d5f 7265 6475 6365 6420 3d20 612e 6e75  m_reduced = a.nu
+000087f0: 6d65 6c20 2f2f 206d 2e6e 756d 656c 2069  mel // m.numel i
+00008800: 6620 612e 6e75 6d65 6c20 213d 2030 2065  f a.numel != 0 e
+00008810: 6c73 6520 310a 0a20 2020 2023 2043 6f6d  lse 1..    # Com
+00008820: 7075 7465 7320 6d65 616e 2062 7764 0a20  putes mean bwd. 
+00008830: 2020 206d 6561 6e5f 7363 616c 6520 3d20     mean_scale = 
+00008840: 312e 3020 2f20 6e5f 656c 656d 5f72 6564  1.0 / n_elem_red
+00008850: 7563 6564 0a20 2020 206d 6561 6e5f 6772  uced.    mean_gr
+00008860: 6164 203d 206d 6561 6e5f 7363 616c 6520  ad = mean_scale 
+00008870: 2a20 7265 7374 6f72 655f 7265 6475 6365  * restore_reduce
+00008880: 645f 6469 6d73 2867 6d2c 2064 696d 732c  d_dims(gm, dims,
+00008890: 2061 2e73 6861 7065 290a 0a20 2020 2023   a.shape)..    #
+000088a0: 2043 6f6d 7075 7465 7320 7661 7220 6277   Computes var bw
+000088b0: 640a 2020 2020 6e6f 726d 616c 697a 6174  d.    normalizat
+000088c0: 696f 6e5f 7363 616c 6172 203d 206e 5f65  ion_scalar = n_e
+000088d0: 6c65 6d5f 7265 6475 6365 6420 2d20 636f  lem_reduced - co
+000088e0: 7272 6563 7469 6f6e 0a20 2020 2072 6573  rrection.    res
+000088f0: 746f 7265 645f 6776 203d 2072 6573 746f  tored_gv = resto
+00008900: 7265 5f72 6564 7563 6564 5f64 696d 7328  re_reduced_dims(
+00008910: 6776 2c20 6469 6d73 2c20 612e 7368 6170  gv, dims, a.shap
+00008920: 6529 0a20 2020 2023 2049 6e73 6572 7469  e).    # Inserti
+00008930: 6e67 2061 2063 6f6e 7665 7273 696f 6e20  ng a conversion 
+00008940: 746f 2074 6865 2073 616d 6520 6474 7970  to the same dtyp
+00008950: 6520 746f 2064 6973 6162 6c65 206e 7646  e to disable nvF
+00008960: 7573 6572 2065 7865 6375 746f 7273 2773  user executors's
+00008970: 0a20 2020 2023 2062 6f6f 6b65 6e64 206f  .    # bookend o
+00008980: 7074 696d 697a 6174 696f 6e20 286e 765f  ptimization (nv_
+00008990: 656e 6162 6c65 5f62 6f6f 6b65 6e64 292c  enable_bookend),
+000089a0: 2077 6869 6368 2063 616e 2063 6175 7365   which can cause
+000089b0: 2074 6865 2062 6163 6b77 6172 640a 2020   the backward.  
+000089c0: 2020 2320 7061 7373 2074 6f20 6765 6e65    # pass to gene
+000089d0: 7261 7465 2074 776f 206b 6572 6e65 6c73  rate two kernels
+000089e0: 0a20 2020 206d 6561 6e5f 6d64 7479 7065  .    mean_mdtype
+000089f0: 203d 2070 7269 6d73 2e63 6f6e 7665 7274   = prims.convert
+00008a00: 5f65 6c65 6d65 6e74 5f74 7970 6528 6d2c  _element_type(m,
+00008a10: 206d 2e64 7479 7065 290a 2020 2020 7265   m.dtype).    re
+00008a20: 7374 6f72 6564 5f6d 6561 6e20 3d20 7265  stored_mean = re
+00008a30: 7374 6f72 655f 7265 6475 6365 645f 6469  store_reduced_di
+00008a40: 6d73 286d 6561 6e5f 6d64 7479 7065 2c20  ms(mean_mdtype, 
+00008a50: 6469 6d73 2c20 612e 7368 6170 6529 0a20  dims, a.shape). 
+00008a60: 2020 2076 6172 5f67 7261 6420 3d20 2832     var_grad = (2
+00008a70: 202a 2072 6573 746f 7265 645f 6776 202a   * restored_gv *
+00008a80: 2028 6120 2d20 7265 7374 6f72 6564 5f6d   (a - restored_m
+00008a90: 6561 6e29 2920 2f20 6e6f 726d 616c 697a  ean)) / normaliz
+00008aa0: 6174 696f 6e5f 7363 616c 6172 0a0a 2020  ation_scalar..  
+00008ab0: 2020 7075 745f 6772 6164 2861 2c20 6d65    put_grad(a, me
+00008ac0: 616e 5f67 7261 6420 2b20 7661 725f 6772  an_grad + var_gr
+00008ad0: 6164 290a 0a20 2020 2072 6574 7572 6e20  ad)..    return 
+00008ae0: 762c 206d 0a0a 0a72 6567 6973 7465 725f  v, m...register_
+00008af0: 6772 6164 2870 6964 732e 5641 525f 4d45  grad(pids.VAR_ME
+00008b00: 414e 2c20 5f76 6172 5f6d 6561 6e5f 7072  AN, _var_mean_pr
+00008b10: 696d 5f67 7261 6429 0a0a 0a23 0a23 204c  im_grad)...#.# L
+00008b20: 696e 6561 7220 616c 6765 6272 6120 6f70  inear algebra op
+00008b30: 6572 6174 6f72 2067 7261 6473 0a23 0a40  erator grads.#.@
+00008b40: 746f 7263 6863 7478 0a64 6566 205f 6c69  torchctx.def _li
+00008b50: 6e65 6172 5f70 7269 6d5f 6772 6164 2861  near_prim_grad(a
+00008b60: 3a20 5465 6e73 6f72 5072 6f78 792c 2077  : TensorProxy, w
+00008b70: 3a20 5465 6e73 6f72 5072 6f78 792c 2062  : TensorProxy, b
+00008b80: 6961 733a 204e 6f6e 6520 7c20 5465 6e73  ias: None | Tens
+00008b90: 6f72 5072 6f78 7929 202d 3e20 5465 6e73  orProxy) -> Tens
+00008ba0: 6f72 5072 6f78 793a 0a20 2020 2066 7764  orProxy:.    fwd
+00008bb0: 203d 2070 7269 6d73 2e6c 696e 6561 7228   = prims.linear(
+00008bc0: 612c 2077 2c20 6269 6173 290a 0a20 2020  a, w, bias)..   
+00008bd0: 2067 203d 2067 6574 5f67 7261 6428 6677   g = get_grad(fw
+00008be0: 6429 0a0a 2020 2020 6669 7273 745f 6469  d)..    first_di
+00008bf0: 6d20 3d20 2d32 0a20 2020 2067 7261 645f  m = -2.    grad_
+00008c00: 6120 3d20 6c74 6f72 6368 2e6d 6174 6d75  a = ltorch.matmu
+00008c10: 6c28 672e 7265 7368 6170 6528 2d31 2c20  l(g.reshape(-1, 
+00008c20: 672e 7368 6170 655b 2d31 5d29 2c20 7729  g.shape[-1]), w)
+00008c30: 2e72 6573 6861 7065 2861 2e73 6861 7065  .reshape(a.shape
+00008c40: 290a 0a20 2020 2067 7261 645f 773a 2054  )..    grad_w: T
+00008c50: 656e 736f 7250 726f 7879 0a20 2020 2069  ensorProxy.    i
+00008c60: 6620 612e 6e64 696d 203d 3d20 313a 0a20  f a.ndim == 1:. 
+00008c70: 2020 2020 2020 2067 7261 645f 7720 3d20         grad_w = 
+00008c80: 6c74 6f72 6368 2e6d 6174 6d75 6c28 672e  ltorch.matmul(g.
+00008c90: 756e 7371 7565 657a 6528 6669 7273 745f  unsqueeze(first_
+00008ca0: 6469 6d29 2e6d 542c 2061 2e75 6e73 7175  dim).mT, a.unsqu
+00008cb0: 6565 7a65 2866 6972 7374 5f64 696d 2929  eeze(first_dim))
+00008cc0: 0a20 2020 2065 6c73 653a 0a20 2020 2020  .    else:.     
+00008cd0: 2020 2067 7261 645f 7720 3d20 6c74 6f72     grad_w = ltor
+00008ce0: 6368 2e6d 6174 6d75 6c28 672e 7265 7368  ch.matmul(g.resh
+00008cf0: 6170 6528 2d31 2c20 672e 7368 6170 655b  ape(-1, g.shape[
+00008d00: 2d31 5d29 2e6d 542c 2061 2e72 6573 6861  -1]).mT, a.resha
+00008d10: 7065 282d 312c 2061 2e73 6861 7065 5b2d  pe(-1, a.shape[-
+00008d20: 315d 2929 0a0a 2020 2020 7075 745f 6772  1]))..    put_gr
+00008d30: 6164 7328 2861 2c20 7729 2c20 2867 7261  ads((a, w), (gra
+00008d40: 645f 612c 2067 7261 645f 7729 290a 0a20  d_a, grad_w)).. 
+00008d50: 2020 2069 6620 6269 6173 2069 7320 6e6f     if bias is no
+00008d60: 7420 4e6f 6e65 3a0a 2020 2020 2020 2020  t None:.        
+00008d70: 6966 2067 2e6e 6469 6d20 3e20 313a 0a20  if g.ndim > 1:. 
+00008d80: 2020 2020 2020 2020 2020 2067 7261 645f             grad_
+00008d90: 6269 6173 203d 206c 746f 7263 682e 7375  bias = ltorch.su
+00008da0: 6d28 672c 2074 7570 6c65 2872 616e 6765  m(g, tuple(range
+00008db0: 2867 2e6e 6469 6d20 2d20 3129 2929 0a20  (g.ndim - 1))). 
+00008dc0: 2020 2020 2020 2065 6c73 653a 0a20 2020         else:.   
+00008dd0: 2020 2020 2020 2020 2067 7261 645f 6269           grad_bi
+00008de0: 6173 203d 2067 0a20 2020 2020 2020 2070  as = g.        p
+00008df0: 7574 5f67 7261 6428 6269 6173 2c20 6772  ut_grad(bias, gr
+00008e00: 6164 5f62 6961 7329 0a0a 2020 2020 7265  ad_bias)..    re
+00008e10: 7475 726e 2066 7764 0a0a 0a72 6567 6973  turn fwd...regis
+00008e20: 7465 725f 6772 6164 2870 6964 732e 4c49  ter_grad(pids.LI
+00008e30: 4e45 4152 2c20 5f6c 696e 6561 725f 7072  NEAR, _linear_pr
+00008e40: 696d 5f67 7261 6429 0a0a 0a23 2054 4f44  im_grad)...# TOD
+00008e50: 4f20 4164 6420 6578 706c 6963 6974 206c  O Add explicit l
+00008e60: 746f 7263 6820 7673 2063 6c61 6e67 206d  torch vs clang m
+00008e70: 6f64 756c 6520 746f 2074 6865 2074 656e  odule to the ten
+00008e80: 736f 7220 6f70 6572 6174 696f 6e73 2062  sor operations b
+00008e90: 656c 6f77 0a23 2054 4f44 4f20 636f 756c  elow.# TODO coul
+00008ea0: 6420 7765 2067 6574 2072 6964 206f 6620  d we get rid of 
+00008eb0: 7468 6520 6669 6e61 6c20 7371 7565 657a  the final squeez
+00008ec0: 6573 2069 6e20 7468 6520 622e 6e64 696d  es in the b.ndim
+00008ed0: 203d 3d20 3120 6361 7365 2061 6e64 2074   == 1 case and t
+00008ee0: 6865 2061 2e6e 6469 6d20 3d3d 2031 2063  he a.ndim == 1 c
+00008ef0: 6173 653f 0a40 746f 7263 6863 7478 0a64  ase?.@torchctx.d
+00008f00: 6566 205f 6d61 746d 756c 5f70 7269 6d5f  ef _matmul_prim_
+00008f10: 6772 6164 2861 3a20 5465 6e73 6f72 5072  grad(a: TensorPr
+00008f20: 6f78 792c 2062 3a20 5465 6e73 6f72 5072  oxy, b: TensorPr
+00008f30: 6f78 792c 202f 2920 2d3e 2054 656e 736f  oxy, /) -> Tenso
+00008f40: 7250 726f 7879 3a0a 2020 2020 6677 6420  rProxy:.    fwd 
+00008f50: 3d20 7072 696d 732e 6d61 746d 756c 2861  = prims.matmul(a
+00008f60: 2c20 6229 0a20 2020 2067 203d 2067 6574  , b).    g = get
+00008f70: 5f67 7261 6428 6677 6429 0a0a 2020 2020  _grad(fwd)..    
+00008f80: 6c61 7374 5f64 696d 203d 2028 2d31 2c29  last_dim = (-1,)
+00008f90: 0a20 2020 2066 6972 7374 5f64 696d 203d  .    first_dim =
+00008fa0: 2028 2d32 2c29 0a20 2020 2069 6620 612e   (-2,).    if a.
+00008fb0: 6e64 696d 203d 3d20 3120 616e 6420 622e  ndim == 1 and b.
+00008fc0: 6e64 696d 203d 3d20 313a 0a20 2020 2020  ndim == 1:.     
+00008fd0: 2020 2070 7574 5f67 7261 6473 2828 612c     put_grads((a,
+00008fe0: 2062 292c 2028 6720 2a20 622c 2067 202a   b), (g * b, g *
+00008ff0: 2061 2929 0a20 2020 2065 6c69 6620 622e   a)).    elif b.
+00009000: 6e64 696d 203d 3d20 313a 0a20 2020 2020  ndim == 1:.     
+00009010: 2020 2067 6120 3d20 756e 7371 7565 657a     ga = unsqueez
+00009020: 6528 672c 206c 6173 745f 6469 6d29 2040  e(g, last_dim) @
+00009030: 2075 6e73 7175 6565 7a65 2862 2c20 6c61   unsqueeze(b, la
+00009040: 7374 5f64 696d 292e 6d54 0a20 2020 2020  st_dim).mT.     
+00009050: 2020 2067 6220 3d20 612e 6d54 2040 2075     gb = a.mT @ u
+00009060: 6e73 7175 6565 7a65 2867 2c20 6c61 7374  nsqueeze(g, last
+00009070: 5f64 696d 290a 2020 2020 2020 2020 6966  _dim).        if
+00009080: 2067 2e6e 6469 6d20 3e20 313a 0a20 2020   g.ndim > 1:.   
+00009090: 2020 2020 2020 2020 2067 6220 3d20 7371           gb = sq
+000090a0: 7565 657a 6528 6762 2c20 6c61 7374 5f64  ueeze(gb, last_d
+000090b0: 696d 290a 2020 2020 2020 2020 2020 2020  im).            
+000090c0: 6762 203d 206c 746f 7263 682e 7375 6d28  gb = ltorch.sum(
+000090d0: 6762 2c20 7475 706c 6528 7261 6e67 6528  gb, tuple(range(
+000090e0: 6762 2e6e 6469 6d20 2d20 3129 2929 0a20  gb.ndim - 1))). 
+000090f0: 2020 2020 2020 2070 7574 5f67 7261 6473         put_grads
+00009100: 2828 612c 2062 292c 2028 6761 2c20 6762  ((a, b), (ga, gb
+00009110: 2e73 7175 6565 7a65 2829 2929 0a20 2020  .squeeze())).   
+00009120: 2065 6c69 6620 612e 6e64 696d 203d 3d20   elif a.ndim == 
+00009130: 313a 0a20 2020 2020 2020 2067 6120 3d20  1:.        ga = 
+00009140: 756e 7371 7565 657a 6528 672c 2066 6972  unsqueeze(g, fir
+00009150: 7374 5f64 696d 2920 4020 622e 6d54 0a20  st_dim) @ b.mT. 
+00009160: 2020 2020 2020 2069 6620 672e 6e64 696d         if g.ndim
+00009170: 203e 2031 3a0a 2020 2020 2020 2020 2020   > 1:.          
+00009180: 2020 6761 203d 206c 746f 7263 682e 7375    ga = ltorch.su
+00009190: 6d28 6761 2c20 7475 706c 6528 7261 6e67  m(ga, tuple(rang
+000091a0: 6528 6761 2e6e 6469 6d20 2d20 3129 2929  e(ga.ndim - 1)))
+000091b0: 0a20 2020 2020 2020 2067 6220 3d20 756e  .        gb = un
+000091c0: 7371 7565 657a 6528 612c 2066 6972 7374  squeeze(a, first
+000091d0: 5f64 696d 292e 6d54 2040 2075 6e73 7175  _dim).mT @ unsqu
+000091e0: 6565 7a65 2867 2c20 6669 7273 745f 6469  eeze(g, first_di
+000091f0: 6d29 0a20 2020 2020 2020 2070 7574 5f67  m).        put_g
+00009200: 7261 6473 2828 612c 2062 292c 2028 6761  rads((a, b), (ga
+00009210: 2e73 7175 6565 7a65 2829 2c20 6762 2929  .squeeze(), gb))
+00009220: 0a20 2020 2065 6c73 653a 0a20 2020 2020  .    else:.     
+00009230: 2020 2070 7574 5f67 7261 6473 2828 612c     put_grads((a,
+00009240: 2062 292c 2028 6720 4020 622e 6d54 2c20   b), (g @ b.mT, 
+00009250: 612e 6d54 2040 2067 2929 0a0a 2020 2020  a.mT @ g))..    
+00009260: 7265 7475 726e 2066 7764 0a0a 0a72 6567  return fwd...reg
+00009270: 6973 7465 725f 6772 6164 2870 6964 732e  ister_grad(pids.
+00009280: 4d41 544d 554c 2c20 5f6d 6174 6d75 6c5f  MATMUL, _matmul_
+00009290: 7072 696d 5f67 7261 6429 0a0a 230a 2320  prim_grad)..#.# 
+000092a0: 4e4e 206f 7065 7261 746f 7220 6772 6164  NN operator grad
+000092b0: 730a 230a 0a0a 4074 6f72 6368 6374 780a  s.#...@torchctx.
+000092c0: 6465 6620 5f65 6d62 6564 6469 6e67 5f70  def _embedding_p
+000092d0: 7269 6d5f 6772 6164 280a 2020 2020 613a  rim_grad(.    a:
+000092e0: 2054 656e 736f 7250 726f 7879 2c20 2f2c   TensorProxy, /,
+000092f0: 2077 6569 6768 742c 202a 2c20 7061 6464   weight, *, padd
+00009300: 696e 675f 6964 783d 2d31 2c20 6d61 785f  ing_idx=-1, max_
+00009310: 6e6f 726d 3d4e 6f6e 652c 206e 6f72 6d5f  norm=None, norm_
+00009320: 7479 7065 3d32 2e30 2c20 7363 616c 655f  type=2.0, scale_
+00009330: 6772 6164 5f62 795f 6672 6571 3d46 616c  grad_by_freq=Fal
+00009340: 7365 2c20 7370 6172 7365 3d46 616c 7365  se, sparse=False
+00009350: 0a29 202d 3e20 5465 6e73 6f72 5072 6f78  .) -> TensorProx
+00009360: 793a 0a20 2020 2066 7764 203d 2070 7269  y:.    fwd = pri
+00009370: 6d73 2e65 6d62 6564 6469 6e67 280a 2020  ms.embedding(.  
+00009380: 2020 2020 2020 612c 0a20 2020 2020 2020        a,.       
+00009390: 2077 6569 6768 742c 0a20 2020 2020 2020   weight,.       
+000093a0: 2070 6164 6469 6e67 5f69 6478 3d70 6164   padding_idx=pad
+000093b0: 6469 6e67 5f69 6478 2c0a 2020 2020 2020  ding_idx,.      
+000093c0: 2020 6d61 785f 6e6f 726d 3d6d 6178 5f6e    max_norm=max_n
+000093d0: 6f72 6d2c 0a20 2020 2020 2020 206e 6f72  orm,.        nor
+000093e0: 6d5f 7479 7065 3d6e 6f72 6d5f 7479 7065  m_type=norm_type
+000093f0: 2c0a 2020 2020 2020 2020 7363 616c 655f  ,.        scale_
+00009400: 6772 6164 5f62 795f 6672 6571 3d73 6361  grad_by_freq=sca
+00009410: 6c65 5f67 7261 645f 6279 5f66 7265 712c  le_grad_by_freq,
+00009420: 0a20 2020 2020 2020 2073 7061 7273 653d  .        sparse=
+00009430: 7370 6172 7365 2c0a 2020 2020 290a 0a20  sparse,.    ).. 
+00009440: 2020 2067 203d 2067 6574 5f67 7261 6428     g = get_grad(
+00009450: 6677 6429 0a20 2020 2061 5f67 7261 6420  fwd).    a_grad 
+00009460: 3d20 7072 696d 732e 656d 6265 6464 696e  = prims.embeddin
+00009470: 675f 6261 636b 7761 7264 2867 2c20 612c  g_backward(g, a,
+00009480: 2077 6569 6768 742e 7368 6170 655b 305d   weight.shape[0]
+00009490: 2c20 7061 6464 696e 675f 6964 782c 2073  , padding_idx, s
+000094a0: 6361 6c65 5f67 7261 645f 6279 5f66 7265  cale_grad_by_fre
+000094b0: 712c 2073 7061 7273 6529 0a20 2020 2070  q, sparse).    p
+000094c0: 7574 5f67 7261 6428 612c 2061 5f67 7261  ut_grad(a, a_gra
+000094d0: 6429 0a0a 2020 2020 7265 7475 726e 2066  d)..    return f
+000094e0: 7764 0a0a 0a72 6567 6973 7465 725f 6772  wd...register_gr
+000094f0: 6164 2870 6964 732e 454d 4245 4444 494e  ad(pids.EMBEDDIN
+00009500: 472c 205f 656d 6265 6464 696e 675f 7072  G, _embedding_pr
+00009510: 696d 5f67 7261 6429 0a0a 230a 2320 5068  im_grad)..#.# Ph
+00009520: 616e 746f 6d20 6772 6164 2074 7261 6e73  antom grad trans
+00009530: 666f 726d 2068 656c 7065 7273 0a23 0a0a  form helpers.#..
+00009540: 0a64 6566 205f 6765 745f 6772 6164 666e  .def _get_gradfn
+00009550: 5f61 6e64 5f65 7865 6375 746f 7228 0a20  _and_executor(. 
+00009560: 2020 2062 7379 6d3a 2042 6f75 6e64 5379     bsym: BoundSy
+00009570: 6d62 6f6c 2c20 2a2c 2065 7865 6375 746f  mbol, *, executo
+00009580: 7273 5f6c 6973 743a 2053 6571 7565 6e63  rs_list: Sequenc
+00009590: 655b 416e 795d 203d 2074 7570 6c65 2829  e[Any] = tuple()
+000095a0: 0a29 202d 3e20 7475 706c 655b 4361 6c6c  .) -> tuple[Call
+000095b0: 6162 6c65 207c 204e 6f6e 652c 2045 7865  able | None, Exe
+000095c0: 6375 746f 7220 7c20 4e6f 6e65 5d3a 0a20  cutor | None]:. 
+000095d0: 2020 2063 6420 3d20 6765 745f 636f 6d70     cd = get_comp
+000095e0: 696c 655f 6461 7461 2829 0a20 2020 2065  ile_data().    e
+000095f0: 7865 6375 746f 7273 5f6c 6973 7420 3d20  xecutors_list = 
+00009600: 6364 2e65 7865 6375 746f 7273 5f6c 6973  cd.executors_lis
+00009610: 7420 6966 2063 6420 6973 206e 6f74 204e  t if cd is not N
+00009620: 6f6e 6520 656c 7365 2065 7865 6375 746f  one else executo
+00009630: 7273 5f6c 6973 740a 2020 2020 2320 4368  rs_list.    # Ch
+00009640: 6563 6b73 2069 6620 7468 6520 6578 6563  ecks if the exec
+00009650: 7574 6f72 2077 6869 6368 2068 6173 2070  utor which has p
+00009660: 7269 6f72 6974 7920 666f 7220 7468 6973  riority for this
+00009670: 206f 7065 7261 7469 6f6e 2068 6173 2061   operation has a
+00009680: 2073 7065 6369 6669 6320 6772 6164 2074   specific grad t
+00009690: 7261 6e73 666f 726d 2066 6f72 2069 740a  ransform for it.
+000096a0: 2020 2020 666f 7220 6578 2069 6e20 6578      for ex in ex
+000096b0: 6563 7574 6f72 735f 6c69 7374 3a0a 2020  ecutors_list:.  
+000096c0: 2020 2020 2020 6966 2065 782e 6361 6e5f        if ex.can_
+000096d0: 6578 6563 7574 655f 6f72 5f66 7573 6528  execute_or_fuse(
+000096e0: 6273 796d 293a 0a20 2020 2020 2020 2020  bsym):.         
+000096f0: 2020 2065 785f 6772 6164 5f74 7261 6e73     ex_grad_trans
+00009700: 666f 726d 3a20 4e6f 6e65 207c 2043 616c  form: None | Cal
+00009710: 6c61 626c 6520 3d20 6578 2e67 6574 5f67  lable = ex.get_g
+00009720: 7261 645f 7472 616e 7366 6f72 6d28 6273  rad_transform(bs
+00009730: 796d 2e73 796d 290a 2020 2020 2020 2020  ym.sym).        
+00009740: 2020 2020 6966 2065 785f 6772 6164 5f74      if ex_grad_t
+00009750: 7261 6e73 666f 726d 2069 7320 6e6f 7420  ransform is not 
+00009760: 4e6f 6e65 3a0a 2020 2020 2020 2020 2020  None:.          
+00009770: 2020 2020 2020 7265 7475 726e 2065 785f        return ex_
+00009780: 6772 6164 5f74 7261 6e73 666f 726d 2c20  grad_transform, 
+00009790: 6578 0a20 2020 2020 2020 2020 2020 2062  ex.            b
+000097a0: 7265 616b 0a0a 2020 2020 2320 4966 2074  reak..    # If t
+000097b0: 6865 2065 7865 6375 746f 7220 646f 6573  he executor does
+000097c0: 6e27 7420 6465 6669 6e65 2069 7473 206f  n't define its o
+000097d0: 776e 2067 7261 6420 7472 616e 7366 6f72  wn grad transfor
+000097e0: 6d2c 2074 6869 7320 6a75 7374 2072 6574  m, this just ret
+000097f0: 7572 6e73 2074 6865 2064 6566 6175 6c74  urns the default
+00009800: 2067 7261 6420 7472 616e 7366 6f72 6d20   grad transform 
+00009810: 666f 7220 7468 6520 6273 796d 0a20 2020  for the bsym.   
+00009820: 2067 7261 6466 6e20 3d20 5f67 7261 645f   gradfn = _grad_
+00009830: 666e 5f6d 6170 2e67 6574 2862 7379 6d2e  fn_map.get(bsym.
+00009840: 7379 6d2e 6964 2c20 4e6f 6e65 290a 2020  sym.id, None).  
+00009850: 2020 7265 7475 726e 2067 7261 6466 6e2c    return gradfn,
+00009860: 204e 6f6e 650a 0a0a 2320 5468 6520 6465   None...# The de
+00009870: 6661 756c 7420 6772 6164 2073 7065 6369  fault grad speci
+00009880: 6669 6572 2066 6f72 2074 6865 2067 7261  fier for the gra
+00009890: 6420 7472 616e 7366 6f72 6d0a 2320 2020  d transform.#   
+000098a0: 466f 7220 6561 6368 2074 656e 736f 7220  For each tensor 
+000098b0: 6f75 7470 7574 2022 6f22 2072 6571 7569  output "o" requi
+000098c0: 7269 6e67 2067 7261 642c 2073 7065 6369  ring grad, speci
+000098d0: 6669 6573 2061 2067 7261 6420 6f66 206f  fies a grad of o
+000098e0: 6e65 735f 6c69 6b65 286f 290a 6465 6620  nes_like(o).def 
+000098f0: 5f67 7261 645f 7370 6563 6966 6965 725f  _grad_specifier_
+00009900: 6465 6661 756c 7428 7079 7472 6565 3a20  default(pytree: 
+00009910: 416e 7929 202d 3e20 4e6f 6e65 3a0a 2020  Any) -> None:.  
+00009920: 2020 666c 6174 732c 205f 203d 2074 7265    flats, _ = tre
+00009930: 655f 666c 6174 7465 6e28 7079 7472 6565  e_flatten(pytree
+00009940: 290a 0a20 2020 2066 6f72 2066 2069 6e20  )..    for f in 
+00009950: 666c 6174 733a 0a20 2020 2020 2020 2069  flats:.        i
+00009960: 6620 6973 696e 7374 616e 6365 2866 2c20  f isinstance(f, 
+00009970: 5465 6e73 6f72 5072 6f78 7929 2061 6e64  TensorProxy) and
+00009980: 2066 2e72 6571 7569 7265 735f 6772 6164   f.requires_grad
+00009990: 3a0a 2020 2020 2020 2020 2020 2020 2320  :.            # 
+000099a0: 4e4f 5445 2054 6869 7320 7573 6573 2063  NOTE This uses c
+000099b0: 6c61 6e67 2e6f 6e65 735f 6c69 6b65 2066  lang.ones_like f
+000099c0: 6f72 206e 6f77 2062 6563 6175 7365 206c  or now because l
+000099d0: 746f 7263 682e 6f6e 6573 5f6c 696b 6520  torch.ones_like 
+000099e0: 7769 6c6c 2065 7874 656e 6420 7468 650a  will extend the.
+000099f0: 2020 2020 2020 2020 2020 2020 2320 2020              #   
+00009a00: 6c69 6665 7469 6d65 206f 6620 662c 2077  lifetime of f, w
+00009a10: 6869 6c65 2063 6c61 6e67 2e6f 6e65 735f  hile clang.ones_
+00009a20: 6c69 6b65 2077 696c 6c20 6578 7472 6163  like will extrac
+00009a30: 7420 7468 6520 6d65 7461 6461 7461 206f  t the metadata o
+00009a40: 6620 6620 6174 2074 7261 6365 2074 696d  f f at trace tim
+00009a50: 650a 2020 2020 2020 2020 2020 2020 7072  e.            pr
+00009a60: 696d 732e 7075 745f 6772 6164 2866 2c20  ims.put_grad(f, 
+00009a70: 636c 616e 672e 6675 6c6c 5f6c 696b 6528  clang.full_like(
+00009a80: 662c 2031 2e30 2929 0a0a 0a23 2054 4f44  f, 1.0))...# TOD
+00009a90: 4f20 5465 7374 2077 6974 6820 6275 6666  O Test with buff
+00009aa0: 6572 730a 6465 6620 5f67 7261 645f 6f75  ers.def _grad_ou
+00009ab0: 745f 7370 6563 6966 6965 725f 6465 6661  t_specifier_defa
+00009ac0: 756c 7428 7079 7472 6565 3a20 416e 7929  ult(pytree: Any)
+00009ad0: 202d 3e20 6c69 7374 5b54 656e 736f 7250   -> list[TensorP
+00009ae0: 726f 7879 5d3a 0a20 2020 2066 6c61 7473  roxy]:.    flats
+00009af0: 2c20 5f20 3d20 7472 6565 5f66 6c61 7474  , _ = tree_flatt
+00009b00: 656e 2870 7974 7265 6529 0a20 2020 2067  en(pytree).    g
+00009b10: 7261 6473 203d 206c 6973 7428 5b70 7269  rads = list([pri
+00009b20: 6d73 2e67 6574 5f67 7261 6428 6629 2066  ms.get_grad(f) f
+00009b30: 6f72 2066 2069 6e20 666c 6174 7320 6966  or f in flats if
+00009b40: 2069 7369 6e73 7461 6e63 6528 662c 2054   isinstance(f, T
+00009b50: 656e 736f 7250 726f 7879 2920 616e 6420  ensorProxy) and 
+00009b60: 662e 7265 7175 6972 6573 5f67 7261 645d  f.requires_grad]
+00009b70: 290a 2020 2020 7265 7475 726e 2067 7261  ).    return gra
+00009b80: 6473 0a0a 0a23 2054 4f44 4f20 466f 726d  ds...# TODO Form
+00009b90: 616c 6c79 2064 6566 696e 6520 7468 6520  ally define the 
+00009ba0: 2267 7261 6469 656e 7422 206f 6620 6120  "gradient" of a 
+00009bb0: 7465 6e73 6f72 0a23 2054 4f44 4f20 4966  tensor.# TODO If
+00009bc0: 206e 6f6e 6520 6f66 2074 6865 2069 6e70   none of the inp
+00009bd0: 7574 7320 746f 2061 6e20 6f70 6572 6174  uts to an operat
+00009be0: 696f 6e20 7265 7175 6972 6520 6772 6164  ion require grad
+00009bf0: 2c20 7468 656e 2077 6520 636f 756c 6420  , then we could 
+00009c00: 6c65 6176 6520 7468 6174 206f 7065 7261  leave that opera
+00009c10: 7469 6f6e 2061 6c6f 6e65 0a23 2020 2054  tion alone.#   T
+00009c20: 6869 7320 636f 756c 6420 6163 7475 616c  his could actual
+00009c30: 6c79 2069 6d70 726f 7665 2070 6572 666f  ly improve perfo
+00009c40: 726d 616e 6365 2069 6620 7468 6520 6f70  rmance if the op
+00009c50: 6572 6174 696f 6e20 7065 7266 6f72 6d73  eration performs
+00009c60: 2065 7874 7261 2063 6f6d 7075 7461 7469   extra computati
+00009c70: 6f6e 7320 696e 2069 7473 2067 7261 6420  ons in its grad 
+00009c80: 7472 616e 7366 6f72 6d0a 2320 2020 4120  transform.#   A 
+00009c90: 776f 726b 6172 6f75 6e64 2066 6f72 2074  workaround for t
+00009ca0: 6869 7320 776f 756c 6420 6265 2066 6f72  his would be for
+00009cb0: 2074 6865 206f 7065 7261 7469 6f6e 2069   the operation i
+00009cc0: 7473 656c 6620 746f 2063 6865 636b 2069  tself to check i
+00009cd0: 6620 6974 7320 696e 7075 7420 7265 7175  f its input requ
+00009ce0: 6972 6573 2067 7261 6420 6f72 206e 6f74  ires grad or not
+00009cf0: 0a23 2054 7261 6e73 666f 726d 7320 6120  .# Transforms a 
+00009d00: 6675 6e63 7469 6f6e 2074 6f20 636f 6d70  function to comp
+00009d10: 7574 6520 7468 6520 2267 7261 6469 656e  ute the "gradien
+00009d20: 7422 206f 6620 6974 7320 696e 7075 7473  t" of its inputs
+00009d30: 2072 6571 7569 7269 6e67 2067 7261 642c   requiring grad,
+00009d40: 2070 6f73 7369 626c 790a 2320 2020 6d6f   possibly.#   mo
+00009d50: 6469 6669 6564 2062 7920 7468 6520 6772  dified by the gr
+00009d60: 6164 2073 7065 6369 6669 6572 7320 2873  ad specifiers (s
+00009d70: 6565 2062 656c 6f77 292e 0a23 2054 6865  ee below)..# The
+00009d80: 206f 7074 696f 6e61 6c20 6772 6164 5f73   optional grad_s
+00009d90: 7065 6369 6669 6572 2061 7267 756d 656e  pecifier argumen
+00009da0: 7420 6163 6365 7074 7320 7468 6520 6675  t accepts the fu
+00009db0: 6e63 7469 6f6e 2773 206f 7574 7075 742c  nction's output,
+00009dc0: 2072 756e 7320 696e 2061 206e 6f2d 6772   runs in a no-gr
+00009dd0: 6164 2063 6f6e 7465 7874 2c0a 2320 2020  ad context,.#   
+00009de0: 616e 6420 6361 6e20 7075 7420 6772 6164  and can put grad
+00009df0: 7320 2875 7369 6e67 2070 7269 6d73 2e70  s (using prims.p
+00009e00: 7574 5f67 7261 6428 2929 2066 6f72 2074  ut_grad()) for t
+00009e10: 656e 736f 7273 2e20 4279 2064 6566 6175  ensors. By defau
+00009e20: 6c74 2c20 666f 7220 6576 6572 7920 7465  lt, for every te
+00009e30: 6e73 6f72 206f 7574 7075 7420 226f 220a  nsor output "o".
+00009e40: 2320 2020 7468 6174 2072 6571 7569 7265  #   that require
+00009e50: 7320 6772 6164 2c20 6120 6772 6164 206f  s grad, a grad o
+00009e60: 6620 6f6e 6573 5f6c 696b 6528 6f29 2069  f ones_like(o) i
+00009e70: 7320 7075 742e 0a23 2054 6865 206f 7074  s put..# The opt
+00009e80: 696f 6e61 6c20 6772 6164 5f6f 7574 5f73  ional grad_out_s
+00009e90: 7065 6369 6669 6572 2061 6363 6570 7473  pecifier accepts
+00009ea0: 2074 6865 2066 756e 6374 696f 6e27 7320   the function's 
+00009eb0: 696e 7075 7420 616e 6420 6361 6e20 6361  input and can ca
+00009ec0: 6c6c 2070 7269 6d73 2e67 6574 5f67 7261  ll prims.get_gra
+00009ed0: 6428 2920 746f 0a23 2020 2061 6371 7569  d() to.#   acqui
+00009ee0: 7265 2061 6e64 2072 6574 7572 6e20 6772  re and return gr
+00009ef0: 6164 6965 6e74 7320 6173 2064 6573 6972  adients as desir
+00009f00: 6564 2e20 4279 2064 6566 6175 6c74 2c20  ed. By default, 
+00009f10: 7468 6520 696e 7075 7420 6973 2066 6c61  the input is fla
+00009f20: 7474 656e 6564 0a23 2020 2028 7472 6565  ttened.#   (tree
+00009f30: 5f66 6c61 7474 656e 2861 7267 732c 206b  _flatten(args, k
+00009f40: 7761 7267 7329 2920 616e 6420 6120 666c  wargs)) and a fl
+00009f50: 6174 206c 6973 7420 6f66 2067 7261 6473  at list of grads
+00009f60: 2066 6f72 2061 6c6c 2074 656e 736f 7273   for all tensors
+00009f70: 2072 6571 7569 7269 6e67 2067 7261 640a   requiring grad.
+00009f80: 2320 2020 616e 6420 4e6f 6e65 2066 6f72  #   and None for
+00009f90: 206f 7468 6572 2069 6e70 7574 7320 6973   other inputs is
+00009fa0: 2072 6574 7572 6e65 642e 0a23 2054 6865   returned..# The
+00009fb0: 2061 6c67 6f72 6974 686d 2066 6f72 206d   algorithm for m
+00009fc0: 6f64 6966 7969 6e67 2074 6865 2070 726f  odifying the pro
+00009fd0: 6772 616d 2068 6173 2074 6865 2066 6f6c  gram has the fol
+00009fe0: 6c6f 7769 6e67 2073 7465 7073 3a0a 2320  lowing steps:.# 
+00009ff0: 2020 3129 2046 6c61 7474 656e 7320 7468    1) Flattens th
+0000a000: 6520 6f72 6967 696e 616c 2074 7261 6365  e original trace
+0000a010: 2066 6f72 2074 6865 2067 7261 6420 7472   for the grad tr
+0000a020: 616e 7366 6f72 6d20 2d2d 2065 6e73 7569  ansform -- ensui
+0000a030: 6e67 2074 6861 7420 616c 6c20 746f 702d  ng that all top-
+0000a040: 6c65 7665 6c20 7379 6d62 6f6c 7320 6861  level symbols ha
+0000a050: 7665 0a23 2020 2020 2020 2061 2067 7261  ve.#       a gra
+0000a060: 6420 6675 6e63 7469 6f6e 2e0a 6465 6620  d function..def 
+0000a070: 6772 6164 280a 2020 2020 6366 6e2c 2067  grad(.    cfn, g
+0000a080: 7261 645f 7370 6563 6966 6965 723a 2043  rad_specifier: C
+0000a090: 616c 6c61 626c 6520 3d20 5f67 7261 645f  allable = _grad_
+0000a0a0: 7370 6563 6966 6965 725f 6465 6661 756c  specifier_defaul
+0000a0b0: 742c 2067 7261 645f 6f75 745f 7370 6563  t, grad_out_spec
+0000a0c0: 6966 6965 723a 2043 616c 6c61 626c 6520  ifier: Callable 
+0000a0d0: 3d20 5f67 7261 645f 6f75 745f 7370 6563  = _grad_out_spec
+0000a0e0: 6966 6965 725f 6465 6661 756c 740a 2920  ifier_default.) 
+0000a0f0: 2d3e 2043 616c 6c61 626c 653a 0a20 2020  -> Callable:.   
+0000a100: 2023 2043 7265 6174 6573 2061 2063 7573   # Creates a cus
+0000a110: 746f 6d20 7472 616e 7366 6f72 6d20 6361  tom transform ca
+0000a120: 6c6c 6162 6c65 2074 6861 7420 6269 6e64  llable that bind
+0000a130: 7320 7468 6520 6164 6469 7469 6f6e 616c  s the additional
+0000a140: 2061 7267 756d 656e 7473 2074 6f20 7468   arguments to th
+0000a150: 6520 6772 6164 2074 7261 6e73 666f 726d  e grad transform
+0000a160: 0a20 2020 2040 6c61 6e67 6374 7828 4c61  .    @langctx(La
+0000a170: 6e67 7561 6765 732e 434c 414e 4729 0a20  nguages.CLANG). 
+0000a180: 2020 2064 6566 205f 6772 6164 5f74 7261     def _grad_tra
+0000a190: 6e73 666f 726d 2874 7263 3a20 5472 6163  nsform(trc: Trac
+0000a1a0: 652c 202a 2c20 6578 6563 7574 6f72 735f  e, *, executors_
+0000a1b0: 6c69 7374 3a20 5365 7175 656e 6365 5b41  list: Sequence[A
+0000a1c0: 6e79 5d29 202d 3e20 5472 6163 653a 0a20  ny]) -> Trace:. 
+0000a1d0: 2020 2020 2020 2073 7461 7274 5f74 696d         start_tim
+0000a1e0: 655f 6e73 203d 2074 696d 652e 7469 6d65  e_ns = time.time
+0000a1f0: 5f6e 7328 290a 0a20 2020 2020 2020 2023  _ns()..        #
+0000a200: 2053 5445 5020 4f4e 4520 2d2d 2046 6c61   STEP ONE -- Fla
+0000a210: 7474 656e 7320 616e 6420 6463 6573 0a0a  ttens and dces..
+0000a220: 2020 2020 2020 2020 2320 5265 7475 726e          # Return
+0000a230: 7320 5472 7565 2069 6620 7468 6520 6273  s True if the bs
+0000a240: 796d 2068 6173 206e 6f20 6772 6164 2066  ym has no grad f
+0000a250: 756e 6374 696f 6e2c 2061 6e64 2073 6f20  unction, and so 
+0000a260: 6d75 7374 2062 6520 666c 6174 7465 6e65  must be flattene
+0000a270: 6420 666f 7220 7468 6520 6772 6164 2074  d for the grad t
+0000a280: 7261 6e73 666f 726d 0a20 2020 2020 2020  ransform.       
+0000a290: 206e 6576 6572 5f66 6c61 7474 656e 3a20   never_flatten: 
+0000a2a0: 7365 745b 4861 7368 6162 6c65 5d20 3d20  set[Hashable] = 
+0000a2b0: 7b70 7269 6d73 2e50 7269 6d49 4473 2e52  {prims.PrimIDs.R
+0000a2c0: 4554 5552 4e2c 2070 7269 6d73 2e50 7269  ETURN, prims.Pri
+0000a2d0: 6d49 4473 2e55 4e50 4143 4b5f 5452 4956  mIDs.UNPACK_TRIV
+0000a2e0: 4941 4c7d 0a0a 2020 2020 2020 2020 6465  IAL}..        de
+0000a2f0: 6620 7368 6f75 6c64 5f66 6c61 7474 656e  f should_flatten
+0000a300: 5f66 6f72 5f67 7261 6428 6273 796d 3a20  _for_grad(bsym: 
+0000a310: 426f 756e 6453 796d 626f 6c29 202d 3e20  BoundSymbol) -> 
+0000a320: 626f 6f6c 3a0a 2020 2020 2020 2020 2020  bool:.          
+0000a330: 2020 6966 2062 7379 6d2e 7379 6d2e 6964    if bsym.sym.id
+0000a340: 2069 6e20 6e65 7665 725f 666c 6174 7465   in never_flatte
+0000a350: 6e3a 0a20 2020 2020 2020 2020 2020 2020  n:.             
+0000a360: 2020 2072 6574 7572 6e20 4661 6c73 650a     return False.
+0000a370: 0a20 2020 2020 2020 2020 2020 2067 7261  .            gra
+0000a380: 6466 6e3a 204e 6f6e 6520 7c20 4361 6c6c  dfn: None | Call
+0000a390: 6162 6c65 0a20 2020 2020 2020 2020 2020  able.           
+0000a3a0: 2067 7261 6466 6e2c 205f 203d 205f 6765   gradfn, _ = _ge
+0000a3b0: 745f 6772 6164 666e 5f61 6e64 5f65 7865  t_gradfn_and_exe
+0000a3c0: 6375 746f 7228 6273 796d 2c20 6578 6563  cutor(bsym, exec
+0000a3d0: 7574 6f72 735f 6c69 7374 3d65 7865 6375  utors_list=execu
+0000a3e0: 746f 7273 5f6c 6973 7429 0a20 2020 2020  tors_list).     
+0000a3f0: 2020 2020 2020 2072 6574 7572 6e20 6772         return gr
+0000a400: 6164 666e 2069 7320 4e6f 6e65 0a0a 2020  adfn is None..  
+0000a410: 2020 2020 2020 2320 544f 444f 2052 4331        # TODO RC1
+0000a420: 3a20 6d61 7962 6520 6d6f 7665 2074 6f20  : maybe move to 
+0000a430: 7072 6f64 7563 6520 7468 6573 6520 616c  produce these al
+0000a440: 7761 7973 206f 6e20 6372 6561 7469 6f6e  ways on creation
+0000a450: 0a20 2020 2020 2020 2069 6620 7472 632e  .        if trc.
+0000a460: 6b77 6172 6773 2069 7320 4e6f 6e65 3a0a  kwargs is None:.
+0000a470: 2020 2020 2020 2020 2020 2020 7472 632e              trc.
+0000a480: 6b77 6172 6773 203d 207b 7d0a 2020 2020  kwargs = {}.    
+0000a490: 2020 2020 6966 2074 7263 2e66 6e20 6973      if trc.fn is
+0000a4a0: 204e 6f6e 653a 0a20 2020 2020 2020 2020   None:.         
+0000a4b0: 2020 2074 7263 2e66 6e20 3d20 7472 632e     trc.fn = trc.
+0000a4c0: 7079 7468 6f6e 5f63 616c 6c61 626c 6528  python_callable(
+0000a4d0: 290a 0a20 2020 2020 2020 2067 7261 6474  )..        gradt
+0000a4e0: 7263 203d 2066 726f 6d5f 7472 6163 6528  rc = from_trace(
+0000a4f0: 7472 6329 0a20 2020 2020 2020 2066 6c61  trc).        fla
+0000a500: 7474 656e 6564 5f62 7379 6d73 3a20 6c69  ttened_bsyms: li
+0000a510: 7374 5b42 6f75 6e64 5379 6d62 6f6c 5d20  st[BoundSymbol] 
+0000a520: 3d20 666c 6174 7465 6e5f 666f 725f 7472  = flatten_for_tr
+0000a530: 616e 7366 6f72 6d28 7368 6f75 6c64 5f66  ansform(should_f
+0000a540: 6c61 7474 656e 5f66 6f72 5f67 7261 642c  latten_for_grad,
+0000a550: 2074 7263 2e62 6f75 6e64 5f73 796d 626f   trc.bound_symbo
+0000a560: 6c73 290a 2020 2020 2020 2020 6772 6164  ls).        grad
+0000a570: 7472 632e 626f 756e 645f 7379 6d62 6f6c  trc.bound_symbol
+0000a580: 7320 3d20 666c 6174 7465 6e65 645f 6273  s = flattened_bs
+0000a590: 796d 730a 2020 2020 2020 2020 6772 6164  yms.        grad
+0000a5a0: 7472 6320 3d20 6463 6528 6772 6164 7472  trc = dce(gradtr
+0000a5b0: 6329 0a0a 2020 2020 2020 2020 2320 5354  c)..        # ST
+0000a5c0: 4550 2054 574f 202d 2d20 5265 706c 6163  EP TWO -- Replac
+0000a5d0: 6573 206f 7269 6769 6e61 6c20 6361 6c6c  es original call
+0000a5e0: 7320 7769 7468 2067 7261 6420 6361 6c6c  s with grad call
+0000a5f0: 730a 0a20 2020 2020 2020 2023 2044 6566  s..        # Def
+0000a600: 696e 6573 2074 6865 2076 6973 6974 6f72  ines the visitor
+0000a610: 2070 6174 7465 726e 2066 6f72 2074 6865   pattern for the
+0000a620: 2066 6972 7374 2070 6173 7320 6f66 2074   first pass of t
+0000a630: 6865 2067 7261 6420 7472 616e 7366 6f72  he grad transfor
+0000a640: 6d2c 0a20 2020 2020 2020 2023 2020 2077  m,.        #   w
+0000a650: 6869 6368 2073 7761 7073 2042 6f75 6e64  hich swaps Bound
+0000a660: 5379 6d62 6f6c 7320 7769 7468 2074 6865  Symbols with the
+0000a670: 6972 2067 7261 6420 6675 6e63 7469 6f6e  ir grad function
+0000a680: 730a 2020 2020 2020 2020 6465 6620 7669  s.        def vi
+0000a690: 7369 745f 2862 7379 6d3a 2042 6f75 6e64  sit_(bsym: Bound
+0000a6a0: 5379 6d62 6f6c 2920 2d3e 2043 616c 6c61  Symbol) -> Calla
+0000a6b0: 626c 653a 0a20 2020 2020 2020 2020 2020  ble:.           
+0000a6c0: 2067 7261 6466 6e3a 204e 6f6e 6520 7c20   gradfn: None | 
+0000a6d0: 4361 6c6c 6162 6c65 0a20 2020 2020 2020  Callable.       
+0000a6e0: 2020 2020 2067 7261 6466 6e2c 205f 203d       gradfn, _ =
+0000a6f0: 205f 6765 745f 6772 6164 666e 5f61 6e64   _get_gradfn_and
+0000a700: 5f65 7865 6375 746f 7228 6273 796d 2c20  _executor(bsym, 
+0000a710: 6578 6563 7574 6f72 735f 6c69 7374 3d65  executors_list=e
+0000a720: 7865 6375 746f 7273 5f6c 6973 7429 0a20  xecutors_list). 
+0000a730: 2020 2020 2020 2020 2020 2063 6865 636b             check
+0000a740: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
+0000a750: 2020 6772 6164 666e 2069 7320 6e6f 7420    gradfn is not 
+0000a760: 4e6f 6e65 2c0a 2020 2020 2020 2020 2020  None,.          
+0000a770: 2020 2020 2020 6c61 6d62 6461 3a20 6622        lambda: f"
+0000a780: 4661 696c 6564 2074 6f20 6669 6e64 2061  Failed to find a
+0000a790: 2067 7261 6466 6e20 666f 7220 7b62 7379   gradfn for {bsy
+0000a7a0: 6d3d 7d20 6166 7465 7220 666c 6174 7465  m=} after flatte
+0000a7b0: 6e69 6e67 222c 0a20 2020 2020 2020 2020  ning",.         
+0000a7c0: 2020 2020 2020 2065 7863 6570 7469 6f6e         exception
+0000a7d0: 5f74 7970 653d 4173 7365 7274 696f 6e45  _type=AssertionE
+0000a7e0: 7272 6f72 2c0a 2020 2020 2020 2020 2020  rror,.          
+0000a7f0: 2020 290a 2020 2020 2020 2020 2020 2020    ).            
+0000a800: 7265 7475 726e 2067 7261 6466 6e0a 0a20  return gradfn.. 
+0000a810: 2020 2020 2020 2040 7772 6170 7328 7472         @wraps(tr
+0000a820: 632e 666e 2e6d 6574 6120 6966 2069 7369  c.fn.meta if isi
+0000a830: 6e73 7461 6e63 6528 7472 632e 666e 2c20  nstance(trc.fn, 
+0000a840: 5379 6d62 6f6c 2920 656c 7365 2074 7263  Symbol) else trc
+0000a850: 2e66 6e29 0a20 2020 2020 2020 2064 6566  .fn).        def
+0000a860: 2069 6e74 6572 7072 6574 696e 675f 666e   interpreting_fn
+0000a870: 282a 6172 6773 2c20 2a2a 6b77 6172 6773  (*args, **kwargs
+0000a880: 293a 0a20 2020 2020 2020 2020 2020 2072  ):.            r
+0000a890: 6573 756c 7420 3d20 6576 616c 5f74 7261  esult = eval_tra
+0000a8a0: 6365 2867 7261 6474 7263 2c20 2a61 7267  ce(gradtrc, *arg
+0000a8b0: 732c 2073 796d 626f 6c5f 6d61 7070 6572  s, symbol_mapper
+0000a8c0: 3d76 6973 6974 5f2c 202a 2a6b 7761 7267  =visit_, **kwarg
+0000a8d0: 7329 0a20 2020 2020 2020 2020 2020 2023  s).            #
+0000a8e0: 2053 6574 7320 6772 6164 7320 666f 7220   Sets grads for 
+0000a8f0: 6f75 7470 7574 0a20 2020 2020 2020 2020  output.         
+0000a900: 2020 2023 2054 4f44 4f20 5468 6973 2065     # TODO This e
+0000a910: 6666 6563 7469 7665 6c79 2072 756e 7320  ffectively runs 
+0000a920: 696e 2061 206e 6f20 6772 6164 2063 6f6e  in a no grad con
+0000a930: 7465 7874 202d 2d20 7368 6f75 6c64 2069  text -- should i
+0000a940: 7420 7275 6e20 696e 2061 2067 7261 6420  t run in a grad 
+0000a950: 636f 6e74 6578 742c 0a20 2020 2020 2020  context,.       
+0000a960: 2020 2020 2023 2020 206f 7220 7368 6f75       #   or shou
+0000a970: 6c64 2074 6865 7265 2062 6520 7468 6520  ld there be the 
+0000a980: 6f70 7469 6f6e 2074 6f20 7275 6e20 6974  option to run it
+0000a990: 2069 6e20 6120 6772 6164 2063 6f6e 7465   in a grad conte
+0000a9a0: 7874 3f0a 2020 2020 2020 2020 2020 2020  xt?.            
+0000a9b0: 6772 6164 5f73 7065 6369 6669 6572 2872  grad_specifier(r
+0000a9c0: 6573 756c 7429 0a20 2020 2020 2020 2020  esult).         
+0000a9d0: 2020 2023 2043 6f6e 7374 7275 6374 7320     # Constructs 
+0000a9e0: 7265 7475 726e 2076 616c 7565 0a20 2020  return value.   
+0000a9f0: 2020 2020 2020 2020 2066 6c61 745f 6772           flat_gr
+0000aa00: 6164 7320 3d20 6772 6164 5f6f 7574 5f73  ads = grad_out_s
+0000aa10: 7065 6369 6669 6572 2828 6172 6773 2c20  pecifier((args, 
+0000aa20: 6b77 6172 6773 2929 0a20 2020 2020 2020  kwargs)).       
+0000aa30: 2020 2020 2072 6574 7572 6e20 666c 6174       return flat
+0000aa40: 5f67 7261 6473 0a0a 2020 2020 2020 2020  _grads..        
+0000aa50: 2320 4e4f 5445 2041 6674 6572 2074 6869  # NOTE After thi
+0000aa60: 7320 6361 6c6c 2074 6865 2067 7261 6474  s call the gradt
+0000aa70: 7263 2069 7320 696e 7661 6c69 642c 2062  rc is invalid, b
+0000aa80: 6563 6175 7365 3a0a 2020 2020 2020 2020  ecause:.        
+0000aa90: 2320 2020 3129 2054 6865 206e 6f6e 2d65  #   1) The non-e
+0000aaa0: 7865 6375 7461 626c 6520 7075 745f 6772  xecutable put_gr
+0000aab0: 6164 206f 7065 7261 7469 6f6e 7320 6172  ad operations ar
+0000aac0: 6520 7374 696c 6c20 696e 2074 6865 2074  e still in the t
+0000aad0: 7261 6365 2c20 616e 6420 6d75 6c74 6970  race, and multip
+0000aae0: 6c65 2063 616c 6c73 2074 6f20 7075 7420  le calls to put 
+0000aaf0: 6772 6164 2061 7265 206e 6f74 2061 6363  grad are not acc
+0000ab00: 756d 756c 6174 6564 0a20 2020 2020 2020  umulated.       
+0000ab10: 2023 2020 2032 2920 5468 6520 6e6f 6e2d   #   2) The non-
+0000ab20: 6578 6563 7574 6162 6c65 2067 6574 5f67  executable get_g
+0000ab30: 7261 6420 6f70 6572 6174 696f 6e73 2061  rad operations a
+0000ab40: 7265 2073 7469 6c6c 2069 6e20 7468 6520  re still in the 
+0000ab50: 7472 6163 652c 2061 6e64 2074 6865 7920  trace, and they 
+0000ab60: 6d61 7920 7072 6f64 7563 6520 6469 6666  may produce diff
+0000ab70: 6572 656e 7420 7072 6f78 6965 7320 7768  erent proxies wh
+0000ab80: 656e 0a20 2020 2020 2020 2023 2020 2020  en.        #    
+0000ab90: 2020 2063 616c 6c65 6420 6f6e 2074 6865     called on the
+0000aba0: 2073 616d 6520 696e 7075 7473 0a20 2020   same inputs.   
+0000abb0: 2020 2020 2023 2020 2033 2920 5468 6520       #   3) The 
+0000abc0: 6f70 6572 6174 696f 6e73 2061 7265 206e  operations are n
+0000abd0: 6f74 2069 6e20 6120 7661 6c69 6420 6f72  ot in a valid or
+0000abe0: 6465 720a 2020 2020 2020 2020 6772 6164  der.        grad
+0000abf0: 7472 6320 3d20 636f 6e73 7472 7563 745f  trc = construct_
+0000ac00: 7472 6163 6528 0a20 2020 2020 2020 2020  trace(.         
+0000ac10: 2020 2072 656e 616d 655f 7072 6f78 6965     rename_proxie
+0000ac20: 733d 4661 6c73 652c 0a20 2020 2020 2020  s=False,.       
+0000ac30: 2020 2020 2075 7365 5f64 6365 3d46 616c       use_dce=Fal
+0000ac40: 7365 2c0a 2020 2020 2020 2020 2928 696e  se,.        )(in
+0000ac50: 7465 7270 7265 7469 6e67 5f66 6e2c 202a  terpreting_fn, *
+0000ac60: 6772 6164 7472 632e 6172 6773 2c20 2a2a  gradtrc.args, **
+0000ac70: 6772 6164 7472 632e 6b77 6172 6773 290a  gradtrc.kwargs).
+0000ac80: 2020 2020 2020 2020 6772 6164 7472 632e          gradtrc.
+0000ac90: 7363 6f70 6573 203d 205b 6772 6164 7472  scopes = [gradtr
+0000aca0: 632e 626f 756e 645f 7379 6d62 6f6c 735d  c.bound_symbols]
+0000acb0: 0a20 2020 2020 2020 2067 7261 6474 7263  .        gradtrc
+0000acc0: 2e5f 636f 6d70 6c65 7465 203d 2046 616c  ._complete = Fal
+0000acd0: 7365 0a0a 2020 2020 2020 2020 2320 5354  se..        # ST
+0000ace0: 4550 2054 4852 4545 202d 2d20 4861 6e64  EP THREE -- Hand
+0000acf0: 6c65 7320 7075 745f 6772 6164 2061 6e64  les put_grad and
+0000ad00: 2067 6574 5f67 7261 6420 6f70 6572 6174   get_grad operat
+0000ad10: 696f 6e73 2061 6e64 2061 6363 756d 756c  ions and accumul
+0000ad20: 6174 6573 2067 7261 6469 656e 7473 0a0a  ates gradients..
+0000ad30: 2020 2020 2020 2020 2320 4163 6375 6d75          # Accumu
+0000ad40: 6c61 7465 7320 6772 6164 6965 6e74 732c  lates gradients,
+0000ad50: 2063 7265 6174 696e 6720 7468 6520 7072   creating the pr
+0000ad60: 696d 616c 202d 3e20 6163 6375 6d75 6c61  imal -> accumula
+0000ad70: 7465 6420 6772 6164 206d 6170 7069 6e67  ted grad mapping
+0000ad80: 0a20 2020 2020 2020 2023 2053 6574 7320  .        # Sets 
+0000ad90: 7468 6520 7472 6163 696e 6720 636f 6e74  the tracing cont
+0000ada0: 6578 7420 736f 2061 6363 756d 756c 6174  ext so accumulat
+0000adb0: 696f 6e20 6f70 6572 6174 696f 6e73 2061  ion operations a
+0000adc0: 7265 2072 6563 6f72 6465 6420 696e 746f  re recorded into
+0000add0: 2074 6865 2074 7261 6365 0a20 2020 2020   the trace.     
+0000ade0: 2020 2074 7279 3a0a 2020 2020 2020 2020     try:.        
+0000adf0: 2020 2020 7472 6163 6563 7478 5f74 6f6b      tracectx_tok
+0000ae00: 203d 2073 6574 5f74 7261 6365 6374 7828   = set_tracectx(
+0000ae10: 6772 6164 7472 6329 0a0a 2020 2020 2020  gradtrc)..      
+0000ae20: 2020 2020 2020 2320 4d61 7073 2070 7269        # Maps pri
+0000ae30: 6d61 6c73 2074 6f20 7468 6569 7220 6772  mals to their gr
+0000ae40: 6164 6965 6e74 7320 2877 6869 6368 2061  adients (which a
+0000ae50: 7265 2072 6574 7572 6e65 6420 6672 6f6d  re returned from
+0000ae60: 2063 616c 6c69 6e67 2067 6574 5f67 7261   calling get_gra
+0000ae70: 6420 6f6e 2074 6865 2070 7269 6d61 6c29  d on the primal)
+0000ae80: 0a20 2020 2020 2020 2020 2020 2070 7269  .            pri
+0000ae90: 6d61 6c73 5f74 6f5f 6769 6e70 7574 5f6d  mals_to_ginput_m
+0000aea0: 6170 3a20 6469 6374 5b56 6172 6961 626c  ap: dict[Variabl
+0000aeb0: 652c 2054 656e 736f 7250 726f 7879 5d20  e, TensorProxy] 
+0000aec0: 3d20 7b7d 0a0a 2020 2020 2020 2020 2020  = {}..          
+0000aed0: 2020 2320 4861 6e64 6c65 7320 7075 745f    # Handles put_
+0000aee0: 6772 6164 206f 7065 7261 7469 6f6e 730a  grad operations.
+0000aef0: 2020 2020 2020 2020 2020 2020 2320 4e4f              # NO
+0000af00: 5445 2054 6869 7320 6d6f 6469 6669 6573  TE This modifies
+0000af10: 2061 206c 6973 7420 7468 6174 2069 7320   a list that is 
+0000af20: 6265 696e 6720 656e 756d 6572 6174 6564  being enumerated
+0000af30: 206f 7665 722c 2062 7574 2069 7427 7320   over, but it's 
+0000af40: 4f4b 2062 6563 6175 7365 2077 6527 7265  OK because we're
+0000af50: 206f 6e6c 790a 2020 2020 2020 2020 2020   only.          
+0000af60: 2020 2320 2020 6170 7065 6e64 696e 6720    #   appending 
+0000af70: 746f 2074 6865 2065 6e64 206f 6620 7468  to the end of th
+0000af80: 6520 6c69 7374 0a20 2020 2020 2020 2020  e list.         
+0000af90: 2020 2062 7379 6d3a 2042 6f75 6e64 5379     bsym: BoundSy
+0000afa0: 6d62 6f6c 0a20 2020 2020 2020 2020 2020  mbol.           
+0000afb0: 2066 6f72 2062 7379 6d20 696e 2067 7261   for bsym in gra
+0000afc0: 6474 7263 2e62 6f75 6e64 5f73 796d 626f  dtrc.bound_symbo
+0000afd0: 6c73 3a0a 2020 2020 2020 2020 2020 2020  ls:.            
+0000afe0: 2020 2020 6964 3a20 4861 7368 6162 6c65      id: Hashable
+0000aff0: 203d 2062 7379 6d2e 7379 6d2e 6964 0a20   = bsym.sym.id. 
+0000b000: 2020 2020 2020 2020 2020 2020 2020 2069                 i
+0000b010: 6620 6964 2069 7320 7069 6473 2e50 5554  f id is pids.PUT
+0000b020: 5f47 5241 443a 0a20 2020 2020 2020 2020  _GRAD:.         
+0000b030: 2020 2020 2020 2020 2020 2070 7269 6d61             prima
+0000b040: 6c3a 204e 756d 6265 7220 7c20 5465 6e73  l: Number | Tens
+0000b050: 6f72 5072 6f78 790a 2020 2020 2020 2020  orProxy.        
+0000b060: 2020 2020 2020 2020 2020 2020 6772 6164              grad
+0000b070: 3a20 4e75 6d62 6572 207c 2054 656e 736f  : Number | Tenso
+0000b080: 7250 726f 7879 0a20 2020 2020 2020 2020  rProxy.         
+0000b090: 2020 2020 2020 2020 2020 2070 7269 6d61             prima
+0000b0a0: 6c2c 2067 7261 6420 3d20 6273 796d 2e66  l, grad = bsym.f
+0000b0b0: 6c61 745f 6172 6773 0a0a 2020 2020 2020  lat_args..      
+0000b0c0: 2020 2020 2020 2020 2020 2020 2020 2320                # 
+0000b0d0: 544f 444f 2053 7570 706f 7274 2061 7574  TODO Support aut
+0000b0e0: 6f67 7261 6420 6f6e 206e 756d 6265 7273  ograd on numbers
+0000b0f0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0000b100: 2020 2020 2023 2046 696c 7465 7273 2063       # Filters c
+0000b110: 616c 6c73 2074 6f20 7075 745f 6772 6164  alls to put_grad
+0000b120: 2074 6861 7420 776f 756c 6420 7075 7420   that would put 
+0000b130: 6120 6772 6164 206f 6e20 6120 6e6f 6e2d  a grad on a non-
+0000b140: 7465 6e73 6f72 206f 7220 6120 7465 6e73  tensor or a tens
+0000b150: 6f72 2074 6861 7420 646f 6573 6e27 7420  or that doesn't 
+0000b160: 7265 7175 6972 6520 6772 6164 0a20 2020  require grad.   
+0000b170: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000b180: 2069 6620 6e6f 7420 6973 696e 7374 616e   if not isinstan
+0000b190: 6365 2870 7269 6d61 6c2c 2054 656e 736f  ce(primal, Tenso
+0000b1a0: 7250 726f 7879 2920 6f72 206e 6f74 2070  rProxy) or not p
+0000b1b0: 7269 6d61 6c2e 7265 7175 6972 6573 5f67  rimal.requires_g
+0000b1c0: 7261 643a 0a20 2020 2020 2020 2020 2020  rad:.           
+0000b1d0: 2020 2020 2020 2020 2020 2020 2063 6f6e               con
+0000b1e0: 7469 6e75 650a 0a20 2020 2020 2020 2020  tinue..         
+0000b1f0: 2020 2020 2020 2020 2020 2023 2054 4f44             # TOD
+0000b200: 4f20 5375 7070 6f72 7420 636f 6d70 6c65  O Support comple
+0000b210: 7820 6175 746f 6772 6164 0a20 2020 2020  x autograd.     
+0000b220: 2020 2020 2020 2020 2020 2020 2020 2063                 c
+0000b230: 6865 636b 280a 2020 2020 2020 2020 2020  heck(.          
+0000b240: 2020 2020 2020 2020 2020 2020 2020 6e6f                no
+0000b250: 7420 6474 7970 6573 2e69 735f 636f 6d70  t dtypes.is_comp
+0000b260: 6c65 785f 6474 7970 6528 6474 7970 6573  lex_dtype(dtypes
+0000b270: 2e74 6f5f 6474 7970 6528 7072 696d 616c  .to_dtype(primal
+0000b280: 2929 2c0a 2020 2020 2020 2020 2020 2020  )),.            
+0000b290: 2020 2020 2020 2020 2020 2020 6c61 6d62              lamb
+0000b2a0: 6461 3a20 6622 436f 6d70 6c65 7820 6772  da: f"Complex gr
+0000b2b0: 6164 2069 7320 6e6f 7420 7375 7070 6f72  ad is not suppor
+0000b2c0: 7465 6420 7965 7422 2c0a 2020 2020 2020  ted yet",.      
+0000b2d0: 2020 2020 2020 2020 2020 2020 2020 290a                ).
+0000b2e0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0000b2f0: 2020 2020 2076 7072 696d 616c 3a20 5661       vprimal: Va
+0000b300: 7269 6162 6c65 203d 2076 6172 6961 626c  riable = variabl
+0000b310: 6569 6679 2870 7269 6d61 6c29 0a20 2020  eify(primal).   
+0000b320: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000b330: 2061 6363 756d 3a20 4e6f 6e65 207c 2054   accum: None | T
+0000b340: 656e 736f 7250 726f 7879 203d 2070 7269  ensorProxy = pri
+0000b350: 6d61 6c73 5f74 6f5f 6769 6e70 7574 5f6d  mals_to_ginput_m
+0000b360: 6170 2e67 6574 2876 7072 696d 616c 2c20  ap.get(vprimal, 
+0000b370: 4e6f 6e65 290a 0a20 2020 2020 2020 2020  None)..         
+0000b380: 2020 2020 2020 2020 2020 2069 6620 6163             if ac
+0000b390: 6375 6d20 6973 204e 6f6e 653a 0a20 2020  cum is None:.   
+0000b3a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000b3b0: 2020 2020 2070 7269 6d61 6c73 5f74 6f5f       primals_to_
+0000b3c0: 6769 6e70 7574 5f6d 6170 5b76 7072 696d  ginput_map[vprim
+0000b3d0: 616c 5d20 3d20 6772 6164 0a20 2020 2020  al] = grad.     
+0000b3e0: 2020 2020 2020 2020 2020 2020 2020 2065                 e
+0000b3f0: 6c73 653a 0a20 2020 2020 2020 2020 2020  lse:.           
+0000b400: 2020 2020 2020 2020 2020 2020 2061 6363               acc
+0000b410: 756d 203d 2061 6363 756d 202b 2067 7261  um = accum + gra
+0000b420: 640a 2020 2020 2020 2020 2020 2020 2020  d.              
+0000b430: 2020 2020 2020 2020 2020 7072 696d 616c            primal
+0000b440: 735f 746f 5f67 696e 7075 745f 6d61 705b  s_to_ginput_map[
+0000b450: 7670 7269 6d61 6c5d 203d 2061 6363 756d  vprimal] = accum
+0000b460: 0a0a 2020 2020 2020 2020 2020 2020 2320  ..            # 
+0000b470: 4861 6e64 6c65 7320 6765 745f 6772 6164  Handles get_grad
+0000b480: 206f 7065 7261 7469 6f6e 730a 0a20 2020   operations..   
+0000b490: 2020 2020 2020 2020 2023 2052 6573 6574           # Reset
+0000b4a0: 7320 7468 6520 7377 6170 6d61 7020 666f  s the swapmap fo
+0000b4b0: 7220 6772 6164 730a 2020 2020 2020 2020  r grads.        
+0000b4c0: 2020 2020 7377 6170 6d61 703a 2064 6963      swapmap: dic
+0000b4d0: 745b 5661 7269 6162 6c65 2c20 5072 6f78  t[Variable, Prox
+0000b4e0: 795d 203d 207b 7d0a 0a20 2020 2020 2020  y] = {}..       
+0000b4f0: 2020 2020 2066 6f72 2062 7379 6d20 696e       for bsym in
+0000b500: 2067 7261 6474 7263 2e62 6f75 6e64 5f73   gradtrc.bound_s
+0000b510: 796d 626f 6c73 3a0a 2020 2020 2020 2020  ymbols:.        
+0000b520: 2020 2020 2020 2020 6964 3a20 4861 7368          id: Hash
+0000b530: 6162 6c65 203d 2062 7379 6d2e 7379 6d2e  able = bsym.sym.
+0000b540: 6964 0a20 2020 2020 2020 2020 2020 2020  id.             
+0000b550: 2020 2069 6620 6964 2069 7320 7069 6473     if id is pids
+0000b560: 2e47 4554 5f47 5241 443a 0a20 2020 2020  .GET_GRAD:.     
+0000b570: 2020 2020 2020 2020 2020 2020 2020 2070                 p
+0000b580: 7269 6d61 6c3a 204e 756d 6265 7220 7c20  rimal: Number | 
+0000b590: 5465 6e73 6f72 5072 6f78 790a 2020 2020  TensorProxy.    
 0000b5a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000b5b0: 2020 2076 7072 696d 616c 3a20 5661 7269     vprimal: Vari
-0000b5c0: 6162 6c65 0a20 2020 2020 2020 2020 2020  able.           
-0000b5d0: 2020 2020 2020 2020 2076 6772 6164 3a20           vgrad: 
-0000b5e0: 5661 7269 6162 6c65 0a20 2020 2020 2020  Variable.       
-0000b5f0: 2020 2020 2020 2020 2020 2020 2076 7072               vpr
-0000b600: 696d 616c 2c20 7667 7261 6420 3d20 7661  imal, vgrad = va
-0000b610: 7269 6162 6c65 6966 7928 7072 696d 616c  riableify(primal
-0000b620: 292c 2076 6172 6961 626c 6569 6679 2867  ), variableify(g
-0000b630: 7261 6429 0a0a 2020 2020 2020 2020 2020  rad)..          
-0000b640: 2020 2020 2020 2020 2020 6163 7475 616c            actual
-0000b650: 5f67 7261 643a 204e 6f6e 6520 7c20 5465  _grad: None | Te
-0000b660: 6e73 6f72 5072 6f78 7920 3d20 7072 696d  nsorProxy = prim
-0000b670: 616c 735f 746f 5f67 696e 7075 745f 6d61  als_to_ginput_ma
-0000b680: 702e 6765 7428 7670 7269 6d61 6c2c 204e  p.get(vprimal, N
-0000b690: 6f6e 6529 0a0a 2020 2020 2020 2020 2020  one)..          
-0000b6a0: 2020 2020 2020 2020 2020 2320 4e4f 5445            # NOTE
-0000b6b0: 2049 6620 6163 7475 616c 5f67 7261 6420   If actual_grad 
-0000b6c0: 6973 204e 6f6e 6520 7468 656e 2074 6865  is None then the
-0000b6d0: 7265 2773 2061 2067 6574 5f67 7261 6428  re's a get_grad(
-0000b6e0: 2920 7265 7175 6573 7420 666f 7220 6120  ) request for a 
-0000b6f0: 7465 6e73 6f72 2077 6869 6368 0a20 2020  tensor which.   
+0000b5b0: 2870 7269 6d61 6c2c 2920 3d20 6273 796d  (primal,) = bsym
+0000b5c0: 2e66 6c61 745f 6172 6773 0a20 2020 2020  .flat_args.     
+0000b5d0: 2020 2020 2020 2020 2020 2020 2020 2067                 g
+0000b5e0: 7261 643a 204e 756d 6265 7220 7c20 5465  rad: Number | Te
+0000b5f0: 6e73 6f72 5072 6f78 7920 3d20 6273 796d  nsorProxy = bsym
+0000b600: 2e6f 7574 7075 740a 0a20 2020 2020 2020  .output..       
+0000b610: 2020 2020 2020 2020 2020 2020 2076 7072               vpr
+0000b620: 696d 616c 3a20 5661 7269 6162 6c65 0a20  imal: Variable. 
+0000b630: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000b640: 2020 2076 6772 6164 3a20 5661 7269 6162     vgrad: Variab
+0000b650: 6c65 0a20 2020 2020 2020 2020 2020 2020  le.             
+0000b660: 2020 2020 2020 2076 7072 696d 616c 2c20         vprimal, 
+0000b670: 7667 7261 6420 3d20 7661 7269 6162 6c65  vgrad = variable
+0000b680: 6966 7928 7072 696d 616c 292c 2076 6172  ify(primal), var
+0000b690: 6961 626c 6569 6679 2867 7261 6429 0a0a  iableify(grad)..
+0000b6a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000b6b0: 2020 2020 6163 7475 616c 5f67 7261 643a      actual_grad:
+0000b6c0: 204e 6f6e 6520 7c20 5465 6e73 6f72 5072   None | TensorPr
+0000b6d0: 6f78 7920 3d20 7072 696d 616c 735f 746f  oxy = primals_to
+0000b6e0: 5f67 696e 7075 745f 6d61 702e 6765 7428  _ginput_map.get(
+0000b6f0: 7670 7269 6d61 6c2c 204e 6f6e 6529 0a0a  vprimal, None)..
 0000b700: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000b710: 2023 2020 2068 6173 206e 6f20 7075 745f   #   has no put_
-0000b720: 6772 6164 2829 2c20 736f 2077 6520 7265  grad(), so we re
-0000b730: 7475 726e 207a 6572 6f73 2066 6f72 2074  turn zeros for t
-0000b740: 6865 2067 7261 640a 2020 2020 2020 2020  he grad.        
-0000b750: 2020 2020 2020 2020 2020 2020 2320 544f              # TO
-0000b760: 444f 2052 6576 6973 6974 2074 6869 7320  DO Revisit this 
-0000b770: 2d2d 2063 616e 2077 6520 7265 6d6f 7665  -- can we remove
-0000b780: 2074 6865 7365 2063 6f6d 7075 7461 7469   these computati
-0000b790: 6f6e 732c 206f 7220 7573 6520 6120 7370  ons, or use a sp
-0000b7a0: 6563 6961 6c20 5a65 726f 5465 6e73 6f72  ecial ZeroTensor
-0000b7b0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0000b7c0: 2020 2020 2023 2020 2074 6f20 7369 6d70       #   to simp
-0000b7d0: 6c69 6679 2074 6865 6d3f 0a20 2020 2020  lify them?.     
-0000b7e0: 2020 2020 2020 2020 2020 2020 2020 2069                 i
-0000b7f0: 6620 6163 7475 616c 5f67 7261 6420 6973  f actual_grad is
-0000b800: 204e 6f6e 653a 0a20 2020 2020 2020 2020   None:.         
-0000b810: 2020 2020 2020 2020 2020 2020 2020 2061                 a
-0000b820: 6374 7561 6c5f 6772 6164 203d 206c 746f  ctual_grad = lto
-0000b830: 7263 682e 7a65 726f 735f 6c69 6b65 2870  rch.zeros_like(p
-0000b840: 7269 6d61 6c29 0a20 2020 2020 2020 2020  rimal).         
-0000b850: 2020 2020 2020 2020 2020 2020 2020 2070                 p
-0000b860: 7269 6d61 6c73 5f74 6f5f 6769 6e70 7574  rimals_to_ginput
-0000b870: 5f6d 6170 5b76 7072 696d 616c 5d20 3d20  _map[vprimal] = 
-0000b880: 6163 7475 616c 5f67 7261 640a 0a20 2020  actual_grad..   
-0000b890: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000b8a0: 2023 2055 7064 6174 6573 2074 6865 2067   # Updates the g
-0000b8b0: 7261 6420 616c 6961 7320 6d61 700a 2020  rad alias map.  
-0000b8c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000b8d0: 2020 7661 6374 7561 6c5f 6772 6164 3a20    vactual_grad: 
-0000b8e0: 5661 7269 6162 6c65 203d 2076 6172 6961  Variable = varia
-0000b8f0: 626c 6569 6679 2861 6374 7561 6c5f 6772  bleify(actual_gr
-0000b900: 6164 290a 2020 2020 2020 2020 2020 2020  ad).            
-0000b910: 2020 2020 2020 2020 6966 2076 6163 7475          if vactu
-0000b920: 616c 5f67 7261 6420 213d 2076 6772 6164  al_grad != vgrad
-0000b930: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-0000b940: 2020 2020 2020 2020 2020 7377 6170 6d61            swapma
-0000b950: 705b 7667 7261 645d 203d 2061 6374 7561  p[vgrad] = actua
-0000b960: 6c5f 6772 6164 0a0a 2020 2020 2020 2020  l_grad..        
-0000b970: 6669 6e61 6c6c 793a 0a20 2020 2020 2020  finally:.       
-0000b980: 2020 2020 2023 2052 6573 746f 7265 7320       # Restores 
-0000b990: 7363 6f70 650a 2020 2020 2020 2020 2020  scope.          
-0000b9a0: 2020 7265 7365 745f 7472 6163 6563 7478    reset_tracectx
-0000b9b0: 2874 7261 6365 6374 785f 746f 6b29 0a0a  (tracectx_tok)..
-0000b9c0: 2020 2020 2020 2020 2320 4669 6c74 6572          # Filter
-0000b9d0: 7320 7075 745f 6772 6164 2061 6e64 2067  s put_grad and g
-0000b9e0: 6574 5f67 7261 6420 6f70 6572 6174 696f  et_grad operatio
-0000b9f0: 6e73 2061 6e64 2061 7070 6c69 6573 2074  ns and applies t
-0000ba00: 6865 2073 7761 706d 6170 0a20 2020 2020  he swapmap.     
-0000ba10: 2020 2064 6566 205f 6669 6c74 6572 2862     def _filter(b
-0000ba20: 7379 6d3a 2042 6f75 6e64 5379 6d62 6f6c  sym: BoundSymbol
-0000ba30: 2920 2d3e 2062 6f6f 6c3a 0a20 2020 2020  ) -> bool:.     
-0000ba40: 2020 2020 2020 2069 643a 2048 6173 6861         id: Hasha
-0000ba50: 626c 6520 3d20 6273 796d 2e73 796d 2e69  ble = bsym.sym.i
-0000ba60: 640a 2020 2020 2020 2020 2020 2020 7265  d.            re
-0000ba70: 7475 726e 2069 6420 696e 2028 7069 6473  turn id in (pids
-0000ba80: 2e50 5554 5f47 5241 442c 2070 6964 732e  .PUT_GRAD, pids.
-0000ba90: 4745 545f 4752 4144 290a 0a20 2020 2020  GET_GRAD)..     
-0000baa0: 2020 2067 7261 6474 7263 2e62 6f75 6e64     gradtrc.bound
-0000bab0: 5f73 796d 626f 6c73 203d 205b 0a20 2020  _symbols = [.   
-0000bac0: 2020 2020 2020 2020 2062 7379 6d2e 6672           bsym.fr
-0000bad0: 6f6d 5f62 7379 6d5f 7377 6170 5f70 726f  om_bsym_swap_pro
-0000bae0: 7869 6573 2873 7761 706d 6170 2920 666f  xies(swapmap) fo
-0000baf0: 7220 6273 796d 2069 6e20 6772 6164 7472  r bsym in gradtr
-0000bb00: 632e 626f 756e 645f 7379 6d62 6f6c 7320  c.bound_symbols 
-0000bb10: 6966 206e 6f74 205f 6669 6c74 6572 2862  if not _filter(b
-0000bb20: 7379 6d29 0a20 2020 2020 2020 205d 0a0a  sym).        ]..
-0000bb30: 2020 2020 2020 2020 2320 5354 4550 2046          # STEP F
-0000bb40: 4f55 5220 2d2d 2d20 4f72 6465 7273 2074  OUR --- Orders t
-0000bb50: 6865 206f 7065 7261 7469 6f6e 730a 2020  he operations.  
-0000bb60: 2020 2020 2020 2320 544f 444f 2043 6f6e        # TODO Con
-0000bb70: 7369 6465 7220 616c 7465 726e 6174 6976  sider alternativ
-0000bb80: 6520 7363 6865 6475 6c69 6e67 2061 6c67  e scheduling alg
-0000bb90: 6f72 6974 686d 732c 206d 6179 6265 2062  orithms, maybe b
-0000bba0: 7920 7573 696e 6720 6772 6170 6820 6665  y using graph fe
-0000bbb0: 6174 7572 6573 0a20 2020 2020 2020 2023  atures.        #
-0000bbc0: 2020 2053 6f6d 6520 6964 6561 7320 6172     Some ideas ar
-0000bbd0: 6520 6c6f 6f6b 696e 6720 6174 206d 656d  e looking at mem
-0000bbe0: 6f72 792d 7361 7669 6e67 206e 6f64 6573  ory-saving nodes
-0000bbf0: 2c20 616e 6420 6e6f 6465 7320 7769 7468  , and nodes with
-0000bc00: 2061 2068 6967 6820 696e 2d64 6567 7265   a high in-degre
-0000bc10: 6520 6f72 2068 6967 6820 6f75 742d 6465  e or high out-de
-0000bc20: 6772 6565 0a0a 2020 2020 2020 2020 2320  gree..        # 
-0000bc30: 4372 6561 7465 7320 616e 2069 6e69 7469  Creates an initi
-0000bc40: 616c 2076 616c 6964 206f 7264 6572 696e  al valid orderin
-0000bc50: 6720 746f 2044 4345 2c20 736f 2074 6861  g to DCE, so tha
-0000bc60: 7420 6164 6469 7469 6f6e 616c 206f 7264  t additional ord
-0000bc70: 6572 696e 6720 616e 616c 7973 6973 2064  ering analysis d
-0000bc80: 6f65 736e 2774 206e 6565 6420 746f 2063  oesn't need to c
-0000bc90: 6f6e 7369 6465 7220 616c 6c20 7379 6d62  onsider all symb
-0000bca0: 6f6c 730a 2020 2020 2020 2020 726f 6f74  ols.        root
-0000bcb0: 732c 206c 6561 7665 7320 3d20 6273 796d  s, leaves = bsym
-0000bcc0: 5f6c 6973 745f 746f 5f64 6167 2867 7261  _list_to_dag(gra
-0000bcd0: 6474 7263 2e62 6f75 6e64 5f73 796d 626f  dtrc.bound_symbo
-0000bce0: 6c73 290a 2020 2020 2020 2020 6f72 6465  ls).        orde
-0000bcf0: 7265 645f 6273 796d 7320 3d20 746f 706f  red_bsyms = topo
-0000bd00: 736f 7274 5f62 7379 6d5f 6461 6728 726f  sort_bsym_dag(ro
-0000bd10: 6f74 732c 2054 4f50 4f53 4f52 545f 4f52  ots, TOPOSORT_OR
-0000bd20: 4445 522e 544f 505f 444f 574e 290a 2020  DER.TOP_DOWN).  
-0000bd30: 2020 2020 2020 6772 6164 7472 632e 626f        gradtrc.bo
-0000bd40: 756e 645f 7379 6d62 6f6c 7320 3d20 6f72  und_symbols = or
-0000bd50: 6465 7265 645f 6273 796d 730a 2020 2020  dered_bsyms.    
-0000bd60: 2020 2020 6772 6164 7472 6320 3d20 6463      gradtrc = dc
-0000bd70: 6528 6772 6164 7472 6329 0a0a 2020 2020  e(gradtrc)..    
-0000bd80: 2020 2020 2320 4964 656e 7469 6669 6573      # Identifies
-0000bd90: 2074 6865 206f 7264 6572 206f 6620 426f   the order of Bo
-0000bda0: 756e 6453 796d 626f 6c73 2075 7369 6e67  undSymbols using
-0000bdb0: 2061 2022 4446 5320 616e 6420 6368 6169   a "DFS and chai
-0000bdc0: 6e22 2061 6c67 6f72 6974 686d 0a20 2020  n" algorithm.   
-0000bdd0: 2020 2020 2023 2054 4f44 4f20 456c 6162       # TODO Elab
-0000bde0: 6f72 6174 6520 6f6e 2074 6869 7320 616c  orate on this al
-0000bdf0: 676f 7269 7468 6d20 616e 6420 7468 6520  gorithm and the 
-0000be00: 696d 706c 656d 656e 7461 7469 6f6e 0a20  implementation. 
-0000be10: 2020 2020 2020 2072 6f6f 7473 2c20 6c65         roots, le
-0000be20: 6176 6573 203d 2062 7379 6d5f 6c69 7374  aves = bsym_list
-0000be30: 5f74 6f5f 6461 6728 6772 6164 7472 632e  _to_dag(gradtrc.
-0000be40: 626f 756e 645f 7379 6d62 6f6c 7329 0a20  bound_symbols). 
-0000be50: 2020 2020 2020 2063 6865 636b 280a 2020         check(.  
-0000be60: 2020 2020 2020 2020 2020 6c65 6e28 6c65            len(le
-0000be70: 6176 6573 2920 3d3d 2031 2c0a 2020 2020  aves) == 1,.    
-0000be80: 2020 2020 2020 2020 6c61 6d62 6461 3a20          lambda: 
-0000be90: 6622 4578 7065 6374 6564 206f 6e6c 7920  f"Expected only 
-0000bea0: 6f6e 6520 6c65 6166 206e 6f64 6520 7768  one leaf node wh
-0000beb0: 656e 2073 6f72 7469 6e67 2066 6f72 2067  en sorting for g
-0000bec0: 7261 642c 2066 6f75 6e64 2074 6865 7265  rad, found there
-0000bed0: 2077 6572 6520 7b6c 656e 286c 6561 7665   were {len(leave
-0000bee0: 7329 7d20 6c65 6176 6573 222c 0a20 2020  s)} leaves",.   
-0000bef0: 2020 2020 2029 0a20 2020 2020 2020 2028       ).        (
-0000bf00: 6c65 6166 2c29 203d 206c 6561 7665 730a  leaf,) = leaves.
-0000bf10: 0a20 2020 2020 2020 2023 2043 6f6d 7075  .        # Compu
-0000bf20: 7465 7320 7468 6520 7465 6e73 6f72 206d  tes the tensor m
-0000bf30: 656d 6f72 7920 7573 6564 2062 7920 7468  emory used by th
-0000bf40: 6520 6769 7665 6e20 7079 7472 6565 0a20  e given pytree. 
-0000bf50: 2020 2020 2020 2064 6566 206d 656d 6f72         def memor
-0000bf60: 795f 7573 6564 2870 7974 7265 6529 202d  y_used(pytree) -
-0000bf70: 3e20 696e 743a 0a20 2020 2020 2020 2020  > int:.         
-0000bf80: 2020 206d 656d 6f72 795f 7573 653a 2069     memory_use: i
-0000bf90: 6e74 203d 2030 0a0a 2020 2020 2020 2020  nt = 0..        
-0000bfa0: 2020 2020 6465 6620 636f 756e 745f 6d65      def count_me
-0000bfb0: 6d6f 7279 5f75 7365 2878 293a 0a20 2020  mory_use(x):.   
-0000bfc0: 2020 2020 2020 2020 2020 2020 206e 6f6e               non
-0000bfd0: 6c6f 6361 6c20 6d65 6d6f 7279 5f75 7365  local memory_use
-0000bfe0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0000bff0: 2069 6620 6973 696e 7374 616e 6365 2878   if isinstance(x
-0000c000: 2c20 5465 6e73 6f72 5072 6f78 7929 3a0a  , TensorProxy):.
-0000c010: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000c020: 2020 2020 6d65 6d6f 7279 5f75 7365 202b      memory_use +
-0000c030: 3d20 782e 6474 7970 652e 5f62 7974 6573  = x.dtype._bytes
-0000c040: 202a 2078 2e6e 756d 656c 0a0a 2020 2020   * x.numel..    
-0000c050: 2020 2020 2020 2020 7472 6565 5f6d 6170          tree_map
-0000c060: 2863 6f75 6e74 5f6d 656d 6f72 795f 7573  (count_memory_us
-0000c070: 652c 2070 7974 7265 6529 0a20 2020 2020  e, pytree).     
-0000c080: 2020 2020 2020 2072 6574 7572 6e20 6d65         return me
-0000c090: 6d6f 7279 5f75 7365 0a0a 2020 2020 2020  mory_use..      
-0000c0a0: 2020 2320 5472 7565 2077 6865 6e20 6120    # True when a 
-0000c0b0: 6e6f 6465 2069 7320 6120 226c 696e 6b22  node is a "link"
-0000c0c0: 202d 2d20 6120 6e6f 6465 2077 6974 6820   -- a node with 
-0000c0d0: 6f6e 6c79 206f 6e65 2063 6869 6c64 2061  only one child a
-0000c0e0: 6e64 2061 7420 6d6f 7374 206f 6e65 2070  nd at most one p
-0000c0f0: 6172 656e 740a 2020 2020 2020 2020 2320  arent.        # 
-0000c100: 2020 436f 6e63 6570 7475 616c 6c79 2074    Conceptually t
-0000c110: 6865 206e 6f64 6520 6973 2061 2022 6c69  he node is a "li
-0000c120: 6e6b 2220 696e 2061 2063 6861 696e 206f  nk" in a chain o
-0000c130: 6620 6e6f 6465 7320 6c69 6b65 2041 202d  f nodes like A -
-0000c140: 3e20 4220 2d3e 2043 0a20 2020 2020 2020  > B -> C.       
-0000c150: 2064 6566 2069 735f 6c69 6e6b 286e 3a20   def is_link(n: 
-0000c160: 4e6f 6465 2920 2d3e 2062 6f6f 6c3a 0a20  Node) -> bool:. 
-0000c170: 2020 2020 2020 2020 2020 205f 6973 5f6c             _is_l
-0000c180: 696e 6b20 3d20 6c65 6e28 6e2e 6368 696c  ink = len(n.chil
-0000c190: 6472 656e 2920 3d3d 2031 2061 6e64 206c  dren) == 1 and l
-0000c1a0: 656e 286e 2e70 6172 656e 7473 2920 3c3d  en(n.parents) <=
-0000c1b0: 2031 0a20 2020 2020 2020 2020 2020 2072   1.            r
-0000c1c0: 6574 7572 6e20 5f69 735f 6c69 6e6b 0a0a  eturn _is_link..
-0000c1d0: 2020 2020 2020 2020 636f 756e 7465 723a          counter:
-0000c1e0: 2069 6e74 203d 2030 0a0a 2020 2020 2020   int = 0..      
-0000c1f0: 2020 6465 6620 5f63 6861 696e 2863 3a20    def _chain(c: 
-0000c200: 6c69 7374 5b4e 6f64 655d 2c20 656e 643a  list[Node], end:
-0000c210: 204e 6f64 6529 202d 3e20 6c69 7374 5b4e   Node) -> list[N
-0000c220: 6f64 655d 3a0a 2020 2020 2020 2020 2020  ode]:.          
-0000c230: 2020 6e6f 6e6c 6f63 616c 2063 6f75 6e74    nonlocal count
-0000c240: 6572 0a0a 2020 2020 2020 2020 2020 2020  er..            
-0000c250: 2320 544f 444f 2045 7870 6572 696d 656e  # TODO Experimen
-0000c260: 7420 7769 7468 206e 6f74 2061 6c77 6179  t with not alway
-0000c270: 7320 6675 7369 6e67 2074 6869 7320 696e  s fusing this in
-0000c280: 746f 2074 6865 2063 6f6e 7375 6d65 7220  to the consumer 
-0000c290: 2d2d 2074 6865 7265 2063 6f75 6c64 2062  -- there could b
-0000c2a0: 6520 616e 0a20 2020 2020 2020 2020 2020  e an.           
-0000c2b0: 2023 2020 2069 6e74 6572 6573 7469 6e67   #   interesting
-0000c2c0: 206d 696e 6375 740a 2020 2020 2020 2020   mincut.        
-0000c2d0: 2020 2020 2320 4e4f 5445 2049 6e20 7468      # NOTE In th
-0000c2e0: 6973 2063 6173 6520 7468 6520 6368 6169  is case the chai
-0000c2f0: 6e20 6361 6e6e 6f74 2062 6520 6578 7465  n cannot be exte
-0000c300: 6e64 6564 2c20 616e 6420 6974 7320 6f72  nded, and its or
-0000c310: 6967 696e 2069 7320 696e 7075 7420 746f  igin is input to
-0000c320: 2074 6865 2066 756e 6374 696f 6e0a 2020   the function.  
-0000c330: 2020 2020 2020 2020 2020 2320 2020 736f            #   so
-0000c340: 2074 6869 7320 6a75 7374 2066 7573 6573   this just fuses
-0000c350: 2069 7420 696e 746f 2074 6865 2063 6f6e   it into the con
-0000c360: 7375 6d65 720a 2020 2020 2020 2020 2020  sumer.          
-0000c370: 2020 6966 206c 656e 2865 6e64 2e70 6172    if len(end.par
-0000c380: 656e 7473 2920 3d3d 2030 3a0a 2020 2020  ents) == 0:.    
-0000c390: 2020 2020 2020 2020 2020 2020 666f 7220              for 
-0000c3a0: 6e20 696e 2063 3a0a 2020 2020 2020 2020  n in c:.        
-0000c3b0: 2020 2020 2020 2020 2020 2020 6e2e 6e75              n.nu
-0000c3c0: 6d62 6572 203d 2063 6f75 6e74 6572 0a20  mber = counter. 
-0000c3d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000c3e0: 2020 2063 6f75 6e74 6572 202b 3d20 310a     counter += 1.
-0000c3f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000c400: 7265 7475 726e 205b 5d0a 0a20 2020 2020  return []..     
-0000c410: 2020 2020 2020 2023 204e 4f54 4520 6c65         # NOTE le
-0000c420: 6e28 656e 642e 7061 7265 6e74 7329 203d  n(end.parents) =
-0000c430: 3d20 3120 6f6e 2074 6869 7320 7061 7468  = 1 on this path
-0000c440: 0a20 2020 2020 2020 2020 2020 2028 7061  .            (pa
-0000c450: 7265 6e74 2c29 203d 2065 6e64 2e70 6172  rent,) = end.par
-0000c460: 656e 7473 0a0a 2020 2020 2020 2020 2020  ents..          
-0000c470: 2020 2320 4578 7465 6e64 7320 7468 6520    # Extends the 
-0000c480: 6368 6169 6e20 6966 2074 6865 2070 6172  chain if the par
-0000c490: 656e 7420 6973 2061 206c 696e 6b0a 2020  ent is a link.  
-0000c4a0: 2020 2020 2020 2020 2020 6966 2069 735f            if is_
-0000c4b0: 6c69 6e6b 2870 6172 656e 7429 3a0a 2020  link(parent):.  
-0000c4c0: 2020 2020 2020 2020 2020 2020 2020 632e                c.
-0000c4d0: 6170 7065 6e64 2870 6172 656e 7429 0a20  append(parent). 
-0000c4e0: 2020 2020 2020 2020 2020 2020 2020 2072                 r
-0000c4f0: 6574 7572 6e20 5f63 6861 696e 2863 2c20  eturn _chain(c, 
-0000c500: 7061 7265 6e74 290a 0a20 2020 2020 2020  parent)..       
-0000c510: 2020 2020 2023 204e 4f54 4520 496e 2074       # NOTE In t
-0000c520: 6869 7320 6361 7365 2074 6865 2063 6861  his case the cha
-0000c530: 696e 2068 6173 2061 2070 6172 656e 7420  in has a parent 
-0000c540: 7468 6174 2069 7320 6e6f 7420 6120 6c69  that is not a li
-0000c550: 6e6b 0a20 2020 2020 2020 2020 2020 2023  nk.            #
-0000c560: 2046 696e 6473 2074 6865 206d 696e 6375   Finds the mincu
-0000c570: 740a 2020 2020 2020 2020 2020 2020 6d69  t.            mi
-0000c580: 6e63 7574 5f69 6478 3a20 696e 7420 3d20  ncut_idx: int = 
-0000c590: 6c65 6e28 6329 0a20 2020 2020 2020 2020  len(c).         
-0000c5a0: 2020 206d 696e 5f6d 656d 6f72 795f 7573     min_memory_us
-0000c5b0: 6167 653a 2069 6e74 203d 206d 656d 6f72  age: int = memor
-0000c5c0: 795f 7573 6564 2870 6172 656e 742e 6273  y_used(parent.bs
-0000c5d0: 796d 2e6f 7574 7075 7429 0a0a 2020 2020  ym.output)..    
-0000c5e0: 2020 2020 2020 2020 666f 7220 6964 782c          for idx,
-0000c5f0: 206e 2069 6e20 656e 756d 6572 6174 6528   n in enumerate(
-0000c600: 6329 3a0a 2020 2020 2020 2020 2020 2020  c):.            
-0000c610: 2020 2020 6d65 6d20 3d20 6d65 6d6f 7279      mem = memory
-0000c620: 5f75 7365 6428 6e2e 6273 796d 2e6f 7574  _used(n.bsym.out
-0000c630: 7075 7429 0a20 2020 2020 2020 2020 2020  put).           
-0000c640: 2020 2020 2069 6620 6d65 6d20 3c20 6d69       if mem < mi
-0000c650: 6e5f 6d65 6d6f 7279 5f75 7361 6765 3a0a  n_memory_usage:.
-0000c660: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000c670: 2020 2020 6d69 6e63 7574 5f69 6478 203d      mincut_idx =
-0000c680: 2069 6478 0a20 2020 2020 2020 2020 2020   idx.           
-0000c690: 2020 2020 2020 2020 206d 696e 5f6d 656d           min_mem
-0000c6a0: 6f72 795f 7573 6167 6520 3d20 6d65 6d0a  ory_usage = mem.
-0000c6b0: 0a20 2020 2020 2020 2020 2020 2066 6f72  .            for
-0000c6c0: 2069 6478 2c20 6e20 696e 2065 6e75 6d65   idx, n in enume
-0000c6d0: 7261 7465 2863 293a 0a20 2020 2020 2020  rate(c):.       
-0000c6e0: 2020 2020 2020 2020 2069 6620 6964 7820           if idx 
-0000c6f0: 3c20 6d69 6e63 7574 5f69 6478 3a0a 2020  < mincut_idx:.  
-0000c700: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000c710: 2020 6e2e 6e75 6d62 6572 203d 2063 6f75    n.number = cou
-0000c720: 6e74 6572 0a20 2020 2020 2020 2020 2020  nter.           
-0000c730: 2020 2020 2020 2020 2063 6f75 6e74 6572           counter
-0000c740: 202b 3d20 310a 0a20 2020 2020 2020 2020   += 1..         
-0000c750: 2020 2023 2052 6574 7572 6e73 2074 6865     # Returns the
-0000c760: 2070 726f 6475 6365 722d 7369 6465 2063   producer-side c
-0000c770: 6861 696e 2063 7574 2069 6620 6974 2065  hain cut if it e
-0000c780: 7869 7374 730a 2020 2020 2020 2020 2020  xists.          
-0000c790: 2020 6966 206d 696e 6375 745f 6964 7820    if mincut_idx 
-0000c7a0: 3c20 6c65 6e28 6329 3a0a 2020 2020 2020  < len(c):.      
-0000c7b0: 2020 2020 2020 2020 2020 7265 7475 726e            return
-0000c7c0: 205b 635b 6d69 6e63 7574 5f69 6478 5d5d   [c[mincut_idx]]
-0000c7d0: 0a20 2020 2020 2020 2020 2020 2065 6c73  .            els
-0000c7e0: 653a 0a20 2020 2020 2020 2020 2020 2020  e:.             
-0000c7f0: 2020 2061 7373 6572 7420 6d69 6e63 7574     assert mincut
-0000c800: 5f69 6478 203d 3d20 6c65 6e28 6329 0a20  _idx == len(c). 
-0000c810: 2020 2020 2020 2020 2020 2020 2020 2072                 r
-0000c820: 6574 7572 6e20 656e 642e 7061 7265 6e74  eturn end.parent
-0000c830: 730a 0a20 2020 2020 2020 2064 6566 2063  s..        def c
-0000c840: 6861 696e 5f6f 7574 286e 3a20 4e6f 6465  hain_out(n: Node
-0000c850: 2c20 7374 6163 6b3a 206c 6973 745b 4e6f  , stack: list[No
-0000c860: 6465 5d29 202d 3e20 4e6f 6e65 3a0a 2020  de]) -> None:.  
-0000c870: 2020 2020 2020 2020 2020 2320 5368 6f72            # Shor
-0000c880: 742d 6369 7263 7569 7473 2069 6620 7468  t-circuits if th
-0000c890: 6520 6f72 6967 696e 616c 206e 6f64 6520  e original node 
-0000c8a0: 6e20 6361 6e6e 6f74 2062 6520 7061 7274  n cannot be part
-0000c8b0: 206f 6620 6120 6368 6169 6e0a 2020 2020   of a chain.    
-0000c8c0: 2020 2020 2020 2020 6966 206e 6f74 2069          if not i
-0000c8d0: 735f 6c69 6e6b 286e 293a 0a20 2020 2020  s_link(n):.     
-0000c8e0: 2020 2020 2020 2020 2020 2073 7461 636b             stack
-0000c8f0: 2e61 7070 656e 6428 6e29 0a20 2020 2020  .append(n).     
-0000c900: 2020 2020 2020 2020 2020 2072 6574 7572             retur
-0000c910: 6e0a 0a20 2020 2020 2020 2020 2020 2023  n..            #
-0000c920: 204e 4f54 4520 6973 5f6c 696e 6b28 6e29   NOTE is_link(n)
-0000c930: 203d 3d20 5472 7565 0a20 2020 2020 2020   == True.       
-0000c940: 2020 2020 2070 6f73 745f 6368 6169 6e3a       post_chain:
-0000c950: 206c 6973 745b 4e6f 6465 5d20 3d20 5f63   list[Node] = _c
-0000c960: 6861 696e 285b 6e5d 2c20 6e29 0a0a 2020  hain([n], n)..  
-0000c970: 2020 2020 2020 2020 2020 666f 7220 7063            for pc
-0000c980: 2069 6e20 706f 7374 5f63 6861 696e 3a0a   in post_chain:.
-0000c990: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000c9a0: 7374 6163 6b2e 6170 7065 6e64 2870 6329  stack.append(pc)
-0000c9b0: 0a0a 2020 2020 2020 2020 7374 6163 6b3a  ..        stack:
-0000c9c0: 206c 6973 745b 4e6f 6465 5d20 3d20 5b6c   list[Node] = [l
-0000c9d0: 6561 665d 0a20 2020 2020 2020 2077 6869  eaf].        whi
-0000c9e0: 6c65 206c 656e 2873 7461 636b 2920 3e20  le len(stack) > 
-0000c9f0: 303a 0a20 2020 2020 2020 2020 2020 206e  0:.            n
-0000ca00: 3a20 4e6f 6465 203d 2073 7461 636b 2e70  : Node = stack.p
-0000ca10: 6f70 2829 0a0a 2020 2020 2020 2020 2020  op()..          
-0000ca20: 2020 6966 206e 2e6e 756d 6265 7220 6973    if n.number is
-0000ca30: 206e 6f74 204e 6f6e 653a 0a20 2020 2020   not None:.     
-0000ca40: 2020 2020 2020 2020 2020 2063 6f6e 7469             conti
-0000ca50: 6e75 650a 0a20 2020 2020 2020 2020 2020  nue..           
-0000ca60: 206e 2e6e 756d 6265 7220 3d20 636f 756e   n.number = coun
-0000ca70: 7465 720a 2020 2020 2020 2020 2020 2020  ter.            
-0000ca80: 636f 756e 7465 7220 2b3d 2031 0a0a 2020  counter += 1..  
-0000ca90: 2020 2020 2020 2020 2020 666f 7220 7020            for p 
-0000caa0: 696e 206e 2e70 6172 656e 7473 3a0a 2020  in n.parents:.  
-0000cab0: 2020 2020 2020 2020 2020 2020 2020 6368                ch
-0000cac0: 6169 6e5f 6f75 7428 702c 2073 7461 636b  ain_out(p, stack
-0000cad0: 290a 0a20 2020 2020 2020 2064 6566 205f  )..        def _
-0000cae0: 7365 6c65 6374 6f72 2865 6c69 6769 626c  selector(eligibl
-0000caf0: 655f 6e6f 6465 733a 206c 6973 745b 4e6f  e_nodes: list[No
-0000cb00: 6465 5d29 202d 3e20 696e 743a 0a20 2020  de]) -> int:.   
-0000cb10: 2020 2020 2020 2020 206d 696e 5f69 6478           min_idx
-0000cb20: 3a20 696e 7420 3d20 300a 2020 2020 2020  : int = 0.      
-0000cb30: 2020 2020 2020 6d69 6e5f 6e75 6d62 6572        min_number
-0000cb40: 3a20 696e 7420 3d20 656c 6967 6962 6c65  : int = eligible
-0000cb50: 5f6e 6f64 6573 5b30 5d2e 6e75 6d62 6572  _nodes[0].number
-0000cb60: 0a0a 2020 2020 2020 2020 2020 2020 2320  ..            # 
-0000cb70: 4e4f 5445 2041 6c74 686f 7567 6820 7765  NOTE Although we
-0000cb80: 2776 6520 616c 7265 6164 7920 7072 6f63  've already proc
-0000cb90: 6573 7365 6420 7468 6520 6669 7273 7420  essed the first 
-0000cba0: 656c 656d 656e 7420 6865 7265 2c20 7468  element here, th
-0000cbb0: 6973 2073 7469 6c6c 0a20 2020 2020 2020  is still.       
-0000cbc0: 2020 2020 2023 2020 2065 6e75 6d65 7261       #   enumera
-0000cbd0: 7465 7320 7468 6520 656e 7469 7265 206c  tes the entire l
-0000cbe0: 6973 7420 6320 746f 2061 6c69 676e 2074  ist c to align t
-0000cbf0: 6865 2065 6e75 6d65 7261 7469 6f6e 2069  he enumeration i
-0000cc00: 6478 2070 726f 7065 726c 790a 2020 2020  dx properly.    
-0000cc10: 2020 2020 2020 2020 666f 7220 6964 782c          for idx,
-0000cc20: 206e 2069 6e20 656e 756d 6572 6174 6528   n in enumerate(
-0000cc30: 656c 6967 6962 6c65 5f6e 6f64 6573 293a  eligible_nodes):
-0000cc40: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0000cc50: 2063 6865 636b 286e 2e6e 756d 6265 7220   check(n.number 
-0000cc60: 6973 206e 6f74 204e 6f6e 652c 206c 616d  is not None, lam
-0000cc70: 6264 613a 2066 2245 7870 6563 7465 6420  bda: f"Expected 
-0000cc80: 6561 6368 206e 6f64 6520 746f 2062 6520  each node to be 
-0000cc90: 6e75 6d62 6572 6564 2c20 6275 7420 7b6e  numbered, but {n
-0000cca0: 7d20 7761 7320 6e6f 7422 290a 0a20 2020  } was not")..   
-0000ccb0: 2020 2020 2020 2020 2020 2020 2069 6620               if 
-0000ccc0: 6e2e 6e75 6d62 6572 203c 206d 696e 5f6e  n.number < min_n
-0000ccd0: 756d 6265 723a 0a20 2020 2020 2020 2020  umber:.         
-0000cce0: 2020 2020 2020 2020 2020 206d 696e 5f69             min_i
-0000ccf0: 6478 203d 2069 6478 0a20 2020 2020 2020  dx = idx.       
-0000cd00: 2020 2020 2020 2020 2020 2020 206d 696e               min
-0000cd10: 5f6e 756d 6265 7220 3d20 6e2e 6e75 6d62  _number = n.numb
-0000cd20: 6572 0a0a 2020 2020 2020 2020 2020 2020  er..            
-0000cd30: 7265 7475 726e 206d 696e 5f69 6478 0a0a  return min_idx..
-0000cd40: 2020 2020 2020 2020 736f 7274 6564 5f62          sorted_b
-0000cd50: 7379 6d73 203d 2074 6f70 6f73 6f72 745f  syms = toposort_
-0000cd60: 6273 796d 5f64 6167 286c 6561 7665 732c  bsym_dag(leaves,
-0000cd70: 2074 6f70 6f73 6f72 745f 6f72 6465 723d   toposort_order=
-0000cd80: 544f 504f 534f 5254 5f4f 5244 4552 2e42  TOPOSORT_ORDER.B
-0000cd90: 4f54 544f 4d5f 5550 2c20 7365 6c65 6374  OTTOM_UP, select
-0000cda0: 6f72 3d5f 7365 6c65 6374 6f72 290a 2020  or=_selector).  
-0000cdb0: 2020 2020 2020 6772 6164 7472 632e 626f        gradtrc.bo
-0000cdc0: 756e 645f 7379 6d62 6f6c 7320 3d20 736f  und_symbols = so
-0000cdd0: 7274 6564 5f62 7379 6d73 0a20 2020 2020  rted_bsyms.     
-0000cde0: 2020 2067 7261 6474 7263 203d 2064 6365     gradtrc = dce
-0000cdf0: 2867 7261 6474 7263 290a 0a20 2020 2020  (gradtrc)..     
-0000ce00: 2020 2023 2054 4f44 4f20 436f 6e73 6964     # TODO Consid
-0000ce10: 6572 2068 6f77 2074 6f20 6861 6e64 6c65  er how to handle
-0000ce20: 2067 7261 6420 772e 722e 742e 206f 6e6c   grad w.r.t. onl
-0000ce30: 7920 736f 6d65 206f 7574 7075 7473 202d  y some outputs -
-0000ce40: 2d20 7368 6f75 6c64 2061 6c6c 2067 7261  - should all gra
-0000ce50: 640a 2020 2020 2020 2020 2320 2020 6f70  d.        #   op
-0000ce60: 6572 6174 696f 6e73 2075 7369 6e67 2074  erations using t
-0000ce70: 6865 206f 7468 6572 206f 7574 7075 7420  he other output 
-0000ce80: 6265 2072 656d 6f76 6564 3f20 5768 6174  be removed? What
-0000ce90: 206b 696e 6420 6f66 2061 7373 756d 7074   kind of assumpt
-0000cea0: 696f 6e20 646f 6573 2074 6861 740a 2020  ion does that.  
-0000ceb0: 2020 2020 2020 2320 2020 6d61 6b65 2061        #   make a
-0000cec0: 626f 7574 2074 6865 2067 7261 6420 7374  bout the grad st
-0000ced0: 7275 6374 7572 653f 2050 726f 6261 626c  ructure? Probabl
-0000cee0: 7920 736f 6d65 206b 696e 6420 6f66 2069  y some kind of i
-0000cef0: 6e64 6570 656e 6465 6e63 6520 6173 7375  ndependence assu
-0000cf00: 6d70 7469 6f6e 3f20 4172 650a 2020 2020  mption? Are.    
-0000cf10: 2020 2020 2320 2020 7468 6572 6520 7072      #   there pr
-0000cf20: 6163 7469 6361 6c20 6578 616d 706c 6573  actical examples
-0000cf30: 2077 6865 7265 2074 6861 7427 7320 616e   where that's an
-0000cf40: 2069 7373 7565 3f0a 0a20 2020 2020 2020   issue?..       
-0000cf50: 2065 6e64 5f74 696d 655f 6e73 203d 2074   end_time_ns = t
-0000cf60: 696d 652e 7469 6d65 5f6e 7328 290a 2020  ime.time_ns().  
-0000cf70: 2020 2020 2020 656c 6170 7365 645f 7469        elapsed_ti
-0000cf80: 6d65 5f6e 7320 3d20 656e 645f 7469 6d65  me_ns = end_time
-0000cf90: 5f6e 7320 2d20 7374 6172 745f 7469 6d65  _ns - start_time
-0000cfa0: 5f6e 730a 2020 2020 2020 2020 656c 6170  _ns.        elap
-0000cfb0: 7365 645f 7469 6d65 5f6d 696c 6c69 7320  sed_time_millis 
-0000cfc0: 3d20 656c 6170 7365 645f 7469 6d65 5f6e  = elapsed_time_n
-0000cfd0: 7320 2f2f 2031 3030 3030 3030 0a20 2020  s // 1000000.   
-0000cfe0: 2020 2020 2067 7261 6474 7263 2e73 6574       gradtrc.set
-0000cff0: 5f70 726f 7665 6e61 6e63 6528 5472 6163  _provenance(Trac
-0000d000: 6550 726f 7665 6e61 6e63 6528 6622 4772  eProvenance(f"Gr
-0000d010: 6164 2028 746f 6f6b 207b 656c 6170 7365  ad (took {elapse
-0000d020: 645f 7469 6d65 5f6d 696c 6c69 737d 206d  d_time_millis} m
-0000d030: 696c 6c69 7365 636f 6e64 7329 2229 290a  illiseconds)")).
-0000d040: 0a20 2020 2020 2020 2072 6574 7572 6e20  .        return 
-0000d050: 6772 6164 7472 630a 0a20 2020 2023 204e  gradtrc..    # N
-0000d060: 4f54 4520 5468 6973 2069 7320 6120 6b6c  OTE This is a kl
-0000d070: 7564 6765 2074 6f20 696e 6469 6361 7465  udge to indicate
-0000d080: 2074 6861 7420 7765 2073 686f 756c 646e   that we shouldn
-0000d090: 2774 2075 7365 2050 7954 6f72 6368 2773  't use PyTorch's
-0000d0a0: 2061 7574 6f67 7261 6420 6265 6361 7573   autograd becaus
-0000d0b0: 650a 2020 2020 2320 2020 7765 2772 6520  e.    #   we're 
-0000d0c0: 7573 696e 6720 6f75 7220 6f77 6e20 6175  using our own au
-0000d0d0: 746f 6772 6164 2074 7261 6e73 666f 726d  tograd transform
-0000d0e0: 0a20 2020 2063 666e 2e5f 7573 696e 675f  .    cfn._using_
-0000d0f0: 6772 6164 5f74 7261 6e73 666f 726d 203d  grad_transform =
-0000d100: 2054 7275 650a 0a20 2020 2072 6574 7572   True..    retur
-0000d110: 6e20 6164 645f 7472 616e 7366 6f72 6d28  n add_transform(
-0000d120: 6366 6e2c 205f 6772 6164 5f74 7261 6e73  cfn, _grad_trans
-0000d130: 666f 726d 290a 0a0a 6465 6620 6772 6164  form)...def grad
-0000d140: 5f76 3128 0a20 2020 2063 666e 2c0a 2920  _v1(.    cfn,.) 
-0000d150: 2d3e 2043 616c 6c61 626c 653a 0a20 2020  -> Callable:.   
-0000d160: 2064 6566 2067 7261 6428 6675 6e63 293a   def grad(func):
-0000d170: 0a20 2020 2020 2020 2064 6566 2067 7261  .        def gra
-0000d180: 645f 6675 6e63 282a 6172 6773 2c20 2a2a  d_func(*args, **
-0000d190: 6b77 6172 6773 293a 0a20 2020 2020 2020  kwargs):.       
-0000d1a0: 2020 2020 205f 2c20 6772 6164 7320 3d20       _, grads = 
-0000d1b0: 7661 6c75 655f 616e 645f 6772 6164 2866  value_and_grad(f
-0000d1c0: 756e 6329 282a 6172 6773 2c20 2a2a 6b77  unc)(*args, **kw
-0000d1d0: 6172 6773 290a 2020 2020 2020 2020 2020  args).          
-0000d1e0: 2020 6772 6164 7320 3d20 5b67 2066 6f72    grads = [g for
-0000d1f0: 2067 2069 6e20 6772 6164 7320 6966 2067   g in grads if g
-0000d200: 2069 7320 6e6f 7420 4e6f 6e65 5d0a 2020   is not None].  
-0000d210: 2020 2020 2020 2020 2020 7265 7475 726e            return
-0000d220: 2067 7261 6473 0a0a 2020 2020 2020 2020   grads..        
-0000d230: 7265 7475 726e 2067 7261 645f 6675 6e63  return grad_func
-0000d240: 0a0a 2020 2020 6465 6620 5f67 7261 645f  ..    def _grad_
-0000d250: 7472 616e 7366 6f72 6d28 7472 633a 2054  transform(trc: T
-0000d260: 7261 6365 2c20 2a2c 2065 7865 6375 746f  race, *, executo
-0000d270: 7273 5f6c 6973 743a 2053 6571 7565 6e63  rs_list: Sequenc
-0000d280: 655b 416e 795d 2920 2d3e 2054 7261 6365  e[Any]) -> Trace
-0000d290: 3a0a 2020 2020 2020 2020 6772 6164 7472  :.        gradtr
-0000d2a0: 6320 3d20 636f 6e73 7472 7563 745f 7472  c = construct_tr
-0000d2b0: 6163 6528 2928 6772 6164 2874 7263 2e70  ace()(grad(trc.p
-0000d2c0: 7974 686f 6e5f 6361 6c6c 6162 6c65 2829  ython_callable()
-0000d2d0: 292c 202a 7472 632e 6172 6773 2c20 2a2a  ), *trc.args, **
-0000d2e0: 7472 632e 6b77 6172 6773 290a 2020 2020  trc.kwargs).    
-0000d2f0: 2020 2020 7265 7475 726e 2067 7261 6474      return gradt
-0000d300: 7263 0a0a 2020 2020 6366 6e2e 5f75 7369  rc..    cfn._usi
-0000d310: 6e67 5f67 7261 645f 7472 616e 7366 6f72  ng_grad_transfor
-0000d320: 6d20 3d20 5472 7565 0a20 2020 2072 6574  m = True.    ret
-0000d330: 7572 6e20 6164 645f 7472 616e 7366 6f72  urn add_transfor
-0000d340: 6d28 6366 6e2c 205f 6772 6164 5f74 7261  m(cfn, _grad_tra
-0000d350: 6e73 666f 726d 290a 0a0a 636c 6173 7320  nsform)...class 
-0000d360: 5472 616e 7366 6f72 6d73 2845 6e75 6d29  Transforms(Enum)
-0000d370: 3a0a 2020 2020 4964 656e 7469 7479 4f70  :.    IdentityOp
-0000d380: 203d 2061 7574 6f28 290a 2020 2020 566d   = auto().    Vm
-0000d390: 6170 4f70 203d 2061 7574 6f28 290a 2020  apOp = auto().  
-0000d3a0: 2020 4a76 704f 7020 3d20 6175 746f 2829    JvpOp = auto()
-0000d3b0: 0a20 2020 2056 6a70 4f70 203d 2061 7574  .    VjpOp = aut
-0000d3c0: 6f28 290a 0a0a 406c 7275 5f63 6163 6865  o()...@lru_cache
-0000d3d0: 286d 6178 7369 7a65 3d4e 6f6e 6529 0a64  (maxsize=None).d
-0000d3e0: 6566 2073 796d 626f 6c5f 746f 5f65 7661  ef symbol_to_eva
-0000d3f0: 6c28 626f 756e 645f 7379 6d62 6f6c 293a  l(bound_symbol):
-0000d400: 0a20 2020 2022 2222 4d61 7020 6120 426f  .    """Map a Bo
-0000d410: 756e 6453 796d 626f 6c20 746f 2061 2066  undSymbol to a f
-0000d420: 756e 6374 696f 6e20 7468 6174 2065 7661  unction that eva
-0000d430: 6c75 6174 6573 2069 742e 0a0a 2020 2020  luates it...    
-0000d440: 4172 6773 3a0a 2020 2020 2020 2020 626f  Args:.        bo
-0000d450: 756e 645f 7379 6d62 6f6c 3a20 426f 756e  und_symbol: Boun
-0000d460: 6453 796d 626f 6c20 746f 206d 6170 0a20  dSymbol to map. 
-0000d470: 2020 2022 2222 0a20 2020 2023 2053 796d     """.    # Sym
-0000d480: 626f 6c20 6973 2063 616c 6c61 626c 650a  bol is callable.
-0000d490: 2020 2020 7265 7475 726e 2062 6f75 6e64      return bound
-0000d4a0: 5f73 796d 626f 6c2e 7379 6d0a 0a0a 2320  _symbol.sym...# 
-0000d4b0: 544f 444f 3a20 4375 7272 656e 746c 7920  TODO: Currently 
-0000d4c0: 7765 2075 7365 2074 7261 6365 2e61 7267  we use trace.arg
-0000d4d0: 7320 616e 6420 7472 6163 652e 6b77 6172  s and trace.kwar
-0000d4e0: 6773 2074 6f20 6765 7420 7468 6520 6172  gs to get the ar
-0000d4f0: 6775 6d65 6e74 730a 2320 4d61 7962 6520  guments.# Maybe 
-0000d500: 7765 2073 686f 756c 6420 7573 6520 7468  we should use th
-0000d510: 6573 6520 696e 7374 6561 640a 7472 616e  ese instead.tran
-0000d520: 7366 6f72 6d5f 736b 6970 5f6c 6973 7420  sform_skip_list 
-0000d530: 3d20 280a 2020 2020 7072 696d 732e 5072  = (.    prims.Pr
-0000d540: 696d 4944 732e 554e 5041 434b 5f45 4d50  imIDs.UNPACK_EMP
-0000d550: 5459 5f44 4943 542c 0a20 2020 2070 7269  TY_DICT,.    pri
-0000d560: 6d73 2e50 7269 6d49 4473 2e55 4e50 4143  ms.PrimIDs.UNPAC
-0000d570: 4b5f 4b45 592c 0a20 2020 2070 7269 6d73  K_KEY,.    prims
-0000d580: 2e50 7269 6d49 4473 2e55 4e50 4143 4b5f  .PrimIDs.UNPACK_
-0000d590: 5345 5155 454e 4345 2c0a 2020 2020 7072  SEQUENCE,.    pr
-0000d5a0: 696d 732e 5072 696d 4944 732e 554e 5041  ims.PrimIDs.UNPA
-0000d5b0: 434b 5f54 5249 5649 414c 2c0a 2020 2020  CK_TRIVIAL,.    
-0000d5c0: 7072 696d 732e 5072 696d 4944 732e 5245  prims.PrimIDs.RE
-0000d5d0: 5455 524e 2c0a 290a 0a0a 6465 6620 6576  TURN,.)...def ev
-0000d5e0: 616c 5f74 7261 6365 2874 7261 6365 2c20  al_trace(trace, 
-0000d5f0: 2a61 7267 732c 2073 796d 626f 6c5f 6d61  *args, symbol_ma
-0000d600: 7070 6572 3d73 796d 626f 6c5f 746f 5f65  pper=symbol_to_e
-0000d610: 7661 6c2c 2077 6974 685f 656e 763d 4661  val, with_env=Fa
-0000d620: 6c73 652c 202a 2a6b 7761 7267 7329 3a0a  lse, **kwargs):.
-0000d630: 2020 2020 2222 2245 7661 6c75 6174 6520      """Evaluate 
-0000d640: 6120 7472 6163 652e 0a0a 2020 2020 4172  a trace...    Ar
-0000d650: 6773 3a0a 2020 2020 2020 2020 7472 6163  gs:.        trac
-0000d660: 653a 2074 7261 6365 2074 6f20 6576 616c  e: trace to eval
-0000d670: 7561 7465 0a20 2020 2020 2020 202a 6172  uate.        *ar
-0000d680: 6773 3a20 6172 6775 6d65 6e74 7320 746f  gs: arguments to
-0000d690: 2065 7661 6c75 6174 6520 7468 6520 7472   evaluate the tr
-0000d6a0: 6163 6520 7769 7468 0a20 2020 2020 2020  ace with.       
-0000d6b0: 2073 796d 626f 6c5f 6d61 7070 6572 3a20   symbol_mapper: 
-0000d6c0: 6675 6e63 7469 6f6e 2074 6861 7420 6d61  function that ma
-0000d6d0: 7073 2061 2073 796d 626f 6c20 746f 2061  ps a symbol to a
-0000d6e0: 2066 756e 6374 696f 6e20 7468 6174 2065   function that e
-0000d6f0: 7661 6c75 6174 6573 2069 740a 2020 2020  valuates it.    
-0000d700: 2020 2020 2a2a 6b77 6172 6773 3a20 6b65      **kwargs: ke
-0000d710: 7977 6f72 6420 6172 6775 6d65 6e74 7320  yword arguments 
-0000d720: 746f 2065 7661 6c75 6174 6520 7468 6520  to evaluate the 
-0000d730: 7472 6163 6520 7769 7468 0a0a 2020 2020  trace with..    
-0000d740: 5265 7475 726e 733a 0a20 2020 2020 2020  Returns:.       
-0000d750: 2072 6573 756c 7420 6f66 2065 7661 6c75   result of evalu
-0000d760: 6174 696e 6720 7468 6520 7472 6163 650a  ating the trace.
-0000d770: 2020 2020 2222 220a 2020 2020 656e 7620      """.    env 
-0000d780: 3d20 7b7d 0a0a 2020 2020 6465 6620 7265  = {}..    def re
-0000d790: 6164 2878 3a20 5661 7269 6162 6c65 293a  ad(x: Variable):
-0000d7a0: 0a20 2020 2020 2020 2069 6620 6973 696e  .        if isin
-0000d7b0: 7374 616e 6365 2878 2c20 5661 7269 6162  stance(x, Variab
-0000d7c0: 6c65 293a 0a20 2020 2020 2020 2020 2020  le):.           
-0000d7d0: 2072 6574 7572 6e20 656e 765b 782e 6e61   return env[x.na
-0000d7e0: 6d65 5d0a 2020 2020 2020 2020 656c 7365  me].        else
-0000d7f0: 3a0a 2020 2020 2020 2020 2020 2020 7265  :.            re
-0000d800: 7475 726e 2078 0a0a 2020 2020 6465 6620  turn x..    def 
-0000d810: 7772 6974 6528 763a 2056 6172 6961 626c  write(v: Variabl
-0000d820: 652c 2076 616c 3a20 416e 792c 2061 6c6c  e, val: Any, all
-0000d830: 6f77 5f64 7570 6c69 6361 7465 733d 4661  ow_duplicates=Fa
-0000d840: 6c73 6529 202d 3e20 4e6f 6e65 3a0a 2020  lse) -> None:.  
-0000d850: 2020 2020 2020 6966 206e 6f74 2069 7369        if not isi
-0000d860: 6e73 7461 6e63 6528 762c 2056 6172 6961  nstance(v, Varia
-0000d870: 626c 6529 3a0a 2020 2020 2020 2020 2020  ble):.          
-0000d880: 2020 7265 7475 726e 0a20 2020 2020 2020    return.       
-0000d890: 2023 2044 7570 6c69 6361 7465 7320 6172   # Duplicates ar
-0000d8a0: 6520 616c 6c6f 7765 6420 616e 6420 6f76  e allowed and ov
-0000d8b0: 6572 7772 6974 7465 6e0a 2020 2020 2020  erwritten.      
-0000d8c0: 2020 6966 2076 2e6e 616d 6520 696e 2065    if v.name in e
-0000d8d0: 6e76 3a0a 2020 2020 2020 2020 2020 2020  nv:.            
-0000d8e0: 6966 2061 6c6c 6f77 5f64 7570 6c69 6361  if allow_duplica
-0000d8f0: 7465 733a 0a20 2020 2020 2020 2020 2020  tes:.           
-0000d900: 2020 2020 2072 6574 7572 6e0a 2020 2020       return.    
-0000d910: 2020 2020 2020 2020 7261 6973 6520 5661          raise Va
-0000d920: 6c75 6545 7272 6f72 2866 2256 6172 6961  lueError(f"Varia
-0000d930: 626c 6520 7b76 2e6e 616d 657d 2069 7320  ble {v.name} is 
-0000d940: 6265 696e 6720 6f76 6572 7772 6974 7465  being overwritte
-0000d950: 6e20 7468 6973 2069 7320 6e6f 7420 616c  n this is not al
-0000d960: 6c6f 7765 6422 290a 2020 2020 2020 2020  lowed").        
-0000d970: 656e 765b 762e 6e61 6d65 5d20 3d20 7661  env[v.name] = va
-0000d980: 6c0a 0a20 2020 2073 6166 655f 6d61 705f  l..    safe_map_
-0000d990: 666c 6174 2877 7269 7465 2c20 6c69 7374  flat(write, list
-0000d9a0: 2874 7261 6365 2e61 7267 7329 2c20 6c69  (trace.args), li
-0000d9b0: 7374 2861 7267 7329 290a 2020 2020 7361  st(args)).    sa
-0000d9c0: 6665 5f6d 6170 5f66 6c61 7428 7772 6974  fe_map_flat(writ
-0000d9d0: 652c 206c 6973 7428 7472 6163 652e 6b77  e, list(trace.kw
-0000d9e0: 6172 6773 2e76 616c 7565 7328 2929 2c20  args.values()), 
-0000d9f0: 6c69 7374 286b 7761 7267 732e 7661 6c75  list(kwargs.valu
-0000da00: 6573 2829 2929 0a0a 2020 2020 666f 7220  es()))..    for 
-0000da10: 7379 6d62 6f6c 2069 6e20 7472 6163 652e  symbol in trace.
-0000da20: 626f 756e 645f 7379 6d62 6f6c 733a 0a20  bound_symbols:. 
-0000da30: 2020 2020 2020 2069 6620 7379 6d62 6f6c         if symbol
-0000da40: 2e73 796d 2e69 6420 696e 2074 7261 6e73  .sym.id in trans
-0000da50: 666f 726d 5f73 6b69 705f 6c69 7374 3a0a  form_skip_list:.
-0000da60: 2020 2020 2020 2020 2020 2020 636f 6e74              cont
-0000da70: 696e 7565 0a20 2020 2020 2020 2061 7267  inue.        arg
-0000da80: 7320 3d20 7472 6565 5f6d 6170 2872 6561  s = tree_map(rea
-0000da90: 642c 2073 796d 626f 6c2e 6172 6773 290a  d, symbol.args).
-0000daa0: 2020 2020 2020 2020 6b77 6172 6773 203d          kwargs =
-0000dab0: 2074 7265 655f 6d61 7028 7265 6164 2c20   tree_map(read, 
-0000dac0: 7379 6d62 6f6c 2e6b 7761 7267 7329 0a20  symbol.kwargs). 
-0000dad0: 2020 2020 2020 2070 7269 6d5f 6675 6e63         prim_func
-0000dae0: 203d 2073 796d 626f 6c5f 6d61 7070 6572   = symbol_mapper
-0000daf0: 2873 796d 626f 6c29 0a20 2020 2020 2020  (symbol).       
-0000db00: 2069 6620 7072 696d 5f66 756e 6320 6973   if prim_func is
-0000db10: 204e 6f6e 653a 0a20 2020 2020 2020 2020   None:.         
-0000db20: 2020 2063 6f6e 7469 6e75 650a 2020 2020     continue.    
-0000db30: 2020 2020 7265 7375 6c74 203d 2070 7269      result = pri
-0000db40: 6d5f 6675 6e63 282a 6172 6773 2c20 2a2a  m_func(*args, **
-0000db50: 6b77 6172 6773 290a 2020 2020 2020 2020  kwargs).        
-0000db60: 7361 6665 5f6d 6170 5f66 6c61 7428 7772  safe_map_flat(wr
-0000db70: 6974 652c 206c 6973 7428 7365 7175 656e  ite, list(sequen
-0000db80: 6369 6679 2873 796d 626f 6c2e 6f75 7470  cify(symbol.outp
-0000db90: 7574 2929 2c20 6c69 7374 2873 6571 7565  ut)), list(seque
-0000dba0: 6e63 6966 7928 7265 7375 6c74 2929 290a  ncify(result))).
-0000dbb0: 0a20 2020 2069 6620 7769 7468 5f65 6e76  .    if with_env
-0000dbc0: 3a0a 2020 2020 2020 2020 7265 7475 726e  :.        return
-0000dbd0: 2074 7265 655f 6d61 7028 7265 6164 2c20   tree_map(read, 
-0000dbe0: 7472 6163 652e 6f75 7470 7574 292c 2065  trace.output), e
-0000dbf0: 6e76 0a0a 2020 2020 7265 7475 726e 2074  nv..    return t
-0000dc00: 7265 655f 6d61 7028 7265 6164 2c20 7472  ree_map(read, tr
-0000dc10: 6163 652e 6f75 7470 7574 290a 0a0a 6465  ace.output)...de
-0000dc20: 6620 5f69 6465 6e74 6974 795f 6361 6c6c  f _identity_call
-0000dc30: 5f6d 6574 6166 756e 6328 2a61 7267 732c  _metafunc(*args,
-0000dc40: 2074 7261 6365 3a20 5472 6163 652c 202a   trace: Trace, *
-0000dc50: 2a6b 7761 7267 7329 3a0a 2020 2020 7769  *kwargs):.    wi
-0000dc60: 7468 2064 6574 6163 6865 645f 7472 6163  th detached_trac
-0000dc70: 6528 293a 0a20 2020 2020 2020 2072 6574  e():.        ret
-0000dc80: 7572 6e20 6576 616c 5f74 7261 6365 2874  urn eval_trace(t
-0000dc90: 7261 6365 2c20 2a61 7267 732c 202a 2a6b  race, *args, **k
-0000dca0: 7761 7267 7329 0a0a 0a69 6465 6e74 6974  wargs)...identit
-0000dcb0: 795f 6361 6c6c 203d 2053 796d 626f 6c28  y_call = Symbol(
-0000dcc0: 6964 3d54 7261 6e73 666f 726d 732e 4964  id=Transforms.Id
-0000dcd0: 656e 7469 7479 4f70 2c20 6e61 6d65 3d22  entityOp, name="
-0000dce0: 6964 656e 7469 7479 5f63 616c 6c22 2c20  identity_call", 
-0000dcf0: 6d65 7461 3d5f 6964 656e 7469 7479 5f63  meta=_identity_c
-0000dd00: 616c 6c5f 6d65 7461 6675 6e63 290a 0a0a  all_metafunc)...
-0000dd10: 6465 6620 6964 656e 7469 7479 2866 756e  def identity(fun
-0000dd20: 6329 3a0a 2020 2020 2222 2249 6465 6e74  c):.    """Ident
-0000dd30: 6974 7920 7472 616e 7366 6f72 6d20 666f  ity transform fo
-0000dd40: 7220 6120 5468 756e 6465 7220 6675 6e63  r a Thunder func
-0000dd50: 7469 6f6e 2e0a 0a20 2020 2041 7267 733a  tion...    Args:
-0000dd60: 0a20 2020 2020 2020 2066 756e 6320 2843  .        func (C
-0000dd70: 616c 6c61 626c 6529 3a20 4120 5468 756e  allable): A Thun
-0000dd80: 6465 7220 6675 6e63 7469 6f6e 2074 6f20  der function to 
-0000dd90: 6265 2074 7261 6e73 666f 726d 6564 2e0a  be transformed..
-0000dda0: 2020 2020 2222 220a 0a20 2020 2064 6566      """..    def
-0000ddb0: 2077 7261 7070 6572 282a 6172 6773 2c20   wrapper(*args, 
-0000ddc0: 2a2a 6b77 6172 6773 293a 0a20 2020 2020  **kwargs):.     
-0000ddd0: 2020 2074 7261 6365 203d 2063 6f6e 7374     trace = const
-0000dde0: 7275 6374 5f74 7261 6365 2829 2866 756e  ruct_trace()(fun
-0000ddf0: 632c 202a 6172 6773 2c20 2a2a 6b77 6172  c, *args, **kwar
-0000de00: 6773 290a 2020 2020 2020 2020 7265 7475  gs).        retu
-0000de10: 726e 2069 6465 6e74 6974 795f 6361 6c6c  rn identity_call
-0000de20: 282a 6172 6773 2c20 2a2a 6b77 6172 6773  (*args, **kwargs
-0000de30: 2c20 7472 6163 653d 7472 6163 6529 0a0a  , trace=trace)..
-0000de40: 2020 2020 7265 7475 726e 2077 7261 7070      return wrapp
-0000de50: 6572 0a0a 0a64 6566 205f 6964 656e 7469  er...def _identi
-0000de60: 7479 5f63 616c 6c5f 7079 746f 7263 6828  ty_call_pytorch(
-0000de70: 2a61 7267 732c 2074 7261 6365 3a20 5472  *args, trace: Tr
-0000de80: 6163 652c 202a 2a6b 7761 7267 7329 3a0a  ace, **kwargs):.
-0000de90: 2020 2020 696d 706f 7274 2074 6f72 6368      import torch
-0000dea0: 0a0a 2020 2020 6465 6620 7379 6d62 6f6c  ..    def symbol
-0000deb0: 5f6d 6170 7065 7228 6f70 293a 0a20 2020  _mapper(op):.   
-0000dec0: 2020 2020 2069 6620 6f70 2e6f 7020 3d3d       if op.op ==
-0000ded0: 2054 7261 6e73 666f 726d 732e 4964 656e   Transforms.Iden
-0000dee0: 7469 7479 4f70 3a0a 2020 2020 2020 2020  tityOp:.        
-0000def0: 2020 2020 7265 7475 726e 205f 6964 656e      return _iden
-0000df00: 7469 7479 5f63 616c 6c5f 7079 746f 7263  tity_call_pytorc
-0000df10: 680a 0a20 2020 2020 2020 2074 6f72 6368  h..        torch
-0000df20: 5f6f 7020 3d20 6f70 735f 746f 5f74 6f72  _op = ops_to_tor
-0000df30: 6368 5f6f 7073 5f6d 6170 5b6f 702e 6f70  ch_ops_map[op.op
-0000df40: 5d0a 2020 2020 2020 2020 6966 2069 7369  ].        if isi
-0000df50: 6e73 7461 6e63 6528 746f 7263 685f 6f70  nstance(torch_op
-0000df60: 2c20 7374 7229 3a0a 2020 2020 2020 2020  , str):.        
-0000df70: 2020 2020 7265 7475 726e 2067 6574 6174      return getat
-0000df80: 7472 2874 6f72 6368 2c20 746f 7263 685f  tr(torch, torch_
-0000df90: 6f70 2e73 7472 6970 2822 7079 746f 7263  op.strip("pytorc
-0000dfa0: 682e 2229 290a 2020 2020 2020 2020 7265  h.")).        re
-0000dfb0: 7475 726e 2074 6f72 6368 5f6f 700a 0a20  turn torch_op.. 
-0000dfc0: 2020 2077 6974 6820 6465 7461 6368 6564     with detached
-0000dfd0: 5f74 7261 6365 2829 3a0a 2020 2020 2020  _trace():.      
-0000dfe0: 2020 7265 7475 726e 2065 7661 6c5f 7472    return eval_tr
-0000dff0: 6163 6528 7472 6163 652c 202a 6172 6773  ace(trace, *args
-0000e000: 2c20 2a2a 6b77 6172 6773 2c20 7379 6d62  , **kwargs, symb
-0000e010: 6f6c 5f6d 6170 7065 723d 7379 6d62 6f6c  ol_mapper=symbol
-0000e020: 5f6d 6170 7065 7229 0a0a 0a23 2052 6567  _mapper)...# Reg
-0000e030: 6973 7465 7220 7468 6520 6964 656e 7469  ister the identi
-0000e040: 7479 2063 616c 6c20 666f 7220 5079 546f  ty call for PyTo
-0000e050: 7263 6820 6578 6563 7574 6f72 2e0a 2320  rch executor..# 
-0000e060: 6f70 735f 746f 5f74 6f72 6368 5f6f 7073  ops_to_torch_ops
-0000e070: 5f6d 6170 5b54 7261 6e73 666f 726d 732e  _map[Transforms.
-0000e080: 4964 656e 7469 7479 4f70 5d20 3d20 5f69  IdentityOp] = _i
-0000e090: 6465 6e74 6974 795f 6361 6c6c 5f70 7974  dentity_call_pyt
-0000e0a0: 6f72 6368 0a0a 0a23 2056 4d41 5020 7472  orch...# VMAP tr
-0000e0b0: 616e 7366 6f72 6d0a 2320 2d2d 2d2d 2d2d  ansform.# ------
-0000e0c0: 2d2d 2d2d 2d2d 2d0a 0a0a 636c 6173 7320  -------...class 
-0000e0d0: 4e6f 744d 6170 7065 643a 0a20 2020 2022  NotMapped:.    "
-0000e0e0: 2222 5265 7072 6573 656e 7473 2061 206e  ""Represents a n
-0000e0f0: 6f6e 2d62 6174 6368 6564 2064 696d 656e  on-batched dimen
-0000e100: 7369 6f6e 2e22 2222 0a0a 2020 2020 6465  sion."""..    de
-0000e110: 6620 5f5f 7265 7072 5f5f 2873 656c 6629  f __repr__(self)
-0000e120: 3a0a 2020 2020 2020 2020 7265 7475 726e  :.        return
-0000e130: 2022 6e6f 745f 6d61 7070 6564 220a 0a0a   "not_mapped"...
-0000e140: 4064 6174 6163 6c61 7373 2866 726f 7a65  @dataclass(froze
-0000e150: 6e3d 5472 7565 290a 636c 6173 7320 4261  n=True).class Ba
-0000e160: 7463 6865 6456 616c 7565 3a0a 2020 2020  tchedValue:.    
-0000e170: 2222 2242 6174 6368 6564 2076 616c 7565  """Batched value
-0000e180: 2066 6f72 2074 6865 2076 6d61 7020 7472   for the vmap tr
-0000e190: 616e 7366 6f72 6d2e 0a0a 2020 2020 4174  ansform...    At
-0000e1a0: 7472 6962 7574 6573 3a0a 2020 2020 2020  tributes:.      
-0000e1b0: 2020 7661 6c75 653a 2042 6174 6368 6564    value: Batched
-0000e1c0: 2076 616c 7565 2e0a 2020 2020 2020 2020   value..        
-0000e1d0: 6261 7463 685f 6469 6d3a 2042 6174 6368  batch_dim: Batch
-0000e1e0: 696e 6720 6469 6d65 6e73 696f 6e20 6f72  ing dimension or
-0000e1f0: 206e 6f74 5f6d 6170 7065 640a 2020 2020   not_mapped.    
-0000e200: 2222 220a 0a20 2020 2076 616c 7565 3a20  """..    value: 
-0000e210: 416e 790a 2020 2020 6261 7463 685f 6469  Any.    batch_di
-0000e220: 6d3a 2069 6e74 207c 204e 6f74 4d61 7070  m: int | NotMapp
-0000e230: 6564 0a0a 2020 2020 6465 6620 5f5f 6974  ed..    def __it
-0000e240: 6572 5f5f 2873 656c 6629 3a0a 2020 2020  er__(self):.    
-0000e250: 2020 2020 7969 656c 6420 7365 6c66 2e76      yield self.v
-0000e260: 616c 7565 0a20 2020 2020 2020 2079 6965  alue.        yie
-0000e270: 6c64 2073 656c 662e 6261 7463 685f 6469  ld self.batch_di
-0000e280: 6d0a 0a0a 6465 6620 7061 6972 5f74 6f5f  m...def pair_to_
-0000e290: 6261 7463 6865 645f 7661 6c75 6528 7061  batched_value(pa
-0000e2a0: 6972 293a 0a20 2020 2022 2222 436f 6e76  ir):.    """Conv
-0000e2b0: 6572 7473 2061 2070 6169 7220 746f 2061  erts a pair to a
-0000e2c0: 2042 6174 6368 6564 5661 6c75 652e 0a0a   BatchedValue...
-0000e2d0: 2020 2020 4172 6773 3a0a 2020 2020 2020      Args:.      
-0000e2e0: 2020 7061 6972 2028 5365 7175 656e 6365    pair (Sequence
-0000e2f0: 293a 2050 6169 7220 746f 2063 6f6e 7665  ): Pair to conve
-0000e300: 7274 2e0a 0a20 2020 2052 6574 7572 6e73  rt...    Returns
-0000e310: 3a0a 2020 2020 2020 2020 4261 7463 6865  :.        Batche
-0000e320: 6456 616c 7565 3a20 4261 7463 6865 6456  dValue: BatchedV
-0000e330: 616c 7565 2072 6570 7265 7365 6e74 6174  alue representat
-0000e340: 696f 6e20 6f66 2074 6865 2070 6169 722e  ion of the pair.
-0000e350: 0a20 2020 2022 2222 0a20 2020 2069 6620  .    """.    if 
-0000e360: 6973 696e 7374 616e 6365 2870 6169 722c  isinstance(pair,
-0000e370: 2042 6174 6368 6564 5661 6c75 6529 3a0a   BatchedValue):.
-0000e380: 2020 2020 2020 2020 7265 7475 726e 2070          return p
-0000e390: 6169 720a 2020 2020 656c 7365 3a0a 2020  air.    else:.  
-0000e3a0: 2020 2020 2020 6173 7365 7274 2069 7369        assert isi
-0000e3b0: 6e73 7461 6e63 6528 7061 6972 2c20 5365  nstance(pair, Se
-0000e3c0: 7175 656e 6365 2920 616e 6420 6c65 6e28  quence) and len(
-0000e3d0: 7061 6972 2920 3d3d 2032 0a20 2020 2020  pair) == 2.     
-0000e3e0: 2020 2072 6574 7572 6e20 4261 7463 6865     return Batche
-0000e3f0: 6456 616c 7565 282a 7061 6972 290a 0a0a  dValue(*pair)...
-0000e400: 6465 6620 7665 6374 6f72 697a 6564 5f62  def vectorized_b
-0000e410: 6174 6368 6572 2870 7269 6d2c 2061 7869  atcher(prim, axi
-0000e420: 735f 7369 7a65 2c20 6261 7463 6865 645f  s_size, batched_
-0000e430: 7661 6c75 6573 2c20 2a2a 6b77 6172 6773  values, **kwargs
-0000e440: 293a 0a20 2020 2062 6174 6368 5f64 696d  ):.    batch_dim
-0000e450: 203d 2062 6174 6368 6564 5f76 616c 7565   = batched_value
-0000e460: 735b 305d 2e62 6174 6368 5f64 696d 0a20  s[0].batch_dim. 
-0000e470: 2020 2061 7373 6572 7420 616c 6c28 0a20     assert all(. 
-0000e480: 2020 2020 2020 2062 6174 6368 5f64 696d         batch_dim
-0000e490: 203d 3d20 6276 2e62 6174 6368 5f64 696d   == bv.batch_dim
-0000e4a0: 2066 6f72 2062 7620 696e 2062 6174 6368   for bv in batch
-0000e4b0: 6564 5f76 616c 7565 735b 313a 5d0a 2020  ed_values[1:].  
-0000e4c0: 2020 292c 2066 2260 7665 6374 6f72 697a    ), f"`vectoriz
-0000e4d0: 6564 5f62 6174 6368 6572 6020 676f 7420  ed_batcher` got 
-0000e4e0: 6469 6666 6572 656e 7420 6261 7463 6865  different batche
-0000e4f0: 6420 6469 6d65 6e73 696f 6e73 207b 5b62  d dimensions {[b
-0000e500: 762e 6261 7463 685f 6469 6d20 666f 7220  v.batch_dim for 
-0000e510: 6276 2069 6e20 6261 7463 6865 645f 7661  bv in batched_va
-0000e520: 6c75 6573 5d7d 220a 2020 2020 7265 7475  lues]}".    retu
-0000e530: 726e 2042 6174 6368 6564 5661 6c75 6528  rn BatchedValue(
-0000e540: 7072 696d 282a 5b62 762e 7661 6c75 6520  prim(*[bv.value 
-0000e550: 666f 7220 6276 2069 6e20 6261 7463 6865  for bv in batche
-0000e560: 645f 7661 6c75 6573 5d2c 202a 2a6b 7761  d_values], **kwa
-0000e570: 7267 7329 2c20 6261 7463 685f 6469 6d29  rgs), batch_dim)
-0000e580: 0a0a 0a6e 6f74 5f6d 6170 7065 6420 3d20  ...not_mapped = 
-0000e590: 4e6f 744d 6170 7065 6428 290a 0a0a 6465  NotMapped()...de
-0000e5a0: 6620 6d6f 7665 6469 6d28 782c 2073 7263  f movedim(x, src
-0000e5b0: 3a20 696e 742c 2064 7374 3a20 696e 7429  : int, dst: int)
-0000e5c0: 3a0a 2020 2020 7065 726d 203d 205b 6920  :.    perm = [i 
-0000e5d0: 666f 7220 6920 696e 2072 616e 6765 2878  for i in range(x
-0000e5e0: 2e6e 6469 6d29 2069 6620 6920 213d 2073  .ndim) if i != s
-0000e5f0: 7263 5d0a 2020 2020 7065 726d 2e69 6e73  rc].    perm.ins
-0000e600: 6572 7428 6473 742c 2073 7263 290a 2020  ert(dst, src).  
-0000e610: 2020 7265 7475 726e 2070 7269 6d73 2e74    return prims.t
-0000e620: 7261 6e73 706f 7365 2878 2c20 7475 706c  ranspose(x, tupl
-0000e630: 6528 7065 726d 2929 0a0a 0a64 6566 206d  e(perm))...def m
-0000e640: 6f76 655f 6261 7463 685f 6469 6d28 6178  ove_batch_dim(ax
-0000e650: 6973 5f73 697a 652c 2073 7263 2c20 6473  is_size, src, ds
-0000e660: 742c 2078 293a 0a20 2020 2069 6620 7372  t, x):.    if sr
-0000e670: 6320 6973 206e 6f74 5f6d 6170 7065 643a  c is not_mapped:
-0000e680: 0a20 2020 2020 2020 2069 6620 6973 696e  .        if isin
-0000e690: 7374 616e 6365 2878 2c20 4e75 6d62 6572  stance(x, Number
-0000e6a0: 293a 0a20 2020 2020 2020 2020 2020 2072  ):.            r
-0000e6b0: 6574 7572 6e20 780a 2020 2020 2020 2020  eturn x.        
-0000e6c0: 7461 7267 6574 5f73 6861 7065 203d 206c  target_shape = l
-0000e6d0: 6973 7428 782e 7368 6170 6529 0a20 2020  ist(x.shape).   
-0000e6e0: 2020 2020 2074 6172 6765 745f 7368 6170       target_shap
-0000e6f0: 652e 696e 7365 7274 2864 7374 2c20 6178  e.insert(dst, ax
-0000e700: 6973 5f73 697a 6529 0a20 2020 2020 2020  is_size).       
-0000e710: 2062 6361 7374 5f64 696d 7320 3d20 6c69   bcast_dims = li
-0000e720: 7374 2872 616e 6765 286c 656e 2874 6172  st(range(len(tar
-0000e730: 6765 745f 7368 6170 6529 2929 0a20 2020  get_shape))).   
-0000e740: 2020 2020 2062 6361 7374 5f64 696d 732e       bcast_dims.
-0000e750: 706f 7028 6473 7429 0a20 2020 2020 2020  pop(dst).       
-0000e760: 2072 6574 7572 6e20 7072 696d 732e 6272   return prims.br
-0000e770: 6f61 6463 6173 745f 696e 5f64 696d 2878  oadcast_in_dim(x
-0000e780: 2c20 7461 7267 6574 5f73 6861 7065 2c20  , target_shape, 
-0000e790: 6263 6173 745f 6469 6d73 290a 2020 2020  bcast_dims).    
-0000e7a0: 656c 6966 2073 7263 203d 3d20 6473 743a  elif src == dst:
-0000e7b0: 0a20 2020 2020 2020 2072 6574 7572 6e20  .        return 
-0000e7c0: 780a 2020 2020 656c 7365 3a0a 2020 2020  x.    else:.    
-0000e7d0: 2020 2020 7265 7475 726e 206d 6f76 6564      return moved
-0000e7e0: 696d 2878 2c20 7372 632c 2064 7374 290a  im(x, src, dst).
-0000e7f0: 0a0a 6465 6620 6269 6e61 7279 5f6f 705f  ..def binary_op_
-0000e800: 6261 7463 6869 6e67 5f72 756c 6528 6f70  batching_rule(op
-0000e810: 3a20 7072 696d 732e 5072 696d 4944 732c  : prims.PrimIDs,
-0000e820: 2061 7869 735f 7369 7a65 3a20 696e 742c   axis_size: int,
-0000e830: 2076 616c 735f 696e 3a20 4261 7463 6865   vals_in: Batche
-0000e840: 6456 616c 7565 293a 0a20 2020 2028 2878  dValue):.    ((x
-0000e850: 2c20 785f 6264 696d 292c 2028 792c 2079  , x_bdim), (y, y
-0000e860: 5f62 6469 6d29 2920 3d20 7661 6c73 5f69  _bdim)) = vals_i
-0000e870: 6e0a 2020 2020 6966 2078 5f62 6469 6d20  n.    if x_bdim 
-0000e880: 213d 2079 5f62 6469 6d3a 0a20 2020 2020  != y_bdim:.     
-0000e890: 2020 2069 6620 785f 6264 696d 2069 7320     if x_bdim is 
-0000e8a0: 6e6f 745f 6d61 7070 6564 3a0a 2020 2020  not_mapped:.    
-0000e8b0: 2020 2020 2020 2020 7820 3d20 6d6f 7665          x = move
-0000e8c0: 5f62 6174 6368 5f64 696d 2861 7869 735f  _batch_dim(axis_
-0000e8d0: 7369 7a65 2c20 785f 6264 696d 2c20 795f  size, x_bdim, y_
-0000e8e0: 6264 696d 2c20 7829 0a20 2020 2020 2020  bdim, x).       
-0000e8f0: 2020 2020 2078 5f62 6469 6d20 3d20 795f       x_bdim = y_
-0000e900: 6264 696d 0a20 2020 2020 2020 2065 6c73  bdim.        els
-0000e910: 653a 0a20 2020 2020 2020 2020 2020 2079  e:.            y
-0000e920: 203d 206d 6f76 655f 6261 7463 685f 6469   = move_batch_di
-0000e930: 6d28 6178 6973 5f73 697a 652c 2079 5f62  m(axis_size, y_b
-0000e940: 6469 6d2c 2078 5f62 6469 6d2c 2079 290a  dim, x_bdim, y).
-0000e950: 2020 2020 7265 7475 726e 2042 6174 6368      return Batch
-0000e960: 6564 5661 6c75 6528 6f70 2878 2c20 7929  edValue(op(x, y)
-0000e970: 2c20 785f 6264 696d 290a 0a0a 6465 6620  , x_bdim)...def 
-0000e980: 7369 6e5f 766d 6170 2861 7869 735f 7369  sin_vmap(axis_si
-0000e990: 7a65 3a20 696e 742c 2061 3a20 4261 7463  ze: int, a: Batc
-0000e9a0: 6865 6456 616c 7565 2920 2d3e 2042 6174  hedValue) -> Bat
-0000e9b0: 6368 6564 5661 6c75 653a 0a20 2020 2072  chedValue:.    r
-0000e9c0: 6574 7572 6e20 7665 6374 6f72 697a 6564  eturn vectorized
-0000e9d0: 5f62 6174 6368 6572 2870 7269 6d73 2e73  _batcher(prims.s
-0000e9e0: 696e 2c20 6178 6973 5f73 697a 652c 2028  in, axis_size, (
-0000e9f0: 612c 2929 0a0a 0a64 6566 2063 6f73 5f76  a,))...def cos_v
-0000ea00: 6d61 7028 6178 6973 5f73 697a 653a 2069  map(axis_size: i
-0000ea10: 6e74 2c20 613a 2042 6174 6368 6564 5661  nt, a: BatchedVa
-0000ea20: 6c75 6529 202d 3e20 4261 7463 6865 6456  lue) -> BatchedV
-0000ea30: 616c 7565 3a0a 2020 2020 7265 7475 726e  alue:.    return
-0000ea40: 2076 6563 746f 7269 7a65 645f 6261 7463   vectorized_batc
-0000ea50: 6865 7228 7072 696d 732e 636f 732c 2061  her(prims.cos, a
-0000ea60: 7869 735f 7369 7a65 2c20 2861 2c29 290a  xis_size, (a,)).
-0000ea70: 0a0a 6465 6620 6d75 6c5f 766d 6170 2861  ..def mul_vmap(a
-0000ea80: 7869 735f 7369 7a65 3a20 696e 742c 2061  xis_size: int, a
-0000ea90: 3a20 4261 7463 6865 6456 616c 7565 2c20  : BatchedValue, 
-0000eaa0: 623a 2042 6174 6368 6564 5661 6c75 6529  b: BatchedValue)
-0000eab0: 202d 3e20 4261 7463 6865 6456 616c 7565   -> BatchedValue
-0000eac0: 3a0a 2020 2020 7265 7475 726e 2062 696e  :.    return bin
-0000ead0: 6172 795f 6f70 5f62 6174 6368 696e 675f  ary_op_batching_
-0000eae0: 7275 6c65 2870 7269 6d73 2e6d 756c 2c20  rule(prims.mul, 
-0000eaf0: 6178 6973 5f73 697a 652c 2028 612c 2062  axis_size, (a, b
-0000eb00: 2929 0a0a 0a64 6566 2061 6464 5f76 6d61  ))...def add_vma
-0000eb10: 7028 6178 6973 5f73 697a 653a 2069 6e74  p(axis_size: int
-0000eb20: 2c20 613a 2042 6174 6368 6564 5661 6c75  , a: BatchedValu
-0000eb30: 652c 2062 3a20 4261 7463 6865 6456 616c  e, b: BatchedVal
-0000eb40: 7565 2920 2d3e 2042 6174 6368 6564 5661  ue) -> BatchedVa
-0000eb50: 6c75 653a 0a20 2020 2072 6574 7572 6e20  lue:.    return 
-0000eb60: 6269 6e61 7279 5f6f 705f 6261 7463 6869  binary_op_batchi
-0000eb70: 6e67 5f72 756c 6528 7072 696d 732e 6164  ng_rule(prims.ad
-0000eb80: 642c 2061 7869 735f 7369 7a65 2c20 2861  d, axis_size, (a
-0000eb90: 2c20 6229 290a 0a0a 6465 6620 7375 6d5f  , b))...def sum_
-0000eba0: 766d 6170 2861 7869 735f 7369 7a65 3a20  vmap(axis_size: 
-0000ebb0: 696e 742c 2061 3a20 4261 7463 6865 6456  int, a: BatchedV
-0000ebc0: 616c 7565 2c20 6469 6d73 3a20 5365 7175  alue, dims: Sequ
-0000ebd0: 656e 6365 5b69 6e74 5d2c 202a 2a6b 7761  ence[int], **kwa
-0000ebe0: 7267 7329 202d 3e20 4261 7463 6865 6456  rgs) -> BatchedV
-0000ebf0: 616c 7565 3a0a 2020 2020 6264 696d 203d  alue:.    bdim =
-0000ec00: 2061 2e62 6174 6368 5f64 696d 0a20 2020   a.batch_dim.   
-0000ec10: 2023 2054 4f44 4f3a 2072 656d 6f76 6520   # TODO: remove 
-0000ec20: 7468 6973 2077 6865 6e20 6469 6d73 2062  this when dims b
-0000ec30: 6563 6f6d 6573 2061 206d 616e 6461 746f  ecomes a mandato
-0000ec40: 7279 206b 7761 7267 0a20 2020 2069 6620  ry kwarg.    if 
-0000ec50: 6c65 6e28 6469 6d73 2920 3e20 303a 0a20  len(dims) > 0:. 
-0000ec60: 2020 2020 2020 2064 696d 732c 205f 203d         dims, _ =
-0000ec70: 2073 6166 655f 7a69 7028 2a64 696d 7329   safe_zip(*dims)
-0000ec80: 0a20 2020 2064 696d 735f 6265 666f 7265  .    dims_before
-0000ec90: 203d 2074 7570 6c65 2865 6c20 666f 7220   = tuple(el for 
-0000eca0: 656c 2069 6e20 6469 6d73 2069 6620 656c  el in dims if el
-0000ecb0: 203c 2062 6469 6d29 0a20 2020 2064 696d   < bdim).    dim
-0000ecc0: 735f 6166 7465 7220 3d20 7475 706c 6528  s_after = tuple(
-0000ecd0: 656c 202b 2031 2066 6f72 2065 6c20 696e  el + 1 for el in
-0000ece0: 2064 696d 7320 6966 2065 6c20 3e3d 2062   dims if el >= b
-0000ecf0: 6469 6d29 0a20 2020 2062 6174 6368 6564  dim).    batched
-0000ed00: 5f64 696d 7320 3d20 6469 6d73 5f62 6566  _dims = dims_bef
-0000ed10: 6f72 6520 2b20 6469 6d73 5f61 6674 6572  ore + dims_after
-0000ed20: 0a20 2020 2072 6574 7572 6e20 7665 6374  .    return vect
-0000ed30: 6f72 697a 6564 5f62 6174 6368 6572 2870  orized_batcher(p
-0000ed40: 7269 6d73 2e73 756d 2c20 6178 6973 5f73  rims.sum, axis_s
-0000ed50: 697a 652c 2028 612c 292c 2064 696d 733d  ize, (a,), dims=
-0000ed60: 6261 7463 6865 645f 6469 6d73 2c20 2a2a  batched_dims, **
-0000ed70: 6b77 6172 6773 290a 0a0a 2320 544f 444f  kwargs)...# TODO
-0000ed80: 3a20 506c 6561 7365 2074 6573 7420 7468  : Please test th
-0000ed90: 6973 2065 7874 656e 7369 7665 6c79 0a64  is extensively.d
-0000eda0: 6566 2062 726f 6164 6361 7374 5f69 6e5f  ef broadcast_in_
-0000edb0: 6469 6d5f 766d 6170 280a 2020 2020 6178  dim_vmap(.    ax
-0000edc0: 6973 5f73 697a 653a 2069 6e74 2c20 613a  is_size: int, a:
-0000edd0: 2042 6174 6368 6564 5661 6c75 652c 2073   BatchedValue, s
-0000ede0: 6861 7065 3a20 5365 7175 656e 6365 5b42  hape: Sequence[B
-0000edf0: 6174 6368 6564 5661 6c75 655d 2c20 6272  atchedValue], br
-0000ee00: 6f61 6463 6173 745f 6469 6d65 6e73 696f  oadcast_dimensio
-0000ee10: 6e73 3a20 5365 7175 656e 6365 5b42 6174  ns: Sequence[Bat
-0000ee20: 6368 6564 5661 6c75 655d 0a29 202d 3e20  chedValue].) -> 
-0000ee30: 4261 7463 6865 6456 616c 7565 3a0a 2020  BatchedValue:.  
-0000ee40: 2020 6264 696d 203d 2061 2e62 6174 6368    bdim = a.batch
-0000ee50: 5f64 696d 0a20 2020 2023 2054 4f44 4f3a  _dim.    # TODO:
-0000ee60: 2072 656d 6f76 6520 7468 6973 2077 6865   remove this whe
-0000ee70: 6e20 7368 6170 6520 616e 6420 6272 6f61  n shape and broa
-0000ee80: 6463 6173 745f 6469 6d65 6e73 696f 6e73  dcast_dimensions
-0000ee90: 2062 6563 6f6d 6520 6d61 6e64 6174 6f72   become mandator
-0000eea0: 7920 6b77 6172 6773 0a20 2020 2073 6861  y kwargs.    sha
-0000eeb0: 7065 2c20 5f20 3d20 7361 6665 5f7a 6970  pe, _ = safe_zip
-0000eec0: 282a 7368 6170 6529 0a20 2020 2069 6620  (*shape).    if 
-0000eed0: 6c65 6e28 6272 6f61 6463 6173 745f 6469  len(broadcast_di
-0000eee0: 6d65 6e73 696f 6e73 2920 3e20 303a 0a20  mensions) > 0:. 
-0000eef0: 2020 2020 2020 2062 726f 6164 6361 7374         broadcast
-0000ef00: 5f64 696d 656e 7369 6f6e 732c 205f 203d  _dimensions, _ =
-0000ef10: 2073 6166 655f 7a69 7028 2a62 726f 6164   safe_zip(*broad
-0000ef20: 6361 7374 5f64 696d 656e 7369 6f6e 7329  cast_dimensions)
-0000ef30: 0a20 2020 2069 6620 6264 696d 2069 7320  .    if bdim is 
-0000ef40: 6e6f 745f 6d61 7070 6564 3a0a 2020 2020  not_mapped:.    
-0000ef50: 2020 2020 7265 7475 726e 2042 6174 6368      return Batch
-0000ef60: 6564 5661 6c75 6528 7072 696d 732e 6272  edValue(prims.br
-0000ef70: 6f61 6463 6173 745f 696e 5f64 696d 2861  oadcast_in_dim(a
-0000ef80: 2e76 616c 7565 2c20 7368 6170 652c 2062  .value, shape, b
-0000ef90: 726f 6164 6361 7374 5f64 696d 656e 7369  roadcast_dimensi
-0000efa0: 6f6e 7329 2c20 6264 696d 290a 2020 2020  ons), bdim).    
-0000efb0: 656c 7365 3a0a 2020 2020 2020 2020 6e65  else:.        ne
-0000efc0: 775f 6264 696d 203d 2062 6469 6d20 2b20  w_bdim = bdim + 
-0000efd0: 7375 6d28 3120 666f 7220 6469 6d20 696e  sum(1 for dim in
-0000efe0: 2062 726f 6164 6361 7374 5f64 696d 656e   broadcast_dimen
-0000eff0: 7369 6f6e 7320 6966 2064 696d 203c 2062  sions if dim < b
-0000f000: 6469 6d29 0a20 2020 2020 2020 206e 6577  dim).        new
-0000f010: 5f73 6861 7065 203d 206c 6973 7428 7368  _shape = list(sh
-0000f020: 6170 6529 0a20 2020 2020 2020 206e 6577  ape).        new
-0000f030: 5f73 6861 7065 2e69 6e73 6572 7428 6e65  _shape.insert(ne
-0000f040: 775f 6264 696d 2c20 6178 6973 5f73 697a  w_bdim, axis_siz
-0000f050: 6529 0a20 2020 2020 2020 206e 6577 5f62  e).        new_b
-0000f060: 726f 6164 6361 7374 5f64 696d 656e 7369  roadcast_dimensi
-0000f070: 6f6e 7320 3d20 2830 2c29 202b 2074 7570  ons = (0,) + tup
-0000f080: 6c65 2864 696d 202b 2031 2069 6620 6469  le(dim + 1 if di
-0000f090: 6d20 3e3d 2062 6469 6d20 656c 7365 2064  m >= bdim else d
-0000f0a0: 696d 2066 6f72 2064 696d 2069 6e20 6272  im for dim in br
-0000f0b0: 6f61 6463 6173 745f 6469 6d65 6e73 696f  oadcast_dimensio
-0000f0c0: 6e73 290a 2020 2020 2020 2020 6966 2062  ns).        if b
-0000f0d0: 726f 6164 6361 7374 5f64 696d 656e 7369  roadcast_dimensi
-0000f0e0: 6f6e 7320 3d3d 2028 293a 0a20 2020 2020  ons == ():.     
-0000f0f0: 2020 2020 2020 206e 6577 5f62 726f 6164         new_broad
-0000f100: 6361 7374 5f64 696d 656e 7369 6f6e 7320  cast_dimensions 
-0000f110: 3d20 2829 0a20 2020 2020 2020 2072 6574  = ().        ret
-0000f120: 7572 6e20 4261 7463 6865 6456 616c 7565  urn BatchedValue
-0000f130: 2870 7269 6d73 2e62 726f 6164 6361 7374  (prims.broadcast
-0000f140: 5f69 6e5f 6469 6d28 612e 7661 6c75 652c  _in_dim(a.value,
-0000f150: 206e 6577 5f73 6861 7065 2c20 6e65 775f   new_shape, new_
-0000f160: 6272 6f61 6463 6173 745f 6469 6d65 6e73  broadcast_dimens
-0000f170: 696f 6e73 292c 206e 6577 5f62 6469 6d29  ions), new_bdim)
-0000f180: 0a0a 0a76 6d61 705f 696d 706c 733a 2064  ...vmap_impls: d
-0000f190: 6963 745b 7072 696d 732e 5379 6d62 6f6c  ict[prims.Symbol
-0000f1a0: 2c20 4361 6c6c 6162 6c65 5d20 3d20 6469  , Callable] = di
-0000f1b0: 6374 2829 0a0a 0a64 6566 2075 6e77 7261  ct()...def unwra
-0000f1c0: 705f 6f6e 655f 6c65 7665 6c5f 6f66 5f73  p_one_level_of_s
-0000f1d0: 7562 7379 6d62 6f6c 7328 7472 6163 6529  ubsymbols(trace)
-0000f1e0: 3a0a 2020 2020 6e65 775f 7379 6d62 6f6c  :.    new_symbol
-0000f1f0: 735f 6974 6572 203d 2028 0a20 2020 2020  s_iter = (.     
-0000f200: 2020 2062 6f75 6e64 5f73 796d 626f 6c2e     bound_symbol.
-0000f210: 7375 6273 796d 626f 6c73 2069 6620 6c65  subsymbols if le
-0000f220: 6e28 626f 756e 645f 7379 6d62 6f6c 2e73  n(bound_symbol.s
-0000f230: 7562 7379 6d62 6f6c 7329 203e 2030 2065  ubsymbols) > 0 e
-0000f240: 6c73 6520 5b62 6f75 6e64 5f73 796d 626f  lse [bound_symbo
-0000f250: 6c5d 0a20 2020 2020 2020 2066 6f72 2062  l].        for b
-0000f260: 6f75 6e64 5f73 796d 626f 6c20 696e 2074  ound_symbol in t
-0000f270: 7261 6365 2e62 6f75 6e64 5f73 796d 626f  race.bound_symbo
-0000f280: 6c73 0a20 2020 2029 0a20 2020 206e 6577  ls.    ).    new
-0000f290: 5f73 796d 626f 6c73 203d 206c 6973 7428  _symbols = list(
-0000f2a0: 6368 6169 6e2e 6672 6f6d 5f69 7465 7261  chain.from_itera
-0000f2b0: 626c 6528 6e65 775f 7379 6d62 6f6c 735f  ble(new_symbols_
-0000f2c0: 6974 6572 2929 0a20 2020 2074 7261 6365  iter)).    trace
-0000f2d0: 2e62 6f75 6e64 5f73 796d 626f 6c73 203d  .bound_symbols =
-0000f2e0: 206e 6577 5f73 796d 626f 6c73 0a20 2020   new_symbols.   
-0000f2f0: 2072 6574 7572 6e20 7472 6163 650a 0a0a   return trace...
-0000f300: 6465 6620 6465 636f 6d70 6f73 6564 5f66  def decomposed_f
-0000f310: 6e5f 766d 6170 5f72 756c 6528 6178 6973  n_vmap_rule(axis
-0000f320: 5f73 697a 652c 202a 6172 6773 2c20 666e  _size, *args, fn
-0000f330: 2c20 2a2a 6b77 6172 6773 293a 0a20 2020  , **kwargs):.   
-0000f340: 2061 7267 732c 2069 6e5f 6469 6d73 203d   args, in_dims =
-0000f350: 2075 6e7a 6970 3228 6172 6773 290a 2020   unzip2(args).  
-0000f360: 2020 756e 6261 7463 6865 645f 6172 6773    unbatched_args
-0000f370: 203d 2074 7265 655f 6d61 7028 6c61 6d62   = tree_map(lamb
-0000f380: 6461 2078 3a20 7265 6d6f 7665 5f62 6174  da x: remove_bat
-0000f390: 6368 5f64 696d 2878 2920 6966 2069 7369  ch_dim(x) if isi
-0000f3a0: 6e73 7461 6e63 6528 782c 2054 656e 736f  nstance(x, Tenso
-0000f3b0: 7250 726f 7879 2920 656c 7365 2078 2c20  rProxy) else x, 
-0000f3c0: 6172 6773 290a 2020 2020 7472 6163 6520  args).    trace 
-0000f3d0: 3d20 636f 6e73 7472 7563 745f 7472 6163  = construct_trac
-0000f3e0: 6528 2928 666e 2c20 2a75 6e62 6174 6368  e()(fn, *unbatch
-0000f3f0: 6564 5f61 7267 732c 202a 2a6b 7761 7267  ed_args, **kwarg
-0000f400: 7329 0a20 2020 2074 7261 6365 203d 2075  s).    trace = u
-0000f410: 6e77 7261 705f 6f6e 655f 6c65 7665 6c5f  nwrap_one_level_
-0000f420: 6f66 5f73 7562 7379 6d62 6f6c 7328 7472  of_subsymbols(tr
-0000f430: 6163 6529 0a20 2020 206f 7574 7320 3d20  ace).    outs = 
-0000f440: 5f76 6d61 705f 6361 6c6c 5f6d 6574 6166  _vmap_call_metaf
-0000f450: 756e 6328 4661 6c73 652c 2061 7267 732c  unc(False, args,
-0000f460: 2069 6e5f 6469 6d73 2c20 302c 2061 7869   in_dims, 0, axi
-0000f470: 735f 7369 7a65 2c20 6675 6e63 7469 6f6e  s_size, function
-0000f480: 5f74 7261 6365 3d74 7261 6365 2c20 2a2a  _trace=trace, **
-0000f490: 6b77 6172 6773 290a 2020 2020 6966 2069  kwargs).    if i
-0000f4a0: 7369 6e73 7461 6e63 6528 6f75 7473 2c20  sinstance(outs, 
-0000f4b0: 5365 7175 656e 6365 293a 0a20 2020 2020  Sequence):.     
-0000f4c0: 2020 206f 7574 5f64 696d 7320 3d20 2830     out_dims = (0
-0000f4d0: 2c29 202a 206c 656e 286f 7574 7329 0a20  ,) * len(outs). 
-0000f4e0: 2020 2020 2020 2072 6574 7572 6e20 7361         return sa
-0000f4f0: 6665 5f6d 6170 2870 6169 725f 746f 5f62  fe_map(pair_to_b
-0000f500: 6174 6368 6564 5f76 616c 7565 2c20 7361  atched_value, sa
-0000f510: 6665 5f7a 6970 286f 7574 732c 206f 7574  fe_zip(outs, out
-0000f520: 5f64 696d 7329 290a 2020 2020 7265 7475  _dims)).    retu
-0000f530: 726e 2042 6174 6368 6564 5661 6c75 6528  rn BatchedValue(
-0000f540: 6f75 7473 2c20 3029 0a0a 0a76 6d61 705f  outs, 0)...vmap_
-0000f550: 696d 706c 735b 7072 696d 732e 5072 696d  impls[prims.Prim
-0000f560: 4944 732e 5349 4e5d 203d 2073 696e 5f76  IDs.SIN] = sin_v
-0000f570: 6d61 700a 766d 6170 5f69 6d70 6c73 5b70  map.vmap_impls[p
-0000f580: 7269 6d73 2e50 7269 6d49 4473 2e43 4f53  rims.PrimIDs.COS
-0000f590: 5d20 3d20 636f 735f 766d 6170 0a76 6d61  ] = cos_vmap.vma
-0000f5a0: 705f 696d 706c 735b 7072 696d 732e 5072  p_impls[prims.Pr
-0000f5b0: 696d 4944 732e 4d55 4c5d 203d 206d 756c  imIDs.MUL] = mul
-0000f5c0: 5f76 6d61 700a 766d 6170 5f69 6d70 6c73  _vmap.vmap_impls
-0000f5d0: 5b70 7269 6d73 2e50 7269 6d49 4473 2e41  [prims.PrimIDs.A
-0000f5e0: 4444 5d20 3d20 6164 645f 766d 6170 0a76  DD] = add_vmap.v
-0000f5f0: 6d61 705f 696d 706c 735b 7072 696d 732e  map_impls[prims.
-0000f600: 5072 696d 4944 732e 5355 4d5d 203d 2073  PrimIDs.SUM] = s
-0000f610: 756d 5f76 6d61 700a 766d 6170 5f69 6d70  um_vmap.vmap_imp
-0000f620: 6c73 5b70 7269 6d73 2e50 7269 6d49 4473  ls[prims.PrimIDs
-0000f630: 2e42 524f 4144 4341 5354 5f49 4e5f 4449  .BROADCAST_IN_DI
-0000f640: 4d5d 203d 2062 726f 6164 6361 7374 5f69  M] = broadcast_i
-0000f650: 6e5f 6469 6d5f 766d 6170 0a0a 0a64 6566  n_dim_vmap...def
-0000f660: 2076 6d61 705f 7379 6d62 6f6c 5f6d 6170   vmap_symbol_map
-0000f670: 7065 7228 7379 6d62 6f6c 3a20 7072 696d  per(symbol: prim
-0000f680: 732e 5379 6d62 6f6c 2c20 2a2c 2061 7869  s.Symbol, *, axi
-0000f690: 735f 7369 7a65 3a20 696e 7429 3a0a 2020  s_size: int):.  
-0000f6a0: 2020 2222 224d 6170 7320 6120 7379 6d62    """Maps a symb
-0000f6b0: 6f6c 2074 6f20 6120 766d 6170 2066 756e  ol to a vmap fun
-0000f6c0: 6374 696f 6e20 7468 6174 2065 7661 6c75  ction that evalu
-0000f6d0: 6174 6573 2069 742e 0a0a 2020 2020 4172  ates it...    Ar
-0000f6e0: 6773 3a0a 2020 2020 2020 2020 7379 6d62  gs:.        symb
-0000f6f0: 6f6c 2028 7072 696d 732e 5379 6d62 6f6c  ol (prims.Symbol
-0000f700: 293a 2053 796d 626f 6c20 746f 2065 7661  ): Symbol to eva
-0000f710: 6c75 6174 652e 0a0a 2020 2020 5261 6973  luate...    Rais
-0000f720: 6573 3a0a 2020 2020 2020 2020 4e6f 7449  es:.        NotI
-0000f730: 6d70 6c65 6d65 6e74 6564 4572 726f 723a  mplementedError:
-0000f740: 2049 6620 7468 6520 766d 6170 2066 6f72   If the vmap for
-0000f750: 2074 6865 2073 796d 626f 6c20 6973 206e   the symbol is n
-0000f760: 6f74 2069 6d70 6c65 6d65 6e74 6564 2e0a  ot implemented..
-0000f770: 0a20 2020 2052 6574 7572 6e73 3a0a 2020  .    Returns:.  
-0000f780: 2020 2020 2020 4361 6c6c 6162 6c65 3a20        Callable: 
-0000f790: 766d 6170 2066 756e 6374 696f 6e20 7468  vmap function th
-0000f7a0: 6174 2065 7661 6c75 6174 6573 2074 6865  at evaluates the
-0000f7b0: 2073 796d 626f 6c2e 0a20 2020 2022 2222   symbol..    """
-0000f7c0: 0a0a 2020 2020 6465 6620 7772 6170 5f61  ..    def wrap_a
-0000f7d0: 7267 2878 293a 0a20 2020 2020 2020 2069  rg(x):.        i
-0000f7e0: 6620 6973 696e 7374 616e 6365 2878 2c20  f isinstance(x, 
-0000f7f0: 4261 7463 6865 6456 616c 7565 293a 0a20  BatchedValue):. 
-0000f800: 2020 2020 2020 2020 2020 2072 6574 7572             retur
-0000f810: 6e20 780a 2020 2020 2020 2020 656c 6966  n x.        elif
-0000f820: 2069 7369 6e73 7461 6e63 6528 782c 204e   isinstance(x, N
-0000f830: 756d 6265 7229 3a0a 2020 2020 2020 2020  umber):.        
-0000f840: 2020 2020 7265 7475 726e 2042 6174 6368      return Batch
-0000f850: 6564 5661 6c75 6528 782c 206e 6f74 5f6d  edValue(x, not_m
-0000f860: 6170 7065 6429 0a20 2020 2020 2020 2065  apped).        e
-0000f870: 6c73 653a 0a20 2020 2020 2020 2020 2020  lse:.           
-0000f880: 2072 6169 7365 2056 616c 7565 4572 726f   raise ValueErro
-0000f890: 7228 6622 766d 6170 2077 7261 705f 6172  r(f"vmap wrap_ar
-0000f8a0: 6720 676f 7420 616e 2075 6e73 7570 706f  g got an unsuppo
-0000f8b0: 7274 6564 2074 7970 6520 7b74 7970 6528  rted type {type(
-0000f8c0: 7829 7d22 290a 0a20 2020 2069 6620 7379  x)}")..    if sy
-0000f8d0: 6d62 6f6c 2e61 7265 5f61 6c6c 5f61 7267  mbol.are_all_arg
-0000f8e0: 735f 636f 6e73 7461 6e74 3a0a 0a20 2020  s_constant:..   
-0000f8f0: 2020 2020 2064 6566 205f 766d 6170 5f69       def _vmap_i
-0000f900: 6d70 6c5f 636f 6e73 7428 7379 6d62 6f6c  mpl_const(symbol
-0000f910: 2c20 2a61 7267 732c 202a 2a6b 7761 7267  , *args, **kwarg
-0000f920: 7329 3a0a 2020 2020 2020 2020 2020 2020  s):.            
-0000f930: 6f75 7420 3d20 7379 6d62 6f6c 5f74 6f5f  out = symbol_to_
-0000f940: 6576 616c 2873 796d 626f 6c29 282a 6172  eval(symbol)(*ar
-0000f950: 6773 2c20 2a2a 6b77 6172 6773 290a 0a20  gs, **kwargs).. 
-0000f960: 2020 2020 2020 2020 2020 2069 6620 6973             if is
-0000f970: 696e 7374 616e 6365 286f 7574 2c20 5365  instance(out, Se
-0000f980: 7175 656e 6365 293a 0a20 2020 2020 2020  quence):.       
-0000f990: 2020 2020 2020 2020 2072 6574 7572 6e20           return 
-0000f9a0: 7361 6665 5f6d 6170 2870 6169 725f 746f  safe_map(pair_to
-0000f9b0: 5f62 6174 6368 6564 5f76 616c 7565 2c20  _batched_value, 
-0000f9c0: 7361 6665 5f7a 6970 2861 7267 732c 205b  safe_zip(args, [
-0000f9d0: 6e6f 745f 6d61 7070 6564 5d20 2a20 6c65  not_mapped] * le
-0000f9e0: 6e28 6f75 7429 2929 0a0a 2020 2020 2020  n(out)))..      
-0000f9f0: 2020 2020 2020 7265 7475 726e 2042 6174        return Bat
-0000fa00: 6368 6564 5661 6c75 6528 6f75 742c 206e  chedValue(out, n
-0000fa10: 6f74 5f6d 6170 7065 6429 0a0a 2020 2020  ot_mapped)..    
-0000fa20: 2020 2020 7265 7475 726e 2070 6172 7469      return parti
-0000fa30: 616c 285f 766d 6170 5f69 6d70 6c5f 636f  al(_vmap_impl_co
-0000fa40: 6e73 742c 2073 796d 626f 6c29 0a0a 2020  nst, symbol)..  
-0000fa50: 2020 766d 6170 5f69 6d70 6c20 3d20 766d    vmap_impl = vm
-0000fa60: 6170 5f69 6d70 6c73 2e67 6574 2873 796d  ap_impls.get(sym
-0000fa70: 626f 6c2e 7379 6d2e 6964 290a 2020 2020  bol.sym.id).    
-0000fa80: 6966 2076 6d61 705f 696d 706c 2069 7320  if vmap_impl is 
-0000fa90: 4e6f 6e65 3a0a 2020 2020 2020 2020 6966  None:.        if
-0000faa0: 206c 656e 2873 796d 626f 6c2e 7375 6273   len(symbol.subs
-0000fab0: 796d 626f 6c73 2920 3e20 303a 0a20 2020  ymbols) > 0:.   
-0000fac0: 2020 2020 2020 2020 2076 6d61 705f 696d           vmap_im
-0000fad0: 706c 203d 2070 6172 7469 616c 2864 6563  pl = partial(dec
-0000fae0: 6f6d 706f 7365 645f 666e 5f76 6d61 705f  omposed_fn_vmap_
-0000faf0: 7275 6c65 2c20 666e 3d73 796d 626f 6c2e  rule, fn=symbol.
-0000fb00: 7379 6d29 0a20 2020 2020 2020 2065 6c73  sym).        els
-0000fb10: 653a 0a20 2020 2020 2020 2020 2020 2072  e:.            r
-0000fb20: 6169 7365 204e 6f74 496d 706c 656d 656e  aise NotImplemen
-0000fb30: 7465 6445 7272 6f72 2866 2276 6d61 7020  tedError(f"vmap 
-0000fb40: 666f 7220 7b73 796d 626f 6c2e 7379 6d2e  for {symbol.sym.
-0000fb50: 6964 7d20 6973 206e 6f74 2069 6d70 6c65  id} is not imple
-0000fb60: 6d65 6e74 6564 2229 0a0a 2020 2020 6465  mented")..    de
-0000fb70: 6620 5f76 6d61 705f 696d 706c 282a 6172  f _vmap_impl(*ar
-0000fb80: 6773 2c20 2a2a 6b77 6172 6773 293a 0a20  gs, **kwargs):. 
-0000fb90: 2020 2020 2020 2061 7267 7320 3d20 7472         args = tr
-0000fba0: 6565 5f6d 6170 2877 7261 705f 6172 672c  ee_map(wrap_arg,
-0000fbb0: 2061 7267 7329 0a20 2020 2020 2020 2061   args).        a
-0000fbc0: 7373 6572 7420 616c 6c28 6973 696e 7374  ssert all(isinst
-0000fbd0: 616e 6365 2861 7267 2c20 4261 7463 6865  ance(arg, Batche
-0000fbe0: 6456 616c 7565 2920 666f 7220 6172 6720  dValue) for arg 
-0000fbf0: 696e 2074 7265 655f 666c 6174 7465 6e28  in tree_flatten(
-0000fc00: 6172 6773 295b 305d 290a 2020 2020 2020  args)[0]).      
-0000fc10: 2020 7265 7475 726e 2076 6d61 705f 696d    return vmap_im
-0000fc20: 706c 2861 7869 735f 7369 7a65 2c20 2a61  pl(axis_size, *a
-0000fc30: 7267 732c 202a 2a6b 7761 7267 7329 0a0a  rgs, **kwargs)..
-0000fc40: 2020 2020 7265 7475 726e 205f 766d 6170      return _vmap
-0000fc50: 5f69 6d70 6c0a 0a0a 6465 6620 7265 6d6f  _impl...def remo
-0000fc60: 7665 5f62 6174 6368 5f64 696d 2874 656e  ve_batch_dim(ten
-0000fc70: 736f 723a 2054 656e 736f 7250 726f 7879  sor: TensorProxy
-0000fc80: 2c20 6261 7463 685f 6469 6d3a 2069 6e74  , batch_dim: int
-0000fc90: 203d 2030 2920 2d3e 2054 656e 736f 7250   = 0) -> TensorP
-0000fca0: 726f 7879 3a0a 2020 2020 2222 2252 656d  roxy:.    """Rem
-0000fcb0: 6f76 6573 2074 6865 2062 6174 6368 2064  oves the batch d
-0000fcc0: 696d 656e 7369 6f6e 2066 726f 6d20 6120  imension from a 
-0000fcd0: 7465 6e73 6f72 2e0a 0a20 2020 2041 7267  tensor...    Arg
-0000fce0: 733a 0a20 2020 2020 2020 2074 656e 736f  s:.        tenso
-0000fcf0: 7220 2854 656e 736f 7250 726f 7879 293a  r (TensorProxy):
-0000fd00: 2054 656e 736f 7220 746f 2072 656d 6f76   Tensor to remov
-0000fd10: 6520 7468 6520 6261 7463 6820 6469 6d65  e the batch dime
-0000fd20: 6e73 696f 6e20 6672 6f6d 2e0a 0a20 2020  nsion from...   
-0000fd30: 2052 6574 7572 6e73 3a0a 2020 2020 2020   Returns:.      
-0000fd40: 2020 5465 6e73 6f72 5072 6f78 793a 2054    TensorProxy: T
-0000fd50: 656e 736f 7220 7769 7468 2074 6865 2062  ensor with the b
-0000fd60: 6174 6368 2064 696d 656e 7369 6f6e 2072  atch dimension r
-0000fd70: 656d 6f76 6564 2e0a 2020 2020 2222 220a  emoved..    """.
-0000fd80: 2020 2020 6e65 775f 7368 6170 6520 3d20      new_shape = 
-0000fd90: 7465 6e73 6f72 2e73 6861 7065 5b3a 6261  tensor.shape[:ba
-0000fda0: 7463 685f 6469 6d5d 202b 2074 656e 736f  tch_dim] + tenso
-0000fdb0: 722e 7368 6170 655b 6261 7463 685f 6469  r.shape[batch_di
-0000fdc0: 6d20 2b20 3120 3a5d 0a20 2020 2072 6574  m + 1 :].    ret
-0000fdd0: 7572 6e20 5465 6e73 6f72 5072 6f78 7928  urn TensorProxy(
-0000fde0: 6c69 6b65 3d74 656e 736f 722c 2073 6861  like=tensor, sha
-0000fdf0: 7065 3d6e 6577 5f73 6861 7065 290a 0a0a  pe=new_shape)...
-0000fe00: 2320 544f 444f 3a20 696e 204a 4158 2061  # TODO: in JAX a
-0000fe10: 7267 732c 2069 6e5f 6469 6d73 2061 7265  rgs, in_dims are
-0000fe20: 2066 6c61 7474 656e 6564 2074 6865 2073   flattened the s
-0000fe30: 616d 6520 7761 790a 2320 544f 444f 3a20  ame way.# TODO: 
-0000fe40: 696e 204a 4158 206f 7574 5f64 696d 7320  in JAX out_dims 
-0000fe50: 6172 6520 666c 6174 7465 6e65 6420 6173  are flattened as
-0000fe60: 2077 656c 6c0a 6465 6620 5f76 6d61 705f   well.def _vmap_
-0000fe70: 6361 6c6c 5f6d 6574 6166 756e 6328 6465  call_metafunc(de
-0000fe80: 7461 6368 6564 3a20 626f 6f6c 2c20 6172  tached: bool, ar
-0000fe90: 6773 2c20 696e 5f64 696d 732c 206f 7574  gs, in_dims, out
-0000fea0: 5f64 696d 732c 2061 7869 735f 7369 7a65  _dims, axis_size
-0000feb0: 2c20 6675 6e63 7469 6f6e 5f74 7261 6365  , function_trace
-0000fec0: 3a20 5472 6163 652c 202a 2a6b 7761 7267  : Trace, **kwarg
-0000fed0: 7329 3a0a 2020 2020 2222 224d 6574 6166  s):.    """Metaf
-0000fee0: 756e 6374 696f 6e20 666f 7220 766d 6170  unction for vmap
-0000fef0: 2063 616c 6c2e 0a0a 2020 2020 4172 6773   call...    Args
-0000ff00: 3a0a 2020 2020 2020 2020 6465 7461 6368  :.        detach
-0000ff10: 6564 2028 626f 6f6c 293a 2057 6865 7468  ed (bool): Wheth
-0000ff20: 6572 2074 6f20 6465 7461 6368 2074 6865  er to detach the
-0000ff30: 2074 7261 6365 2e0a 2020 2020 2020 2020   trace..        
-0000ff40: 6172 6773 2028 5475 706c 655b 5072 6f78  args (Tuple[Prox
-0000ff50: 795d 293a 2041 7267 756d 656e 7473 2074  y]): Arguments t
-0000ff60: 6f20 7468 6520 6675 6e63 7469 6f6e 2e0a  o the function..
-0000ff70: 2020 2020 2020 2020 696e 5f64 696d 7320          in_dims 
-0000ff80: 2854 7570 6c65 5b69 6e74 5d29 3a20 4261  (Tuple[int]): Ba
-0000ff90: 7463 6820 6469 6d65 6e73 696f 6e20 666f  tch dimension fo
-0000ffa0: 7220 6561 6368 2061 7267 756d 656e 742e  r each argument.
-0000ffb0: 0a20 2020 2020 2020 206f 7574 5f64 696d  .        out_dim
-0000ffc0: 7320 2854 7570 6c65 5b69 6e74 5d29 3a20  s (Tuple[int]): 
-0000ffd0: 4261 7463 6820 6469 6d65 6e73 696f 6e20  Batch dimension 
-0000ffe0: 666f 7220 7265 7475 726e 2076 616c 7565  for return value
-0000fff0: 732e 0a20 2020 2020 2020 2066 756e 6374  s..        funct
-00010000: 696f 6e5f 7472 6163 6520 2854 7261 6365  ion_trace (Trace
-00010010: 293a 2054 7261 6365 2074 6f20 7573 6520  ): Trace to use 
-00010020: 666f 7220 7468 6520 6675 6e63 7469 6f6e  for the function
-00010030: 2e0a 2020 2020 2020 2020 6b77 6172 6773  ..        kwargs
-00010040: 3a20 4b65 7977 6f72 6420 6172 6775 6d65  : Keyword argume
-00010050: 6e74 732e 0a0a 2020 2020 5261 6973 6573  nts...    Raises
-00010060: 3a0a 2020 2020 2020 2020 4173 7365 7274  :.        Assert
-00010070: 696f 6e45 7272 6f72 3a20 4966 2074 6865  ionError: If the
-00010080: 2076 6d61 7020 666f 7220 6b65 7977 6f72   vmap for keywor
-00010090: 6420 6172 6775 6d65 6e74 7320 6973 206e  d arguments is n
-000100a0: 6f74 2069 6d70 6c65 6d65 6e74 6564 2e0a  ot implemented..
-000100b0: 0a20 2020 2052 6574 7572 6e73 3a0a 2020  .    Returns:.  
-000100c0: 2020 2020 2020 5265 7375 6c74 206f 6620        Result of 
-000100d0: 7468 6520 766d 6170 2074 7261 6e73 666f  the vmap transfo
-000100e0: 726d 2e0a 2020 2020 2222 220a 2020 2020  rm..    """.    
-000100f0: 636f 6d6d 6f6e 5f64 6576 6963 6520 3d20  common_device = 
-00010100: 7b78 2e64 6576 6963 6520 666f 7220 7820  {x.device for x 
-00010110: 696e 2061 7267 7320 6966 2069 7369 6e73  in args if isins
-00010120: 7461 6e63 6528 782c 2054 656e 736f 7250  tance(x, TensorP
-00010130: 726f 7879 297d 0a20 2020 2061 7373 6572  roxy)}.    asser
-00010140: 7420 6c65 6e28 636f 6d6d 6f6e 5f64 6576  t len(common_dev
-00010150: 6963 6529 203c 3d20 312c 2022 766d 6170  ice) <= 1, "vmap
-00010160: 2066 6f72 206d 756c 7469 706c 6520 6465   for multiple de
-00010170: 7669 6365 7320 6973 206e 6f74 2069 6d70  vices is not imp
-00010180: 6c65 6d65 6e74 6564 220a 2020 2020 2863  lemented".    (c
-00010190: 6f6d 6d6f 6e5f 6465 7669 6365 2c29 203d  ommon_device,) =
-000101a0: 2063 6f6d 6d6f 6e5f 6465 7669 6365 2069   common_device i
-000101b0: 6620 6c65 6e28 636f 6d6d 6f6e 5f64 6576  f len(common_dev
-000101c0: 6963 6529 203d 3d20 3120 656c 7365 2028  ice) == 1 else (
-000101d0: 6370 752c 290a 0a20 2020 2069 6620 6178  cpu,)..    if ax
-000101e0: 6973 5f73 697a 6520 6973 204e 6f6e 653a  is_size is None:
-000101f0: 0a20 2020 2020 2020 2028 6178 6973 5f73  .        (axis_s
-00010200: 697a 652c 2920 3d20 7b78 2e73 6861 7065  ize,) = {x.shape
-00010210: 5b61 785d 2066 6f72 2078 2c20 6178 2069  [ax] for x, ax i
-00010220: 6e20 7a69 7028 6172 6773 2c20 696e 5f64  n zip(args, in_d
-00010230: 696d 7329 2069 6620 6178 2069 7320 6e6f  ims) if ax is no
-00010240: 7420 6e6f 745f 6d61 7070 6564 7d0a 2020  t not_mapped}.  
-00010250: 2020 696e 5f64 696d 7320 3d20 696e 5f64    in_dims = in_d
-00010260: 696d 7320 6966 2069 7369 6e73 7461 6e63  ims if isinstanc
-00010270: 6528 696e 5f64 696d 732c 2053 6571 7565  e(in_dims, Seque
-00010280: 6e63 6529 2065 6c73 6520 2869 6e5f 6469  nce) else (in_di
-00010290: 6d73 2c29 0a20 2020 2069 6e5f 6469 6d73  ms,).    in_dims
-000102a0: 203d 2074 7570 6c65 286e 6f74 5f6d 6170   = tuple(not_map
-000102b0: 7065 6420 6966 2069 7369 6e73 7461 6e63  ped if isinstanc
-000102c0: 6528 612c 204e 756d 6265 7229 2065 6c73  e(a, Number) els
-000102d0: 6520 6420 666f 7220 612c 2064 2069 6e20  e d for a, d in 
-000102e0: 7361 6665 5f7a 6970 2861 7267 732c 2069  safe_zip(args, i
-000102f0: 6e5f 6469 6d73 2929 0a20 2020 206f 7574  n_dims)).    out
-00010300: 5f64 696d 7320 3d20 6f75 745f 6469 6d73  _dims = out_dims
-00010310: 2069 6620 6973 696e 7374 616e 6365 286f   if isinstance(o
-00010320: 7574 5f64 696d 732c 2053 6571 7565 6e63  ut_dims, Sequenc
-00010330: 6529 2065 6c73 6520 286f 7574 5f64 696d  e) else (out_dim
-00010340: 732c 290a 0a20 2020 2063 7478 203d 2064  s,)..    ctx = d
-00010350: 6574 6163 6865 645f 7472 6163 6528 2920  etached_trace() 
-00010360: 6966 2064 6574 6163 6865 6420 656c 7365  if detached else
-00010370: 206e 756c 6c63 6f6e 7465 7874 2829 0a20   nullcontext(). 
-00010380: 2020 2077 6974 6820 6374 783a 0a20 2020     with ctx:.   
-00010390: 2020 2020 2023 2057 6520 7072 6f70 6167       # We propag
-000103a0: 6174 6520 7468 6520 4261 7463 6856 616c  ate the BatchVal
-000103b0: 7565 2074 6872 6f75 6768 2074 6865 2074  ue through the t
-000103c0: 7261 6365 2c20 616e 6420 7468 656e 2075  race, and then u
-000103d0: 6e77 7261 7020 6974 2061 7420 7468 6520  nwrap it at the 
-000103e0: 656e 640a 2020 2020 2020 2020 6261 7463  end.        batc
-000103f0: 6865 645f 6172 6773 203d 2073 6166 655f  hed_args = safe_
-00010400: 6d61 7028 7061 6972 5f74 6f5f 6261 7463  map(pair_to_batc
-00010410: 6865 645f 7661 6c75 652c 2073 6166 655f  hed_value, safe_
-00010420: 7a69 7028 6172 6773 2c20 696e 5f64 696d  zip(args, in_dim
-00010430: 7329 290a 2020 2020 2020 2020 7265 7375  s)).        resu
-00010440: 6c74 203d 2065 7661 6c5f 7472 6163 6528  lt = eval_trace(
-00010450: 0a20 2020 2020 2020 2020 2020 2066 756e  .            fun
-00010460: 6374 696f 6e5f 7472 6163 652c 202a 6261  ction_trace, *ba
-00010470: 7463 6865 645f 6172 6773 2c20 7379 6d62  tched_args, symb
-00010480: 6f6c 5f6d 6170 7065 723d 7061 7274 6961  ol_mapper=partia
-00010490: 6c28 766d 6170 5f73 796d 626f 6c5f 6d61  l(vmap_symbol_ma
-000104a0: 7070 6572 2c20 6178 6973 5f73 697a 653d  pper, axis_size=
-000104b0: 6178 6973 5f73 697a 6529 2c20 2a2a 6b77  axis_size), **kw
-000104c0: 6172 6773 0a20 2020 2020 2020 2029 0a20  args.        ). 
-000104d0: 2020 2020 2020 2023 2055 6e77 7261 7070         # Unwrapp
-000104e0: 696e 6720 7468 6520 4261 7463 6865 6456  ing the BatchedV
-000104f0: 616c 7565 2773 0a20 2020 2020 2020 2069  alue's.        i
-00010500: 6620 6973 696e 7374 616e 6365 2872 6573  f isinstance(res
-00010510: 756c 742c 2053 6571 7565 6e63 6529 3a0a  ult, Sequence):.
-00010520: 2020 2020 2020 2020 2020 2020 666c 6174              flat
-00010530: 5f72 6573 756c 742c 2073 7065 6320 3d20  _result, spec = 
-00010540: 7472 6565 5f66 6c61 7474 656e 2872 6573  tree_flatten(res
-00010550: 756c 7429 0a20 2020 2020 2020 2020 2020  ult).           
-00010560: 2061 7373 6572 7420 616c 6c28 6973 696e   assert all(isin
-00010570: 7374 616e 6365 2878 2c20 4261 7463 6865  stance(x, Batche
-00010580: 6456 616c 7565 2920 666f 7220 7820 696e  dValue) for x in
-00010590: 2066 6c61 745f 7265 7375 6c74 290a 2020   flat_result).  
-000105a0: 2020 2020 2020 2020 2020 6f75 7473 2c20            outs, 
-000105b0: 6264 696d 7320 3d20 756e 7a69 7032 2866  bdims = unzip2(f
-000105c0: 6c61 745f 7265 7375 6c74 290a 2020 2020  lat_result).    
-000105d0: 2020 2020 2020 2020 2320 544f 444f 3a20          # TODO: 
-000105e0: 6861 6e64 6c65 2074 6865 2063 6173 6520  handle the case 
-000105f0: 7768 6572 6520 6f75 745f 6469 6d73 2069  where out_dims i
-00010600: 7320 6120 7369 6e67 6c65 2076 616c 7565  s a single value
-00010610: 2062 6574 7465 720a 2020 2020 2020 2020   better.        
-00010620: 2020 2020 6966 206c 656e 286f 7574 5f64      if len(out_d
-00010630: 696d 7329 203d 3d20 313a 0a20 2020 2020  ims) == 1:.     
-00010640: 2020 2020 2020 2020 2020 206f 7574 5f64             out_d
-00010650: 696d 7320 3d20 6f75 745f 6469 6d73 202a  ims = out_dims *
-00010660: 206c 656e 286f 7574 7329 0a20 2020 2020   len(outs).     
-00010670: 2020 2020 2020 206f 7574 7320 3d20 7361         outs = sa
-00010680: 6665 5f6d 6170 2870 6172 7469 616c 286d  fe_map(partial(m
-00010690: 6f76 655f 6261 7463 685f 6469 6d2c 2061  ove_batch_dim, a
-000106a0: 7869 735f 7369 7a65 292c 2062 6469 6d73  xis_size), bdims
-000106b0: 2c20 6f75 745f 6469 6d73 2c20 6f75 7473  , out_dims, outs
-000106c0: 290a 2020 2020 2020 2020 2020 2020 7265  ).            re
-000106d0: 7475 726e 2074 7265 655f 756e 666c 6174  turn tree_unflat
-000106e0: 7465 6e28 6f75 7473 2c20 7370 6563 290a  ten(outs, spec).
-000106f0: 2020 2020 2020 2020 6966 2069 7369 6e73          if isins
-00010700: 7461 6e63 6528 7265 7375 6c74 2c20 4e75  tance(result, Nu
-00010710: 6d62 6572 2920 616e 6420 6178 6973 5f73  mber) and axis_s
-00010720: 697a 6520 6973 206e 6f74 204e 6f6e 653a  ize is not None:
-00010730: 0a20 2020 2020 2020 2020 2020 2023 2054  .            # T
-00010740: 4f44 4f3a 2066 6574 6368 2074 6865 2064  ODO: fetch the d
-00010750: 6566 6175 6c74 2064 6576 6963 6520 6672  efault device fr
-00010760: 6f6d 2074 6865 2063 6f6e 7465 7874 0a20  om the context. 
-00010770: 2020 2020 2020 2020 2020 2072 6573 756c             resul
-00010780: 7420 3d20 6675 6c6c 2873 6861 7065 3d28  t = full(shape=(
-00010790: 292c 2066 696c 6c5f 7661 6c75 653d 7265  ), fill_value=re
-000107a0: 7375 6c74 2c20 6465 7669 6365 3d63 6f6d  sult, device=com
-000107b0: 6d6f 6e5f 6465 7669 6365 290a 2020 2020  mon_device).    
-000107c0: 2020 2020 2020 2020 7265 7375 6c74 203d          result =
-000107d0: 2042 6174 6368 6564 5661 6c75 6528 7265   BatchedValue(re
-000107e0: 7375 6c74 2c20 6e6f 745f 6d61 7070 6564  sult, not_mapped
-000107f0: 290a 2020 2020 2020 2020 656c 6966 2069  ).        elif i
-00010800: 7369 6e73 7461 6e63 6528 7265 7375 6c74  sinstance(result
-00010810: 2c20 4261 7463 6865 6456 616c 7565 2920  , BatchedValue) 
-00010820: 616e 6420 6973 696e 7374 616e 6365 2872  and isinstance(r
-00010830: 6573 756c 742e 7661 6c75 652c 204e 756d  esult.value, Num
-00010840: 6265 7229 2061 6e64 2061 7869 735f 7369  ber) and axis_si
-00010850: 7a65 2069 7320 6e6f 7420 4e6f 6e65 3a0a  ze is not None:.
-00010860: 2020 2020 2020 2020 2020 2020 7265 7375              resu
-00010870: 6c74 203d 2042 6174 6368 6564 5661 6c75  lt = BatchedValu
-00010880: 6528 6675 6c6c 2873 6861 7065 3d28 292c  e(full(shape=(),
-00010890: 2066 696c 6c5f 7661 6c75 653d 7265 7375   fill_value=resu
-000108a0: 6c74 2e76 616c 7565 2c20 6465 7669 6365  lt.value, device
-000108b0: 3d63 6f6d 6d6f 6e5f 6465 7669 6365 292c  =common_device),
-000108c0: 2072 6573 756c 742e 6261 7463 685f 6469   result.batch_di
-000108d0: 6d29 0a20 2020 2020 2020 2061 7373 6572  m).        asser
-000108e0: 7420 6973 696e 7374 616e 6365 2872 6573  t isinstance(res
-000108f0: 756c 742c 2042 6174 6368 6564 5661 6c75  ult, BatchedValu
-00010900: 6529 0a20 2020 2020 2020 206f 7574 203d  e).        out =
-00010910: 206d 6f76 655f 6261 7463 685f 6469 6d28   move_batch_dim(
-00010920: 6178 6973 5f73 697a 652c 2072 6573 756c  axis_size, resul
-00010930: 742e 6261 7463 685f 6469 6d2c 206f 7574  t.batch_dim, out
-00010940: 5f64 696d 735b 305d 2c20 7265 7375 6c74  _dims[0], result
-00010950: 2e76 616c 7565 290a 2020 2020 2020 2020  .value).        
-00010960: 7265 7475 726e 206f 7574 0a0a 0a76 6d61  return out...vma
-00010970: 705f 6361 6c6c 203d 2053 796d 626f 6c28  p_call = Symbol(
-00010980: 6964 3d54 7261 6e73 666f 726d 732e 566d  id=Transforms.Vm
-00010990: 6170 4f70 2c20 6e61 6d65 3d22 766d 6170  apOp, name="vmap
-000109a0: 5f63 616c 6c22 2c20 6d65 7461 3d70 6172  _call", meta=par
-000109b0: 7469 616c 285f 766d 6170 5f63 616c 6c5f  tial(_vmap_call_
-000109c0: 6d65 7461 6675 6e63 2c20 4661 6c73 6529  metafunc, False)
-000109d0: 290a 0a0a 2320 544f 444f 3a20 686f 7720  )...# TODO: how 
-000109e0: 7368 6f75 6c64 2077 6520 6861 6e64 6c65  should we handle
-000109f0: 206f 7574 5f64 696d 7320 6865 7265 3f0a   out_dims here?.
-00010a00: 2320 616c 7468 6f75 6768 2068 6572 6520  # although here 
-00010a10: 7765 2061 7265 2063 616c 6c69 6e67 2076  we are calling v
-00010a20: 6d61 7020 6f66 2069 6465 6e74 6974 792c  map of identity,
-00010a30: 2073 6f20 7765 2073 686f 756c 6420 6b6e   so we should kn
-00010a40: 6f77 2066 726f 6d20 7468 6520 6361 6c6c  ow from the call
-00010a50: 2074 6f20 766d 6170 0a23 2054 6869 7320   to vmap.# This 
-00010a60: 7368 6f75 6c64 2062 6520 6669 6e65 2e20  should be fine. 
-00010a70: 4966 2077 6520 6861 7665 2076 6d61 7028  If we have vmap(
-00010a80: 6964 656e 7469 7479 2866 756e 6329 2c20  identity(func), 
-00010a90: 6f75 745f 6469 6d73 3d4e 2920 7468 656e  out_dims=N) then
-00010aa0: 2074 6869 7320 7275 6c65 2069 7320 6669   this rule is fi
-00010ab0: 7273 7420 7573 6564 0a23 2074 6f20 6765  rst used.# to ge
-00010ac0: 7420 7468 6520 766d 6170 7065 6420 7265  t the vmapped re
-00010ad0: 7375 6c74 206f 6620 6964 656e 7469 7479  sult of identity
-00010ae0: 2866 756e 6329 2069 6e20 766d 6170 5f73  (func) in vmap_s
-00010af0: 796d 626f 6c5f 6d61 7070 6572 2c20 616e  ymbol_mapper, an
-00010b00: 6420 6f75 745f 6469 6d73 2069 7320 6861  d out_dims is ha
-00010b10: 6e64 6c65 640a 2320 6166 7465 7220 7468  ndled.# after th
-00010b20: 6174 2069 6e20 7468 6520 6f75 7465 7220  at in the outer 
-00010b30: 5f76 6d61 705f 6361 6c6c 5f6d 6574 6166  _vmap_call_metaf
-00010b40: 756e 632e 0a64 6566 205f 6964 656e 7469  unc..def _identi
-00010b50: 7479 5f63 616c 6c5f 766d 6170 2861 7869  ty_call_vmap(axi
-00010b60: 735f 7369 7a65 2c20 2a62 6174 6368 6564  s_size, *batched
-00010b70: 5f61 7267 732c 2074 7261 6365 3a20 5472  _args, trace: Tr
-00010b80: 6163 652c 202a 2a6b 7761 7267 7329 3a0a  ace, **kwargs):.
-00010b90: 2020 2020 6172 6773 2c20 696e 5f64 696d      args, in_dim
-00010ba0: 7320 3d20 756e 7a69 7032 2862 6174 6368  s = unzip2(batch
-00010bb0: 6564 5f61 7267 7329 0a20 2020 206f 7574  ed_args).    out
-00010bc0: 5f64 696d 7320 3d20 3020 2023 2046 6978  _dims = 0  # Fix
-00010bd0: 6d65 0a20 2020 206f 7574 732c 206f 7574  me.    outs, out
-00010be0: 5f64 696d 7320 3d20 5f76 6d61 705f 6361  _dims = _vmap_ca
-00010bf0: 6c6c 5f6d 6574 6166 756e 6328 4661 6c73  ll_metafunc(Fals
-00010c00: 652c 2061 7267 732c 2069 6e5f 6469 6d73  e, args, in_dims
-00010c10: 2c20 6f75 745f 6469 6d73 2c20 6178 6973  , out_dims, axis
-00010c20: 5f73 697a 652c 2066 756e 6374 696f 6e5f  _size, function_
-00010c30: 7472 6163 653d 7472 6163 652c 202a 2a6b  trace=trace, **k
-00010c40: 7761 7267 7329 0a20 2020 2069 6620 6973  wargs).    if is
-00010c50: 696e 7374 616e 6365 286f 7574 732c 2053  instance(outs, S
-00010c60: 6571 7565 6e63 6529 3a0a 2020 2020 2020  equence):.      
-00010c70: 2020 7265 7475 726e 2073 6166 655f 6d61    return safe_ma
-00010c80: 7028 7061 6972 5f74 6f5f 6261 7463 6865  p(pair_to_batche
-00010c90: 645f 7661 6c75 652c 2073 6166 655f 7a69  d_value, safe_zi
-00010ca0: 7028 6f75 7473 2c20 6f75 745f 6469 6d73  p(outs, out_dims
-00010cb0: 2929 0a20 2020 2072 6574 7572 6e20 4261  )).    return Ba
-00010cc0: 7463 6865 6456 616c 7565 286f 7574 732c  tchedValue(outs,
-00010cd0: 206f 7574 5f64 696d 7329 0a0a 0a76 6d61   out_dims)...vma
-00010ce0: 705f 696d 706c 735b 5472 616e 7366 6f72  p_impls[Transfor
-00010cf0: 6d73 2e49 6465 6e74 6974 794f 705d 203d  ms.IdentityOp] =
-00010d00: 205f 6964 656e 7469 7479 5f63 616c 6c5f   _identity_call_
-00010d10: 766d 6170 0a0a 0a64 6566 205f 6a76 705f  vmap...def _jvp_
-00010d20: 6361 6c6c 5f76 6d61 7028 6178 6973 5f73  call_vmap(axis_s
-00010d30: 697a 652c 2062 6174 6368 6564 5f70 7269  ize, batched_pri
-00010d40: 6d61 6c73 2c20 6261 7463 6865 645f 7461  mals, batched_ta
-00010d50: 6e67 656e 7473 2c20 2a2c 2066 756e 6374  ngents, *, funct
-00010d60: 696f 6e5f 7472 6163 653a 2054 7261 6365  ion_trace: Trace
-00010d70: 2c20 2a2a 6b77 6172 6773 293a 0a20 2020  , **kwargs):.   
-00010d80: 2070 7269 6d61 6c73 2c20 7072 696d 616c   primals, primal
-00010d90: 735f 6264 696d 7320 3d20 7361 6665 5f7a  s_bdims = safe_z
-00010da0: 6970 282a 6261 7463 6865 645f 7072 696d  ip(*batched_prim
-00010db0: 616c 7329 0a20 2020 2074 616e 6765 6e74  als).    tangent
-00010dc0: 732c 2074 616e 6765 6e74 735f 6264 696d  s, tangents_bdim
-00010dd0: 7320 3d20 7361 6665 5f7a 6970 282a 6261  s = safe_zip(*ba
-00010de0: 7463 6865 645f 7461 6e67 656e 7473 290a  tched_tangents).
-00010df0: 2020 2020 6a76 705f 6675 6e63 203d 2070      jvp_func = p
-00010e00: 6172 7469 616c 285f 6a76 705f 6361 6c6c  artial(_jvp_call
-00010e10: 5f6d 6574 6166 756e 632c 2046 616c 7365  _metafunc, False
-00010e20: 2c20 6675 6e63 7469 6f6e 5f74 7261 6365  , function_trace
-00010e30: 3d66 756e 6374 696f 6e5f 7472 6163 6529  =function_trace)
-00010e40: 0a20 2020 2076 6d61 7070 6564 5f6a 7670  .    vmapped_jvp
-00010e50: 5f66 756e 6320 3d20 766d 6170 286a 7670  _func = vmap(jvp
-00010e60: 5f66 756e 632c 2069 6e5f 6469 6d73 3d28  _func, in_dims=(
-00010e70: 7072 696d 616c 735f 6264 696d 732c 2074  primals_bdims, t
-00010e80: 616e 6765 6e74 735f 6264 696d 7329 2c20  angents_bdims), 
-00010e90: 6178 6973 5f73 697a 653d 6178 6973 5f73  axis_size=axis_s
-00010ea0: 697a 6529 0a20 2020 2072 6573 756c 7420  ize).    result 
-00010eb0: 3d20 766d 6170 7065 645f 6a76 705f 6675  = vmapped_jvp_fu
-00010ec0: 6e63 2870 7269 6d61 6c73 2c20 7461 6e67  nc(primals, tang
-00010ed0: 656e 7473 2c20 2a2a 6b77 6172 6773 290a  ents, **kwargs).
-00010ee0: 2020 2020 7265 7475 726e 2074 7265 655f      return tree_
-00010ef0: 6d61 7028 6c61 6d62 6461 2078 3a20 4261  map(lambda x: Ba
-00010f00: 7463 6865 6456 616c 7565 2878 2c20 3029  tchedValue(x, 0)
-00010f10: 2c20 7265 7375 6c74 290a 0a0a 766d 6170  , result)...vmap
-00010f20: 5f69 6d70 6c73 5b54 7261 6e73 666f 726d  _impls[Transform
-00010f30: 732e 4a76 704f 705d 203d 205f 6a76 705f  s.JvpOp] = _jvp_
-00010f40: 6361 6c6c 5f76 6d61 700a 0a0a 6465 6620  call_vmap...def 
-00010f50: 766d 6170 2866 756e 632c 2069 6e5f 6469  vmap(func, in_di
-00010f60: 6d73 3d30 2c20 6f75 745f 6469 6d73 3d30  ms=0, out_dims=0
-00010f70: 2c20 6178 6973 5f73 697a 653d 4e6f 6e65  , axis_size=None
-00010f80: 293a 0a20 2020 2022 2222 5665 6374 6f72  ):.    """Vector
-00010f90: 697a 696e 6720 7472 616e 7366 6f72 6d20  izing transform 
-00010fa0: 666f 7220 6120 5468 756e 6465 7220 6675  for a Thunder fu
-00010fb0: 6e63 7469 6f6e 2e0a 0a20 2020 2041 7267  nction...    Arg
-00010fc0: 733a 0a20 2020 2020 2020 2066 756e 6320  s:.        func 
-00010fd0: 2843 616c 6c61 626c 6529 3a20 4120 5468  (Callable): A Th
-00010fe0: 756e 6465 7220 6675 6e63 7469 6f6e 2074  under function t
-00010ff0: 6f20 6265 2074 7261 6e73 666f 726d 6564  o be transformed
-00011000: 2e0a 0a20 2020 2052 6574 7572 6e73 3a0a  ...    Returns:.
-00011010: 2020 2020 2020 2020 4361 6c6c 6162 6c65          Callable
-00011020: 3a20 4120 766d 6170 7065 6420 7665 7273  : A vmapped vers
-00011030: 696f 6e20 6f66 2074 6865 2066 756e 6374  ion of the funct
-00011040: 696f 6e2e 0a20 2020 2022 2222 0a0a 2020  ion..    """..  
-00011050: 2020 2320 544f 444f 3a20 666c 6174 7465    # TODO: flatte
-00011060: 6e0a 2020 2020 2320 496e 204a 4158 2066  n.    # In JAX f
-00011070: 6c61 7474 656e 696e 6720 6f66 2069 6e5f  lattening of in_
-00011080: 6469 6d73 2069 7320 7261 7468 6572 2063  dims is rather c
-00011090: 6f6d 706c 6963 6174 6564 2062 6563 6175  omplicated becau
-000110a0: 7365 2069 7420 6361 6e20 6f70 7469 6f6e  se it can option
-000110b0: 616c 6c79 2062 650a 2020 2020 2320 7370  ally be.    # sp
-000110c0: 6563 6966 6965 6420 6173 2061 20e2 809c  ecified as a ...
-000110d0: 7072 6566 6978 e280 9d20 7079 7472 6565  prefix... pytree
-000110e0: 2c20 6d65 616e 696e 6720 7468 6174 2061  , meaning that a
-000110f0: 2073 696e 676c 6520 6c65 6166 2076 616c   single leaf val
-00011100: 7565 2063 616e 2062 6520 6170 706c 6965  ue can be applie
-00011110: 640a 2020 2020 2320 746f 2061 6e20 656e  d.    # to an en
-00011120: 7469 7265 2073 7562 2d70 7974 7265 652e  tire sub-pytree.
-00011130: 0a0a 2020 2020 6465 6620 666c 6174 7465  ..    def flatte
-00011140: 6e5f 6675 6e63 5f66 6f72 5f76 6d61 7028  n_func_for_vmap(
-00011150: 6675 6e63 2c20 6172 6773 2c20 6b77 6172  func, args, kwar
-00011160: 6773 293a 0a20 2020 2020 2020 2066 6c61  gs):.        fla
-00011170: 745f 6172 6773 2c20 7370 6563 203d 2074  t_args, spec = t
-00011180: 7265 655f 666c 6174 7465 6e28 2861 7267  ree_flatten((arg
-00011190: 732c 206b 7761 7267 7329 290a 0a20 2020  s, kwargs))..   
-000111a0: 2020 2020 2064 6566 2066 6c61 745f 6675       def flat_fu
-000111b0: 6e63 282a 666c 6174 5f61 7267 7329 3a0a  nc(*flat_args):.
-000111c0: 2020 2020 2020 2020 2020 2020 666e 5f61              fn_a
-000111d0: 7267 732c 2066 6e5f 6b77 6172 6773 203d  rgs, fn_kwargs =
-000111e0: 2074 7265 655f 756e 666c 6174 7465 6e28   tree_unflatten(
-000111f0: 666c 6174 5f61 7267 732c 2073 7065 6329  flat_args, spec)
-00011200: 0a20 2020 2020 2020 2020 2020 2072 6574  .            ret
-00011210: 7572 6e20 6675 6e63 282a 666e 5f61 7267  urn func(*fn_arg
-00011220: 732c 202a 2a66 6e5f 6b77 6172 6773 290a  s, **fn_kwargs).
-00011230: 0a20 2020 2020 2020 2072 6574 7572 6e20  .        return 
-00011240: 666c 6174 5f66 756e 632c 2066 6c61 745f  flat_func, flat_
-00011250: 6172 6773 2c20 7370 6563 0a0a 2020 2020  args, spec..    
-00011260: 6465 6620 7772 6170 7065 7228 2a61 7267  def wrapper(*arg
-00011270: 732c 202a 2a6b 7761 7267 7329 3a0a 2020  s, **kwargs):.  
-00011280: 2020 2020 2020 6675 6e63 5f66 6c61 742c        func_flat,
-00011290: 2061 7267 735f 666c 6174 2c20 6172 6773   args_flat, args
-000112a0: 5f73 7065 6320 3d20 666c 6174 7465 6e5f  _spec = flatten_
-000112b0: 6675 6e63 5f66 6f72 5f76 6d61 7028 6675  func_for_vmap(fu
-000112c0: 6e63 2c20 6172 6773 2c20 6b77 6172 6773  nc, args, kwargs
-000112d0: 290a 2020 2020 2020 2020 6966 2069 7369  ).        if isi
-000112e0: 6e73 7461 6e63 6528 696e 5f64 696d 732c  nstance(in_dims,
-000112f0: 2069 6e74 293a 0a20 2020 2020 2020 2020   int):.         
-00011300: 2020 2069 6e5f 6469 6d73 5f66 6c61 7420     in_dims_flat 
-00011310: 3d20 2869 6e5f 6469 6d73 2c29 202a 206c  = (in_dims,) * l
-00011320: 656e 2861 7267 735f 666c 6174 290a 2020  en(args_flat).  
-00011330: 2020 2020 2020 656c 7365 3a0a 2020 2020        else:.    
-00011340: 2020 2020 2020 2020 696e 5f64 696d 735f          in_dims_
-00011350: 666c 6174 2c20 696e 5f64 696d 735f 7370  flat, in_dims_sp
-00011360: 6563 203d 2074 7265 655f 666c 6174 7465  ec = tree_flatte
-00011370: 6e28 696e 5f64 696d 7329 0a20 2020 2020  n(in_dims).     
-00011380: 2020 2020 2020 2061 7373 6572 7420 6c65         assert le
-00011390: 6e28 696e 5f64 696d 735f 666c 6174 2920  n(in_dims_flat) 
-000113a0: 3d3d 206c 656e 2861 7267 735f 666c 6174  == len(args_flat
-000113b0: 292c 2022 696e 5f64 696d 7320 6d75 7374  ), "in_dims must
-000113c0: 2068 6176 6520 7468 6520 7361 6d65 206c   have the same l
-000113d0: 656e 6774 6820 6173 2061 7267 732c 206b  ength as args, k
-000113e0: 7761 7267 7322 0a20 2020 2020 2020 2075  wargs".        u
-000113f0: 6e62 6174 6368 6564 5f61 7267 735f 666c  nbatched_args_fl
-00011400: 6174 203d 205b 7265 6d6f 7665 5f62 6174  at = [remove_bat
-00011410: 6368 5f64 696d 2861 7267 2920 6966 2069  ch_dim(arg) if i
-00011420: 7369 6e73 7461 6e63 6528 6172 672c 2054  sinstance(arg, T
-00011430: 656e 736f 7250 726f 7879 2920 656c 7365  ensorProxy) else
-00011440: 2061 7267 2066 6f72 2061 7267 2069 6e20   arg for arg in 
-00011450: 6172 6773 5f66 6c61 745d 0a20 2020 2020  args_flat].     
-00011460: 2020 2074 7261 6365 203d 2063 6f6e 7374     trace = const
-00011470: 7275 6374 5f74 7261 6365 2829 2866 756e  ruct_trace()(fun
-00011480: 635f 666c 6174 2c20 2a75 6e62 6174 6368  c_flat, *unbatch
-00011490: 6564 5f61 7267 735f 666c 6174 290a 2020  ed_args_flat).  
-000114a0: 2020 2020 2020 6f75 7473 203d 2076 6d61        outs = vma
-000114b0: 705f 6361 6c6c 2861 7267 735f 666c 6174  p_call(args_flat
-000114c0: 2c20 696e 5f64 696d 735f 666c 6174 2c20  , in_dims_flat, 
-000114d0: 6f75 745f 6469 6d73 2c20 6178 6973 5f73  out_dims, axis_s
-000114e0: 697a 653d 6178 6973 5f73 697a 652c 2066  ize=axis_size, f
-000114f0: 756e 6374 696f 6e5f 7472 6163 653d 7472  unction_trace=tr
-00011500: 6163 6529 0a20 2020 2020 2020 2072 6574  ace).        ret
-00011510: 7572 6e20 6f75 7473 0a0a 2020 2020 7265  urn outs..    re
-00011520: 7475 726e 2077 7261 7070 6572 0a0a 0a23  turn wrapper...#
-00011530: 2054 4f44 4f20 5468 6973 2066 756e 6374   TODO This funct
-00011540: 696f 6e20 636f 6d6d 656e 7465 6420 6f75  ion commented ou
-00011550: 7420 6265 6361 7573 6520 6974 2063 616c  t because it cal
-00011560: 6c73 206d 616b 655f 7472 6163 6564 2c20  ls make_traced, 
-00011570: 7768 6963 6820 646f 6573 206e 6f74 2065  which does not e
-00011580: 7869 7374 0a23 2064 6566 2076 6d61 705f  xist.# def vmap_
-00011590: 6561 6765 7228 6675 6e63 2c20 6172 6773  eager(func, args
-000115a0: 2c20 696e 5f64 696d 733d 302c 206f 7574  , in_dims=0, out
-000115b0: 5f64 696d 733d 302c 2061 7869 735f 7369  _dims=0, axis_si
-000115c0: 7a65 3d4e 6f6e 652c 2065 7865 6375 746f  ze=None, executo
-000115d0: 723d 2274 6f72 6368 2229 3a0a 2320 2020  r="torch"):.#   
-000115e0: 2020 2222 2243 6f6d 7075 7465 7320 7468    """Computes th
-000115f0: 6520 766d 6170 206f 6620 6120 5468 756e  e vmap of a Thun
-00011600: 6465 7220 6675 6e63 7469 6f6e 2e0a 0a23  der function...#
-00011610: 2020 2020 2041 7267 733a 0a23 2020 2020       Args:.#    
-00011620: 2020 2020 2066 756e 6320 2843 616c 6c61       func (Calla
-00011630: 626c 6529 3a20 4120 5468 756e 6465 7220  ble): A Thunder 
-00011640: 6675 6e63 7469 6f6e 2074 6f20 6265 2074  function to be t
-00011650: 7261 6e73 666f 726d 6564 2e0a 2320 2020  ransformed..#   
-00011660: 2020 2020 2020 6172 6773 2028 5f74 7970        args (_typ
-00011670: 655f 293a 2041 7267 7320 6f66 2074 6865  e_): Args of the
-00011680: 2066 756e 6374 696f 6e2e 0a23 2020 2020   function..#    
-00011690: 2020 2020 2065 7865 6375 746f 7220 2873       executor (s
-000116a0: 7472 2c20 6f70 7469 6f6e 616c 293a 2045  tr, optional): E
-000116b0: 7865 6375 746f 7220 746f 2075 7365 2e20  xecutor to use. 
-000116c0: 4465 6661 756c 7473 2074 6f20 2274 6f72  Defaults to "tor
-000116d0: 6368 222e 0a0a 2320 2020 2020 5265 7475  ch"...#     Retu
-000116e0: 726e 733a 0a23 2020 2020 2020 2020 2054  rns:.#         T
-000116f0: 6865 2072 6573 756c 7420 6f66 2074 6865  he result of the
-00011700: 2076 6d61 7070 6564 2066 756e 6374 696f   vmapped functio
-00011710: 6e2e 0a23 2020 2020 2022 2222 0a23 2020  n..#     """.#  
-00011720: 2020 2023 2054 4f44 4f3a 2066 6978 2074     # TODO: fix t
-00011730: 6869 7320 2d20 6e6f 7420 616c 6c20 6172  his - not all ar
-00011740: 6773 206d 6179 2062 6520 6261 7463 6865  gs may be batche
-00011750: 640a 2320 2020 2020 2320 544f 444f 3a20  d.#     # TODO: 
-00011760: 6865 7265 2077 6520 6173 7375 6d65 2062  here we assume b
-00011770: 6174 6368 2061 7869 7320 6973 2030 0a23  atch axis is 0.#
-00011780: 2020 2020 2076 6d61 705f 7472 6163 6520       vmap_trace 
-00011790: 3d20 6d61 6b65 5f74 7261 6365 280a 2320  = make_trace(.# 
-000117a0: 2020 2020 2020 2020 766d 6170 2866 756e          vmap(fun
-000117b0: 632c 2069 6e5f 6469 6d73 3d69 6e5f 6469  c, in_dims=in_di
-000117c0: 6d73 2c20 6f75 745f 6469 6d73 3d6f 7574  ms, out_dims=out
-000117d0: 5f64 696d 732c 2061 7869 735f 7369 7a65  _dims, axis_size
-000117e0: 3d61 7869 735f 7369 7a65 292c 2065 7865  =axis_size), exe
-000117f0: 6375 746f 723d 6578 6563 7574 6f72 2c0a  cutor=executor,.
-00011800: 2320 2020 2020 2020 2020 2a61 7267 7329  #         *args)
-00011810: 0a23 2020 2020 2076 6d61 705f 7472 6163  .#     vmap_trac
-00011820: 6564 203d 206d 616b 655f 7472 6163 6564  ed = make_traced
-00011830: 2870 6172 7469 616c 2865 7661 6c5f 7472  (partial(eval_tr
-00011840: 6163 652c 2076 6d61 705f 7472 6163 6529  ace, vmap_trace)
-00011850: 2c20 6578 6563 7574 6f72 3d65 7865 6375  , executor=execu
-00011860: 746f 7229 0a23 2020 2020 2072 6574 7572  tor).#     retur
-00011870: 6e20 766d 6170 5f74 7261 6365 6428 2a61  n vmap_traced(*a
-00011880: 7267 7329 0a0a 0a23 204a 5650 2074 7261  rgs)...# JVP tra
-00011890: 6e73 666f 726d 0a23 202d 2d2d 2d2d 2d2d  nsform.# -------
-000118a0: 2d2d 2d2d 2d2d 0a0a 0a40 6461 7461 636c  ------...@datacl
-000118b0: 6173 7328 6672 6f7a 656e 3d54 7275 6529  ass(frozen=True)
-000118c0: 0a63 6c61 7373 204a 5650 4475 616c 3a0a  .class JVPDual:.
-000118d0: 2020 2020 2222 2244 7561 6c20 6e75 6d62      """Dual numb
-000118e0: 6572 2066 6f72 2074 6865 204a 5650 2074  er for the JVP t
-000118f0: 7261 6e73 666f 726d 2e0a 0a20 2020 2041  ransform...    A
-00011900: 7474 7269 6275 7465 733a 0a20 2020 2020  ttributes:.     
-00011910: 2020 2070 7269 6d61 6c3a 2050 7269 6d61     primal: Prima
-00011920: 6c20 7661 6c75 652e 0a20 2020 2020 2020  l value..       
-00011930: 2074 616e 6765 6e74 3a20 5461 6e67 656e   tangent: Tangen
-00011940: 7420 7661 6c75 652e 0a20 2020 2022 2222  t value..    """
-00011950: 0a0a 2020 2020 7072 696d 616c 3a20 416e  ..    primal: An
-00011960: 790a 2020 2020 7461 6e67 656e 743a 2041  y.    tangent: A
-00011970: 6e79 0a0a 2020 2020 6465 6620 5f5f 6974  ny..    def __it
-00011980: 6572 5f5f 2873 656c 6629 3a0a 2020 2020  er__(self):.    
-00011990: 2020 2020 7969 656c 6420 7365 6c66 2e70      yield self.p
-000119a0: 7269 6d61 6c0a 2020 2020 2020 2020 7969  rimal.        yi
-000119b0: 656c 6420 7365 6c66 2e74 616e 6765 6e74  eld self.tangent
-000119c0: 0a0a 0a64 6566 2070 6169 725f 746f 5f6a  ...def pair_to_j
-000119d0: 7670 5f64 7561 6c28 7061 6972 293a 0a20  vp_dual(pair):. 
-000119e0: 2020 2022 2222 436f 6e76 6572 7473 2061     """Converts a
-000119f0: 2070 6169 7220 746f 2061 204a 5650 4475   pair to a JVPDu
-00011a00: 616c 2e0a 0a20 2020 2041 7267 733a 0a20  al...    Args:. 
-00011a10: 2020 2020 2020 2070 6169 7220 2853 6571         pair (Seq
-00011a20: 7565 6e63 6529 3a20 5061 6972 2074 6f20  uence): Pair to 
-00011a30: 636f 6e76 6572 742e 0a0a 2020 2020 5265  convert...    Re
-00011a40: 7475 726e 733a 0a20 2020 2020 2020 204a  turns:.        J
-00011a50: 5650 4475 616c 3a20 4a56 5044 7561 6c20  VPDual: JVPDual 
-00011a60: 7265 7072 6573 656e 7461 7469 6f6e 206f  representation o
-00011a70: 6620 7468 6520 7061 6972 2e0a 2020 2020  f the pair..    
-00011a80: 2222 220a 2020 2020 6966 2069 7369 6e73  """.    if isins
-00011a90: 7461 6e63 6528 7061 6972 2c20 4a56 5044  tance(pair, JVPD
-00011aa0: 7561 6c29 3a0a 2020 2020 2020 2020 7265  ual):.        re
-00011ab0: 7475 726e 2070 6169 720a 2020 2020 656c  turn pair.    el
-00011ac0: 7365 3a0a 2020 2020 2020 2020 6173 7365  se:.        asse
-00011ad0: 7274 2069 7369 6e73 7461 6e63 6528 7061  rt isinstance(pa
-00011ae0: 6972 2c20 5365 7175 656e 6365 2920 616e  ir, Sequence) an
-00011af0: 6420 6c65 6e28 7061 6972 2920 3d3d 2032  d len(pair) == 2
-00011b00: 0a20 2020 2020 2020 2072 6574 7572 6e20  .        return 
-00011b10: 4a56 5044 7561 6c28 2a70 6169 7229 0a0a  JVPDual(*pair)..
-00011b20: 0a64 6566 2073 696e 5f6a 7670 2861 3a20  .def sin_jvp(a: 
-00011b30: 4a56 5044 7561 6c29 3a0a 2020 2020 782c  JVPDual):.    x,
-00011b40: 2078 6420 3d20 610a 2020 2020 7265 7475   xd = a.    retu
-00011b50: 726e 204a 5650 4475 616c 2870 7269 6d73  rn JVPDual(prims
-00011b60: 2e73 696e 2878 292c 2070 7269 6d73 2e63  .sin(x), prims.c
-00011b70: 6f73 2878 2920 2a20 7864 290a 0a0a 6465  os(x) * xd)...de
-00011b80: 6620 6d75 6c5f 6a76 7028 613a 204a 5650  f mul_jvp(a: JVP
-00011b90: 4475 616c 2c20 623a 204a 5650 4475 616c  Dual, b: JVPDual
-00011ba0: 293a 0a20 2020 2078 2c20 7864 203d 2061  ):.    x, xd = a
-00011bb0: 0a20 2020 2079 2c20 7964 203d 2062 0a20  .    y, yd = b. 
-00011bc0: 2020 2072 6574 7572 6e20 4a56 5044 7561     return JVPDua
-00011bd0: 6c28 7820 2a20 792c 2078 202a 2079 6420  l(x * y, x * yd 
-00011be0: 2b20 7920 2a20 7864 290a 0a0a 6465 6620  + y * xd)...def 
-00011bf0: 6164 645f 6a76 7028 613a 204a 5650 4475  add_jvp(a: JVPDu
-00011c00: 616c 2c20 623a 204a 5650 4475 616c 293a  al, b: JVPDual):
-00011c10: 0a20 2020 2078 2c20 7864 203d 2061 0a20  .    x, xd = a. 
-00011c20: 2020 2079 2c20 7964 203d 2062 0a20 2020     y, yd = b.   
-00011c30: 2072 6574 7572 6e20 4a56 5044 7561 6c28   return JVPDual(
-00011c40: 7820 2b20 792c 2078 6420 2b20 7964 290a  x + y, xd + yd).
-00011c50: 0a0a 6465 6620 6272 6f61 6463 6173 745f  ..def broadcast_
-00011c60: 696e 5f64 696d 5f6a 7670 2861 3a20 4a56  in_dim_jvp(a: JV
-00011c70: 5044 7561 6c2c 2073 6861 7065 3a20 7475  PDual, shape: tu
-00011c80: 706c 655b 4a56 5044 7561 6c2c 202e 2e2e  ple[JVPDual, ...
-00011c90: 5d2c 2062 726f 6164 6361 7374 5f64 696d  ], broadcast_dim
-00011ca0: 656e 7369 6f6e 733a 2074 7570 6c65 5b4a  ensions: tuple[J
-00011cb0: 5650 4475 616c 2c20 2e2e 2e5d 2920 2d3e  VPDual, ...]) ->
-00011cc0: 204a 5650 4475 616c 3a0a 2020 2020 782c   JVPDual:.    x,
-00011cd0: 2078 6420 3d20 610a 2020 2020 2320 544f   xd = a.    # TO
-00011ce0: 444f 3a20 7368 6170 6520 616e 6420 6272  DO: shape and br
-00011cf0: 6f61 6463 6173 745f 6469 6d65 6e73 696f  oadcast_dimensio
-00011d00: 6e73 2073 686f 756c 6420 6265 2074 7570  ns should be tup
-00011d10: 6c65 7320 6f66 2069 6e74 730a 2020 2020  les of ints.    
-00011d20: 2320 6275 7420 666f 7220 6e6f 7720 6974  # but for now it
-00011d30: 2773 2061 2074 7570 6c65 206f 6620 4a56  's a tuple of JV
-00011d40: 5044 7561 6c73 0a20 2020 2069 6620 6c65  PDuals.    if le
-00011d50: 6e28 7368 6170 6529 203e 2030 2061 6e64  n(shape) > 0 and
-00011d60: 2069 7369 6e73 7461 6e63 6528 7368 6170   isinstance(shap
-00011d70: 655b 305d 2c20 4a56 5044 7561 6c29 3a0a  e[0], JVPDual):.
-00011d80: 2020 2020 2020 2020 7368 6170 652c 205f          shape, _
-00011d90: 203d 2073 6166 655f 7a69 7028 2a73 6861   = safe_zip(*sha
-00011da0: 7065 290a 2020 2020 6966 206c 656e 2862  pe).    if len(b
-00011db0: 726f 6164 6361 7374 5f64 696d 656e 7369  roadcast_dimensi
-00011dc0: 6f6e 7329 203e 2030 2061 6e64 2069 7369  ons) > 0 and isi
-00011dd0: 6e73 7461 6e63 6528 6272 6f61 6463 6173  nstance(broadcas
-00011de0: 745f 6469 6d65 6e73 696f 6e73 5b30 5d2c  t_dimensions[0],
-00011df0: 204a 5650 4475 616c 293a 0a20 2020 2020   JVPDual):.     
-00011e00: 2020 2062 726f 6164 6361 7374 5f64 696d     broadcast_dim
-00011e10: 656e 7369 6f6e 732c 205f 203d 2073 6166  ensions, _ = saf
-00011e20: 655f 7a69 7028 2a62 726f 6164 6361 7374  e_zip(*broadcast
-00011e30: 5f64 696d 656e 7369 6f6e 7329 0a20 2020  _dimensions).   
-00011e40: 2072 6574 7572 6e20 4a56 5044 7561 6c28   return JVPDual(
-00011e50: 0a20 2020 2020 2020 2070 7269 6d73 2e62  .        prims.b
-00011e60: 726f 6164 6361 7374 5f69 6e5f 6469 6d28  roadcast_in_dim(
-00011e70: 782c 2073 6861 7065 2c20 6272 6f61 6463  x, shape, broadc
-00011e80: 6173 745f 6469 6d65 6e73 696f 6e73 292c  ast_dimensions),
-00011e90: 2070 7269 6d73 2e62 726f 6164 6361 7374   prims.broadcast
-00011ea0: 5f69 6e5f 6469 6d28 7864 2c20 7368 6170  _in_dim(xd, shap
-00011eb0: 652c 2062 726f 6164 6361 7374 5f64 696d  e, broadcast_dim
-00011ec0: 656e 7369 6f6e 7329 0a20 2020 2029 0a0a  ensions).    )..
-00011ed0: 0a64 6566 2075 6e70 6163 6b5f 7365 7175  .def unpack_sequ
-00011ee0: 656e 6365 5f6a 7670 2873 6571 7565 6e63  ence_jvp(sequenc
-00011ef0: 653a 204a 5650 4475 616c 2c20 6c65 6e67  e: JVPDual, leng
-00011f00: 7468 3a20 4a56 5044 7561 6c29 202d 3e20  th: JVPDual) -> 
-00011f10: 4a56 5044 7561 6c3a 0a20 2020 2078 203d  JVPDual:.    x =
-00011f20: 2074 7265 655f 6d61 7028 6c61 6d62 6461   tree_map(lambda
-00011f30: 2078 3a20 782e 7072 696d 616c 2c20 7365   x: x.primal, se
-00011f40: 7175 656e 6365 290a 2020 2020 7864 203d  quence).    xd =
-00011f50: 2074 7265 655f 6d61 7028 6c61 6d62 6461   tree_map(lambda
-00011f60: 2078 3a20 782e 7461 6e67 656e 742c 2073   x: x.tangent, s
-00011f70: 6571 7565 6e63 6529 0a20 2020 206c 656e  equence).    len
-00011f80: 6774 682c 205f 203d 206c 656e 6774 680a  gth, _ = length.
-00011f90: 2020 2020 7072 696d 616c 7320 3d20 7072      primals = pr
-00011fa0: 696d 732e 756e 7061 636b 5f73 6571 7565  ims.unpack_seque
-00011fb0: 6e63 6528 782c 206c 656e 6774 6829 0a20  nce(x, length). 
-00011fc0: 2020 2074 616e 6765 6e74 7320 3d20 7072     tangents = pr
-00011fd0: 696d 732e 756e 7061 636b 5f73 6571 7565  ims.unpack_seque
-00011fe0: 6e63 6528 7864 2c20 6c65 6e67 7468 290a  nce(xd, length).
-00011ff0: 2020 2020 7265 7475 726e 2073 6166 655f      return safe_
-00012000: 6d61 7028 7061 6972 5f74 6f5f 6a76 705f  map(pair_to_jvp_
-00012010: 6475 616c 2c20 7361 6665 5f7a 6970 2870  dual, safe_zip(p
-00012020: 7269 6d61 6c73 2c20 7461 6e67 656e 7473  rimals, tangents
-00012030: 2929 0a0a 0a64 6566 2075 6e70 6163 6b5f  ))...def unpack_
-00012040: 7472 6976 6961 6c5f 6a76 7028 783a 204a  trivial_jvp(x: J
-00012050: 5650 4475 616c 2920 2d3e 204a 5650 4475  VPDual) -> JVPDu
-00012060: 616c 3a0a 2020 2020 7265 7475 726e 2078  al:.    return x
-00012070: 0a0a 0a6a 7670 5f69 6d70 6c73 3a20 6469  ...jvp_impls: di
-00012080: 6374 5b70 7269 6d73 2e53 796d 626f 6c2c  ct[prims.Symbol,
-00012090: 2043 616c 6c61 626c 655d 203d 2064 6963   Callable] = dic
-000120a0: 7428 290a 0a6a 7670 5f69 6d70 6c73 5b70  t()..jvp_impls[p
-000120b0: 7269 6d73 2e50 7269 6d49 4473 2e53 494e  rims.PrimIDs.SIN
-000120c0: 5d20 3d20 7369 6e5f 6a76 700a 6a76 705f  ] = sin_jvp.jvp_
-000120d0: 696d 706c 735b 7072 696d 732e 5072 696d  impls[prims.Prim
-000120e0: 4944 732e 4d55 4c5d 203d 206d 756c 5f6a  IDs.MUL] = mul_j
-000120f0: 7670 0a6a 7670 5f69 6d70 6c73 5b70 7269  vp.jvp_impls[pri
-00012100: 6d73 2e50 7269 6d49 4473 2e41 4444 5d20  ms.PrimIDs.ADD] 
-00012110: 3d20 6164 645f 6a76 700a 6a76 705f 696d  = add_jvp.jvp_im
-00012120: 706c 735b 7072 696d 732e 5072 696d 4944  pls[prims.PrimID
-00012130: 732e 4252 4f41 4443 4153 545f 494e 5f44  s.BROADCAST_IN_D
-00012140: 494d 5d20 3d20 6272 6f61 6463 6173 745f  IM] = broadcast_
-00012150: 696e 5f64 696d 5f6a 7670 0a23 206a 7670  in_dim_jvp.# jvp
+0000b710: 2020 2020 2320 4e4f 5445 2049 6620 6163      # NOTE If ac
+0000b720: 7475 616c 5f67 7261 6420 6973 204e 6f6e  tual_grad is Non
+0000b730: 6520 7468 656e 2074 6865 7265 2773 2061  e then there's a
+0000b740: 2067 6574 5f67 7261 6428 2920 7265 7175   get_grad() requ
+0000b750: 6573 7420 666f 7220 6120 7465 6e73 6f72  est for a tensor
+0000b760: 2077 6869 6368 0a20 2020 2020 2020 2020   which.         
+0000b770: 2020 2020 2020 2020 2020 2023 2020 2068             #   h
+0000b780: 6173 206e 6f20 7075 745f 6772 6164 2829  as no put_grad()
+0000b790: 2c20 736f 2077 6520 7265 7475 726e 207a  , so we return z
+0000b7a0: 6572 6f73 2066 6f72 2074 6865 2067 7261  eros for the gra
+0000b7b0: 640a 2020 2020 2020 2020 2020 2020 2020  d.              
+0000b7c0: 2020 2020 2020 2320 544f 444f 2052 6576        # TODO Rev
+0000b7d0: 6973 6974 2074 6869 7320 2d2d 2063 616e  isit this -- can
+0000b7e0: 2077 6520 7265 6d6f 7665 2074 6865 7365   we remove these
+0000b7f0: 2063 6f6d 7075 7461 7469 6f6e 732c 206f   computations, o
+0000b800: 7220 7573 6520 6120 7370 6563 6961 6c20  r use a special 
+0000b810: 5a65 726f 5465 6e73 6f72 0a20 2020 2020  ZeroTensor.     
+0000b820: 2020 2020 2020 2020 2020 2020 2020 2023                 #
+0000b830: 2020 2074 6f20 7369 6d70 6c69 6679 2074     to simplify t
+0000b840: 6865 6d3f 0a20 2020 2020 2020 2020 2020  hem?.           
+0000b850: 2020 2020 2020 2020 2069 6620 6163 7475           if actu
+0000b860: 616c 5f67 7261 6420 6973 204e 6f6e 653a  al_grad is None:
+0000b870: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0000b880: 2020 2020 2020 2020 2061 6374 7561 6c5f           actual_
+0000b890: 6772 6164 203d 206c 746f 7263 682e 7a65  grad = ltorch.ze
+0000b8a0: 726f 735f 6c69 6b65 2870 7269 6d61 6c29  ros_like(primal)
+0000b8b0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0000b8c0: 2020 2020 2020 2020 2070 7269 6d61 6c73           primals
+0000b8d0: 5f74 6f5f 6769 6e70 7574 5f6d 6170 5b76  _to_ginput_map[v
+0000b8e0: 7072 696d 616c 5d20 3d20 6163 7475 616c  primal] = actual
+0000b8f0: 5f67 7261 640a 0a20 2020 2020 2020 2020  _grad..         
+0000b900: 2020 2020 2020 2020 2020 2023 2055 7064             # Upd
+0000b910: 6174 6573 2074 6865 2067 7261 6420 616c  ates the grad al
+0000b920: 6961 7320 6d61 700a 2020 2020 2020 2020  ias map.        
+0000b930: 2020 2020 2020 2020 2020 2020 7661 6374              vact
+0000b940: 7561 6c5f 6772 6164 3a20 5661 7269 6162  ual_grad: Variab
+0000b950: 6c65 203d 2076 6172 6961 626c 6569 6679  le = variableify
+0000b960: 2861 6374 7561 6c5f 6772 6164 290a 2020  (actual_grad).  
+0000b970: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000b980: 2020 6966 2076 6163 7475 616c 5f67 7261    if vactual_gra
+0000b990: 6420 213d 2076 6772 6164 3a0a 2020 2020  d != vgrad:.    
+0000b9a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000b9b0: 2020 2020 7377 6170 6d61 705b 7667 7261      swapmap[vgra
+0000b9c0: 645d 203d 2061 6374 7561 6c5f 6772 6164  d] = actual_grad
+0000b9d0: 0a0a 2020 2020 2020 2020 6669 6e61 6c6c  ..        finall
+0000b9e0: 793a 0a20 2020 2020 2020 2020 2020 2023  y:.            #
+0000b9f0: 2052 6573 746f 7265 7320 7363 6f70 650a   Restores scope.
+0000ba00: 2020 2020 2020 2020 2020 2020 7265 7365              rese
+0000ba10: 745f 7472 6163 6563 7478 2874 7261 6365  t_tracectx(trace
+0000ba20: 6374 785f 746f 6b29 0a0a 2020 2020 2020  ctx_tok)..      
+0000ba30: 2020 2320 4669 6c74 6572 7320 7075 745f    # Filters put_
+0000ba40: 6772 6164 2061 6e64 2067 6574 5f67 7261  grad and get_gra
+0000ba50: 6420 6f70 6572 6174 696f 6e73 2061 6e64  d operations and
+0000ba60: 2061 7070 6c69 6573 2074 6865 2073 7761   applies the swa
+0000ba70: 706d 6170 0a20 2020 2020 2020 2064 6566  pmap.        def
+0000ba80: 205f 6669 6c74 6572 2862 7379 6d3a 2042   _filter(bsym: B
+0000ba90: 6f75 6e64 5379 6d62 6f6c 2920 2d3e 2062  oundSymbol) -> b
+0000baa0: 6f6f 6c3a 0a20 2020 2020 2020 2020 2020  ool:.           
+0000bab0: 2069 643a 2048 6173 6861 626c 6520 3d20   id: Hashable = 
+0000bac0: 6273 796d 2e73 796d 2e69 640a 2020 2020  bsym.sym.id.    
+0000bad0: 2020 2020 2020 2020 7265 7475 726e 2069          return i
+0000bae0: 6420 696e 2028 7069 6473 2e50 5554 5f47  d in (pids.PUT_G
+0000baf0: 5241 442c 2070 6964 732e 4745 545f 4752  RAD, pids.GET_GR
+0000bb00: 4144 290a 0a20 2020 2020 2020 2067 7261  AD)..        gra
+0000bb10: 6474 7263 2e62 6f75 6e64 5f73 796d 626f  dtrc.bound_symbo
+0000bb20: 6c73 203d 205b 0a20 2020 2020 2020 2020  ls = [.         
+0000bb30: 2020 2062 7379 6d2e 6672 6f6d 5f62 7379     bsym.from_bsy
+0000bb40: 6d5f 7377 6170 5f70 726f 7869 6573 2873  m_swap_proxies(s
+0000bb50: 7761 706d 6170 2920 666f 7220 6273 796d  wapmap) for bsym
+0000bb60: 2069 6e20 6772 6164 7472 632e 626f 756e   in gradtrc.boun
+0000bb70: 645f 7379 6d62 6f6c 7320 6966 206e 6f74  d_symbols if not
+0000bb80: 205f 6669 6c74 6572 2862 7379 6d29 0a20   _filter(bsym). 
+0000bb90: 2020 2020 2020 205d 0a0a 2020 2020 2020         ]..      
+0000bba0: 2020 2320 5354 4550 2046 4f55 5220 2d2d    # STEP FOUR --
+0000bbb0: 2d20 4f72 6465 7273 2074 6865 206f 7065  - Orders the ope
+0000bbc0: 7261 7469 6f6e 730a 2020 2020 2020 2020  rations.        
+0000bbd0: 2320 544f 444f 2043 6f6e 7369 6465 7220  # TODO Consider 
+0000bbe0: 616c 7465 726e 6174 6976 6520 7363 6865  alternative sche
+0000bbf0: 6475 6c69 6e67 2061 6c67 6f72 6974 686d  duling algorithm
+0000bc00: 732c 206d 6179 6265 2062 7920 7573 696e  s, maybe by usin
+0000bc10: 6720 6772 6170 6820 6665 6174 7572 6573  g graph features
+0000bc20: 0a20 2020 2020 2020 2023 2020 2053 6f6d  .        #   Som
+0000bc30: 6520 6964 6561 7320 6172 6520 6c6f 6f6b  e ideas are look
+0000bc40: 696e 6720 6174 206d 656d 6f72 792d 7361  ing at memory-sa
+0000bc50: 7669 6e67 206e 6f64 6573 2c20 616e 6420  ving nodes, and 
+0000bc60: 6e6f 6465 7320 7769 7468 2061 2068 6967  nodes with a hig
+0000bc70: 6820 696e 2d64 6567 7265 6520 6f72 2068  h in-degree or h
+0000bc80: 6967 6820 6f75 742d 6465 6772 6565 0a0a  igh out-degree..
+0000bc90: 2020 2020 2020 2020 2320 4372 6561 7465          # Create
+0000bca0: 7320 616e 2069 6e69 7469 616c 2076 616c  s an initial val
+0000bcb0: 6964 206f 7264 6572 696e 6720 746f 2044  id ordering to D
+0000bcc0: 4345 2c20 736f 2074 6861 7420 6164 6469  CE, so that addi
+0000bcd0: 7469 6f6e 616c 206f 7264 6572 696e 6720  tional ordering 
+0000bce0: 616e 616c 7973 6973 2064 6f65 736e 2774  analysis doesn't
+0000bcf0: 206e 6565 6420 746f 2063 6f6e 7369 6465   need to conside
+0000bd00: 7220 616c 6c20 7379 6d62 6f6c 730a 2020  r all symbols.  
+0000bd10: 2020 2020 2020 726f 6f74 732c 206c 6561        roots, lea
+0000bd20: 7665 7320 3d20 6273 796d 5f6c 6973 745f  ves = bsym_list_
+0000bd30: 746f 5f64 6167 2867 7261 6474 7263 2e62  to_dag(gradtrc.b
+0000bd40: 6f75 6e64 5f73 796d 626f 6c73 290a 2020  ound_symbols).  
+0000bd50: 2020 2020 2020 6f72 6465 7265 645f 6273        ordered_bs
+0000bd60: 796d 7320 3d20 746f 706f 736f 7274 5f62  yms = toposort_b
+0000bd70: 7379 6d5f 6461 6728 726f 6f74 732c 2054  sym_dag(roots, T
+0000bd80: 4f50 4f53 4f52 545f 4f52 4445 522e 544f  OPOSORT_ORDER.TO
+0000bd90: 505f 444f 574e 290a 2020 2020 2020 2020  P_DOWN).        
+0000bda0: 6772 6164 7472 632e 626f 756e 645f 7379  gradtrc.bound_sy
+0000bdb0: 6d62 6f6c 7320 3d20 6f72 6465 7265 645f  mbols = ordered_
+0000bdc0: 6273 796d 730a 2020 2020 2020 2020 6772  bsyms.        gr
+0000bdd0: 6164 7472 6320 3d20 6463 6528 6772 6164  adtrc = dce(grad
+0000bde0: 7472 6329 0a0a 2020 2020 2020 2020 2320  trc)..        # 
+0000bdf0: 4964 656e 7469 6669 6573 2074 6865 206f  Identifies the o
+0000be00: 7264 6572 206f 6620 426f 756e 6453 796d  rder of BoundSym
+0000be10: 626f 6c73 2075 7369 6e67 2061 2022 4446  bols using a "DF
+0000be20: 5320 616e 6420 6368 6169 6e22 2061 6c67  S and chain" alg
+0000be30: 6f72 6974 686d 0a20 2020 2020 2020 2023  orithm.        #
+0000be40: 2054 4f44 4f20 456c 6162 6f72 6174 6520   TODO Elaborate 
+0000be50: 6f6e 2074 6869 7320 616c 676f 7269 7468  on this algorith
+0000be60: 6d20 616e 6420 7468 6520 696d 706c 656d  m and the implem
+0000be70: 656e 7461 7469 6f6e 0a20 2020 2020 2020  entation.       
+0000be80: 2072 6f6f 7473 2c20 6c65 6176 6573 203d   roots, leaves =
+0000be90: 2062 7379 6d5f 6c69 7374 5f74 6f5f 6461   bsym_list_to_da
+0000bea0: 6728 6772 6164 7472 632e 626f 756e 645f  g(gradtrc.bound_
+0000beb0: 7379 6d62 6f6c 7329 0a20 2020 2020 2020  symbols).       
+0000bec0: 2063 6865 636b 280a 2020 2020 2020 2020   check(.        
+0000bed0: 2020 2020 6c65 6e28 6c65 6176 6573 2920      len(leaves) 
+0000bee0: 3d3d 2031 2c0a 2020 2020 2020 2020 2020  == 1,.          
+0000bef0: 2020 6c61 6d62 6461 3a20 6622 4578 7065    lambda: f"Expe
+0000bf00: 6374 6564 206f 6e6c 7920 6f6e 6520 6c65  cted only one le
+0000bf10: 6166 206e 6f64 6520 7768 656e 2073 6f72  af node when sor
+0000bf20: 7469 6e67 2066 6f72 2067 7261 642c 2066  ting for grad, f
+0000bf30: 6f75 6e64 2074 6865 7265 2077 6572 6520  ound there were 
+0000bf40: 7b6c 656e 286c 6561 7665 7329 7d20 6c65  {len(leaves)} le
+0000bf50: 6176 6573 222c 0a20 2020 2020 2020 2029  aves",.        )
+0000bf60: 0a20 2020 2020 2020 2028 6c65 6166 2c29  .        (leaf,)
+0000bf70: 203d 206c 6561 7665 730a 0a20 2020 2020   = leaves..     
+0000bf80: 2020 2023 2043 6f6d 7075 7465 7320 7468     # Computes th
+0000bf90: 6520 7465 6e73 6f72 206d 656d 6f72 7920  e tensor memory 
+0000bfa0: 7573 6564 2062 7920 7468 6520 6769 7665  used by the give
+0000bfb0: 6e20 7079 7472 6565 0a20 2020 2020 2020  n pytree.       
+0000bfc0: 2064 6566 206d 656d 6f72 795f 7573 6564   def memory_used
+0000bfd0: 2870 7974 7265 6529 202d 3e20 696e 743a  (pytree) -> int:
+0000bfe0: 0a20 2020 2020 2020 2020 2020 206d 656d  .            mem
+0000bff0: 6f72 795f 7573 653a 2069 6e74 203d 2030  ory_use: int = 0
+0000c000: 0a0a 2020 2020 2020 2020 2020 2020 6465  ..            de
+0000c010: 6620 636f 756e 745f 6d65 6d6f 7279 5f75  f count_memory_u
+0000c020: 7365 2878 293a 0a20 2020 2020 2020 2020  se(x):.         
+0000c030: 2020 2020 2020 206e 6f6e 6c6f 6361 6c20         nonlocal 
+0000c040: 6d65 6d6f 7279 5f75 7365 0a20 2020 2020  memory_use.     
+0000c050: 2020 2020 2020 2020 2020 2069 6620 6973             if is
+0000c060: 696e 7374 616e 6365 2878 2c20 5465 6e73  instance(x, Tens
+0000c070: 6f72 5072 6f78 7929 3a0a 2020 2020 2020  orProxy):.      
+0000c080: 2020 2020 2020 2020 2020 2020 2020 6d65                me
+0000c090: 6d6f 7279 5f75 7365 202b 3d20 782e 6474  mory_use += x.dt
+0000c0a0: 7970 652e 5f62 7974 6573 202a 2078 2e6e  ype._bytes * x.n
+0000c0b0: 756d 656c 0a0a 2020 2020 2020 2020 2020  umel..          
+0000c0c0: 2020 7472 6565 5f6d 6170 2863 6f75 6e74    tree_map(count
+0000c0d0: 5f6d 656d 6f72 795f 7573 652c 2070 7974  _memory_use, pyt
+0000c0e0: 7265 6529 0a20 2020 2020 2020 2020 2020  ree).           
+0000c0f0: 2072 6574 7572 6e20 6d65 6d6f 7279 5f75   return memory_u
+0000c100: 7365 0a0a 2020 2020 2020 2020 2320 5472  se..        # Tr
+0000c110: 7565 2077 6865 6e20 6120 6e6f 6465 2069  ue when a node i
+0000c120: 7320 6120 226c 696e 6b22 202d 2d20 6120  s a "link" -- a 
+0000c130: 6e6f 6465 2077 6974 6820 6f6e 6c79 206f  node with only o
+0000c140: 6e65 2063 6869 6c64 2061 6e64 2061 7420  ne child and at 
+0000c150: 6d6f 7374 206f 6e65 2070 6172 656e 740a  most one parent.
+0000c160: 2020 2020 2020 2020 2320 2020 436f 6e63          #   Conc
+0000c170: 6570 7475 616c 6c79 2074 6865 206e 6f64  eptually the nod
+0000c180: 6520 6973 2061 2022 6c69 6e6b 2220 696e  e is a "link" in
+0000c190: 2061 2063 6861 696e 206f 6620 6e6f 6465   a chain of node
+0000c1a0: 7320 6c69 6b65 2041 202d 3e20 4220 2d3e  s like A -> B ->
+0000c1b0: 2043 0a20 2020 2020 2020 2064 6566 2069   C.        def i
+0000c1c0: 735f 6c69 6e6b 286e 3a20 4e6f 6465 2920  s_link(n: Node) 
+0000c1d0: 2d3e 2062 6f6f 6c3a 0a20 2020 2020 2020  -> bool:.       
+0000c1e0: 2020 2020 205f 6973 5f6c 696e 6b20 3d20       _is_link = 
+0000c1f0: 6c65 6e28 6e2e 6368 696c 6472 656e 2920  len(n.children) 
+0000c200: 3d3d 2031 2061 6e64 206c 656e 286e 2e70  == 1 and len(n.p
+0000c210: 6172 656e 7473 2920 3c3d 2031 0a20 2020  arents) <= 1.   
+0000c220: 2020 2020 2020 2020 2072 6574 7572 6e20           return 
+0000c230: 5f69 735f 6c69 6e6b 0a0a 2020 2020 2020  _is_link..      
+0000c240: 2020 636f 756e 7465 723a 2069 6e74 203d    counter: int =
+0000c250: 2030 0a0a 2020 2020 2020 2020 6465 6620   0..        def 
+0000c260: 5f63 6861 696e 2863 3a20 6c69 7374 5b4e  _chain(c: list[N
+0000c270: 6f64 655d 2c20 656e 643a 204e 6f64 6529  ode], end: Node)
+0000c280: 202d 3e20 6c69 7374 5b4e 6f64 655d 3a0a   -> list[Node]:.
+0000c290: 2020 2020 2020 2020 2020 2020 6e6f 6e6c              nonl
+0000c2a0: 6f63 616c 2063 6f75 6e74 6572 0a0a 2020  ocal counter..  
+0000c2b0: 2020 2020 2020 2020 2020 2320 544f 444f            # TODO
+0000c2c0: 2045 7870 6572 696d 656e 7420 7769 7468   Experiment with
+0000c2d0: 206e 6f74 2061 6c77 6179 7320 6675 7369   not always fusi
+0000c2e0: 6e67 2074 6869 7320 696e 746f 2074 6865  ng this into the
+0000c2f0: 2063 6f6e 7375 6d65 7220 2d2d 2074 6865   consumer -- the
+0000c300: 7265 2063 6f75 6c64 2062 6520 616e 0a20  re could be an. 
+0000c310: 2020 2020 2020 2020 2020 2023 2020 2069             #   i
+0000c320: 6e74 6572 6573 7469 6e67 206d 696e 6375  nteresting mincu
+0000c330: 740a 2020 2020 2020 2020 2020 2020 2320  t.            # 
+0000c340: 4e4f 5445 2049 6e20 7468 6973 2063 6173  NOTE In this cas
+0000c350: 6520 7468 6520 6368 6169 6e20 6361 6e6e  e the chain cann
+0000c360: 6f74 2062 6520 6578 7465 6e64 6564 2c20  ot be extended, 
+0000c370: 616e 6420 6974 7320 6f72 6967 696e 2069  and its origin i
+0000c380: 7320 696e 7075 7420 746f 2074 6865 2066  s input to the f
+0000c390: 756e 6374 696f 6e0a 2020 2020 2020 2020  unction.        
+0000c3a0: 2020 2020 2320 2020 736f 2074 6869 7320      #   so this 
+0000c3b0: 6a75 7374 2066 7573 6573 2069 7420 696e  just fuses it in
+0000c3c0: 746f 2074 6865 2063 6f6e 7375 6d65 720a  to the consumer.
+0000c3d0: 2020 2020 2020 2020 2020 2020 6966 206c              if l
+0000c3e0: 656e 2865 6e64 2e70 6172 656e 7473 2920  en(end.parents) 
+0000c3f0: 3d3d 2030 3a0a 2020 2020 2020 2020 2020  == 0:.          
+0000c400: 2020 2020 2020 666f 7220 6e20 696e 2063        for n in c
+0000c410: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+0000c420: 2020 2020 2020 6e2e 6e75 6d62 6572 203d        n.number =
+0000c430: 2063 6f75 6e74 6572 0a20 2020 2020 2020   counter.       
+0000c440: 2020 2020 2020 2020 2020 2020 2063 6f75               cou
+0000c450: 6e74 6572 202b 3d20 310a 2020 2020 2020  nter += 1.      
+0000c460: 2020 2020 2020 2020 2020 7265 7475 726e            return
+0000c470: 205b 5d0a 0a20 2020 2020 2020 2020 2020   []..           
+0000c480: 2023 204e 4f54 4520 6c65 6e28 656e 642e   # NOTE len(end.
+0000c490: 7061 7265 6e74 7329 203d 3d20 3120 6f6e  parents) == 1 on
+0000c4a0: 2074 6869 7320 7061 7468 0a20 2020 2020   this path.     
+0000c4b0: 2020 2020 2020 2028 7061 7265 6e74 2c29         (parent,)
+0000c4c0: 203d 2065 6e64 2e70 6172 656e 7473 0a0a   = end.parents..
+0000c4d0: 2020 2020 2020 2020 2020 2020 2320 4578              # Ex
+0000c4e0: 7465 6e64 7320 7468 6520 6368 6169 6e20  tends the chain 
+0000c4f0: 6966 2074 6865 2070 6172 656e 7420 6973  if the parent is
+0000c500: 2061 206c 696e 6b0a 2020 2020 2020 2020   a link.        
+0000c510: 2020 2020 6966 2069 735f 6c69 6e6b 2870      if is_link(p
+0000c520: 6172 656e 7429 3a0a 2020 2020 2020 2020  arent):.        
+0000c530: 2020 2020 2020 2020 632e 6170 7065 6e64          c.append
+0000c540: 2870 6172 656e 7429 0a20 2020 2020 2020  (parent).       
+0000c550: 2020 2020 2020 2020 2072 6574 7572 6e20           return 
+0000c560: 5f63 6861 696e 2863 2c20 7061 7265 6e74  _chain(c, parent
+0000c570: 290a 0a20 2020 2020 2020 2020 2020 2023  )..            #
+0000c580: 204e 4f54 4520 496e 2074 6869 7320 6361   NOTE In this ca
+0000c590: 7365 2074 6865 2063 6861 696e 2068 6173  se the chain has
+0000c5a0: 2061 2070 6172 656e 7420 7468 6174 2069   a parent that i
+0000c5b0: 7320 6e6f 7420 6120 6c69 6e6b 0a20 2020  s not a link.   
+0000c5c0: 2020 2020 2020 2020 2023 2046 696e 6473           # Finds
+0000c5d0: 2074 6865 206d 696e 6375 740a 2020 2020   the mincut.    
+0000c5e0: 2020 2020 2020 2020 6d69 6e63 7574 5f69          mincut_i
+0000c5f0: 6478 3a20 696e 7420 3d20 6c65 6e28 6329  dx: int = len(c)
+0000c600: 0a20 2020 2020 2020 2020 2020 206d 696e  .            min
+0000c610: 5f6d 656d 6f72 795f 7573 6167 653a 2069  _memory_usage: i
+0000c620: 6e74 203d 206d 656d 6f72 795f 7573 6564  nt = memory_used
+0000c630: 2870 6172 656e 742e 6273 796d 2e6f 7574  (parent.bsym.out
+0000c640: 7075 7429 0a0a 2020 2020 2020 2020 2020  put)..          
+0000c650: 2020 666f 7220 6964 782c 206e 2069 6e20    for idx, n in 
+0000c660: 656e 756d 6572 6174 6528 6329 3a0a 2020  enumerate(c):.  
+0000c670: 2020 2020 2020 2020 2020 2020 2020 6d65                me
+0000c680: 6d20 3d20 6d65 6d6f 7279 5f75 7365 6428  m = memory_used(
+0000c690: 6e2e 6273 796d 2e6f 7574 7075 7429 0a20  n.bsym.output). 
+0000c6a0: 2020 2020 2020 2020 2020 2020 2020 2069                 i
+0000c6b0: 6620 6d65 6d20 3c20 6d69 6e5f 6d65 6d6f  f mem < min_memo
+0000c6c0: 7279 5f75 7361 6765 3a0a 2020 2020 2020  ry_usage:.      
+0000c6d0: 2020 2020 2020 2020 2020 2020 2020 6d69                mi
+0000c6e0: 6e63 7574 5f69 6478 203d 2069 6478 0a20  ncut_idx = idx. 
+0000c6f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000c700: 2020 206d 696e 5f6d 656d 6f72 795f 7573     min_memory_us
+0000c710: 6167 6520 3d20 6d65 6d0a 0a20 2020 2020  age = mem..     
+0000c720: 2020 2020 2020 2066 6f72 2069 6478 2c20         for idx, 
+0000c730: 6e20 696e 2065 6e75 6d65 7261 7465 2863  n in enumerate(c
+0000c740: 293a 0a20 2020 2020 2020 2020 2020 2020  ):.             
+0000c750: 2020 2069 6620 6964 7820 3c20 6d69 6e63     if idx < minc
+0000c760: 7574 5f69 6478 3a0a 2020 2020 2020 2020  ut_idx:.        
+0000c770: 2020 2020 2020 2020 2020 2020 6e2e 6e75              n.nu
+0000c780: 6d62 6572 203d 2063 6f75 6e74 6572 0a20  mber = counter. 
+0000c790: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000c7a0: 2020 2063 6f75 6e74 6572 202b 3d20 310a     counter += 1.
+0000c7b0: 0a20 2020 2020 2020 2020 2020 2023 2052  .            # R
+0000c7c0: 6574 7572 6e73 2074 6865 2070 726f 6475  eturns the produ
+0000c7d0: 6365 722d 7369 6465 2063 6861 696e 2063  cer-side chain c
+0000c7e0: 7574 2069 6620 6974 2065 7869 7374 730a  ut if it exists.
+0000c7f0: 2020 2020 2020 2020 2020 2020 6966 206d              if m
+0000c800: 696e 6375 745f 6964 7820 3c20 6c65 6e28  incut_idx < len(
+0000c810: 6329 3a0a 2020 2020 2020 2020 2020 2020  c):.            
+0000c820: 2020 2020 7265 7475 726e 205b 635b 6d69      return [c[mi
+0000c830: 6e63 7574 5f69 6478 5d5d 0a20 2020 2020  ncut_idx]].     
+0000c840: 2020 2020 2020 2065 6c73 653a 0a20 2020         else:.   
+0000c850: 2020 2020 2020 2020 2020 2020 2061 7373               ass
+0000c860: 6572 7420 6d69 6e63 7574 5f69 6478 203d  ert mincut_idx =
+0000c870: 3d20 6c65 6e28 6329 0a20 2020 2020 2020  = len(c).       
+0000c880: 2020 2020 2020 2020 2072 6574 7572 6e20           return 
+0000c890: 656e 642e 7061 7265 6e74 730a 0a20 2020  end.parents..   
+0000c8a0: 2020 2020 2064 6566 2063 6861 696e 5f6f       def chain_o
+0000c8b0: 7574 286e 3a20 4e6f 6465 2c20 7374 6163  ut(n: Node, stac
+0000c8c0: 6b3a 206c 6973 745b 4e6f 6465 5d29 202d  k: list[Node]) -
+0000c8d0: 3e20 4e6f 6e65 3a0a 2020 2020 2020 2020  > None:.        
+0000c8e0: 2020 2020 2320 5368 6f72 742d 6369 7263      # Short-circ
+0000c8f0: 7569 7473 2069 6620 7468 6520 6f72 6967  uits if the orig
+0000c900: 696e 616c 206e 6f64 6520 6e20 6361 6e6e  inal node n cann
+0000c910: 6f74 2062 6520 7061 7274 206f 6620 6120  ot be part of a 
+0000c920: 6368 6169 6e0a 2020 2020 2020 2020 2020  chain.          
+0000c930: 2020 6966 206e 6f74 2069 735f 6c69 6e6b    if not is_link
+0000c940: 286e 293a 0a20 2020 2020 2020 2020 2020  (n):.           
+0000c950: 2020 2020 2073 7461 636b 2e61 7070 656e       stack.appen
+0000c960: 6428 6e29 0a20 2020 2020 2020 2020 2020  d(n).           
+0000c970: 2020 2020 2072 6574 7572 6e0a 0a20 2020       return..   
+0000c980: 2020 2020 2020 2020 2023 204e 4f54 4520           # NOTE 
+0000c990: 6973 5f6c 696e 6b28 6e29 203d 3d20 5472  is_link(n) == Tr
+0000c9a0: 7565 0a20 2020 2020 2020 2020 2020 2070  ue.            p
+0000c9b0: 6f73 745f 6368 6169 6e3a 206c 6973 745b  ost_chain: list[
+0000c9c0: 4e6f 6465 5d20 3d20 5f63 6861 696e 285b  Node] = _chain([
+0000c9d0: 6e5d 2c20 6e29 0a0a 2020 2020 2020 2020  n], n)..        
+0000c9e0: 2020 2020 666f 7220 7063 2069 6e20 706f      for pc in po
+0000c9f0: 7374 5f63 6861 696e 3a0a 2020 2020 2020  st_chain:.      
+0000ca00: 2020 2020 2020 2020 2020 7374 6163 6b2e            stack.
+0000ca10: 6170 7065 6e64 2870 6329 0a0a 2020 2020  append(pc)..    
+0000ca20: 2020 2020 7374 6163 6b3a 206c 6973 745b      stack: list[
+0000ca30: 4e6f 6465 5d20 3d20 5b6c 6561 665d 0a20  Node] = [leaf]. 
+0000ca40: 2020 2020 2020 2077 6869 6c65 206c 656e         while len
+0000ca50: 2873 7461 636b 2920 3e20 303a 0a20 2020  (stack) > 0:.   
+0000ca60: 2020 2020 2020 2020 206e 3a20 4e6f 6465           n: Node
+0000ca70: 203d 2073 7461 636b 2e70 6f70 2829 0a0a   = stack.pop()..
+0000ca80: 2020 2020 2020 2020 2020 2020 6966 206e              if n
+0000ca90: 2e6e 756d 6265 7220 6973 206e 6f74 204e  .number is not N
+0000caa0: 6f6e 653a 0a20 2020 2020 2020 2020 2020  one:.           
+0000cab0: 2020 2020 2063 6f6e 7469 6e75 650a 0a20       continue.. 
+0000cac0: 2020 2020 2020 2020 2020 206e 2e6e 756d             n.num
+0000cad0: 6265 7220 3d20 636f 756e 7465 720a 2020  ber = counter.  
+0000cae0: 2020 2020 2020 2020 2020 636f 756e 7465            counte
+0000caf0: 7220 2b3d 2031 0a0a 2020 2020 2020 2020  r += 1..        
+0000cb00: 2020 2020 666f 7220 7020 696e 206e 2e70      for p in n.p
+0000cb10: 6172 656e 7473 3a0a 2020 2020 2020 2020  arents:.        
+0000cb20: 2020 2020 2020 2020 6368 6169 6e5f 6f75          chain_ou
+0000cb30: 7428 702c 2073 7461 636b 290a 0a20 2020  t(p, stack)..   
+0000cb40: 2020 2020 2064 6566 205f 7365 6c65 6374       def _select
+0000cb50: 6f72 2865 6c69 6769 626c 655f 6e6f 6465  or(eligible_node
+0000cb60: 733a 206c 6973 745b 4e6f 6465 5d29 202d  s: list[Node]) -
+0000cb70: 3e20 696e 743a 0a20 2020 2020 2020 2020  > int:.         
+0000cb80: 2020 206d 696e 5f69 6478 3a20 696e 7420     min_idx: int 
+0000cb90: 3d20 300a 2020 2020 2020 2020 2020 2020  = 0.            
+0000cba0: 6d69 6e5f 6e75 6d62 6572 3a20 696e 7420  min_number: int 
+0000cbb0: 3d20 656c 6967 6962 6c65 5f6e 6f64 6573  = eligible_nodes
+0000cbc0: 5b30 5d2e 6e75 6d62 6572 0a0a 2020 2020  [0].number..    
+0000cbd0: 2020 2020 2020 2020 2320 4e4f 5445 2041          # NOTE A
+0000cbe0: 6c74 686f 7567 6820 7765 2776 6520 616c  lthough we've al
+0000cbf0: 7265 6164 7920 7072 6f63 6573 7365 6420  ready processed 
+0000cc00: 7468 6520 6669 7273 7420 656c 656d 656e  the first elemen
+0000cc10: 7420 6865 7265 2c20 7468 6973 2073 7469  t here, this sti
+0000cc20: 6c6c 0a20 2020 2020 2020 2020 2020 2023  ll.            #
+0000cc30: 2020 2065 6e75 6d65 7261 7465 7320 7468     enumerates th
+0000cc40: 6520 656e 7469 7265 206c 6973 7420 6320  e entire list c 
+0000cc50: 746f 2061 6c69 676e 2074 6865 2065 6e75  to align the enu
+0000cc60: 6d65 7261 7469 6f6e 2069 6478 2070 726f  meration idx pro
+0000cc70: 7065 726c 790a 2020 2020 2020 2020 2020  perly.          
+0000cc80: 2020 666f 7220 6964 782c 206e 2069 6e20    for idx, n in 
+0000cc90: 656e 756d 6572 6174 6528 656c 6967 6962  enumerate(eligib
+0000cca0: 6c65 5f6e 6f64 6573 293a 0a20 2020 2020  le_nodes):.     
+0000ccb0: 2020 2020 2020 2020 2020 2063 6865 636b             check
+0000ccc0: 286e 2e6e 756d 6265 7220 6973 206e 6f74  (n.number is not
+0000ccd0: 204e 6f6e 652c 206c 616d 6264 613a 2066   None, lambda: f
+0000cce0: 2245 7870 6563 7465 6420 6561 6368 206e  "Expected each n
+0000ccf0: 6f64 6520 746f 2062 6520 6e75 6d62 6572  ode to be number
+0000cd00: 6564 2c20 6275 7420 7b6e 7d20 7761 7320  ed, but {n} was 
+0000cd10: 6e6f 7422 290a 0a20 2020 2020 2020 2020  not")..         
+0000cd20: 2020 2020 2020 2069 6620 6e2e 6e75 6d62         if n.numb
+0000cd30: 6572 203c 206d 696e 5f6e 756d 6265 723a  er < min_number:
+0000cd40: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0000cd50: 2020 2020 206d 696e 5f69 6478 203d 2069       min_idx = i
+0000cd60: 6478 0a20 2020 2020 2020 2020 2020 2020  dx.             
+0000cd70: 2020 2020 2020 206d 696e 5f6e 756d 6265         min_numbe
+0000cd80: 7220 3d20 6e2e 6e75 6d62 6572 0a0a 2020  r = n.number..  
+0000cd90: 2020 2020 2020 2020 2020 7265 7475 726e            return
+0000cda0: 206d 696e 5f69 6478 0a0a 2020 2020 2020   min_idx..      
+0000cdb0: 2020 736f 7274 6564 5f62 7379 6d73 203d    sorted_bsyms =
+0000cdc0: 2074 6f70 6f73 6f72 745f 6273 796d 5f64   toposort_bsym_d
+0000cdd0: 6167 286c 6561 7665 732c 2074 6f70 6f73  ag(leaves, topos
+0000cde0: 6f72 745f 6f72 6465 723d 544f 504f 534f  ort_order=TOPOSO
+0000cdf0: 5254 5f4f 5244 4552 2e42 4f54 544f 4d5f  RT_ORDER.BOTTOM_
+0000ce00: 5550 2c20 7365 6c65 6374 6f72 3d5f 7365  UP, selector=_se
+0000ce10: 6c65 6374 6f72 290a 2020 2020 2020 2020  lector).        
+0000ce20: 6772 6164 7472 632e 626f 756e 645f 7379  gradtrc.bound_sy
+0000ce30: 6d62 6f6c 7320 3d20 736f 7274 6564 5f62  mbols = sorted_b
+0000ce40: 7379 6d73 0a20 2020 2020 2020 2067 7261  syms.        gra
+0000ce50: 6474 7263 203d 2064 6365 2867 7261 6474  dtrc = dce(gradt
+0000ce60: 7263 290a 0a20 2020 2020 2020 2023 2054  rc)..        # T
+0000ce70: 4f44 4f20 436f 6e73 6964 6572 2068 6f77  ODO Consider how
+0000ce80: 2074 6f20 6861 6e64 6c65 2067 7261 6420   to handle grad 
+0000ce90: 772e 722e 742e 206f 6e6c 7920 736f 6d65  w.r.t. only some
+0000cea0: 206f 7574 7075 7473 202d 2d20 7368 6f75   outputs -- shou
+0000ceb0: 6c64 2061 6c6c 2067 7261 640a 2020 2020  ld all grad.    
+0000cec0: 2020 2020 2320 2020 6f70 6572 6174 696f      #   operatio
+0000ced0: 6e73 2075 7369 6e67 2074 6865 206f 7468  ns using the oth
+0000cee0: 6572 206f 7574 7075 7420 6265 2072 656d  er output be rem
+0000cef0: 6f76 6564 3f20 5768 6174 206b 696e 6420  oved? What kind 
+0000cf00: 6f66 2061 7373 756d 7074 696f 6e20 646f  of assumption do
+0000cf10: 6573 2074 6861 740a 2020 2020 2020 2020  es that.        
+0000cf20: 2320 2020 6d61 6b65 2061 626f 7574 2074  #   make about t
+0000cf30: 6865 2067 7261 6420 7374 7275 6374 7572  he grad structur
+0000cf40: 653f 2050 726f 6261 626c 7920 736f 6d65  e? Probably some
+0000cf50: 206b 696e 6420 6f66 2069 6e64 6570 656e   kind of indepen
+0000cf60: 6465 6e63 6520 6173 7375 6d70 7469 6f6e  dence assumption
+0000cf70: 3f20 4172 650a 2020 2020 2020 2020 2320  ? Are.        # 
+0000cf80: 2020 7468 6572 6520 7072 6163 7469 6361    there practica
+0000cf90: 6c20 6578 616d 706c 6573 2077 6865 7265  l examples where
+0000cfa0: 2074 6861 7427 7320 616e 2069 7373 7565   that's an issue
+0000cfb0: 3f0a 0a20 2020 2020 2020 2065 6e64 5f74  ?..        end_t
+0000cfc0: 696d 655f 6e73 203d 2074 696d 652e 7469  ime_ns = time.ti
+0000cfd0: 6d65 5f6e 7328 290a 2020 2020 2020 2020  me_ns().        
+0000cfe0: 656c 6170 7365 645f 7469 6d65 5f6e 7320  elapsed_time_ns 
+0000cff0: 3d20 656e 645f 7469 6d65 5f6e 7320 2d20  = end_time_ns - 
+0000d000: 7374 6172 745f 7469 6d65 5f6e 730a 2020  start_time_ns.  
+0000d010: 2020 2020 2020 656c 6170 7365 645f 7469        elapsed_ti
+0000d020: 6d65 5f6d 696c 6c69 7320 3d20 656c 6170  me_millis = elap
+0000d030: 7365 645f 7469 6d65 5f6e 7320 2f2f 2031  sed_time_ns // 1
+0000d040: 3030 3030 3030 0a20 2020 2020 2020 2067  000000.        g
+0000d050: 7261 6474 7263 2e73 6574 5f70 726f 7665  radtrc.set_prove
+0000d060: 6e61 6e63 6528 5472 6163 6550 726f 7665  nance(TraceProve
+0000d070: 6e61 6e63 6528 6622 4772 6164 2028 746f  nance(f"Grad (to
+0000d080: 6f6b 207b 656c 6170 7365 645f 7469 6d65  ok {elapsed_time
+0000d090: 5f6d 696c 6c69 737d 206d 696c 6c69 7365  _millis} millise
+0000d0a0: 636f 6e64 7329 2229 290a 0a20 2020 2020  conds)"))..     
+0000d0b0: 2020 2072 6574 7572 6e20 6772 6164 7472     return gradtr
+0000d0c0: 630a 0a20 2020 2023 204e 4f54 4520 5468  c..    # NOTE Th
+0000d0d0: 6973 2069 7320 6120 6b6c 7564 6765 2074  is is a kludge t
+0000d0e0: 6f20 696e 6469 6361 7465 2074 6861 7420  o indicate that 
+0000d0f0: 7765 2073 686f 756c 646e 2774 2075 7365  we shouldn't use
+0000d100: 2050 7954 6f72 6368 2773 2061 7574 6f67   PyTorch's autog
+0000d110: 7261 6420 6265 6361 7573 650a 2020 2020  rad because.    
+0000d120: 2320 2020 7765 2772 6520 7573 696e 6720  #   we're using 
+0000d130: 6f75 7220 6f77 6e20 6175 746f 6772 6164  our own autograd
+0000d140: 2074 7261 6e73 666f 726d 0a20 2020 2063   transform.    c
+0000d150: 666e 2e5f 7573 696e 675f 6772 6164 5f74  fn._using_grad_t
+0000d160: 7261 6e73 666f 726d 203d 2054 7275 650a  ransform = True.
+0000d170: 0a20 2020 2072 6574 7572 6e20 6164 645f  .    return add_
+0000d180: 7472 616e 7366 6f72 6d28 6366 6e2c 205f  transform(cfn, _
+0000d190: 6772 6164 5f74 7261 6e73 666f 726d 290a  grad_transform).
+0000d1a0: 0a0a 6465 6620 6772 6164 5f76 3128 0a20  ..def grad_v1(. 
+0000d1b0: 2020 2063 666e 2c0a 2920 2d3e 2043 616c     cfn,.) -> Cal
+0000d1c0: 6c61 626c 653a 0a20 2020 2064 6566 2067  lable:.    def g
+0000d1d0: 7261 6428 6675 6e63 293a 0a20 2020 2020  rad(func):.     
+0000d1e0: 2020 2064 6566 2067 7261 645f 6675 6e63     def grad_func
+0000d1f0: 282a 6172 6773 2c20 2a2a 6b77 6172 6773  (*args, **kwargs
+0000d200: 293a 0a20 2020 2020 2020 2020 2020 205f  ):.            _
+0000d210: 2c20 6772 6164 7320 3d20 7661 6c75 655f  , grads = value_
+0000d220: 616e 645f 6772 6164 2866 756e 6329 282a  and_grad(func)(*
+0000d230: 6172 6773 2c20 2a2a 6b77 6172 6773 290a  args, **kwargs).
+0000d240: 2020 2020 2020 2020 2020 2020 6772 6164              grad
+0000d250: 7320 3d20 5b67 2066 6f72 2067 2069 6e20  s = [g for g in 
+0000d260: 6772 6164 7320 6966 2067 2069 7320 6e6f  grads if g is no
+0000d270: 7420 4e6f 6e65 5d0a 2020 2020 2020 2020  t None].        
+0000d280: 2020 2020 7265 7475 726e 2067 7261 6473      return grads
+0000d290: 0a0a 2020 2020 2020 2020 7265 7475 726e  ..        return
+0000d2a0: 2067 7261 645f 6675 6e63 0a0a 2020 2020   grad_func..    
+0000d2b0: 6465 6620 5f67 7261 645f 7472 616e 7366  def _grad_transf
+0000d2c0: 6f72 6d28 7472 633a 2054 7261 6365 2c20  orm(trc: Trace, 
+0000d2d0: 2a2c 2065 7865 6375 746f 7273 5f6c 6973  *, executors_lis
+0000d2e0: 743a 2053 6571 7565 6e63 655b 416e 795d  t: Sequence[Any]
+0000d2f0: 2920 2d3e 2054 7261 6365 3a0a 2020 2020  ) -> Trace:.    
+0000d300: 2020 2020 6772 6164 7472 6320 3d20 636f      gradtrc = co
+0000d310: 6e73 7472 7563 745f 7472 6163 6528 2928  nstruct_trace()(
+0000d320: 6772 6164 2874 7263 2e70 7974 686f 6e5f  grad(trc.python_
+0000d330: 6361 6c6c 6162 6c65 2829 292c 202a 7472  callable()), *tr
+0000d340: 632e 6172 6773 2c20 2a2a 7472 632e 6b77  c.args, **trc.kw
+0000d350: 6172 6773 290a 2020 2020 2020 2020 7265  args).        re
+0000d360: 7475 726e 2067 7261 6474 7263 0a0a 2020  turn gradtrc..  
+0000d370: 2020 6366 6e2e 5f75 7369 6e67 5f67 7261    cfn._using_gra
+0000d380: 645f 7472 616e 7366 6f72 6d20 3d20 5472  d_transform = Tr
+0000d390: 7565 0a20 2020 2072 6574 7572 6e20 6164  ue.    return ad
+0000d3a0: 645f 7472 616e 7366 6f72 6d28 6366 6e2c  d_transform(cfn,
+0000d3b0: 205f 6772 6164 5f74 7261 6e73 666f 726d   _grad_transform
+0000d3c0: 290a 0a0a 636c 6173 7320 5472 616e 7366  )...class Transf
+0000d3d0: 6f72 6d73 2845 6e75 6d29 3a0a 2020 2020  orms(Enum):.    
+0000d3e0: 4964 656e 7469 7479 4f70 203d 2061 7574  IdentityOp = aut
+0000d3f0: 6f28 290a 2020 2020 566d 6170 4f70 203d  o().    VmapOp =
+0000d400: 2061 7574 6f28 290a 2020 2020 4a76 704f   auto().    JvpO
+0000d410: 7020 3d20 6175 746f 2829 0a20 2020 2056  p = auto().    V
+0000d420: 6a70 4f70 203d 2061 7574 6f28 290a 0a0a  jpOp = auto()...
+0000d430: 406c 7275 5f63 6163 6865 286d 6178 7369  @lru_cache(maxsi
+0000d440: 7a65 3d4e 6f6e 6529 0a64 6566 2073 796d  ze=None).def sym
+0000d450: 626f 6c5f 746f 5f65 7661 6c28 626f 756e  bol_to_eval(boun
+0000d460: 645f 7379 6d62 6f6c 293a 0a20 2020 2022  d_symbol):.    "
+0000d470: 2222 4d61 7020 6120 426f 756e 6453 796d  ""Map a BoundSym
+0000d480: 626f 6c20 746f 2061 2066 756e 6374 696f  bol to a functio
+0000d490: 6e20 7468 6174 2065 7661 6c75 6174 6573  n that evaluates
+0000d4a0: 2069 742e 0a0a 2020 2020 4172 6773 3a0a   it...    Args:.
+0000d4b0: 2020 2020 2020 2020 626f 756e 645f 7379          bound_sy
+0000d4c0: 6d62 6f6c 3a20 426f 756e 6453 796d 626f  mbol: BoundSymbo
+0000d4d0: 6c20 746f 206d 6170 0a20 2020 2022 2222  l to map.    """
+0000d4e0: 0a20 2020 2023 2053 796d 626f 6c20 6973  .    # Symbol is
+0000d4f0: 2063 616c 6c61 626c 650a 2020 2020 7265   callable.    re
+0000d500: 7475 726e 2062 6f75 6e64 5f73 796d 626f  turn bound_symbo
+0000d510: 6c2e 7379 6d0a 0a0a 2320 544f 444f 3a20  l.sym...# TODO: 
+0000d520: 4375 7272 656e 746c 7920 7765 2075 7365  Currently we use
+0000d530: 2074 7261 6365 2e61 7267 7320 616e 6420   trace.args and 
+0000d540: 7472 6163 652e 6b77 6172 6773 2074 6f20  trace.kwargs to 
+0000d550: 6765 7420 7468 6520 6172 6775 6d65 6e74  get the argument
+0000d560: 730a 2320 4d61 7962 6520 7765 2073 686f  s.# Maybe we sho
+0000d570: 756c 6420 7573 6520 7468 6573 6520 696e  uld use these in
+0000d580: 7374 6561 640a 7472 616e 7366 6f72 6d5f  stead.transform_
+0000d590: 736b 6970 5f6c 6973 7420 3d20 280a 2020  skip_list = (.  
+0000d5a0: 2020 7072 696d 732e 5072 696d 4944 732e    prims.PrimIDs.
+0000d5b0: 554e 5041 434b 5f45 4d50 5459 5f44 4943  UNPACK_EMPTY_DIC
+0000d5c0: 542c 0a20 2020 2070 7269 6d73 2e50 7269  T,.    prims.Pri
+0000d5d0: 6d49 4473 2e55 4e50 4143 4b5f 4b45 592c  mIDs.UNPACK_KEY,
+0000d5e0: 0a20 2020 2070 7269 6d73 2e50 7269 6d49  .    prims.PrimI
+0000d5f0: 4473 2e55 4e50 4143 4b5f 5345 5155 454e  Ds.UNPACK_SEQUEN
+0000d600: 4345 2c0a 2020 2020 7072 696d 732e 5072  CE,.    prims.Pr
+0000d610: 696d 4944 732e 554e 5041 434b 5f54 5249  imIDs.UNPACK_TRI
+0000d620: 5649 414c 2c0a 2020 2020 7072 696d 732e  VIAL,.    prims.
+0000d630: 5072 696d 4944 732e 5245 5455 524e 2c0a  PrimIDs.RETURN,.
+0000d640: 290a 0a0a 6465 6620 6576 616c 5f74 7261  )...def eval_tra
+0000d650: 6365 2874 7261 6365 2c20 2a61 7267 732c  ce(trace, *args,
+0000d660: 2073 796d 626f 6c5f 6d61 7070 6572 3d73   symbol_mapper=s
+0000d670: 796d 626f 6c5f 746f 5f65 7661 6c2c 2077  ymbol_to_eval, w
+0000d680: 6974 685f 656e 763d 4661 6c73 652c 202a  ith_env=False, *
+0000d690: 2a6b 7761 7267 7329 3a0a 2020 2020 2222  *kwargs):.    ""
+0000d6a0: 2245 7661 6c75 6174 6520 6120 7472 6163  "Evaluate a trac
+0000d6b0: 652e 0a0a 2020 2020 4172 6773 3a0a 2020  e...    Args:.  
+0000d6c0: 2020 2020 2020 7472 6163 653a 2074 7261        trace: tra
+0000d6d0: 6365 2074 6f20 6576 616c 7561 7465 0a20  ce to evaluate. 
+0000d6e0: 2020 2020 2020 202a 6172 6773 3a20 6172         *args: ar
+0000d6f0: 6775 6d65 6e74 7320 746f 2065 7661 6c75  guments to evalu
+0000d700: 6174 6520 7468 6520 7472 6163 6520 7769  ate the trace wi
+0000d710: 7468 0a20 2020 2020 2020 2073 796d 626f  th.        symbo
+0000d720: 6c5f 6d61 7070 6572 3a20 6675 6e63 7469  l_mapper: functi
+0000d730: 6f6e 2074 6861 7420 6d61 7073 2061 2073  on that maps a s
+0000d740: 796d 626f 6c20 746f 2061 2066 756e 6374  ymbol to a funct
+0000d750: 696f 6e20 7468 6174 2065 7661 6c75 6174  ion that evaluat
+0000d760: 6573 2069 740a 2020 2020 2020 2020 2a2a  es it.        **
+0000d770: 6b77 6172 6773 3a20 6b65 7977 6f72 6420  kwargs: keyword 
+0000d780: 6172 6775 6d65 6e74 7320 746f 2065 7661  arguments to eva
+0000d790: 6c75 6174 6520 7468 6520 7472 6163 6520  luate the trace 
+0000d7a0: 7769 7468 0a0a 2020 2020 5265 7475 726e  with..    Return
+0000d7b0: 733a 0a20 2020 2020 2020 2072 6573 756c  s:.        resul
+0000d7c0: 7420 6f66 2065 7661 6c75 6174 696e 6720  t of evaluating 
+0000d7d0: 7468 6520 7472 6163 650a 2020 2020 2222  the trace.    ""
+0000d7e0: 220a 2020 2020 656e 7620 3d20 7b7d 0a0a  ".    env = {}..
+0000d7f0: 2020 2020 6465 6620 7265 6164 2878 3a20      def read(x: 
+0000d800: 5661 7269 6162 6c65 293a 0a20 2020 2020  Variable):.     
+0000d810: 2020 2069 6620 6973 696e 7374 616e 6365     if isinstance
+0000d820: 2878 2c20 5661 7269 6162 6c65 293a 0a20  (x, Variable):. 
+0000d830: 2020 2020 2020 2020 2020 2072 6574 7572             retur
+0000d840: 6e20 656e 765b 782e 6e61 6d65 5d0a 2020  n env[x.name].  
+0000d850: 2020 2020 2020 656c 7365 3a0a 2020 2020        else:.    
+0000d860: 2020 2020 2020 2020 7265 7475 726e 2078          return x
+0000d870: 0a0a 2020 2020 6465 6620 7772 6974 6528  ..    def write(
+0000d880: 763a 2056 6172 6961 626c 652c 2076 616c  v: Variable, val
+0000d890: 3a20 416e 792c 2061 6c6c 6f77 5f64 7570  : Any, allow_dup
+0000d8a0: 6c69 6361 7465 733d 4661 6c73 6529 202d  licates=False) -
+0000d8b0: 3e20 4e6f 6e65 3a0a 2020 2020 2020 2020  > None:.        
+0000d8c0: 6966 206e 6f74 2069 7369 6e73 7461 6e63  if not isinstanc
+0000d8d0: 6528 762c 2056 6172 6961 626c 6529 3a0a  e(v, Variable):.
+0000d8e0: 2020 2020 2020 2020 2020 2020 7265 7475              retu
+0000d8f0: 726e 0a20 2020 2020 2020 2023 2044 7570  rn.        # Dup
+0000d900: 6c69 6361 7465 7320 6172 6520 616c 6c6f  licates are allo
+0000d910: 7765 6420 616e 6420 6f76 6572 7772 6974  wed and overwrit
+0000d920: 7465 6e0a 2020 2020 2020 2020 6966 2076  ten.        if v
+0000d930: 2e6e 616d 6520 696e 2065 6e76 3a0a 2020  .name in env:.  
+0000d940: 2020 2020 2020 2020 2020 6966 2061 6c6c            if all
+0000d950: 6f77 5f64 7570 6c69 6361 7465 733a 0a20  ow_duplicates:. 
+0000d960: 2020 2020 2020 2020 2020 2020 2020 2072                 r
+0000d970: 6574 7572 6e0a 2020 2020 2020 2020 2020  eturn.          
+0000d980: 2020 7261 6973 6520 5661 6c75 6545 7272    raise ValueErr
+0000d990: 6f72 2866 2256 6172 6961 626c 6520 7b76  or(f"Variable {v
+0000d9a0: 2e6e 616d 657d 2069 7320 6265 696e 6720  .name} is being 
+0000d9b0: 6f76 6572 7772 6974 7465 6e20 7468 6973  overwritten this
+0000d9c0: 2069 7320 6e6f 7420 616c 6c6f 7765 6422   is not allowed"
+0000d9d0: 290a 2020 2020 2020 2020 656e 765b 762e  ).        env[v.
+0000d9e0: 6e61 6d65 5d20 3d20 7661 6c0a 0a20 2020  name] = val..   
+0000d9f0: 2073 6166 655f 6d61 705f 666c 6174 2877   safe_map_flat(w
+0000da00: 7269 7465 2c20 6c69 7374 2874 7261 6365  rite, list(trace
+0000da10: 2e61 7267 7329 2c20 6c69 7374 2861 7267  .args), list(arg
+0000da20: 7329 290a 2020 2020 7361 6665 5f6d 6170  s)).    safe_map
+0000da30: 5f66 6c61 7428 7772 6974 652c 206c 6973  _flat(write, lis
+0000da40: 7428 7472 6163 652e 6b77 6172 6773 2e76  t(trace.kwargs.v
+0000da50: 616c 7565 7328 2929 2c20 6c69 7374 286b  alues()), list(k
+0000da60: 7761 7267 732e 7661 6c75 6573 2829 2929  wargs.values()))
+0000da70: 0a0a 2020 2020 666f 7220 7379 6d62 6f6c  ..    for symbol
+0000da80: 2069 6e20 7472 6163 652e 626f 756e 645f   in trace.bound_
+0000da90: 7379 6d62 6f6c 733a 0a20 2020 2020 2020  symbols:.       
+0000daa0: 2069 6620 7379 6d62 6f6c 2e73 796d 2e69   if symbol.sym.i
+0000dab0: 6420 696e 2074 7261 6e73 666f 726d 5f73  d in transform_s
+0000dac0: 6b69 705f 6c69 7374 3a0a 2020 2020 2020  kip_list:.      
+0000dad0: 2020 2020 2020 636f 6e74 696e 7565 0a20        continue. 
+0000dae0: 2020 2020 2020 2061 7267 7320 3d20 7472         args = tr
+0000daf0: 6565 5f6d 6170 2872 6561 642c 2073 796d  ee_map(read, sym
+0000db00: 626f 6c2e 6172 6773 290a 2020 2020 2020  bol.args).      
+0000db10: 2020 6b77 6172 6773 203d 2074 7265 655f    kwargs = tree_
+0000db20: 6d61 7028 7265 6164 2c20 7379 6d62 6f6c  map(read, symbol
+0000db30: 2e6b 7761 7267 7329 0a20 2020 2020 2020  .kwargs).       
+0000db40: 2070 7269 6d5f 6675 6e63 203d 2073 796d   prim_func = sym
+0000db50: 626f 6c5f 6d61 7070 6572 2873 796d 626f  bol_mapper(symbo
+0000db60: 6c29 0a20 2020 2020 2020 2069 6620 7072  l).        if pr
+0000db70: 696d 5f66 756e 6320 6973 204e 6f6e 653a  im_func is None:
+0000db80: 0a20 2020 2020 2020 2020 2020 2063 6f6e  .            con
+0000db90: 7469 6e75 650a 2020 2020 2020 2020 7265  tinue.        re
+0000dba0: 7375 6c74 203d 2070 7269 6d5f 6675 6e63  sult = prim_func
+0000dbb0: 282a 6172 6773 2c20 2a2a 6b77 6172 6773  (*args, **kwargs
+0000dbc0: 290a 2020 2020 2020 2020 7361 6665 5f6d  ).        safe_m
+0000dbd0: 6170 5f66 6c61 7428 7772 6974 652c 206c  ap_flat(write, l
+0000dbe0: 6973 7428 7365 7175 656e 6369 6679 2873  ist(sequencify(s
+0000dbf0: 796d 626f 6c2e 6f75 7470 7574 2929 2c20  ymbol.output)), 
+0000dc00: 6c69 7374 2873 6571 7565 6e63 6966 7928  list(sequencify(
+0000dc10: 7265 7375 6c74 2929 290a 0a20 2020 2069  result)))..    i
+0000dc20: 6620 7769 7468 5f65 6e76 3a0a 2020 2020  f with_env:.    
+0000dc30: 2020 2020 7265 7475 726e 2074 7265 655f      return tree_
+0000dc40: 6d61 7028 7265 6164 2c20 7472 6163 652e  map(read, trace.
+0000dc50: 6f75 7470 7574 292c 2065 6e76 0a0a 2020  output), env..  
+0000dc60: 2020 7265 7475 726e 2074 7265 655f 6d61    return tree_ma
+0000dc70: 7028 7265 6164 2c20 7472 6163 652e 6f75  p(read, trace.ou
+0000dc80: 7470 7574 290a 0a0a 6465 6620 5f69 6465  tput)...def _ide
+0000dc90: 6e74 6974 795f 6361 6c6c 5f6d 6574 6166  ntity_call_metaf
+0000dca0: 756e 6328 2a61 7267 732c 2074 7261 6365  unc(*args, trace
+0000dcb0: 3a20 5472 6163 652c 202a 2a6b 7761 7267  : Trace, **kwarg
+0000dcc0: 7329 3a0a 2020 2020 7769 7468 2064 6574  s):.    with det
+0000dcd0: 6163 6865 645f 7472 6163 6528 293a 0a20  ached_trace():. 
+0000dce0: 2020 2020 2020 2072 6574 7572 6e20 6576         return ev
+0000dcf0: 616c 5f74 7261 6365 2874 7261 6365 2c20  al_trace(trace, 
+0000dd00: 2a61 7267 732c 202a 2a6b 7761 7267 7329  *args, **kwargs)
+0000dd10: 0a0a 0a69 6465 6e74 6974 795f 6361 6c6c  ...identity_call
+0000dd20: 203d 2053 796d 626f 6c28 6964 3d54 7261   = Symbol(id=Tra
+0000dd30: 6e73 666f 726d 732e 4964 656e 7469 7479  nsforms.Identity
+0000dd40: 4f70 2c20 6e61 6d65 3d22 6964 656e 7469  Op, name="identi
+0000dd50: 7479 5f63 616c 6c22 2c20 6d65 7461 3d5f  ty_call", meta=_
+0000dd60: 6964 656e 7469 7479 5f63 616c 6c5f 6d65  identity_call_me
+0000dd70: 7461 6675 6e63 290a 0a0a 6465 6620 6964  tafunc)...def id
+0000dd80: 656e 7469 7479 2866 756e 6329 3a0a 2020  entity(func):.  
+0000dd90: 2020 2222 2249 6465 6e74 6974 7920 7472    """Identity tr
+0000dda0: 616e 7366 6f72 6d20 666f 7220 6120 5468  ansform for a Th
+0000ddb0: 756e 6465 7220 6675 6e63 7469 6f6e 2e0a  under function..
+0000ddc0: 0a20 2020 2041 7267 733a 0a20 2020 2020  .    Args:.     
+0000ddd0: 2020 2066 756e 6320 2843 616c 6c61 626c     func (Callabl
+0000dde0: 6529 3a20 4120 5468 756e 6465 7220 6675  e): A Thunder fu
+0000ddf0: 6e63 7469 6f6e 2074 6f20 6265 2074 7261  nction to be tra
+0000de00: 6e73 666f 726d 6564 2e0a 2020 2020 2222  nsformed..    ""
+0000de10: 220a 0a20 2020 2064 6566 2077 7261 7070  "..    def wrapp
+0000de20: 6572 282a 6172 6773 2c20 2a2a 6b77 6172  er(*args, **kwar
+0000de30: 6773 293a 0a20 2020 2020 2020 2074 7261  gs):.        tra
+0000de40: 6365 203d 2063 6f6e 7374 7275 6374 5f74  ce = construct_t
+0000de50: 7261 6365 2829 2866 756e 632c 202a 6172  race()(func, *ar
+0000de60: 6773 2c20 2a2a 6b77 6172 6773 290a 2020  gs, **kwargs).  
+0000de70: 2020 2020 2020 7265 7475 726e 2069 6465        return ide
+0000de80: 6e74 6974 795f 6361 6c6c 282a 6172 6773  ntity_call(*args
+0000de90: 2c20 2a2a 6b77 6172 6773 2c20 7472 6163  , **kwargs, trac
+0000dea0: 653d 7472 6163 6529 0a0a 2020 2020 7265  e=trace)..    re
+0000deb0: 7475 726e 2077 7261 7070 6572 0a0a 0a64  turn wrapper...d
+0000dec0: 6566 205f 6964 656e 7469 7479 5f63 616c  ef _identity_cal
+0000ded0: 6c5f 7079 746f 7263 6828 2a61 7267 732c  l_pytorch(*args,
+0000dee0: 2074 7261 6365 3a20 5472 6163 652c 202a   trace: Trace, *
+0000def0: 2a6b 7761 7267 7329 3a0a 2020 2020 696d  *kwargs):.    im
+0000df00: 706f 7274 2074 6f72 6368 0a0a 2020 2020  port torch..    
+0000df10: 6465 6620 7379 6d62 6f6c 5f6d 6170 7065  def symbol_mappe
+0000df20: 7228 6f70 293a 0a20 2020 2020 2020 2069  r(op):.        i
+0000df30: 6620 6f70 2e6f 7020 3d3d 2054 7261 6e73  f op.op == Trans
+0000df40: 666f 726d 732e 4964 656e 7469 7479 4f70  forms.IdentityOp
+0000df50: 3a0a 2020 2020 2020 2020 2020 2020 7265  :.            re
+0000df60: 7475 726e 205f 6964 656e 7469 7479 5f63  turn _identity_c
+0000df70: 616c 6c5f 7079 746f 7263 680a 0a20 2020  all_pytorch..   
+0000df80: 2020 2020 2074 6f72 6368 5f6f 7020 3d20       torch_op = 
+0000df90: 6f70 735f 746f 5f74 6f72 6368 5f6f 7073  ops_to_torch_ops
+0000dfa0: 5f6d 6170 5b6f 702e 6f70 5d0a 2020 2020  _map[op.op].    
+0000dfb0: 2020 2020 6966 2069 7369 6e73 7461 6e63      if isinstanc
+0000dfc0: 6528 746f 7263 685f 6f70 2c20 7374 7229  e(torch_op, str)
+0000dfd0: 3a0a 2020 2020 2020 2020 2020 2020 7265  :.            re
+0000dfe0: 7475 726e 2067 6574 6174 7472 2874 6f72  turn getattr(tor
+0000dff0: 6368 2c20 746f 7263 685f 6f70 2e73 7472  ch, torch_op.str
+0000e000: 6970 2822 7079 746f 7263 682e 2229 290a  ip("pytorch.")).
+0000e010: 2020 2020 2020 2020 7265 7475 726e 2074          return t
+0000e020: 6f72 6368 5f6f 700a 0a20 2020 2077 6974  orch_op..    wit
+0000e030: 6820 6465 7461 6368 6564 5f74 7261 6365  h detached_trace
+0000e040: 2829 3a0a 2020 2020 2020 2020 7265 7475  ():.        retu
+0000e050: 726e 2065 7661 6c5f 7472 6163 6528 7472  rn eval_trace(tr
+0000e060: 6163 652c 202a 6172 6773 2c20 2a2a 6b77  ace, *args, **kw
+0000e070: 6172 6773 2c20 7379 6d62 6f6c 5f6d 6170  args, symbol_map
+0000e080: 7065 723d 7379 6d62 6f6c 5f6d 6170 7065  per=symbol_mappe
+0000e090: 7229 0a0a 0a23 2052 6567 6973 7465 7220  r)...# Register 
+0000e0a0: 7468 6520 6964 656e 7469 7479 2063 616c  the identity cal
+0000e0b0: 6c20 666f 7220 5079 546f 7263 6820 6578  l for PyTorch ex
+0000e0c0: 6563 7574 6f72 2e0a 2320 6f70 735f 746f  ecutor..# ops_to
+0000e0d0: 5f74 6f72 6368 5f6f 7073 5f6d 6170 5b54  _torch_ops_map[T
+0000e0e0: 7261 6e73 666f 726d 732e 4964 656e 7469  ransforms.Identi
+0000e0f0: 7479 4f70 5d20 3d20 5f69 6465 6e74 6974  tyOp] = _identit
+0000e100: 795f 6361 6c6c 5f70 7974 6f72 6368 0a0a  y_call_pytorch..
+0000e110: 0a23 2056 4d41 5020 7472 616e 7366 6f72  .# VMAP transfor
+0000e120: 6d0a 2320 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  m.# ------------
+0000e130: 2d0a 0a0a 636c 6173 7320 4e6f 744d 6170  -...class NotMap
+0000e140: 7065 643a 0a20 2020 2022 2222 5265 7072  ped:.    """Repr
+0000e150: 6573 656e 7473 2061 206e 6f6e 2d62 6174  esents a non-bat
+0000e160: 6368 6564 2064 696d 656e 7369 6f6e 2e22  ched dimension."
+0000e170: 2222 0a0a 2020 2020 6465 6620 5f5f 7265  ""..    def __re
+0000e180: 7072 5f5f 2873 656c 6629 3a0a 2020 2020  pr__(self):.    
+0000e190: 2020 2020 7265 7475 726e 2022 6e6f 745f      return "not_
+0000e1a0: 6d61 7070 6564 220a 0a0a 4064 6174 6163  mapped"...@datac
+0000e1b0: 6c61 7373 2866 726f 7a65 6e3d 5472 7565  lass(frozen=True
+0000e1c0: 290a 636c 6173 7320 4261 7463 6865 6456  ).class BatchedV
+0000e1d0: 616c 7565 3a0a 2020 2020 2222 2242 6174  alue:.    """Bat
+0000e1e0: 6368 6564 2076 616c 7565 2066 6f72 2074  ched value for t
+0000e1f0: 6865 2076 6d61 7020 7472 616e 7366 6f72  he vmap transfor
+0000e200: 6d2e 0a0a 2020 2020 4174 7472 6962 7574  m...    Attribut
+0000e210: 6573 3a0a 2020 2020 2020 2020 7661 6c75  es:.        valu
+0000e220: 653a 2042 6174 6368 6564 2076 616c 7565  e: Batched value
+0000e230: 2e0a 2020 2020 2020 2020 6261 7463 685f  ..        batch_
+0000e240: 6469 6d3a 2042 6174 6368 696e 6720 6469  dim: Batching di
+0000e250: 6d65 6e73 696f 6e20 6f72 206e 6f74 5f6d  mension or not_m
+0000e260: 6170 7065 640a 2020 2020 2222 220a 0a20  apped.    """.. 
+0000e270: 2020 2076 616c 7565 3a20 416e 790a 2020     value: Any.  
+0000e280: 2020 6261 7463 685f 6469 6d3a 2069 6e74    batch_dim: int
+0000e290: 207c 204e 6f74 4d61 7070 6564 0a0a 2020   | NotMapped..  
+0000e2a0: 2020 6465 6620 5f5f 6974 6572 5f5f 2873    def __iter__(s
+0000e2b0: 656c 6629 3a0a 2020 2020 2020 2020 7969  elf):.        yi
+0000e2c0: 656c 6420 7365 6c66 2e76 616c 7565 0a20  eld self.value. 
+0000e2d0: 2020 2020 2020 2079 6965 6c64 2073 656c         yield sel
+0000e2e0: 662e 6261 7463 685f 6469 6d0a 0a0a 6465  f.batch_dim...de
+0000e2f0: 6620 7061 6972 5f74 6f5f 6261 7463 6865  f pair_to_batche
+0000e300: 645f 7661 6c75 6528 7061 6972 293a 0a20  d_value(pair):. 
+0000e310: 2020 2022 2222 436f 6e76 6572 7473 2061     """Converts a
+0000e320: 2070 6169 7220 746f 2061 2042 6174 6368   pair to a Batch
+0000e330: 6564 5661 6c75 652e 0a0a 2020 2020 4172  edValue...    Ar
+0000e340: 6773 3a0a 2020 2020 2020 2020 7061 6972  gs:.        pair
+0000e350: 2028 5365 7175 656e 6365 293a 2050 6169   (Sequence): Pai
+0000e360: 7220 746f 2063 6f6e 7665 7274 2e0a 0a20  r to convert... 
+0000e370: 2020 2052 6574 7572 6e73 3a0a 2020 2020     Returns:.    
+0000e380: 2020 2020 4261 7463 6865 6456 616c 7565      BatchedValue
+0000e390: 3a20 4261 7463 6865 6456 616c 7565 2072  : BatchedValue r
+0000e3a0: 6570 7265 7365 6e74 6174 696f 6e20 6f66  epresentation of
+0000e3b0: 2074 6865 2070 6169 722e 0a20 2020 2022   the pair..    "
+0000e3c0: 2222 0a20 2020 2069 6620 6973 696e 7374  "".    if isinst
+0000e3d0: 616e 6365 2870 6169 722c 2042 6174 6368  ance(pair, Batch
+0000e3e0: 6564 5661 6c75 6529 3a0a 2020 2020 2020  edValue):.      
+0000e3f0: 2020 7265 7475 726e 2070 6169 720a 2020    return pair.  
+0000e400: 2020 656c 7365 3a0a 2020 2020 2020 2020    else:.        
+0000e410: 6173 7365 7274 2069 7369 6e73 7461 6e63  assert isinstanc
+0000e420: 6528 7061 6972 2c20 5365 7175 656e 6365  e(pair, Sequence
+0000e430: 2920 616e 6420 6c65 6e28 7061 6972 2920  ) and len(pair) 
+0000e440: 3d3d 2032 0a20 2020 2020 2020 2072 6574  == 2.        ret
+0000e450: 7572 6e20 4261 7463 6865 6456 616c 7565  urn BatchedValue
+0000e460: 282a 7061 6972 290a 0a0a 6465 6620 7665  (*pair)...def ve
+0000e470: 6374 6f72 697a 6564 5f62 6174 6368 6572  ctorized_batcher
+0000e480: 2870 7269 6d2c 2061 7869 735f 7369 7a65  (prim, axis_size
+0000e490: 2c20 6261 7463 6865 645f 7661 6c75 6573  , batched_values
+0000e4a0: 2c20 2a2a 6b77 6172 6773 293a 0a20 2020  , **kwargs):.   
+0000e4b0: 2062 6174 6368 5f64 696d 203d 2062 6174   batch_dim = bat
+0000e4c0: 6368 6564 5f76 616c 7565 735b 305d 2e62  ched_values[0].b
+0000e4d0: 6174 6368 5f64 696d 0a20 2020 2061 7373  atch_dim.    ass
+0000e4e0: 6572 7420 616c 6c28 0a20 2020 2020 2020  ert all(.       
+0000e4f0: 2062 6174 6368 5f64 696d 203d 3d20 6276   batch_dim == bv
+0000e500: 2e62 6174 6368 5f64 696d 2066 6f72 2062  .batch_dim for b
+0000e510: 7620 696e 2062 6174 6368 6564 5f76 616c  v in batched_val
+0000e520: 7565 735b 313a 5d0a 2020 2020 292c 2066  ues[1:].    ), f
+0000e530: 2260 7665 6374 6f72 697a 6564 5f62 6174  "`vectorized_bat
+0000e540: 6368 6572 6020 676f 7420 6469 6666 6572  cher` got differ
+0000e550: 656e 7420 6261 7463 6865 6420 6469 6d65  ent batched dime
+0000e560: 6e73 696f 6e73 207b 5b62 762e 6261 7463  nsions {[bv.batc
+0000e570: 685f 6469 6d20 666f 7220 6276 2069 6e20  h_dim for bv in 
+0000e580: 6261 7463 6865 645f 7661 6c75 6573 5d7d  batched_values]}
+0000e590: 220a 2020 2020 7265 7475 726e 2042 6174  ".    return Bat
+0000e5a0: 6368 6564 5661 6c75 6528 7072 696d 282a  chedValue(prim(*
+0000e5b0: 5b62 762e 7661 6c75 6520 666f 7220 6276  [bv.value for bv
+0000e5c0: 2069 6e20 6261 7463 6865 645f 7661 6c75   in batched_valu
+0000e5d0: 6573 5d2c 202a 2a6b 7761 7267 7329 2c20  es], **kwargs), 
+0000e5e0: 6261 7463 685f 6469 6d29 0a0a 0a6e 6f74  batch_dim)...not
+0000e5f0: 5f6d 6170 7065 6420 3d20 4e6f 744d 6170  _mapped = NotMap
+0000e600: 7065 6428 290a 0a0a 6465 6620 6d6f 7665  ped()...def move
+0000e610: 6469 6d28 782c 2073 7263 3a20 696e 742c  dim(x, src: int,
+0000e620: 2064 7374 3a20 696e 7429 3a0a 2020 2020   dst: int):.    
+0000e630: 7065 726d 203d 205b 6920 666f 7220 6920  perm = [i for i 
+0000e640: 696e 2072 616e 6765 2878 2e6e 6469 6d29  in range(x.ndim)
+0000e650: 2069 6620 6920 213d 2073 7263 5d0a 2020   if i != src].  
+0000e660: 2020 7065 726d 2e69 6e73 6572 7428 6473    perm.insert(ds
+0000e670: 742c 2073 7263 290a 2020 2020 7265 7475  t, src).    retu
+0000e680: 726e 2070 7269 6d73 2e74 7261 6e73 706f  rn prims.transpo
+0000e690: 7365 2878 2c20 7475 706c 6528 7065 726d  se(x, tuple(perm
+0000e6a0: 2929 0a0a 0a64 6566 206d 6f76 655f 6261  ))...def move_ba
+0000e6b0: 7463 685f 6469 6d28 6178 6973 5f73 697a  tch_dim(axis_siz
+0000e6c0: 652c 2073 7263 2c20 6473 742c 2078 293a  e, src, dst, x):
+0000e6d0: 0a20 2020 2069 6620 7372 6320 6973 206e  .    if src is n
+0000e6e0: 6f74 5f6d 6170 7065 643a 0a20 2020 2020  ot_mapped:.     
+0000e6f0: 2020 2069 6620 6973 696e 7374 616e 6365     if isinstance
+0000e700: 2878 2c20 4e75 6d62 6572 293a 0a20 2020  (x, Number):.   
+0000e710: 2020 2020 2020 2020 2072 6574 7572 6e20           return 
+0000e720: 780a 2020 2020 2020 2020 7461 7267 6574  x.        target
+0000e730: 5f73 6861 7065 203d 206c 6973 7428 782e  _shape = list(x.
+0000e740: 7368 6170 6529 0a20 2020 2020 2020 2074  shape).        t
+0000e750: 6172 6765 745f 7368 6170 652e 696e 7365  arget_shape.inse
+0000e760: 7274 2864 7374 2c20 6178 6973 5f73 697a  rt(dst, axis_siz
+0000e770: 6529 0a20 2020 2020 2020 2062 6361 7374  e).        bcast
+0000e780: 5f64 696d 7320 3d20 6c69 7374 2872 616e  _dims = list(ran
+0000e790: 6765 286c 656e 2874 6172 6765 745f 7368  ge(len(target_sh
+0000e7a0: 6170 6529 2929 0a20 2020 2020 2020 2062  ape))).        b
+0000e7b0: 6361 7374 5f64 696d 732e 706f 7028 6473  cast_dims.pop(ds
+0000e7c0: 7429 0a20 2020 2020 2020 2072 6574 7572  t).        retur
+0000e7d0: 6e20 7072 696d 732e 6272 6f61 6463 6173  n prims.broadcas
+0000e7e0: 745f 696e 5f64 696d 2878 2c20 7461 7267  t_in_dim(x, targ
+0000e7f0: 6574 5f73 6861 7065 2c20 6263 6173 745f  et_shape, bcast_
+0000e800: 6469 6d73 290a 2020 2020 656c 6966 2073  dims).    elif s
+0000e810: 7263 203d 3d20 6473 743a 0a20 2020 2020  rc == dst:.     
+0000e820: 2020 2072 6574 7572 6e20 780a 2020 2020     return x.    
+0000e830: 656c 7365 3a0a 2020 2020 2020 2020 7265  else:.        re
+0000e840: 7475 726e 206d 6f76 6564 696d 2878 2c20  turn movedim(x, 
+0000e850: 7372 632c 2064 7374 290a 0a0a 6465 6620  src, dst)...def 
+0000e860: 6269 6e61 7279 5f6f 705f 6261 7463 6869  binary_op_batchi
+0000e870: 6e67 5f72 756c 6528 6f70 3a20 7072 696d  ng_rule(op: prim
+0000e880: 732e 5072 696d 4944 732c 2061 7869 735f  s.PrimIDs, axis_
+0000e890: 7369 7a65 3a20 696e 742c 2076 616c 735f  size: int, vals_
+0000e8a0: 696e 3a20 4261 7463 6865 6456 616c 7565  in: BatchedValue
+0000e8b0: 293a 0a20 2020 2028 2878 2c20 785f 6264  ):.    ((x, x_bd
+0000e8c0: 696d 292c 2028 792c 2079 5f62 6469 6d29  im), (y, y_bdim)
+0000e8d0: 2920 3d20 7661 6c73 5f69 6e0a 2020 2020  ) = vals_in.    
+0000e8e0: 6966 2078 5f62 6469 6d20 213d 2079 5f62  if x_bdim != y_b
+0000e8f0: 6469 6d3a 0a20 2020 2020 2020 2069 6620  dim:.        if 
+0000e900: 785f 6264 696d 2069 7320 6e6f 745f 6d61  x_bdim is not_ma
+0000e910: 7070 6564 3a0a 2020 2020 2020 2020 2020  pped:.          
+0000e920: 2020 7820 3d20 6d6f 7665 5f62 6174 6368    x = move_batch
+0000e930: 5f64 696d 2861 7869 735f 7369 7a65 2c20  _dim(axis_size, 
+0000e940: 785f 6264 696d 2c20 795f 6264 696d 2c20  x_bdim, y_bdim, 
+0000e950: 7829 0a20 2020 2020 2020 2020 2020 2078  x).            x
+0000e960: 5f62 6469 6d20 3d20 795f 6264 696d 0a20  _bdim = y_bdim. 
+0000e970: 2020 2020 2020 2065 6c73 653a 0a20 2020         else:.   
+0000e980: 2020 2020 2020 2020 2079 203d 206d 6f76           y = mov
+0000e990: 655f 6261 7463 685f 6469 6d28 6178 6973  e_batch_dim(axis
+0000e9a0: 5f73 697a 652c 2079 5f62 6469 6d2c 2078  _size, y_bdim, x
+0000e9b0: 5f62 6469 6d2c 2079 290a 2020 2020 7265  _bdim, y).    re
+0000e9c0: 7475 726e 2042 6174 6368 6564 5661 6c75  turn BatchedValu
+0000e9d0: 6528 6f70 2878 2c20 7929 2c20 785f 6264  e(op(x, y), x_bd
+0000e9e0: 696d 290a 0a0a 6465 6620 7369 6e5f 766d  im)...def sin_vm
+0000e9f0: 6170 2861 7869 735f 7369 7a65 3a20 696e  ap(axis_size: in
+0000ea00: 742c 2061 3a20 4261 7463 6865 6456 616c  t, a: BatchedVal
+0000ea10: 7565 2920 2d3e 2042 6174 6368 6564 5661  ue) -> BatchedVa
+0000ea20: 6c75 653a 0a20 2020 2072 6574 7572 6e20  lue:.    return 
+0000ea30: 7665 6374 6f72 697a 6564 5f62 6174 6368  vectorized_batch
+0000ea40: 6572 2870 7269 6d73 2e73 696e 2c20 6178  er(prims.sin, ax
+0000ea50: 6973 5f73 697a 652c 2028 612c 2929 0a0a  is_size, (a,))..
+0000ea60: 0a64 6566 2063 6f73 5f76 6d61 7028 6178  .def cos_vmap(ax
+0000ea70: 6973 5f73 697a 653a 2069 6e74 2c20 613a  is_size: int, a:
+0000ea80: 2042 6174 6368 6564 5661 6c75 6529 202d   BatchedValue) -
+0000ea90: 3e20 4261 7463 6865 6456 616c 7565 3a0a  > BatchedValue:.
+0000eaa0: 2020 2020 7265 7475 726e 2076 6563 746f      return vecto
+0000eab0: 7269 7a65 645f 6261 7463 6865 7228 7072  rized_batcher(pr
+0000eac0: 696d 732e 636f 732c 2061 7869 735f 7369  ims.cos, axis_si
+0000ead0: 7a65 2c20 2861 2c29 290a 0a0a 6465 6620  ze, (a,))...def 
+0000eae0: 6d75 6c5f 766d 6170 2861 7869 735f 7369  mul_vmap(axis_si
+0000eaf0: 7a65 3a20 696e 742c 2061 3a20 4261 7463  ze: int, a: Batc
+0000eb00: 6865 6456 616c 7565 2c20 623a 2042 6174  hedValue, b: Bat
+0000eb10: 6368 6564 5661 6c75 6529 202d 3e20 4261  chedValue) -> Ba
+0000eb20: 7463 6865 6456 616c 7565 3a0a 2020 2020  tchedValue:.    
+0000eb30: 7265 7475 726e 2062 696e 6172 795f 6f70  return binary_op
+0000eb40: 5f62 6174 6368 696e 675f 7275 6c65 2870  _batching_rule(p
+0000eb50: 7269 6d73 2e6d 756c 2c20 6178 6973 5f73  rims.mul, axis_s
+0000eb60: 697a 652c 2028 612c 2062 2929 0a0a 0a64  ize, (a, b))...d
+0000eb70: 6566 2061 6464 5f76 6d61 7028 6178 6973  ef add_vmap(axis
+0000eb80: 5f73 697a 653a 2069 6e74 2c20 613a 2042  _size: int, a: B
+0000eb90: 6174 6368 6564 5661 6c75 652c 2062 3a20  atchedValue, b: 
+0000eba0: 4261 7463 6865 6456 616c 7565 2920 2d3e  BatchedValue) ->
+0000ebb0: 2042 6174 6368 6564 5661 6c75 653a 0a20   BatchedValue:. 
+0000ebc0: 2020 2072 6574 7572 6e20 6269 6e61 7279     return binary
+0000ebd0: 5f6f 705f 6261 7463 6869 6e67 5f72 756c  _op_batching_rul
+0000ebe0: 6528 7072 696d 732e 6164 642c 2061 7869  e(prims.add, axi
+0000ebf0: 735f 7369 7a65 2c20 2861 2c20 6229 290a  s_size, (a, b)).
+0000ec00: 0a0a 6465 6620 7375 6d5f 766d 6170 2861  ..def sum_vmap(a
+0000ec10: 7869 735f 7369 7a65 3a20 696e 742c 2061  xis_size: int, a
+0000ec20: 3a20 4261 7463 6865 6456 616c 7565 2c20  : BatchedValue, 
+0000ec30: 6469 6d73 3a20 5365 7175 656e 6365 5b69  dims: Sequence[i
+0000ec40: 6e74 5d2c 202a 2a6b 7761 7267 7329 202d  nt], **kwargs) -
+0000ec50: 3e20 4261 7463 6865 6456 616c 7565 3a0a  > BatchedValue:.
+0000ec60: 2020 2020 6264 696d 203d 2061 2e62 6174      bdim = a.bat
+0000ec70: 6368 5f64 696d 0a20 2020 2023 2054 4f44  ch_dim.    # TOD
+0000ec80: 4f3a 2072 656d 6f76 6520 7468 6973 2077  O: remove this w
+0000ec90: 6865 6e20 6469 6d73 2062 6563 6f6d 6573  hen dims becomes
+0000eca0: 2061 206d 616e 6461 746f 7279 206b 7761   a mandatory kwa
+0000ecb0: 7267 0a20 2020 2069 6620 6c65 6e28 6469  rg.    if len(di
+0000ecc0: 6d73 2920 3e20 303a 0a20 2020 2020 2020  ms) > 0:.       
+0000ecd0: 2064 696d 732c 205f 203d 2073 6166 655f   dims, _ = safe_
+0000ece0: 7a69 7028 2a64 696d 7329 0a20 2020 2064  zip(*dims).    d
+0000ecf0: 696d 735f 6265 666f 7265 203d 2074 7570  ims_before = tup
+0000ed00: 6c65 2865 6c20 666f 7220 656c 2069 6e20  le(el for el in 
+0000ed10: 6469 6d73 2069 6620 656c 203c 2062 6469  dims if el < bdi
+0000ed20: 6d29 0a20 2020 2064 696d 735f 6166 7465  m).    dims_afte
+0000ed30: 7220 3d20 7475 706c 6528 656c 202b 2031  r = tuple(el + 1
+0000ed40: 2066 6f72 2065 6c20 696e 2064 696d 7320   for el in dims 
+0000ed50: 6966 2065 6c20 3e3d 2062 6469 6d29 0a20  if el >= bdim). 
+0000ed60: 2020 2062 6174 6368 6564 5f64 696d 7320     batched_dims 
+0000ed70: 3d20 6469 6d73 5f62 6566 6f72 6520 2b20  = dims_before + 
+0000ed80: 6469 6d73 5f61 6674 6572 0a20 2020 2072  dims_after.    r
+0000ed90: 6574 7572 6e20 7665 6374 6f72 697a 6564  eturn vectorized
+0000eda0: 5f62 6174 6368 6572 2870 7269 6d73 2e73  _batcher(prims.s
+0000edb0: 756d 2c20 6178 6973 5f73 697a 652c 2028  um, axis_size, (
+0000edc0: 612c 292c 2064 696d 733d 6261 7463 6865  a,), dims=batche
+0000edd0: 645f 6469 6d73 2c20 2a2a 6b77 6172 6773  d_dims, **kwargs
+0000ede0: 290a 0a0a 2320 544f 444f 3a20 506c 6561  )...# TODO: Plea
+0000edf0: 7365 2074 6573 7420 7468 6973 2065 7874  se test this ext
+0000ee00: 656e 7369 7665 6c79 0a64 6566 2062 726f  ensively.def bro
+0000ee10: 6164 6361 7374 5f69 6e5f 6469 6d5f 766d  adcast_in_dim_vm
+0000ee20: 6170 280a 2020 2020 6178 6973 5f73 697a  ap(.    axis_siz
+0000ee30: 653a 2069 6e74 2c20 613a 2042 6174 6368  e: int, a: Batch
+0000ee40: 6564 5661 6c75 652c 2073 6861 7065 3a20  edValue, shape: 
+0000ee50: 5365 7175 656e 6365 5b42 6174 6368 6564  Sequence[Batched
+0000ee60: 5661 6c75 655d 2c20 6272 6f61 6463 6173  Value], broadcas
+0000ee70: 745f 6469 6d65 6e73 696f 6e73 3a20 5365  t_dimensions: Se
+0000ee80: 7175 656e 6365 5b42 6174 6368 6564 5661  quence[BatchedVa
+0000ee90: 6c75 655d 0a29 202d 3e20 4261 7463 6865  lue].) -> Batche
+0000eea0: 6456 616c 7565 3a0a 2020 2020 6264 696d  dValue:.    bdim
+0000eeb0: 203d 2061 2e62 6174 6368 5f64 696d 0a20   = a.batch_dim. 
+0000eec0: 2020 2023 2054 4f44 4f3a 2072 656d 6f76     # TODO: remov
+0000eed0: 6520 7468 6973 2077 6865 6e20 7368 6170  e this when shap
+0000eee0: 6520 616e 6420 6272 6f61 6463 6173 745f  e and broadcast_
+0000eef0: 6469 6d65 6e73 696f 6e73 2062 6563 6f6d  dimensions becom
+0000ef00: 6520 6d61 6e64 6174 6f72 7920 6b77 6172  e mandatory kwar
+0000ef10: 6773 0a20 2020 2073 6861 7065 2c20 5f20  gs.    shape, _ 
+0000ef20: 3d20 7361 6665 5f7a 6970 282a 7368 6170  = safe_zip(*shap
+0000ef30: 6529 0a20 2020 2069 6620 6c65 6e28 6272  e).    if len(br
+0000ef40: 6f61 6463 6173 745f 6469 6d65 6e73 696f  oadcast_dimensio
+0000ef50: 6e73 2920 3e20 303a 0a20 2020 2020 2020  ns) > 0:.       
+0000ef60: 2062 726f 6164 6361 7374 5f64 696d 656e   broadcast_dimen
+0000ef70: 7369 6f6e 732c 205f 203d 2073 6166 655f  sions, _ = safe_
+0000ef80: 7a69 7028 2a62 726f 6164 6361 7374 5f64  zip(*broadcast_d
+0000ef90: 696d 656e 7369 6f6e 7329 0a20 2020 2069  imensions).    i
+0000efa0: 6620 6264 696d 2069 7320 6e6f 745f 6d61  f bdim is not_ma
+0000efb0: 7070 6564 3a0a 2020 2020 2020 2020 7265  pped:.        re
+0000efc0: 7475 726e 2042 6174 6368 6564 5661 6c75  turn BatchedValu
+0000efd0: 6528 7072 696d 732e 6272 6f61 6463 6173  e(prims.broadcas
+0000efe0: 745f 696e 5f64 696d 2861 2e76 616c 7565  t_in_dim(a.value
+0000eff0: 2c20 7368 6170 652c 2062 726f 6164 6361  , shape, broadca
+0000f000: 7374 5f64 696d 656e 7369 6f6e 7329 2c20  st_dimensions), 
+0000f010: 6264 696d 290a 2020 2020 656c 7365 3a0a  bdim).    else:.
+0000f020: 2020 2020 2020 2020 6e65 775f 6264 696d          new_bdim
+0000f030: 203d 2062 6469 6d20 2b20 7375 6d28 3120   = bdim + sum(1 
+0000f040: 666f 7220 6469 6d20 696e 2062 726f 6164  for dim in broad
+0000f050: 6361 7374 5f64 696d 656e 7369 6f6e 7320  cast_dimensions 
+0000f060: 6966 2064 696d 203c 2062 6469 6d29 0a20  if dim < bdim). 
+0000f070: 2020 2020 2020 206e 6577 5f73 6861 7065         new_shape
+0000f080: 203d 206c 6973 7428 7368 6170 6529 0a20   = list(shape). 
+0000f090: 2020 2020 2020 206e 6577 5f73 6861 7065         new_shape
+0000f0a0: 2e69 6e73 6572 7428 6e65 775f 6264 696d  .insert(new_bdim
+0000f0b0: 2c20 6178 6973 5f73 697a 6529 0a20 2020  , axis_size).   
+0000f0c0: 2020 2020 206e 6577 5f62 726f 6164 6361       new_broadca
+0000f0d0: 7374 5f64 696d 656e 7369 6f6e 7320 3d20  st_dimensions = 
+0000f0e0: 2830 2c29 202b 2074 7570 6c65 2864 696d  (0,) + tuple(dim
+0000f0f0: 202b 2031 2069 6620 6469 6d20 3e3d 2062   + 1 if dim >= b
+0000f100: 6469 6d20 656c 7365 2064 696d 2066 6f72  dim else dim for
+0000f110: 2064 696d 2069 6e20 6272 6f61 6463 6173   dim in broadcas
+0000f120: 745f 6469 6d65 6e73 696f 6e73 290a 2020  t_dimensions).  
+0000f130: 2020 2020 2020 6966 2062 726f 6164 6361        if broadca
+0000f140: 7374 5f64 696d 656e 7369 6f6e 7320 3d3d  st_dimensions ==
+0000f150: 2028 293a 0a20 2020 2020 2020 2020 2020   ():.           
+0000f160: 206e 6577 5f62 726f 6164 6361 7374 5f64   new_broadcast_d
+0000f170: 696d 656e 7369 6f6e 7320 3d20 2829 0a20  imensions = (). 
+0000f180: 2020 2020 2020 2072 6574 7572 6e20 4261         return Ba
+0000f190: 7463 6865 6456 616c 7565 2870 7269 6d73  tchedValue(prims
+0000f1a0: 2e62 726f 6164 6361 7374 5f69 6e5f 6469  .broadcast_in_di
+0000f1b0: 6d28 612e 7661 6c75 652c 206e 6577 5f73  m(a.value, new_s
+0000f1c0: 6861 7065 2c20 6e65 775f 6272 6f61 6463  hape, new_broadc
+0000f1d0: 6173 745f 6469 6d65 6e73 696f 6e73 292c  ast_dimensions),
+0000f1e0: 206e 6577 5f62 6469 6d29 0a0a 0a76 6d61   new_bdim)...vma
+0000f1f0: 705f 696d 706c 733a 2064 6963 745b 7072  p_impls: dict[pr
+0000f200: 696d 732e 5379 6d62 6f6c 2c20 4361 6c6c  ims.Symbol, Call
+0000f210: 6162 6c65 5d20 3d20 6469 6374 2829 0a0a  able] = dict()..
+0000f220: 0a64 6566 2075 6e77 7261 705f 6f6e 655f  .def unwrap_one_
+0000f230: 6c65 7665 6c5f 6f66 5f73 7562 7379 6d62  level_of_subsymb
+0000f240: 6f6c 7328 7472 6163 6529 3a0a 2020 2020  ols(trace):.    
+0000f250: 6e65 775f 7379 6d62 6f6c 735f 6974 6572  new_symbols_iter
+0000f260: 203d 2028 0a20 2020 2020 2020 2062 6f75   = (.        bou
+0000f270: 6e64 5f73 796d 626f 6c2e 7375 6273 796d  nd_symbol.subsym
+0000f280: 626f 6c73 2069 6620 6c65 6e28 626f 756e  bols if len(boun
+0000f290: 645f 7379 6d62 6f6c 2e73 7562 7379 6d62  d_symbol.subsymb
+0000f2a0: 6f6c 7329 203e 2030 2065 6c73 6520 5b62  ols) > 0 else [b
+0000f2b0: 6f75 6e64 5f73 796d 626f 6c5d 0a20 2020  ound_symbol].   
+0000f2c0: 2020 2020 2066 6f72 2062 6f75 6e64 5f73       for bound_s
+0000f2d0: 796d 626f 6c20 696e 2074 7261 6365 2e62  ymbol in trace.b
+0000f2e0: 6f75 6e64 5f73 796d 626f 6c73 0a20 2020  ound_symbols.   
+0000f2f0: 2029 0a20 2020 206e 6577 5f73 796d 626f   ).    new_symbo
+0000f300: 6c73 203d 206c 6973 7428 6368 6169 6e2e  ls = list(chain.
+0000f310: 6672 6f6d 5f69 7465 7261 626c 6528 6e65  from_iterable(ne
+0000f320: 775f 7379 6d62 6f6c 735f 6974 6572 2929  w_symbols_iter))
+0000f330: 0a20 2020 2074 7261 6365 2e62 6f75 6e64  .    trace.bound
+0000f340: 5f73 796d 626f 6c73 203d 206e 6577 5f73  _symbols = new_s
+0000f350: 796d 626f 6c73 0a20 2020 2072 6574 7572  ymbols.    retur
+0000f360: 6e20 7472 6163 650a 0a0a 6465 6620 6465  n trace...def de
+0000f370: 636f 6d70 6f73 6564 5f66 6e5f 766d 6170  composed_fn_vmap
+0000f380: 5f72 756c 6528 6178 6973 5f73 697a 652c  _rule(axis_size,
+0000f390: 202a 6172 6773 2c20 666e 2c20 2a2a 6b77   *args, fn, **kw
+0000f3a0: 6172 6773 293a 0a20 2020 2061 7267 732c  args):.    args,
+0000f3b0: 2069 6e5f 6469 6d73 203d 2075 6e7a 6970   in_dims = unzip
+0000f3c0: 3228 6172 6773 290a 2020 2020 756e 6261  2(args).    unba
+0000f3d0: 7463 6865 645f 6172 6773 203d 2074 7265  tched_args = tre
+0000f3e0: 655f 6d61 7028 6c61 6d62 6461 2078 3a20  e_map(lambda x: 
+0000f3f0: 7265 6d6f 7665 5f62 6174 6368 5f64 696d  remove_batch_dim
+0000f400: 2878 2920 6966 2069 7369 6e73 7461 6e63  (x) if isinstanc
+0000f410: 6528 782c 2054 656e 736f 7250 726f 7879  e(x, TensorProxy
+0000f420: 2920 656c 7365 2078 2c20 6172 6773 290a  ) else x, args).
+0000f430: 2020 2020 7472 6163 6520 3d20 636f 6e73      trace = cons
+0000f440: 7472 7563 745f 7472 6163 6528 2928 666e  truct_trace()(fn
+0000f450: 2c20 2a75 6e62 6174 6368 6564 5f61 7267  , *unbatched_arg
+0000f460: 732c 202a 2a6b 7761 7267 7329 0a20 2020  s, **kwargs).   
+0000f470: 2074 7261 6365 203d 2075 6e77 7261 705f   trace = unwrap_
+0000f480: 6f6e 655f 6c65 7665 6c5f 6f66 5f73 7562  one_level_of_sub
+0000f490: 7379 6d62 6f6c 7328 7472 6163 6529 0a20  symbols(trace). 
+0000f4a0: 2020 206f 7574 7320 3d20 5f76 6d61 705f     outs = _vmap_
+0000f4b0: 6361 6c6c 5f6d 6574 6166 756e 6328 4661  call_metafunc(Fa
+0000f4c0: 6c73 652c 2061 7267 732c 2069 6e5f 6469  lse, args, in_di
+0000f4d0: 6d73 2c20 302c 2061 7869 735f 7369 7a65  ms, 0, axis_size
+0000f4e0: 2c20 6675 6e63 7469 6f6e 5f74 7261 6365  , function_trace
+0000f4f0: 3d74 7261 6365 2c20 2a2a 6b77 6172 6773  =trace, **kwargs
+0000f500: 290a 2020 2020 6966 2069 7369 6e73 7461  ).    if isinsta
+0000f510: 6e63 6528 6f75 7473 2c20 5365 7175 656e  nce(outs, Sequen
+0000f520: 6365 293a 0a20 2020 2020 2020 206f 7574  ce):.        out
+0000f530: 5f64 696d 7320 3d20 2830 2c29 202a 206c  _dims = (0,) * l
+0000f540: 656e 286f 7574 7329 0a20 2020 2020 2020  en(outs).       
+0000f550: 2072 6574 7572 6e20 7361 6665 5f6d 6170   return safe_map
+0000f560: 2870 6169 725f 746f 5f62 6174 6368 6564  (pair_to_batched
+0000f570: 5f76 616c 7565 2c20 7361 6665 5f7a 6970  _value, safe_zip
+0000f580: 286f 7574 732c 206f 7574 5f64 696d 7329  (outs, out_dims)
+0000f590: 290a 2020 2020 7265 7475 726e 2042 6174  ).    return Bat
+0000f5a0: 6368 6564 5661 6c75 6528 6f75 7473 2c20  chedValue(outs, 
+0000f5b0: 3029 0a0a 0a76 6d61 705f 696d 706c 735b  0)...vmap_impls[
+0000f5c0: 7072 696d 732e 5072 696d 4944 732e 5349  prims.PrimIDs.SI
+0000f5d0: 4e5d 203d 2073 696e 5f76 6d61 700a 766d  N] = sin_vmap.vm
+0000f5e0: 6170 5f69 6d70 6c73 5b70 7269 6d73 2e50  ap_impls[prims.P
+0000f5f0: 7269 6d49 4473 2e43 4f53 5d20 3d20 636f  rimIDs.COS] = co
+0000f600: 735f 766d 6170 0a76 6d61 705f 696d 706c  s_vmap.vmap_impl
+0000f610: 735b 7072 696d 732e 5072 696d 4944 732e  s[prims.PrimIDs.
+0000f620: 4d55 4c5d 203d 206d 756c 5f76 6d61 700a  MUL] = mul_vmap.
+0000f630: 766d 6170 5f69 6d70 6c73 5b70 7269 6d73  vmap_impls[prims
+0000f640: 2e50 7269 6d49 4473 2e41 4444 5d20 3d20  .PrimIDs.ADD] = 
+0000f650: 6164 645f 766d 6170 0a76 6d61 705f 696d  add_vmap.vmap_im
+0000f660: 706c 735b 7072 696d 732e 5072 696d 4944  pls[prims.PrimID
+0000f670: 732e 5355 4d5d 203d 2073 756d 5f76 6d61  s.SUM] = sum_vma
+0000f680: 700a 766d 6170 5f69 6d70 6c73 5b70 7269  p.vmap_impls[pri
+0000f690: 6d73 2e50 7269 6d49 4473 2e42 524f 4144  ms.PrimIDs.BROAD
+0000f6a0: 4341 5354 5f49 4e5f 4449 4d5d 203d 2062  CAST_IN_DIM] = b
+0000f6b0: 726f 6164 6361 7374 5f69 6e5f 6469 6d5f  roadcast_in_dim_
+0000f6c0: 766d 6170 0a0a 0a64 6566 2076 6d61 705f  vmap...def vmap_
+0000f6d0: 7379 6d62 6f6c 5f6d 6170 7065 7228 7379  symbol_mapper(sy
+0000f6e0: 6d62 6f6c 3a20 7072 696d 732e 5379 6d62  mbol: prims.Symb
+0000f6f0: 6f6c 2c20 2a2c 2061 7869 735f 7369 7a65  ol, *, axis_size
+0000f700: 3a20 696e 7429 3a0a 2020 2020 2222 224d  : int):.    """M
+0000f710: 6170 7320 6120 7379 6d62 6f6c 2074 6f20  aps a symbol to 
+0000f720: 6120 766d 6170 2066 756e 6374 696f 6e20  a vmap function 
+0000f730: 7468 6174 2065 7661 6c75 6174 6573 2069  that evaluates i
+0000f740: 742e 0a0a 2020 2020 4172 6773 3a0a 2020  t...    Args:.  
+0000f750: 2020 2020 2020 7379 6d62 6f6c 2028 7072        symbol (pr
+0000f760: 696d 732e 5379 6d62 6f6c 293a 2053 796d  ims.Symbol): Sym
+0000f770: 626f 6c20 746f 2065 7661 6c75 6174 652e  bol to evaluate.
+0000f780: 0a0a 2020 2020 5261 6973 6573 3a0a 2020  ..    Raises:.  
+0000f790: 2020 2020 2020 4e6f 7449 6d70 6c65 6d65        NotImpleme
+0000f7a0: 6e74 6564 4572 726f 723a 2049 6620 7468  ntedError: If th
+0000f7b0: 6520 766d 6170 2066 6f72 2074 6865 2073  e vmap for the s
+0000f7c0: 796d 626f 6c20 6973 206e 6f74 2069 6d70  ymbol is not imp
+0000f7d0: 6c65 6d65 6e74 6564 2e0a 0a20 2020 2052  lemented...    R
+0000f7e0: 6574 7572 6e73 3a0a 2020 2020 2020 2020  eturns:.        
+0000f7f0: 4361 6c6c 6162 6c65 3a20 766d 6170 2066  Callable: vmap f
+0000f800: 756e 6374 696f 6e20 7468 6174 2065 7661  unction that eva
+0000f810: 6c75 6174 6573 2074 6865 2073 796d 626f  luates the symbo
+0000f820: 6c2e 0a20 2020 2022 2222 0a0a 2020 2020  l..    """..    
+0000f830: 6465 6620 7772 6170 5f61 7267 2878 293a  def wrap_arg(x):
+0000f840: 0a20 2020 2020 2020 2069 6620 6973 696e  .        if isin
+0000f850: 7374 616e 6365 2878 2c20 4261 7463 6865  stance(x, Batche
+0000f860: 6456 616c 7565 293a 0a20 2020 2020 2020  dValue):.       
+0000f870: 2020 2020 2072 6574 7572 6e20 780a 2020       return x.  
+0000f880: 2020 2020 2020 656c 6966 2069 7369 6e73        elif isins
+0000f890: 7461 6e63 6528 782c 204e 756d 6265 7229  tance(x, Number)
+0000f8a0: 3a0a 2020 2020 2020 2020 2020 2020 7265  :.            re
+0000f8b0: 7475 726e 2042 6174 6368 6564 5661 6c75  turn BatchedValu
+0000f8c0: 6528 782c 206e 6f74 5f6d 6170 7065 6429  e(x, not_mapped)
+0000f8d0: 0a20 2020 2020 2020 2065 6c73 653a 0a20  .        else:. 
+0000f8e0: 2020 2020 2020 2020 2020 2072 6169 7365             raise
+0000f8f0: 2056 616c 7565 4572 726f 7228 6622 766d   ValueError(f"vm
+0000f900: 6170 2077 7261 705f 6172 6720 676f 7420  ap wrap_arg got 
+0000f910: 616e 2075 6e73 7570 706f 7274 6564 2074  an unsupported t
+0000f920: 7970 6520 7b74 7970 6528 7829 7d22 290a  ype {type(x)}").
+0000f930: 0a20 2020 2069 6620 7379 6d62 6f6c 2e61  .    if symbol.a
+0000f940: 7265 5f61 6c6c 5f61 7267 735f 636f 6e73  re_all_args_cons
+0000f950: 7461 6e74 3a0a 0a20 2020 2020 2020 2064  tant:..        d
+0000f960: 6566 205f 766d 6170 5f69 6d70 6c5f 636f  ef _vmap_impl_co
+0000f970: 6e73 7428 7379 6d62 6f6c 2c20 2a61 7267  nst(symbol, *arg
+0000f980: 732c 202a 2a6b 7761 7267 7329 3a0a 2020  s, **kwargs):.  
+0000f990: 2020 2020 2020 2020 2020 6f75 7420 3d20            out = 
+0000f9a0: 7379 6d62 6f6c 5f74 6f5f 6576 616c 2873  symbol_to_eval(s
+0000f9b0: 796d 626f 6c29 282a 6172 6773 2c20 2a2a  ymbol)(*args, **
+0000f9c0: 6b77 6172 6773 290a 0a20 2020 2020 2020  kwargs)..       
+0000f9d0: 2020 2020 2069 6620 6973 696e 7374 616e       if isinstan
+0000f9e0: 6365 286f 7574 2c20 5365 7175 656e 6365  ce(out, Sequence
+0000f9f0: 293a 0a20 2020 2020 2020 2020 2020 2020  ):.             
+0000fa00: 2020 2072 6574 7572 6e20 7361 6665 5f6d     return safe_m
+0000fa10: 6170 2870 6169 725f 746f 5f62 6174 6368  ap(pair_to_batch
+0000fa20: 6564 5f76 616c 7565 2c20 7361 6665 5f7a  ed_value, safe_z
+0000fa30: 6970 2861 7267 732c 205b 6e6f 745f 6d61  ip(args, [not_ma
+0000fa40: 7070 6564 5d20 2a20 6c65 6e28 6f75 7429  pped] * len(out)
+0000fa50: 2929 0a0a 2020 2020 2020 2020 2020 2020  ))..            
+0000fa60: 7265 7475 726e 2042 6174 6368 6564 5661  return BatchedVa
+0000fa70: 6c75 6528 6f75 742c 206e 6f74 5f6d 6170  lue(out, not_map
+0000fa80: 7065 6429 0a0a 2020 2020 2020 2020 7265  ped)..        re
+0000fa90: 7475 726e 2070 6172 7469 616c 285f 766d  turn partial(_vm
+0000faa0: 6170 5f69 6d70 6c5f 636f 6e73 742c 2073  ap_impl_const, s
+0000fab0: 796d 626f 6c29 0a0a 2020 2020 766d 6170  ymbol)..    vmap
+0000fac0: 5f69 6d70 6c20 3d20 766d 6170 5f69 6d70  _impl = vmap_imp
+0000fad0: 6c73 2e67 6574 2873 796d 626f 6c2e 7379  ls.get(symbol.sy
+0000fae0: 6d2e 6964 290a 2020 2020 6966 2076 6d61  m.id).    if vma
+0000faf0: 705f 696d 706c 2069 7320 4e6f 6e65 3a0a  p_impl is None:.
+0000fb00: 2020 2020 2020 2020 6966 206c 656e 2873          if len(s
+0000fb10: 796d 626f 6c2e 7375 6273 796d 626f 6c73  ymbol.subsymbols
+0000fb20: 2920 3e20 303a 0a20 2020 2020 2020 2020  ) > 0:.         
+0000fb30: 2020 2076 6d61 705f 696d 706c 203d 2070     vmap_impl = p
+0000fb40: 6172 7469 616c 2864 6563 6f6d 706f 7365  artial(decompose
+0000fb50: 645f 666e 5f76 6d61 705f 7275 6c65 2c20  d_fn_vmap_rule, 
+0000fb60: 666e 3d73 796d 626f 6c2e 7379 6d29 0a20  fn=symbol.sym). 
+0000fb70: 2020 2020 2020 2065 6c73 653a 0a20 2020         else:.   
+0000fb80: 2020 2020 2020 2020 2072 6169 7365 204e           raise N
+0000fb90: 6f74 496d 706c 656d 656e 7465 6445 7272  otImplementedErr
+0000fba0: 6f72 2866 2276 6d61 7020 666f 7220 7b73  or(f"vmap for {s
+0000fbb0: 796d 626f 6c2e 7379 6d2e 6964 7d20 6973  ymbol.sym.id} is
+0000fbc0: 206e 6f74 2069 6d70 6c65 6d65 6e74 6564   not implemented
+0000fbd0: 2229 0a0a 2020 2020 6465 6620 5f76 6d61  ")..    def _vma
+0000fbe0: 705f 696d 706c 282a 6172 6773 2c20 2a2a  p_impl(*args, **
+0000fbf0: 6b77 6172 6773 293a 0a20 2020 2020 2020  kwargs):.       
+0000fc00: 2061 7267 7320 3d20 7472 6565 5f6d 6170   args = tree_map
+0000fc10: 2877 7261 705f 6172 672c 2061 7267 7329  (wrap_arg, args)
+0000fc20: 0a20 2020 2020 2020 2061 7373 6572 7420  .        assert 
+0000fc30: 616c 6c28 6973 696e 7374 616e 6365 2861  all(isinstance(a
+0000fc40: 7267 2c20 4261 7463 6865 6456 616c 7565  rg, BatchedValue
+0000fc50: 2920 666f 7220 6172 6720 696e 2074 7265  ) for arg in tre
+0000fc60: 655f 666c 6174 7465 6e28 6172 6773 295b  e_flatten(args)[
+0000fc70: 305d 290a 2020 2020 2020 2020 7265 7475  0]).        retu
+0000fc80: 726e 2076 6d61 705f 696d 706c 2861 7869  rn vmap_impl(axi
+0000fc90: 735f 7369 7a65 2c20 2a61 7267 732c 202a  s_size, *args, *
+0000fca0: 2a6b 7761 7267 7329 0a0a 2020 2020 7265  *kwargs)..    re
+0000fcb0: 7475 726e 205f 766d 6170 5f69 6d70 6c0a  turn _vmap_impl.
+0000fcc0: 0a0a 6465 6620 7265 6d6f 7665 5f62 6174  ..def remove_bat
+0000fcd0: 6368 5f64 696d 2874 656e 736f 723a 2054  ch_dim(tensor: T
+0000fce0: 656e 736f 7250 726f 7879 2c20 6261 7463  ensorProxy, batc
+0000fcf0: 685f 6469 6d3a 2069 6e74 203d 2030 2920  h_dim: int = 0) 
+0000fd00: 2d3e 2054 656e 736f 7250 726f 7879 3a0a  -> TensorProxy:.
+0000fd10: 2020 2020 2222 2252 656d 6f76 6573 2074      """Removes t
+0000fd20: 6865 2062 6174 6368 2064 696d 656e 7369  he batch dimensi
+0000fd30: 6f6e 2066 726f 6d20 6120 7465 6e73 6f72  on from a tensor
+0000fd40: 2e0a 0a20 2020 2041 7267 733a 0a20 2020  ...    Args:.   
+0000fd50: 2020 2020 2074 656e 736f 7220 2854 656e       tensor (Ten
+0000fd60: 736f 7250 726f 7879 293a 2054 656e 736f  sorProxy): Tenso
+0000fd70: 7220 746f 2072 656d 6f76 6520 7468 6520  r to remove the 
+0000fd80: 6261 7463 6820 6469 6d65 6e73 696f 6e20  batch dimension 
+0000fd90: 6672 6f6d 2e0a 0a20 2020 2052 6574 7572  from...    Retur
+0000fda0: 6e73 3a0a 2020 2020 2020 2020 5465 6e73  ns:.        Tens
+0000fdb0: 6f72 5072 6f78 793a 2054 656e 736f 7220  orProxy: Tensor 
+0000fdc0: 7769 7468 2074 6865 2062 6174 6368 2064  with the batch d
+0000fdd0: 696d 656e 7369 6f6e 2072 656d 6f76 6564  imension removed
+0000fde0: 2e0a 2020 2020 2222 220a 2020 2020 6e65  ..    """.    ne
+0000fdf0: 775f 7368 6170 6520 3d20 7465 6e73 6f72  w_shape = tensor
+0000fe00: 2e73 6861 7065 5b3a 6261 7463 685f 6469  .shape[:batch_di
+0000fe10: 6d5d 202b 2074 656e 736f 722e 7368 6170  m] + tensor.shap
+0000fe20: 655b 6261 7463 685f 6469 6d20 2b20 3120  e[batch_dim + 1 
+0000fe30: 3a5d 0a20 2020 2072 6574 7572 6e20 5465  :].    return Te
+0000fe40: 6e73 6f72 5072 6f78 7928 6c69 6b65 3d74  nsorProxy(like=t
+0000fe50: 656e 736f 722c 2073 6861 7065 3d6e 6577  ensor, shape=new
+0000fe60: 5f73 6861 7065 290a 0a0a 2320 544f 444f  _shape)...# TODO
+0000fe70: 3a20 696e 204a 4158 2061 7267 732c 2069  : in JAX args, i
+0000fe80: 6e5f 6469 6d73 2061 7265 2066 6c61 7474  n_dims are flatt
+0000fe90: 656e 6564 2074 6865 2073 616d 6520 7761  ened the same wa
+0000fea0: 790a 2320 544f 444f 3a20 696e 204a 4158  y.# TODO: in JAX
+0000feb0: 206f 7574 5f64 696d 7320 6172 6520 666c   out_dims are fl
+0000fec0: 6174 7465 6e65 6420 6173 2077 656c 6c0a  attened as well.
+0000fed0: 6465 6620 5f76 6d61 705f 6361 6c6c 5f6d  def _vmap_call_m
+0000fee0: 6574 6166 756e 6328 6465 7461 6368 6564  etafunc(detached
+0000fef0: 3a20 626f 6f6c 2c20 6172 6773 2c20 696e  : bool, args, in
+0000ff00: 5f64 696d 732c 206f 7574 5f64 696d 732c  _dims, out_dims,
+0000ff10: 2061 7869 735f 7369 7a65 2c20 6675 6e63   axis_size, func
+0000ff20: 7469 6f6e 5f74 7261 6365 3a20 5472 6163  tion_trace: Trac
+0000ff30: 652c 202a 2a6b 7761 7267 7329 3a0a 2020  e, **kwargs):.  
+0000ff40: 2020 2222 224d 6574 6166 756e 6374 696f    """Metafunctio
+0000ff50: 6e20 666f 7220 766d 6170 2063 616c 6c2e  n for vmap call.
+0000ff60: 0a0a 2020 2020 4172 6773 3a0a 2020 2020  ..    Args:.    
+0000ff70: 2020 2020 6465 7461 6368 6564 2028 626f      detached (bo
+0000ff80: 6f6c 293a 2057 6865 7468 6572 2074 6f20  ol): Whether to 
+0000ff90: 6465 7461 6368 2074 6865 2074 7261 6365  detach the trace
+0000ffa0: 2e0a 2020 2020 2020 2020 6172 6773 2028  ..        args (
+0000ffb0: 5475 706c 655b 5072 6f78 795d 293a 2041  Tuple[Proxy]): A
+0000ffc0: 7267 756d 656e 7473 2074 6f20 7468 6520  rguments to the 
+0000ffd0: 6675 6e63 7469 6f6e 2e0a 2020 2020 2020  function..      
+0000ffe0: 2020 696e 5f64 696d 7320 2854 7570 6c65    in_dims (Tuple
+0000fff0: 5b69 6e74 5d29 3a20 4261 7463 6820 6469  [int]): Batch di
+00010000: 6d65 6e73 696f 6e20 666f 7220 6561 6368  mension for each
+00010010: 2061 7267 756d 656e 742e 0a20 2020 2020   argument..     
+00010020: 2020 206f 7574 5f64 696d 7320 2854 7570     out_dims (Tup
+00010030: 6c65 5b69 6e74 5d29 3a20 4261 7463 6820  le[int]): Batch 
+00010040: 6469 6d65 6e73 696f 6e20 666f 7220 7265  dimension for re
+00010050: 7475 726e 2076 616c 7565 732e 0a20 2020  turn values..   
+00010060: 2020 2020 2066 756e 6374 696f 6e5f 7472       function_tr
+00010070: 6163 6520 2854 7261 6365 293a 2054 7261  ace (Trace): Tra
+00010080: 6365 2074 6f20 7573 6520 666f 7220 7468  ce to use for th
+00010090: 6520 6675 6e63 7469 6f6e 2e0a 2020 2020  e function..    
+000100a0: 2020 2020 6b77 6172 6773 3a20 4b65 7977      kwargs: Keyw
+000100b0: 6f72 6420 6172 6775 6d65 6e74 732e 0a0a  ord arguments...
+000100c0: 2020 2020 5261 6973 6573 3a0a 2020 2020      Raises:.    
+000100d0: 2020 2020 4173 7365 7274 696f 6e45 7272      AssertionErr
+000100e0: 6f72 3a20 4966 2074 6865 2076 6d61 7020  or: If the vmap 
+000100f0: 666f 7220 6b65 7977 6f72 6420 6172 6775  for keyword argu
+00010100: 6d65 6e74 7320 6973 206e 6f74 2069 6d70  ments is not imp
+00010110: 6c65 6d65 6e74 6564 2e0a 0a20 2020 2052  lemented...    R
+00010120: 6574 7572 6e73 3a0a 2020 2020 2020 2020  eturns:.        
+00010130: 5265 7375 6c74 206f 6620 7468 6520 766d  Result of the vm
+00010140: 6170 2074 7261 6e73 666f 726d 2e0a 2020  ap transform..  
+00010150: 2020 2222 220a 2020 2020 636f 6d6d 6f6e    """.    common
+00010160: 5f64 6576 6963 6520 3d20 7b78 2e64 6576  _device = {x.dev
+00010170: 6963 6520 666f 7220 7820 696e 2061 7267  ice for x in arg
+00010180: 7320 6966 2069 7369 6e73 7461 6e63 6528  s if isinstance(
+00010190: 782c 2054 656e 736f 7250 726f 7879 297d  x, TensorProxy)}
+000101a0: 0a20 2020 2061 7373 6572 7420 6c65 6e28  .    assert len(
+000101b0: 636f 6d6d 6f6e 5f64 6576 6963 6529 203c  common_device) <
+000101c0: 3d20 312c 2022 766d 6170 2066 6f72 206d  = 1, "vmap for m
+000101d0: 756c 7469 706c 6520 6465 7669 6365 7320  ultiple devices 
+000101e0: 6973 206e 6f74 2069 6d70 6c65 6d65 6e74  is not implement
+000101f0: 6564 220a 2020 2020 2863 6f6d 6d6f 6e5f  ed".    (common_
+00010200: 6465 7669 6365 2c29 203d 2063 6f6d 6d6f  device,) = commo
+00010210: 6e5f 6465 7669 6365 2069 6620 6c65 6e28  n_device if len(
+00010220: 636f 6d6d 6f6e 5f64 6576 6963 6529 203d  common_device) =
+00010230: 3d20 3120 656c 7365 2028 6370 752c 290a  = 1 else (cpu,).
+00010240: 0a20 2020 2069 6620 6178 6973 5f73 697a  .    if axis_siz
+00010250: 6520 6973 204e 6f6e 653a 0a20 2020 2020  e is None:.     
+00010260: 2020 2028 6178 6973 5f73 697a 652c 2920     (axis_size,) 
+00010270: 3d20 7b78 2e73 6861 7065 5b61 785d 2066  = {x.shape[ax] f
+00010280: 6f72 2078 2c20 6178 2069 6e20 7a69 7028  or x, ax in zip(
+00010290: 6172 6773 2c20 696e 5f64 696d 7329 2069  args, in_dims) i
+000102a0: 6620 6178 2069 7320 6e6f 7420 6e6f 745f  f ax is not not_
+000102b0: 6d61 7070 6564 7d0a 2020 2020 696e 5f64  mapped}.    in_d
+000102c0: 696d 7320 3d20 696e 5f64 696d 7320 6966  ims = in_dims if
+000102d0: 2069 7369 6e73 7461 6e63 6528 696e 5f64   isinstance(in_d
+000102e0: 696d 732c 2053 6571 7565 6e63 6529 2065  ims, Sequence) e
+000102f0: 6c73 6520 2869 6e5f 6469 6d73 2c29 0a20  lse (in_dims,). 
+00010300: 2020 2069 6e5f 6469 6d73 203d 2074 7570     in_dims = tup
+00010310: 6c65 286e 6f74 5f6d 6170 7065 6420 6966  le(not_mapped if
+00010320: 2069 7369 6e73 7461 6e63 6528 612c 204e   isinstance(a, N
+00010330: 756d 6265 7229 2065 6c73 6520 6420 666f  umber) else d fo
+00010340: 7220 612c 2064 2069 6e20 7361 6665 5f7a  r a, d in safe_z
+00010350: 6970 2861 7267 732c 2069 6e5f 6469 6d73  ip(args, in_dims
+00010360: 2929 0a20 2020 206f 7574 5f64 696d 7320  )).    out_dims 
+00010370: 3d20 6f75 745f 6469 6d73 2069 6620 6973  = out_dims if is
+00010380: 696e 7374 616e 6365 286f 7574 5f64 696d  instance(out_dim
+00010390: 732c 2053 6571 7565 6e63 6529 2065 6c73  s, Sequence) els
+000103a0: 6520 286f 7574 5f64 696d 732c 290a 0a20  e (out_dims,).. 
+000103b0: 2020 2063 7478 203d 2064 6574 6163 6865     ctx = detache
+000103c0: 645f 7472 6163 6528 2920 6966 2064 6574  d_trace() if det
+000103d0: 6163 6865 6420 656c 7365 206e 756c 6c63  ached else nullc
+000103e0: 6f6e 7465 7874 2829 0a20 2020 2077 6974  ontext().    wit
+000103f0: 6820 6374 783a 0a20 2020 2020 2020 2023  h ctx:.        #
+00010400: 2057 6520 7072 6f70 6167 6174 6520 7468   We propagate th
+00010410: 6520 4261 7463 6856 616c 7565 2074 6872  e BatchValue thr
+00010420: 6f75 6768 2074 6865 2074 7261 6365 2c20  ough the trace, 
+00010430: 616e 6420 7468 656e 2075 6e77 7261 7020  and then unwrap 
+00010440: 6974 2061 7420 7468 6520 656e 640a 2020  it at the end.  
+00010450: 2020 2020 2020 6261 7463 6865 645f 6172        batched_ar
+00010460: 6773 203d 2073 6166 655f 6d61 7028 7061  gs = safe_map(pa
+00010470: 6972 5f74 6f5f 6261 7463 6865 645f 7661  ir_to_batched_va
+00010480: 6c75 652c 2073 6166 655f 7a69 7028 6172  lue, safe_zip(ar
+00010490: 6773 2c20 696e 5f64 696d 7329 290a 2020  gs, in_dims)).  
+000104a0: 2020 2020 2020 7265 7375 6c74 203d 2065        result = e
+000104b0: 7661 6c5f 7472 6163 6528 0a20 2020 2020  val_trace(.     
+000104c0: 2020 2020 2020 2066 756e 6374 696f 6e5f         function_
+000104d0: 7472 6163 652c 202a 6261 7463 6865 645f  trace, *batched_
+000104e0: 6172 6773 2c20 7379 6d62 6f6c 5f6d 6170  args, symbol_map
+000104f0: 7065 723d 7061 7274 6961 6c28 766d 6170  per=partial(vmap
+00010500: 5f73 796d 626f 6c5f 6d61 7070 6572 2c20  _symbol_mapper, 
+00010510: 6178 6973 5f73 697a 653d 6178 6973 5f73  axis_size=axis_s
+00010520: 697a 6529 2c20 2a2a 6b77 6172 6773 0a20  ize), **kwargs. 
+00010530: 2020 2020 2020 2029 0a20 2020 2020 2020         ).       
+00010540: 2023 2055 6e77 7261 7070 696e 6720 7468   # Unwrapping th
+00010550: 6520 4261 7463 6865 6456 616c 7565 2773  e BatchedValue's
+00010560: 0a20 2020 2020 2020 2069 6620 6973 696e  .        if isin
+00010570: 7374 616e 6365 2872 6573 756c 742c 2053  stance(result, S
+00010580: 6571 7565 6e63 6529 3a0a 2020 2020 2020  equence):.      
+00010590: 2020 2020 2020 666c 6174 5f72 6573 756c        flat_resul
+000105a0: 742c 2073 7065 6320 3d20 7472 6565 5f66  t, spec = tree_f
+000105b0: 6c61 7474 656e 2872 6573 756c 7429 0a20  latten(result). 
+000105c0: 2020 2020 2020 2020 2020 2061 7373 6572             asser
+000105d0: 7420 616c 6c28 6973 696e 7374 616e 6365  t all(isinstance
+000105e0: 2878 2c20 4261 7463 6865 6456 616c 7565  (x, BatchedValue
+000105f0: 2920 666f 7220 7820 696e 2066 6c61 745f  ) for x in flat_
+00010600: 7265 7375 6c74 290a 2020 2020 2020 2020  result).        
+00010610: 2020 2020 6f75 7473 2c20 6264 696d 7320      outs, bdims 
+00010620: 3d20 756e 7a69 7032 2866 6c61 745f 7265  = unzip2(flat_re
+00010630: 7375 6c74 290a 2020 2020 2020 2020 2020  sult).          
+00010640: 2020 2320 544f 444f 3a20 6861 6e64 6c65    # TODO: handle
+00010650: 2074 6865 2063 6173 6520 7768 6572 6520   the case where 
+00010660: 6f75 745f 6469 6d73 2069 7320 6120 7369  out_dims is a si
+00010670: 6e67 6c65 2076 616c 7565 2062 6574 7465  ngle value bette
+00010680: 720a 2020 2020 2020 2020 2020 2020 6966  r.            if
+00010690: 206c 656e 286f 7574 5f64 696d 7329 203d   len(out_dims) =
+000106a0: 3d20 313a 0a20 2020 2020 2020 2020 2020  = 1:.           
+000106b0: 2020 2020 206f 7574 5f64 696d 7320 3d20       out_dims = 
+000106c0: 6f75 745f 6469 6d73 202a 206c 656e 286f  out_dims * len(o
+000106d0: 7574 7329 0a20 2020 2020 2020 2020 2020  uts).           
+000106e0: 206f 7574 7320 3d20 7361 6665 5f6d 6170   outs = safe_map
+000106f0: 2870 6172 7469 616c 286d 6f76 655f 6261  (partial(move_ba
+00010700: 7463 685f 6469 6d2c 2061 7869 735f 7369  tch_dim, axis_si
+00010710: 7a65 292c 2062 6469 6d73 2c20 6f75 745f  ze), bdims, out_
+00010720: 6469 6d73 2c20 6f75 7473 290a 2020 2020  dims, outs).    
+00010730: 2020 2020 2020 2020 7265 7475 726e 2074          return t
+00010740: 7265 655f 756e 666c 6174 7465 6e28 6f75  ree_unflatten(ou
+00010750: 7473 2c20 7370 6563 290a 2020 2020 2020  ts, spec).      
+00010760: 2020 6966 2069 7369 6e73 7461 6e63 6528    if isinstance(
+00010770: 7265 7375 6c74 2c20 4e75 6d62 6572 2920  result, Number) 
+00010780: 616e 6420 6178 6973 5f73 697a 6520 6973  and axis_size is
+00010790: 206e 6f74 204e 6f6e 653a 0a20 2020 2020   not None:.     
+000107a0: 2020 2020 2020 2023 2054 4f44 4f3a 2066         # TODO: f
+000107b0: 6574 6368 2074 6865 2064 6566 6175 6c74  etch the default
+000107c0: 2064 6576 6963 6520 6672 6f6d 2074 6865   device from the
+000107d0: 2063 6f6e 7465 7874 0a20 2020 2020 2020   context.       
+000107e0: 2020 2020 2072 6573 756c 7420 3d20 6675       result = fu
+000107f0: 6c6c 2873 6861 7065 3d28 292c 2066 696c  ll(shape=(), fil
+00010800: 6c5f 7661 6c75 653d 7265 7375 6c74 2c20  l_value=result, 
+00010810: 6465 7669 6365 3d63 6f6d 6d6f 6e5f 6465  device=common_de
+00010820: 7669 6365 290a 2020 2020 2020 2020 2020  vice).          
+00010830: 2020 7265 7375 6c74 203d 2042 6174 6368    result = Batch
+00010840: 6564 5661 6c75 6528 7265 7375 6c74 2c20  edValue(result, 
+00010850: 6e6f 745f 6d61 7070 6564 290a 2020 2020  not_mapped).    
+00010860: 2020 2020 656c 6966 2069 7369 6e73 7461      elif isinsta
+00010870: 6e63 6528 7265 7375 6c74 2c20 4261 7463  nce(result, Batc
+00010880: 6865 6456 616c 7565 2920 616e 6420 6973  hedValue) and is
+00010890: 696e 7374 616e 6365 2872 6573 756c 742e  instance(result.
+000108a0: 7661 6c75 652c 204e 756d 6265 7229 2061  value, Number) a
+000108b0: 6e64 2061 7869 735f 7369 7a65 2069 7320  nd axis_size is 
+000108c0: 6e6f 7420 4e6f 6e65 3a0a 2020 2020 2020  not None:.      
+000108d0: 2020 2020 2020 7265 7375 6c74 203d 2042        result = B
+000108e0: 6174 6368 6564 5661 6c75 6528 6675 6c6c  atchedValue(full
+000108f0: 2873 6861 7065 3d28 292c 2066 696c 6c5f  (shape=(), fill_
+00010900: 7661 6c75 653d 7265 7375 6c74 2e76 616c  value=result.val
+00010910: 7565 2c20 6465 7669 6365 3d63 6f6d 6d6f  ue, device=commo
+00010920: 6e5f 6465 7669 6365 292c 2072 6573 756c  n_device), resul
+00010930: 742e 6261 7463 685f 6469 6d29 0a20 2020  t.batch_dim).   
+00010940: 2020 2020 2061 7373 6572 7420 6973 696e       assert isin
+00010950: 7374 616e 6365 2872 6573 756c 742c 2042  stance(result, B
+00010960: 6174 6368 6564 5661 6c75 6529 0a20 2020  atchedValue).   
+00010970: 2020 2020 206f 7574 203d 206d 6f76 655f       out = move_
+00010980: 6261 7463 685f 6469 6d28 6178 6973 5f73  batch_dim(axis_s
+00010990: 697a 652c 2072 6573 756c 742e 6261 7463  ize, result.batc
+000109a0: 685f 6469 6d2c 206f 7574 5f64 696d 735b  h_dim, out_dims[
+000109b0: 305d 2c20 7265 7375 6c74 2e76 616c 7565  0], result.value
+000109c0: 290a 2020 2020 2020 2020 7265 7475 726e  ).        return
+000109d0: 206f 7574 0a0a 0a76 6d61 705f 6361 6c6c   out...vmap_call
+000109e0: 203d 2053 796d 626f 6c28 6964 3d54 7261   = Symbol(id=Tra
+000109f0: 6e73 666f 726d 732e 566d 6170 4f70 2c20  nsforms.VmapOp, 
+00010a00: 6e61 6d65 3d22 766d 6170 5f63 616c 6c22  name="vmap_call"
+00010a10: 2c20 6d65 7461 3d70 6172 7469 616c 285f  , meta=partial(_
+00010a20: 766d 6170 5f63 616c 6c5f 6d65 7461 6675  vmap_call_metafu
+00010a30: 6e63 2c20 4661 6c73 6529 290a 0a0a 2320  nc, False))...# 
+00010a40: 544f 444f 3a20 686f 7720 7368 6f75 6c64  TODO: how should
+00010a50: 2077 6520 6861 6e64 6c65 206f 7574 5f64   we handle out_d
+00010a60: 696d 7320 6865 7265 3f0a 2320 616c 7468  ims here?.# alth
+00010a70: 6f75 6768 2068 6572 6520 7765 2061 7265  ough here we are
+00010a80: 2063 616c 6c69 6e67 2076 6d61 7020 6f66   calling vmap of
+00010a90: 2069 6465 6e74 6974 792c 2073 6f20 7765   identity, so we
+00010aa0: 2073 686f 756c 6420 6b6e 6f77 2066 726f   should know fro
+00010ab0: 6d20 7468 6520 6361 6c6c 2074 6f20 766d  m the call to vm
+00010ac0: 6170 0a23 2054 6869 7320 7368 6f75 6c64  ap.# This should
+00010ad0: 2062 6520 6669 6e65 2e20 4966 2077 6520   be fine. If we 
+00010ae0: 6861 7665 2076 6d61 7028 6964 656e 7469  have vmap(identi
+00010af0: 7479 2866 756e 6329 2c20 6f75 745f 6469  ty(func), out_di
+00010b00: 6d73 3d4e 2920 7468 656e 2074 6869 7320  ms=N) then this 
+00010b10: 7275 6c65 2069 7320 6669 7273 7420 7573  rule is first us
+00010b20: 6564 0a23 2074 6f20 6765 7420 7468 6520  ed.# to get the 
+00010b30: 766d 6170 7065 6420 7265 7375 6c74 206f  vmapped result o
+00010b40: 6620 6964 656e 7469 7479 2866 756e 6329  f identity(func)
+00010b50: 2069 6e20 766d 6170 5f73 796d 626f 6c5f   in vmap_symbol_
+00010b60: 6d61 7070 6572 2c20 616e 6420 6f75 745f  mapper, and out_
+00010b70: 6469 6d73 2069 7320 6861 6e64 6c65 640a  dims is handled.
+00010b80: 2320 6166 7465 7220 7468 6174 2069 6e20  # after that in 
+00010b90: 7468 6520 6f75 7465 7220 5f76 6d61 705f  the outer _vmap_
+00010ba0: 6361 6c6c 5f6d 6574 6166 756e 632e 0a64  call_metafunc..d
+00010bb0: 6566 205f 6964 656e 7469 7479 5f63 616c  ef _identity_cal
+00010bc0: 6c5f 766d 6170 2861 7869 735f 7369 7a65  l_vmap(axis_size
+00010bd0: 2c20 2a62 6174 6368 6564 5f61 7267 732c  , *batched_args,
+00010be0: 2074 7261 6365 3a20 5472 6163 652c 202a   trace: Trace, *
+00010bf0: 2a6b 7761 7267 7329 3a0a 2020 2020 6172  *kwargs):.    ar
+00010c00: 6773 2c20 696e 5f64 696d 7320 3d20 756e  gs, in_dims = un
+00010c10: 7a69 7032 2862 6174 6368 6564 5f61 7267  zip2(batched_arg
+00010c20: 7329 0a20 2020 206f 7574 5f64 696d 7320  s).    out_dims 
+00010c30: 3d20 3020 2023 2046 6978 6d65 0a20 2020  = 0  # Fixme.   
+00010c40: 206f 7574 732c 206f 7574 5f64 696d 7320   outs, out_dims 
+00010c50: 3d20 5f76 6d61 705f 6361 6c6c 5f6d 6574  = _vmap_call_met
+00010c60: 6166 756e 6328 4661 6c73 652c 2061 7267  afunc(False, arg
+00010c70: 732c 2069 6e5f 6469 6d73 2c20 6f75 745f  s, in_dims, out_
+00010c80: 6469 6d73 2c20 6178 6973 5f73 697a 652c  dims, axis_size,
+00010c90: 2066 756e 6374 696f 6e5f 7472 6163 653d   function_trace=
+00010ca0: 7472 6163 652c 202a 2a6b 7761 7267 7329  trace, **kwargs)
+00010cb0: 0a20 2020 2069 6620 6973 696e 7374 616e  .    if isinstan
+00010cc0: 6365 286f 7574 732c 2053 6571 7565 6e63  ce(outs, Sequenc
+00010cd0: 6529 3a0a 2020 2020 2020 2020 7265 7475  e):.        retu
+00010ce0: 726e 2073 6166 655f 6d61 7028 7061 6972  rn safe_map(pair
+00010cf0: 5f74 6f5f 6261 7463 6865 645f 7661 6c75  _to_batched_valu
+00010d00: 652c 2073 6166 655f 7a69 7028 6f75 7473  e, safe_zip(outs
+00010d10: 2c20 6f75 745f 6469 6d73 2929 0a20 2020  , out_dims)).   
+00010d20: 2072 6574 7572 6e20 4261 7463 6865 6456   return BatchedV
+00010d30: 616c 7565 286f 7574 732c 206f 7574 5f64  alue(outs, out_d
+00010d40: 696d 7329 0a0a 0a76 6d61 705f 696d 706c  ims)...vmap_impl
+00010d50: 735b 5472 616e 7366 6f72 6d73 2e49 6465  s[Transforms.Ide
+00010d60: 6e74 6974 794f 705d 203d 205f 6964 656e  ntityOp] = _iden
+00010d70: 7469 7479 5f63 616c 6c5f 766d 6170 0a0a  tity_call_vmap..
+00010d80: 0a64 6566 205f 6a76 705f 6361 6c6c 5f76  .def _jvp_call_v
+00010d90: 6d61 7028 6178 6973 5f73 697a 652c 2062  map(axis_size, b
+00010da0: 6174 6368 6564 5f70 7269 6d61 6c73 2c20  atched_primals, 
+00010db0: 6261 7463 6865 645f 7461 6e67 656e 7473  batched_tangents
+00010dc0: 2c20 2a2c 2066 756e 6374 696f 6e5f 7472  , *, function_tr
+00010dd0: 6163 653a 2054 7261 6365 2c20 2a2a 6b77  ace: Trace, **kw
+00010de0: 6172 6773 293a 0a20 2020 2070 7269 6d61  args):.    prima
+00010df0: 6c73 2c20 7072 696d 616c 735f 6264 696d  ls, primals_bdim
+00010e00: 7320 3d20 7361 6665 5f7a 6970 282a 6261  s = safe_zip(*ba
+00010e10: 7463 6865 645f 7072 696d 616c 7329 0a20  tched_primals). 
+00010e20: 2020 2074 616e 6765 6e74 732c 2074 616e     tangents, tan
+00010e30: 6765 6e74 735f 6264 696d 7320 3d20 7361  gents_bdims = sa
+00010e40: 6665 5f7a 6970 282a 6261 7463 6865 645f  fe_zip(*batched_
+00010e50: 7461 6e67 656e 7473 290a 2020 2020 6a76  tangents).    jv
+00010e60: 705f 6675 6e63 203d 2070 6172 7469 616c  p_func = partial
+00010e70: 285f 6a76 705f 6361 6c6c 5f6d 6574 6166  (_jvp_call_metaf
+00010e80: 756e 632c 2046 616c 7365 2c20 6675 6e63  unc, False, func
+00010e90: 7469 6f6e 5f74 7261 6365 3d66 756e 6374  tion_trace=funct
+00010ea0: 696f 6e5f 7472 6163 6529 0a20 2020 2076  ion_trace).    v
+00010eb0: 6d61 7070 6564 5f6a 7670 5f66 756e 6320  mapped_jvp_func 
+00010ec0: 3d20 766d 6170 286a 7670 5f66 756e 632c  = vmap(jvp_func,
+00010ed0: 2069 6e5f 6469 6d73 3d28 7072 696d 616c   in_dims=(primal
+00010ee0: 735f 6264 696d 732c 2074 616e 6765 6e74  s_bdims, tangent
+00010ef0: 735f 6264 696d 7329 2c20 6178 6973 5f73  s_bdims), axis_s
+00010f00: 697a 653d 6178 6973 5f73 697a 6529 0a20  ize=axis_size). 
+00010f10: 2020 2072 6573 756c 7420 3d20 766d 6170     result = vmap
+00010f20: 7065 645f 6a76 705f 6675 6e63 2870 7269  ped_jvp_func(pri
+00010f30: 6d61 6c73 2c20 7461 6e67 656e 7473 2c20  mals, tangents, 
+00010f40: 2a2a 6b77 6172 6773 290a 2020 2020 7265  **kwargs).    re
+00010f50: 7475 726e 2074 7265 655f 6d61 7028 6c61  turn tree_map(la
+00010f60: 6d62 6461 2078 3a20 4261 7463 6865 6456  mbda x: BatchedV
+00010f70: 616c 7565 2878 2c20 3029 2c20 7265 7375  alue(x, 0), resu
+00010f80: 6c74 290a 0a0a 766d 6170 5f69 6d70 6c73  lt)...vmap_impls
+00010f90: 5b54 7261 6e73 666f 726d 732e 4a76 704f  [Transforms.JvpO
+00010fa0: 705d 203d 205f 6a76 705f 6361 6c6c 5f76  p] = _jvp_call_v
+00010fb0: 6d61 700a 0a0a 6465 6620 766d 6170 2866  map...def vmap(f
+00010fc0: 756e 632c 2069 6e5f 6469 6d73 3d30 2c20  unc, in_dims=0, 
+00010fd0: 6f75 745f 6469 6d73 3d30 2c20 6178 6973  out_dims=0, axis
+00010fe0: 5f73 697a 653d 4e6f 6e65 293a 0a20 2020  _size=None):.   
+00010ff0: 2022 2222 5665 6374 6f72 697a 696e 6720   """Vectorizing 
+00011000: 7472 616e 7366 6f72 6d20 666f 7220 6120  transform for a 
+00011010: 5468 756e 6465 7220 6675 6e63 7469 6f6e  Thunder function
+00011020: 2e0a 0a20 2020 2041 7267 733a 0a20 2020  ...    Args:.   
+00011030: 2020 2020 2066 756e 6320 2843 616c 6c61       func (Calla
+00011040: 626c 6529 3a20 4120 5468 756e 6465 7220  ble): A Thunder 
+00011050: 6675 6e63 7469 6f6e 2074 6f20 6265 2074  function to be t
+00011060: 7261 6e73 666f 726d 6564 2e0a 0a20 2020  ransformed...   
+00011070: 2052 6574 7572 6e73 3a0a 2020 2020 2020   Returns:.      
+00011080: 2020 4361 6c6c 6162 6c65 3a20 4120 766d    Callable: A vm
+00011090: 6170 7065 6420 7665 7273 696f 6e20 6f66  apped version of
+000110a0: 2074 6865 2066 756e 6374 696f 6e2e 0a20   the function.. 
+000110b0: 2020 2022 2222 0a0a 2020 2020 2320 544f     """..    # TO
+000110c0: 444f 3a20 666c 6174 7465 6e0a 2020 2020  DO: flatten.    
+000110d0: 2320 496e 204a 4158 2066 6c61 7474 656e  # In JAX flatten
+000110e0: 696e 6720 6f66 2069 6e5f 6469 6d73 2069  ing of in_dims i
+000110f0: 7320 7261 7468 6572 2063 6f6d 706c 6963  s rather complic
+00011100: 6174 6564 2062 6563 6175 7365 2069 7420  ated because it 
+00011110: 6361 6e20 6f70 7469 6f6e 616c 6c79 2062  can optionally b
+00011120: 650a 2020 2020 2320 7370 6563 6966 6965  e.    # specifie
+00011130: 6420 6173 2061 20e2 809c 7072 6566 6978  d as a ...prefix
+00011140: e280 9d20 7079 7472 6565 2c20 6d65 616e  ... pytree, mean
+00011150: 696e 6720 7468 6174 2061 2073 696e 676c  ing that a singl
+00011160: 6520 6c65 6166 2076 616c 7565 2063 616e  e leaf value can
+00011170: 2062 6520 6170 706c 6965 640a 2020 2020   be applied.    
+00011180: 2320 746f 2061 6e20 656e 7469 7265 2073  # to an entire s
+00011190: 7562 2d70 7974 7265 652e 0a0a 2020 2020  ub-pytree...    
+000111a0: 6465 6620 666c 6174 7465 6e5f 6675 6e63  def flatten_func
+000111b0: 5f66 6f72 5f76 6d61 7028 6675 6e63 2c20  _for_vmap(func, 
+000111c0: 6172 6773 2c20 6b77 6172 6773 293a 0a20  args, kwargs):. 
+000111d0: 2020 2020 2020 2066 6c61 745f 6172 6773         flat_args
+000111e0: 2c20 7370 6563 203d 2074 7265 655f 666c  , spec = tree_fl
+000111f0: 6174 7465 6e28 2861 7267 732c 206b 7761  atten((args, kwa
+00011200: 7267 7329 290a 0a20 2020 2020 2020 2064  rgs))..        d
+00011210: 6566 2066 6c61 745f 6675 6e63 282a 666c  ef flat_func(*fl
+00011220: 6174 5f61 7267 7329 3a0a 2020 2020 2020  at_args):.      
+00011230: 2020 2020 2020 666e 5f61 7267 732c 2066        fn_args, f
+00011240: 6e5f 6b77 6172 6773 203d 2074 7265 655f  n_kwargs = tree_
+00011250: 756e 666c 6174 7465 6e28 666c 6174 5f61  unflatten(flat_a
+00011260: 7267 732c 2073 7065 6329 0a20 2020 2020  rgs, spec).     
+00011270: 2020 2020 2020 2072 6574 7572 6e20 6675         return fu
+00011280: 6e63 282a 666e 5f61 7267 732c 202a 2a66  nc(*fn_args, **f
+00011290: 6e5f 6b77 6172 6773 290a 0a20 2020 2020  n_kwargs)..     
+000112a0: 2020 2072 6574 7572 6e20 666c 6174 5f66     return flat_f
+000112b0: 756e 632c 2066 6c61 745f 6172 6773 2c20  unc, flat_args, 
+000112c0: 7370 6563 0a0a 2020 2020 6465 6620 7772  spec..    def wr
+000112d0: 6170 7065 7228 2a61 7267 732c 202a 2a6b  apper(*args, **k
+000112e0: 7761 7267 7329 3a0a 2020 2020 2020 2020  wargs):.        
+000112f0: 6675 6e63 5f66 6c61 742c 2061 7267 735f  func_flat, args_
+00011300: 666c 6174 2c20 6172 6773 5f73 7065 6320  flat, args_spec 
+00011310: 3d20 666c 6174 7465 6e5f 6675 6e63 5f66  = flatten_func_f
+00011320: 6f72 5f76 6d61 7028 6675 6e63 2c20 6172  or_vmap(func, ar
+00011330: 6773 2c20 6b77 6172 6773 290a 2020 2020  gs, kwargs).    
+00011340: 2020 2020 6966 2069 7369 6e73 7461 6e63      if isinstanc
+00011350: 6528 696e 5f64 696d 732c 2069 6e74 293a  e(in_dims, int):
+00011360: 0a20 2020 2020 2020 2020 2020 2069 6e5f  .            in_
+00011370: 6469 6d73 5f66 6c61 7420 3d20 2869 6e5f  dims_flat = (in_
+00011380: 6469 6d73 2c29 202a 206c 656e 2861 7267  dims,) * len(arg
+00011390: 735f 666c 6174 290a 2020 2020 2020 2020  s_flat).        
+000113a0: 656c 7365 3a0a 2020 2020 2020 2020 2020  else:.          
+000113b0: 2020 696e 5f64 696d 735f 666c 6174 2c20    in_dims_flat, 
+000113c0: 696e 5f64 696d 735f 7370 6563 203d 2074  in_dims_spec = t
+000113d0: 7265 655f 666c 6174 7465 6e28 696e 5f64  ree_flatten(in_d
+000113e0: 696d 7329 0a20 2020 2020 2020 2020 2020  ims).           
+000113f0: 2061 7373 6572 7420 6c65 6e28 696e 5f64   assert len(in_d
+00011400: 696d 735f 666c 6174 2920 3d3d 206c 656e  ims_flat) == len
+00011410: 2861 7267 735f 666c 6174 292c 2022 696e  (args_flat), "in
+00011420: 5f64 696d 7320 6d75 7374 2068 6176 6520  _dims must have 
+00011430: 7468 6520 7361 6d65 206c 656e 6774 6820  the same length 
+00011440: 6173 2061 7267 732c 206b 7761 7267 7322  as args, kwargs"
+00011450: 0a20 2020 2020 2020 2075 6e62 6174 6368  .        unbatch
+00011460: 6564 5f61 7267 735f 666c 6174 203d 205b  ed_args_flat = [
+00011470: 7265 6d6f 7665 5f62 6174 6368 5f64 696d  remove_batch_dim
+00011480: 2861 7267 2920 6966 2069 7369 6e73 7461  (arg) if isinsta
+00011490: 6e63 6528 6172 672c 2054 656e 736f 7250  nce(arg, TensorP
+000114a0: 726f 7879 2920 656c 7365 2061 7267 2066  roxy) else arg f
+000114b0: 6f72 2061 7267 2069 6e20 6172 6773 5f66  or arg in args_f
+000114c0: 6c61 745d 0a20 2020 2020 2020 2074 7261  lat].        tra
+000114d0: 6365 203d 2063 6f6e 7374 7275 6374 5f74  ce = construct_t
+000114e0: 7261 6365 2829 2866 756e 635f 666c 6174  race()(func_flat
+000114f0: 2c20 2a75 6e62 6174 6368 6564 5f61 7267  , *unbatched_arg
+00011500: 735f 666c 6174 290a 2020 2020 2020 2020  s_flat).        
+00011510: 6f75 7473 203d 2076 6d61 705f 6361 6c6c  outs = vmap_call
+00011520: 2861 7267 735f 666c 6174 2c20 696e 5f64  (args_flat, in_d
+00011530: 696d 735f 666c 6174 2c20 6f75 745f 6469  ims_flat, out_di
+00011540: 6d73 2c20 6178 6973 5f73 697a 653d 6178  ms, axis_size=ax
+00011550: 6973 5f73 697a 652c 2066 756e 6374 696f  is_size, functio
+00011560: 6e5f 7472 6163 653d 7472 6163 6529 0a20  n_trace=trace). 
+00011570: 2020 2020 2020 2072 6574 7572 6e20 6f75         return ou
+00011580: 7473 0a0a 2020 2020 7265 7475 726e 2077  ts..    return w
+00011590: 7261 7070 6572 0a0a 0a23 2054 4f44 4f20  rapper...# TODO 
+000115a0: 5468 6973 2066 756e 6374 696f 6e20 636f  This function co
+000115b0: 6d6d 656e 7465 6420 6f75 7420 6265 6361  mmented out beca
+000115c0: 7573 6520 6974 2063 616c 6c73 206d 616b  use it calls mak
+000115d0: 655f 7472 6163 6564 2c20 7768 6963 6820  e_traced, which 
+000115e0: 646f 6573 206e 6f74 2065 7869 7374 0a23  does not exist.#
+000115f0: 2064 6566 2076 6d61 705f 6561 6765 7228   def vmap_eager(
+00011600: 6675 6e63 2c20 6172 6773 2c20 696e 5f64  func, args, in_d
+00011610: 696d 733d 302c 206f 7574 5f64 696d 733d  ims=0, out_dims=
+00011620: 302c 2061 7869 735f 7369 7a65 3d4e 6f6e  0, axis_size=Non
+00011630: 652c 2065 7865 6375 746f 723d 2274 6f72  e, executor="tor
+00011640: 6368 2229 3a0a 2320 2020 2020 2222 2243  ch"):.#     """C
+00011650: 6f6d 7075 7465 7320 7468 6520 766d 6170  omputes the vmap
+00011660: 206f 6620 6120 5468 756e 6465 7220 6675   of a Thunder fu
+00011670: 6e63 7469 6f6e 2e0a 0a23 2020 2020 2041  nction...#     A
+00011680: 7267 733a 0a23 2020 2020 2020 2020 2066  rgs:.#         f
+00011690: 756e 6320 2843 616c 6c61 626c 6529 3a20  unc (Callable): 
+000116a0: 4120 5468 756e 6465 7220 6675 6e63 7469  A Thunder functi
+000116b0: 6f6e 2074 6f20 6265 2074 7261 6e73 666f  on to be transfo
+000116c0: 726d 6564 2e0a 2320 2020 2020 2020 2020  rmed..#         
+000116d0: 6172 6773 2028 5f74 7970 655f 293a 2041  args (_type_): A
+000116e0: 7267 7320 6f66 2074 6865 2066 756e 6374  rgs of the funct
+000116f0: 696f 6e2e 0a23 2020 2020 2020 2020 2065  ion..#         e
+00011700: 7865 6375 746f 7220 2873 7472 2c20 6f70  xecutor (str, op
+00011710: 7469 6f6e 616c 293a 2045 7865 6375 746f  tional): Executo
+00011720: 7220 746f 2075 7365 2e20 4465 6661 756c  r to use. Defaul
+00011730: 7473 2074 6f20 2274 6f72 6368 222e 0a0a  ts to "torch"...
+00011740: 2320 2020 2020 5265 7475 726e 733a 0a23  #     Returns:.#
+00011750: 2020 2020 2020 2020 2054 6865 2072 6573           The res
+00011760: 756c 7420 6f66 2074 6865 2076 6d61 7070  ult of the vmapp
+00011770: 6564 2066 756e 6374 696f 6e2e 0a23 2020  ed function..#  
+00011780: 2020 2022 2222 0a23 2020 2020 2023 2054     """.#     # T
+00011790: 4f44 4f3a 2066 6978 2074 6869 7320 2d20  ODO: fix this - 
+000117a0: 6e6f 7420 616c 6c20 6172 6773 206d 6179  not all args may
+000117b0: 2062 6520 6261 7463 6865 640a 2320 2020   be batched.#   
+000117c0: 2020 2320 544f 444f 3a20 6865 7265 2077    # TODO: here w
+000117d0: 6520 6173 7375 6d65 2062 6174 6368 2061  e assume batch a
+000117e0: 7869 7320 6973 2030 0a23 2020 2020 2076  xis is 0.#     v
+000117f0: 6d61 705f 7472 6163 6520 3d20 6d61 6b65  map_trace = make
+00011800: 5f74 7261 6365 280a 2320 2020 2020 2020  _trace(.#       
+00011810: 2020 766d 6170 2866 756e 632c 2069 6e5f    vmap(func, in_
+00011820: 6469 6d73 3d69 6e5f 6469 6d73 2c20 6f75  dims=in_dims, ou
+00011830: 745f 6469 6d73 3d6f 7574 5f64 696d 732c  t_dims=out_dims,
+00011840: 2061 7869 735f 7369 7a65 3d61 7869 735f   axis_size=axis_
+00011850: 7369 7a65 292c 2065 7865 6375 746f 723d  size), executor=
+00011860: 6578 6563 7574 6f72 2c0a 2320 2020 2020  executor,.#     
+00011870: 2020 2020 2a61 7267 7329 0a23 2020 2020      *args).#    
+00011880: 2076 6d61 705f 7472 6163 6564 203d 206d   vmap_traced = m
+00011890: 616b 655f 7472 6163 6564 2870 6172 7469  ake_traced(parti
+000118a0: 616c 2865 7661 6c5f 7472 6163 652c 2076  al(eval_trace, v
+000118b0: 6d61 705f 7472 6163 6529 2c20 6578 6563  map_trace), exec
+000118c0: 7574 6f72 3d65 7865 6375 746f 7229 0a23  utor=executor).#
+000118d0: 2020 2020 2072 6574 7572 6e20 766d 6170       return vmap
+000118e0: 5f74 7261 6365 6428 2a61 7267 7329 0a0a  _traced(*args)..
+000118f0: 0a23 204a 5650 2074 7261 6e73 666f 726d  .# JVP transform
+00011900: 0a23 202d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  .# -------------
+00011910: 0a0a 0a40 6461 7461 636c 6173 7328 6672  ...@dataclass(fr
+00011920: 6f7a 656e 3d54 7275 6529 0a63 6c61 7373  ozen=True).class
+00011930: 204a 5650 4475 616c 3a0a 2020 2020 2222   JVPDual:.    ""
+00011940: 2244 7561 6c20 6e75 6d62 6572 2066 6f72  "Dual number for
+00011950: 2074 6865 204a 5650 2074 7261 6e73 666f   the JVP transfo
+00011960: 726d 2e0a 0a20 2020 2041 7474 7269 6275  rm...    Attribu
+00011970: 7465 733a 0a20 2020 2020 2020 2070 7269  tes:.        pri
+00011980: 6d61 6c3a 2050 7269 6d61 6c20 7661 6c75  mal: Primal valu
+00011990: 652e 0a20 2020 2020 2020 2074 616e 6765  e..        tange
+000119a0: 6e74 3a20 5461 6e67 656e 7420 7661 6c75  nt: Tangent valu
+000119b0: 652e 0a20 2020 2022 2222 0a0a 2020 2020  e..    """..    
+000119c0: 7072 696d 616c 3a20 416e 790a 2020 2020  primal: Any.    
+000119d0: 7461 6e67 656e 743a 2041 6e79 0a0a 2020  tangent: Any..  
+000119e0: 2020 6465 6620 5f5f 6974 6572 5f5f 2873    def __iter__(s
+000119f0: 656c 6629 3a0a 2020 2020 2020 2020 7969  elf):.        yi
+00011a00: 656c 6420 7365 6c66 2e70 7269 6d61 6c0a  eld self.primal.
+00011a10: 2020 2020 2020 2020 7969 656c 6420 7365          yield se
+00011a20: 6c66 2e74 616e 6765 6e74 0a0a 0a64 6566  lf.tangent...def
+00011a30: 2070 6169 725f 746f 5f6a 7670 5f64 7561   pair_to_jvp_dua
+00011a40: 6c28 7061 6972 293a 0a20 2020 2022 2222  l(pair):.    """
+00011a50: 436f 6e76 6572 7473 2061 2070 6169 7220  Converts a pair 
+00011a60: 746f 2061 204a 5650 4475 616c 2e0a 0a20  to a JVPDual... 
+00011a70: 2020 2041 7267 733a 0a20 2020 2020 2020     Args:.       
+00011a80: 2070 6169 7220 2853 6571 7565 6e63 6529   pair (Sequence)
+00011a90: 3a20 5061 6972 2074 6f20 636f 6e76 6572  : Pair to conver
+00011aa0: 742e 0a0a 2020 2020 5265 7475 726e 733a  t...    Returns:
+00011ab0: 0a20 2020 2020 2020 204a 5650 4475 616c  .        JVPDual
+00011ac0: 3a20 4a56 5044 7561 6c20 7265 7072 6573  : JVPDual repres
+00011ad0: 656e 7461 7469 6f6e 206f 6620 7468 6520  entation of the 
+00011ae0: 7061 6972 2e0a 2020 2020 2222 220a 2020  pair..    """.  
+00011af0: 2020 6966 2069 7369 6e73 7461 6e63 6528    if isinstance(
+00011b00: 7061 6972 2c20 4a56 5044 7561 6c29 3a0a  pair, JVPDual):.
+00011b10: 2020 2020 2020 2020 7265 7475 726e 2070          return p
+00011b20: 6169 720a 2020 2020 656c 7365 3a0a 2020  air.    else:.  
+00011b30: 2020 2020 2020 6173 7365 7274 2069 7369        assert isi
+00011b40: 6e73 7461 6e63 6528 7061 6972 2c20 5365  nstance(pair, Se
+00011b50: 7175 656e 6365 2920 616e 6420 6c65 6e28  quence) and len(
+00011b60: 7061 6972 2920 3d3d 2032 0a20 2020 2020  pair) == 2.     
+00011b70: 2020 2072 6574 7572 6e20 4a56 5044 7561     return JVPDua
+00011b80: 6c28 2a70 6169 7229 0a0a 0a64 6566 2073  l(*pair)...def s
+00011b90: 696e 5f6a 7670 2861 3a20 4a56 5044 7561  in_jvp(a: JVPDua
+00011ba0: 6c29 3a0a 2020 2020 782c 2078 6420 3d20  l):.    x, xd = 
+00011bb0: 610a 2020 2020 7265 7475 726e 204a 5650  a.    return JVP
+00011bc0: 4475 616c 2870 7269 6d73 2e73 696e 2878  Dual(prims.sin(x
+00011bd0: 292c 2070 7269 6d73 2e63 6f73 2878 2920  ), prims.cos(x) 
+00011be0: 2a20 7864 290a 0a0a 6465 6620 6d75 6c5f  * xd)...def mul_
+00011bf0: 6a76 7028 613a 204a 5650 4475 616c 2c20  jvp(a: JVPDual, 
+00011c00: 623a 204a 5650 4475 616c 293a 0a20 2020  b: JVPDual):.   
+00011c10: 2078 2c20 7864 203d 2061 0a20 2020 2079   x, xd = a.    y
+00011c20: 2c20 7964 203d 2062 0a20 2020 2072 6574  , yd = b.    ret
+00011c30: 7572 6e20 4a56 5044 7561 6c28 7820 2a20  urn JVPDual(x * 
+00011c40: 792c 2078 202a 2079 6420 2b20 7920 2a20  y, x * yd + y * 
+00011c50: 7864 290a 0a0a 6465 6620 6164 645f 6a76  xd)...def add_jv
+00011c60: 7028 613a 204a 5650 4475 616c 2c20 623a  p(a: JVPDual, b:
+00011c70: 204a 5650 4475 616c 293a 0a20 2020 2078   JVPDual):.    x
+00011c80: 2c20 7864 203d 2061 0a20 2020 2079 2c20  , xd = a.    y, 
+00011c90: 7964 203d 2062 0a20 2020 2072 6574 7572  yd = b.    retur
+00011ca0: 6e20 4a56 5044 7561 6c28 7820 2b20 792c  n JVPDual(x + y,
+00011cb0: 2078 6420 2b20 7964 290a 0a0a 6465 6620   xd + yd)...def 
+00011cc0: 6272 6f61 6463 6173 745f 696e 5f64 696d  broadcast_in_dim
+00011cd0: 5f6a 7670 2861 3a20 4a56 5044 7561 6c2c  _jvp(a: JVPDual,
+00011ce0: 2073 6861 7065 3a20 7475 706c 655b 4a56   shape: tuple[JV
+00011cf0: 5044 7561 6c2c 202e 2e2e 5d2c 2062 726f  PDual, ...], bro
+00011d00: 6164 6361 7374 5f64 696d 656e 7369 6f6e  adcast_dimension
+00011d10: 733a 2074 7570 6c65 5b4a 5650 4475 616c  s: tuple[JVPDual
+00011d20: 2c20 2e2e 2e5d 2920 2d3e 204a 5650 4475  , ...]) -> JVPDu
+00011d30: 616c 3a0a 2020 2020 782c 2078 6420 3d20  al:.    x, xd = 
+00011d40: 610a 2020 2020 2320 544f 444f 3a20 7368  a.    # TODO: sh
+00011d50: 6170 6520 616e 6420 6272 6f61 6463 6173  ape and broadcas
+00011d60: 745f 6469 6d65 6e73 696f 6e73 2073 686f  t_dimensions sho
+00011d70: 756c 6420 6265 2074 7570 6c65 7320 6f66  uld be tuples of
+00011d80: 2069 6e74 730a 2020 2020 2320 6275 7420   ints.    # but 
+00011d90: 666f 7220 6e6f 7720 6974 2773 2061 2074  for now it's a t
+00011da0: 7570 6c65 206f 6620 4a56 5044 7561 6c73  uple of JVPDuals
+00011db0: 0a20 2020 2069 6620 6c65 6e28 7368 6170  .    if len(shap
+00011dc0: 6529 203e 2030 2061 6e64 2069 7369 6e73  e) > 0 and isins
+00011dd0: 7461 6e63 6528 7368 6170 655b 305d 2c20  tance(shape[0], 
+00011de0: 4a56 5044 7561 6c29 3a0a 2020 2020 2020  JVPDual):.      
+00011df0: 2020 7368 6170 652c 205f 203d 2073 6166    shape, _ = saf
+00011e00: 655f 7a69 7028 2a73 6861 7065 290a 2020  e_zip(*shape).  
+00011e10: 2020 6966 206c 656e 2862 726f 6164 6361    if len(broadca
+00011e20: 7374 5f64 696d 656e 7369 6f6e 7329 203e  st_dimensions) >
+00011e30: 2030 2061 6e64 2069 7369 6e73 7461 6e63   0 and isinstanc
+00011e40: 6528 6272 6f61 6463 6173 745f 6469 6d65  e(broadcast_dime
+00011e50: 6e73 696f 6e73 5b30 5d2c 204a 5650 4475  nsions[0], JVPDu
+00011e60: 616c 293a 0a20 2020 2020 2020 2062 726f  al):.        bro
+00011e70: 6164 6361 7374 5f64 696d 656e 7369 6f6e  adcast_dimension
+00011e80: 732c 205f 203d 2073 6166 655f 7a69 7028  s, _ = safe_zip(
+00011e90: 2a62 726f 6164 6361 7374 5f64 696d 656e  *broadcast_dimen
+00011ea0: 7369 6f6e 7329 0a20 2020 2072 6574 7572  sions).    retur
+00011eb0: 6e20 4a56 5044 7561 6c28 0a20 2020 2020  n JVPDual(.     
+00011ec0: 2020 2070 7269 6d73 2e62 726f 6164 6361     prims.broadca
+00011ed0: 7374 5f69 6e5f 6469 6d28 782c 2073 6861  st_in_dim(x, sha
+00011ee0: 7065 2c20 6272 6f61 6463 6173 745f 6469  pe, broadcast_di
+00011ef0: 6d65 6e73 696f 6e73 292c 2070 7269 6d73  mensions), prims
+00011f00: 2e62 726f 6164 6361 7374 5f69 6e5f 6469  .broadcast_in_di
+00011f10: 6d28 7864 2c20 7368 6170 652c 2062 726f  m(xd, shape, bro
+00011f20: 6164 6361 7374 5f64 696d 656e 7369 6f6e  adcast_dimension
+00011f30: 7329 0a20 2020 2029 0a0a 0a64 6566 2075  s).    )...def u
+00011f40: 6e70 6163 6b5f 7365 7175 656e 6365 5f6a  npack_sequence_j
+00011f50: 7670 2873 6571 7565 6e63 653a 204a 5650  vp(sequence: JVP
+00011f60: 4475 616c 2c20 6c65 6e67 7468 3a20 4a56  Dual, length: JV
+00011f70: 5044 7561 6c29 202d 3e20 4a56 5044 7561  PDual) -> JVPDua
+00011f80: 6c3a 0a20 2020 2078 203d 2074 7265 655f  l:.    x = tree_
+00011f90: 6d61 7028 6c61 6d62 6461 2078 3a20 782e  map(lambda x: x.
+00011fa0: 7072 696d 616c 2c20 7365 7175 656e 6365  primal, sequence
+00011fb0: 290a 2020 2020 7864 203d 2074 7265 655f  ).    xd = tree_
+00011fc0: 6d61 7028 6c61 6d62 6461 2078 3a20 782e  map(lambda x: x.
+00011fd0: 7461 6e67 656e 742c 2073 6571 7565 6e63  tangent, sequenc
+00011fe0: 6529 0a20 2020 206c 656e 6774 682c 205f  e).    length, _
+00011ff0: 203d 206c 656e 6774 680a 2020 2020 7072   = length.    pr
+00012000: 696d 616c 7320 3d20 7072 696d 732e 756e  imals = prims.un
+00012010: 7061 636b 5f73 6571 7565 6e63 6528 782c  pack_sequence(x,
+00012020: 206c 656e 6774 6829 0a20 2020 2074 616e   length).    tan
+00012030: 6765 6e74 7320 3d20 7072 696d 732e 756e  gents = prims.un
+00012040: 7061 636b 5f73 6571 7565 6e63 6528 7864  pack_sequence(xd
+00012050: 2c20 6c65 6e67 7468 290a 2020 2020 7265  , length).    re
+00012060: 7475 726e 2073 6166 655f 6d61 7028 7061  turn safe_map(pa
+00012070: 6972 5f74 6f5f 6a76 705f 6475 616c 2c20  ir_to_jvp_dual, 
+00012080: 7361 6665 5f7a 6970 2870 7269 6d61 6c73  safe_zip(primals
+00012090: 2c20 7461 6e67 656e 7473 2929 0a0a 0a64  , tangents))...d
+000120a0: 6566 2075 6e70 6163 6b5f 7472 6976 6961  ef unpack_trivia
+000120b0: 6c5f 6a76 7028 783a 204a 5650 4475 616c  l_jvp(x: JVPDual
+000120c0: 2920 2d3e 204a 5650 4475 616c 3a0a 2020  ) -> JVPDual:.  
+000120d0: 2020 7265 7475 726e 2078 0a0a 0a6a 7670    return x...jvp
+000120e0: 5f69 6d70 6c73 3a20 6469 6374 5b70 7269  _impls: dict[pri
+000120f0: 6d73 2e53 796d 626f 6c2c 2043 616c 6c61  ms.Symbol, Calla
+00012100: 626c 655d 203d 2064 6963 7428 290a 0a6a  ble] = dict()..j
+00012110: 7670 5f69 6d70 6c73 5b70 7269 6d73 2e50  vp_impls[prims.P
+00012120: 7269 6d49 4473 2e53 494e 5d20 3d20 7369  rimIDs.SIN] = si
+00012130: 6e5f 6a76 700a 6a76 705f 696d 706c 735b  n_jvp.jvp_impls[
+00012140: 7072 696d 732e 5072 696d 4944 732e 4d55  prims.PrimIDs.MU
+00012150: 4c5d 203d 206d 756c 5f6a 7670 0a6a 7670  L] = mul_jvp.jvp
 00012160: 5f69 6d70 6c73 5b70 7269 6d73 2e50 7269  _impls[prims.Pri
-00012170: 6d49 4473 2e55 4e50 4143 4b5f 5345 5155  mIDs.UNPACK_SEQU
-00012180: 454e 4345 5d20 3d20 756e 7061 636b 5f73  ENCE] = unpack_s
-00012190: 6571 7565 6e63 655f 6a76 700a 2320 6a76  equence_jvp.# jv
-000121a0: 705f 696d 706c 735b 7072 696d 732e 5072  p_impls[prims.Pr
-000121b0: 696d 4944 732e 554e 5041 434b 5f54 5249  imIDs.UNPACK_TRI
-000121c0: 5649 414c 5d20 3d20 756e 7061 636b 5f74  VIAL] = unpack_t
-000121d0: 7269 7669 616c 5f6a 7670 0a0a 0a64 6566  rivial_jvp...def
-000121e0: 206a 7670 5f73 796d 626f 6c5f 6d61 7070   jvp_symbol_mapp
-000121f0: 6572 2873 796d 626f 6c3a 2070 7269 6d73  er(symbol: prims
-00012200: 2e53 796d 626f 6c29 3a0a 2020 2020 2222  .Symbol):.    ""
-00012210: 224d 6170 7320 6120 7379 6d62 6f6c 2074  "Maps a symbol t
-00012220: 6f20 6120 4a56 5020 6675 6e63 7469 6f6e  o a JVP function
-00012230: 2074 6861 7420 6576 616c 7561 7465 7320   that evaluates 
-00012240: 6974 2e0a 0a20 2020 2041 7267 733a 0a20  it...    Args:. 
-00012250: 2020 2020 2020 2073 796d 626f 6c20 2870         symbol (p
-00012260: 7269 6d73 2e53 796d 626f 6c29 3a20 5379  rims.Symbol): Sy
-00012270: 6d62 6f6c 2074 6f20 6576 616c 7561 7465  mbol to evaluate
-00012280: 2e0a 0a20 2020 2052 6169 7365 733a 0a20  ...    Raises:. 
-00012290: 2020 2020 2020 204e 6f74 496d 706c 656d         NotImplem
-000122a0: 656e 7465 6445 7272 6f72 3a20 4966 2074  entedError: If t
-000122b0: 6865 204a 5650 2066 6f72 2074 6865 2073  he JVP for the s
-000122c0: 796d 626f 6c20 6973 206e 6f74 2069 6d70  ymbol is not imp
-000122d0: 6c65 6d65 6e74 6564 2e0a 0a20 2020 2052  lemented...    R
-000122e0: 6574 7572 6e73 3a0a 2020 2020 2020 2020  eturns:.        
-000122f0: 4361 6c6c 6162 6c65 3a20 4a56 5020 6675  Callable: JVP fu
-00012300: 6e63 7469 6f6e 2074 6861 7420 6576 616c  nction that eval
-00012310: 7561 7465 7320 7468 6520 7379 6d62 6f6c  uates the symbol
-00012320: 2e0a 2020 2020 2222 220a 0a20 2020 2064  ..    """..    d
-00012330: 6566 2077 7261 705f 6172 6728 7829 3a0a  ef wrap_arg(x):.
-00012340: 2020 2020 2020 2020 6966 2069 7369 6e73          if isins
-00012350: 7461 6e63 6528 782c 204a 5650 4475 616c  tance(x, JVPDual
-00012360: 293a 0a20 2020 2020 2020 2020 2020 2072  ):.            r
-00012370: 6574 7572 6e20 780a 2020 2020 2020 2020  eturn x.        
-00012380: 656c 6966 2069 7369 6e73 7461 6e63 6528  elif isinstance(
-00012390: 782c 204e 756d 6265 7229 3a0a 2020 2020  x, Number):.    
-000123a0: 2020 2020 2020 2020 7265 7475 726e 204a          return J
-000123b0: 5650 4475 616c 2878 2c20 7479 7065 2878  VPDual(x, type(x
-000123c0: 2928 3029 290a 2020 2020 2020 2020 656c  )(0)).        el
-000123d0: 7365 3a0a 2020 2020 2020 2020 2020 2020  se:.            
-000123e0: 7261 6973 6520 5661 6c75 6545 7272 6f72  raise ValueError
-000123f0: 2866 224a 5650 2077 7261 705f 6172 6720  (f"JVP wrap_arg 
-00012400: 676f 7420 616e 2075 6e73 7570 706f 7274  got an unsupport
-00012410: 6564 2074 7970 6520 7b74 7970 6528 7829  ed type {type(x)
-00012420: 7d22 290a 0a20 2020 2023 2049 6620 7379  }")..    # If sy
-00012430: 6d62 6f6c 2e61 7267 7320 646f 6573 6e27  mbol.args doesn'
-00012440: 7420 6861 7665 2073 7562 636c 6173 7365  t have subclasse
-00012450: 7320 6f66 2056 6172 6961 626c 652c 2074  s of Variable, t
-00012460: 6865 6e20 7765 206e 6565 6420 746f 2072  hen we need to r
-00012470: 6574 7572 6e20 6120 7a65 726f 2074 616e  eturn a zero tan
-00012480: 6765 6e74 0a20 2020 2023 2054 4f44 4f3a  gent.    # TODO:
-00012490: 2074 6865 7265 206d 6179 2062 6520 6120   there may be a 
-000124a0: 6265 7474 6572 2077 6179 2074 6f20 6465  better way to de
-000124b0: 7465 6374 2063 6f6e 7374 616e 7473 2069  tect constants i
-000124c0: 6e20 7468 6520 7472 6163 650a 2020 2020  n the trace.    
-000124d0: 6966 2073 796d 626f 6c2e 6172 655f 616c  if symbol.are_al
-000124e0: 6c5f 6172 6773 5f63 6f6e 7374 616e 743a  l_args_constant:
-000124f0: 0a0a 2020 2020 2020 2020 6465 6620 7a65  ..        def ze
-00012500: 726f 735f 6c69 6b65 2878 293a 0a20 2020  ros_like(x):.   
-00012510: 2020 2020 2020 2020 2069 6620 6973 696e           if isin
-00012520: 7374 616e 6365 2878 2c20 5465 6e73 6f72  stance(x, Tensor
-00012530: 5072 6f78 7929 3a0a 2020 2020 2020 2020  Proxy):.        
-00012540: 2020 2020 2020 2020 7265 7475 726e 2066          return f
-00012550: 756c 6c5f 6c69 6b65 2878 2c20 6669 6c6c  ull_like(x, fill
-00012560: 5f76 616c 7565 3d30 290a 2020 2020 2020  _value=0).      
-00012570: 2020 2020 2020 656c 6966 2069 7369 6e73        elif isins
-00012580: 7461 6e63 6528 782c 204e 756d 6265 7250  tance(x, NumberP
-00012590: 726f 7879 293a 0a20 2020 2020 2020 2020  roxy):.         
-000125a0: 2020 2020 2020 2072 6574 7572 6e20 7479         return ty
-000125b0: 7065 2878 2e76 616c 7565 2928 3029 0a20  pe(x.value)(0). 
-000125c0: 2020 2020 2020 2020 2020 2065 6c69 6620             elif 
-000125d0: 6973 696e 7374 616e 6365 2878 2c20 4e75  isinstance(x, Nu
-000125e0: 6d62 6572 293a 0a20 2020 2020 2020 2020  mber):.         
-000125f0: 2020 2020 2020 2072 6574 7572 6e20 7479         return ty
-00012600: 7065 2878 2928 3029 0a20 2020 2020 2020  pe(x)(0).       
-00012610: 2020 2020 2065 6c73 653a 0a20 2020 2020       else:.     
-00012620: 2020 2020 2020 2020 2020 2072 6169 7365             raise
-00012630: 2056 616c 7565 4572 726f 7228 6622 7a65   ValueError(f"ze
-00012640: 726f 735f 6c69 6b65 2069 6e73 6964 6520  ros_like inside 
-00012650: 4a56 5020 676f 7420 616e 2075 6e73 7570  JVP got an unsup
-00012660: 706f 7274 6564 2074 7970 6520 7b74 7970  ported type {typ
-00012670: 6528 7829 7d22 290a 0a20 2020 2020 2020  e(x)}")..       
-00012680: 2064 6566 206a 7670 5f69 6d70 6c5f 636f   def jvp_impl_co
-00012690: 6e73 7428 7379 6d62 6f6c 2c20 2a61 7267  nst(symbol, *arg
-000126a0: 732c 202a 2a6b 7761 7267 7329 3a0a 2020  s, **kwargs):.  
-000126b0: 2020 2020 2020 2020 2020 7072 696d 616c            primal
-000126c0: 7320 3d20 7379 6d62 6f6c 5f74 6f5f 6576  s = symbol_to_ev
-000126d0: 616c 2873 796d 626f 6c29 282a 6172 6773  al(symbol)(*args
-000126e0: 2c20 2a2a 6b77 6172 6773 290a 2020 2020  , **kwargs).    
-000126f0: 2020 2020 2020 2020 6966 2069 7369 6e73          if isins
-00012700: 7461 6e63 6528 7072 696d 616c 732c 2053  tance(primals, S
-00012710: 6571 7565 6e63 6529 3a0a 2020 2020 2020  equence):.      
-00012720: 2020 2020 2020 2020 2020 7461 6e67 656e            tangen
-00012730: 7473 203d 2074 7570 6c65 287a 6572 6f73  ts = tuple(zeros
-00012740: 5f6c 696b 6528 7029 2066 6f72 2070 2069  _like(p) for p i
-00012750: 6e20 7072 696d 616c 7329 0a20 2020 2020  n primals).     
-00012760: 2020 2020 2020 2020 2020 2072 6574 7572             retur
-00012770: 6e20 7361 6665 5f6d 6170 2870 6169 725f  n safe_map(pair_
-00012780: 746f 5f6a 7670 5f64 7561 6c2c 2073 6166  to_jvp_dual, saf
-00012790: 655f 7a69 7028 7072 696d 616c 732c 2074  e_zip(primals, t
-000127a0: 616e 6765 6e74 7329 290a 2020 2020 2020  angents)).      
-000127b0: 2020 2020 2020 7265 7475 726e 204a 5650        return JVP
-000127c0: 4475 616c 2870 7269 6d61 6c73 2c20 7a65  Dual(primals, ze
-000127d0: 726f 735f 6c69 6b65 2870 7269 6d61 6c73  ros_like(primals
-000127e0: 2929 0a0a 2020 2020 2020 2020 7265 7475  ))..        retu
-000127f0: 726e 2070 6172 7469 616c 286a 7670 5f69  rn partial(jvp_i
-00012800: 6d70 6c5f 636f 6e73 742c 2073 796d 626f  mpl_const, symbo
-00012810: 6c29 0a0a 2020 2020 2320 4e6f 726d 616c  l)..    # Normal
-00012820: 2063 6173 652c 2077 6520 6861 7665 2061   case, we have a
-00012830: 2070 726f 7879 2074 616e 6765 6e74 0a20   proxy tangent. 
-00012840: 2020 206a 7670 5f69 6d70 6c20 3d20 6a76     jvp_impl = jv
-00012850: 705f 696d 706c 732e 6765 7428 7379 6d62  p_impls.get(symb
-00012860: 6f6c 2e73 796d 2e69 6429 0a20 2020 2069  ol.sym.id).    i
-00012870: 6620 6a76 705f 696d 706c 2069 7320 4e6f  f jvp_impl is No
-00012880: 6e65 3a0a 2020 2020 2020 2020 7261 6973  ne:.        rais
-00012890: 6520 4e6f 7449 6d70 6c65 6d65 6e74 6564  e NotImplemented
-000128a0: 4572 726f 7228 6622 4a56 5020 666f 7220  Error(f"JVP for 
-000128b0: 7b73 796d 626f 6c2e 7379 6d2e 6964 7d20  {symbol.sym.id} 
-000128c0: 6973 206e 6f74 2069 6d70 6c65 6d65 6e74  is not implement
-000128d0: 6564 2229 0a0a 2020 2020 6465 6620 5f6a  ed")..    def _j
-000128e0: 7670 5f69 6d70 6c28 2a61 7267 732c 202a  vp_impl(*args, *
-000128f0: 2a6b 7761 7267 7329 3a0a 2020 2020 2020  *kwargs):.      
-00012900: 2020 6172 6773 203d 2074 7265 655f 6d61    args = tree_ma
-00012910: 7028 7772 6170 5f61 7267 2c20 6172 6773  p(wrap_arg, args
-00012920: 290a 2020 2020 2020 2020 2320 4578 7065  ).        # Expe
-00012930: 6374 696e 6720 4a56 5044 7561 6c73 2077  cting JVPDuals w
-00012940: 7261 7070 696e 6720 7061 6972 7320 6f66  rapping pairs of
-00012950: 2070 7269 6d61 6c73 2061 6e64 2074 616e   primals and tan
-00012960: 6765 6e74 730a 2020 2020 2020 2020 6173  gents.        as
-00012970: 7365 7274 2061 6c6c 2869 7369 6e73 7461  sert all(isinsta
-00012980: 6e63 6528 6172 672c 204a 5650 4475 616c  nce(arg, JVPDual
-00012990: 2920 666f 7220 6172 6720 696e 2074 7265  ) for arg in tre
-000129a0: 655f 666c 6174 7465 6e28 6172 6773 295b  e_flatten(args)[
-000129b0: 305d 290a 2020 2020 2020 2020 7265 7475  0]).        retu
-000129c0: 726e 206a 7670 5f69 6d70 6c28 2a61 7267  rn jvp_impl(*arg
-000129d0: 732c 202a 2a6b 7761 7267 7329 0a0a 2020  s, **kwargs)..  
-000129e0: 2020 7265 7475 726e 205f 6a76 705f 696d    return _jvp_im
-000129f0: 706c 0a0a 0a64 6566 205f 6a76 705f 6361  pl...def _jvp_ca
-00012a00: 6c6c 5f6d 6574 6166 756e 6328 6465 7461  ll_metafunc(deta
-00012a10: 6368 6564 3a20 626f 6f6c 2c20 7072 696d  ched: bool, prim
-00012a20: 616c 732c 2074 616e 6765 6e74 732c 202a  als, tangents, *
-00012a30: 2c20 6675 6e63 7469 6f6e 5f74 7261 6365  , function_trace
-00012a40: 3a20 5472 6163 652c 202a 2a6b 7761 7267  : Trace, **kwarg
-00012a50: 7329 3a0a 2020 2020 2222 224d 6574 6166  s):.    """Metaf
-00012a60: 756e 6374 696f 6e20 666f 7220 7468 6520  unction for the 
-00012a70: 4a56 5020 7472 616e 7366 6f72 6d2e 0a0a  JVP transform...
-00012a80: 2020 2020 4172 6773 3a0a 2020 2020 2020      Args:.      
-00012a90: 2020 6465 7461 6368 6564 2028 626f 6f6c    detached (bool
-00012aa0: 293a 2057 6865 7468 6572 2074 6f20 6465  ): Whether to de
-00012ab0: 7461 6368 2074 6865 2074 7261 6365 2e0a  tach the trace..
-00012ac0: 2020 2020 2020 2020 7072 696d 616c 7320          primals 
-00012ad0: 2854 7570 6c65 5b50 726f 7879 5d29 3a20  (Tuple[Proxy]): 
-00012ae0: 5072 696d 616c 2076 616c 7565 732e 0a20  Primal values.. 
-00012af0: 2020 2020 2020 2074 616e 6765 6e74 7320         tangents 
-00012b00: 2854 7570 6c65 5b50 726f 7879 5d29 3a20  (Tuple[Proxy]): 
-00012b10: 5461 6e67 656e 7420 7661 6c75 6573 2e0a  Tangent values..
-00012b20: 2020 2020 2020 2020 6675 6e63 7469 6f6e          function
-00012b30: 5f74 7261 6365 2028 5472 6163 6529 3a20  _trace (Trace): 
-00012b40: 5472 6163 6520 6f66 2074 6865 2066 756e  Trace of the fun
-00012b50: 6374 696f 6e20 746f 2062 6520 7472 616e  ction to be tran
-00012b60: 7366 6f72 6d65 642e 0a20 2020 2020 2020  sformed..       
-00012b70: 206b 7761 7267 733a 204b 6579 776f 7264   kwargs: Keyword
-00012b80: 2061 7267 756d 656e 7473 2e0a 0a20 2020   arguments...   
-00012b90: 2052 6169 7365 733a 0a20 2020 2020 2020   Raises:.       
-00012ba0: 2041 7373 6572 7469 6f6e 4572 726f 723a   AssertionError:
-00012bb0: 2049 6620 7468 6520 4a56 5020 666f 7220   If the JVP for 
-00012bc0: 6b65 7977 6f72 6420 6172 6775 6d65 6e74  keyword argument
-00012bd0: 7320 6973 206e 6f74 2069 6d70 6c65 6d65  s is not impleme
-00012be0: 6e74 6564 2e0a 0a20 2020 2052 6574 7572  nted...    Retur
-00012bf0: 6e73 3a0a 2020 2020 2020 2020 5265 7375  ns:.        Resu
-00012c00: 6c74 206f 6620 7468 6520 4a56 5020 7472  lt of the JVP tr
-00012c10: 616e 7366 6f72 6d2e 0a20 2020 2022 2222  ansform..    """
-00012c20: 0a20 2020 2061 7373 6572 7420 6c65 6e28  .    assert len(
-00012c30: 6b77 6172 6773 2920 3d3d 2030 2c20 224a  kwargs) == 0, "J
-00012c40: 5650 2066 6f72 206b 7761 7267 7320 6973  VP for kwargs is
-00012c50: 206e 6f74 2069 6d70 6c65 6d65 6e74 6564   not implemented
-00012c60: 220a 0a20 2020 2063 7478 203d 2064 6574  "..    ctx = det
-00012c70: 6163 6865 645f 7472 6163 6528 2920 6966  ached_trace() if
-00012c80: 2064 6574 6163 6865 6420 656c 7365 206e   detached else n
-00012c90: 756c 6c63 6f6e 7465 7874 2829 0a20 2020  ullcontext().   
-00012ca0: 2077 6974 6820 6374 783a 0a20 2020 2020   with ctx:.     
-00012cb0: 2020 2023 2057 7261 7070 696e 6720 7468     # Wrapping th
-00012cc0: 6520 7072 696d 616c 7320 616e 6420 7461  e primals and ta
-00012cd0: 6e67 656e 7473 2069 6e20 4a56 5044 7561  ngents in JVPDua
-00012ce0: 6c73 2069 7320 6e6f 7420 7374 7269 6374  ls is not strict
-00012cf0: 6c79 206e 6563 6573 7361 7279 2c20 6275  ly necessary, bu
-00012d00: 7420 6974 206d 616b 6573 0a20 2020 2020  t it makes.     
-00012d10: 2020 2023 2074 6865 2063 6f64 6520 6d6f     # the code mo
-00012d20: 7265 2072 6561 6461 626c 650a 2020 2020  re readable.    
-00012d30: 2020 2020 2320 5765 2070 726f 7061 6761      # We propaga
-00012d40: 7465 2074 6865 204a 5650 4475 616c 7320  te the JVPDuals 
-00012d50: 7468 726f 7567 6820 7468 6520 7472 6163  through the trac
-00012d60: 652c 2061 6e64 2074 6865 6e20 756e 7772  e, and then unwr
-00012d70: 6170 2074 6865 6d20 6174 2074 6865 2065  ap them at the e
-00012d80: 6e64 0a20 2020 2020 2020 2070 7269 6d61  nd.        prima
-00012d90: 6c73 5f74 616e 6765 6e74 735f 6475 616c  ls_tangents_dual
-00012da0: 7320 3d20 7361 6665 5f6d 6170 2870 6169  s = safe_map(pai
-00012db0: 725f 746f 5f6a 7670 5f64 7561 6c2c 2073  r_to_jvp_dual, s
-00012dc0: 6166 655f 7a69 7028 7072 696d 616c 732c  afe_zip(primals,
-00012dd0: 2074 616e 6765 6e74 7329 290a 2020 2020   tangents)).    
-00012de0: 2020 2020 7265 7375 6c74 203d 2065 7661      result = eva
-00012df0: 6c5f 7472 6163 6528 6675 6e63 7469 6f6e  l_trace(function
-00012e00: 5f74 7261 6365 2c20 2a70 7269 6d61 6c73  _trace, *primals
-00012e10: 5f74 616e 6765 6e74 735f 6475 616c 732c  _tangents_duals,
-00012e20: 2073 796d 626f 6c5f 6d61 7070 6572 3d6a   symbol_mapper=j
-00012e30: 7670 5f73 796d 626f 6c5f 6d61 7070 6572  vp_symbol_mapper
-00012e40: 290a 2020 2020 2020 2020 2320 556e 7772  ).        # Unwr
-00012e50: 6170 7069 6e67 2074 6865 204a 5650 4475  apping the JVPDu
-00012e60: 616c 730a 2020 2020 2020 2020 6966 2069  als.        if i
-00012e70: 7369 6e73 7461 6e63 6528 7265 7375 6c74  sinstance(result
-00012e80: 2c20 5365 7175 656e 6365 293a 0a20 2020  , Sequence):.   
-00012e90: 2020 2020 2020 2020 2061 7373 6572 7420           assert 
-00012ea0: 616c 6c28 6973 696e 7374 616e 6365 2878  all(isinstance(x
-00012eb0: 2c20 4a56 5044 7561 6c29 2066 6f72 2078  , JVPDual) for x
-00012ec0: 2069 6e20 7265 7375 6c74 290a 2020 2020   in result).    
-00012ed0: 2020 2020 2020 2020 7072 696d 616c 732c          primals,
-00012ee0: 2074 616e 6765 6e74 7320 3d20 756e 7a69   tangents = unzi
-00012ef0: 7032 2872 6573 756c 7429 0a20 2020 2020  p2(result).     
-00012f00: 2020 2020 2020 2072 6574 7572 6e20 7072         return pr
-00012f10: 696d 616c 732c 2074 616e 6765 6e74 730a  imals, tangents.
-00012f20: 2020 2020 2020 2020 6173 7365 7274 2069          assert i
-00012f30: 7369 6e73 7461 6e63 6528 7265 7375 6c74  sinstance(result
-00012f40: 2c20 4a56 5044 7561 6c29 0a20 2020 2020  , JVPDual).     
-00012f50: 2020 2072 6574 7572 6e20 7265 7375 6c74     return result
-00012f60: 2e70 7269 6d61 6c2c 2072 6573 756c 742e  .primal, result.
-00012f70: 7461 6e67 656e 740a 0a0a 6a76 705f 6361  tangent...jvp_ca
-00012f80: 6c6c 203d 2053 796d 626f 6c28 6964 3d54  ll = Symbol(id=T
-00012f90: 7261 6e73 666f 726d 732e 4a76 704f 702c  ransforms.JvpOp,
-00012fa0: 206e 616d 653d 226a 7670 5f63 616c 6c22   name="jvp_call"
-00012fb0: 2c20 6d65 7461 3d70 6172 7469 616c 285f  , meta=partial(_
-00012fc0: 6a76 705f 6361 6c6c 5f6d 6574 6166 756e  jvp_call_metafun
-00012fd0: 632c 2046 616c 7365 2929 0a0a 0a64 6566  c, False))...def
-00012fe0: 205f 6964 656e 7469 7479 5f63 616c 6c5f   _identity_call_
-00012ff0: 6a76 7028 2a61 7267 733a 204a 5650 4475  jvp(*args: JVPDu
-00013000: 616c 2c20 7472 6163 653a 2054 7261 6365  al, trace: Trace
-00013010: 2c20 2a2a 6b77 6172 6773 293a 0a20 2020  , **kwargs):.   
-00013020: 2070 7269 6d61 6c73 2c20 7461 6e67 656e   primals, tangen
-00013030: 7473 203d 2075 6e7a 6970 3228 6172 6773  ts = unzip2(args
-00013040: 290a 2020 2020 6f75 745f 7072 696d 616c  ).    out_primal
-00013050: 732c 206f 7574 5f74 616e 6765 6e74 7320  s, out_tangents 
-00013060: 3d20 5f6a 7670 5f63 616c 6c5f 6d65 7461  = _jvp_call_meta
-00013070: 6675 6e63 2846 616c 7365 2c20 7072 696d  func(False, prim
-00013080: 616c 732c 2074 616e 6765 6e74 732c 2074  als, tangents, t
-00013090: 7261 6365 2c20 2a2a 6b77 6172 6773 290a  race, **kwargs).
-000130a0: 2020 2020 6966 2069 7369 6e73 7461 6e63      if isinstanc
-000130b0: 6528 6f75 745f 7072 696d 616c 732c 2053  e(out_primals, S
-000130c0: 6571 7565 6e63 6529 3a0a 2020 2020 2020  equence):.      
-000130d0: 2020 7265 7475 726e 2073 6166 655f 6d61    return safe_ma
-000130e0: 7028 7061 6972 5f74 6f5f 6a76 705f 6475  p(pair_to_jvp_du
-000130f0: 616c 2c20 7361 6665 5f7a 6970 286f 7574  al, safe_zip(out
-00013100: 5f70 7269 6d61 6c73 2c20 6f75 745f 7461  _primals, out_ta
-00013110: 6e67 656e 7473 2929 0a20 2020 2072 6574  ngents)).    ret
-00013120: 7572 6e20 4a56 5044 7561 6c28 6f75 745f  urn JVPDual(out_
-00013130: 7072 696d 616c 732c 206f 7574 5f74 616e  primals, out_tan
-00013140: 6765 6e74 7329 0a0a 0a6a 7670 5f69 6d70  gents)...jvp_imp
-00013150: 6c73 5b54 7261 6e73 666f 726d 732e 4964  ls[Transforms.Id
-00013160: 656e 7469 7479 4f70 5d20 3d20 5f69 6465  entityOp] = _ide
-00013170: 6e74 6974 795f 6361 6c6c 5f6a 7670 0a0a  ntity_call_jvp..
-00013180: 0a64 6566 205f 766d 6170 5f63 616c 6c5f  .def _vmap_call_
-00013190: 6a76 7028 6172 6773 3a20 4a56 5044 7561  jvp(args: JVPDua
-000131a0: 6c2c 2069 6e5f 6469 6d73 2c20 6f75 745f  l, in_dims, out_
-000131b0: 6469 6d73 2c20 6178 6973 5f73 697a 652c  dims, axis_size,
-000131c0: 2074 7261 6365 3a20 5472 6163 652c 202a   trace: Trace, *
-000131d0: 2a6b 7761 7267 7329 3a0a 2020 2020 7072  *kwargs):.    pr
-000131e0: 696d 616c 732c 2074 616e 6765 6e74 7320  imals, tangents 
-000131f0: 3d20 7361 6665 5f7a 6970 282a 6172 6773  = safe_zip(*args
-00013200: 290a 2020 2020 696e 5f64 696d 732c 205f  ).    in_dims, _
-00013210: 203d 2073 6166 655f 7a69 7028 2a69 6e5f   = safe_zip(*in_
-00013220: 6469 6d73 290a 2020 2020 6f75 745f 6469  dims).    out_di
-00013230: 6d73 2c20 5f20 3d20 7361 6665 5f7a 6970  ms, _ = safe_zip
-00013240: 282a 6f75 745f 6469 6d73 290a 2020 2020  (*out_dims).    
-00013250: 766d 6170 7065 645f 7472 6163 6520 3d20  vmapped_trace = 
-00013260: 636f 6e73 7472 7563 745f 7472 6163 6528  construct_trace(
-00013270: 2928 0a20 2020 2020 2020 2076 6d61 7028  )(.        vmap(
-00013280: 7061 7274 6961 6c28 6576 616c 5f74 7261  partial(eval_tra
-00013290: 6365 2c20 7472 6163 6529 2c20 696e 5f64  ce, trace), in_d
-000132a0: 696d 733d 696e 5f64 696d 732c 206f 7574  ims=in_dims, out
-000132b0: 5f64 696d 733d 6f75 745f 6469 6d73 2c20  _dims=out_dims, 
-000132c0: 6178 6973 5f73 697a 653d 6178 6973 5f73  axis_size=axis_s
-000132d0: 697a 6529 2c20 2a70 7269 6d61 6c73 0a20  ize), *primals. 
-000132e0: 2020 2029 0a20 2020 2076 6d61 7070 6564     ).    vmapped
-000132f0: 5f66 756e 6320 3d20 7061 7274 6961 6c28  _func = partial(
-00013300: 6576 616c 5f74 7261 6365 2c20 766d 6170  eval_trace, vmap
-00013310: 7065 645f 7472 6163 6529 0a20 2020 206f  ped_trace).    o
-00013320: 7574 5f70 7269 6d61 6c73 2c20 6f75 745f  ut_primals, out_
-00013330: 7461 6e67 656e 7473 203d 206a 7670 2876  tangents = jvp(v
-00013340: 6d61 7070 6564 5f66 756e 6329 2870 7269  mapped_func)(pri
-00013350: 6d61 6c73 2c20 7461 6e67 656e 7473 2c20  mals, tangents, 
-00013360: 2a2a 6b77 6172 6773 290a 2020 2020 6966  **kwargs).    if
-00013370: 2069 7369 6e73 7461 6e63 6528 6f75 745f   isinstance(out_
-00013380: 7072 696d 616c 732c 2053 6571 7565 6e63  primals, Sequenc
-00013390: 6529 3a0a 2020 2020 2020 2020 7265 7475  e):.        retu
-000133a0: 726e 2073 6166 655f 6d61 7028 7061 6972  rn safe_map(pair
-000133b0: 5f74 6f5f 6a76 705f 6475 616c 2c20 7361  _to_jvp_dual, sa
-000133c0: 6665 5f7a 6970 286f 7574 5f70 7269 6d61  fe_zip(out_prima
-000133d0: 6c73 2c20 6f75 745f 7461 6e67 656e 7473  ls, out_tangents
-000133e0: 2929 0a20 2020 2072 6574 7572 6e20 4a56  )).    return JV
-000133f0: 5044 7561 6c28 6f75 745f 7072 696d 616c  PDual(out_primal
-00013400: 732c 206f 7574 5f74 616e 6765 6e74 7329  s, out_tangents)
-00013410: 0a0a 0a6a 7670 5f69 6d70 6c73 5b54 7261  ...jvp_impls[Tra
-00013420: 6e73 666f 726d 732e 566d 6170 4f70 5d20  nsforms.VmapOp] 
-00013430: 3d20 5f76 6d61 705f 6361 6c6c 5f6a 7670  = _vmap_call_jvp
-00013440: 0a0a 0a64 6566 206a 7670 2866 756e 6329  ...def jvp(func)
-00013450: 3a0a 2020 2020 2222 224a 6163 6f62 6961  :.    """Jacobia
-00013460: 6e2d 7665 6374 6f72 2070 726f 6475 6374  n-vector product
-00013470: 2074 7261 6e73 666f 726d 2066 6f72 2061   transform for a
-00013480: 2054 6875 6e64 6572 2066 756e 6374 696f   Thunder functio
-00013490: 6e2e 0a0a 2020 2020 4172 6773 3a0a 2020  n...    Args:.  
-000134a0: 2020 2020 2020 6675 6e63 2028 4361 6c6c        func (Call
-000134b0: 6162 6c65 293a 2041 2054 6875 6e64 6572  able): A Thunder
-000134c0: 2066 756e 6374 696f 6e20 746f 2062 6520   function to be 
-000134d0: 7472 616e 7366 6f72 6d65 642e 0a0a 2020  transformed...  
-000134e0: 2020 5265 7475 726e 733a 0a20 2020 2020    Returns:.     
-000134f0: 2020 2043 616c 6c61 626c 653a 2041 2066     Callable: A f
-00013500: 756e 6374 696f 6e20 7468 6174 2063 6f6d  unction that com
-00013510: 7075 7465 7320 7468 6520 4a61 636f 6269  putes the Jacobi
-00013520: 616e 2d76 6563 746f 7220 7072 6f64 7563  an-vector produc
-00013530: 740a 2020 2020 2020 2020 2020 2020 7461  t.            ta
-00013540: 6b69 6e67 2070 7269 6d61 6c73 2061 6e64  king primals and
-00013550: 2074 616e 6765 6e74 7320 6173 2061 7267   tangents as arg
-00013560: 756d 656e 7473 2e0a 2020 2020 2222 220a  uments..    """.
-00013570: 0a20 2020 2064 6566 2077 7261 7070 6572  .    def wrapper
-00013580: 2870 7269 6d61 6c73 2c20 7461 6e67 656e  (primals, tangen
-00013590: 7473 293a 0a20 2020 2020 2020 2074 7261  ts):.        tra
-000135a0: 6365 203d 2063 6f6e 7374 7275 6374 5f74  ce = construct_t
-000135b0: 7261 6365 2829 2866 756e 632c 202a 7072  race()(func, *pr
-000135c0: 696d 616c 7329 0a20 2020 2020 2020 2072  imals).        r
-000135d0: 6574 7572 6e20 6a76 705f 6361 6c6c 2870  eturn jvp_call(p
-000135e0: 7269 6d61 6c73 2c20 7461 6e67 656e 7473  rimals, tangents
-000135f0: 2c20 6675 6e63 7469 6f6e 5f74 7261 6365  , function_trace
-00013600: 3d74 7261 6365 290a 0a20 2020 2072 6574  =trace)..    ret
-00013610: 7572 6e20 7772 6170 7065 720a 0a0a 2320  urn wrapper...# 
-00013620: 544f 444f 2054 6869 7320 6675 6e63 7469  TODO This functi
-00013630: 6f6e 2063 6f6d 6d65 6e74 6564 206f 7574  on commented out
-00013640: 2062 6563 6175 7365 2069 7420 6361 6c6c   because it call
-00013650: 7320 6d61 6b65 5f74 7261 6365 642c 2077  s make_traced, w
-00013660: 6869 6368 2064 6f65 7320 6e6f 7420 6578  hich does not ex
-00013670: 6973 740a 2320 6465 6620 6a76 705f 6561  ist.# def jvp_ea
-00013680: 6765 7228 6675 6e63 2c20 7072 696d 616c  ger(func, primal
-00013690: 732c 2074 616e 6765 6e74 732c 2065 7865  s, tangents, exe
-000136a0: 6375 746f 723d 2274 6f72 6368 2229 3a0a  cutor="torch"):.
-000136b0: 2320 2020 2020 2222 2243 6f6d 7075 7465  #     """Compute
-000136c0: 7320 7468 6520 4a61 636f 6269 616e 2d76  s the Jacobian-v
-000136d0: 6563 746f 7220 7072 6f64 7563 7420 6f66  ector product of
-000136e0: 2061 2054 6875 6e64 6572 2066 756e 6374   a Thunder funct
-000136f0: 696f 6e2e 0a0a 2320 2020 2020 4172 6773  ion...#     Args
-00013700: 3a0a 2320 2020 2020 2020 2020 6675 6e63  :.#         func
-00013710: 2028 4361 6c6c 6162 6c65 293a 2041 2054   (Callable): A T
-00013720: 6875 6e64 6572 2066 756e 6374 696f 6e20  hunder function 
-00013730: 746f 2062 6520 7472 616e 7366 6f72 6d65  to be transforme
-00013740: 642e 0a23 2020 2020 2020 2020 2070 7269  d..#         pri
-00013750: 6d61 6c73 2028 5f74 7970 655f 293a 2050  mals (_type_): P
-00013760: 7269 6d61 6c73 206f 6620 7468 6520 6675  rimals of the fu
-00013770: 6e63 7469 6f6e 2e0a 2320 2020 2020 2020  nction..#       
-00013780: 2020 7461 6e67 656e 7473 2028 5f74 7970    tangents (_typ
-00013790: 655f 293a 2054 616e 6765 6e74 7320 6f66  e_): Tangents of
-000137a0: 2074 6865 2066 756e 6374 696f 6e2e 0a23   the function..#
-000137b0: 2020 2020 2020 2020 2065 7865 6375 746f           executo
-000137c0: 7220 2873 7472 2c20 6f70 7469 6f6e 616c  r (str, optional
-000137d0: 293a 2045 7865 6375 746f 7220 746f 2075  ): Executor to u
-000137e0: 7365 2e20 4465 6661 756c 7473 2074 6f20  se. Defaults to 
-000137f0: 2274 6f72 6368 222e 0a0a 2320 2020 2020  "torch"...#     
-00013800: 5265 7475 726e 733a 0a23 2020 2020 2020  Returns:.#      
-00013810: 2020 2054 6865 2072 6573 756c 7420 6f66     The result of
-00013820: 2074 6865 204a 6163 6f62 6961 6e2d 7665   the Jacobian-ve
-00013830: 6374 6f72 2070 726f 6475 6374 2e0a 2320  ctor product..# 
-00013840: 2020 2020 2222 220a 2320 2020 2020 7472      """.#     tr
-00013850: 6163 6520 3d20 6d61 6b65 5f74 7261 6365  ace = make_trace
-00013860: 2866 756e 632c 2065 7865 6375 746f 723d  (func, executor=
-00013870: 6578 6563 7574 6f72 2c20 2a70 7269 6d61  executor, *prima
-00013880: 6c73 290a 0a23 2020 2020 2064 6566 206a  ls)..#     def j
-00013890: 7670 5f66 756e 6328 2a70 7269 6d61 6c73  vp_func(*primals
-000138a0: 5f61 6e64 5f74 616e 6765 6e74 7329 3a0a  _and_tangents):.
-000138b0: 2320 2020 2020 2020 2020 5f70 7269 6d61  #         _prima
-000138c0: 6c73 2c20 5f74 616e 6765 6e74 7320 3d20  ls, _tangents = 
-000138d0: 7072 696d 616c 735f 616e 645f 7461 6e67  primals_and_tang
-000138e0: 656e 7473 5b3a 206c 656e 2870 7269 6d61  ents[: len(prima
-000138f0: 6c73 295d 2c20 7072 696d 616c 735f 616e  ls)], primals_an
-00013900: 645f 7461 6e67 656e 7473 5b6c 656e 2870  d_tangents[len(p
-00013910: 7269 6d61 6c73 2920 3a5d 0a23 2020 2020  rimals) :].#    
-00013920: 2020 2020 2072 6574 7572 6e20 5f6a 7670       return _jvp
-00013930: 5f63 616c 6c5f 6d65 7461 6675 6e63 285f  _call_metafunc(_
-00013940: 7072 696d 616c 732c 205f 7461 6e67 656e  primals, _tangen
-00013950: 7473 2c20 7472 6163 652c 2064 6574 6163  ts, trace, detac
-00013960: 6865 643d 4661 6c73 6529 0a0a 2320 2020  hed=False)..#   
-00013970: 2020 6a76 705f 7472 6163 6520 3d20 6d61    jvp_trace = ma
-00013980: 6b65 5f74 7261 6365 286a 7670 5f66 756e  ke_trace(jvp_fun
-00013990: 632c 2065 7865 6375 746f 723d 6578 6563  c, executor=exec
-000139a0: 7574 6f72 2928 2a70 7269 6d61 6c73 2c20  utor)(*primals, 
-000139b0: 2a74 616e 6765 6e74 7329 0a23 2020 2020  *tangents).#    
-000139c0: 206a 7670 5f74 7261 6365 6420 3d20 6d61   jvp_traced = ma
-000139d0: 6b65 5f74 7261 6365 6428 7061 7274 6961  ke_traced(partia
-000139e0: 6c28 6576 616c 5f74 7261 6365 2c20 6a76  l(eval_trace, jv
-000139f0: 705f 7472 6163 6529 2c20 6578 6563 7574  p_trace), execut
-00013a00: 6f72 3d65 7865 6375 746f 7229 0a23 2020  or=executor).#  
-00013a10: 2020 2072 6574 7572 6e20 6a76 705f 7472     return jvp_tr
-00013a20: 6163 6564 282a 7072 696d 616c 732c 202a  aced(*primals, *
-00013a30: 7461 6e67 656e 7473 290a 0a0a 2320 564a  tangents)...# VJ
-00013a40: 5020 7472 616e 7366 6f72 6d0a 2320 3d3d  P transform.# ==
-00013a50: 3d3d 3d3d 3d3d 3d3d 3d3d 3d0a 4064 6174  ===========.@dat
-00013a60: 6163 6c61 7373 2866 726f 7a65 6e3d 5472  aclass(frozen=Tr
-00013a70: 7565 290a 636c 6173 7320 564a 5044 7561  ue).class VJPDua
-00013a80: 6c3a 0a20 2020 2022 2222 4120 7061 6972  l:.    """A pair
-00013a90: 206f 6620 7072 696d 616c 2061 6e64 2073   of primal and s
-00013aa0: 6176 6564 2069 6e66 6f72 6d61 7469 6f6e  aved information
-00013ab0: 2066 6f72 2062 6163 6b77 6172 6420 2872   for backward (r
-00013ac0: 6573 6964 7561 6c73 292e 0a0a 2020 2020  esiduals)...    
-00013ad0: 4172 6773 3a0a 2020 2020 2020 2020 7072  Args:.        pr
-00013ae0: 696d 616c 2028 556e 696f 6e5b 5072 6f78  imal (Union[Prox
-00013af0: 792c 204e 756d 6265 725d 293a 2050 7269  y, Number]): Pri
-00013b00: 6d61 6c20 7661 6c75 652c 2069 2e65 2e2c  mal value, i.e.,
-00013b10: 2074 6865 2076 616c 7565 2062 6569 6e67   the value being
-00013b20: 2064 6966 6665 7265 6e74 6961 7465 642e   differentiated.
-00013b30: 0a20 2020 2020 2020 2072 6573 6964 7561  .        residua
-00013b40: 6c73 2028 5475 706c 655b 5072 6f78 792c  ls (Tuple[Proxy,
-00013b50: 202e 2e2e 5d29 3a20 5265 7369 6475 616c   ...]): Residual
-00013b60: 732c 2069 2e65 2e2c 2074 6865 2076 616c  s, i.e., the val
-00013b70: 7565 7320 7468 6174 2061 7265 0a20 2020  ues that are.   
-00013b80: 2020 2020 2020 2020 2073 6176 6564 2066           saved f
-00013b90: 6f72 2074 6865 2062 6163 6b77 6172 642e  or the backward.
-00013ba0: 0a0a 2020 2020 5969 656c 6473 3a0a 2020  ..    Yields:.  
-00013bb0: 2020 2020 2020 5475 706c 655b 5661 7269        Tuple[Vari
-00013bc0: 6162 6c65 2c20 5475 706c 655b 5661 7269  able, Tuple[Vari
-00013bd0: 6162 6c65 2c20 2e2e 2e5d 2c20 4361 6c6c  able, ...], Call
-00013be0: 6162 6c65 5d3a 2050 7269 6d61 6c20 616e  able]: Primal an
-00013bf0: 6420 7265 7369 6475 616c 730a 2020 2020  d residuals.    
-00013c00: 2222 220a 0a20 2020 2070 7269 6d61 6c3a  """..    primal:
-00013c10: 2050 726f 7879 207c 204e 756d 6265 720a   Proxy | Number.
-00013c20: 2020 2020 7265 7369 6475 616c 733a 2074      residuals: t
-00013c30: 7570 6c65 5b50 726f 7879 2c20 2e2e 2e5d  uple[Proxy, ...]
-00013c40: 0a0a 2020 2020 6465 6620 5f5f 6974 6572  ..    def __iter
-00013c50: 5f5f 2873 656c 6629 3a0a 2020 2020 2020  __(self):.      
-00013c60: 2020 7969 656c 6420 7365 6c66 2e70 7269    yield self.pri
-00013c70: 6d61 6c0a 2020 2020 2020 2020 7969 656c  mal.        yiel
-00013c80: 6420 7365 6c66 2e72 6573 6964 7561 6c73  d self.residuals
-00013c90: 0a0a 0a63 6c61 7373 204e 6f50 756c 6c62  ...class NoPullb
-00013ca0: 6163 6b3a 0a20 2020 2022 2222 4120 6475  ack:.    """A du
-00013cb0: 6d6d 7920 7075 6c6c 6261 636b 2066 756e  mmy pullback fun
-00013cc0: 6374 696f 6e20 7468 6174 2072 6574 7572  ction that retur
-00013cd0: 6e73 204e 6f6e 6520 6f72 2072 6169 7365  ns None or raise
-00013ce0: 7320 616e 2065 7272 6f72 2e22 2222 0a0a  s an error."""..
-00013cf0: 2020 2020 6465 6620 5f5f 696e 6974 5f5f      def __init__
-00013d00: 2873 656c 662c 206e 756d 5f61 7267 733d  (self, num_args=
-00013d10: 3029 3a0a 2020 2020 2020 2020 7365 6c66  0):.        self
-00013d20: 2e6e 756d 5f61 7267 7320 3d20 6e75 6d5f  .num_args = num_
-00013d30: 6172 6773 0a0a 2020 2020 6465 6620 5f5f  args..    def __
-00013d40: 6361 6c6c 5f5f 2873 656c 662c 202a 6172  call__(self, *ar
-00013d50: 6773 2c20 2a2a 6b77 6172 6773 293a 0a20  gs, **kwargs):. 
-00013d60: 2020 2020 2020 2069 6620 7365 6c66 2e6e         if self.n
-00013d70: 756d 5f61 7267 7320 3e20 303a 0a20 2020  um_args > 0:.   
-00013d80: 2020 2020 2020 2020 2072 6574 7572 6e20           return 
-00013d90: 284e 6f6e 652c 2920 2a20 7365 6c66 2e6e  (None,) * self.n
-00013da0: 756d 5f61 7267 730a 2020 2020 2020 2020  um_args.        
-00013db0: 7261 6973 6520 5275 6e74 696d 6545 7272  raise RuntimeErr
-00013dc0: 6f72 2822 5075 6c6c 6261 636b 2063 616c  or("Pullback cal
-00013dd0: 6c65 6420 6f6e 2061 206e 6f6e 2d64 6966  led on a non-dif
-00013de0: 6665 7265 6e74 6961 626c 6520 7379 6d62  ferentiable symb
-00013df0: 6f6c 206f 7220 6120 636f 6e73 7461 6e74  ol or a constant
-00013e00: 2e22 290a 0a0a 636c 6173 7320 5a65 726f  .")...class Zero
-00013e10: 4261 636b 7761 7264 3a0a 2020 2020 2222  Backward:.    ""
-00013e20: 2241 2068 656c 7065 7220 6261 636b 7761  "A helper backwa
-00013e30: 7264 2066 756e 6374 696f 6e20 7468 6174  rd function that
-00013e40: 2072 6574 7572 6e73 207a 6572 6f73 2e22   returns zeros."
-00013e50: 2222 0a0a 2020 2020 6465 6620 5f5f 696e  ""..    def __in
-00013e60: 6974 5f5f 2873 656c 662c 206e 756d 5f61  it__(self, num_a
-00013e70: 7267 7329 3a0a 2020 2020 2020 2020 7365  rgs):.        se
-00013e80: 6c66 2e6e 756d 5f61 7267 7320 3d20 6e75  lf.num_args = nu
-00013e90: 6d5f 6172 6773 0a0a 2020 2020 6465 6620  m_args..    def 
-00013ea0: 5f5f 6361 6c6c 5f5f 2873 656c 662c 202a  __call__(self, *
-00013eb0: 6172 6773 2c20 2a2a 6b77 6172 6773 293a  args, **kwargs):
-00013ec0: 0a20 2020 2020 2020 2023 2041 7373 756d  .        # Assum
-00013ed0: 696e 6720 7468 6174 2074 6865 2066 6972  ing that the fir
-00013ee0: 7374 2061 7267 756d 656e 7473 2061 7265  st arguments are
-00013ef0: 2074 6865 2066 6f72 7761 7264 2061 7267   the forward arg
-00013f00: 756d 656e 7473 0a20 2020 2020 2020 2066  uments.        f
-00013f10: 6f72 7761 7264 5f61 7267 7320 3d20 6172  orward_args = ar
-00013f20: 6773 5b3a 2073 656c 662e 6e75 6d5f 6172  gs[: self.num_ar
-00013f30: 6773 5d0a 0a20 2020 2020 2020 2064 6566  gs]..        def
-00013f40: 207a 6572 6f73 5f6c 696b 6528 7829 3a0a   zeros_like(x):.
-00013f50: 2020 2020 2020 2020 2020 2020 6966 2069              if i
-00013f60: 7369 6e73 7461 6e63 6528 782c 2054 656e  sinstance(x, Ten
-00013f70: 736f 7250 726f 7879 293a 0a20 2020 2020  sorProxy):.     
-00013f80: 2020 2020 2020 2020 2020 2072 6574 7572             retur
-00013f90: 6e20 6675 6c6c 5f6c 696b 6528 782c 2066  n full_like(x, f
-00013fa0: 696c 6c5f 7661 6c75 653d 3029 0a20 2020  ill_value=0).   
-00013fb0: 2020 2020 2020 2020 2065 6c69 6620 6973           elif is
-00013fc0: 696e 7374 616e 6365 2878 2c20 4e75 6d62  instance(x, Numb
-00013fd0: 6572 5072 6f78 7929 3a0a 2020 2020 2020  erProxy):.      
-00013fe0: 2020 2020 2020 2020 2020 7265 7475 726e            return
-00013ff0: 2074 7970 6528 782e 7661 6c75 6529 2830   type(x.value)(0
-00014000: 290a 2020 2020 2020 2020 2020 2020 656c  ).            el
-00014010: 6966 2069 7369 6e73 7461 6e63 6528 782c  if isinstance(x,
-00014020: 204e 756d 6265 7229 3a0a 2020 2020 2020   Number):.      
-00014030: 2020 2020 2020 2020 2020 7265 7475 726e            return
-00014040: 2074 7970 6528 7829 2830 290a 2020 2020   type(x)(0).    
-00014050: 2020 2020 2020 2020 656c 7365 3a0a 2020          else:.  
-00014060: 2020 2020 2020 2020 2020 2020 2020 7261                ra
-00014070: 6973 6520 5661 6c75 6545 7272 6f72 2866  ise ValueError(f
-00014080: 227a 6572 6f73 5f6c 696b 6520 696e 7369  "zeros_like insi
-00014090: 6465 205a 6572 6f42 6163 6b77 6172 6420  de ZeroBackward 
-000140a0: 676f 7420 616e 2075 6e73 7570 706f 7274  got an unsupport
-000140b0: 6564 2074 7970 6520 7b74 7970 6528 7829  ed type {type(x)
-000140c0: 7d22 290a 0a20 2020 2020 2020 2072 6574  }")..        ret
-000140d0: 7572 6e20 7475 706c 6528 7a65 726f 735f  urn tuple(zeros_
-000140e0: 6c69 6b65 2861 7267 2920 666f 7220 6172  like(arg) for ar
-000140f0: 6720 696e 2066 6f72 7761 7264 5f61 7267  g in forward_arg
-00014100: 7329 0a0a 0a23 204d 6170 7069 6e67 2066  s)...# Mapping f
-00014110: 726f 6d20 7379 6d62 6f6c 7320 746f 2061  rom symbols to a
-00014120: 7567 6d65 6e74 6564 2070 7269 6d61 6c20  ugmented primal 
-00014130: 2866 6f72 7761 7264 2920 6675 6e63 7469  (forward) functi
-00014140: 6f6e 7320 7573 6564 2069 6e20 564a 500a  ons used in VJP.
-00014150: 2320 5468 6520 6175 676d 656e 7465 645f  # The augmented_
-00014160: 7072 696d 616c 2066 756e 6374 696f 6e20  primal function 
-00014170: 7461 6b65 7320 7468 6520 7072 696d 616c  takes the primal
-00014180: 2076 616c 7565 7320 616e 6420 7265 7475   values and retu
-00014190: 726e 7320 7468 6520 7072 696d 616c 0a23  rns the primal.#
-000141a0: 2072 6573 756c 7420 616e 6420 7468 6520   result and the 
-000141b0: 7265 7369 6475 616c 7320 2873 6176 6564  residuals (saved
-000141c0: 2076 616c 7565 7320 666f 7220 7468 6520   values for the 
-000141d0: 6261 636b 7761 7264 292e 0a61 7567 6d65  backward)..augme
-000141e0: 6e74 6564 5f66 6f72 7761 7264 5f69 6d70  nted_forward_imp
-000141f0: 6c73 203d 207b 0a20 2020 2070 7269 6d73  ls = {.    prims
-00014200: 2e50 7269 6d49 4473 2e41 434f 533a 206c  .PrimIDs.ACOS: l
-00014210: 616d 6264 6120 783a 2028 7072 696d 732e  ambda x: (prims.
-00014220: 6163 6f73 2878 292c 2028 782c 2929 2c0a  acos(x), (x,)),.
-00014230: 2020 2020 7072 696d 732e 5072 696d 4944      prims.PrimID
-00014240: 732e 4143 4f53 483a 206c 616d 6264 6120  s.ACOSH: lambda 
-00014250: 783a 2028 7072 696d 732e 6163 6f73 6828  x: (prims.acosh(
-00014260: 7829 2c20 2878 2c29 292c 0a20 2020 2070  x), (x,)),.    p
-00014270: 7269 6d73 2e50 7269 6d49 4473 2e41 5349  rims.PrimIDs.ASI
-00014280: 4e3a 206c 616d 6264 6120 783a 2028 7072  N: lambda x: (pr
-00014290: 696d 732e 6173 696e 2878 292c 2028 782c  ims.asin(x), (x,
-000142a0: 2929 2c0a 2020 2020 7072 696d 732e 5072  )),.    prims.Pr
-000142b0: 696d 4944 732e 4153 494e 483a 206c 616d  imIDs.ASINH: lam
-000142c0: 6264 6120 783a 2028 7072 696d 732e 6173  bda x: (prims.as
-000142d0: 696e 6828 7829 2c20 2878 2c29 292c 0a20  inh(x), (x,)),. 
-000142e0: 2020 2070 7269 6d73 2e50 7269 6d49 4473     prims.PrimIDs
-000142f0: 2e41 5441 4e3a 206c 616d 6264 6120 783a  .ATAN: lambda x:
-00014300: 2028 7072 696d 732e 6174 616e 2878 292c   (prims.atan(x),
-00014310: 2028 782c 2929 2c0a 2020 2020 7072 696d   (x,)),.    prim
-00014320: 732e 5072 696d 4944 732e 4154 414e 483a  s.PrimIDs.ATANH:
-00014330: 206c 616d 6264 6120 783a 2028 7072 696d   lambda x: (prim
-00014340: 732e 6174 616e 6828 7829 2c20 2878 2c29  s.atanh(x), (x,)
-00014350: 292c 0a20 2020 2070 7269 6d73 2e50 7269  ),.    prims.Pri
-00014360: 6d49 4473 2e41 5441 4e32 3a20 6c61 6d62  mIDs.ATAN2: lamb
-00014370: 6461 2078 2c20 793a 2028 7072 696d 732e  da x, y: (prims.
-00014380: 6174 616e 3228 782c 2079 292c 2028 782c  atan2(x, y), (x,
-00014390: 2079 2929 2c0a 2020 2020 7072 696d 732e   y)),.    prims.
-000143a0: 5072 696d 4944 732e 434f 5348 3a20 6c61  PrimIDs.COSH: la
-000143b0: 6d62 6461 2078 3a20 2870 7269 6d73 2e63  mbda x: (prims.c
-000143c0: 6f73 6828 7829 2c20 2878 2c29 292c 0a20  osh(x), (x,)),. 
-000143d0: 2020 2070 7269 6d73 2e50 7269 6d49 4473     prims.PrimIDs
-000143e0: 2e44 4947 414d 4d41 3a20 6c61 6d62 6461  .DIGAMMA: lambda
-000143f0: 2078 3a20 2870 7269 6d73 2e64 6967 616d   x: (prims.digam
-00014400: 6d61 2878 292c 2028 782c 2929 2c0a 2020  ma(x), (x,)),.  
-00014410: 2020 7072 696d 732e 5072 696d 4944 732e    prims.PrimIDs.
-00014420: 4552 4643 3a20 6c61 6d62 6461 2078 3a20  ERFC: lambda x: 
-00014430: 2870 7269 6d73 2e65 7266 6328 7829 2c20  (prims.erfc(x), 
-00014440: 2878 2c29 292c 0a20 2020 2070 7269 6d73  (x,)),.    prims
-00014450: 2e50 7269 6d49 4473 2e45 5246 494e 563a  .PrimIDs.ERFINV:
-00014460: 206c 616d 6264 6120 783a 2028 7072 696d   lambda x: (prim
-00014470: 732e 6572 6669 6e76 2878 292c 2028 7072  s.erfinv(x), (pr
-00014480: 696d 732e 6572 6669 6e76 2878 292c 2929  ims.erfinv(x),))
-00014490: 2c0a 2020 2020 7072 696d 732e 5072 696d  ,.    prims.Prim
-000144a0: 4944 732e 4552 4643 494e 563a 206c 616d  IDs.ERFCINV: lam
-000144b0: 6264 6120 783a 2028 7072 696d 732e 6572  bda x: (prims.er
-000144c0: 6663 696e 7628 7829 2c20 2870 7269 6d73  fcinv(x), (prims
-000144d0: 2e65 7266 6369 6e76 2878 292c 2929 2c0a  .erfcinv(x),)),.
-000144e0: 2020 2020 7072 696d 732e 5072 696d 4944      prims.PrimID
-000144f0: 732e 4558 5032 3a20 6c61 6d62 6461 2078  s.EXP2: lambda x
-00014500: 3a20 2870 7269 6d73 2e65 7870 3228 7829  : (prims.exp2(x)
-00014510: 2c20 2870 7269 6d73 2e65 7870 3228 7829  , (prims.exp2(x)
-00014520: 2c29 292c 0a20 2020 2070 7269 6d73 2e50  ,)),.    prims.P
-00014530: 7269 6d49 4473 2e45 5850 4d31 3a20 6c61  rimIDs.EXPM1: la
-00014540: 6d62 6461 2078 3a20 2870 7269 6d73 2e65  mbda x: (prims.e
-00014550: 7870 6d31 2878 292c 2028 7072 696d 732e  xpm1(x), (prims.
-00014560: 6578 706d 3128 7829 2c29 292c 0a20 2020  expm1(x),)),.   
-00014570: 2070 7269 6d73 2e50 7269 6d49 4473 2e4c   prims.PrimIDs.L
-00014580: 4741 4d4d 413a 206c 616d 6264 6120 783a  GAMMA: lambda x:
-00014590: 2028 7072 696d 732e 6c67 616d 6d61 2878   (prims.lgamma(x
-000145a0: 292c 2028 782c 2929 2c0a 2020 2020 7072  ), (x,)),.    pr
-000145b0: 696d 732e 5072 696d 4944 732e 4e44 5452  ims.PrimIDs.NDTR
-000145c0: 493a 206c 616d 6264 6120 783a 2028 7072  I: lambda x: (pr
-000145d0: 696d 732e 6e64 7472 6928 7829 2c20 2870  ims.ndtri(x), (p
-000145e0: 7269 6d73 2e6e 6474 7269 2878 292c 2929  rims.ndtri(x),))
-000145f0: 2c0a 2020 2020 7072 696d 732e 5072 696d  ,.    prims.Prim
-00014600: 4944 732e 5349 4e48 3a20 6c61 6d62 6461  IDs.SINH: lambda
-00014610: 2078 3a20 2870 7269 6d73 2e73 696e 6828   x: (prims.sinh(
-00014620: 7829 2c20 2878 2c29 292c 0a20 2020 2070  x), (x,)),.    p
-00014630: 7269 6d73 2e50 7269 6d49 4473 2e53 5152  rims.PrimIDs.SQR
-00014640: 543a 206c 616d 6264 6120 783a 2028 7072  T: lambda x: (pr
-00014650: 696d 732e 7371 7274 2878 292c 2028 7072  ims.sqrt(x), (pr
-00014660: 696d 732e 7371 7274 2878 292c 2929 2c0a  ims.sqrt(x),)),.
-00014670: 2020 2020 7072 696d 732e 5072 696d 4944      prims.PrimID
-00014680: 732e 4e45 3a20 6c61 6d62 6461 2078 2c20  s.NE: lambda x, 
-00014690: 793a 2028 7072 696d 732e 6e65 2878 2c20  y: (prims.ne(x, 
-000146a0: 7929 2c20 2878 2c20 7929 292c 0a20 2020  y), (x, y)),.   
-000146b0: 2070 7269 6d73 2e50 7269 6d49 4473 2e47   prims.PrimIDs.G
-000146c0: 543a 206c 616d 6264 6120 782c 2079 3a20  T: lambda x, y: 
-000146d0: 2870 7269 6d73 2e67 7428 782c 2079 292c  (prims.gt(x, y),
-000146e0: 2028 782c 2079 2929 2c0a 2020 2020 7072   (x, y)),.    pr
-000146f0: 696d 732e 5072 696d 4944 732e 4c45 3a20  ims.PrimIDs.LE: 
-00014700: 6c61 6d62 6461 2078 2c20 793a 2028 7072  lambda x, y: (pr
-00014710: 696d 732e 6c65 2878 2c20 7929 2c20 2878  ims.le(x, y), (x
-00014720: 2c20 7929 292c 0a20 2020 2070 7269 6d73  , y)),.    prims
-00014730: 2e50 7269 6d49 4473 2e4c 4f47 3130 3a20  .PrimIDs.LOG10: 
-00014740: 6c61 6d62 6461 2078 3a20 2870 7269 6d73  lambda x: (prims
-00014750: 2e6c 6f67 3130 2878 292c 2028 782c 2929  .log10(x), (x,))
-00014760: 2c0a 2020 2020 7072 696d 732e 5072 696d  ,.    prims.Prim
-00014770: 4944 732e 4c4f 4731 503a 206c 616d 6264  IDs.LOG1P: lambd
-00014780: 6120 783a 2028 7072 696d 732e 6c6f 6731  a x: (prims.log1
-00014790: 7028 7829 2c20 2878 2c29 292c 0a20 2020  p(x), (x,)),.   
-000147a0: 2070 7269 6d73 2e50 7269 6d49 4473 2e4c   prims.PrimIDs.L
-000147b0: 4f47 323a 206c 616d 6264 6120 783a 2028  OG2: lambda x: (
-000147c0: 7072 696d 732e 6c6f 6732 2878 292c 2028  prims.log2(x), (
-000147d0: 782c 2929 2c0a 2020 2020 7072 696d 732e  x,)),.    prims.
-000147e0: 5072 696d 4944 732e 5a45 5441 3a20 6c61  PrimIDs.ZETA: la
-000147f0: 6d62 6461 2078 2c20 793a 2028 7072 696d  mbda x, y: (prim
-00014800: 732e 7a65 7461 2878 2c20 7929 2c20 2878  s.zeta(x, y), (x
-00014810: 2c20 7929 292c 0a20 2020 2070 7269 6d73  , y)),.    prims
-00014820: 2e50 7269 6d49 4473 2e46 4d4f 443a 206c  .PrimIDs.FMOD: l
-00014830: 616d 6264 6120 782c 2079 3a20 2870 7269  ambda x, y: (pri
-00014840: 6d73 2e66 6d6f 6428 782c 2079 292c 2028  ms.fmod(x, y), (
-00014850: 782c 2079 2929 2c0a 2020 2020 7072 696d  x, y)),.    prim
-00014860: 732e 5072 696d 4944 732e 434f 5059 5f3a  s.PrimIDs.COPY_:
-00014870: 206c 616d 6264 6120 782c 2079 3a20 2870   lambda x, y: (p
-00014880: 7269 6d73 2e63 6f70 795f 2878 2c20 7929  rims.copy_(x, y)
-00014890: 2c20 7475 706c 6528 2929 2c0a 7d0a 0a0a  , tuple()),.}...
-000148a0: 2320 4d61 7070 696e 6720 6672 6f6d 2073  # Mapping from s
-000148b0: 796d 626f 6c73 2074 6f20 6261 636b 7761  ymbols to backwa
-000148c0: 7264 2066 756e 6374 696f 6e73 2075 7365  rd functions use
-000148d0: 6420 696e 2056 4a50 0a23 2054 6865 2062  d in VJP.# The b
-000148e0: 6163 6b77 6172 6420 6675 6e63 7469 6f6e  ackward function
-000148f0: 2074 616b 6573 2074 6865 2072 6573 6964   takes the resid
-00014900: 7561 6c73 2061 6e64 2063 6f74 616e 6765  uals and cotange
-00014910: 6e74 7320 616e 6420 7265 7475 726e 7320  nts and returns 
-00014920: 7468 650a 2320 7665 6374 6f72 2d4a 6163  the.# vector-Jac
-00014930: 6f62 6961 6e20 7072 6f64 7563 7473 2066  obian products f
-00014940: 6f72 2065 6163 6820 6172 6775 6d65 6e74  or each argument
-00014950: 2e0a 6261 636b 7761 7264 5f69 6d70 6c73  ..backward_impls
-00014960: 203d 207b 0a20 2020 2070 7269 6d73 2e50   = {.    prims.P
-00014970: 7269 6d49 4473 2e41 434f 533a 206c 616d  rimIDs.ACOS: lam
-00014980: 6264 6120 782c 2067 3a20 2d67 202f 2070  bda x, g: -g / p
-00014990: 7269 6d73 2e73 7172 7428 312e 3020 2d20  rims.sqrt(1.0 - 
-000149a0: 7820 2a20 7829 2c0a 2020 2020 7072 696d  x * x),.    prim
-000149b0: 732e 5072 696d 4944 732e 4143 4f53 483a  s.PrimIDs.ACOSH:
-000149c0: 206c 616d 6264 6120 782c 2067 3a20 6720   lambda x, g: g 
-000149d0: 2a20 7072 696d 732e 7273 7172 7428 7820  * prims.rsqrt(x 
-000149e0: 2a20 7820 2d20 312e 3029 2c0a 2020 2020  * x - 1.0),.    
-000149f0: 7072 696d 732e 5072 696d 4944 732e 4153  prims.PrimIDs.AS
-00014a00: 494e 3a20 6c61 6d62 6461 2078 2c20 673a  IN: lambda x, g:
-00014a10: 2067 202f 2070 7269 6d73 2e73 7172 7428   g / prims.sqrt(
-00014a20: 312e 3020 2d20 7820 2a20 7829 2c0a 2020  1.0 - x * x),.  
-00014a30: 2020 7072 696d 732e 5072 696d 4944 732e    prims.PrimIDs.
-00014a40: 4153 494e 483a 206c 616d 6264 6120 782c  ASINH: lambda x,
-00014a50: 2067 3a20 6720 2a20 7072 696d 732e 7273   g: g * prims.rs
-00014a60: 7172 7428 312e 3020 2b20 7820 2a20 7829  qrt(1.0 + x * x)
-00014a70: 2c0a 2020 2020 7072 696d 732e 5072 696d  ,.    prims.Prim
-00014a80: 4944 732e 4154 414e 3a20 6c61 6d62 6461  IDs.ATAN: lambda
-00014a90: 2078 2c20 673a 2067 202f 2028 312e 3020   x, g: g / (1.0 
-00014aa0: 2b20 7820 2a20 7829 2c0a 2020 2020 7072  + x * x),.    pr
-00014ab0: 696d 732e 5072 696d 4944 732e 4154 414e  ims.PrimIDs.ATAN
-00014ac0: 483a 206c 616d 6264 6120 782c 2067 3a20  H: lambda x, g: 
-00014ad0: 6720 2f20 2831 2e30 202d 2078 202a 2078  g / (1.0 - x * x
-00014ae0: 292c 0a20 2020 2070 7269 6d73 2e50 7269  ),.    prims.Pri
-00014af0: 6d49 4473 2e43 4f53 483a 206c 616d 6264  mIDs.COSH: lambd
-00014b00: 6120 782c 2067 3a20 7072 696d 732e 6d75  a x, g: prims.mu
-00014b10: 6c28 672c 2070 7269 6d73 2e73 696e 6828  l(g, prims.sinh(
-00014b20: 7829 292c 0a20 2020 2070 7269 6d73 2e50  x)),.    prims.P
-00014b30: 7269 6d49 4473 2e45 5246 433a 206c 616d  rimIDs.ERFC: lam
-00014b40: 6264 6120 782c 2067 3a20 2d67 202a 2032  bda x, g: -g * 2
-00014b50: 2e30 202f 206d 6174 682e 7371 7274 286d  .0 / math.sqrt(m
-00014b60: 6174 682e 7069 2920 2a20 7072 696d 732e  ath.pi) * prims.
-00014b70: 6578 7028 2d78 202a 2078 292c 0a20 2020  exp(-x * x),.   
-00014b80: 2070 7269 6d73 2e50 7269 6d49 4473 2e45   prims.PrimIDs.E
-00014b90: 5246 494e 563a 206c 616d 6264 6120 7265  RFINV: lambda re
-00014ba0: 7375 6c74 2c20 673a 2067 202a 2030 2e35  sult, g: g * 0.5
-00014bb0: 202a 206d 6174 682e 7371 7274 286d 6174   * math.sqrt(mat
-00014bc0: 682e 7069 2920 2a20 7072 696d 732e 6578  h.pi) * prims.ex
-00014bd0: 7028 7265 7375 6c74 2a2a 3229 2c0a 2020  p(result**2),.  
-00014be0: 2020 7072 696d 732e 5072 696d 4944 732e    prims.PrimIDs.
-00014bf0: 4552 4643 494e 563a 206c 616d 6264 6120  ERFCINV: lambda 
-00014c00: 7265 7375 6c74 2c20 673a 202d 6720 2a20  result, g: -g * 
-00014c10: 302e 3520 2a20 6d61 7468 2e73 7172 7428  0.5 * math.sqrt(
-00014c20: 6d61 7468 2e70 6929 202a 2070 7269 6d73  math.pi) * prims
-00014c30: 2e65 7870 2872 6573 756c 742a 2a32 292c  .exp(result**2),
-00014c40: 0a20 2020 2070 7269 6d73 2e50 7269 6d49  .    prims.PrimI
-00014c50: 4473 2e45 5850 323a 206c 616d 6264 6120  Ds.EXP2: lambda 
-00014c60: 7265 7375 6c74 2c20 673a 2067 202a 2072  result, g: g * r
-00014c70: 6573 756c 7420 2a20 6d61 7468 2e6c 6f67  esult * math.log
-00014c80: 2832 2e30 292c 0a20 2020 2070 7269 6d73  (2.0),.    prims
-00014c90: 2e50 7269 6d49 4473 2e45 5850 4d31 3a20  .PrimIDs.EXPM1: 
-00014ca0: 6c61 6d62 6461 2072 6573 756c 742c 2067  lambda result, g
-00014cb0: 3a20 6720 2a20 2872 6573 756c 7420 2b20  : g * (result + 
-00014cc0: 312e 3029 2c0a 2020 2020 7072 696d 732e  1.0),.    prims.
-00014cd0: 5072 696d 4944 732e 4c47 414d 4d41 3a20  PrimIDs.LGAMMA: 
-00014ce0: 6c61 6d62 6461 2078 2c20 673a 2067 202a  lambda x, g: g *
-00014cf0: 2070 7269 6d73 2e64 6967 616d 6d61 2878   prims.digamma(x
-00014d00: 292c 0a20 2020 2070 7269 6d73 2e50 7269  ),.    prims.Pri
-00014d10: 6d49 4473 2e4e 4454 5249 3a20 6c61 6d62  mIDs.NDTRI: lamb
-00014d20: 6461 2072 6573 756c 742c 2067 3a20 6720  da result, g: g 
-00014d30: 2a20 7072 696d 732e 6578 7028 302e 3520  * prims.exp(0.5 
-00014d40: 2a20 7265 7375 6c74 2a2a 3229 202a 206d  * result**2) * m
-00014d50: 6174 682e 7371 7274 2832 2e30 202a 206d  ath.sqrt(2.0 * m
-00014d60: 6174 682e 7069 292c 0a20 2020 2070 7269  ath.pi),.    pri
-00014d70: 6d73 2e50 7269 6d49 4473 2e53 494e 483a  ms.PrimIDs.SINH:
-00014d80: 206c 616d 6264 6120 782c 2067 3a20 7072   lambda x, g: pr
-00014d90: 696d 732e 6d75 6c28 672c 2070 7269 6d73  ims.mul(g, prims
-00014da0: 2e63 6f73 6828 7829 292c 0a20 2020 2070  .cosh(x)),.    p
-00014db0: 7269 6d73 2e50 7269 6d49 4473 2e53 5152  rims.PrimIDs.SQR
-00014dc0: 543a 206c 616d 6264 6120 7265 7375 6c74  T: lambda result
-00014dd0: 2c20 673a 2067 202f 2028 322e 3020 2a20  , g: g / (2.0 * 
-00014de0: 7265 7375 6c74 292c 0a20 2020 2070 7269  result),.    pri
-00014df0: 6d73 2e50 7269 6d49 4473 2e4e 453a 205a  ms.PrimIDs.NE: Z
-00014e00: 6572 6f42 6163 6b77 6172 6428 6e75 6d5f  eroBackward(num_
-00014e10: 6172 6773 3d32 292c 0a20 2020 2070 7269  args=2),.    pri
-00014e20: 6d73 2e50 7269 6d49 4473 2e47 543a 205a  ms.PrimIDs.GT: Z
-00014e30: 6572 6f42 6163 6b77 6172 6428 6e75 6d5f  eroBackward(num_
-00014e40: 6172 6773 3d32 292c 0a20 2020 2070 7269  args=2),.    pri
-00014e50: 6d73 2e50 7269 6d49 4473 2e4c 453a 205a  ms.PrimIDs.LE: Z
-00014e60: 6572 6f42 6163 6b77 6172 6428 6e75 6d5f  eroBackward(num_
-00014e70: 6172 6773 3d32 292c 0a20 2020 2070 7269  args=2),.    pri
-00014e80: 6d73 2e50 7269 6d49 4473 2e4c 4f47 3130  ms.PrimIDs.LOG10
-00014e90: 3a20 6c61 6d62 6461 2078 2c20 673a 2067  : lambda x, g: g
-00014ea0: 202f 2028 7820 2a20 322e 3330 3235 3835   / (x * 2.302585
-00014eb0: 3039 3239 3934 3034 3629 2c0a 2020 2020  092994046),.    
-00014ec0: 7072 696d 732e 5072 696d 4944 732e 4c4f  prims.PrimIDs.LO
-00014ed0: 4731 503a 206c 616d 6264 6120 782c 2067  G1P: lambda x, g
-00014ee0: 3a20 6720 2f20 2878 202b 2031 292c 0a20  : g / (x + 1),. 
-00014ef0: 2020 2070 7269 6d73 2e50 7269 6d49 4473     prims.PrimIDs
-00014f00: 2e4c 4f47 323a 206c 616d 6264 6120 782c  .LOG2: lambda x,
-00014f10: 2067 3a20 6720 2f20 2878 202a 2030 2e36   g: g / (x * 0.6
-00014f20: 3933 3134 3731 3830 3535 3939 3435 3329  931471805599453)
-00014f30: 2c0a 2020 2020 7072 696d 732e 5072 696d  ,.    prims.Prim
-00014f40: 4944 732e 464d 4f44 3a20 6c61 6d62 6461  IDs.FMOD: lambda
-00014f50: 2078 2c20 792c 2067 3a20 2867 2c20 2d67   x, y, g: (g, -g
-00014f60: 202a 2070 7269 6d73 2e74 7275 6e63 2878   * prims.trunc(x
-00014f70: 202f 2079 2929 2c0a 2020 2020 2320 5468   / y)),.    # Th
-00014f80: 6520 636f 7079 2073 686f 756c 6420 6e6f  e copy should no
-00014f90: 7420 6265 2064 6966 6665 7265 6e74 6961  t be differentia
-00014fa0: 626c 652e 2057 6520 7265 7475 726e 204e  ble. We return N
-00014fb0: 6f6e 6520 746f 2065 6e61 626c 6520 7468  one to enable th
-00014fc0: 6520 6765 6e65 7261 7469 6f6e 206f 6620  e generation of 
-00014fd0: 7468 6520 6261 636b 7761 7264 2067 7261  the backward gra
-00014fe0: 7068 2074 6872 6f75 6768 2074 6865 6d2e  ph through them.
-00014ff0: 0a20 2020 2070 7269 6d73 2e50 7269 6d49  .    prims.PrimI
-00015000: 4473 2e43 4f50 595f 3a20 6c61 6d62 6461  Ds.COPY_: lambda
-00015010: 2067 3a20 284e 6f6e 652c 204e 6f6e 6529   g: (None, None)
-00015020: 2c0a 7d0a 0a0a 6465 6620 7265 6769 7374  ,.}...def regist
-00015030: 6572 5f61 7567 6d65 6e74 6564 5f66 6f72  er_augmented_for
-00015040: 7761 7264 286f 7029 3a0a 2020 2020 2222  ward(op):.    ""
-00015050: 2244 6563 6f72 6174 6f72 2074 6f20 7265  "Decorator to re
-00015060: 6769 7374 6572 2061 6e20 6175 676d 656e  gister an augmen
-00015070: 7465 6420 666f 7277 6172 6420 696d 706c  ted forward impl
-00015080: 656d 656e 7461 7469 6f6e 2066 6f72 2061  ementation for a
-00015090: 2073 796d 626f 6c2e 0a0a 2020 2020 4172   symbol...    Ar
-000150a0: 6773 3a0a 2020 2020 2020 2020 6f70 2028  gs:.        op (
-000150b0: 4f70 7329 3a20 5379 6d62 6f6c 2066 6f72  Ops): Symbol for
-000150c0: 2077 6869 6368 2074 6f20 7265 6769 7374   which to regist
-000150d0: 6572 2074 6865 2061 7567 6d65 6e74 6564  er the augmented
-000150e0: 2066 6f72 7761 7264 2069 6d70 6c65 6d65   forward impleme
-000150f0: 6e74 6174 696f 6e2e 0a0a 2020 2020 5265  ntation...    Re
-00015100: 7475 726e 733a 0a20 2020 2020 2020 2043  turns:.        C
-00015110: 616c 6c61 626c 653a 2044 6563 6f72 6174  allable: Decorat
-00015120: 6f72 2066 756e 6374 696f 6e2e 0a20 2020  or function..   
-00015130: 2022 2222 0a0a 2020 2020 6465 6620 6465   """..    def de
-00015140: 636f 7261 746f 7228 6675 6e63 293a 0a20  corator(func):. 
-00015150: 2020 2020 2020 2061 7567 6d65 6e74 6564         augmented
-00015160: 5f66 6f72 7761 7264 5f69 6d70 6c73 5b6f  _forward_impls[o
-00015170: 705d 203d 2066 756e 630a 2020 2020 2020  p] = func.      
-00015180: 2020 7265 7475 726e 2066 756e 630a 0a20    return func.. 
-00015190: 2020 2072 6574 7572 6e20 6465 636f 7261     return decora
-000151a0: 746f 720a 0a0a 6465 6620 7265 6769 7374  tor...def regist
-000151b0: 6572 5f62 6163 6b77 6172 6428 6f70 293a  er_backward(op):
-000151c0: 0a20 2020 2022 2222 4465 636f 7261 746f  .    """Decorato
-000151d0: 7220 746f 2072 6567 6973 7465 7220 6120  r to register a 
-000151e0: 6261 636b 7761 7264 2069 6d70 6c65 6d65  backward impleme
-000151f0: 6e74 6174 696f 6e20 666f 7220 6120 7379  ntation for a sy
-00015200: 6d62 6f6c 2e0a 0a20 2020 2041 7267 733a  mbol...    Args:
-00015210: 0a20 2020 2020 2020 206f 7020 284f 7073  .        op (Ops
-00015220: 293a 2053 796d 626f 6c20 666f 7220 7768  ): Symbol for wh
-00015230: 6963 6820 746f 2072 6567 6973 7465 7220  ich to register 
-00015240: 7468 6520 6261 636b 7761 7264 2069 6d70  the backward imp
-00015250: 6c65 6d65 6e74 6174 696f 6e2e 0a0a 2020  lementation...  
-00015260: 2020 5265 7475 726e 733a 0a20 2020 2020    Returns:.     
-00015270: 2020 2043 616c 6c61 626c 653a 2044 6563     Callable: Dec
-00015280: 6f72 6174 6f72 2066 756e 6374 696f 6e2e  orator function.
-00015290: 0a20 2020 2022 2222 0a0a 2020 2020 6465  .    """..    de
-000152a0: 6620 6465 636f 7261 746f 7228 6675 6e63  f decorator(func
-000152b0: 293a 0a20 2020 2020 2020 2062 6163 6b77  ):.        backw
-000152c0: 6172 645f 696d 706c 735b 6f70 5d20 3d20  ard_impls[op] = 
-000152d0: 6675 6e63 0a20 2020 2020 2020 2072 6574  func.        ret
-000152e0: 7572 6e20 6675 6e63 0a0a 2020 2020 7265  urn func..    re
-000152f0: 7475 726e 2064 6563 6f72 6174 6f72 0a0a  turn decorator..
-00015300: 0a64 6566 2072 6573 746f 7265 5f72 6564  .def restore_red
-00015310: 7563 6564 5f64 696d 7328 782c 2072 6564  uced_dims(x, red
-00015320: 7563 6564 5f64 696d 732c 206f 7269 6769  uced_dims, origi
-00015330: 6e61 6c5f 7368 6170 6529 3a0a 2020 2020  nal_shape):.    
-00015340: 2222 2252 6573 746f 7265 7320 7468 6520  """Restores the 
-00015350: 7265 6475 6365 6420 6469 6d65 6e73 696f  reduced dimensio
-00015360: 6e73 206f 6620 6120 7465 6e73 6f72 2e0a  ns of a tensor..
-00015370: 0a20 2020 2041 7267 733a 0a20 2020 2020  .    Args:.     
-00015380: 2020 2078 2028 5661 7269 6162 6c65 293a     x (Variable):
-00015390: 2054 656e 736f 7220 746f 2062 6520 7265   Tensor to be re
-000153a0: 7368 6170 6564 2e0a 2020 2020 2020 2020  shaped..        
-000153b0: 7265 6475 6365 645f 6469 6d73 2028 5475  reduced_dims (Tu
-000153c0: 706c 655b 696e 742c 202e 2e2e 5d29 3a20  ple[int, ...]): 
-000153d0: 5475 706c 6520 6f66 2072 6564 7563 6564  Tuple of reduced
-000153e0: 2064 696d 656e 7369 6f6e 732e 0a20 2020   dimensions..   
-000153f0: 2020 2020 206f 7269 6769 6e61 6c5f 7368       original_sh
-00015400: 6170 6520 2854 7570 6c65 5b69 6e74 2c20  ape (Tuple[int, 
-00015410: 2e2e 2e5d 293a 204f 7269 6769 6e61 6c20  ...]): Original 
-00015420: 7368 6170 6520 6f66 2074 6865 2074 656e  shape of the ten
-00015430: 736f 722e 0a0a 2020 2020 5265 7475 726e  sor...    Return
-00015440: 733a 0a20 2020 2020 2020 2056 6172 6961  s:.        Varia
-00015450: 626c 653a 2054 656e 736f 7220 7769 7468  ble: Tensor with
-00015460: 2074 6865 2072 6564 7563 6564 2064 696d   the reduced dim
-00015470: 656e 7369 6f6e 7320 7265 7374 6f72 6564  ensions restored
-00015480: 2e0a 2020 2020 2222 220a 2020 2020 6966  ..    """.    if
-00015490: 206f 7269 6769 6e61 6c5f 7368 6170 6520   original_shape 
-000154a0: 3d3d 2028 293a 2020 2320 7363 616c 6172  == ():  # scalar
-000154b0: 0a20 2020 2020 2020 2072 6574 7572 6e20  .        return 
-000154c0: 780a 0a20 2020 2075 6e73 7175 6565 7a65  x..    unsqueeze
-000154d0: 6420 3d20 636c 616e 672e 756e 7371 7565  d = clang.unsque
-000154e0: 657a 6528 782c 2072 6564 7563 6564 5f64  eze(x, reduced_d
-000154f0: 696d 7329 0a20 2020 2072 6574 7572 6e20  ims).    return 
-00015500: 636c 616e 672e 6578 7061 6e64 2875 6e73  clang.expand(uns
-00015510: 7175 6565 7a65 642c 206f 7269 6769 6e61  queezed, origina
-00015520: 6c5f 7368 6170 6529 0a0a 0a40 7265 6769  l_shape)...@regi
-00015530: 7374 6572 5f62 6163 6b77 6172 6428 7072  ster_backward(pr
-00015540: 696d 732e 5072 696d 4944 732e 5a45 5441  ims.PrimIDs.ZETA
-00015550: 290a 6465 6620 7a65 7461 5f62 6163 6b77  ).def zeta_backw
-00015560: 6172 6428 782c 2079 2c20 6729 3a0a 2020  ard(x, y, g):.  
-00015570: 2020 2320 5468 6520 6465 7269 7661 7469    # The derivati
-00015580: 7665 2077 7274 2074 6865 2066 6972 7374  ve wrt the first
-00015590: 2061 7267 756d 656e 7420 6973 206e 6f74   argument is not
-000155a0: 2065 7870 7265 7373 6962 6c65 2069 6e20   expressible in 
-000155b0: 7465 726d 7320 6f66 207a 6574 6120 6f72  terms of zeta or
-000155c0: 0a20 2020 2023 206f 7468 6572 2073 7065  .    # other spe
-000155d0: 6369 616c 2066 756e 6374 696f 6e73 0a20  cial functions. 
-000155e0: 2020 2023 2054 6865 7265 666f 7265 2c20     # Therefore, 
-000155f0: 7765 2063 6f6d 7075 7465 206f 6e6c 7920  we compute only 
-00015600: 7468 6520 6465 7269 7661 7469 7665 2077  the derivative w
-00015610: 7274 2074 6865 2073 6563 6f6e 6420 6172  rt the second ar
-00015620: 6775 6d65 6e74 0a20 2020 2067 7920 3d20  gument.    gy = 
-00015630: 6720 2a20 2d78 202a 2070 7269 6d73 2e7a  g * -x * prims.z
-00015640: 6574 6128 7820 2b20 312e 302c 2079 290a  eta(x + 1.0, y).
-00015650: 0a20 2020 2023 2052 6574 7572 6e20 6120  .    # Return a 
-00015660: 6d61 7070 7069 6e67 2066 726f 6d20 7468  mappping from th
-00015670: 6520 666f 7277 6172 6420 6172 6775 6d65  e forward argume
-00015680: 6e74 7320 746f 2074 6865 2067 7261 6469  nts to the gradi
-00015690: 656e 7473 0a20 2020 2072 6574 7572 6e20  ents.    return 
-000156a0: 7b22 7922 3a20 6779 7d0a 0a0a 4072 6567  {"y": gy}...@reg
-000156b0: 6973 7465 725f 6261 636b 7761 7264 2870  ister_backward(p
-000156c0: 7269 6d73 2e50 7269 6d49 4473 2e44 4947  rims.PrimIDs.DIG
-000156d0: 414d 4d41 290a 6465 6620 6469 6761 6d6d  AMMA).def digamm
-000156e0: 615f 6261 636b 7761 7264 2861 3a20 5072  a_backward(a: Pr
-000156f0: 6f78 792c 2067 293a 0a20 2020 2066 726f  oxy, g):.    fro
-00015700: 6d20 7468 756e 6465 722e 746f 7263 6820  m thunder.torch 
-00015710: 696d 706f 7274 2070 6f6c 7967 616d 6d61  import polygamma
-00015720: 0a0a 2020 2020 7265 7475 726e 2067 202a  ..    return g *
-00015730: 2070 6f6c 7967 616d 6d61 2831 2c20 6129   polygamma(1, a)
-00015740: 0a0a 0a40 7265 6769 7374 6572 5f61 7567  ...@register_aug
-00015750: 6d65 6e74 6564 5f66 6f72 7761 7264 2822  mented_forward("
-00015760: 746f 7263 682e 706f 6c79 6761 6d6d 6122  torch.polygamma"
-00015770: 290a 6465 6620 706f 6c79 6761 6d6d 615f  ).def polygamma_
-00015780: 6175 675f 6677 6428 6e3a 2069 6e74 2c20  aug_fwd(n: int, 
-00015790: 613a 2050 726f 7879 293a 0a20 2020 2066  a: Proxy):.    f
-000157a0: 726f 6d20 7468 756e 6465 722e 746f 7263  rom thunder.torc
-000157b0: 6820 696d 706f 7274 2070 6f6c 7967 616d  h import polygam
-000157c0: 6d61 0a0a 2020 2020 7072 696d 616c 203d  ma..    primal =
-000157d0: 2070 6f6c 7967 616d 6d61 286e 2c20 6129   polygamma(n, a)
-000157e0: 0a20 2020 2072 6573 6964 7561 6c73 203d  .    residuals =
-000157f0: 2028 6e2c 2061 290a 2020 2020 7265 7475   (n, a).    retu
-00015800: 726e 2056 4a50 4475 616c 2870 7269 6d61  rn VJPDual(prima
-00015810: 6c2c 2072 6573 6964 7561 6c73 290a 0a0a  l, residuals)...
-00015820: 4072 6567 6973 7465 725f 6261 636b 7761  @register_backwa
-00015830: 7264 2822 746f 7263 682e 706f 6c79 6761  rd("torch.polyga
-00015840: 6d6d 6122 290a 6465 6620 706f 6c79 6761  mma").def polyga
-00015850: 6d6d 615f 6261 636b 7761 7264 286e 3a20  mma_backward(n: 
-00015860: 696e 742c 2061 3a20 5072 6f78 792c 2067  int, a: Proxy, g
-00015870: 293a 0a20 2020 2066 726f 6d20 7468 756e  ):.    from thun
-00015880: 6465 722e 746f 7263 6820 696d 706f 7274  der.torch import
-00015890: 2070 6f6c 7967 616d 6d61 0a0a 2020 2020   polygamma..    
-000158a0: 7265 7475 726e 204e 6f6e 652c 2067 202a  return None, g *
-000158b0: 2070 6f6c 7967 616d 6d61 286e 202b 2031   polygamma(n + 1
-000158c0: 2c20 6129 0a0a 0a40 7265 6769 7374 6572  , a)...@register
-000158d0: 5f62 6163 6b77 6172 6428 7072 696d 732e  _backward(prims.
-000158e0: 5072 696d 4944 732e 4154 414e 3229 0a64  PrimIDs.ATAN2).d
-000158f0: 6566 2061 7461 6e32 5f62 6163 6b77 6172  ef atan2_backwar
-00015900: 6428 782c 2079 2c20 6729 3a0a 2020 2020  d(x, y, g):.    
-00015910: 616c 7068 6120 3d20 312e 3020 2f20 2878  alpha = 1.0 / (x
-00015920: 202a 2078 202b 2079 202a 2079 290a 2020   * x + y * y).  
-00015930: 2020 6772 6164 5f78 203d 2067 202a 2079    grad_x = g * y
-00015940: 202a 2061 6c70 6861 0a20 2020 2067 7261   * alpha.    gra
-00015950: 645f 7920 3d20 6720 2a20 2d78 202a 2061  d_y = g * -x * a
-00015960: 6c70 6861 0a20 2020 2072 6574 7572 6e20  lpha.    return 
-00015970: 6772 6164 5f78 2c20 6772 6164 5f79 0a0a  grad_x, grad_y..
-00015980: 0a40 7265 6769 7374 6572 5f61 7567 6d65  .@register_augme
-00015990: 6e74 6564 5f66 6f72 7761 7264 2870 7269  nted_forward(pri
-000159a0: 6d73 2e50 7269 6d49 4473 2e56 4152 290a  ms.PrimIDs.VAR).
-000159b0: 6465 6620 7661 725f 6175 675f 6677 6428  def var_aug_fwd(
-000159c0: 612c 2064 696d 2c20 2a2c 2063 6f72 7265  a, dim, *, corre
-000159d0: 6374 696f 6e29 3a0a 2020 2020 7620 3d20  ction):.    v = 
-000159e0: 7072 696d 732e 7661 7228 612c 2064 696d  prims.var(a, dim
-000159f0: 2c20 636f 7272 6563 7469 6f6e 3d63 6f72  , correction=cor
-00015a00: 7265 6374 696f 6e29 0a20 2020 2072 6574  rection).    ret
-00015a10: 7572 6e20 564a 5044 7561 6c28 2876 2c29  urn VJPDual((v,)
-00015a20: 2c20 2861 2c20 6469 6d2c 2063 6f72 7265  , (a, dim, corre
-00015a30: 6374 696f 6e2c 2076 2929 0a0a 0a23 2054  ction, v))...# T
-00015a40: 4f44 4f3a 2066 6978 2064 6976 6973 696f  ODO: fix divisio
-00015a50: 6e20 6279 207a 6572 6f20 7768 656e 206e  n by zero when n
-00015a60: 5f65 6c65 6d5f 7265 6475 6365 6420 3d3d  _elem_reduced ==
-00015a70: 2030 206f 7220 7768 656e 2076 2e6e 756d   0 or when v.num
-00015a80: 656c 203d 3d20 300a 2320 6279 2072 6574  el == 0.# by ret
-00015a90: 7572 6e69 6e67 207a 6572 6f73 5f6c 696b  urning zeros_lik
-00015aa0: 6528 6129 206f 7220 7369 6d69 6c61 722e  e(a) or similar.
-00015ab0: 0a23 2054 4f44 4f3a 2066 6978 2067 7261  .# TODO: fix gra
-00015ac0: 6420 7768 656e 2063 6f72 7265 6374 696f  d when correctio
-00015ad0: 6e20 3e20 6e5f 656c 656d 5f72 6564 7563  n > n_elem_reduc
-00015ae0: 6564 2e0a 4072 6567 6973 7465 725f 6261  ed..@register_ba
-00015af0: 636b 7761 7264 2870 7269 6d73 2e50 7269  ckward(prims.Pri
-00015b00: 6d49 4473 2e56 4152 290a 6465 6620 7661  mIDs.VAR).def va
-00015b10: 725f 6261 636b 7761 7264 2861 2c20 6469  r_backward(a, di
-00015b20: 6d2c 2063 6f72 7265 6374 696f 6e2c 2076  m, correction, v
-00015b30: 2c20 6729 3a0a 2020 2020 6e5f 656c 656d  , g):.    n_elem
-00015b40: 5f72 6564 7563 6564 203d 2061 2e6e 756d  _reduced = a.num
-00015b50: 656c 202f 2f20 762e 6e75 6d65 6c20 6966  el // v.numel if
-00015b60: 2061 2e6e 756d 656c 2021 3d20 3020 656c   a.numel != 0 el
-00015b70: 7365 2031 0a20 2020 206e 6f72 6d61 6c69  se 1.    normali
-00015b80: 7a61 7469 6f6e 5f73 6361 6c61 7220 3d20  zation_scalar = 
-00015b90: 6e5f 656c 656d 5f72 6564 7563 6564 202d  n_elem_reduced -
-00015ba0: 2063 6f72 7265 6374 696f 6e0a 2020 2020   correction.    
-00015bb0: 6720 3d20 7265 7374 6f72 655f 7265 6475  g = restore_redu
-00015bc0: 6365 645f 6469 6d73 2867 2c20 6469 6d2c  ced_dims(g, dim,
-00015bd0: 2061 2e73 6861 7065 290a 2020 2020 6966   a.shape).    if
-00015be0: 2061 2e64 7479 7065 2021 3d20 762e 6474   a.dtype != v.dt
-00015bf0: 7970 653a 0a20 2020 2020 2020 2061 203d  ype:.        a =
-00015c00: 2070 7269 6d73 2e63 6f6e 7665 7274 5f65   prims.convert_e
-00015c10: 6c65 6d65 6e74 5f74 7970 6528 612c 2076  lement_type(a, v
-00015c20: 2e64 7479 7065 290a 2020 2020 6d65 616e  .dtype).    mean
-00015c30: 203d 2070 7269 6d73 2e73 756d 2861 2c20   = prims.sum(a, 
-00015c40: 6469 6d29 202f 206e 5f65 6c65 6d5f 7265  dim) / n_elem_re
-00015c50: 6475 6365 640a 2020 2020 6d65 616e 203d  duced.    mean =
-00015c60: 2072 6573 746f 7265 5f72 6564 7563 6564   restore_reduced
-00015c70: 5f64 696d 7328 6d65 616e 2c20 6469 6d2c  _dims(mean, dim,
-00015c80: 2061 2e73 6861 7065 290a 2020 2020 7265   a.shape).    re
-00015c90: 7475 726e 2028 3220 2a20 6720 2a20 2861  turn (2 * g * (a
-00015ca0: 202d 206d 6561 6e29 2920 2f20 6e6f 726d   - mean)) / norm
-00015cb0: 616c 697a 6174 696f 6e5f 7363 616c 6172  alization_scalar
-00015cc0: 0a0a 0a64 6566 206e 5f65 6c65 6d5f 7265  ...def n_elem_re
-00015cd0: 6475 6365 6428 615f 6e64 696d 2c20 615f  duced(a_ndim, a_
-00015ce0: 7368 6170 652c 2064 696d 7329 3a0a 2020  shape, dims):.  
-00015cf0: 2020 6469 6d73 203d 2075 7469 6c73 2e63    dims = utils.c
-00015d00: 616e 6f6e 6963 616c 697a 655f 6469 6d73  anonicalize_dims
-00015d10: 2861 5f6e 6469 6d2c 2064 696d 7329 0a20  (a_ndim, dims). 
-00015d20: 2020 2072 6564 7563 7469 6f6e 5f73 697a     reduction_siz
-00015d30: 6520 3d20 310a 2020 2020 666f 7220 6964  e = 1.    for id
-00015d40: 782c 2073 697a 6520 696e 2065 6e75 6d65  x, size in enume
-00015d50: 7261 7465 2861 5f73 6861 7065 293a 0a20  rate(a_shape):. 
-00015d60: 2020 2020 2020 2069 6620 6964 7820 696e         if idx in
-00015d70: 2064 696d 733a 0a20 2020 2020 2020 2020   dims:.         
-00015d80: 2020 2072 6564 7563 7469 6f6e 5f73 697a     reduction_siz
-00015d90: 6520 2a3d 2073 697a 650a 2020 2020 7265  e *= size.    re
-00015da0: 7475 726e 2072 6564 7563 7469 6f6e 5f73  turn reduction_s
-00015db0: 697a 650a 0a0a 6465 6620 6d65 616e 5f62  ize...def mean_b
-00015dc0: 6163 6b77 6172 6428 615f 6e64 696d 2c20  ackward(a_ndim, 
-00015dd0: 615f 7368 6170 652c 2064 696d 732c 2067  a_shape, dims, g
-00015de0: 7261 6429 3a0a 2020 2020 6d65 616e 5f6c  rad):.    mean_l
-00015df0: 6f63 616c 5f67 7261 6420 3d20 312e 3020  ocal_grad = 1.0 
-00015e00: 2f20 6e5f 656c 656d 5f72 6564 7563 6564  / n_elem_reduced
-00015e10: 2861 5f6e 6469 6d2c 2061 5f73 6861 7065  (a_ndim, a_shape
-00015e20: 2c20 6469 6d73 290a 2020 2020 7265 7475  , dims).    retu
-00015e30: 726e 2072 6573 746f 7265 5f72 6564 7563  rn restore_reduc
-00015e40: 6564 5f64 696d 7328 6772 6164 2c20 6469  ed_dims(grad, di
-00015e50: 6d73 2c20 615f 7368 6170 6529 202a 206d  ms, a_shape) * m
-00015e60: 6561 6e5f 6c6f 6361 6c5f 6772 6164 0a0a  ean_local_grad..
-00015e70: 0a40 7265 6769 7374 6572 5f61 7567 6d65  .@register_augme
-00015e80: 6e74 6564 5f66 6f72 7761 7264 2870 7269  nted_forward(pri
-00015e90: 6d73 2e50 7269 6d49 4473 2e50 4144 290a  ms.PrimIDs.PAD).
-00015ea0: 6465 6620 7061 645f 6175 675f 6677 6428  def pad_aug_fwd(
-00015eb0: 612c 2070 6164 6469 6e67 5f76 616c 7565  a, padding_value
-00015ec0: 2c20 7061 6464 696e 675f 636f 6e66 6967  , padding_config
-00015ed0: 293a 0a20 2020 2072 6574 7572 6e20 564a  ):.    return VJ
-00015ee0: 5044 7561 6c28 2870 7269 6d73 2e70 6164  PDual((prims.pad
-00015ef0: 2861 2c20 7061 6464 696e 675f 7661 6c75  (a, padding_valu
-00015f00: 652c 2070 6164 6469 6e67 5f63 6f6e 6669  e, padding_confi
-00015f10: 6729 2c29 2c20 2861 2c20 7061 6464 696e  g),), (a, paddin
-00015f20: 675f 636f 6e66 6967 2929 0a0a 0a40 7265  g_config))...@re
-00015f30: 6769 7374 6572 5f62 6163 6b77 6172 6428  gister_backward(
-00015f40: 7072 696d 732e 5072 696d 4944 732e 5041  prims.PrimIDs.PA
-00015f50: 4429 0a64 6566 2070 6164 5f62 6163 6b77  D).def pad_backw
-00015f60: 6172 6428 612c 2070 6164 6469 6e67 5f63  ard(a, padding_c
-00015f70: 6f6e 6669 672c 2067 293a 0a20 2020 2023  onfig, g):.    #
-00015f80: 2053 686f 7274 2063 6972 6375 6974 206f   Short circuit o
-00015f90: 6e20 656d 7074 7920 696e 7075 742e 0a20  n empty input.. 
-00015fa0: 2020 2069 6620 616e 7928 6469 6d20 3d3d     if any(dim ==
-00015fb0: 2030 2066 6f72 2064 696d 2069 6e20 612e   0 for dim in a.
-00015fc0: 7368 6170 6529 3a0a 2020 2020 2020 2020  shape):.        
-00015fd0: 7265 7475 726e 2066 756c 6c5f 6c69 6b65  return full_like
-00015fe0: 2861 2c20 6669 6c6c 5f76 616c 7565 3d30  (a, fill_value=0
-00015ff0: 290a 0a20 2020 2023 2055 6e2d 7061 6420  )..    # Un-pad 
-00016000: 6279 2070 6164 6469 6e67 2077 6974 6820  by padding with 
-00016010: 7a65 726f 2076 616c 7565 730a 2020 2020  zero values.    
-00016020: 7a65 726f 5f70 6164 6469 6e67 5f63 6f6e  zero_padding_con
-00016030: 6669 6720 3d20 5b28 2d6c 6f2c 202d 6869  fig = [(-lo, -hi
-00016040: 2c20 3029 2066 6f72 206c 6f2c 2068 692c  , 0) for lo, hi,
-00016050: 205f 2069 6e20 7061 6464 696e 675f 636f   _ in padding_co
-00016060: 6e66 6967 5d0a 0a20 2020 2067 203d 2070  nfig]..    g = p
-00016070: 7269 6d73 2e70 6164 2867 2c20 302e 302c  rims.pad(g, 0.0,
-00016080: 207a 6572 6f5f 7061 6464 696e 675f 636f   zero_padding_co
-00016090: 6e66 6967 290a 0a20 2020 2023 2055 6e2d  nfig)..    # Un-
-000160a0: 736c 6963 6520 6279 2073 6c69 6369 6e67  slice by slicing
-000160b0: 2077 6974 6820 6120 7374 7269 6465 206f   with a stride o
-000160c0: 6620 7661 6c75 6520 2864 696c 6174 696f  f value (dilatio
-000160d0: 6e20 2b20 3129 0a20 2020 2066 6f72 2064  n + 1).    for d
-000160e0: 696d 2c20 285f 2c20 5f2c 2064 2920 696e  im, (_, _, d) in
-000160f0: 2065 6e75 6d65 7261 7465 2870 6164 6469   enumerate(paddi
-00016100: 6e67 5f63 6f6e 6669 6729 3a0a 2020 2020  ng_config):.    
-00016110: 2020 2020 6720 3d20 736c 6963 655f 696e      g = slice_in
-00016120: 5f64 696d 2867 2c20 302c 2067 2e73 6861  _dim(g, 0, g.sha
-00016130: 7065 5b64 696d 5d2c 2073 7472 6964 653d  pe[dim], stride=
-00016140: 6420 2b20 312c 2064 696d 3d64 696d 290a  d + 1, dim=dim).
-00016150: 0a20 2020 2072 6574 7572 6e20 670a 0a0a  .    return g...
-00016160: 4072 6567 6973 7465 725f 6175 676d 656e  @register_augmen
-00016170: 7465 645f 666f 7277 6172 6428 7072 696d  ted_forward(prim
-00016180: 732e 5072 696d 4944 732e 5052 4f44 290a  s.PrimIDs.PROD).
-00016190: 6465 6620 7072 6f64 5f61 7567 5f66 7764  def prod_aug_fwd
-000161a0: 2878 2c20 6469 6d73 293a 0a20 2020 2022  (x, dims):.    "
-000161b0: 2222 4175 676d 656e 7465 6420 7072 6f64  ""Augmented prod
-000161c0: 206f 7065 7261 7469 6f6e 2e0a 0a20 2020   operation...   
-000161d0: 2041 7267 733a 0a20 2020 2020 2020 2078   Args:.        x
-000161e0: 2028 5661 7269 6162 6c65 293a 2054 656e   (Variable): Ten
-000161f0: 736f 7220 746f 2062 6520 6d75 6c74 6970  sor to be multip
-00016200: 6c69 6564 2e0a 2020 2020 2020 2020 6469  lied..        di
-00016210: 6d73 2028 5475 706c 655b 696e 742c 202e  ms (Tuple[int, .
-00016220: 2e2e 5d29 3a20 4469 6d65 6e73 696f 6e73  ..]): Dimensions
-00016230: 2074 6f20 6265 206d 756c 7469 706c 6965   to be multiplie
-00016240: 642e 0a0a 2020 2020 5265 7475 726e 733a  d...    Returns:
-00016250: 0a20 2020 2020 2020 2056 4a50 4475 616c  .        VJPDual
-00016260: 3a20 5072 696d 616c 2061 6e64 2072 6573  : Primal and res
-00016270: 6964 7561 6c73 2e0a 2020 2020 2222 220a  iduals..    """.
-00016280: 2020 2020 7072 696d 616c 203d 2070 7269      primal = pri
-00016290: 6d73 2e70 726f 6428 782c 2064 696d 7329  ms.prod(x, dims)
-000162a0: 0a0a 2020 2020 7265 7369 6475 616c 7320  ..    residuals 
-000162b0: 3d20 280a 2020 2020 2020 2020 7072 696d  = (.        prim
-000162c0: 616c 2c0a 2020 2020 2020 2020 782c 0a20  al,.        x,. 
-000162d0: 2020 2020 2020 2078 2e73 6861 7065 2c0a         x.shape,.
-000162e0: 2020 2020 2020 2020 6469 6d73 2c0a 2020          dims,.  
-000162f0: 2020 290a 2020 2020 7265 7475 726e 2056    ).    return V
-00016300: 4a50 4475 616c 2870 7269 6d61 6c2c 2072  JPDual(primal, r
-00016310: 6573 6964 7561 6c73 290a 0a0a 4072 6567  esiduals)...@reg
-00016320: 6973 7465 725f 6261 636b 7761 7264 2870  ister_backward(p
-00016330: 7269 6d73 2e50 7269 6d49 4473 2e50 524f  rims.PrimIDs.PRO
-00016340: 4429 0a64 6566 2070 726f 645f 7075 6c6c  D).def prod_pull
-00016350: 6261 636b 2870 7269 6d61 6c2c 2078 2c20  back(primal, x, 
-00016360: 785f 7368 6170 652c 2072 6564 7563 6564  x_shape, reduced
-00016370: 5f64 696d 732c 2067 293a 0a20 2020 2072  _dims, g):.    r
-00016380: 6574 7572 6e20 7072 696d 732e 6469 7628  eturn prims.div(
-00016390: 7265 7374 6f72 655f 7265 6475 6365 645f  restore_reduced_
-000163a0: 6469 6d73 2870 7269 6d61 6c20 2a20 672c  dims(primal * g,
-000163b0: 2072 6564 7563 6564 5f64 696d 732c 2078   reduced_dims, x
-000163c0: 5f73 6861 7065 292c 2078 290a 0a0a 6465  _shape), x)...de
-000163d0: 6620 6b65 6570 6469 6d5f 7265 6475 6374  f keepdim_reduct
-000163e0: 696f 6e28 7265 6475 6374 696f 6e5f 666e  ion(reduction_fn
-000163f0: 2c20 782c 2064 696d 7329 3a0a 2020 2020  , x, dims):.    
-00016400: 2222 2241 7070 6c69 6573 2072 6564 7563  """Applies reduc
-00016410: 7469 6f6e 2061 6e64 2066 6978 6573 206f  tion and fixes o
-00016420: 7574 7075 7420 746f 2063 6f6e 666f 726d  utput to conform
-00016430: 2074 6f20 6b65 6570 6469 6d3d 5472 7565   to keepdim=True
-00016440: 2222 220a 2020 2020 6f75 7420 3d20 7265  """.    out = re
-00016450: 6475 6374 696f 6e5f 666e 2878 2c20 6469  duction_fn(x, di
-00016460: 6d73 290a 2020 2020 6172 676d 6178 5f73  ms).    argmax_s
-00016470: 756d 5f6f 7574 5f73 6861 7065 203d 205b  um_out_shape = [
-00016480: 782e 7368 6170 655b 695d 2069 6620 6920  x.shape[i] if i 
-00016490: 6e6f 7420 696e 2064 696d 7320 656c 7365  not in dims else
-000164a0: 2031 2066 6f72 2069 2069 6e20 7261 6e67   1 for i in rang
-000164b0: 6528 782e 6e64 696d 295d 0a20 2020 2062  e(x.ndim)].    b
-000164c0: 726f 6164 6361 7374 5f64 696d 7320 3d20  roadcast_dims = 
-000164d0: 5b69 2066 6f72 2069 2069 6e20 7261 6e67  [i for i in rang
-000164e0: 6528 782e 6e64 696d 2920 6966 2069 206e  e(x.ndim) if i n
-000164f0: 6f74 2069 6e20 6469 6d73 5d0a 2020 2020  ot in dims].    
-00016500: 7265 7475 726e 2070 7269 6d73 2e62 726f  return prims.bro
-00016510: 6164 6361 7374 5f69 6e5f 6469 6d28 6f75  adcast_in_dim(ou
-00016520: 742c 2061 7267 6d61 785f 7375 6d5f 6f75  t, argmax_sum_ou
-00016530: 745f 7368 6170 652c 2062 726f 6164 6361  t_shape, broadca
-00016540: 7374 5f64 696d 7329 0a0a 0a23 2049 6e73  st_dims)...# Ins
-00016550: 7069 7265 6420 6672 6f6d 2068 7474 7073  pired from https
-00016560: 3a2f 2f67 6974 6875 622e 636f 6d2f 4849  ://github.com/HI
-00016570: 5053 2f61 7574 6f67 7261 642f 626c 6f62  PS/autograd/blob
-00016580: 2f6d 6173 7465 722f 6175 746f 6772 6164  /master/autograd
-00016590: 2f6e 756d 7079 2f6e 756d 7079 5f76 6a70  /numpy/numpy_vjp
-000165a0: 732e 7079 234c 3335 330a 6465 6620 6772  s.py#L353.def gr
-000165b0: 6164 5f63 686f 6f73 6572 5f62 6163 6b77  ad_chooser_backw
-000165c0: 6172 6428 7072 696d 616c 2c20 782c 2078  ard(primal, x, x
-000165d0: 5f73 6861 7065 2c20 7265 6475 6365 645f  _shape, reduced_
-000165e0: 6469 6d73 2c20 6729 3a0a 2020 2020 2222  dims, g):.    ""
-000165f0: 2242 7569 6c64 7320 6772 6164 6965 6e74  "Builds gradient
-00016600: 206f 6620 6675 6e63 7469 6f6e 7320 7468   of functions th
-00016610: 6174 2063 686f 6f73 6520 6120 7369 6e67  at choose a sing
-00016620: 6c65 2069 7465 6d2c 2073 7563 6820 6173  le item, such as
-00016630: 206d 696e 206f 7220 6d61 782e 2222 220a   min or max.""".
-00016640: 2020 2020 675f 7265 7065 6174 6564 203d      g_repeated =
-00016650: 2072 6573 746f 7265 5f72 6564 7563 6564   restore_reduced
-00016660: 5f64 696d 7328 672c 2072 6564 7563 6564  _dims(g, reduced
-00016670: 5f64 696d 732c 2078 5f73 6861 7065 290a  _dims, x_shape).
-00016680: 2020 2020 7072 696d 616c 5f72 6570 6561      primal_repea
-00016690: 7465 6420 3d20 7265 7374 6f72 655f 7265  ted = restore_re
-000166a0: 6475 6365 645f 6469 6d73 2870 7269 6d61  duced_dims(prima
-000166b0: 6c2c 2072 6564 7563 6564 5f64 696d 732c  l, reduced_dims,
-000166c0: 2078 5f73 6861 7065 290a 2020 2020 6172   x_shape).    ar
-000166d0: 676d 6178 5f6c 6f63 6174 696f 6e73 203d  gmax_locations =
-000166e0: 2078 203d 3d20 7072 696d 616c 5f72 6570   x == primal_rep
-000166f0: 6561 7465 640a 2020 2020 6172 676d 6178  eated.    argmax
-00016700: 5f73 756d 203d 206b 6565 7064 696d 5f72  _sum = keepdim_r
-00016710: 6564 7563 7469 6f6e 2870 7269 6d73 2e73  eduction(prims.s
-00016720: 756d 2c20 6172 676d 6178 5f6c 6f63 6174  um, argmax_locat
-00016730: 696f 6e73 2c20 7265 6475 6365 645f 6469  ions, reduced_di
-00016740: 6d73 290a 2020 2020 6f75 7420 3d20 675f  ms).    out = g_
-00016750: 7265 7065 6174 6564 202a 2061 7267 6d61  repeated * argma
-00016760: 785f 6c6f 6361 7469 6f6e 7320 2f20 6172  x_locations / ar
-00016770: 676d 6178 5f73 756d 0a20 2020 2072 6574  gmax_sum.    ret
-00016780: 7572 6e20 6f75 740a 0a0a 7265 6769 7374  urn out...regist
-00016790: 6572 5f62 6163 6b77 6172 6428 7072 696d  er_backward(prim
-000167a0: 732e 5072 696d 4944 732e 414d 494e 2928  s.PrimIDs.AMIN)(
-000167b0: 6772 6164 5f63 686f 6f73 6572 5f62 6163  grad_chooser_bac
-000167c0: 6b77 6172 6429 0a0a 0a40 7265 6769 7374  kward)...@regist
-000167d0: 6572 5f61 7567 6d65 6e74 6564 5f66 6f72  er_augmented_for
-000167e0: 7761 7264 2870 7269 6d73 2e50 7269 6d49  ward(prims.PrimI
-000167f0: 4473 2e41 4d49 4e29 0a64 6566 2061 6d69  Ds.AMIN).def ami
-00016800: 6e5f 6175 675f 6677 6428 782c 2064 696d  n_aug_fwd(x, dim
-00016810: 7329 3a0a 2020 2020 2222 2241 7567 6d65  s):.    """Augme
-00016820: 6e74 6564 2061 6d69 6e20 6f70 6572 6174  nted amin operat
-00016830: 696f 6e2e 0a20 2020 2041 7267 733a 0a20  ion..    Args:. 
-00016840: 2020 2020 2020 2078 2028 5661 7269 6162         x (Variab
-00016850: 6c65 293a 2054 656e 736f 7220 746f 2063  le): Tensor to c
-00016860: 6f6d 7075 7465 2061 6d69 6e20 6f6e 2e0a  ompute amin on..
-00016870: 2020 2020 2020 2020 6469 6d73 2028 5475          dims (Tu
-00016880: 706c 655b 696e 742c 202e 2e2e 5d29 3a20  ple[int, ...]): 
-00016890: 4469 6d65 6e73 696f 6e73 2074 6f20 636f  Dimensions to co
-000168a0: 6d70 7574 6520 616d 696e 206f 7665 722e  mpute amin over.
-000168b0: 0a20 2020 2052 6574 7572 6e73 3a0a 2020  .    Returns:.  
-000168c0: 2020 2020 2020 564a 5044 7561 6c3a 2050        VJPDual: P
-000168d0: 7269 6d61 6c20 616e 6420 7265 7369 6475  rimal and residu
-000168e0: 616c 732e 0a20 2020 2022 2222 0a20 2020  als..    """.   
-000168f0: 2070 7269 6d61 6c20 3d20 7072 696d 732e   primal = prims.
-00016900: 616d 696e 2878 2c20 6469 6d73 290a 0a20  amin(x, dims).. 
-00016910: 2020 2072 6573 6964 7561 6c73 203d 2028     residuals = (
-00016920: 0a20 2020 2020 2020 2070 7269 6d61 6c2c  .        primal,
-00016930: 0a20 2020 2020 2020 2078 2c0a 2020 2020  .        x,.    
-00016940: 2020 2020 782e 7368 6170 652c 0a20 2020      x.shape,.   
-00016950: 2020 2020 2064 696d 732c 0a20 2020 2029       dims,.    )
-00016960: 0a0a 2020 2020 7265 7475 726e 2056 4a50  ..    return VJP
-00016970: 4475 616c 2870 7269 6d61 6c2c 2072 6573  Dual(primal, res
-00016980: 6964 7561 6c73 290a 0a0a 4072 6567 6973  iduals)...@regis
-00016990: 7465 725f 6175 676d 656e 7465 645f 666f  ter_augmented_fo
-000169a0: 7277 6172 6428 7072 696d 732e 5072 696d  rward(prims.Prim
-000169b0: 4944 732e 504f 5729 0a64 6566 2070 6f77  IDs.POW).def pow
-000169c0: 5f61 7567 5f66 6564 2878 2c20 7929 3a0a  _aug_fed(x, y):.
-000169d0: 2020 2020 2222 2241 7567 6d65 6e74 6564      """Augmented
-000169e0: 2074 6865 2070 6f77 206f 7065 7261 7469   the pow operati
-000169f0: 6f6e 2e0a 0a20 2020 2041 7267 733a 0a20  on...    Args:. 
-00016a00: 2020 2020 2020 2078 2028 5661 7269 6162         x (Variab
-00016a10: 6c65 293a 2054 656e 736f 7220 7769 7468  le): Tensor with
-00016a20: 2074 6865 2062 6173 6520 746f 2062 6520   the base to be 
-00016a30: 6578 706f 6e65 6e74 6961 7465 642e 0a20  exponentiated.. 
-00016a40: 2020 2020 2020 2079 2028 5661 7269 6162         y (Variab
-00016a50: 6c65 293a 2054 656e 736f 7220 7769 7468  le): Tensor with
-00016a60: 2070 6f77 6572 2074 6f20 7261 6973 6520   power to raise 
-00016a70: 746f 2e0a 0a20 2020 2052 6574 7572 6e73  to...    Returns
-00016a80: 3a0a 2020 2020 2020 2020 564a 5044 7561  :.        VJPDua
-00016a90: 6c3a 2050 7269 6d61 6c20 616e 6420 7265  l: Primal and re
-00016aa0: 7369 6475 616c 732e 0a20 2020 2022 2222  siduals..    """
-00016ab0: 0a20 2020 2070 7269 6d61 6c20 3d20 7072  .    primal = pr
-00016ac0: 696d 732e 706f 7728 782c 2079 290a 2020  ims.pow(x, y).  
-00016ad0: 2020 7265 7369 6475 616c 7320 3d20 2870    residuals = (p
-00016ae0: 7269 6d61 6c2c 2078 2c20 7929 0a20 2020  rimal, x, y).   
-00016af0: 2072 6574 7572 6e20 564a 5044 7561 6c28   return VJPDual(
-00016b00: 7072 696d 616c 2c20 7265 7369 6475 616c  primal, residual
-00016b10: 7329 0a0a 0a40 7265 6769 7374 6572 5f62  s)...@register_b
-00016b20: 6163 6b77 6172 6428 7072 696d 732e 5072  ackward(prims.Pr
-00016b30: 696d 4944 732e 504f 5729 0a64 6566 2070  imIDs.POW).def p
-00016b40: 6f77 5f62 6163 6b77 6172 6428 7265 7375  ow_backward(resu
-00016b50: 6c74 2c20 782c 2079 2c20 6729 3a0a 2020  lt, x, y, g):.  
-00016b60: 2020 696d 706f 7274 2074 6875 6e64 6572    import thunder
-00016b70: 2e63 6c61 6e67 2061 7320 746c 616e 670a  .clang as tlang.
-00016b80: 0a20 2020 2067 7265 7375 6c74 203d 2067  .    gresult = g
-00016b90: 202a 2072 6573 756c 7420 2023 2072 6575   * result  # reu
-00016ba0: 7365 2063 6f6d 6d6f 6e20 6661 6374 6f72  se common factor
-00016bb0: 0a20 2020 2064 7820 3d20 6720 2a20 7920  .    dx = g * y 
-00016bc0: 2a20 7820 2a2a 2028 7920 2d20 3129 0a20  * x ** (y - 1). 
-00016bd0: 2020 2064 7920 3d20 6772 6573 756c 7420     dy = gresult 
-00016be0: 2a20 746c 616e 672e 6c6f 6728 7829 0a20  * tlang.log(x). 
-00016bf0: 2020 2072 6574 7572 6e20 6478 2c20 6479     return dx, dy
-00016c00: 0a0a 0a40 7265 6769 7374 6572 5f61 7567  ...@register_aug
-00016c10: 6d65 6e74 6564 5f66 6f72 7761 7264 2870  mented_forward(p
-00016c20: 7269 6d73 2e50 7269 6d49 4473 2e54 414e  rims.PrimIDs.TAN
-00016c30: 290a 6465 6620 7461 6e5f 6175 675f 6677  ).def tan_aug_fw
-00016c40: 6428 7829 3a0a 2020 2020 2222 2241 7567  d(x):.    """Aug
-00016c50: 6d65 6e74 6564 2074 616e 206f 7065 7261  mented tan opera
-00016c60: 7469 6f6e 2e0a 0a20 2020 2041 7267 733a  tion...    Args:
-00016c70: 0a20 2020 2020 2020 2078 2028 5661 7269  .        x (Vari
-00016c80: 6162 6c65 293a 2054 656e 736f 7220 746f  able): Tensor to
-00016c90: 2062 6520 7061 7373 6564 2074 6f20 7461   be passed to ta
-00016ca0: 6e2e 0a20 2020 2022 2222 0a0a 2020 2020  n..    """..    
-00016cb0: 7072 696d 616c 203d 2070 7269 6d73 2e74  primal = prims.t
-00016cc0: 616e 2878 290a 2020 2020 7265 7369 6475  an(x).    residu
-00016cd0: 616c 7320 3d20 2870 7269 6d61 6c2c 290a  als = (primal,).
-00016ce0: 2020 2020 7265 7475 726e 2056 4a50 4475      return VJPDu
-00016cf0: 616c 2870 7269 6d61 6c2c 2072 6573 6964  al(primal, resid
-00016d00: 7561 6c73 290a 0a0a 4072 6567 6973 7465  uals)...@registe
-00016d10: 725f 6261 636b 7761 7264 2870 7269 6d73  r_backward(prims
-00016d20: 2e50 7269 6d49 4473 2e54 414e 290a 6465  .PrimIDs.TAN).de
-00016d30: 6620 7461 6e5f 6261 636b 7761 7264 2872  f tan_backward(r
-00016d40: 6573 756c 742c 2067 293a 0a20 2020 2072  esult, g):.    r
-00016d50: 6574 7572 6e20 6720 2a20 2831 202b 2072  eturn g * (1 + r
-00016d60: 6573 756c 7420 2a20 7265 7375 6c74 290a  esult * result).
-00016d70: 0a0a 2320 4e4f 5445 3a20 4a61 7820 7573  ..# NOTE: Jax us
-00016d80: 6573 206e 702e 6172 6773 6f72 7420 696e  es np.argsort in
-00016d90: 2069 7473 2074 7261 6e73 706f 7365 2076   its transpose v
-00016da0: 6a70 2063 6f6d 7075 7461 7469 6f6e 0a64  jp computation.d
-00016db0: 6566 205f 6172 6773 6f72 7428 7365 7129  ef _argsort(seq)
-00016dc0: 3a0a 2020 2020 7265 7475 726e 2073 6f72  :.    return sor
-00016dd0: 7465 6428 7261 6e67 6528 6c65 6e28 7365  ted(range(len(se
-00016de0: 7129 292c 206b 6579 3d73 6571 2e5f 5f67  q)), key=seq.__g
-00016df0: 6574 6974 656d 5f5f 290a 0a0a 4072 6567  etitem__)...@reg
-00016e00: 6973 7465 725f 6175 676d 656e 7465 645f  ister_augmented_
-00016e10: 666f 7277 6172 6428 7072 696d 732e 5072  forward(prims.Pr
-00016e20: 696d 4944 732e 4445 5649 4345 5f50 5554  imIDs.DEVICE_PUT
-00016e30: 290a 6465 6620 6465 7669 6365 5f70 7574  ).def device_put
-00016e40: 5f61 7567 5f66 7764 2861 3a20 5465 6e73  _aug_fwd(a: Tens
-00016e50: 6f72 5072 6f78 792c 2064 6576 6963 653a  orProxy, device:
-00016e60: 2044 6576 6963 6529 202d 3e20 5465 6e73   Device) -> Tens
-00016e70: 6f72 5072 6f78 793a 0a20 2020 2070 7269  orProxy:.    pri
-00016e80: 6d61 6c20 3d20 7072 696d 732e 6465 7669  mal = prims.devi
-00016e90: 6365 5f70 7574 2861 2c20 6465 7669 6365  ce_put(a, device
-00016ea0: 290a 2020 2020 7265 7369 6475 616c 7320  ).    residuals 
-00016eb0: 3d20 2861 2e64 6576 6963 652c 290a 2020  = (a.device,).  
-00016ec0: 2020 7265 7475 726e 2056 4a50 4475 616c    return VJPDual
-00016ed0: 2870 7269 6d61 6c2c 2072 6573 6964 7561  (primal, residua
-00016ee0: 6c73 290a 0a0a 4072 6567 6973 7465 725f  ls)...@register_
-00016ef0: 6261 636b 7761 7264 2870 7269 6d73 2e50  backward(prims.P
-00016f00: 7269 6d49 4473 2e44 4556 4943 455f 5055  rimIDs.DEVICE_PU
-00016f10: 5429 0a64 6566 2064 6576 6963 655f 7075  T).def device_pu
-00016f20: 745f 6261 636b 7761 7264 286f 7269 675f  t_backward(orig_
-00016f30: 6465 7669 6365 2c20 6729 3a0a 2020 2020  device, g):.    
-00016f40: 7265 7475 726e 2070 7269 6d73 2e64 6576  return prims.dev
-00016f50: 6963 655f 7075 7428 672c 206f 7269 675f  ice_put(g, orig_
-00016f60: 6465 7669 6365 292c 204e 6f6e 650a 0a0a  device), None...
-00016f70: 4072 6567 6973 7465 725f 6175 676d 656e  @register_augmen
-00016f80: 7465 645f 666f 7277 6172 6428 7072 696d  ted_forward(prim
-00016f90: 732e 5072 696d 4944 732e 434f 4e56 4f4c  s.PrimIDs.CONVOL
-00016fa0: 5554 494f 4e29 0a64 6566 2063 6f6e 766f  UTION).def convo
-00016fb0: 6c75 7469 6f6e 5f61 7567 5f66 7764 280a  lution_aug_fwd(.
-00016fc0: 2020 2020 613a 2050 726f 7879 2c0a 2020      a: Proxy,.  
-00016fd0: 2020 7765 6967 6874 2c0a 2020 2020 6269    weight,.    bi
-00016fe0: 6173 2c0a 2020 2020 7374 7269 6465 2c0a  as,.    stride,.
-00016ff0: 2020 2020 7061 6464 696e 672c 0a20 2020      padding,.   
-00017000: 2064 696c 6174 696f 6e2c 0a20 2020 2074   dilation,.    t
-00017010: 7261 6e73 706f 7365 642c 0a20 2020 206f  ransposed,.    o
-00017020: 7574 7075 745f 7061 6464 696e 672c 0a20  utput_padding,. 
-00017030: 2020 2067 726f 7570 732c 0a29 3a0a 2020     groups,.):.  
-00017040: 2020 7072 696d 616c 203d 2063 6f6e 766f    primal = convo
-00017050: 6c75 7469 6f6e 2861 2c20 7765 6967 6874  lution(a, weight
-00017060: 2c20 6269 6173 2c20 7374 7269 6465 2c20  , bias, stride, 
-00017070: 7061 6464 696e 672c 2064 696c 6174 696f  padding, dilatio
-00017080: 6e2c 2074 7261 6e73 706f 7365 642c 206f  n, transposed, o
-00017090: 7574 7075 745f 7061 6464 696e 672c 2067  utput_padding, g
-000170a0: 726f 7570 7329 0a20 2020 2072 6573 6964  roups).    resid
-000170b0: 7561 6c73 203d 2028 7072 696d 616c 2c20  uals = (primal, 
-000170c0: 612c 2077 6569 6768 742c 2062 6961 732c  a, weight, bias,
-000170d0: 2073 7472 6964 652c 2070 6164 6469 6e67   stride, padding
-000170e0: 2c20 6469 6c61 7469 6f6e 2c20 7472 616e  , dilation, tran
-000170f0: 7370 6f73 6564 2c20 6f75 7470 7574 5f70  sposed, output_p
-00017100: 6164 6469 6e67 2c20 6772 6f75 7073 290a  adding, groups).
-00017110: 2020 2020 7265 7475 726e 2056 4a50 4475      return VJPDu
-00017120: 616c 2870 7269 6d61 6c2c 2072 6573 6964  al(primal, resid
-00017130: 7561 6c73 290a 0a0a 4072 6567 6973 7465  uals)...@registe
-00017140: 725f 6261 636b 7761 7264 2870 7269 6d73  r_backward(prims
-00017150: 2e50 7269 6d49 4473 2e43 4f4e 564f 4c55  .PrimIDs.CONVOLU
-00017160: 5449 4f4e 290a 6465 6620 636f 6e76 6f6c  TION).def convol
-00017170: 7574 696f 6e5f 6261 636b 7761 7264 280a  ution_backward(.
-00017180: 2020 2020 6f75 7470 7574 3a20 5072 6f78      output: Prox
-00017190: 792c 0a20 2020 2069 6e70 7574 3a20 5072  y,.    input: Pr
-000171a0: 6f78 792c 0a20 2020 2077 6569 6768 742c  oxy,.    weight,
-000171b0: 0a20 2020 2062 6961 732c 0a20 2020 2073  .    bias,.    s
-000171c0: 7472 6964 652c 0a20 2020 2070 6164 6469  tride,.    paddi
-000171d0: 6e67 2c0a 2020 2020 6469 6c61 7469 6f6e  ng,.    dilation
-000171e0: 2c0a 2020 2020 7472 616e 7370 6f73 6564  ,.    transposed
-000171f0: 2c0a 2020 2020 6f75 7470 7574 5f70 6164  ,.    output_pad
-00017200: 6469 6e67 2c0a 2020 2020 6772 6f75 7073  ding,.    groups
-00017210: 2c0a 2020 2020 6772 6164 2c0a 293a 0a20  ,.    grad,.):. 
-00017220: 2020 2023 2054 7261 6e73 706f 7365 6420     # Transposed 
-00017230: 636f 6e76 6f6c 7574 696f 6e20 6973 206e  convolution is n
-00017240: 6f74 2073 7570 706f 7274 6564 210a 2020  ot supported!.  
-00017250: 2020 6173 7365 7274 2074 7261 6e73 706f    assert transpo
-00017260: 7365 6420 3d3d 2030 0a0a 2020 2020 696e  sed == 0..    in
-00017270: 7075 745f 6772 6164 203d 204e 6f6e 650a  put_grad = None.
-00017280: 2020 2020 7765 6967 6874 5f67 7261 6420      weight_grad 
-00017290: 3d20 4e6f 6e65 0a20 2020 2062 6961 735f  = None.    bias_
-000172a0: 6772 6164 203d 204e 6f6e 650a 0a20 2020  grad = None..   
-000172b0: 2023 2053 686f 7274 2063 6972 6375 6974   # Short circuit
-000172c0: 206f 6e20 7a65 726f 2d64 696d 2067 7261   on zero-dim gra
-000172d0: 640a 2020 2020 6966 2061 6e79 2873 203d  d.    if any(s =
-000172e0: 3d20 3020 666f 7220 7320 696e 2067 7261  = 0 for s in gra
-000172f0: 642e 7368 6170 6529 3a0a 2020 2020 2020  d.shape):.      
-00017300: 2020 696e 7075 745f 6772 6164 203d 2066    input_grad = f
-00017310: 756c 6c5f 6c69 6b65 2869 6e70 7574 2c20  ull_like(input, 
-00017320: 6669 6c6c 5f76 616c 7565 3d30 290a 2020  fill_value=0).  
-00017330: 2020 2020 2020 7765 6967 6874 5f67 7261        weight_gra
-00017340: 6420 3d20 6675 6c6c 5f6c 696b 6528 7765  d = full_like(we
-00017350: 6967 6874 2c20 6669 6c6c 5f76 616c 7565  ight, fill_value
-00017360: 3d30 290a 2020 2020 2020 2020 6966 2062  =0).        if b
-00017370: 6961 7320 6973 206e 6f74 204e 6f6e 653a  ias is not None:
-00017380: 0a20 2020 2020 2020 2020 2020 2062 6961  .            bia
-00017390: 735f 6772 6164 203d 2066 756c 6c5f 6c69  s_grad = full_li
-000173a0: 6b65 2862 6961 732c 2066 696c 6c5f 7661  ke(bias, fill_va
-000173b0: 6c75 653d 3029 0a20 2020 2020 2020 2072  lue=0).        r
-000173c0: 6574 7572 6e20 2869 6e70 7574 5f67 7261  eturn (input_gra
-000173d0: 642c 2077 6569 6768 745f 6772 6164 2c20  d, weight_grad, 
-000173e0: 6269 6173 5f67 7261 6429 202b 2028 284e  bias_grad) + ((N
-000173f0: 6f6e 652c 2920 2a20 3629 0a0a 2020 2020  one,) * 6)..    
-00017400: 6261 7463 682c 2069 6e5f 6368 616e 6e65  batch, in_channe
-00017410: 6c73 2c20 2a73 7061 7469 616c 5f64 696d  ls, *spatial_dim
-00017420: 7320 3d20 696e 7075 742e 7368 6170 650a  s = input.shape.
-00017430: 2020 2020 6f75 745f 6368 616e 6e65 6c73      out_channels
-00017440: 2c20 6769 6e5f 6368 616e 6e65 6c73 2c20  , gin_channels, 
-00017450: 2a6b 6572 6e65 6c5f 6469 6d73 203d 2077  *kernel_dims = w
-00017460: 6569 6768 742e 7368 6170 650a 2020 2020  eight.shape.    
-00017470: 6469 6d20 3d20 6c65 6e28 7370 6174 6961  dim = len(spatia
-00017480: 6c5f 6469 6d73 290a 0a20 2020 2064 6566  l_dims)..    def
-00017490: 206d 6179 6265 5f65 7870 616e 645f 7365   maybe_expand_se
-000174a0: 7128 732c 2064 696d 293a 0a20 2020 2020  q(s, dim):.     
-000174b0: 2020 2069 6620 6c65 6e28 7329 203d 3d20     if len(s) == 
-000174c0: 313a 0a20 2020 2020 2020 2020 2020 2072  1:.            r
-000174d0: 6574 7572 6e20 2873 5b30 5d2c 2920 2a20  eturn (s[0],) * 
-000174e0: 6469 6d0a 2020 2020 2020 2020 656c 7365  dim.        else
-000174f0: 3a0a 2020 2020 2020 2020 2020 2020 7265  :.            re
-00017500: 7475 726e 2073 0a0a 2020 2020 7374 7269  turn s..    stri
-00017510: 6465 203d 206d 6179 6265 5f65 7870 616e  de = maybe_expan
-00017520: 645f 7365 7128 7374 7269 6465 2c20 6469  d_seq(stride, di
-00017530: 6d29 0a20 2020 2070 6164 6469 6e67 203d  m).    padding =
-00017540: 206d 6179 6265 5f65 7870 616e 645f 7365   maybe_expand_se
-00017550: 7128 7061 6464 696e 672c 2064 696d 290a  q(padding, dim).
-00017560: 2020 2020 6469 6c61 7469 6f6e 203d 206d      dilation = m
-00017570: 6179 6265 5f65 7870 616e 645f 7365 7128  aybe_expand_seq(
-00017580: 6469 6c61 7469 6f6e 2c20 6469 6d29 0a0a  dilation, dim)..
-00017590: 2020 2020 6465 6620 636f 6e76 5f74 7261      def conv_tra
-000175a0: 6e73 706f 7365 2874 293a 0a20 2020 2020  nspose(t):.     
-000175b0: 2020 2072 6574 7572 6e20 7072 696d 732e     return prims.
-000175c0: 7472 616e 7370 6f73 6528 742c 2028 312c  transpose(t, (1,
-000175d0: 2030 2920 2b20 7475 706c 6528 7261 6e67   0) + tuple(rang
-000175e0: 6528 322c 2074 2e6e 6469 6d29 2929 0a0a  e(2, t.ndim)))..
-000175f0: 2020 2020 2320 696e 7075 745f 6772 6164      # input_grad
-00017600: 203d 207b 0a20 2020 2064 6566 2074 7261   = {.    def tra
-00017610: 6e73 706f 7365 5f61 6e64 5f66 6c69 705f  nspose_and_flip_
-00017620: 7765 6967 6874 2877 6569 6768 7429 3a0a  weight(weight):.
-00017630: 2020 2020 2020 2020 2320 5468 6520 6c69          # The li
-00017640: 6e65 7320 6265 6c6f 7720 6172 6520 7472  nes below are tr
-00017650: 616e 7370 6f73 696e 6720 7468 6520 6368  ansposing the ch
-00017660: 616e 6e65 6c73 2064 696d 732e 0a20 2020  annels dims..   
-00017670: 2020 2020 2023 2057 6520 616c 736f 206e       # We also n
-00017680: 6565 6420 746f 2065 7874 7261 6374 2074  eed to extract t
-00017690: 6865 2067 726f 7570 2069 6e66 6f72 6d61  he group informa
-000176a0: 7469 6f6e 2061 6e64 206d 6572 6765 2069  tion and merge i
-000176b0: 740a 2020 2020 2020 2020 2320 7769 7468  t.        # with
-000176c0: 2074 6865 2064 696d 656e 7369 6f6e 2063   the dimension c
-000176d0: 6f72 7265 7370 6f6e 6469 6e67 2074 6f20  orresponding to 
-000176e0: 7468 6520 226f 7574 5f63 6861 6e6e 656c  the "out_channel
-000176f0: 7322 2064 696d 2e0a 2020 2020 2020 2020  s" dim..        
-00017700: 2320 286f 7574 5f63 6861 6e6e 656c 732c  # (out_channels,
-00017710: 2067 696e 5f63 6861 6e6e 656c 7329 202d   gin_channels) -
-00017720: 3e20 2867 696e 5f63 6861 6e6e 656c 732c  > (gin_channels,
-00017730: 206f 7574 5f63 6861 6e6e 656c 7329 0a20   out_channels). 
-00017740: 2020 2020 2020 2077 6569 6768 7420 3d20         weight = 
-00017750: 636f 6e76 5f74 7261 6e73 706f 7365 2877  conv_transpose(w
-00017760: 6569 6768 7429 0a20 2020 2020 2020 2023  eight).        #
-00017770: 2053 706c 6974 2028 6f75 745f 6368 616e   Split (out_chan
-00017780: 6e65 6c73 2c29 202d 3e20 2867 726f 7570  nels,) -> (group
-00017790: 732c 206f 7574 5f63 6861 6e6e 656c 7320  s, out_channels 
-000177a0: 2f2f 2067 726f 7570 7329 0a20 2020 2020  // groups).     
-000177b0: 2020 2077 6569 6768 7420 3d20 7765 6967     weight = weig
-000177c0: 6874 2e72 6573 6861 7065 285b 6769 6e5f  ht.reshape([gin_
-000177d0: 6368 616e 6e65 6c73 2c20 6772 6f75 7073  channels, groups
-000177e0: 2c20 6f75 745f 6368 616e 6e65 6c73 202f  , out_channels /
-000177f0: 2f20 6772 6f75 7073 5d20 2b20 6b65 726e  / groups] + kern
-00017800: 656c 5f64 696d 7329 0a20 2020 2020 2020  el_dims).       
-00017810: 2023 204d 6f76 696e 6720 6772 6f75 7073   # Moving groups
-00017820: 2074 6f20 7468 6520 6c65 6674 2d6d 6f73   to the left-mos
-00017830: 7420 706f 7369 7469 6f6e 2e0a 2020 2020  t position..    
-00017840: 2020 2020 2320 2867 696e 5f63 6861 6e6e      # (gin_chann
-00017850: 656c 732c 2067 726f 7570 732c 206f 7574  els, groups, out
-00017860: 5f63 6861 6e6e 656c 7320 2f2f 2067 726f  _channels // gro
-00017870: 7570 7329 202d 3e20 2867 726f 7570 732c  ups) -> (groups,
-00017880: 2067 696e 5f63 6861 6e6e 656c 732c 206f   gin_channels, o
-00017890: 7574 5f63 6861 6e6e 656c 7320 2f2f 2067  ut_channels // g
-000178a0: 726f 7570 7329 0a20 2020 2020 2020 2077  roups).        w
-000178b0: 6569 6768 7420 3d20 636f 6e76 5f74 7261  eight = conv_tra
-000178c0: 6e73 706f 7365 2877 6569 6768 7429 0a20  nspose(weight). 
-000178d0: 2020 2020 2020 2023 2053 7175 6173 6820         # Squash 
-000178e0: 2867 726f 7570 732c 2067 696e 5f63 6861  (groups, gin_cha
-000178f0: 6e6e 656c 7329 202d 3e20 2869 6e5f 6368  nnels) -> (in_ch
-00017900: 616e 6e65 6c73 290a 2020 2020 2020 2020  annels).        
-00017910: 7765 6967 6874 203d 2077 6569 6768 742e  weight = weight.
-00017920: 7265 7368 6170 6528 5b69 6e5f 6368 616e  reshape([in_chan
-00017930: 6e65 6c73 2c20 6f75 745f 6368 616e 6e65  nels, out_channe
-00017940: 6c73 202f 2f20 6772 6f75 7073 5d20 2b20  ls // groups] + 
-00017950: 6b65 726e 656c 5f64 696d 7329 0a0a 2020  kernel_dims)..  
-00017960: 2020 2020 2020 2320 466c 6970 2073 7061        # Flip spa
-00017970: 7469 616c 2064 696d 656e 7369 6f6e 730a  tial dimensions.
-00017980: 2020 2020 2020 2020 7765 6967 6874 203d          weight =
-00017990: 2070 7269 6d73 2e66 6c69 7028 7765 6967   prims.flip(weig
-000179a0: 6874 2c20 7475 706c 6528 7261 6e67 6528  ht, tuple(range(
-000179b0: 322c 2077 6569 6768 742e 6e64 696d 2929  2, weight.ndim))
-000179c0: 290a 2020 2020 2020 2020 7265 7475 726e  ).        return
-000179d0: 2077 6569 6768 740a 0a20 2020 2023 2057   weight..    # W
-000179e0: 6520 6e65 6564 2074 6f20 7061 6420 7468  e need to pad th
-000179f0: 6520 6772 6164 6965 6e74 2074 6f20 6265  e gradient to be
-00017a00: 2061 626c 6520 746f 2066 6974 206b 6572   able to fit ker
-00017a10: 6e65 6c20 7769 6e64 6f77 732e 0a20 2020  nel windows..   
-00017a20: 2069 6e69 7469 616c 5f67 7261 645f 7061   initial_grad_pa
-00017a30: 6464 696e 6720 3d20 5b64 202a 2028 6b20  dding = [d * (k 
-00017a40: 2d20 3129 2066 6f72 2064 2c20 6b20 696e  - 1) for d, k in
-00017a50: 207a 6970 2864 696c 6174 696f 6e2c 206b   zip(dilation, k
-00017a60: 6572 6e65 6c5f 6469 6d73 295d 0a0a 2020  ernel_dims)]..  
-00017a70: 2020 696e 7075 745f 6772 6164 203d 2063    input_grad = c
-00017a80: 6f6e 766f 6c75 7469 6f6e 280a 2020 2020  onvolution(.    
-00017a90: 2020 2020 7072 696d 732e 7061 6428 0a20      prims.pad(. 
-00017aa0: 2020 2020 2020 2020 2020 2067 7261 642c             grad,
-00017ab0: 0a20 2020 2020 2020 2020 2020 2030 2e30  .            0.0
-00017ac0: 2c0a 2020 2020 2020 2020 2020 2020 2320  ,.            # 
-00017ad0: 5468 6520 7069 7865 7320 6172 6520 7374  The pixes are st
-00017ae0: 7269 6465 2061 7761 7920 6672 6f6d 2065  ride away from e
-00017af0: 6163 6820 6f74 6865 7220 696e 2074 6865  ach other in the
-00017b00: 206f 7269 6769 6e61 6c20 696e 7075 742e   original input.
-00017b10: 0a20 2020 2020 2020 2020 2020 2023 2048  .            # H
-00017b20: 656e 6365 2077 6520 6e65 6564 2074 6f20  ence we need to 
-00017b30: 6469 6c61 7465 2074 6865 2067 7261 6469  dilate the gradi
-00017b40: 656e 7420 6279 2064 696c 6174 696f 6e3d  ent by dilation=
-00017b50: 7374 7269 6465 202d 2031 0a20 2020 2020  stride - 1.     
-00017b60: 2020 2020 2020 2023 2073 6f20 7468 6174         # so that
-00017b70: 2074 6865 7265 2061 7265 2073 7472 6964   there are strid
-00017b80: 6520 2d20 3120 7a65 726f 7320 6265 7477  e - 1 zeros betw
-00017b90: 6565 6e20 7468 6520 7069 7865 6c73 2e0a  een the pixels..
-00017ba0: 2020 2020 2020 2020 2020 2020 5b28 302c              [(0,
-00017bb0: 2030 2c20 3029 2c20 2830 2c20 302c 2030   0, 0), (0, 0, 0
-00017bc0: 295d 202b 205b 2830 2c20 302c 2073 202d  )] + [(0, 0, s -
-00017bd0: 2031 2920 666f 7220 7320 696e 2073 7472   1) for s in str
-00017be0: 6964 655d 2c0a 2020 2020 2020 2020 292c  ide],.        ),
-00017bf0: 0a20 2020 2020 2020 2074 7261 6e73 706f  .        transpo
-00017c00: 7365 5f61 6e64 5f66 6c69 705f 7765 6967  se_and_flip_weig
-00017c10: 6874 2877 6569 6768 7429 2c0a 2020 2020  ht(weight),.    
-00017c20: 2020 2020 4e6f 6e65 2c0a 2020 2020 2020      None,.      
-00017c30: 2020 2320 5365 7474 696e 6720 7374 7269    # Setting stri
-00017c40: 6465 2074 6f20 3120 6173 2074 6865 2064  de to 1 as the d
-00017c50: 6973 7461 6e63 6520 6265 7477 6565 6e20  istance between 
-00017c60: 7069 7865 6c73 2069 7320 7461 6b65 6e0a  pixels is taken.
-00017c70: 2020 2020 2020 2020 2320 6361 7265 2062          # care b
-00017c80: 7920 7468 6520 7061 6420 7269 6768 7420  y the pad right 
-00017c90: 6162 6f76 652e 0a20 2020 2020 2020 2028  above..        (
-00017ca0: 312c 292c 0a20 2020 2020 2020 2069 6e69  1,),.        ini
-00017cb0: 7469 616c 5f67 7261 645f 7061 6464 696e  tial_grad_paddin
-00017cc0: 672c 0a20 2020 2020 2020 2064 696c 6174  g,.        dilat
-00017cd0: 696f 6e2c 0a20 2020 2020 2020 2074 7261  ion,.        tra
-00017ce0: 6e73 706f 7365 642c 0a20 2020 2020 2020  nsposed,.       
-00017cf0: 206f 7574 7075 745f 7061 6464 696e 672c   output_padding,
-00017d00: 0a20 2020 2020 2020 2067 726f 7570 732c  .        groups,
-00017d10: 0a20 2020 2029 0a0a 2020 2020 6465 6620  .    )..    def 
-00017d20: 7061 645f 746f 5f69 6e70 7574 2867 7261  pad_to_input(gra
-00017d30: 6429 3a0a 2020 2020 2020 2020 2320 5765  d):.        # We
-00017d40: 206e 6565 6420 746f 2075 6e70 6164 2074   need to unpad t
-00017d50: 6865 2070 6164 6469 6e67 2064 6f6e 6520  he padding done 
-00017d60: 746f 2074 6865 2069 6e70 7574 2070 7269  to the input pri
-00017d70: 6f72 2074 6f20 7468 6520 636f 6e76 6f6c  or to the convol
-00017d80: 7574 696f 6e2e 0a20 2020 2020 2020 2023  ution..        #
-00017d90: 204e 6f74 6520 7468 6174 206c 6f77 2061   Note that low a
-00017da0: 6e64 2068 6967 6820 7061 6464 696e 6720  nd high padding 
-00017db0: 6172 6520 6e6f 7420 6e65 6365 7373 6172  are not necessar
-00017dc0: 696c 7920 6571 7561 6c2c 2073 6f20 7765  ily equal, so we
-00017dd0: 2063 616e 6e6f 740a 2020 2020 2020 2020   cannot.        
-00017de0: 2320 6162 736f 7262 2069 7420 696e 746f  # absorb it into
-00017df0: 2074 6865 2063 6f6e 766f 6c75 7469 6f6e   the convolution
-00017e00: 206a 7573 7420 7965 742c 2075 6e6c 6573   just yet, unles
-00017e10: 7320 7468 6520 4150 4920 6973 206d 6f64  s the API is mod
-00017e20: 6966 6965 642e 0a20 2020 2020 2020 2070  ified..        p
-00017e30: 6164 5f63 6f6e 6669 6720 3d20 5b28 302c  ad_config = [(0,
-00017e40: 2030 2c20 3029 2c20 2830 2c20 302c 2030   0, 0), (0, 0, 0
-00017e50: 295d 0a20 2020 2020 2020 2066 6f72 206f  )].        for o
-00017e60: 2c20 692c 2067 2c20 7020 696e 207a 6970  , i, g, p in zip
-00017e70: 2867 7261 642e 7368 6170 655b 323a 5d2c  (grad.shape[2:],
-00017e80: 2073 7061 7469 616c 5f64 696d 732c 2069   spatial_dims, i
-00017e90: 6e70 7574 5f67 7261 642e 7368 6170 655b  nput_grad.shape[
-00017ea0: 323a 5d2c 2070 6164 6469 6e67 293a 0a20  2:], padding):. 
-00017eb0: 2020 2020 2020 2020 2020 206c 6f20 3d20             lo = 
-00017ec0: 2d70 0a20 2020 2020 2020 2020 2020 2023  -p.            #
-00017ed0: 204e 6f74 6520 7468 6174 2028 6920 2b20   Note that (i + 
-00017ee0: 3220 2a20 7029 2069 7320 7468 6520 7369  2 * p) is the si
-00017ef0: 7a65 206f 6620 7468 6520 7061 6464 6564  ze of the padded
-00017f00: 2069 6e70 7574 2c0a 2020 2020 2020 2020   input,.        
-00017f10: 2020 2020 2320 736f 2074 6865 2071 7561      # so the qua
-00017f20: 6e74 6974 7920 2869 202b 2032 202a 2070  ntity (i + 2 * p
-00017f30: 2920 2d20 6720 7465 6c6c 7320 7573 2062  ) - g tells us b
-00017f40: 7920 686f 7720 6d75 6368 0a20 2020 2020  y how much.     
-00017f50: 2020 2020 2020 2023 2077 6520 6e65 6564         # we need
-00017f60: 2074 6f20 7061 6420 7468 6520 6772 6164   to pad the grad
-00017f70: 6965 6e74 2073 6f20 7468 6174 2074 6865  ient so that the
-00017f80: 2065 6c65 6d65 6e74 7320 6f75 7473 6964   elements outsid
-00017f90: 650a 2020 2020 2020 2020 2020 2020 2320  e.            # 
-00017fa0: 6f66 2074 6865 2063 6f6e 766f 6c75 7469  of the convoluti
-00017fb0: 6f6e 2072 6563 6569 7665 207a 6572 6f20  on receive zero 
-00017fc0: 6772 6164 6965 6e74 2e0a 2020 2020 2020  gradient..      
-00017fd0: 2020 2020 2020 2320 7020 6973 2061 6464        # p is add
-00017fe0: 6974 696f 6e61 6c6c 7920 7375 6274 7261  itionally subtra
-00017ff0: 6374 6564 2074 6f20 6e65 6761 7465 2074  cted to negate t
-00018000: 6865 2069 6e70 7574 2773 2070 6164 0a20  he input's pad. 
-00018010: 2020 2020 2020 2020 2020 2023 2069 6e20             # in 
-00018020: 666f 7277 6172 642e 0a20 2020 2020 2020  forward..       
-00018030: 2020 2020 2068 6920 3d20 2869 202b 2032       hi = (i + 2
-00018040: 202a 2070 2920 2d20 6720 2d20 700a 2020   * p) - g - p.  
-00018050: 2020 2020 2020 2020 2020 7061 645f 636f            pad_co
-00018060: 6e66 6967 2e61 7070 656e 6428 286c 6f2c  nfig.append((lo,
-00018070: 2068 692c 2030 2929 0a20 2020 2020 2020   hi, 0)).       
-00018080: 2072 6574 7572 6e20 7072 696d 732e 7061   return prims.pa
-00018090: 6428 6772 6164 2c20 302e 302c 2070 6164  d(grad, 0.0, pad
-000180a0: 5f63 6f6e 6669 6729 0a0a 2020 2020 696e  _config)..    in
-000180b0: 7075 745f 6772 6164 203d 2070 6164 5f74  put_grad = pad_t
-000180c0: 6f5f 696e 7075 7428 696e 7075 745f 6772  o_input(input_gr
-000180d0: 6164 290a 2020 2020 2320 7d0a 0a20 2020  ad).    # }..   
-000180e0: 2023 2062 6961 735f 6772 6164 203d 207b   # bias_grad = {
-000180f0: 0a20 2020 2069 6620 6269 6173 2069 7320  .    if bias is 
-00018100: 6e6f 7420 4e6f 6e65 3a0a 2020 2020 2020  not None:.      
-00018110: 2020 696d 706f 7274 2074 6875 6e64 6572    import thunder
-00018120: 2e74 6f72 6368 2061 7320 6c74 6f72 6368  .torch as ltorch
-00018130: 0a0a 2020 2020 2020 2020 6269 6173 5f67  ..        bias_g
-00018140: 7261 6420 3d20 6c74 6f72 6368 2e73 756d  rad = ltorch.sum
-00018150: 2867 7261 642c 205b 6420 666f 7220 6420  (grad, [d for d 
-00018160: 696e 2072 616e 6765 2867 7261 642e 6e64  in range(grad.nd
-00018170: 696d 2920 6966 2064 2021 3d20 315d 290a  im) if d != 1]).
-00018180: 2020 2020 2320 7d0a 0a20 2020 2023 2077      # }..    # w
-00018190: 6569 6768 7420 6772 6164 203d 207b 0a20  eight grad = {. 
-000181a0: 2020 2064 6566 2070 6164 5f74 7261 6e73     def pad_trans
-000181b0: 706f 7365 5f61 6e64 5f70 7573 685f 6772  pose_and_push_gr
-000181c0: 6f75 7073 5f69 6e74 6f5f 6261 7463 6865  oups_into_batche
-000181d0: 7328 7429 3a0a 2020 2020 2020 2020 2320  s(t):.        # 
-000181e0: 4669 7273 7420 7061 642c 2e2e 2e0a 2020  First pad,....  
-000181f0: 2020 2020 2020 2320 5061 6420 6173 206e        # Pad as n
-00018200: 6563 6573 7361 7279 2073 6f20 7468 6174  ecessary so that
-00018210: 2069 6e20 636f 6e76 6f6c 7574 696f 6e73   in convolutions
-00018220: 2077 6520 6e65 7665 7220 6164 7661 6e63   we never advanc
-00018230: 650a 2020 2020 2020 2020 2320 7061 7374  e.        # past
-00018240: 2072 656c 6576 616e 7420 696e 7075 7473   relevant inputs
-00018250: 2e0a 2020 2020 2020 2020 7061 645f 636f  ..        pad_co
-00018260: 6e66 6967 203d 205b 2830 2c20 302c 2030  nfig = [(0, 0, 0
-00018270: 292c 2028 302c 2030 2c20 3029 5d0a 2020  ), (0, 0, 0)].  
-00018280: 2020 2020 2020 666f 7220 6f2c 2069 2c20        for o, i, 
-00018290: 6b2c 2070 2c20 732c 2064 2069 6e20 7a69  k, p, s, d in zi
-000182a0: 7028 6772 6164 2e73 6861 7065 5b32 3a5d  p(grad.shape[2:]
-000182b0: 2c20 7370 6174 6961 6c5f 6469 6d73 2c20  , spatial_dims, 
-000182c0: 6b65 726e 656c 5f64 696d 732c 2070 6164  kernel_dims, pad
-000182d0: 6469 6e67 2c20 7374 7269 6465 2c20 6469  ding, stride, di
-000182e0: 6c61 7469 6f6e 293a 0a20 2020 2020 2020  lation):.       
-000182f0: 2020 2020 2023 2050 6164 6469 6e67 2066       # Padding f
-00018300: 726f 6d20 6265 6c6f 7720 6973 2074 6865  rom below is the
-00018310: 2073 616d 652e 0a20 2020 2020 2020 2020   same..         
-00018320: 2020 206c 6f20 3d20 700a 2020 2020 2020     lo = p.      
-00018330: 2020 2020 2020 2320 5468 6572 6520 6973        # There is
-00018340: 2061 6c77 6179 7320 7468 6520 6d61 7820   always the max 
-00018350: 696e 6465 7820 6964 7820 696e 2074 6865  index idx in the
-00018360: 2069 6e70 7574 0a20 2020 2020 2020 2020   input.         
-00018370: 2020 2023 2074 6865 2076 616c 7565 206f     # the value o
-00018380: 6620 7768 6963 682c 2069 6e70 7574 5b69  f which, input[i
-00018390: 6478 5d2c 2074 6865 206b 6572 6e65 6c20  dx], the kernel 
-000183a0: 746f 7563 6865 732e 0a20 2020 2020 2020  touches..       
-000183b0: 2020 2020 2023 2054 6865 206b 6572 6e65       # The kerne
-000183c0: 6c20 7265 6163 682c 206f 7220 6b5f 7265  l reach, or k_re
-000183d0: 6163 682c 2069 7320 6578 6163 746c 7920  ach, is exactly 
-000183e0: 6964 7820 2b20 312e 0a20 2020 2020 2020  idx + 1..       
-000183f0: 2020 2020 2023 2057 6520 7573 6520 6974       # We use it
-00018400: 2074 6f20 6465 6369 6465 2062 7920 686f   to decide by ho
-00018410: 7720 6d75 6368 2077 6520 6e65 6564 2074  w much we need t
-00018420: 6f20 7061 6420 6672 6f6d 2061 626f 7665  o pad from above
-00018430: 0a20 2020 2020 2020 2020 2020 2023 2061  .            # a
-00018440: 7320 746f 206e 6f74 206d 6f76 6520 7061  s to not move pa
-00018450: 7374 2072 656c 6576 616e 7420 7661 6c75  st relevant valu
-00018460: 6573 2e0a 2020 2020 2020 2020 2020 2020  es..            
-00018470: 6b5f 7265 6163 6820 3d20 286f 202d 2031  k_reach = (o - 1
-00018480: 2920 2a20 7320 2b20 6420 2a20 286b 202d  ) * s + d * (k -
-00018490: 2031 2920 2b20 310a 2020 2020 2020 2020   1) + 1.        
-000184a0: 2020 2020 2320 5468 6520 7061 6420 6672      # The pad fr
-000184b0: 6f6d 2061 626f 7665 2065 7175 616c 7320  om above equals 
-000184c0: 6b5f 7265 6163 6820 6d69 6e75 7320 7468  k_reach minus th
-000184d0: 6520 6c65 6e67 7468 0a20 2020 2020 2020  e length.       
-000184e0: 2020 2020 2023 206f 6620 7468 6520 696e       # of the in
-000184f0: 7075 7420 7061 6464 6564 2066 726f 6d20  put padded from 
-00018500: 6265 6c6f 772e 0a20 2020 2020 2020 2020  below..         
-00018510: 2020 2068 6920 3d20 6b5f 7265 6163 6820     hi = k_reach 
-00018520: 2d20 2869 202b 2070 290a 2020 2020 2020  - (i + p).      
-00018530: 2020 2020 2020 7061 645f 636f 6e66 6967        pad_config
-00018540: 2e61 7070 656e 6428 286c 6f2c 2068 692c  .append((lo, hi,
-00018550: 2030 2929 0a20 2020 2020 2020 2074 203d   0)).        t =
-00018560: 2070 7269 6d73 2e70 6164 2874 2c20 302e   prims.pad(t, 0.
-00018570: 302c 2070 6164 5f63 6f6e 6669 6729 0a0a  0, pad_config)..
-00018580: 2020 2020 2020 2020 5f2c 205f 2c20 2a74          _, _, *t
-00018590: 5f73 7061 7469 616c 5f64 696d 7320 3d20  _spatial_dims = 
-000185a0: 742e 7368 6170 650a 0a20 2020 2020 2020  t.shape..       
-000185b0: 2023 202e 2e2e 2074 6865 6e20 646f 2074   # ... then do t
-000185c0: 6865 2072 6573 742e 0a20 2020 2020 2020  he rest..       
-000185d0: 2023 2074 2e73 6861 7065 203d 3d20 2862   # t.shape == (b
-000185e0: 6174 6368 2c20 696e 5f63 6861 6e6e 656c  atch, in_channel
-000185f0: 732c 202e 2e2e 290a 2020 2020 2020 2020  s, ...).        
-00018600: 2320 5468 6520 7265 7375 6c74 206f 6620  # The result of 
-00018610: 7468 6973 2066 756e 6374 696f 6e20 6861  this function ha
-00018620: 7320 7368 6170 650a 2020 2020 2020 2020  s shape.        
-00018630: 2320 2869 6e5f 6368 616e 6e65 6c73 2c20  # (in_channels, 
-00018640: 6261 7463 6820 2a20 6772 6f75 7073 290a  batch * groups).
-00018650: 2020 2020 2020 2020 2320 2862 6174 6368          # (batch
-00018660: 2c20 696e 5f63 6861 6e6e 656c 7329 202d  , in_channels) -
-00018670: 3e20 2869 6e5f 6368 616e 6e65 6c73 2c20  > (in_channels, 
-00018680: 6261 7463 6829 0a20 2020 2020 2020 2074  batch).        t
-00018690: 203d 2063 6f6e 765f 7472 616e 7370 6f73   = conv_transpos
-000186a0: 6528 7429 0a20 2020 2020 2020 2023 2053  e(t).        # S
-000186b0: 706c 6974 2028 696e 5f63 6861 6e6e 656c  plit (in_channel
-000186c0: 732c 2920 2d3e 2028 6772 6f75 7073 2c20  s,) -> (groups, 
-000186d0: 6769 6e5f 6368 616e 6e65 6c73 290a 2020  gin_channels).  
-000186e0: 2020 2020 2020 7420 3d20 742e 7265 7368        t = t.resh
-000186f0: 6170 6528 5b67 726f 7570 732c 2067 696e  ape([groups, gin
-00018700: 5f63 6861 6e6e 656c 732c 2062 6174 6368  _channels, batch
-00018710: 5d20 2b20 745f 7370 6174 6961 6c5f 6469  ] + t_spatial_di
-00018720: 6d73 290a 2020 2020 2020 2020 2320 5472  ms).        # Tr
-00018730: 616e 7370 6f73 6520 2867 726f 7570 732c  anspose (groups,
-00018740: 2067 696e 5f63 6861 6e6e 656c 732c 2062   gin_channels, b
-00018750: 6174 6368 2920 2d3e 2028 6769 6e5f 6368  atch) -> (gin_ch
-00018760: 616e 6e65 6c73 2c20 6772 6f75 7073 2c20  annels, groups, 
-00018770: 6261 7463 6829 0a20 2020 2020 2020 2074  batch).        t
-00018780: 203d 2063 6f6e 765f 7472 616e 7370 6f73   = conv_transpos
-00018790: 6528 7429 0a20 2020 2020 2020 2023 2046  e(t).        # F
-000187a0: 6c61 7474 656e 2028 6772 6f75 7073 2c20  latten (groups, 
-000187b0: 6261 7463 6829 202d 3e20 2867 726f 7570  batch) -> (group
-000187c0: 7320 2a20 6261 7463 682c 290a 2020 2020  s * batch,).    
-000187d0: 2020 2020 7420 3d20 742e 7265 7368 6170      t = t.reshap
-000187e0: 6528 5b67 696e 5f63 6861 6e6e 656c 732c  e([gin_channels,
-000187f0: 2067 726f 7570 7320 2a20 6261 7463 685d   groups * batch]
-00018800: 202b 2074 5f73 7061 7469 616c 5f64 696d   + t_spatial_dim
-00018810: 7329 0a20 2020 2020 2020 2072 6574 7572  s).        retur
-00018820: 6e20 740a 0a20 2020 2023 2069 6e70 7574  n t..    # input
-00018830: 2077 696c 6c20 6861 7665 2073 6861 7065   will have shape
-00018840: 2028 6769 6e5f 6368 616e 6e65 6c73 2c20   (gin_channels, 
-00018850: 6772 6f75 7073 202a 2062 6174 6368 290a  groups * batch).
-00018860: 2020 2020 696e 7075 7420 3d20 7061 645f      input = pad_
-00018870: 7472 616e 7370 6f73 655f 616e 645f 7075  transpose_and_pu
-00018880: 7368 5f67 726f 7570 735f 696e 746f 5f62  sh_groups_into_b
-00018890: 6174 6368 6573 2869 6e70 7574 290a 2020  atches(input).  
-000188a0: 2020 2320 6772 6164 2077 696c 6c20 6861    # grad will ha
-000188b0: 7665 2073 6861 7065 2028 6f75 745f 6368  ve shape (out_ch
-000188c0: 616e 6e65 6c73 2c20 6261 7463 6829 0a20  annels, batch). 
-000188d0: 2020 2023 204e 6f74 6520 7468 6174 2074     # Note that t
-000188e0: 6865 7365 2073 6861 7065 7320 6172 6520  hese shapes are 
-000188f0: 636f 6d70 6174 6962 6c65 2066 6f72 2061  compatible for a
-00018900: 2067 726f 7570 2063 6f6e 766f 6c75 7469   group convoluti
-00018910: 6f6e 2e0a 2020 2020 6772 6164 203d 2063  on..    grad = c
-00018920: 6f6e 765f 7472 616e 7370 6f73 6528 6772  onv_transpose(gr
-00018930: 6164 290a 0a20 2020 2023 2057 6879 2064  ad)..    # Why d
-00018940: 6f20 7765 2066 6c69 7020 7374 7269 6465  o we flip stride
-00018950: 2061 6e64 2064 696c 6174 696f 6e3f 0a20   and dilation?. 
-00018960: 2020 2023 206b 6572 6e65 6c5b 695d 2061     # kernel[i] a
-00018970: 6e64 206b 6572 6e65 6c5b 6920 2b20 315d  nd kernel[i + 1]
-00018980: 2061 7265 2064 696c 6174 696f 6e20 6170   are dilation ap
-00018990: 6172 7420 6672 6f6d 2065 6163 6820 6f74  art from each ot
-000189a0: 6865 722c 0a20 2020 2023 2073 6f20 6469  her,.    # so di
-000189b0: 6c61 7469 6f6e 2062 6563 6f6d 6573 2074  lation becomes t
-000189c0: 6865 206e 6577 2073 7472 6964 652e 0a20  he new stride.. 
-000189d0: 2020 2023 2041 6c6c 2074 6865 2065 6c65     # All the ele
-000189e0: 6d65 6e74 7320 7468 6174 206b 6572 6e65  ments that kerne
-000189f0: 6c5b 695d 2074 6f75 6368 6573 2061 7265  l[i] touches are
-00018a00: 2073 7472 6964 6520 6177 6179 2066 726f   stride away fro
-00018a10: 6d20 6561 6368 206f 7468 6572 2c0a 2020  m each other,.  
-00018a20: 2020 2320 6865 6e63 6520 7374 7269 6465    # hence stride
-00018a30: 2062 6563 6f6d 6573 2074 6865 206e 6577   becomes the new
-00018a40: 2064 696c 6174 696f 6e2e 0a20 2020 2077   dilation..    w
-00018a50: 6569 6768 745f 6772 6164 203d 2063 6f6e  eight_grad = con
-00018a60: 766f 6c75 7469 6f6e 280a 2020 2020 2020  volution(.      
-00018a70: 2020 696e 7075 742c 0a20 2020 2020 2020    input,.       
-00018a80: 2067 7261 642c 0a20 2020 2020 2020 204e   grad,.        N
-00018a90: 6f6e 652c 0a20 2020 2020 2020 2064 696c  one,.        dil
-00018aa0: 6174 696f 6e2c 2020 2320 7365 7420 7374  ation,  # set st
-00018ab0: 7269 6465 3d64 696c 6174 696f 6e0a 2020  ride=dilation.  
-00018ac0: 2020 2020 2020 2830 2c29 2c0a 2020 2020        (0,),.    
-00018ad0: 2020 2020 7374 7269 6465 2c20 2023 2073      stride,  # s
-00018ae0: 6574 2064 696c 6174 696f 6e3d 7374 7269  et dilation=stri
-00018af0: 6465 0a20 2020 2020 2020 2074 7261 6e73  de.        trans
-00018b00: 706f 7365 642c 0a20 2020 2020 2020 206f  posed,.        o
-00018b10: 7574 7075 745f 7061 6464 696e 672c 0a20  utput_padding,. 
-00018b20: 2020 2020 2020 2067 726f 7570 732c 0a20         groups,. 
-00018b30: 2020 2029 0a0a 2020 2020 2320 5468 6520     )..    # The 
-00018b40: 7265 7375 6c74 206f 6620 7468 6520 636f  result of the co
-00018b50: 6e76 6f6c 7574 696f 6e20 6861 7320 7368  nvolution has sh
-00018b60: 6170 6520 2867 696e 5f63 6861 6e6e 656c  ape (gin_channel
-00018b70: 732c 206f 7574 5f63 6861 6e6e 656c 7329  s, out_channels)
-00018b80: 2c0a 2020 2020 2320 736f 2074 7261 6e73  ,.    # so trans
-00018b90: 706f 7369 7469 6f6e 2069 7320 7265 7175  position is requ
-00018ba0: 6972 6564 2e0a 2020 2020 7765 6967 6874  ired..    weight
-00018bb0: 5f67 7261 6420 3d20 636f 6e76 5f74 7261  _grad = conv_tra
-00018bc0: 6e73 706f 7365 2877 6569 6768 745f 6772  nspose(weight_gr
-00018bd0: 6164 290a 2020 2020 2320 7d0a 0a20 2020  ad).    # }..   
-00018be0: 2072 6574 7572 6e20 2869 6e70 7574 5f67   return (input_g
-00018bf0: 7261 642c 2077 6569 6768 745f 6772 6164  rad, weight_grad
-00018c00: 2c20 6269 6173 5f67 7261 6429 0a0a 0a40  , bias_grad)...@
-00018c10: 7265 6769 7374 6572 5f61 7567 6d65 6e74  register_augment
-00018c20: 6564 5f66 6f72 7761 7264 2822 746f 7263  ed_forward("torc
-00018c30: 682e 6c6f 675f 736f 6674 6d61 7822 290a  h.log_softmax").
-00018c40: 6465 6620 6c6f 675f 736f 6674 6d61 785f  def log_softmax_
-00018c50: 6175 675f 6677 6428 696e 7075 743a 2054  aug_fwd(input: T
-00018c60: 656e 736f 7250 726f 7879 2c20 6469 6d3a  ensorProxy, dim:
-00018c70: 2069 6e74 2c20 2a2c 2064 7479 7065 3d4e   int, *, dtype=N
-00018c80: 6f6e 6529 202d 3e20 564a 5044 7561 6c3a  one) -> VJPDual:
-00018c90: 0a20 2020 2066 726f 6d20 7468 756e 6465  .    from thunde
-00018ca0: 722e 746f 7263 6820 696d 706f 7274 206c  r.torch import l
-00018cb0: 6f67 5f73 6f66 746d 6178 0a0a 2020 2020  og_softmax..    
-00018cc0: 7072 696d 616c 203d 206c 6f67 5f73 6f66  primal = log_sof
-00018cd0: 746d 6178 2869 6e70 7574 2c20 6469 6d3d  tmax(input, dim=
-00018ce0: 6469 6d2c 2064 7479 7065 3d64 7479 7065  dim, dtype=dtype
-00018cf0: 290a 2020 2020 7265 7369 6475 616c 7320  ).    residuals 
-00018d00: 3d20 2870 7269 6d61 6c2c 2064 696d 2c20  = (primal, dim, 
-00018d10: 696e 7075 742e 6474 7970 6529 0a20 2020  input.dtype).   
-00018d20: 2072 6574 7572 6e20 564a 5044 7561 6c28   return VJPDual(
-00018d30: 7072 696d 616c 2c20 7265 7369 6475 616c  primal, residual
-00018d40: 7329 0a0a 0a40 7265 6769 7374 6572 5f62  s)...@register_b
-00018d50: 6163 6b77 6172 6428 2274 6f72 6368 2e6c  ackward("torch.l
-00018d60: 6f67 5f73 6f66 746d 6178 2229 0a64 6566  og_softmax").def
-00018d70: 206c 6f67 5f73 6f66 746d 6178 5f62 6163   log_softmax_bac
-00018d80: 6b77 6172 6428 7072 696d 616c 2c20 6469  kward(primal, di
-00018d90: 6d2c 2064 7479 7065 2c20 6729 3a0a 2020  m, dtype, g):.  
-00018da0: 2020 6672 6f6d 2074 6875 6e64 6572 2e74    from thunder.t
-00018db0: 6f72 6368 2069 6d70 6f72 7420 6c6f 675f  orch import log_
-00018dc0: 736f 6674 6d61 785f 6261 636b 7761 7264  softmax_backward
-00018dd0: 0a0a 2020 2020 7265 7475 726e 206c 6f67  ..    return log
-00018de0: 5f73 6f66 746d 6178 5f62 6163 6b77 6172  _softmax_backwar
-00018df0: 6428 672c 2070 7269 6d61 6c2c 2064 696d  d(g, primal, dim
-00018e00: 2c20 6474 7970 6529 0a0a 0a40 7265 6769  , dtype)...@regi
-00018e10: 7374 6572 5f61 7567 6d65 6e74 6564 5f66  ster_augmented_f
-00018e20: 6f72 7761 7264 2822 746f 7263 682e 6e6e  orward("torch.nn
-00018e30: 2e66 756e 6374 696f 6e61 6c2e 6e6c 6c5f  .functional.nll_
-00018e40: 6c6f 7373 2229 0a64 6566 206e 6c6c 5f6c  loss").def nll_l
-00018e50: 6f73 735f 6175 675f 6677 6428 0a20 2020  oss_aug_fwd(.   
-00018e60: 2069 6e70 7574 3a20 5072 6f78 792c 0a20   input: Proxy,. 
-00018e70: 2020 2074 6172 6765 743a 2050 726f 7879     target: Proxy
-00018e80: 2c0a 2020 2020 7765 6967 6874 3a20 4e6f  ,.    weight: No
-00018e90: 6e65 207c 2050 726f 7879 2c0a 2020 2020  ne | Proxy,.    
-00018ea0: 6967 6e6f 7265 5f69 6e64 6578 3a20 696e  ignore_index: in
-00018eb0: 742c 0a20 2020 2072 6564 7563 7469 6f6e  t,.    reduction
-00018ec0: 3a20 7374 722c 0a29 202d 3e20 564a 5044  : str,.) -> VJPD
-00018ed0: 7561 6c3a 0a20 2020 2066 726f 6d20 7468  ual:.    from th
-00018ee0: 756e 6465 722e 746f 7263 6820 696d 706f  under.torch impo
-00018ef0: 7274 205f 6e6c 6c5f 6c6f 7373 5f68 656c  rt _nll_loss_hel
-00018f00: 7065 720a 0a20 2020 2070 7269 6d61 6c2c  per..    primal,
-00018f10: 2074 6f74 616c 5f77 6569 6768 7420 3d20   total_weight = 
-00018f20: 5f6e 6c6c 5f6c 6f73 735f 6865 6c70 6572  _nll_loss_helper
-00018f30: 280a 2020 2020 2020 2020 696e 7075 742c  (.        input,
-00018f40: 0a20 2020 2020 2020 2074 6172 6765 742c  .        target,
-00018f50: 0a20 2020 2020 2020 2077 6569 6768 742c  .        weight,
-00018f60: 0a20 2020 2020 2020 2069 676e 6f72 655f  .        ignore_
-00018f70: 696e 6465 782c 0a20 2020 2020 2020 2072  index,.        r
-00018f80: 6564 7563 7469 6f6e 2c0a 2020 2020 290a  eduction,.    ).
-00018f90: 2020 2020 7265 7369 6475 616c 7320 3d20      residuals = 
-00018fa0: 2869 6e70 7574 2c20 7461 7267 6574 2c20  (input, target, 
-00018fb0: 7765 6967 6874 2c20 7265 6475 6374 696f  weight, reductio
-00018fc0: 6e2c 2069 676e 6f72 655f 696e 6465 782c  n, ignore_index,
-00018fd0: 2074 6f74 616c 5f77 6569 6768 7429 0a20   total_weight). 
-00018fe0: 2020 2072 6574 7572 6e20 564a 5044 7561     return VJPDua
-00018ff0: 6c28 7072 696d 616c 2c20 7265 7369 6475  l(primal, residu
-00019000: 616c 7329 0a0a 0a40 7265 6769 7374 6572  als)...@register
-00019010: 5f62 6163 6b77 6172 6428 2274 6f72 6368  _backward("torch
-00019020: 2e6e 6e2e 6675 6e63 7469 6f6e 616c 2e6e  .nn.functional.n
-00019030: 6c6c 5f6c 6f73 7322 290a 6465 6620 6e6c  ll_loss").def nl
-00019040: 6c5f 6c6f 7373 5f62 6163 6b77 6172 6428  l_loss_backward(
-00019050: 696e 7075 742c 2074 6172 6765 742c 2077  input, target, w
-00019060: 6569 6768 742c 2072 6564 7563 7469 6f6e  eight, reduction
-00019070: 2c20 6967 6e6f 7265 5f69 6e64 6578 2c20  , ignore_index, 
-00019080: 746f 7461 6c5f 7765 6967 6874 2c20 6729  total_weight, g)
-00019090: 3a0a 2020 2020 6672 6f6d 2074 6875 6e64  :.    from thund
-000190a0: 6572 2e74 6f72 6368 2069 6d70 6f72 7420  er.torch import 
-000190b0: 6e6c 6c5f 6c6f 7373 5f62 6163 6b77 6172  nll_loss_backwar
-000190c0: 640a 0a20 2020 2067 696e 7075 7420 3d20  d..    ginput = 
-000190d0: 6e6c 6c5f 6c6f 7373 5f62 6163 6b77 6172  nll_loss_backwar
-000190e0: 6428 672c 2069 6e70 7574 2c20 7461 7267  d(g, input, targ
-000190f0: 6574 2c20 7765 6967 6874 2c20 7265 6475  et, weight, redu
-00019100: 6374 696f 6e2c 2069 676e 6f72 655f 696e  ction, ignore_in
-00019110: 6465 782c 2074 6f74 616c 5f77 6569 6768  dex, total_weigh
-00019120: 7429 0a20 2020 2072 6574 7572 6e20 6769  t).    return gi
-00019130: 6e70 7574 2c20 2a28 284e 6f6e 652c 2920  nput, *((None,) 
-00019140: 2a20 3429 0a0a 0a40 7265 6769 7374 6572  * 4)...@register
-00019150: 5f61 7567 6d65 6e74 6564 5f66 6f72 7761  _augmented_forwa
-00019160: 7264 2822 746f 7263 682e 7370 6c69 7422  rd("torch.split"
-00019170: 290a 6465 6620 7370 6c69 745f 6175 675f  ).def split_aug_
-00019180: 6677 6428 613a 2054 656e 736f 7250 726f  fwd(a: TensorPro
-00019190: 7879 2c20 7370 6c69 745f 7369 7a65 5f6f  xy, split_size_o
-000191a0: 725f 7365 6374 696f 6e73 3a20 696e 7420  r_sections: int 
-000191b0: 7c20 5365 7175 656e 6365 5b69 6e74 5d2c  | Sequence[int],
-000191c0: 2064 696d 3a20 696e 7420 3d20 3029 202d   dim: int = 0) -
-000191d0: 3e20 564a 5044 7561 6c3a 0a20 2020 2066  > VJPDual:.    f
-000191e0: 726f 6d20 7468 756e 6465 722e 746f 7263  rom thunder.torc
-000191f0: 6820 696d 706f 7274 2073 706c 6974 0a0a  h import split..
-00019200: 2020 2020 7072 696d 616c 203d 2073 706c      primal = spl
-00019210: 6974 2861 2c20 7370 6c69 745f 7369 7a65  it(a, split_size
-00019220: 5f6f 725f 7365 6374 696f 6e73 2c20 6469  _or_sections, di
-00019230: 6d29 0a20 2020 2072 6573 6964 7561 6c73  m).    residuals
-00019240: 203d 2028 6469 6d2c 290a 2020 2020 7265   = (dim,).    re
-00019250: 7475 726e 2056 4a50 4475 616c 2870 7269  turn VJPDual(pri
-00019260: 6d61 6c2c 2072 6573 6964 7561 6c73 290a  mal, residuals).
-00019270: 0a0a 4072 6567 6973 7465 725f 6261 636b  ..@register_back
-00019280: 7761 7264 2822 746f 7263 682e 7370 6c69  ward("torch.spli
-00019290: 7422 290a 6465 6620 7370 6c69 745f 6261  t").def split_ba
-000192a0: 636b 7761 7264 2864 696d 2c20 2a67 7261  ckward(dim, *gra
-000192b0: 6473 293a 0a20 2020 2066 726f 6d20 7468  ds):.    from th
-000192c0: 756e 6465 722e 746f 7263 6820 696d 706f  under.torch impo
-000192d0: 7274 2063 6174 0a0a 2020 2020 7265 7475  rt cat..    retu
-000192e0: 726e 2063 6174 2867 7261 6473 2c20 6469  rn cat(grads, di
-000192f0: 6d29 0a0a 0a40 7265 6769 7374 6572 5f61  m)...@register_a
-00019300: 7567 6d65 6e74 6564 5f66 6f72 7761 7264  ugmented_forward
-00019310: 2822 746f 7263 682e 6e6e 2e66 756e 6374  ("torch.nn.funct
-00019320: 696f 6e61 6c2e 656d 6265 6464 696e 6722  ional.embedding"
-00019330: 290a 6465 6620 656d 6265 6464 696e 675f  ).def embedding_
-00019340: 6175 675f 6677 6428 0a20 2020 2061 3a20  aug_fwd(.    a: 
-00019350: 5072 6f78 792c 0a20 2020 2077 6569 6768  Proxy,.    weigh
-00019360: 743a 2050 726f 7879 2c0a 2020 2020 7061  t: Proxy,.    pa
-00019370: 6464 696e 675f 6964 783a 2069 6e74 207c  dding_idx: int |
-00019380: 204e 6f6e 652c 0a20 2020 206d 6178 5f6e   None,.    max_n
-00019390: 6f72 6d3a 2066 6c6f 6174 207c 204e 6f6e  orm: float | Non
-000193a0: 652c 0a20 2020 206e 6f72 6d5f 7479 7065  e,.    norm_type
-000193b0: 3a20 666c 6f61 742c 0a20 2020 2073 6361  : float,.    sca
-000193c0: 6c65 5f67 7261 645f 6279 5f66 7265 713a  le_grad_by_freq:
-000193d0: 2062 6f6f 6c2c 0a20 2020 2073 7061 7273   bool,.    spars
-000193e0: 653a 2062 6f6f 6c2c 0a29 202d 3e20 564a  e: bool,.) -> VJ
-000193f0: 5044 7561 6c3a 0a20 2020 2066 726f 6d20  PDual:.    from 
-00019400: 7468 756e 6465 722e 746f 7263 6820 696d  thunder.torch im
-00019410: 706f 7274 2065 6d62 6564 6469 6e67 0a0a  port embedding..
-00019420: 2020 2020 7072 696d 616c 203d 2065 6d62      primal = emb
-00019430: 6564 6469 6e67 280a 2020 2020 2020 2020  edding(.        
-00019440: 612c 0a20 2020 2020 2020 2077 6569 6768  a,.        weigh
-00019450: 742c 0a20 2020 2020 2020 2070 6164 6469  t,.        paddi
-00019460: 6e67 5f69 6478 3d70 6164 6469 6e67 5f69  ng_idx=padding_i
-00019470: 6478 2c0a 2020 2020 2020 2020 6d61 785f  dx,.        max_
-00019480: 6e6f 726d 3d6d 6178 5f6e 6f72 6d2c 0a20  norm=max_norm,. 
-00019490: 2020 2020 2020 206e 6f72 6d5f 7479 7065         norm_type
-000194a0: 3d6e 6f72 6d5f 7479 7065 2c0a 2020 2020  =norm_type,.    
-000194b0: 2020 2020 7363 616c 655f 6772 6164 5f62      scale_grad_b
-000194c0: 795f 6672 6571 3d73 6361 6c65 5f67 7261  y_freq=scale_gra
-000194d0: 645f 6279 5f66 7265 712c 0a20 2020 2020  d_by_freq,.     
-000194e0: 2020 2073 7061 7273 653d 7370 6172 7365     sparse=sparse
-000194f0: 2c0a 2020 2020 290a 2020 2020 7265 7369  ,.    ).    resi
-00019500: 6475 616c 7320 3d20 2861 2c20 7765 6967  duals = (a, weig
-00019510: 6874 2e73 6861 7065 5b30 5d2c 2070 6164  ht.shape[0], pad
-00019520: 6469 6e67 5f69 6478 2c20 7363 616c 655f  ding_idx, scale_
-00019530: 6772 6164 5f62 795f 6672 6571 2c20 7370  grad_by_freq, sp
-00019540: 6172 7365 290a 2020 2020 7265 7475 726e  arse).    return
-00019550: 2056 4a50 4475 616c 2870 7269 6d61 6c2c   VJPDual(primal,
-00019560: 2072 6573 6964 7561 6c73 290a 0a0a 4072   residuals)...@r
-00019570: 6567 6973 7465 725f 6261 636b 7761 7264  egister_backward
-00019580: 2822 746f 7263 682e 6e6e 2e66 756e 6374  ("torch.nn.funct
-00019590: 696f 6e61 6c2e 656d 6265 6464 696e 6722  ional.embedding"
-000195a0: 290a 6465 6620 656d 6265 6464 696e 675f  ).def embedding_
-000195b0: 6261 636b 7761 7264 2861 2c20 6e75 6d5f  backward(a, num_
-000195c0: 7765 6967 6874 732c 2070 6164 6469 6e67  weights, padding
-000195d0: 5f69 6478 2c20 7363 616c 655f 6772 6164  _idx, scale_grad
-000195e0: 5f62 795f 6672 6571 2c20 7370 6172 7365  _by_freq, sparse
-000195f0: 2c20 6729 3a0a 2020 2020 6672 6f6d 2074  , g):.    from t
-00019600: 6875 6e64 6572 2e74 6f72 6368 2069 6d70  hunder.torch imp
-00019610: 6f72 7420 656d 6265 6464 696e 675f 6261  ort embedding_ba
-00019620: 636b 7761 7264 0a0a 2020 2020 7061 6464  ckward..    padd
-00019630: 696e 675f 6964 7820 3d20 2d31 2069 6620  ing_idx = -1 if 
-00019640: 7061 6464 696e 675f 6964 7820 6973 204e  padding_idx is N
-00019650: 6f6e 6520 656c 7365 2070 6164 6469 6e67  one else padding
-00019660: 5f69 6478 0a20 2020 2067 7765 6967 6874  _idx.    gweight
-00019670: 203d 2065 6d62 6564 6469 6e67 5f62 6163   = embedding_bac
-00019680: 6b77 6172 6428 672c 2061 2c20 6e75 6d5f  kward(g, a, num_
-00019690: 7765 6967 6874 732c 2070 6164 6469 6e67  weights, padding
-000196a0: 5f69 6478 2c20 7363 616c 655f 6772 6164  _idx, scale_grad
-000196b0: 5f62 795f 6672 6571 2c20 7370 6172 7365  _by_freq, sparse
-000196c0: 290a 2020 2020 7265 7475 726e 2067 7765  ).    return gwe
-000196d0: 6967 6874 0a0a 0a40 7265 6769 7374 6572  ight...@register
-000196e0: 5f61 7567 6d65 6e74 6564 5f66 6f72 7761  _augmented_forwa
-000196f0: 7264 2822 746f 7263 682e 6375 6d73 756d  rd("torch.cumsum
-00019700: 2229 0a64 6566 2063 756d 7375 6d5f 6175  ").def cumsum_au
-00019710: 675f 6677 6428 613a 2050 726f 7879 2c20  g_fwd(a: Proxy, 
-00019720: 6469 6d3a 2069 6e74 2c20 2a2c 2064 7479  dim: int, *, dty
-00019730: 7065 3a20 4e6f 6e65 207c 2064 7479 7065  pe: None | dtype
-00019740: 732e 6474 7970 6520 3d20 4e6f 6e65 2920  s.dtype = None) 
-00019750: 2d3e 2056 4a50 4475 616c 3a0a 2020 2020  -> VJPDual:.    
-00019760: 6672 6f6d 2074 6875 6e64 6572 2e74 6f72  from thunder.tor
-00019770: 6368 2069 6d70 6f72 7420 6375 6d73 756d  ch import cumsum
-00019780: 0a0a 2020 2020 7072 696d 616c 203d 2063  ..    primal = c
-00019790: 756d 7375 6d28 612c 2064 696d 2c20 6474  umsum(a, dim, dt
-000197a0: 7970 653d 6474 7970 6529 0a20 2020 2072  ype=dtype).    r
-000197b0: 6573 6964 7561 6c73 203d 2028 0a20 2020  esiduals = (.   
-000197c0: 2020 2020 2061 2e64 7479 7065 2c0a 2020       a.dtype,.  
-000197d0: 2020 2020 2020 6469 6d2c 0a20 2020 2029        dim,.    )
-000197e0: 0a20 2020 2072 6574 7572 6e20 564a 5044  .    return VJPD
-000197f0: 7561 6c28 7072 696d 616c 2c20 7265 7369  ual(primal, resi
-00019800: 6475 616c 7329 0a0a 0a40 7265 6769 7374  duals)...@regist
-00019810: 6572 5f62 6163 6b77 6172 6428 2274 6f72  er_backward("tor
-00019820: 6368 2e63 756d 7375 6d22 290a 6465 6620  ch.cumsum").def 
-00019830: 6375 6d73 756d 5f62 6163 6b77 6172 6428  cumsum_backward(
-00019840: 615f 6474 7970 652c 2064 696d 2c20 6729  a_dtype, dim, g)
-00019850: 3a0a 2020 2020 6720 3d20 672e 746f 2861  :.    g = g.to(a
-00019860: 5f64 7479 7065 290a 2020 2020 6966 2067  _dtype).    if g
-00019870: 2e6e 756d 656c 203c 3d20 3120 6f72 2067  .numel <= 1 or g
-00019880: 2e73 6861 7065 5b64 696d 5d20 3d3d 2031  .shape[dim] == 1
-00019890: 3a0a 2020 2020 2020 2020 7265 7475 726e  :.        return
-000198a0: 2067 0a20 2020 2072 6574 7572 6e20 672e   g.    return g.
-000198b0: 666c 6970 2864 696d 292e 6375 6d73 756d  flip(dim).cumsum
-000198c0: 2864 696d 292e 666c 6970 2864 696d 290a  (dim).flip(dim).
-000198d0: 0a0a 4072 6567 6973 7465 725f 6175 676d  ..@register_augm
-000198e0: 656e 7465 645f 666f 7277 6172 6428 2274  ented_forward("t
-000198f0: 6f72 6368 2e73 6f66 746d 6178 2229 0a64  orch.softmax").d
-00019900: 6566 2073 6f66 746d 6178 5f61 7567 5f66  ef softmax_aug_f
-00019910: 7764 2861 3a20 5072 6f78 792c 2064 696d  wd(a: Proxy, dim
-00019920: 3a20 696e 742c 2064 7479 7065 3a20 6474  : int, dtype: dt
-00019930: 7970 6573 2e64 7479 7065 207c 204e 6f6e  ypes.dtype | Non
-00019940: 6520 3d20 4e6f 6e65 2920 2d3e 2056 4a50  e = None) -> VJP
-00019950: 4475 616c 3a0a 2020 2020 6672 6f6d 2074  Dual:.    from t
-00019960: 6875 6e64 6572 2e74 6f72 6368 2069 6d70  hunder.torch imp
-00019970: 6f72 7420 736f 6674 6d61 780a 0a20 2020  ort softmax..   
-00019980: 2070 7269 6d61 6c20 3d20 736f 6674 6d61   primal = softma
-00019990: 7828 612c 2064 696d 2c20 6474 7970 653d  x(a, dim, dtype=
-000199a0: 6474 7970 6529 0a20 2020 2072 6573 6964  dtype).    resid
-000199b0: 7561 6c73 203d 2028 7072 696d 616c 2c20  uals = (primal, 
-000199c0: 6469 6d29 0a20 2020 2072 6574 7572 6e20  dim).    return 
-000199d0: 564a 5044 7561 6c28 7072 696d 616c 2c20  VJPDual(primal, 
-000199e0: 7265 7369 6475 616c 7329 0a0a 0a40 7265  residuals)...@re
-000199f0: 6769 7374 6572 5f62 6163 6b77 6172 6428  gister_backward(
-00019a00: 2274 6f72 6368 2e73 6f66 746d 6178 2229  "torch.softmax")
-00019a10: 0a64 6566 2073 6f66 746d 6178 5f62 6163  .def softmax_bac
-00019a20: 6b77 6172 6428 7072 696d 616c 2c20 6469  kward(primal, di
-00019a30: 6d2c 2067 293a 0a20 2020 2072 6574 7572  m, g):.    retur
-00019a40: 6e20 7072 696d 616c 202a 2028 6720 2d20  n primal * (g - 
-00019a50: 2870 7269 6d61 6c20 2a20 6729 2e73 756d  (primal * g).sum
-00019a60: 2864 696d 2c20 6b65 6570 6469 6d3d 5472  (dim, keepdim=Tr
-00019a70: 7565 2929 0a0a 0a64 6566 2069 7465 725f  ue))...def iter_
-00019a80: 626f 756e 645f 7379 6d62 6f6c 7328 626f  bound_symbols(bo
-00019a90: 756e 645f 7379 6d62 6f6c 7329 3a0a 2020  und_symbols):.  
-00019aa0: 2020 2222 2249 7465 7261 7465 206f 7665    """Iterate ove
-00019ab0: 7220 626f 756e 6420 7379 6d62 6f6c 732c  r bound symbols,
-00019ac0: 2073 6b69 7070 696e 6720 7379 6d62 6f6c   skipping symbol
-00019ad0: 7320 7468 6174 2061 7265 206e 6f74 2073  s that are not s
-00019ae0: 7570 706f 7274 6564 2062 790a 2020 2020  upported by.    
-00019af0: 7468 6520 7472 616e 7366 6f72 6d73 2069  the transforms i
-00019b00: 6e66 7261 7374 7275 6374 7572 652e 0a0a  nfrastructure...
-00019b10: 2020 2020 4172 6773 3a0a 2020 2020 2020      Args:.      
-00019b20: 2020 626f 756e 645f 7379 6d62 6f6c 7320    bound_symbols 
-00019b30: 284c 6973 745b 426f 756e 6453 796d 626f  (List[BoundSymbo
-00019b40: 6c5d 293a 204c 6973 7420 6f66 2062 6f75  l]): List of bou
-00019b50: 6e64 2073 796d 626f 6c73 0a0a 2020 2020  nd symbols..    
-00019b60: 5969 656c 6473 3a0a 2020 2020 2020 2020  Yields:.        
-00019b70: 426f 756e 6453 796d 626f 6c3a 2042 6f75  BoundSymbol: Bou
-00019b80: 6e64 2073 796d 626f 6c73 2074 6861 7420  nd symbols that 
-00019b90: 6172 6520 7375 7070 6f72 7465 6420 6279  are supported by
-00019ba0: 2074 6865 2074 7261 6e73 666f 726d 730a   the transforms.
-00019bb0: 2020 2020 2020 2020 696e 6672 6173 7472          infrastr
-00019bc0: 7563 7475 7265 0a20 2020 2022 2222 0a20  ucture.    """. 
-00019bd0: 2020 2066 6f72 2073 796d 626f 6c20 696e     for symbol in
-00019be0: 2062 6f75 6e64 5f73 796d 626f 6c73 3a0a   bound_symbols:.
-00019bf0: 2020 2020 2020 2020 6966 2073 796d 626f          if symbo
-00019c00: 6c2e 7379 6d2e 6964 2069 6e20 7472 616e  l.sym.id in tran
-00019c10: 7366 6f72 6d5f 736b 6970 5f6c 6973 743a  sform_skip_list:
-00019c20: 0a20 2020 2020 2020 2020 2020 2063 6f6e  .            con
-00019c30: 7469 6e75 650a 2020 2020 2020 2020 656c  tinue.        el
-00019c40: 6966 2073 796d 626f 6c2e 6f75 7470 7574  if symbol.output
-00019c50: 2069 7320 4e6f 6e65 3a0a 2020 2020 2020   is None:.      
-00019c60: 2020 2020 2020 636f 6e74 696e 7565 0a20        continue. 
-00019c70: 2020 2020 2020 2065 6c73 653a 0a20 2020         else:.   
-00019c80: 2020 2020 2020 2020 2079 6965 6c64 2073           yield s
-00019c90: 796d 626f 6c0a 0a0a 6465 6620 6465 636f  ymbol...def deco
-00019ca0: 6e73 7472 7563 745f 666f 7277 6172 645f  nstruct_forward_
-00019cb0: 656e 765f 666f 725f 6261 636b 7761 7264  env_for_backward
-00019cc0: 2874 7261 6365 2c20 656e 7629 3a0a 2020  (trace, env):.  
-00019cd0: 2020 2320 4e6f 7465 205b 5361 7669 6e67    # Note [Saving
-00019ce0: 2074 6865 2066 6f72 7761 7264 2065 6e76   the forward env
-00019cf0: 6972 6f6e 6d65 6e74 2069 6e20 7468 6520  ironment in the 
-00019d00: 6261 636b 7761 7264 2072 756c 655d 0a20  backward rule]. 
-00019d10: 2020 2023 2057 6520 6361 6e6e 6f74 2073     # We cannot s
-00019d20: 6176 6520 7468 6520 7472 6163 6520 6f62  ave the trace ob
-00019d30: 6a65 6374 2069 6e20 7468 6520 7265 7369  ject in the resi
-00019d40: 6475 616c 7320 6265 6361 7573 6520 6578  duals because ex
-00019d50: 6563 7574 6f72 7320 6d61 7920 6e6f 740a  ecutors may not.
-00019d60: 2020 2020 2320 6265 2061 626c 6520 746f      # be able to
-00019d70: 2072 6574 7572 6e20 6974 2066 6f72 2074   return it for t
-00019d80: 6865 2073 706c 6974 7465 6420 666f 7277  he splitted forw
-00019d90: 6172 642f 6261 636b 7761 7264 2070 6173  ard/backward pas
-00019da0: 7365 732e 2049 6e73 7465 6164 2c20 7765  ses. Instead, we
-00019db0: 0a20 2020 2023 2073 6176 6520 6172 6773  .    # save args
-00019dc0: 2061 6e64 206b 7761 7267 7320 6f66 2074   and kwargs of t
-00019dd0: 6865 206f 7269 6769 6e61 6c20 6675 6e63  he original func
-00019de0: 7469 6f6e 2063 616c 6c20 616e 6420 7265  tion call and re
-00019df0: 636f 6e73 7472 7563 7420 7468 650a 2020  construct the.  
-00019e00: 2020 2320 7472 6163 6520 6f62 6a65 6374    # trace object
-00019e10: 2061 6e64 2069 7473 2065 6e76 6972 6f6e   and its environ
-00019e20: 6d65 6e74 2064 6963 7420 696e 2074 6865  ment dict in the
-00019e30: 2062 6163 6b77 6172 6420 7275 6c65 2e20   backward rule. 
-00019e40: 4865 7265 2077 6520 7265 6c79 0a20 2020  Here we rely.   
-00019e50: 2023 206f 6e20 7468 6520 6661 6374 2074   # on the fact t
-00019e60: 6861 7420 7468 6520 6f72 6465 7220 6f66  hat the order of
-00019e70: 2074 6865 2073 796d 626f 6c73 2069 6e20   the symbols in 
-00019e80: 7468 6520 7472 6163 6520 6973 2064 6574  the trace is det
-00019e90: 6572 6d69 6e69 7374 6963 0a20 2020 2023  erministic.    #
-00019ea0: 2061 6e64 2061 6c77 6179 7320 7468 6520   and always the 
-00019eb0: 7361 6d65 2066 6f72 2074 6865 2073 616d  same for the sam
-00019ec0: 6520 6675 6e63 7469 6f6e 2063 616c 6c20  e function call 
-00019ed0: 616e 6420 7468 6520 7361 6d65 2073 6574  and the same set
-00019ee0: 206f 660a 2020 2020 2320 6172 6775 6d65   of.    # argume
-00019ef0: 6e74 732e 2053 6565 2074 6573 745f 6772  nts. See test_gr
-00019f00: 6164 2e70 793a 7465 7374 5f74 6f72 6368  ad.py:test_torch
-00019f10: 5f61 7574 6f67 7261 645f 6675 6e63 7469  _autograd_functi
-00019f20: 6f6e 2066 6f72 2061 6e20 6578 616d 706c  on for an exampl
-00019f30: 650a 2020 2020 2320 7768 6572 6520 7468  e.    # where th
-00019f40: 6973 2069 7320 7465 7374 6564 2e0a 2020  is is tested..  
-00019f50: 2020 626f 756e 645f 7379 6d62 6f6c 7320    bound_symbols 
-00019f60: 3d20 6974 6572 5f62 6f75 6e64 5f73 796d  = iter_bound_sym
-00019f70: 626f 6c73 2874 7261 6365 2e62 6f75 6e64  bols(trace.bound
-00019f80: 5f73 796d 626f 6c73 290a 2020 2020 7361  _symbols).    sa
-00019f90: 7665 645f 666f 725f 6261 636b 7761 7264  ved_for_backward
-00019fa0: 203d 2074 7570 6c65 2865 6e76 5b73 6571   = tuple(env[seq
-00019fb0: 7565 6e63 6966 7928 7379 6d62 6f6c 2e6f  uencify(symbol.o
-00019fc0: 7574 7075 7429 5b30 5d2e 6e61 6d65 5d2e  utput)[0].name].
-00019fd0: 7265 7369 6475 616c 7320 666f 7220 7379  residuals for sy
-00019fe0: 6d62 6f6c 2069 6e20 626f 756e 645f 7379  mbol in bound_sy
-00019ff0: 6d62 6f6c 7329 0a20 2020 2072 6574 7572  mbols).    retur
-0001a000: 6e20 7361 7665 645f 666f 725f 6261 636b  n saved_for_back
-0001a010: 7761 7264 0a0a 0a64 6566 2072 6563 6f6e  ward...def recon
-0001a020: 7374 7275 6374 5f66 6f72 7761 7264 5f65  struct_forward_e
-0001a030: 6e76 5f66 6f72 5f62 6163 6b77 6172 6428  nv_for_backward(
-0001a040: 7472 6163 652c 2073 6176 6564 5f66 6f72  trace, saved_for
-0001a050: 5f62 6163 6b77 6172 6429 3a0a 2020 2020  _backward):.    
-0001a060: 626f 756e 645f 7379 6d62 6f6c 7320 3d20  bound_symbols = 
-0001a070: 6974 6572 5f62 6f75 6e64 5f73 796d 626f  iter_bound_symbo
-0001a080: 6c73 2874 7261 6365 2e62 6f75 6e64 5f73  ls(trace.bound_s
-0001a090: 796d 626f 6c73 290a 0a20 2020 2072 6563  ymbols)..    rec
-0001a0a0: 6f6e 7374 7275 6374 6564 5f65 6e76 203d  onstructed_env =
-0001a0b0: 207b 7d0a 0a20 2020 2066 6f72 2069 6478   {}..    for idx
-0001a0c0: 2c20 7379 6d20 696e 2065 6e75 6d65 7261  , sym in enumera
-0001a0d0: 7465 2862 6f75 6e64 5f73 796d 626f 6c73  te(bound_symbols
-0001a0e0: 293a 0a20 2020 2020 2020 206b 203d 2073  ):.        k = s
-0001a0f0: 6571 7565 6e63 6966 7928 7379 6d2e 6f75  equencify(sym.ou
-0001a100: 7470 7574 295b 305d 2e6e 616d 650a 2020  tput)[0].name.  
-0001a110: 2020 2020 2020 7620 3d20 564a 5044 7561        v = VJPDua
-0001a120: 6c28 4e6f 6e65 2c20 7361 7665 645f 666f  l(None, saved_fo
-0001a130: 725f 6261 636b 7761 7264 5b69 6478 5d29  r_backward[idx])
-0001a140: 0a20 2020 2020 2020 2072 6563 6f6e 7374  .        reconst
-0001a150: 7275 6374 6564 5f65 6e76 5b6b 5d20 3d20  ructed_env[k] = 
-0001a160: 760a 0a20 2020 2072 6574 7572 6e20 7265  v..    return re
-0001a170: 636f 6e73 7472 7563 7465 645f 656e 760a  constructed_env.
-0001a180: 0a0a 6465 6620 6465 636f 6d70 6f73 6564  ..def decomposed
-0001a190: 5f66 6e5f 6175 675f 6677 645f 7275 6c65  _fn_aug_fwd_rule
-0001a1a0: 282a 6172 6773 2c20 6465 636f 6d70 6f73  (*args, decompos
-0001a1b0: 6564 5f66 6e2c 202a 2a6b 7761 7267 7329  ed_fn, **kwargs)
-0001a1c0: 3a0a 2020 2020 2222 2241 7567 6d65 6e74  :.    """Augment
-0001a1d0: 6564 2066 6f72 7761 7264 2072 756c 6520  ed forward rule 
-0001a1e0: 666f 7220 636f 6d70 6f73 6974 6520 6675  for composite fu
-0001a1f0: 6e63 7469 6f6e 7320 696d 706c 656d 656e  nctions implemen
-0001a200: 7465 6420 696e 2074 6572 6d73 206f 6620  ted in terms of 
-0001a210: 6f74 6865 7220 6675 6e63 7469 6f6e 7320  other functions 
-0001a220: 7468 6174 2061 7265 0a20 2020 2073 7570  that are.    sup
-0001a230: 706f 7365 6420 746f 2062 6520 7375 7070  posed to be supp
-0001a240: 6f72 7465 6420 6279 2074 6865 2056 4a50  orted by the VJP
-0001a250: 2069 6e66 7261 7374 7275 6374 7572 652e   infrastructure.
-0001a260: 0a0a 2020 2020 4172 6773 3a0a 2020 2020  ..    Args:.    
-0001a270: 2020 2020 6465 636f 6d70 6f73 6564 5f66      decomposed_f
-0001a280: 6e20 2843 616c 6c61 626c 6529 3a20 6465  n (Callable): de
-0001a290: 636f 6d70 6f73 6564 2076 6572 7369 6f6e  composed version
-0001a2a0: 206f 6620 7468 6520 6675 6e63 7469 6f6e   of the function
-0001a2b0: 0a0a 2020 2020 5265 7475 726e 733a 0a20  ..    Returns:. 
-0001a2c0: 2020 2020 2020 2043 616c 6c61 626c 653a         Callable:
-0001a2d0: 2041 7567 6d65 6e74 6564 2066 6f72 7761   Augmented forwa
-0001a2e0: 7264 2072 756c 6520 666f 7220 7468 6520  rd rule for the 
-0001a2f0: 636f 6d70 6f73 6974 6520 6675 6e63 7469  composite functi
-0001a300: 6f6e 0a20 2020 2022 2222 0a20 2020 2074  on.    """.    t
-0001a310: 7261 6365 203d 2063 6f6e 7374 7275 6374  race = construct
-0001a320: 5f74 7261 6365 2829 2864 6563 6f6d 706f  _trace()(decompo
-0001a330: 7365 645f 666e 2c20 2a61 7267 732c 202a  sed_fn, *args, *
-0001a340: 2a6b 7761 7267 7329 0a20 2020 2074 7261  *kwargs).    tra
-0001a350: 6365 203d 2075 6e77 7261 705f 6f6e 655f  ce = unwrap_one_
-0001a360: 6c65 7665 6c5f 6f66 5f73 7562 7379 6d62  level_of_subsymb
-0001a370: 6f6c 7328 7472 6163 6529 0a20 2020 2023  ols(trace).    #
-0001a380: 2054 6865 7265 206d 6179 2062 6520 6120   There may be a 
-0001a390: 6465 6164 206e 6f64 6520 6c69 6b65 2022  dead node like "
-0001a3a0: 5f20 3d20 7072 696d 732e 636f 6e76 6572  _ = prims.conver
-0001a3b0: 745f 656c 656d 656e 745f 7479 7065 2830  t_element_type(0
-0001a3c0: 2c20 666c 6f61 7429 220a 2020 2020 2320  , float)".    # 
-0001a3d0: 696e 2074 6865 2074 7261 6365 2e20 5765  in the trace. We
-0001a3e0: 206e 6565 6420 746f 2072 656d 6f76 6520   need to remove 
-0001a3f0: 6974 2062 6566 6f72 6520 7765 2063 616e  it before we can
-0001a400: 2075 7365 2074 6865 2074 7261 6365 2066   use the trace f
-0001a410: 6f72 0a20 2020 2023 2061 7567 6d65 6e74  or.    # augment
-0001a420: 6564 5f66 6f72 7761 7264 5f70 6173 732e  ed_forward_pass.
-0001a430: 0a20 2020 2074 7261 6365 203d 2064 6365  .    trace = dce
-0001a440: 2874 7261 6365 290a 2020 2020 7265 7375  (trace).    resu
-0001a450: 6c74 2c20 656e 7620 3d20 6175 676d 656e  lt, env = augmen
-0001a460: 7465 645f 666f 7277 6172 645f 7061 7373  ted_forward_pass
-0001a470: 282a 6172 6773 2c20 7472 6163 653d 7472  (*args, trace=tr
-0001a480: 6163 652c 202a 2a6b 7761 7267 7329 0a20  ace, **kwargs). 
-0001a490: 2020 2073 6176 6564 5f66 6f72 5f62 6163     saved_for_bac
-0001a4a0: 6b77 6172 6420 3d20 6465 636f 6e73 7472  kward = deconstr
-0001a4b0: 7563 745f 666f 7277 6172 645f 656e 765f  uct_forward_env_
-0001a4c0: 666f 725f 6261 636b 7761 7264 2874 7261  for_backward(tra
-0001a4d0: 6365 2c20 656e 7629 0a20 2020 2023 2053  ce, env).    # S
-0001a4e0: 7461 7469 6320 6361 6368 696e 6720 646f  tatic caching do
-0001a4f0: 6573 206e 6f74 2077 6974 6820 7769 7468  es not with with
-0001a500: 206b 7761 7267 7320 6469 6374 732c 2073   kwargs dicts, s
-0001a510: 6f20 7765 2772 6520 636f 6e76 6572 7469  o we're converti
-0001a520: 6e67 2074 6865 6d0a 2020 2020 2320 746f  ng them.    # to
-0001a530: 204e 6f6e 6520 666f 7220 6e6f 7720 7768   None for now wh
-0001a540: 656e 2070 6f73 7369 626c 652e 0a20 2020  en possible..   
-0001a550: 206b 7761 7267 7320 3d20 4e6f 6e65 2069   kwargs = None i
-0001a560: 6620 6e6f 7420 6b77 6172 6773 2065 6c73  f not kwargs els
-0001a570: 6520 6b77 6172 6773 0a20 2020 2072 6573  e kwargs.    res
-0001a580: 6964 7561 6c73 203d 2028 6172 6773 2c20  iduals = (args, 
-0001a590: 6b77 6172 6773 2c20 7361 7665 645f 666f  kwargs, saved_fo
-0001a5a0: 725f 6261 636b 7761 7264 290a 2020 2020  r_backward).    
-0001a5b0: 7265 7475 726e 2056 4a50 4475 616c 2872  return VJPDual(r
-0001a5c0: 6573 756c 742c 2072 6573 6964 7561 6c73  esult, residuals
-0001a5d0: 290a 0a0a 6465 6620 6465 636f 6d70 6f73  )...def decompos
-0001a5e0: 6564 5f66 6e5f 6261 636b 7761 7264 5f72  ed_fn_backward_r
-0001a5f0: 756c 6528 6465 636f 6d70 6f73 6564 5f66  ule(decomposed_f
-0001a600: 6e2c 2061 7267 732c 206b 7761 7267 732c  n, args, kwargs,
-0001a610: 2073 6176 6564 5f66 6f72 5f62 6163 6b77   saved_for_backw
-0001a620: 6172 642c 202a 6772 6164 7329 3a0a 2020  ard, *grads):.  
-0001a630: 2020 6b77 6172 6773 203d 207b 7d20 6966    kwargs = {} if
-0001a640: 206b 7761 7267 7320 6973 204e 6f6e 6520   kwargs is None 
-0001a650: 656c 7365 206b 7761 7267 730a 2020 2020  else kwargs.    
-0001a660: 7472 6163 6520 3d20 636f 6e73 7472 7563  trace = construc
-0001a670: 745f 7472 6163 6528 2928 6465 636f 6d70  t_trace()(decomp
-0001a680: 6f73 6564 5f66 6e2c 202a 6172 6773 2c20  osed_fn, *args, 
-0001a690: 2a2a 6b77 6172 6773 290a 2020 2020 7472  **kwargs).    tr
-0001a6a0: 6163 6520 3d20 756e 7772 6170 5f6f 6e65  ace = unwrap_one
-0001a6b0: 5f6c 6576 656c 5f6f 665f 7375 6273 796d  _level_of_subsym
-0001a6c0: 626f 6c73 2874 7261 6365 290a 2020 2020  bols(trace).    
-0001a6d0: 7472 6163 6520 3d20 6463 6528 7472 6163  trace = dce(trac
-0001a6e0: 6529 0a20 2020 2023 2062 6f75 6e64 5f73  e).    # bound_s
-0001a6f0: 796d 626f 6c73 203d 2069 7465 725f 626f  ymbols = iter_bo
-0001a700: 756e 645f 7379 6d62 6f6c 7328 7472 6163  und_symbols(trac
-0001a710: 652e 626f 756e 645f 7379 6d62 6f6c 7329  e.bound_symbols)
-0001a720: 0a20 2020 2023 2072 6563 6f6e 7374 7275  .    # reconstru
-0001a730: 6374 6564 5f65 6e76 203d 207b 0a20 2020  cted_env = {.   
-0001a740: 2023 2020 2020 2073 6571 7565 6e63 6966   #     sequencif
-0001a750: 7928 7379 6d62 6f6c 2e6f 7574 7075 7429  y(symbol.output)
-0001a760: 5b30 5d2e 6e61 6d65 3a20 564a 5044 7561  [0].name: VJPDua
-0001a770: 6c28 4e6f 6e65 2c20 7361 7665 645f 666f  l(None, saved_fo
-0001a780: 725f 6261 636b 7761 7264 5b69 5d29 0a20  r_backward[i]). 
-0001a790: 2020 2023 2020 2020 2066 6f72 2069 2c20     #     for i, 
-0001a7a0: 7379 6d62 6f6c 2069 6e20 656e 756d 6572  symbol in enumer
-0001a7b0: 6174 6528 626f 756e 645f 7379 6d62 6f6c  ate(bound_symbol
-0001a7c0: 7329 0a20 2020 2023 207d 0a20 2020 2072  s).    # }.    r
-0001a7d0: 6563 6f6e 7374 7275 6374 6564 5f65 6e76  econstructed_env
-0001a7e0: 203d 2072 6563 6f6e 7374 7275 6374 5f66   = reconstruct_f
-0001a7f0: 6f72 7761 7264 5f65 6e76 5f66 6f72 5f62  orward_env_for_b
-0001a800: 6163 6b77 6172 6428 7472 6163 652c 2073  ackward(trace, s
-0001a810: 6176 6564 5f66 6f72 5f62 6163 6b77 6172  aved_for_backwar
-0001a820: 6429 0a20 2020 2072 6573 756c 7420 3d20  d).    result = 
-0001a830: 6261 636b 7761 7264 5f70 6173 7328 7265  backward_pass(re
-0001a840: 636f 6e73 7472 7563 7465 645f 656e 762c  constructed_env,
-0001a850: 2074 7261 6365 2c20 6772 6164 7329 0a20   trace, grads). 
-0001a860: 2020 2069 6620 6c65 6e28 6172 6773 2920     if len(args) 
-0001a870: 3d3d 2031 3a0a 2020 2020 2020 2020 7265  == 1:.        re
-0001a880: 7475 726e 2072 6573 756c 745b 305d 0a20  turn result[0]. 
-0001a890: 2020 2023 2042 6163 6b77 6172 6420 7061     # Backward pa
-0001a8a0: 7373 206d 6967 6874 2072 6574 7572 6e20  ss might return 
-0001a8b0: 6120 6469 6374 2077 6974 6820 6772 6164  a dict with grad
-0001a8c0: 7320 6275 7420 6375 7272 656e 7420 696e  s but current in
-0001a8d0: 7465 7266 6163 6520 6f66 0a20 2020 2023  terface of.    #
-0001a8e0: 2062 6163 6b77 6172 6420 7275 6c65 2064   backward rule d
-0001a8f0: 6f65 7320 6e6f 7420 7375 7070 6f72 7420  oes not support 
-0001a900: 6974 2e20 536f 2077 6520 6a75 7374 2064  it. So we just d
-0001a910: 726f 7020 6974 2066 6f72 206e 6f77 2e0a  rop it for now..
-0001a920: 2020 2020 656c 6966 2069 7369 6e73 7461      elif isinsta
-0001a930: 6e63 6528 7265 7375 6c74 5b2d 315d 2c20  nce(result[-1], 
-0001a940: 6469 6374 293a 0a20 2020 2020 2020 2072  dict):.        r
-0001a950: 6574 7572 6e20 7265 7375 6c74 5b3a 2d31  eturn result[:-1
-0001a960: 5d0a 2020 2020 7265 7475 726e 2072 6573  ].    return res
-0001a970: 756c 740a 0a0a 4072 6567 6973 7465 725f  ult...@register_
-0001a980: 6175 676d 656e 7465 645f 666f 7277 6172  augmented_forwar
-0001a990: 6428 2274 6f72 6368 2e54 656e 736f 722e  d("torch.Tensor.
-0001a9a0: 636f 6e74 6967 756f 7573 2229 0a40 7265  contiguous").@re
-0001a9b0: 6769 7374 6572 5f61 7567 6d65 6e74 6564  gister_augmented
-0001a9c0: 5f66 6f72 7761 7264 2822 746f 7263 682e  _forward("torch.
-0001a9d0: 636f 6e74 6967 756f 7573 2229 0a64 6566  contiguous").def
-0001a9e0: 2063 6f6e 7469 6775 6f75 735f 6175 675f   contiguous_aug_
-0001a9f0: 6677 6428 783a 2054 656e 736f 7250 726f  fwd(x: TensorPro
-0001aa00: 7879 2c20 2f2c 202a 2c20 6d65 6d6f 7279  xy, /, *, memory
-0001aa10: 5f66 6f72 6d61 743a 2074 6f72 6368 2e6d  _format: torch.m
-0001aa20: 656d 6f72 795f 666f 726d 6174 203d 2074  emory_format = t
-0001aa30: 6f72 6368 2e63 6f6e 7469 6775 6f75 735f  orch.contiguous_
-0001aa40: 666f 726d 6174 2920 2d3e 2056 4a50 4475  format) -> VJPDu
-0001aa50: 616c 3a0a 2020 2020 6672 6f6d 2074 6875  al:.    from thu
-0001aa60: 6e64 6572 2e74 6f72 6368 2069 6d70 6f72  nder.torch impor
-0001aa70: 7420 636f 6e74 6967 756f 7573 0a0a 2020  t contiguous..  
-0001aa80: 2020 7265 7475 726e 2056 4a50 4475 616c    return VJPDual
-0001aa90: 2863 6f6e 7469 6775 6f75 7328 782c 206d  (contiguous(x, m
-0001aaa0: 656d 6f72 795f 666f 726d 6174 3d6d 656d  emory_format=mem
-0001aab0: 6f72 795f 666f 726d 6174 292c 2074 7570  ory_format), tup
-0001aac0: 6c65 2829 290a 0a0a 4072 6567 6973 7465  le())...@registe
-0001aad0: 725f 6261 636b 7761 7264 2822 746f 7263  r_backward("torc
-0001aae0: 682e 5465 6e73 6f72 2e63 6f6e 7469 6775  h.Tensor.contigu
-0001aaf0: 6f75 7322 290a 4072 6567 6973 7465 725f  ous").@register_
-0001ab00: 6261 636b 7761 7264 2822 746f 7263 682e  backward("torch.
-0001ab10: 636f 6e74 6967 756f 7573 2229 0a64 6566  contiguous").def
-0001ab20: 2063 6f6e 7469 6775 6f75 735f 6261 636b   contiguous_back
-0001ab30: 7761 7264 282a 7265 7369 6475 616c 735f  ward(*residuals_
-0001ab40: 616e 645f 6772 6164 2920 2d3e 2054 656e  and_grad) -> Ten
-0001ab50: 736f 7250 726f 7879 3a0a 2020 2020 2320  sorProxy:.    # 
-0001ab60: 5265 7369 6475 616c 7320 6973 206e 6f74  Residuals is not
-0001ab70: 2065 6d70 7479 2062 6563 6175 7365 2063   empty because c
-0001ab80: 6f6e 7469 6775 6f75 7320 7379 6d62 6f6c  ontiguous symbol
-0001ab90: 2068 6173 2074 6865 2073 616d 6520 6f75   has the same ou
-0001aba0: 7470 7574 2061 7320 6974 7320 696e 7075  tput as its inpu
-0001abb0: 740a 2020 2020 6720 3d20 7265 7369 6475  t.    g = residu
-0001abc0: 616c 735f 616e 645f 6772 6164 5b2d 315d  als_and_grad[-1]
-0001abd0: 0a20 2020 2072 6574 7572 6e20 670a 0a0a  .    return g...
-0001abe0: 6465 6620 7265 6369 7072 6f63 616c 5f61  def reciprocal_a
-0001abf0: 7567 5f66 7764 2861 3a20 5465 6e73 6f72  ug_fwd(a: Tensor
-0001ac00: 5072 6f78 7929 202d 3e20 564a 5044 7561  Proxy) -> VJPDua
-0001ac10: 6c3a 0a20 2020 2070 7269 6d61 6c20 3d20  l:.    primal = 
-0001ac20: 7265 6369 7072 6f63 616c 2861 290a 2020  reciprocal(a).  
-0001ac30: 2020 7265 7475 726e 2056 4a50 4475 616c    return VJPDual
-0001ac40: 2870 7269 6d61 6c2c 2028 7072 696d 616c  (primal, (primal
-0001ac50: 2c29 290a 0a0a 6465 6620 7265 6369 7072  ,))...def recipr
-0001ac60: 6f63 616c 5f62 6163 6b77 6172 6428 7072  ocal_backward(pr
-0001ac70: 696d 616c 2c20 6729 3a0a 2020 2020 7265  imal, g):.    re
-0001ac80: 7475 726e 202d 6720 2a20 7072 696d 616c  turn -g * primal
-0001ac90: 202a 2070 7269 6d61 6c0a 0a0a 4070 6172   * primal...@par
-0001aca0: 7469 616c 2872 6567 6973 7465 725f 6772  tial(register_gr
-0001acb0: 6164 2c20 7072 696d 732e 5072 696d 4944  ad, prims.PrimID
-0001acc0: 732e 5245 4349 5052 4f43 414c 290a 6465  s.RECIPROCAL).de
-0001acd0: 6620 7265 6369 7072 6f63 616c 5f6a 6f69  f reciprocal_joi
-0001ace0: 6e74 5f66 6f72 7761 7264 5f62 6163 6b77  nt_forward_backw
-0001acf0: 6172 645f 7275 6c65 2861 3a20 5465 6e73  ard_rule(a: Tens
-0001ad00: 6f72 5072 6f78 7929 202d 3e20 5465 6e73  orProxy) -> Tens
-0001ad10: 6f72 5072 6f78 793a 0a20 2020 2072 6573  orProxy:.    res
-0001ad20: 756c 742c 2073 6176 6564 203d 2072 6563  ult, saved = rec
-0001ad30: 6970 726f 6361 6c5f 6175 675f 6677 6428  iprocal_aug_fwd(
-0001ad40: 6129 0a20 2020 2067 203d 2067 6574 5f67  a).    g = get_g
-0001ad50: 7261 6428 7265 7375 6c74 290a 2020 2020  rad(result).    
-0001ad60: 6761 203d 2072 6563 6970 726f 6361 6c5f  ga = reciprocal_
-0001ad70: 6261 636b 7761 7264 282a 7361 7665 642c  backward(*saved,
-0001ad80: 2067 290a 2020 2020 7075 745f 6772 6164   g).    put_grad
-0001ad90: 2861 2c20 6761 290a 2020 2020 7265 7475  (a, ga).    retu
-0001ada0: 726e 2072 6573 756c 740a 0a0a 4072 6567  rn result...@reg
-0001adb0: 6973 7465 725f 6175 676d 656e 7465 645f  ister_augmented_
-0001adc0: 666f 7277 6172 6428 2274 6f72 6368 2e69  forward("torch.i
-0001add0: 6e64 6578 5f70 7574 2229 0a64 6566 2069  ndex_put").def i
-0001ade0: 6e64 6578 5f70 7574 5f61 7567 5f66 7764  ndex_put_aug_fwd
-0001adf0: 280a 2020 2020 613a 2054 656e 736f 7250  (.    a: TensorP
-0001ae00: 726f 7879 2c20 2f2c 2069 6e64 6963 6573  roxy, /, indices
-0001ae10: 3a20 5365 7175 656e 6365 5b54 656e 736f  : Sequence[Tenso
-0001ae20: 7250 726f 7879 5d2c 2076 616c 7565 733a  rProxy], values:
-0001ae30: 2054 656e 736f 7250 726f 7879 2c20 6163   TensorProxy, ac
-0001ae40: 6375 6d75 6c61 7465 3a20 626f 6f6c 203d  cumulate: bool =
-0001ae50: 2046 616c 7365 0a29 202d 3e20 564a 5044   False.) -> VJPD
-0001ae60: 7561 6c3a 0a20 2020 2070 7269 6d61 6c20  ual:.    primal 
-0001ae70: 3d20 636c 616e 672e 696e 6465 785f 7075  = clang.index_pu
-0001ae80: 7428 612c 2069 6e64 6963 6573 2c20 7661  t(a, indices, va
-0001ae90: 6c75 6573 2c20 6163 6375 6d75 6c61 7465  lues, accumulate
-0001aea0: 290a 2020 2020 7265 7369 6475 616c 7320  ).    residuals 
-0001aeb0: 3d20 280a 2020 2020 2020 2020 696e 6469  = (.        indi
-0001aec0: 6365 732c 0a20 2020 2020 2020 2076 616c  ces,.        val
-0001aed0: 7565 732c 0a20 2020 2020 2020 2061 6363  ues,.        acc
-0001aee0: 756d 756c 6174 652c 0a20 2020 2029 0a20  umulate,.    ). 
-0001aef0: 2020 2072 6574 7572 6e20 564a 5044 7561     return VJPDua
-0001af00: 6c28 7072 696d 616c 2c20 7265 7369 6475  l(primal, residu
-0001af10: 616c 7329 0a0a 0a64 6566 2073 756d 5f74  als)...def sum_t
-0001af20: 6f28 613a 2054 656e 736f 7250 726f 7879  o(a: TensorProxy
-0001af30: 2c20 7368 6170 653a 2053 6571 7565 6e63  , shape: Sequenc
-0001af40: 655b 696e 745d 2920 2d3e 2054 656e 736f  e[int]) -> Tenso
-0001af50: 7250 726f 7879 3a0a 2020 2020 6966 206e  rProxy:.    if n
-0001af60: 6f74 2073 6861 7065 3a0a 2020 2020 2020  ot shape:.      
-0001af70: 2020 7265 7475 726e 2061 2e73 756d 2829    return a.sum()
-0001af80: 0a20 2020 206c 6561 6469 6e67 5f64 696d  .    leading_dim
-0001af90: 7320 3d20 612e 6e64 696d 202d 206c 656e  s = a.ndim - len
-0001afa0: 2873 6861 7065 290a 2020 2020 7265 6475  (shape).    redu
-0001afb0: 6365 5f64 696d 7320 3d20 7475 706c 6528  ce_dims = tuple(
-0001afc0: 7261 6e67 6528 6c65 6164 696e 675f 6469  range(leading_di
-0001afd0: 6d73 2929 202b 2074 7570 6c65 280a 2020  ms)) + tuple(.  
-0001afe0: 2020 2020 2020 6920 666f 7220 6920 696e        i for i in
-0001aff0: 2072 616e 6765 286c 6561 6469 6e67 5f64   range(leading_d
-0001b000: 696d 732c 2061 2e6e 6469 6d29 2069 6620  ims, a.ndim) if 
-0001b010: 7368 6170 655b 6920 2d20 6c65 6164 696e  shape[i - leadin
-0001b020: 675f 6469 6d73 5d20 3d3d 2031 2061 6e64  g_dims] == 1 and
-0001b030: 2061 2e73 6861 7065 5b69 5d20 213d 2031   a.shape[i] != 1
-0001b040: 0a20 2020 2029 0a20 2020 2061 203d 206c  .    ).    a = l
-0001b050: 746f 7263 682e 7375 6d28 612c 2064 696d  torch.sum(a, dim
-0001b060: 3d72 6564 7563 655f 6469 6d73 2c20 6b65  =reduce_dims, ke
-0001b070: 6570 6469 6d3d 5472 7565 290a 2020 2020  epdim=True).    
-0001b080: 6966 206c 6561 6469 6e67 5f64 696d 7320  if leading_dims 
-0001b090: 3e20 303a 0a20 2020 2020 2020 2072 6574  > 0:.        ret
-0001b0a0: 7572 6e20 6c74 6f72 6368 2e76 6965 7728  urn ltorch.view(
-0001b0b0: 612c 2073 6861 7065 290a 2020 2020 7265  a, shape).    re
-0001b0c0: 7475 726e 2061 0a0a 0a40 7265 6769 7374  turn a...@regist
-0001b0d0: 6572 5f62 6163 6b77 6172 6428 2274 6f72  er_backward("tor
-0001b0e0: 6368 2e69 6e64 6578 5f70 7574 2229 0a64  ch.index_put").d
-0001b0f0: 6566 2069 6e64 6578 5f70 7574 5f62 6163  ef index_put_bac
-0001b100: 6b77 6172 6428 696e 6469 6365 733a 2053  kward(indices: S
-0001b110: 6571 7565 6e63 655b 5465 6e73 6f72 5072  equence[TensorPr
-0001b120: 6f78 795d 2c20 7661 6c75 6573 3a20 5465  oxy], values: Te
-0001b130: 6e73 6f72 5072 6f78 792c 2061 6363 756d  nsorProxy, accum
-0001b140: 756c 6174 653a 2062 6f6f 6c2c 2067 3a20  ulate: bool, g: 
-0001b150: 5465 6e73 6f72 5072 6f78 7929 3a0a 2020  TensorProxy):.  
-0001b160: 2020 675f 7661 6c75 6573 203d 2067 5b69    g_values = g[i
-0001b170: 6e64 6963 6573 5d0a 2020 2020 2320 746f  ndices].    # to
-0001b180: 7263 6820 6861 7320 6578 7472 6120 6c6f  rch has extra lo
-0001b190: 6769 6320 746f 2068 616e 646c 6520 7468  gic to handle th
-0001b1a0: 6520 6578 7061 6e64 6564 2076 616c 7565  e expanded value
-0001b1b0: 730a 2020 2020 6966 206e 6f74 2075 7469  s.    if not uti
-0001b1c0: 6c73 2e73 616d 655f 7368 6170 6528 675f  ls.same_shape(g_
-0001b1d0: 7661 6c75 6573 2e73 6861 7065 2c20 7661  values.shape, va
-0001b1e0: 6c75 6573 2e73 6861 7065 293a 0a20 2020  lues.shape):.   
-0001b1f0: 2020 2020 2069 6620 636c 616e 672e 636f       if clang.co
-0001b200: 6d70 7574 655f 6272 6f61 6463 6173 745f  mpute_broadcast_
-0001b210: 7368 6170 6528 675f 7661 6c75 6573 2e73  shape(g_values.s
-0001b220: 6861 7065 2c20 7661 6c75 6573 2e73 6861  hape, values.sha
-0001b230: 7065 293a 0a20 2020 2020 2020 2020 2020  pe):.           
-0001b240: 2067 5f76 616c 7565 7320 3d20 7375 6d5f   g_values = sum_
-0001b250: 746f 2867 5f76 616c 7565 732c 2076 616c  to(g_values, val
-0001b260: 7565 732e 7368 6170 6529 0a20 2020 2069  ues.shape).    i
-0001b270: 6620 6163 6375 6d75 6c61 7465 3a0a 2020  f accumulate:.  
-0001b280: 2020 2020 2020 7265 7475 726e 2067 2c20        return g, 
-0001b290: 675f 7661 6c75 6573 0a20 2020 2072 6574  g_values.    ret
-0001b2a0: 7572 6e20 636c 616e 672e 696e 6465 785f  urn clang.index_
-0001b2b0: 7075 7428 672c 2069 6e64 6963 6573 2c20  put(g, indices, 
-0001b2c0: 6c74 6f72 6368 2e7a 6572 6f73 5f6c 696b  ltorch.zeros_lik
-0001b2d0: 6528 7661 6c75 6573 292c 2046 616c 7365  e(values), False
-0001b2e0: 292c 2067 5f76 616c 7565 730a 0a0a 6465  ), g_values...de
-0001b2f0: 6620 756e 6966 6f72 6d5f 6175 675f 6677  f uniform_aug_fw
-0001b300: 6428 7368 6170 652c 206d 696e 7661 6c2c  d(shape, minval,
-0001b310: 206d 6178 7661 6c2c 202a 2c20 6465 7669   maxval, *, devi
-0001b320: 6365 2c20 6474 7970 6529 3a0a 2020 2020  ce, dtype):.    
-0001b330: 7072 696d 616c 203d 2070 7269 6d73 2e75  primal = prims.u
-0001b340: 6e69 666f 726d 2873 6861 7065 2c20 6d69  niform(shape, mi
-0001b350: 6e76 616c 2c20 6d61 7876 616c 2c20 6465  nval, maxval, de
-0001b360: 7669 6365 3d64 6576 6963 652c 2064 7479  vice=device, dty
-0001b370: 7065 3d64 7479 7065 290a 2020 2020 7265  pe=dtype).    re
-0001b380: 7475 726e 2056 4a50 4475 616c 2870 7269  turn VJPDual(pri
-0001b390: 6d61 6c2c 2028 7072 696d 616c 2c20 6d69  mal, (primal, mi
-0001b3a0: 6e76 616c 2c20 6d61 7876 616c 2929 0a0a  nval, maxval))..
-0001b3b0: 0a64 6566 2075 6e69 666f 726d 5f62 6163  .def uniform_bac
-0001b3c0: 6b77 6172 6428 7072 696d 616c 2c20 6d69  kward(primal, mi
-0001b3d0: 6e76 616c 2c20 6d61 7876 616c 2c20 6729  nval, maxval, g)
-0001b3e0: 3a0a 2020 2020 2320 756e 6966 6f72 6d20  :.    # uniform 
-0001b3f0: 6973 2069 6d70 6c65 6d65 6e74 6564 2061  is implemented a
-0001b400: 7320 286d 6178 7661 6c20 2d20 6d69 6e76  s (maxval - minv
-0001b410: 616c 2920 2a20 756e 6966 6f72 6d28 7368  al) * uniform(sh
-0001b420: 6170 652c 2030 2c20 3129 202b 206d 696e  ape, 0, 1) + min
-0001b430: 7661 6c0a 2020 2020 756e 7363 616c 6564  val.    unscaled
-0001b440: 5f70 7269 6d61 6c20 3d20 2870 7269 6d61  _primal = (prima
-0001b450: 6c20 2d20 6d69 6e76 616c 2920 2f20 286d  l - minval) / (m
-0001b460: 6178 7661 6c20 2d20 6d69 6e76 616c 290a  axval - minval).
-0001b470: 2020 2020 7265 6475 6365 5f61 6c6c 5f64      reduce_all_d
-0001b480: 696d 7320 3d20 7475 706c 6528 7261 6e67  ims = tuple(rang
-0001b490: 6528 672e 6e64 696d 2929 0a20 2020 2073  e(g.ndim)).    s
-0001b4a0: 756d 203d 2070 6172 7469 616c 2870 7269  um = partial(pri
-0001b4b0: 6d73 2e73 756d 2c20 6469 6d73 3d72 6564  ms.sum, dims=red
-0001b4c0: 7563 655f 616c 6c5f 6469 6d73 290a 2020  uce_all_dims).  
-0001b4d0: 2020 7265 7475 726e 204e 6f6e 652c 2073    return None, s
-0001b4e0: 756d 2867 202a 2028 3120 2d20 756e 7363  um(g * (1 - unsc
-0001b4f0: 616c 6564 5f70 7269 6d61 6c29 292c 2073  aled_primal)), s
-0001b500: 756d 2867 202a 2075 6e73 6361 6c65 645f  um(g * unscaled_
-0001b510: 7072 696d 616c 290a 0a0a 6e6f 6e64 6966  primal)...nondif
-0001b520: 6665 7265 6e74 6961 626c 655f 766a 705f  ferentiable_vjp_
-0001b530: 7379 6d62 6f6c 7320 3d20 2870 7269 6d73  symbols = (prims
-0001b540: 2e50 7269 6d49 4473 2e42 4954 5749 5345  .PrimIDs.BITWISE
-0001b550: 5f41 4e44 2c20 7072 696d 732e 5072 696d  _AND, prims.Prim
-0001b560: 4944 732e 5349 474e 4249 542c 2070 7269  IDs.SIGNBIT, pri
-0001b570: 6d73 2e50 7269 6d49 4473 2e46 554c 4c29  ms.PrimIDs.FULL)
-0001b580: 0a0a 0a64 6566 2069 735f 636f 6e73 7461  ...def is_consta
-0001b590: 6e74 5f66 6f72 5f76 6a70 2873 796d 626f  nt_for_vjp(symbo
-0001b5a0: 6c3a 2070 7269 6d73 2e53 796d 626f 6c29  l: prims.Symbol)
-0001b5b0: 202d 3e20 626f 6f6c 3a0a 2020 2020 2222   -> bool:.    ""
-0001b5c0: 2243 6865 636b 2069 6620 6120 7379 6d62  "Check if a symb
-0001b5d0: 6f6c 2069 7320 636f 6e73 7461 6e74 2066  ol is constant f
-0001b5e0: 6f72 2074 6865 2056 4a50 2074 7261 6e73  or the VJP trans
-0001b5f0: 666f 726d 2e0a 0a20 2020 2041 7267 733a  form...    Args:
-0001b600: 0a20 2020 2020 2020 2073 796d 626f 6c20  .        symbol 
-0001b610: 2870 7269 6d73 2e53 796d 626f 6c29 3a20  (prims.Symbol): 
-0001b620: 5379 6d62 6f6c 2074 6f20 6368 6563 6b2e  Symbol to check.
-0001b630: 0a0a 2020 2020 5265 7475 726e 733a 0a20  ..    Returns:. 
-0001b640: 2020 2020 2020 2062 6f6f 6c3a 2054 7275         bool: Tru
-0001b650: 6520 6966 2074 6865 2073 796d 626f 6c20  e if the symbol 
-0001b660: 6973 2063 6f6e 7374 616e 742c 2046 616c  is constant, Fal
-0001b670: 7365 206f 7468 6572 7769 7365 2e0a 2020  se otherwise..  
-0001b680: 2020 2222 220a 2020 2020 6172 655f 616c    """.    are_al
-0001b690: 6c5f 6172 6773 5f6e 6f6e 5f64 6966 6665  l_args_non_diffe
-0001b6a0: 7265 6e74 6961 626c 6520 3d20 6e6f 7420  rentiable = not 
-0001b6b0: 616e 7928 6973 696e 7374 616e 6365 2861  any(isinstance(a
-0001b6c0: 7267 2c20 2846 6c6f 6174 5072 6f78 792c  rg, (FloatProxy,
-0001b6d0: 2054 656e 736f 7250 726f 7879 2929 2066   TensorProxy)) f
-0001b6e0: 6f72 2061 7267 2069 6e20 7379 6d62 6f6c  or arg in symbol
-0001b6f0: 2e66 6c61 745f 6172 6773 290a 2020 2020  .flat_args).    
-0001b700: 7265 7475 726e 2028 0a20 2020 2020 2020  return (.       
-0001b710: 2061 7265 5f61 6c6c 5f61 7267 735f 6e6f   are_all_args_no
-0001b720: 6e5f 6469 6666 6572 656e 7469 6162 6c65  n_differentiable
-0001b730: 0a20 2020 2020 2020 206f 7220 7379 6d62  .        or symb
-0001b740: 6f6c 2e61 7265 5f61 6c6c 5f61 7267 735f  ol.are_all_args_
-0001b750: 636f 6e73 7461 6e74 0a20 2020 2020 2020  constant.       
-0001b760: 206f 7220 7379 6d62 6f6c 2e73 796d 2e69   or symbol.sym.i
-0001b770: 6420 696e 206e 6f6e 6469 6666 6572 656e  d in nondifferen
-0001b780: 7469 6162 6c65 5f76 6a70 5f73 796d 626f  tiable_vjp_symbo
-0001b790: 6c73 0a20 2020 2029 0a0a 0a64 6566 2076  ls.    )...def v
-0001b7a0: 6a70 5f73 796d 626f 6c5f 6d61 7070 6572  jp_symbol_mapper
-0001b7b0: 2873 796d 626f 6c3a 2070 7269 6d73 2e53  (symbol: prims.S
-0001b7c0: 796d 626f 6c2c 202a 6172 6773 2c20 2a2a  ymbol, *args, **
-0001b7d0: 6b77 6172 6773 293a 0a20 2020 2022 2222  kwargs):.    """
-0001b7e0: 5379 6d62 6f6c 206d 6170 7065 7220 666f  Symbol mapper fo
-0001b7f0: 7220 7468 6520 564a 5020 7472 616e 7366  r the VJP transf
-0001b800: 6f72 6d2e 0a0a 2020 2020 4172 6773 3a0a  orm...    Args:.
-0001b810: 2020 2020 2020 2020 7379 6d62 6f6c 2028          symbol (
-0001b820: 7072 696d 732e 5379 6d62 6f6c 293a 2053  prims.Symbol): S
-0001b830: 796d 626f 6c20 746f 2062 6520 6d61 7070  ymbol to be mapp
-0001b840: 6564 2e0a 2020 2020 2020 2020 6172 6773  ed..        args
-0001b850: 2028 5475 706c 655b 5661 7269 6162 6c65   (Tuple[Variable
-0001b860: 5d29 3a20 4172 6775 6d65 6e74 7320 746f  ]): Arguments to
-0001b870: 2074 6865 2073 796d 626f 6c2e 0a20 2020   the symbol..   
-0001b880: 2020 2020 206b 7761 7267 7320 2844 6963       kwargs (Dic
-0001b890: 745b 7374 722c 2056 6172 6961 626c 655d  t[str, Variable]
-0001b8a0: 293a 204b 6579 776f 7264 2061 7267 756d  ): Keyword argum
-0001b8b0: 656e 7473 2074 6f20 7468 6520 7379 6d62  ents to the symb
-0001b8c0: 6f6c 2e0a 0a20 2020 2052 6574 7572 6e73  ol...    Returns
-0001b8d0: 3a0a 2020 2020 2020 2020 4361 6c6c 6162  :.        Callab
-0001b8e0: 6c65 3a20 4120 6675 6e63 7469 6f6e 2074  le: A function t
-0001b8f0: 6861 7420 636f 6d70 7574 6573 2074 6865  hat computes the
-0001b900: 2056 4a50 206f 6620 7468 6520 7379 6d62   VJP of the symb
-0001b910: 6f6c 2e0a 2020 2020 2222 220a 2020 2020  ol..    """.    
-0001b920: 2320 436f 6e73 7461 6e74 2063 6173 650a  # Constant case.
-0001b930: 2020 2020 6966 2069 735f 636f 6e73 7461      if is_consta
-0001b940: 6e74 5f66 6f72 5f76 6a70 2873 796d 626f  nt_for_vjp(symbo
-0001b950: 6c29 3a0a 0a20 2020 2020 2020 2064 6566  l):..        def
-0001b960: 2076 6a70 5f69 6d70 6c5f 636f 6e73 7428   vjp_impl_const(
-0001b970: 7379 6d62 6f6c 2c20 2a61 7267 732c 202a  symbol, *args, *
-0001b980: 2a6b 7761 7267 7329 3a0a 2020 2020 2020  *kwargs):.      
-0001b990: 2020 2020 2020 6172 6773 2c20 6b77 6172        args, kwar
-0001b9a0: 6773 203d 2074 7265 655f 6d61 7028 6c61  gs = tree_map(la
-0001b9b0: 6d62 6461 2078 3a20 782e 7072 696d 616c  mbda x: x.primal
-0001b9c0: 2069 6620 6973 696e 7374 616e 6365 2878   if isinstance(x
-0001b9d0: 2c20 564a 5044 7561 6c29 2065 6c73 6520  , VJPDual) else 
-0001b9e0: 782c 2028 6172 6773 2c20 6b77 6172 6773  x, (args, kwargs
-0001b9f0: 2929 0a20 2020 2020 2020 2020 2020 2070  )).            p
-0001ba00: 7269 6d61 6c73 203d 2073 796d 626f 6c5f  rimals = symbol_
-0001ba10: 746f 5f65 7661 6c28 7379 6d62 6f6c 2928  to_eval(symbol)(
-0001ba20: 2a61 7267 732c 202a 2a6b 7761 7267 7329  *args, **kwargs)
-0001ba30: 0a20 2020 2020 2020 2020 2020 2069 6620  .            if 
-0001ba40: 6973 696e 7374 616e 6365 2870 7269 6d61  isinstance(prima
-0001ba50: 6c73 2c20 5365 7175 656e 6365 293a 0a20  ls, Sequence):. 
-0001ba60: 2020 2020 2020 2020 2020 2020 2020 2072                 r
-0001ba70: 6574 7572 6e20 7472 6565 5f6d 6170 286c  eturn tree_map(l
-0001ba80: 616d 6264 6120 783a 2056 4a50 4475 616c  ambda x: VJPDual
-0001ba90: 2878 2c20 7475 706c 6528 2929 2c20 7072  (x, tuple()), pr
-0001baa0: 696d 616c 7329 0a20 2020 2020 2020 2020  imals).         
-0001bab0: 2020 2072 6574 7572 6e20 564a 5044 7561     return VJPDua
-0001bac0: 6c28 7072 696d 616c 732c 2074 7570 6c65  l(primals, tuple
-0001bad0: 2829 290a 0a20 2020 2020 2020 2072 6574  ())..        ret
-0001bae0: 7572 6e20 7061 7274 6961 6c28 766a 705f  urn partial(vjp_
-0001baf0: 696d 706c 5f63 6f6e 7374 2c20 7379 6d62  impl_const, symb
-0001bb00: 6f6c 290a 0a20 2020 2023 204e 6f72 6d61  ol)..    # Norma
-0001bb10: 6c20 6361 7365 2c20 7765 2068 6176 6520  l case, we have 
-0001bb20: 6120 7072 6f78 7920 7461 6e67 656e 740a  a proxy tangent.
-0001bb30: 2020 2020 766a 705f 696d 706c 203d 2061      vjp_impl = a
-0001bb40: 7567 6d65 6e74 6564 5f66 6f72 7761 7264  ugmented_forward
-0001bb50: 5f69 6d70 6c73 2e67 6574 2873 796d 626f  _impls.get(symbo
-0001bb60: 6c2e 7379 6d2e 6964 290a 0a20 2020 2069  l.sym.id)..    i
-0001bb70: 6620 5f67 6574 5f67 7261 6466 6e5f 616e  f _get_gradfn_an
-0001bb80: 645f 6578 6563 7574 6f72 2873 796d 626f  d_executor(symbo
-0001bb90: 6c29 5b30 5d20 6973 206e 6f74 204e 6f6e  l)[0] is not Non
-0001bba0: 653a 0a20 2020 2020 2020 2076 6a70 5f69  e:.        vjp_i
-0001bbb0: 6d70 6c2c 2062 6163 6b77 6172 645f 666e  mpl, backward_fn
-0001bbc0: 203d 206d 616b 655f 6175 675f 666f 7277   = make_aug_forw
-0001bbd0: 6172 645f 616e 645f 6261 636b 7761 7264  ard_and_backward
-0001bbe0: 2873 796d 626f 6c29 0a0a 2020 2020 6966  (symbol)..    if
-0001bbf0: 2076 6a70 5f69 6d70 6c20 6973 204e 6f6e   vjp_impl is Non
-0001bc00: 653a 0a20 2020 2020 2020 2023 2057 6520  e:.        # We 
-0001bc10: 636f 756c 6420 6e6f 7420 6669 6e64 2061  could not find a
-0001bc20: 2056 4a50 2066 6f72 2074 6869 7320 7379   VJP for this sy
-0001bc30: 6d62 6f6c 2c20 736f 2077 6520 7472 7920  mbol, so we try 
-0001bc40: 746f 2064 6563 6f6d 706f 7365 2069 740a  to decompose it.
-0001bc50: 2020 2020 2020 2020 6966 206c 656e 2873          if len(s
-0001bc60: 796d 626f 6c2e 7375 6273 796d 626f 6c73  ymbol.subsymbols
-0001bc70: 2920 3e20 3020 616e 6420 6e6f 7420 6973  ) > 0 and not is
-0001bc80: 696e 7374 616e 6365 2873 796d 626f 6c2e  instance(symbol.
-0001bc90: 7379 6d2e 6964 2c20 7072 696d 732e 5072  sym.id, prims.Pr
-0001bca0: 696d 4944 7329 3a0a 2020 2020 2020 2020  imIDs):.        
-0001bcb0: 2020 2020 766a 705f 696d 706c 203d 2070      vjp_impl = p
-0001bcc0: 6172 7469 616c 2864 6563 6f6d 706f 7365  artial(decompose
-0001bcd0: 645f 666e 5f61 7567 5f66 7764 5f72 756c  d_fn_aug_fwd_rul
-0001bce0: 652c 2064 6563 6f6d 706f 7365 645f 666e  e, decomposed_fn
-0001bcf0: 3d73 796d 626f 6c2e 7379 6d29 0a20 2020  =symbol.sym).   
-0001bd00: 2020 2020 2065 6c73 653a 0a20 2020 2020       else:.     
-0001bd10: 2020 2020 2020 2023 2057 6520 636f 756c         # We coul
-0001bd20: 6420 6e6f 7420 6669 6e64 2061 2056 4a50  d not find a VJP
-0001bd30: 2066 6f72 2074 6869 7320 7379 6d62 6f6c   for this symbol
-0001bd40: 2061 6e64 2077 6520 636f 756c 6420 6e6f   and we could no
-0001bd50: 7420 6465 636f 6d70 6f73 6520 6974 0a20  t decompose it. 
-0001bd60: 2020 2020 2020 2020 2020 2023 2049 7420             # It 
-0001bd70: 636f 756c 6420 6265 2061 2074 6f72 6368  could be a torch
-0001bd80: 2e64 726f 706f 7574 2077 6974 6820 302e  .dropout with 0.
-0001bd90: 3020 7072 6f62 6162 696c 6974 792c 2073  0 probability, s
-0001bda0: 6f20 7765 2073 6b69 7020 6974 0a20 2020  o we skip it.   
-0001bdb0: 2020 2020 2020 2020 2069 6620 7379 6d62           if symb
-0001bdc0: 6f6c 2e73 796d 2e69 6420 3d3d 2022 746f  ol.sym.id == "to
-0001bdd0: 7263 682e 6e6e 2e66 756e 6374 696f 6e61  rch.nn.functiona
-0001bde0: 6c2e 6472 6f70 6f75 7422 3a0a 2020 2020  l.dropout":.    
-0001bdf0: 2020 2020 2020 2020 2020 2020 7265 7475              retu
-0001be00: 726e 204e 6f6e 650a 2020 2020 2020 2020  rn None.        
-0001be10: 2020 2020 7072 696e 7428 6622 564a 5020      print(f"VJP 
-0001be20: 666f 7220 7b73 796d 626f 6c7d 2069 7320  for {symbol} is 
-0001be30: 6e6f 7420 696d 706c 656d 656e 7465 6422  not implemented"
-0001be40: 290a 2020 2020 2020 2020 2020 2020 7261  ).            ra
-0001be50: 6973 6520 4e6f 7449 6d70 6c65 6d65 6e74  ise NotImplement
-0001be60: 6564 4572 726f 7228 6622 564a 5020 666f  edError(f"VJP fo
-0001be70: 7220 7b73 796d 626f 6c2e 7379 6d2e 6964  r {symbol.sym.id
-0001be80: 7d20 6973 206e 6f74 2069 6d70 6c65 6d65  } is not impleme
-0001be90: 6e74 6564 2229 0a0a 2020 2020 6465 6620  nted")..    def 
-0001bea0: 5f76 6a70 5f69 6d70 6c28 2a61 7267 732c  _vjp_impl(*args,
-0001beb0: 202a 2a6b 7761 7267 7329 3a0a 2020 2020   **kwargs):.    
-0001bec0: 2020 2020 7072 696d 616c 732c 206b 7761      primals, kwa
-0001bed0: 7267 7320 3d20 7472 6565 5f6d 6170 286c  rgs = tree_map(l
-0001bee0: 616d 6264 6120 783a 2078 2e70 7269 6d61  ambda x: x.prima
-0001bef0: 6c20 6966 2069 7369 6e73 7461 6e63 6528  l if isinstance(
-0001bf00: 782c 2056 4a50 4475 616c 2920 656c 7365  x, VJPDual) else
-0001bf10: 2078 2c20 2861 7267 732c 206b 7761 7267   x, (args, kwarg
-0001bf20: 7329 290a 2020 2020 2020 2020 6f75 745f  s)).        out_
-0001bf30: 7072 696d 616c 2c20 6f75 745f 7265 7369  primal, out_resi
-0001bf40: 6475 616c 7320 3d20 766a 705f 696d 706c  duals = vjp_impl
-0001bf50: 282a 7072 696d 616c 732c 202a 2a6b 7761  (*primals, **kwa
-0001bf60: 7267 7329 0a0a 2020 2020 2020 2020 2320  rgs)..        # 
-0001bf70: 5765 2061 7265 2073 6176 696e 6720 7468  We are saving th
-0001bf80: 6520 7265 7369 6475 616c 7320 616e 6420  e residuals and 
-0001bf90: 7075 6c6c 6261 636b 206f 6e6c 7920 696e  pullback only in
-0001bfa0: 2074 6865 2066 6972 7374 206f 7574 7075   the first outpu
-0001bfb0: 740a 2020 2020 2020 2020 2320 6261 636b  t.        # back
-0001bfc0: 7761 7264 5f70 6173 7320 7468 656e 2072  ward_pass then r
-0001bfd0: 6574 7269 6576 6573 2074 6865 2072 6573  etrieves the res
-0001bfe0: 6964 7561 6c73 2061 6e64 2070 756c 6c62  iduals and pullb
-0001bff0: 6163 6b20 6672 6f6d 2074 6865 2066 6972  ack from the fir
-0001c000: 7374 206f 7574 7075 740a 2020 2020 2020  st output.      
-0001c010: 2020 6966 2069 7369 6e73 7461 6e63 6528    if isinstance(
-0001c020: 6f75 745f 7072 696d 616c 2c20 5365 7175  out_primal, Sequ
-0001c030: 656e 6365 293a 0a20 2020 2020 2020 2020  ence):.         
-0001c040: 2020 2072 6574 7572 6e20 2856 4a50 4475     return (VJPDu
-0001c050: 616c 286f 7574 5f70 7269 6d61 6c5b 305d  al(out_primal[0]
-0001c060: 2c20 6f75 745f 7265 7369 6475 616c 7329  , out_residuals)
-0001c070: 2c20 2a28 564a 5044 7561 6c28 6f2c 2074  , *(VJPDual(o, t
-0001c080: 7570 6c65 2829 2920 666f 7220 6f20 696e  uple()) for o in
-0001c090: 206f 7574 5f70 7269 6d61 6c5b 313a 5d29   out_primal[1:])
-0001c0a0: 290a 0a20 2020 2020 2020 2072 6574 7572  )..        retur
-0001c0b0: 6e20 2856 4a50 4475 616c 286f 7574 5f70  n (VJPDual(out_p
-0001c0c0: 7269 6d61 6c2c 206f 7574 5f72 6573 6964  rimal, out_resid
-0001c0d0: 7561 6c73 292c 290a 0a20 2020 2072 6574  uals),)..    ret
-0001c0e0: 7572 6e20 5f76 6a70 5f69 6d70 6c0a 0a0a  urn _vjp_impl...
-0001c0f0: 6465 6620 6368 6563 6b5f 6273 796d 5f66  def check_bsym_f
-0001c100: 6f72 5f76 6a70 2862 7379 6d29 3a0a 2020  or_vjp(bsym):.  
-0001c110: 2020 2222 220a 2020 2020 4368 6563 6b20    """.    Check 
-0001c120: 6966 2061 2062 6f75 6e64 2073 796d 626f  if a bound symbo
-0001c130: 6c20 6973 2073 7570 706f 7274 6564 2062  l is supported b
-0001c140: 7920 766a 702e 0a0a 2020 2020 4172 6773  y vjp...    Args
-0001c150: 3a0a 2020 2020 2020 2020 6273 796d 2028  :.        bsym (
-0001c160: 426f 756e 6453 796d 626f 6c29 3a20 5468  BoundSymbol): Th
-0001c170: 6520 626f 756e 6420 7379 6d62 6f6c 2074  e bound symbol t
-0001c180: 6f20 6368 6563 6b2e 0a0a 2020 2020 5265  o check...    Re
-0001c190: 7475 726e 733a 0a20 2020 2020 2020 2062  turns:.        b
-0001c1a0: 6f6f 6c3a 2054 7275 6520 6966 2074 6865  ool: True if the
-0001c1b0: 2062 6f75 6e64 2073 796d 626f 6c20 6973   bound symbol is
-0001c1c0: 2073 7570 706f 7274 6564 2062 7920 766a   supported by vj
-0001c1d0: 702c 2046 616c 7365 206f 7468 6572 7769  p, False otherwi
-0001c1e0: 7365 2e0a 2020 2020 2222 220a 0a20 2020  se..    """..   
-0001c1f0: 2069 6620 6273 796d 2e73 796d 2e69 6420   if bsym.sym.id 
-0001c200: 696e 2074 7261 6e73 666f 726d 5f73 6b69  in transform_ski
-0001c210: 705f 6c69 7374 3a0a 2020 2020 2020 2020  p_list:.        
-0001c220: 7265 7475 726e 2054 7275 650a 0a20 2020  return True..   
-0001c230: 2069 6620 6273 796d 2e73 796d 2e69 6420   if bsym.sym.id 
-0001c240: 696e 2062 6163 6b77 6172 645f 696d 706c  in backward_impl
-0001c250: 7320 616e 6420 6273 796d 2e73 796d 2e69  s and bsym.sym.i
-0001c260: 6420 696e 2061 7567 6d65 6e74 6564 5f66  d in augmented_f
-0001c270: 6f72 7761 7264 5f69 6d70 6c73 3a0a 2020  orward_impls:.  
-0001c280: 2020 2020 2020 7265 7475 726e 2054 7275        return Tru
-0001c290: 650a 0a20 2020 2069 6620 6273 796d 2e73  e..    if bsym.s
-0001c2a0: 796d 2e69 6420 696e 205f 6772 6164 5f66  ym.id in _grad_f
-0001c2b0: 6e5f 6d61 703a 0a20 2020 2020 2020 2072  n_map:.        r
-0001c2c0: 6574 7572 6e20 5472 7565 0a0a 2020 2020  eturn True..    
-0001c2d0: 2320 5765 2063 6f75 6c64 206e 6f74 2066  # We could not f
-0001c2e0: 696e 6420 6120 564a 5020 666f 7220 7468  ind a VJP for th
-0001c2f0: 6973 2073 796d 626f 6c2c 2073 6f20 7765  is symbol, so we
-0001c300: 2074 7279 2074 6f20 6465 636f 6d70 6f73   try to decompos
-0001c310: 6520 6974 0a20 2020 2023 2069 6e74 6f20  e it.    # into 
-0001c320: 7375 622d 7379 6d62 6f6c 7320 616e 6420  sub-symbols and 
-0001c330: 6368 6563 6b20 6966 2074 6865 7920 6172  check if they ar
-0001c340: 6520 7375 7070 6f72 7465 640a 2020 2020  e supported.    
-0001c350: 6966 206c 656e 2862 7379 6d2e 7375 6273  if len(bsym.subs
-0001c360: 796d 626f 6c73 2920 3e20 3020 616e 6420  ymbols) > 0 and 
-0001c370: 6e6f 7420 6273 796d 2e73 796d 2e69 735f  not bsym.sym.is_
-0001c380: 7072 696d 3a0a 2020 2020 2020 2020 7375  prim:.        su
-0001c390: 6274 7261 6365 203d 2063 6f6e 7374 7275  btrace = constru
-0001c3a0: 6374 5f74 7261 6365 2829 2862 7379 6d2e  ct_trace()(bsym.
-0001c3b0: 7379 6d2c 202a 6273 796d 2e61 7267 732c  sym, *bsym.args,
-0001c3c0: 202a 2a62 7379 6d2e 6b77 6172 6773 290a   **bsym.kwargs).
-0001c3d0: 2020 2020 2020 2020 7375 6274 7261 6365          subtrace
-0001c3e0: 203d 2075 6e77 7261 705f 6f6e 655f 6c65   = unwrap_one_le
-0001c3f0: 7665 6c5f 6f66 5f73 7562 7379 6d62 6f6c  vel_of_subsymbol
-0001c400: 7328 7375 6274 7261 6365 290a 2020 2020  s(subtrace).    
-0001c410: 2020 2020 616c 6c5f 7375 7070 6f72 7465      all_supporte
-0001c420: 6420 3d20 616c 6c28 6368 6563 6b5f 6273  d = all(check_bs
-0001c430: 796d 5f66 6f72 5f76 6a70 2873 7562 6273  ym_for_vjp(subbs
-0001c440: 796d 2920 666f 7220 7375 6262 7379 6d20  ym) for subbsym 
-0001c450: 696e 2073 7562 7472 6163 652e 626f 756e  in subtrace.boun
-0001c460: 645f 7379 6d62 6f6c 7329 0a20 2020 2020  d_symbols).     
-0001c470: 2020 2072 6574 7572 6e20 616c 6c5f 7375     return all_su
-0001c480: 7070 6f72 7465 640a 0a20 2020 2072 6574  pported..    ret
-0001c490: 7572 6e20 4661 6c73 650a 0a0a 6465 6620  urn False...def 
-0001c4a0: 6175 676d 656e 7465 645f 666f 7277 6172  augmented_forwar
-0001c4b0: 645f 7061 7373 282a 6172 6773 2c20 7472  d_pass(*args, tr
-0001c4c0: 6163 653a 2054 7261 6365 2c20 2a2a 6b77  ace: Trace, **kw
-0001c4d0: 6172 6773 293a 0a20 2020 2022 2222 4175  args):.    """Au
-0001c4e0: 676d 656e 7465 6420 666f 7277 6172 6420  gmented forward 
-0001c4f0: 7061 7373 2066 6f72 2074 6865 2056 4a50  pass for the VJP
-0001c500: 2074 7261 6e73 666f 726d 2e0a 0a20 2020   transform...   
-0001c510: 2054 6865 2061 7567 6d65 6e74 6564 2066   The augmented f
-0001c520: 6f72 7761 7264 2070 6173 7320 6973 2061  orward pass is a
-0001c530: 2066 6f72 7761 7264 2070 6173 7320 7468   forward pass th
-0001c540: 6174 2072 6574 7572 6e73 2074 6865 2072  at returns the r
-0001c550: 6573 6964 7561 6c73 0a20 2020 206f 6620  esiduals.    of 
-0001c560: 7468 6520 666f 7277 6172 6420 7061 7373  the forward pass
-0001c570: 2e0a 2020 2020 5468 6573 6520 7265 7369  ..    These resi
-0001c580: 6475 616c 7320 6172 6520 7573 6564 2069  duals are used i
-0001c590: 6e20 7468 6520 6261 636b 7761 7264 2070  n the backward p
-0001c5a0: 6173 7320 746f 2063 6f6d 7075 7465 2074  ass to compute t
-0001c5b0: 6865 2056 4a50 2061 6e64 2074 6865 790a  he VJP and they.
-0001c5c0: 2020 2020 6172 6520 7265 636f 7264 6564      are recorded
-0001c5d0: 2069 6e20 7468 6520 656e 7669 726f 6e6d   in the environm
-0001c5e0: 656e 7420 6469 6374 696f 6e61 7279 2066  ent dictionary f
-0001c5f0: 6f72 2065 6163 6820 7661 7269 6162 6c65  or each variable
-0001c600: 2e0a 0a20 2020 2041 7267 733a 0a20 2020  ...    Args:.   
-0001c610: 2020 2020 2061 7267 7320 2854 7570 6c65       args (Tuple
-0001c620: 5b56 6172 6961 626c 655d 293a 2041 7267  [Variable]): Arg
-0001c630: 756d 656e 7473 2074 6f20 7468 6520 6675  uments to the fu
-0001c640: 6e63 7469 6f6e 2e0a 2020 2020 2020 2020  nction..        
-0001c650: 7472 6163 6520 2854 7261 6365 293a 2054  trace (Trace): T
-0001c660: 7261 6365 206f 6620 7468 6520 6675 6e63  race of the func
-0001c670: 7469 6f6e 2e0a 2020 2020 2020 2020 6b77  tion..        kw
-0001c680: 6172 6773 2028 4469 6374 5b73 7472 2c20  args (Dict[str, 
-0001c690: 5661 7269 6162 6c65 5d29 3a20 4b65 7977  Variable]): Keyw
-0001c6a0: 6f72 6420 6172 6775 6d65 6e74 7320 746f  ord arguments to
-0001c6b0: 2074 6865 2066 756e 6374 696f 6e2e 0a0a   the function...
-0001c6c0: 2020 2020 5265 7475 726e 733a 0a20 2020      Returns:.   
-0001c6d0: 2020 2020 2054 7570 6c65 5b41 6e79 2c20       Tuple[Any, 
-0001c6e0: 4469 6374 5b73 7472 2c20 416e 795d 5d3a  Dict[str, Any]]:
-0001c6f0: 2054 7570 6c65 206f 6620 7468 6520 7072   Tuple of the pr
-0001c700: 696d 616c 206f 7574 7075 7473 2061 6e64  imal outputs and
-0001c710: 2074 6865 2065 6e76 6972 6f6e 6d65 6e74   the environment
-0001c720: 2e0a 2020 2020 2222 220a 2020 2020 6172  ..    """.    ar
-0001c730: 6773 2c20 6b77 6172 6773 203d 2074 7265  gs, kwargs = tre
-0001c740: 655f 6d61 7028 6c61 6d62 6461 2078 3a20  e_map(lambda x: 
-0001c750: 564a 5044 7561 6c28 782c 2074 7570 6c65  VJPDual(x, tuple
-0001c760: 2829 292c 2028 6172 6773 2c20 6b77 6172  ()), (args, kwar
-0001c770: 6773 2929 0a20 2020 2072 6573 756c 742c  gs)).    result,
-0001c780: 2065 6e76 203d 2065 7661 6c5f 7472 6163   env = eval_trac
-0001c790: 6528 0a20 2020 2020 2020 2074 7261 6365  e(.        trace
-0001c7a0: 2c0a 2020 2020 2020 2020 2a61 7267 732c  ,.        *args,
-0001c7b0: 0a20 2020 2020 2020 202a 2a6b 7761 7267  .        **kwarg
-0001c7c0: 732c 0a20 2020 2020 2020 2077 6974 685f  s,.        with_
-0001c7d0: 656e 763d 5472 7565 2c0a 2020 2020 2020  env=True,.      
-0001c7e0: 2020 7379 6d62 6f6c 5f6d 6170 7065 723d    symbol_mapper=
-0001c7f0: 766a 705f 7379 6d62 6f6c 5f6d 6170 7065  vjp_symbol_mappe
-0001c800: 722c 0a20 2020 2029 0a20 2020 2072 6573  r,.    ).    res
-0001c810: 756c 7420 3d20 7472 6565 5f6d 6170 286c  ult = tree_map(l
-0001c820: 616d 6264 6120 783a 2078 2e70 7269 6d61  ambda x: x.prima
-0001c830: 6c20 6966 2069 7369 6e73 7461 6e63 6528  l if isinstance(
-0001c840: 782c 2056 4a50 4475 616c 2920 656c 7365  x, VJPDual) else
-0001c850: 2078 2c20 7265 7375 6c74 290a 2020 2020   x, result).    
-0001c860: 7265 7475 726e 2072 6573 756c 742c 2065  return result, e
-0001c870: 6e76 0a0a 0a23 2054 4f44 4f3a 2049 6e73  nv...# TODO: Ins
-0001c880: 7465 6164 206f 6620 7573 696e 6720 7468  tead of using th
-0001c890: 6520 656e 7669 726f 6e6d 656e 7420 6469  e environment di
-0001c8a0: 6374 696f 6e61 7279 2c20 7765 2063 6f75  ctionary, we cou
-0001c8b0: 6c64 2075 7365 2074 6865 2074 7261 6365  ld use the trace
-0001c8c0: 0a23 2073 796d 626f 6c73 206f 7264 6572  .# symbols order
-0001c8d0: 2028 7468 6174 2073 686f 756c 6420 6265   (that should be
-0001c8e0: 2064 6574 6572 6d69 6e69 7374 6963 2920   deterministic) 
-0001c8f0: 746f 2072 6574 7269 6576 6520 7468 6520  to retrieve the 
-0001c900: 7265 7369 6475 616c 7320 6e65 6564 6564  residuals needed
-0001c910: 0a23 2066 6f72 2074 6865 2062 6163 6b77  .# for the backw
-0001c920: 6172 6420 7061 7373 2e0a 6465 6620 6261  ard pass..def ba
-0001c930: 636b 7761 7264 5f70 6173 7328 666f 7277  ckward_pass(forw
-0001c940: 6172 645f 656e 762c 2074 7261 6365 2c20  ard_env, trace, 
-0001c950: 696e 6974 5f63 6f74 616e 6765 6e74 7329  init_cotangents)
-0001c960: 3a0a 2020 2020 2222 2242 6163 6b77 6172  :.    """Backwar
-0001c970: 6420 7061 7373 2066 6f72 2074 6865 2056  d pass for the V
-0001c980: 4a50 2074 7261 6e73 666f 726d 2e0a 0a20  JP transform... 
-0001c990: 2020 2054 6865 2062 6163 6b77 6172 6420     The backward 
-0001c9a0: 7061 7373 2069 7320 6120 7265 7665 7273  pass is a revers
-0001c9b0: 6520 6d6f 6465 2061 7574 6f6d 6174 6963  e mode automatic
-0001c9c0: 2064 6966 6665 7265 6e74 6961 7469 6f6e   differentiation
-0001c9d0: 2070 6173 7320 7468 6174 0a20 2020 2063   pass that.    c
-0001c9e0: 6f6d 7075 7465 7320 7468 6520 7665 6374  omputes the vect
-0001c9f0: 6f72 2d4a 6163 6f62 6961 6e20 7072 6f64  or-Jacobian prod
-0001ca00: 7563 7420 2856 4a50 2920 6f66 2074 6865  uct (VJP) of the
-0001ca10: 2066 756e 6374 696f 6e2e 0a0a 2020 2020   function...    
-0001ca20: 4172 6773 3a0a 2020 2020 2020 2020 666f  Args:.        fo
-0001ca30: 7277 6172 645f 656e 7620 2844 6963 745b  rward_env (Dict[
-0001ca40: 7374 722c 2041 6e79 5d29 3a20 456e 7669  str, Any]): Envi
-0001ca50: 726f 6e6d 656e 7420 6f66 2074 6865 2066  ronment of the f
-0001ca60: 6f72 7761 7264 2070 6173 732e 0a20 2020  orward pass..   
-0001ca70: 2020 2020 2074 7261 6365 2028 5472 6163       trace (Trac
-0001ca80: 6529 3a20 5472 6163 6520 6f66 2074 6865  e): Trace of the
-0001ca90: 2066 756e 6374 696f 6e2e 0a20 2020 2020   function..     
-0001caa0: 2020 2069 6e69 745f 636f 7461 6e67 656e     init_cotangen
-0001cab0: 7473 2028 5475 706c 655b 5661 7269 6162  ts (Tuple[Variab
-0001cac0: 6c65 5d29 3a20 496e 6974 6961 6c20 636f  le]): Initial co
-0001cad0: 7461 6e67 656e 7473 2e0a 0a20 2020 2052  tangents...    R
-0001cae0: 6574 7572 6e73 3a0a 2020 2020 2020 2020  eturns:.        
-0001caf0: 5475 706c 655b 5072 6f78 792c 202e 2e2e  Tuple[Proxy, ...
-0001cb00: 5d3a 2054 7570 6c65 206f 6620 7468 6520  ]: Tuple of the 
-0001cb10: 7265 7375 6c74 7320 6f66 2074 6865 2062  results of the b
-0001cb20: 6163 6b77 6172 6420 7061 7373 2066 6f72  ackward pass for
-0001cb30: 2065 6163 6820 696e 7075 742e 0a20 2020   each input..   
-0001cb40: 2022 2222 0a20 2020 2065 6e76 203d 207b   """.    env = {
-0001cb50: 7d0a 0a20 2020 2064 6566 2067 6574 5f67  }..    def get_g
-0001cb60: 7261 6428 783a 2056 6172 6961 626c 6529  rad(x: Variable)
-0001cb70: 3a0a 2020 2020 2020 2020 6966 2069 7369  :.        if isi
-0001cb80: 6e73 7461 6e63 6528 782c 2056 6172 6961  nstance(x, Varia
-0001cb90: 626c 6529 3a0a 2020 2020 2020 2020 2020  ble):.          
-0001cba0: 2020 2320 5265 7475 726e 204e 6f6e 6520    # Return None 
-0001cbb0: 6966 2074 6865 2076 6172 6961 626c 6520  if the variable 
-0001cbc0: 7761 7320 6e6f 7420 7573 6564 2069 6e20  was not used in 
-0001cbd0: 7468 6520 636f 6d70 7574 6174 696f 6e20  the computation 
-0001cbe0: 616e 640a 2020 2020 2020 2020 2020 2020  and.            
-0001cbf0: 2320 6865 6e63 6520 6e6f 7420 696e 2074  # hence not in t
-0001cc00: 6865 2065 6e76 0a20 2020 2020 2020 2020  he env.         
-0001cc10: 2020 2072 6574 7572 6e20 656e 762e 6765     return env.ge
-0001cc20: 7428 782e 6e61 6d65 2c20 4e6f 6e65 290a  t(x.name, None).
-0001cc30: 2020 2020 2020 2020 656c 7365 3a0a 2020          else:.  
-0001cc40: 2020 2020 2020 2020 2020 7265 7475 726e            return
-0001cc50: 2078 0a0a 2020 2020 6465 6620 7075 745f   x..    def put_
-0001cc60: 6772 6164 2876 3a20 5661 7269 6162 6c65  grad(v: Variable
-0001cc70: 2c20 7661 6c3a 2041 6e79 2920 2d3e 204e  , val: Any) -> N
-0001cc80: 6f6e 653a 0a20 2020 2020 2020 2069 6620  one:.        if 
-0001cc90: 6973 696e 7374 616e 6365 2876 2c20 5661  isinstance(v, Va
-0001cca0: 7269 6162 6c65 293a 0a20 2020 2020 2020  riable):.       
-0001ccb0: 2020 2020 2069 6620 762e 6e61 6d65 2069       if v.name i
-0001ccc0: 6e20 656e 763a 0a20 2020 2020 2020 2020  n env:.         
-0001ccd0: 2020 2020 2020 2069 6620 7661 6c20 6973         if val is
-0001cce0: 204e 6f6e 653a 0a20 2020 2020 2020 2020   None:.         
-0001ccf0: 2020 2020 2020 2020 2020 2072 6574 7572             retur
-0001cd00: 6e0a 2020 2020 2020 2020 2020 2020 2020  n.              
-0001cd10: 2020 2320 4163 6375 6d75 6c61 7465 2063    # Accumulate c
-0001cd20: 6f74 616e 6765 6e74 730a 2020 2020 2020  otangents.      
-0001cd30: 2020 2020 2020 2020 2020 656e 765b 762e            env[v.
-0001cd40: 6e61 6d65 5d20 3d20 636c 616e 672e 6164  name] = clang.ad
-0001cd50: 6428 656e 765b 762e 6e61 6d65 5d2c 2076  d(env[v.name], v
-0001cd60: 616c 2920 6966 2065 6e76 5b76 2e6e 616d  al) if env[v.nam
-0001cd70: 655d 2069 7320 6e6f 7420 4e6f 6e65 2065  e] is not None e
-0001cd80: 6c73 6520 7661 6c0a 2020 2020 2020 2020  lse val.        
-0001cd90: 2020 2020 2020 2020 7265 7475 726e 0a20          return. 
-0001cda0: 2020 2020 2020 2020 2020 2065 6e76 5b76             env[v
-0001cdb0: 2e6e 616d 655d 203d 2076 616c 0a20 2020  .name] = val.   
-0001cdc0: 2020 2020 2065 6c69 6620 6973 696e 7374       elif isinst
-0001cdd0: 616e 6365 2876 2c20 5365 7175 656e 6365  ance(v, Sequence
-0001cde0: 2920 616e 6420 616c 6c28 6973 696e 7374  ) and all(isinst
-0001cdf0: 616e 6365 2878 2c20 696e 7429 2066 6f72  ance(x, int) for
-0001ce00: 2078 2069 6e20 7629 3a0a 2020 2020 2020   x in v):.      
-0001ce10: 2020 2020 2020 2320 544f 444f 3a20 7265        # TODO: re
-0001ce20: 6d6f 7665 2077 6865 6e20 7765 206d 6f76  move when we mov
-0001ce30: 6520 6469 6d73 2074 6f20 6b77 6172 6773  e dims to kwargs
-0001ce40: 0a20 2020 2020 2020 2020 2020 2070 6173  .            pas
-0001ce50: 730a 2020 2020 2020 2020 656c 6966 2069  s.        elif i
-0001ce60: 7369 6e73 7461 6e63 6528 762c 2073 7472  sinstance(v, str
-0001ce70: 293a 0a20 2020 2020 2020 2020 2020 2065  ):.            e
-0001ce80: 6e76 5b76 5d20 3d20 7661 6c0a 2020 2020  nv[v] = val.    
-0001ce90: 2020 2020 656c 6966 2069 7369 6e73 7461      elif isinsta
-0001cea0: 6e63 6528 762c 2053 6571 7565 6e63 6529  nce(v, Sequence)
-0001ceb0: 2061 6e64 2076 616c 2069 7320 4e6f 6e65   and val is None
-0001cec0: 3a0a 2020 2020 2020 2020 2020 2020 2320  :.            # 
-0001ced0: 6272 6f61 6463 6173 7420 4e6f 6e65 2074  broadcast None t
-0001cee0: 6f20 7468 6520 7269 6768 7420 7368 6170  o the right shap
-0001cef0: 650a 2020 2020 2020 2020 2020 2020 7361  e.            sa
-0001cf00: 6665 5f6d 6170 2870 7574 5f67 7261 642c  fe_map(put_grad,
-0001cf10: 2076 2c20 5b4e 6f6e 655d 202a 206c 656e   v, [None] * len
-0001cf20: 2876 2929 0a20 2020 2020 2020 2065 6c69  (v)).        eli
-0001cf30: 6620 6973 696e 7374 616e 6365 2876 2c20  f isinstance(v, 
-0001cf40: 5365 7175 656e 6365 2920 616e 6420 6973  Sequence) and is
-0001cf50: 696e 7374 616e 6365 2876 616c 2c20 5365  instance(val, Se
-0001cf60: 7175 656e 6365 293a 0a20 2020 2020 2020  quence):.       
-0001cf70: 2020 2020 2073 6166 655f 6d61 705f 666c       safe_map_fl
-0001cf80: 6174 2870 7574 5f67 7261 642c 2076 2c20  at(put_grad, v, 
-0001cf90: 7661 6c29 0a20 2020 2020 2020 2065 6c73  val).        els
-0001cfa0: 653a 0a20 2020 2020 2020 2020 2020 2023  e:.            #
-0001cfb0: 2053 6b69 7020 7772 6974 696e 6720 746f   Skip writing to
-0001cfc0: 2063 6f6e 7374 616e 7473 0a20 2020 2020   constants.     
-0001cfd0: 2020 2020 2020 2070 6173 730a 0a20 2020         pass..   
-0001cfe0: 2069 6620 6973 696e 7374 616e 6365 2869   if isinstance(i
-0001cff0: 6e69 745f 636f 7461 6e67 656e 7473 2c20  nit_cotangents, 
-0001d000: 5365 7175 656e 6365 2920 616e 6420 6c65  Sequence) and le
-0001d010: 6e28 696e 6974 5f63 6f74 616e 6765 6e74  n(init_cotangent
-0001d020: 7329 203d 3d20 3120 616e 6420 6e6f 7420  s) == 1 and not 
-0001d030: 6973 696e 7374 616e 6365 2874 7261 6365  isinstance(trace
-0001d040: 2e6f 7574 7075 742c 2053 6571 7565 6e63  .output, Sequenc
-0001d050: 6529 3a0a 2020 2020 2020 2020 696e 6974  e):.        init
-0001d060: 5f63 6f74 616e 6765 6e74 7320 3d20 696e  _cotangents = in
-0001d070: 6974 5f63 6f74 616e 6765 6e74 735b 305d  it_cotangents[0]
-0001d080: 0a20 2020 2073 6166 655f 6d61 705f 666c  .    safe_map_fl
-0001d090: 6174 2870 7574 5f67 7261 642c 2074 7261  at(put_grad, tra
-0001d0a0: 6365 2e6f 7574 7075 742c 2069 6e69 745f  ce.output, init_
-0001d0b0: 636f 7461 6e67 656e 7473 290a 0a20 2020  cotangents)..   
-0001d0c0: 2066 6f72 2073 796d 626f 6c20 696e 2072   for symbol in r
-0001d0d0: 6576 6572 7365 6428 6c69 7374 2869 7465  eversed(list(ite
-0001d0e0: 725f 626f 756e 645f 7379 6d62 6f6c 7328  r_bound_symbols(
-0001d0f0: 7472 6163 652e 626f 756e 645f 7379 6d62  trace.bound_symb
-0001d100: 6f6c 7329 2929 3a0a 2020 2020 2020 2020  ols))):.        
-0001d110: 7379 6d62 6f6c 5f6f 7574 7075 7420 3d20  symbol_output = 
-0001d120: 7365 7175 656e 6369 6679 2873 796d 626f  sequencify(symbo
-0001d130: 6c2e 6f75 7470 7574 290a 0a20 2020 2020  l.output)..     
-0001d140: 2020 2063 6f74 616e 6765 6e74 7320 3d20     cotangents = 
-0001d150: 7472 6565 5f6d 6170 2867 6574 5f67 7261  tree_map(get_gra
-0001d160: 642c 2073 796d 626f 6c5f 6f75 7470 7574  d, symbol_output
-0001d170: 290a 2020 2020 2020 2020 2320 4861 7669  ).        # Havi
-0001d180: 6e67 2061 2073 696e 676c 6520 636f 7461  ng a single cota
-0001d190: 6e67 656e 7420 6973 2061 2063 6f6d 6d6f  ngent is a commo
-0001d1a0: 6e20 6361 7365 2c20 736f 2077 6520 666c  n case, so we fl
-0001d1b0: 6174 7465 6e20 6974 0a20 2020 2020 2020  atten it.       
-0001d1c0: 2023 204f 7468 6572 7769 7365 2c20 7765   # Otherwise, we
-0001d1d0: 2077 696c 6c20 6e65 6564 2074 6f20 7265   will need to re
-0001d1e0: 7772 6974 6520 7468 6520 7075 6c6c 6261  write the pullba
-0001d1f0: 636b 2066 756e 6374 696f 6e73 0a20 2020  ck functions.   
-0001d200: 2020 2020 2063 6f74 616e 6765 6e74 7320       cotangents 
-0001d210: 3d20 7472 6565 5f66 6c61 7474 656e 2863  = tree_flatten(c
-0001d220: 6f74 616e 6765 6e74 7329 5b30 5d0a 2020  otangents)[0].  
-0001d230: 2020 2020 2020 7265 7369 6475 616c 7320        residuals 
-0001d240: 3d20 666f 7277 6172 645f 656e 765b 7379  = forward_env[sy
-0001d250: 6d62 6f6c 5f6f 7574 7075 745b 305d 2e6e  mbol_output[0].n
-0001d260: 616d 655d 2e72 6573 6964 7561 6c73 0a20  ame].residuals. 
-0001d270: 2020 2020 2020 2069 6620 6973 5f63 6f6e         if is_con
-0001d280: 7374 616e 745f 666f 725f 766a 7028 7379  stant_for_vjp(sy
-0001d290: 6d62 6f6c 293a 0a20 2020 2020 2020 2020  mbol):.         
-0001d2a0: 2020 2023 2057 6520 6361 6e20 736b 6970     # We can skip
-0001d2b0: 2074 6865 2070 756c 6c62 6163 6b20 6966   the pullback if
-0001d2c0: 2061 6c6c 2074 6865 2061 7267 756d 656e   all the argumen
-0001d2d0: 7473 2061 7265 2063 6f6e 7374 616e 740a  ts are constant.
+00012170: 6d49 4473 2e41 4444 5d20 3d20 6164 645f  mIDs.ADD] = add_
+00012180: 6a76 700a 6a76 705f 696d 706c 735b 7072  jvp.jvp_impls[pr
+00012190: 696d 732e 5072 696d 4944 732e 4252 4f41  ims.PrimIDs.BROA
+000121a0: 4443 4153 545f 494e 5f44 494d 5d20 3d20  DCAST_IN_DIM] = 
+000121b0: 6272 6f61 6463 6173 745f 696e 5f64 696d  broadcast_in_dim
+000121c0: 5f6a 7670 0a23 206a 7670 5f69 6d70 6c73  _jvp.# jvp_impls
+000121d0: 5b70 7269 6d73 2e50 7269 6d49 4473 2e55  [prims.PrimIDs.U
+000121e0: 4e50 4143 4b5f 5345 5155 454e 4345 5d20  NPACK_SEQUENCE] 
+000121f0: 3d20 756e 7061 636b 5f73 6571 7565 6e63  = unpack_sequenc
+00012200: 655f 6a76 700a 2320 6a76 705f 696d 706c  e_jvp.# jvp_impl
+00012210: 735b 7072 696d 732e 5072 696d 4944 732e  s[prims.PrimIDs.
+00012220: 554e 5041 434b 5f54 5249 5649 414c 5d20  UNPACK_TRIVIAL] 
+00012230: 3d20 756e 7061 636b 5f74 7269 7669 616c  = unpack_trivial
+00012240: 5f6a 7670 0a0a 0a64 6566 206a 7670 5f73  _jvp...def jvp_s
+00012250: 796d 626f 6c5f 6d61 7070 6572 2873 796d  ymbol_mapper(sym
+00012260: 626f 6c3a 2070 7269 6d73 2e53 796d 626f  bol: prims.Symbo
+00012270: 6c29 3a0a 2020 2020 2222 224d 6170 7320  l):.    """Maps 
+00012280: 6120 7379 6d62 6f6c 2074 6f20 6120 4a56  a symbol to a JV
+00012290: 5020 6675 6e63 7469 6f6e 2074 6861 7420  P function that 
+000122a0: 6576 616c 7561 7465 7320 6974 2e0a 0a20  evaluates it... 
+000122b0: 2020 2041 7267 733a 0a20 2020 2020 2020     Args:.       
+000122c0: 2073 796d 626f 6c20 2870 7269 6d73 2e53   symbol (prims.S
+000122d0: 796d 626f 6c29 3a20 5379 6d62 6f6c 2074  ymbol): Symbol t
+000122e0: 6f20 6576 616c 7561 7465 2e0a 0a20 2020  o evaluate...   
+000122f0: 2052 6169 7365 733a 0a20 2020 2020 2020   Raises:.       
+00012300: 204e 6f74 496d 706c 656d 656e 7465 6445   NotImplementedE
+00012310: 7272 6f72 3a20 4966 2074 6865 204a 5650  rror: If the JVP
+00012320: 2066 6f72 2074 6865 2073 796d 626f 6c20   for the symbol 
+00012330: 6973 206e 6f74 2069 6d70 6c65 6d65 6e74  is not implement
+00012340: 6564 2e0a 0a20 2020 2052 6574 7572 6e73  ed...    Returns
+00012350: 3a0a 2020 2020 2020 2020 4361 6c6c 6162  :.        Callab
+00012360: 6c65 3a20 4a56 5020 6675 6e63 7469 6f6e  le: JVP function
+00012370: 2074 6861 7420 6576 616c 7561 7465 7320   that evaluates 
+00012380: 7468 6520 7379 6d62 6f6c 2e0a 2020 2020  the symbol..    
+00012390: 2222 220a 0a20 2020 2064 6566 2077 7261  """..    def wra
+000123a0: 705f 6172 6728 7829 3a0a 2020 2020 2020  p_arg(x):.      
+000123b0: 2020 6966 2069 7369 6e73 7461 6e63 6528    if isinstance(
+000123c0: 782c 204a 5650 4475 616c 293a 0a20 2020  x, JVPDual):.   
+000123d0: 2020 2020 2020 2020 2072 6574 7572 6e20           return 
+000123e0: 780a 2020 2020 2020 2020 656c 6966 2069  x.        elif i
+000123f0: 7369 6e73 7461 6e63 6528 782c 204e 756d  sinstance(x, Num
+00012400: 6265 7229 3a0a 2020 2020 2020 2020 2020  ber):.          
+00012410: 2020 7265 7475 726e 204a 5650 4475 616c    return JVPDual
+00012420: 2878 2c20 7479 7065 2878 2928 3029 290a  (x, type(x)(0)).
+00012430: 2020 2020 2020 2020 656c 7365 3a0a 2020          else:.  
+00012440: 2020 2020 2020 2020 2020 7261 6973 6520            raise 
+00012450: 5661 6c75 6545 7272 6f72 2866 224a 5650  ValueError(f"JVP
+00012460: 2077 7261 705f 6172 6720 676f 7420 616e   wrap_arg got an
+00012470: 2075 6e73 7570 706f 7274 6564 2074 7970   unsupported typ
+00012480: 6520 7b74 7970 6528 7829 7d22 290a 0a20  e {type(x)}").. 
+00012490: 2020 2023 2049 6620 7379 6d62 6f6c 2e61     # If symbol.a
+000124a0: 7267 7320 646f 6573 6e27 7420 6861 7665  rgs doesn't have
+000124b0: 2073 7562 636c 6173 7365 7320 6f66 2056   subclasses of V
+000124c0: 6172 6961 626c 652c 2074 6865 6e20 7765  ariable, then we
+000124d0: 206e 6565 6420 746f 2072 6574 7572 6e20   need to return 
+000124e0: 6120 7a65 726f 2074 616e 6765 6e74 0a20  a zero tangent. 
+000124f0: 2020 2023 2054 4f44 4f3a 2074 6865 7265     # TODO: there
+00012500: 206d 6179 2062 6520 6120 6265 7474 6572   may be a better
+00012510: 2077 6179 2074 6f20 6465 7465 6374 2063   way to detect c
+00012520: 6f6e 7374 616e 7473 2069 6e20 7468 6520  onstants in the 
+00012530: 7472 6163 650a 2020 2020 6966 2073 796d  trace.    if sym
+00012540: 626f 6c2e 6172 655f 616c 6c5f 6172 6773  bol.are_all_args
+00012550: 5f63 6f6e 7374 616e 743a 0a0a 2020 2020  _constant:..    
+00012560: 2020 2020 6465 6620 7a65 726f 735f 6c69      def zeros_li
+00012570: 6b65 2878 293a 0a20 2020 2020 2020 2020  ke(x):.         
+00012580: 2020 2069 6620 6973 696e 7374 616e 6365     if isinstance
+00012590: 2878 2c20 5465 6e73 6f72 5072 6f78 7929  (x, TensorProxy)
+000125a0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+000125b0: 2020 7265 7475 726e 2066 756c 6c5f 6c69    return full_li
+000125c0: 6b65 2878 2c20 6669 6c6c 5f76 616c 7565  ke(x, fill_value
+000125d0: 3d30 290a 2020 2020 2020 2020 2020 2020  =0).            
+000125e0: 656c 6966 2069 7369 6e73 7461 6e63 6528  elif isinstance(
+000125f0: 782c 204e 756d 6265 7250 726f 7879 293a  x, NumberProxy):
+00012600: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00012610: 2072 6574 7572 6e20 7479 7065 2878 2e76   return type(x.v
+00012620: 616c 7565 2928 3029 0a20 2020 2020 2020  alue)(0).       
+00012630: 2020 2020 2065 6c69 6620 6973 696e 7374       elif isinst
+00012640: 616e 6365 2878 2c20 4e75 6d62 6572 293a  ance(x, Number):
+00012650: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00012660: 2072 6574 7572 6e20 7479 7065 2878 2928   return type(x)(
+00012670: 3029 0a20 2020 2020 2020 2020 2020 2065  0).            e
+00012680: 6c73 653a 0a20 2020 2020 2020 2020 2020  lse:.           
+00012690: 2020 2020 2072 6169 7365 2056 616c 7565       raise Value
+000126a0: 4572 726f 7228 6622 7a65 726f 735f 6c69  Error(f"zeros_li
+000126b0: 6b65 2069 6e73 6964 6520 4a56 5020 676f  ke inside JVP go
+000126c0: 7420 616e 2075 6e73 7570 706f 7274 6564  t an unsupported
+000126d0: 2074 7970 6520 7b74 7970 6528 7829 7d22   type {type(x)}"
+000126e0: 290a 0a20 2020 2020 2020 2064 6566 206a  )..        def j
+000126f0: 7670 5f69 6d70 6c5f 636f 6e73 7428 7379  vp_impl_const(sy
+00012700: 6d62 6f6c 2c20 2a61 7267 732c 202a 2a6b  mbol, *args, **k
+00012710: 7761 7267 7329 3a0a 2020 2020 2020 2020  wargs):.        
+00012720: 2020 2020 7072 696d 616c 7320 3d20 7379      primals = sy
+00012730: 6d62 6f6c 5f74 6f5f 6576 616c 2873 796d  mbol_to_eval(sym
+00012740: 626f 6c29 282a 6172 6773 2c20 2a2a 6b77  bol)(*args, **kw
+00012750: 6172 6773 290a 2020 2020 2020 2020 2020  args).          
+00012760: 2020 6966 2069 7369 6e73 7461 6e63 6528    if isinstance(
+00012770: 7072 696d 616c 732c 2053 6571 7565 6e63  primals, Sequenc
+00012780: 6529 3a0a 2020 2020 2020 2020 2020 2020  e):.            
+00012790: 2020 2020 7461 6e67 656e 7473 203d 2074      tangents = t
+000127a0: 7570 6c65 287a 6572 6f73 5f6c 696b 6528  uple(zeros_like(
+000127b0: 7029 2066 6f72 2070 2069 6e20 7072 696d  p) for p in prim
+000127c0: 616c 7329 0a20 2020 2020 2020 2020 2020  als).           
+000127d0: 2020 2020 2072 6574 7572 6e20 7361 6665       return safe
+000127e0: 5f6d 6170 2870 6169 725f 746f 5f6a 7670  _map(pair_to_jvp
+000127f0: 5f64 7561 6c2c 2073 6166 655f 7a69 7028  _dual, safe_zip(
+00012800: 7072 696d 616c 732c 2074 616e 6765 6e74  primals, tangent
+00012810: 7329 290a 2020 2020 2020 2020 2020 2020  s)).            
+00012820: 7265 7475 726e 204a 5650 4475 616c 2870  return JVPDual(p
+00012830: 7269 6d61 6c73 2c20 7a65 726f 735f 6c69  rimals, zeros_li
+00012840: 6b65 2870 7269 6d61 6c73 2929 0a0a 2020  ke(primals))..  
+00012850: 2020 2020 2020 7265 7475 726e 2070 6172        return par
+00012860: 7469 616c 286a 7670 5f69 6d70 6c5f 636f  tial(jvp_impl_co
+00012870: 6e73 742c 2073 796d 626f 6c29 0a0a 2020  nst, symbol)..  
+00012880: 2020 2320 4e6f 726d 616c 2063 6173 652c    # Normal case,
+00012890: 2077 6520 6861 7665 2061 2070 726f 7879   we have a proxy
+000128a0: 2074 616e 6765 6e74 0a20 2020 206a 7670   tangent.    jvp
+000128b0: 5f69 6d70 6c20 3d20 6a76 705f 696d 706c  _impl = jvp_impl
+000128c0: 732e 6765 7428 7379 6d62 6f6c 2e73 796d  s.get(symbol.sym
+000128d0: 2e69 6429 0a20 2020 2069 6620 6a76 705f  .id).    if jvp_
+000128e0: 696d 706c 2069 7320 4e6f 6e65 3a0a 2020  impl is None:.  
+000128f0: 2020 2020 2020 7261 6973 6520 4e6f 7449        raise NotI
+00012900: 6d70 6c65 6d65 6e74 6564 4572 726f 7228  mplementedError(
+00012910: 6622 4a56 5020 666f 7220 7b73 796d 626f  f"JVP for {symbo
+00012920: 6c2e 7379 6d2e 6964 7d20 6973 206e 6f74  l.sym.id} is not
+00012930: 2069 6d70 6c65 6d65 6e74 6564 2229 0a0a   implemented")..
+00012940: 2020 2020 6465 6620 5f6a 7670 5f69 6d70      def _jvp_imp
+00012950: 6c28 2a61 7267 732c 202a 2a6b 7761 7267  l(*args, **kwarg
+00012960: 7329 3a0a 2020 2020 2020 2020 6172 6773  s):.        args
+00012970: 203d 2074 7265 655f 6d61 7028 7772 6170   = tree_map(wrap
+00012980: 5f61 7267 2c20 6172 6773 290a 2020 2020  _arg, args).    
+00012990: 2020 2020 2320 4578 7065 6374 696e 6720      # Expecting 
+000129a0: 4a56 5044 7561 6c73 2077 7261 7070 696e  JVPDuals wrappin
+000129b0: 6720 7061 6972 7320 6f66 2070 7269 6d61  g pairs of prima
+000129c0: 6c73 2061 6e64 2074 616e 6765 6e74 730a  ls and tangents.
+000129d0: 2020 2020 2020 2020 6173 7365 7274 2061          assert a
+000129e0: 6c6c 2869 7369 6e73 7461 6e63 6528 6172  ll(isinstance(ar
+000129f0: 672c 204a 5650 4475 616c 2920 666f 7220  g, JVPDual) for 
+00012a00: 6172 6720 696e 2074 7265 655f 666c 6174  arg in tree_flat
+00012a10: 7465 6e28 6172 6773 295b 305d 290a 2020  ten(args)[0]).  
+00012a20: 2020 2020 2020 7265 7475 726e 206a 7670        return jvp
+00012a30: 5f69 6d70 6c28 2a61 7267 732c 202a 2a6b  _impl(*args, **k
+00012a40: 7761 7267 7329 0a0a 2020 2020 7265 7475  wargs)..    retu
+00012a50: 726e 205f 6a76 705f 696d 706c 0a0a 0a64  rn _jvp_impl...d
+00012a60: 6566 205f 6a76 705f 6361 6c6c 5f6d 6574  ef _jvp_call_met
+00012a70: 6166 756e 6328 6465 7461 6368 6564 3a20  afunc(detached: 
+00012a80: 626f 6f6c 2c20 7072 696d 616c 732c 2074  bool, primals, t
+00012a90: 616e 6765 6e74 732c 202a 2c20 6675 6e63  angents, *, func
+00012aa0: 7469 6f6e 5f74 7261 6365 3a20 5472 6163  tion_trace: Trac
+00012ab0: 652c 202a 2a6b 7761 7267 7329 3a0a 2020  e, **kwargs):.  
+00012ac0: 2020 2222 224d 6574 6166 756e 6374 696f    """Metafunctio
+00012ad0: 6e20 666f 7220 7468 6520 4a56 5020 7472  n for the JVP tr
+00012ae0: 616e 7366 6f72 6d2e 0a0a 2020 2020 4172  ansform...    Ar
+00012af0: 6773 3a0a 2020 2020 2020 2020 6465 7461  gs:.        deta
+00012b00: 6368 6564 2028 626f 6f6c 293a 2057 6865  ched (bool): Whe
+00012b10: 7468 6572 2074 6f20 6465 7461 6368 2074  ther to detach t
+00012b20: 6865 2074 7261 6365 2e0a 2020 2020 2020  he trace..      
+00012b30: 2020 7072 696d 616c 7320 2854 7570 6c65    primals (Tuple
+00012b40: 5b50 726f 7879 5d29 3a20 5072 696d 616c  [Proxy]): Primal
+00012b50: 2076 616c 7565 732e 0a20 2020 2020 2020   values..       
+00012b60: 2074 616e 6765 6e74 7320 2854 7570 6c65   tangents (Tuple
+00012b70: 5b50 726f 7879 5d29 3a20 5461 6e67 656e  [Proxy]): Tangen
+00012b80: 7420 7661 6c75 6573 2e0a 2020 2020 2020  t values..      
+00012b90: 2020 6675 6e63 7469 6f6e 5f74 7261 6365    function_trace
+00012ba0: 2028 5472 6163 6529 3a20 5472 6163 6520   (Trace): Trace 
+00012bb0: 6f66 2074 6865 2066 756e 6374 696f 6e20  of the function 
+00012bc0: 746f 2062 6520 7472 616e 7366 6f72 6d65  to be transforme
+00012bd0: 642e 0a20 2020 2020 2020 206b 7761 7267  d..        kwarg
+00012be0: 733a 204b 6579 776f 7264 2061 7267 756d  s: Keyword argum
+00012bf0: 656e 7473 2e0a 0a20 2020 2052 6169 7365  ents...    Raise
+00012c00: 733a 0a20 2020 2020 2020 2041 7373 6572  s:.        Asser
+00012c10: 7469 6f6e 4572 726f 723a 2049 6620 7468  tionError: If th
+00012c20: 6520 4a56 5020 666f 7220 6b65 7977 6f72  e JVP for keywor
+00012c30: 6420 6172 6775 6d65 6e74 7320 6973 206e  d arguments is n
+00012c40: 6f74 2069 6d70 6c65 6d65 6e74 6564 2e0a  ot implemented..
+00012c50: 0a20 2020 2052 6574 7572 6e73 3a0a 2020  .    Returns:.  
+00012c60: 2020 2020 2020 5265 7375 6c74 206f 6620        Result of 
+00012c70: 7468 6520 4a56 5020 7472 616e 7366 6f72  the JVP transfor
+00012c80: 6d2e 0a20 2020 2022 2222 0a20 2020 2061  m..    """.    a
+00012c90: 7373 6572 7420 6c65 6e28 6b77 6172 6773  ssert len(kwargs
+00012ca0: 2920 3d3d 2030 2c20 224a 5650 2066 6f72  ) == 0, "JVP for
+00012cb0: 206b 7761 7267 7320 6973 206e 6f74 2069   kwargs is not i
+00012cc0: 6d70 6c65 6d65 6e74 6564 220a 0a20 2020  mplemented"..   
+00012cd0: 2063 7478 203d 2064 6574 6163 6865 645f   ctx = detached_
+00012ce0: 7472 6163 6528 2920 6966 2064 6574 6163  trace() if detac
+00012cf0: 6865 6420 656c 7365 206e 756c 6c63 6f6e  hed else nullcon
+00012d00: 7465 7874 2829 0a20 2020 2077 6974 6820  text().    with 
+00012d10: 6374 783a 0a20 2020 2020 2020 2023 2057  ctx:.        # W
+00012d20: 7261 7070 696e 6720 7468 6520 7072 696d  rapping the prim
+00012d30: 616c 7320 616e 6420 7461 6e67 656e 7473  als and tangents
+00012d40: 2069 6e20 4a56 5044 7561 6c73 2069 7320   in JVPDuals is 
+00012d50: 6e6f 7420 7374 7269 6374 6c79 206e 6563  not strictly nec
+00012d60: 6573 7361 7279 2c20 6275 7420 6974 206d  essary, but it m
+00012d70: 616b 6573 0a20 2020 2020 2020 2023 2074  akes.        # t
+00012d80: 6865 2063 6f64 6520 6d6f 7265 2072 6561  he code more rea
+00012d90: 6461 626c 650a 2020 2020 2020 2020 2320  dable.        # 
+00012da0: 5765 2070 726f 7061 6761 7465 2074 6865  We propagate the
+00012db0: 204a 5650 4475 616c 7320 7468 726f 7567   JVPDuals throug
+00012dc0: 6820 7468 6520 7472 6163 652c 2061 6e64  h the trace, and
+00012dd0: 2074 6865 6e20 756e 7772 6170 2074 6865   then unwrap the
+00012de0: 6d20 6174 2074 6865 2065 6e64 0a20 2020  m at the end.   
+00012df0: 2020 2020 2070 7269 6d61 6c73 5f74 616e       primals_tan
+00012e00: 6765 6e74 735f 6475 616c 7320 3d20 7361  gents_duals = sa
+00012e10: 6665 5f6d 6170 2870 6169 725f 746f 5f6a  fe_map(pair_to_j
+00012e20: 7670 5f64 7561 6c2c 2073 6166 655f 7a69  vp_dual, safe_zi
+00012e30: 7028 7072 696d 616c 732c 2074 616e 6765  p(primals, tange
+00012e40: 6e74 7329 290a 2020 2020 2020 2020 7265  nts)).        re
+00012e50: 7375 6c74 203d 2065 7661 6c5f 7472 6163  sult = eval_trac
+00012e60: 6528 6675 6e63 7469 6f6e 5f74 7261 6365  e(function_trace
+00012e70: 2c20 2a70 7269 6d61 6c73 5f74 616e 6765  , *primals_tange
+00012e80: 6e74 735f 6475 616c 732c 2073 796d 626f  nts_duals, symbo
+00012e90: 6c5f 6d61 7070 6572 3d6a 7670 5f73 796d  l_mapper=jvp_sym
+00012ea0: 626f 6c5f 6d61 7070 6572 290a 2020 2020  bol_mapper).    
+00012eb0: 2020 2020 2320 556e 7772 6170 7069 6e67      # Unwrapping
+00012ec0: 2074 6865 204a 5650 4475 616c 730a 2020   the JVPDuals.  
+00012ed0: 2020 2020 2020 6966 2069 7369 6e73 7461        if isinsta
+00012ee0: 6e63 6528 7265 7375 6c74 2c20 5365 7175  nce(result, Sequ
+00012ef0: 656e 6365 293a 0a20 2020 2020 2020 2020  ence):.         
+00012f00: 2020 2061 7373 6572 7420 616c 6c28 6973     assert all(is
+00012f10: 696e 7374 616e 6365 2878 2c20 4a56 5044  instance(x, JVPD
+00012f20: 7561 6c29 2066 6f72 2078 2069 6e20 7265  ual) for x in re
+00012f30: 7375 6c74 290a 2020 2020 2020 2020 2020  sult).          
+00012f40: 2020 7072 696d 616c 732c 2074 616e 6765    primals, tange
+00012f50: 6e74 7320 3d20 756e 7a69 7032 2872 6573  nts = unzip2(res
+00012f60: 756c 7429 0a20 2020 2020 2020 2020 2020  ult).           
+00012f70: 2072 6574 7572 6e20 7072 696d 616c 732c   return primals,
+00012f80: 2074 616e 6765 6e74 730a 2020 2020 2020   tangents.      
+00012f90: 2020 6173 7365 7274 2069 7369 6e73 7461    assert isinsta
+00012fa0: 6e63 6528 7265 7375 6c74 2c20 4a56 5044  nce(result, JVPD
+00012fb0: 7561 6c29 0a20 2020 2020 2020 2072 6574  ual).        ret
+00012fc0: 7572 6e20 7265 7375 6c74 2e70 7269 6d61  urn result.prima
+00012fd0: 6c2c 2072 6573 756c 742e 7461 6e67 656e  l, result.tangen
+00012fe0: 740a 0a0a 6a76 705f 6361 6c6c 203d 2053  t...jvp_call = S
+00012ff0: 796d 626f 6c28 6964 3d54 7261 6e73 666f  ymbol(id=Transfo
+00013000: 726d 732e 4a76 704f 702c 206e 616d 653d  rms.JvpOp, name=
+00013010: 226a 7670 5f63 616c 6c22 2c20 6d65 7461  "jvp_call", meta
+00013020: 3d70 6172 7469 616c 285f 6a76 705f 6361  =partial(_jvp_ca
+00013030: 6c6c 5f6d 6574 6166 756e 632c 2046 616c  ll_metafunc, Fal
+00013040: 7365 2929 0a0a 0a64 6566 205f 6964 656e  se))...def _iden
+00013050: 7469 7479 5f63 616c 6c5f 6a76 7028 2a61  tity_call_jvp(*a
+00013060: 7267 733a 204a 5650 4475 616c 2c20 7472  rgs: JVPDual, tr
+00013070: 6163 653a 2054 7261 6365 2c20 2a2a 6b77  ace: Trace, **kw
+00013080: 6172 6773 293a 0a20 2020 2070 7269 6d61  args):.    prima
+00013090: 6c73 2c20 7461 6e67 656e 7473 203d 2075  ls, tangents = u
+000130a0: 6e7a 6970 3228 6172 6773 290a 2020 2020  nzip2(args).    
+000130b0: 6f75 745f 7072 696d 616c 732c 206f 7574  out_primals, out
+000130c0: 5f74 616e 6765 6e74 7320 3d20 5f6a 7670  _tangents = _jvp
+000130d0: 5f63 616c 6c5f 6d65 7461 6675 6e63 2846  _call_metafunc(F
+000130e0: 616c 7365 2c20 7072 696d 616c 732c 2074  alse, primals, t
+000130f0: 616e 6765 6e74 732c 2074 7261 6365 2c20  angents, trace, 
+00013100: 2a2a 6b77 6172 6773 290a 2020 2020 6966  **kwargs).    if
+00013110: 2069 7369 6e73 7461 6e63 6528 6f75 745f   isinstance(out_
+00013120: 7072 696d 616c 732c 2053 6571 7565 6e63  primals, Sequenc
+00013130: 6529 3a0a 2020 2020 2020 2020 7265 7475  e):.        retu
+00013140: 726e 2073 6166 655f 6d61 7028 7061 6972  rn safe_map(pair
+00013150: 5f74 6f5f 6a76 705f 6475 616c 2c20 7361  _to_jvp_dual, sa
+00013160: 6665 5f7a 6970 286f 7574 5f70 7269 6d61  fe_zip(out_prima
+00013170: 6c73 2c20 6f75 745f 7461 6e67 656e 7473  ls, out_tangents
+00013180: 2929 0a20 2020 2072 6574 7572 6e20 4a56  )).    return JV
+00013190: 5044 7561 6c28 6f75 745f 7072 696d 616c  PDual(out_primal
+000131a0: 732c 206f 7574 5f74 616e 6765 6e74 7329  s, out_tangents)
+000131b0: 0a0a 0a6a 7670 5f69 6d70 6c73 5b54 7261  ...jvp_impls[Tra
+000131c0: 6e73 666f 726d 732e 4964 656e 7469 7479  nsforms.Identity
+000131d0: 4f70 5d20 3d20 5f69 6465 6e74 6974 795f  Op] = _identity_
+000131e0: 6361 6c6c 5f6a 7670 0a0a 0a64 6566 205f  call_jvp...def _
+000131f0: 766d 6170 5f63 616c 6c5f 6a76 7028 6172  vmap_call_jvp(ar
+00013200: 6773 3a20 4a56 5044 7561 6c2c 2069 6e5f  gs: JVPDual, in_
+00013210: 6469 6d73 2c20 6f75 745f 6469 6d73 2c20  dims, out_dims, 
+00013220: 6178 6973 5f73 697a 652c 2074 7261 6365  axis_size, trace
+00013230: 3a20 5472 6163 652c 202a 2a6b 7761 7267  : Trace, **kwarg
+00013240: 7329 3a0a 2020 2020 7072 696d 616c 732c  s):.    primals,
+00013250: 2074 616e 6765 6e74 7320 3d20 7361 6665   tangents = safe
+00013260: 5f7a 6970 282a 6172 6773 290a 2020 2020  _zip(*args).    
+00013270: 696e 5f64 696d 732c 205f 203d 2073 6166  in_dims, _ = saf
+00013280: 655f 7a69 7028 2a69 6e5f 6469 6d73 290a  e_zip(*in_dims).
+00013290: 2020 2020 6f75 745f 6469 6d73 2c20 5f20      out_dims, _ 
+000132a0: 3d20 7361 6665 5f7a 6970 282a 6f75 745f  = safe_zip(*out_
+000132b0: 6469 6d73 290a 2020 2020 766d 6170 7065  dims).    vmappe
+000132c0: 645f 7472 6163 6520 3d20 636f 6e73 7472  d_trace = constr
+000132d0: 7563 745f 7472 6163 6528 2928 0a20 2020  uct_trace()(.   
+000132e0: 2020 2020 2076 6d61 7028 7061 7274 6961       vmap(partia
+000132f0: 6c28 6576 616c 5f74 7261 6365 2c20 7472  l(eval_trace, tr
+00013300: 6163 6529 2c20 696e 5f64 696d 733d 696e  ace), in_dims=in
+00013310: 5f64 696d 732c 206f 7574 5f64 696d 733d  _dims, out_dims=
+00013320: 6f75 745f 6469 6d73 2c20 6178 6973 5f73  out_dims, axis_s
+00013330: 697a 653d 6178 6973 5f73 697a 6529 2c20  ize=axis_size), 
+00013340: 2a70 7269 6d61 6c73 0a20 2020 2029 0a20  *primals.    ). 
+00013350: 2020 2076 6d61 7070 6564 5f66 756e 6320     vmapped_func 
+00013360: 3d20 7061 7274 6961 6c28 6576 616c 5f74  = partial(eval_t
+00013370: 7261 6365 2c20 766d 6170 7065 645f 7472  race, vmapped_tr
+00013380: 6163 6529 0a20 2020 206f 7574 5f70 7269  ace).    out_pri
+00013390: 6d61 6c73 2c20 6f75 745f 7461 6e67 656e  mals, out_tangen
+000133a0: 7473 203d 206a 7670 2876 6d61 7070 6564  ts = jvp(vmapped
+000133b0: 5f66 756e 6329 2870 7269 6d61 6c73 2c20  _func)(primals, 
+000133c0: 7461 6e67 656e 7473 2c20 2a2a 6b77 6172  tangents, **kwar
+000133d0: 6773 290a 2020 2020 6966 2069 7369 6e73  gs).    if isins
+000133e0: 7461 6e63 6528 6f75 745f 7072 696d 616c  tance(out_primal
+000133f0: 732c 2053 6571 7565 6e63 6529 3a0a 2020  s, Sequence):.  
+00013400: 2020 2020 2020 7265 7475 726e 2073 6166        return saf
+00013410: 655f 6d61 7028 7061 6972 5f74 6f5f 6a76  e_map(pair_to_jv
+00013420: 705f 6475 616c 2c20 7361 6665 5f7a 6970  p_dual, safe_zip
+00013430: 286f 7574 5f70 7269 6d61 6c73 2c20 6f75  (out_primals, ou
+00013440: 745f 7461 6e67 656e 7473 2929 0a20 2020  t_tangents)).   
+00013450: 2072 6574 7572 6e20 4a56 5044 7561 6c28   return JVPDual(
+00013460: 6f75 745f 7072 696d 616c 732c 206f 7574  out_primals, out
+00013470: 5f74 616e 6765 6e74 7329 0a0a 0a6a 7670  _tangents)...jvp
+00013480: 5f69 6d70 6c73 5b54 7261 6e73 666f 726d  _impls[Transform
+00013490: 732e 566d 6170 4f70 5d20 3d20 5f76 6d61  s.VmapOp] = _vma
+000134a0: 705f 6361 6c6c 5f6a 7670 0a0a 0a64 6566  p_call_jvp...def
+000134b0: 206a 7670 2866 756e 6329 3a0a 2020 2020   jvp(func):.    
+000134c0: 2222 224a 6163 6f62 6961 6e2d 7665 6374  """Jacobian-vect
+000134d0: 6f72 2070 726f 6475 6374 2074 7261 6e73  or product trans
+000134e0: 666f 726d 2066 6f72 2061 2054 6875 6e64  form for a Thund
+000134f0: 6572 2066 756e 6374 696f 6e2e 0a0a 2020  er function...  
+00013500: 2020 4172 6773 3a0a 2020 2020 2020 2020    Args:.        
+00013510: 6675 6e63 2028 4361 6c6c 6162 6c65 293a  func (Callable):
+00013520: 2041 2054 6875 6e64 6572 2066 756e 6374   A Thunder funct
+00013530: 696f 6e20 746f 2062 6520 7472 616e 7366  ion to be transf
+00013540: 6f72 6d65 642e 0a0a 2020 2020 5265 7475  ormed...    Retu
+00013550: 726e 733a 0a20 2020 2020 2020 2043 616c  rns:.        Cal
+00013560: 6c61 626c 653a 2041 2066 756e 6374 696f  lable: A functio
+00013570: 6e20 7468 6174 2063 6f6d 7075 7465 7320  n that computes 
+00013580: 7468 6520 4a61 636f 6269 616e 2d76 6563  the Jacobian-vec
+00013590: 746f 7220 7072 6f64 7563 740a 2020 2020  tor product.    
+000135a0: 2020 2020 2020 2020 7461 6b69 6e67 2070          taking p
+000135b0: 7269 6d61 6c73 2061 6e64 2074 616e 6765  rimals and tange
+000135c0: 6e74 7320 6173 2061 7267 756d 656e 7473  nts as arguments
+000135d0: 2e0a 2020 2020 2222 220a 0a20 2020 2064  ..    """..    d
+000135e0: 6566 2077 7261 7070 6572 2870 7269 6d61  ef wrapper(prima
+000135f0: 6c73 2c20 7461 6e67 656e 7473 293a 0a20  ls, tangents):. 
+00013600: 2020 2020 2020 2074 7261 6365 203d 2063         trace = c
+00013610: 6f6e 7374 7275 6374 5f74 7261 6365 2829  onstruct_trace()
+00013620: 2866 756e 632c 202a 7072 696d 616c 7329  (func, *primals)
+00013630: 0a20 2020 2020 2020 2072 6574 7572 6e20  .        return 
+00013640: 6a76 705f 6361 6c6c 2870 7269 6d61 6c73  jvp_call(primals
+00013650: 2c20 7461 6e67 656e 7473 2c20 6675 6e63  , tangents, func
+00013660: 7469 6f6e 5f74 7261 6365 3d74 7261 6365  tion_trace=trace
+00013670: 290a 0a20 2020 2072 6574 7572 6e20 7772  )..    return wr
+00013680: 6170 7065 720a 0a0a 2320 544f 444f 2054  apper...# TODO T
+00013690: 6869 7320 6675 6e63 7469 6f6e 2063 6f6d  his function com
+000136a0: 6d65 6e74 6564 206f 7574 2062 6563 6175  mented out becau
+000136b0: 7365 2069 7420 6361 6c6c 7320 6d61 6b65  se it calls make
+000136c0: 5f74 7261 6365 642c 2077 6869 6368 2064  _traced, which d
+000136d0: 6f65 7320 6e6f 7420 6578 6973 740a 2320  oes not exist.# 
+000136e0: 6465 6620 6a76 705f 6561 6765 7228 6675  def jvp_eager(fu
+000136f0: 6e63 2c20 7072 696d 616c 732c 2074 616e  nc, primals, tan
+00013700: 6765 6e74 732c 2065 7865 6375 746f 723d  gents, executor=
+00013710: 2274 6f72 6368 2229 3a0a 2320 2020 2020  "torch"):.#     
+00013720: 2222 2243 6f6d 7075 7465 7320 7468 6520  """Computes the 
+00013730: 4a61 636f 6269 616e 2d76 6563 746f 7220  Jacobian-vector 
+00013740: 7072 6f64 7563 7420 6f66 2061 2054 6875  product of a Thu
+00013750: 6e64 6572 2066 756e 6374 696f 6e2e 0a0a  nder function...
+00013760: 2320 2020 2020 4172 6773 3a0a 2320 2020  #     Args:.#   
+00013770: 2020 2020 2020 6675 6e63 2028 4361 6c6c        func (Call
+00013780: 6162 6c65 293a 2041 2054 6875 6e64 6572  able): A Thunder
+00013790: 2066 756e 6374 696f 6e20 746f 2062 6520   function to be 
+000137a0: 7472 616e 7366 6f72 6d65 642e 0a23 2020  transformed..#  
+000137b0: 2020 2020 2020 2070 7269 6d61 6c73 2028         primals (
+000137c0: 5f74 7970 655f 293a 2050 7269 6d61 6c73  _type_): Primals
+000137d0: 206f 6620 7468 6520 6675 6e63 7469 6f6e   of the function
+000137e0: 2e0a 2320 2020 2020 2020 2020 7461 6e67  ..#         tang
+000137f0: 656e 7473 2028 5f74 7970 655f 293a 2054  ents (_type_): T
+00013800: 616e 6765 6e74 7320 6f66 2074 6865 2066  angents of the f
+00013810: 756e 6374 696f 6e2e 0a23 2020 2020 2020  unction..#      
+00013820: 2020 2065 7865 6375 746f 7220 2873 7472     executor (str
+00013830: 2c20 6f70 7469 6f6e 616c 293a 2045 7865  , optional): Exe
+00013840: 6375 746f 7220 746f 2075 7365 2e20 4465  cutor to use. De
+00013850: 6661 756c 7473 2074 6f20 2274 6f72 6368  faults to "torch
+00013860: 222e 0a0a 2320 2020 2020 5265 7475 726e  "...#     Return
+00013870: 733a 0a23 2020 2020 2020 2020 2054 6865  s:.#         The
+00013880: 2072 6573 756c 7420 6f66 2074 6865 204a   result of the J
+00013890: 6163 6f62 6961 6e2d 7665 6374 6f72 2070  acobian-vector p
+000138a0: 726f 6475 6374 2e0a 2320 2020 2020 2222  roduct..#     ""
+000138b0: 220a 2320 2020 2020 7472 6163 6520 3d20  ".#     trace = 
+000138c0: 6d61 6b65 5f74 7261 6365 2866 756e 632c  make_trace(func,
+000138d0: 2065 7865 6375 746f 723d 6578 6563 7574   executor=execut
+000138e0: 6f72 2c20 2a70 7269 6d61 6c73 290a 0a23  or, *primals)..#
+000138f0: 2020 2020 2064 6566 206a 7670 5f66 756e       def jvp_fun
+00013900: 6328 2a70 7269 6d61 6c73 5f61 6e64 5f74  c(*primals_and_t
+00013910: 616e 6765 6e74 7329 3a0a 2320 2020 2020  angents):.#     
+00013920: 2020 2020 5f70 7269 6d61 6c73 2c20 5f74      _primals, _t
+00013930: 616e 6765 6e74 7320 3d20 7072 696d 616c  angents = primal
+00013940: 735f 616e 645f 7461 6e67 656e 7473 5b3a  s_and_tangents[:
+00013950: 206c 656e 2870 7269 6d61 6c73 295d 2c20   len(primals)], 
+00013960: 7072 696d 616c 735f 616e 645f 7461 6e67  primals_and_tang
+00013970: 656e 7473 5b6c 656e 2870 7269 6d61 6c73  ents[len(primals
+00013980: 2920 3a5d 0a23 2020 2020 2020 2020 2072  ) :].#         r
+00013990: 6574 7572 6e20 5f6a 7670 5f63 616c 6c5f  eturn _jvp_call_
+000139a0: 6d65 7461 6675 6e63 285f 7072 696d 616c  metafunc(_primal
+000139b0: 732c 205f 7461 6e67 656e 7473 2c20 7472  s, _tangents, tr
+000139c0: 6163 652c 2064 6574 6163 6865 643d 4661  ace, detached=Fa
+000139d0: 6c73 6529 0a0a 2320 2020 2020 6a76 705f  lse)..#     jvp_
+000139e0: 7472 6163 6520 3d20 6d61 6b65 5f74 7261  trace = make_tra
+000139f0: 6365 286a 7670 5f66 756e 632c 2065 7865  ce(jvp_func, exe
+00013a00: 6375 746f 723d 6578 6563 7574 6f72 2928  cutor=executor)(
+00013a10: 2a70 7269 6d61 6c73 2c20 2a74 616e 6765  *primals, *tange
+00013a20: 6e74 7329 0a23 2020 2020 206a 7670 5f74  nts).#     jvp_t
+00013a30: 7261 6365 6420 3d20 6d61 6b65 5f74 7261  raced = make_tra
+00013a40: 6365 6428 7061 7274 6961 6c28 6576 616c  ced(partial(eval
+00013a50: 5f74 7261 6365 2c20 6a76 705f 7472 6163  _trace, jvp_trac
+00013a60: 6529 2c20 6578 6563 7574 6f72 3d65 7865  e), executor=exe
+00013a70: 6375 746f 7229 0a23 2020 2020 2072 6574  cutor).#     ret
+00013a80: 7572 6e20 6a76 705f 7472 6163 6564 282a  urn jvp_traced(*
+00013a90: 7072 696d 616c 732c 202a 7461 6e67 656e  primals, *tangen
+00013aa0: 7473 290a 0a0a 2320 564a 5020 7472 616e  ts)...# VJP tran
+00013ab0: 7366 6f72 6d0a 2320 3d3d 3d3d 3d3d 3d3d  sform.# ========
+00013ac0: 3d3d 3d3d 3d0a 4064 6174 6163 6c61 7373  =====.@dataclass
+00013ad0: 2866 726f 7a65 6e3d 5472 7565 290a 636c  (frozen=True).cl
+00013ae0: 6173 7320 564a 5044 7561 6c3a 0a20 2020  ass VJPDual:.   
+00013af0: 2022 2222 4120 7061 6972 206f 6620 7072   """A pair of pr
+00013b00: 696d 616c 2061 6e64 2073 6176 6564 2069  imal and saved i
+00013b10: 6e66 6f72 6d61 7469 6f6e 2066 6f72 2062  nformation for b
+00013b20: 6163 6b77 6172 6420 2872 6573 6964 7561  ackward (residua
+00013b30: 6c73 292e 0a0a 2020 2020 4172 6773 3a0a  ls)...    Args:.
+00013b40: 2020 2020 2020 2020 7072 696d 616c 2028          primal (
+00013b50: 556e 696f 6e5b 5072 6f78 792c 204e 756d  Union[Proxy, Num
+00013b60: 6265 725d 293a 2050 7269 6d61 6c20 7661  ber]): Primal va
+00013b70: 6c75 652c 2069 2e65 2e2c 2074 6865 2076  lue, i.e., the v
+00013b80: 616c 7565 2062 6569 6e67 2064 6966 6665  alue being diffe
+00013b90: 7265 6e74 6961 7465 642e 0a20 2020 2020  rentiated..     
+00013ba0: 2020 2072 6573 6964 7561 6c73 2028 5475     residuals (Tu
+00013bb0: 706c 655b 5072 6f78 792c 202e 2e2e 5d29  ple[Proxy, ...])
+00013bc0: 3a20 5265 7369 6475 616c 732c 2069 2e65  : Residuals, i.e
+00013bd0: 2e2c 2074 6865 2076 616c 7565 7320 7468  ., the values th
+00013be0: 6174 2061 7265 0a20 2020 2020 2020 2020  at are.         
+00013bf0: 2020 2073 6176 6564 2066 6f72 2074 6865     saved for the
+00013c00: 2062 6163 6b77 6172 642e 0a0a 2020 2020   backward...    
+00013c10: 5969 656c 6473 3a0a 2020 2020 2020 2020  Yields:.        
+00013c20: 5475 706c 655b 5661 7269 6162 6c65 2c20  Tuple[Variable, 
+00013c30: 5475 706c 655b 5661 7269 6162 6c65 2c20  Tuple[Variable, 
+00013c40: 2e2e 2e5d 2c20 4361 6c6c 6162 6c65 5d3a  ...], Callable]:
+00013c50: 2050 7269 6d61 6c20 616e 6420 7265 7369   Primal and resi
+00013c60: 6475 616c 730a 2020 2020 2222 220a 0a20  duals.    """.. 
+00013c70: 2020 2070 7269 6d61 6c3a 2050 726f 7879     primal: Proxy
+00013c80: 207c 204e 756d 6265 720a 2020 2020 7265   | Number.    re
+00013c90: 7369 6475 616c 733a 2074 7570 6c65 5b50  siduals: tuple[P
+00013ca0: 726f 7879 2c20 2e2e 2e5d 0a0a 2020 2020  roxy, ...]..    
+00013cb0: 6465 6620 5f5f 6974 6572 5f5f 2873 656c  def __iter__(sel
+00013cc0: 6629 3a0a 2020 2020 2020 2020 7969 656c  f):.        yiel
+00013cd0: 6420 7365 6c66 2e70 7269 6d61 6c0a 2020  d self.primal.  
+00013ce0: 2020 2020 2020 7969 656c 6420 7365 6c66        yield self
+00013cf0: 2e72 6573 6964 7561 6c73 0a0a 0a63 6c61  .residuals...cla
+00013d00: 7373 204e 6f50 756c 6c62 6163 6b3a 0a20  ss NoPullback:. 
+00013d10: 2020 2022 2222 4120 6475 6d6d 7920 7075     """A dummy pu
+00013d20: 6c6c 6261 636b 2066 756e 6374 696f 6e20  llback function 
+00013d30: 7468 6174 2072 6574 7572 6e73 204e 6f6e  that returns Non
+00013d40: 6520 6f72 2072 6169 7365 7320 616e 2065  e or raises an e
+00013d50: 7272 6f72 2e22 2222 0a0a 2020 2020 6465  rror."""..    de
+00013d60: 6620 5f5f 696e 6974 5f5f 2873 656c 662c  f __init__(self,
+00013d70: 206e 756d 5f61 7267 733d 3029 3a0a 2020   num_args=0):.  
+00013d80: 2020 2020 2020 7365 6c66 2e6e 756d 5f61        self.num_a
+00013d90: 7267 7320 3d20 6e75 6d5f 6172 6773 0a0a  rgs = num_args..
+00013da0: 2020 2020 6465 6620 5f5f 6361 6c6c 5f5f      def __call__
+00013db0: 2873 656c 662c 202a 6172 6773 2c20 2a2a  (self, *args, **
+00013dc0: 6b77 6172 6773 293a 0a20 2020 2020 2020  kwargs):.       
+00013dd0: 2069 6620 7365 6c66 2e6e 756d 5f61 7267   if self.num_arg
+00013de0: 7320 3e20 303a 0a20 2020 2020 2020 2020  s > 0:.         
+00013df0: 2020 2072 6574 7572 6e20 284e 6f6e 652c     return (None,
+00013e00: 2920 2a20 7365 6c66 2e6e 756d 5f61 7267  ) * self.num_arg
+00013e10: 730a 2020 2020 2020 2020 7261 6973 6520  s.        raise 
+00013e20: 5275 6e74 696d 6545 7272 6f72 2822 5075  RuntimeError("Pu
+00013e30: 6c6c 6261 636b 2063 616c 6c65 6420 6f6e  llback called on
+00013e40: 2061 206e 6f6e 2d64 6966 6665 7265 6e74   a non-different
+00013e50: 6961 626c 6520 7379 6d62 6f6c 206f 7220  iable symbol or 
+00013e60: 6120 636f 6e73 7461 6e74 2e22 290a 0a0a  a constant.")...
+00013e70: 636c 6173 7320 5a65 726f 4261 636b 7761  class ZeroBackwa
+00013e80: 7264 3a0a 2020 2020 2222 2241 2068 656c  rd:.    """A hel
+00013e90: 7065 7220 6261 636b 7761 7264 2066 756e  per backward fun
+00013ea0: 6374 696f 6e20 7468 6174 2072 6574 7572  ction that retur
+00013eb0: 6e73 207a 6572 6f73 2e22 2222 0a0a 2020  ns zeros."""..  
+00013ec0: 2020 6465 6620 5f5f 696e 6974 5f5f 2873    def __init__(s
+00013ed0: 656c 662c 206e 756d 5f61 7267 7329 3a0a  elf, num_args):.
+00013ee0: 2020 2020 2020 2020 7365 6c66 2e6e 756d          self.num
+00013ef0: 5f61 7267 7320 3d20 6e75 6d5f 6172 6773  _args = num_args
+00013f00: 0a0a 2020 2020 6465 6620 5f5f 6361 6c6c  ..    def __call
+00013f10: 5f5f 2873 656c 662c 202a 6172 6773 2c20  __(self, *args, 
+00013f20: 2a2a 6b77 6172 6773 293a 0a20 2020 2020  **kwargs):.     
+00013f30: 2020 2023 2041 7373 756d 696e 6720 7468     # Assuming th
+00013f40: 6174 2074 6865 2066 6972 7374 2061 7267  at the first arg
+00013f50: 756d 656e 7473 2061 7265 2074 6865 2066  uments are the f
+00013f60: 6f72 7761 7264 2061 7267 756d 656e 7473  orward arguments
+00013f70: 0a20 2020 2020 2020 2066 6f72 7761 7264  .        forward
+00013f80: 5f61 7267 7320 3d20 6172 6773 5b3a 2073  _args = args[: s
+00013f90: 656c 662e 6e75 6d5f 6172 6773 5d0a 0a20  elf.num_args].. 
+00013fa0: 2020 2020 2020 2064 6566 207a 6572 6f73         def zeros
+00013fb0: 5f6c 696b 6528 7829 3a0a 2020 2020 2020  _like(x):.      
+00013fc0: 2020 2020 2020 6966 2069 7369 6e73 7461        if isinsta
+00013fd0: 6e63 6528 782c 2054 656e 736f 7250 726f  nce(x, TensorPro
+00013fe0: 7879 293a 0a20 2020 2020 2020 2020 2020  xy):.           
+00013ff0: 2020 2020 2072 6574 7572 6e20 6675 6c6c       return full
+00014000: 5f6c 696b 6528 782c 2066 696c 6c5f 7661  _like(x, fill_va
+00014010: 6c75 653d 3029 0a20 2020 2020 2020 2020  lue=0).         
+00014020: 2020 2065 6c69 6620 6973 696e 7374 616e     elif isinstan
+00014030: 6365 2878 2c20 4e75 6d62 6572 5072 6f78  ce(x, NumberProx
+00014040: 7929 3a0a 2020 2020 2020 2020 2020 2020  y):.            
+00014050: 2020 2020 7265 7475 726e 2074 7970 6528      return type(
+00014060: 782e 7661 6c75 6529 2830 290a 2020 2020  x.value)(0).    
+00014070: 2020 2020 2020 2020 656c 6966 2069 7369          elif isi
+00014080: 6e73 7461 6e63 6528 782c 204e 756d 6265  nstance(x, Numbe
+00014090: 7229 3a0a 2020 2020 2020 2020 2020 2020  r):.            
+000140a0: 2020 2020 7265 7475 726e 2074 7970 6528      return type(
+000140b0: 7829 2830 290a 2020 2020 2020 2020 2020  x)(0).          
+000140c0: 2020 656c 7365 3a0a 2020 2020 2020 2020    else:.        
+000140d0: 2020 2020 2020 2020 7261 6973 6520 5661          raise Va
+000140e0: 6c75 6545 7272 6f72 2866 227a 6572 6f73  lueError(f"zeros
+000140f0: 5f6c 696b 6520 696e 7369 6465 205a 6572  _like inside Zer
+00014100: 6f42 6163 6b77 6172 6420 676f 7420 616e  oBackward got an
+00014110: 2075 6e73 7570 706f 7274 6564 2074 7970   unsupported typ
+00014120: 6520 7b74 7970 6528 7829 7d22 290a 0a20  e {type(x)}").. 
+00014130: 2020 2020 2020 2072 6574 7572 6e20 7475         return tu
+00014140: 706c 6528 7a65 726f 735f 6c69 6b65 2861  ple(zeros_like(a
+00014150: 7267 2920 666f 7220 6172 6720 696e 2066  rg) for arg in f
+00014160: 6f72 7761 7264 5f61 7267 7329 0a0a 0a23  orward_args)...#
+00014170: 204d 6170 7069 6e67 2066 726f 6d20 7379   Mapping from sy
+00014180: 6d62 6f6c 7320 746f 2061 7567 6d65 6e74  mbols to augment
+00014190: 6564 2070 7269 6d61 6c20 2866 6f72 7761  ed primal (forwa
+000141a0: 7264 2920 6675 6e63 7469 6f6e 7320 7573  rd) functions us
+000141b0: 6564 2069 6e20 564a 500a 2320 5468 6520  ed in VJP.# The 
+000141c0: 6175 676d 656e 7465 645f 7072 696d 616c  augmented_primal
+000141d0: 2066 756e 6374 696f 6e20 7461 6b65 7320   function takes 
+000141e0: 7468 6520 7072 696d 616c 2076 616c 7565  the primal value
+000141f0: 7320 616e 6420 7265 7475 726e 7320 7468  s and returns th
+00014200: 6520 7072 696d 616c 0a23 2072 6573 756c  e primal.# resul
+00014210: 7420 616e 6420 7468 6520 7265 7369 6475  t and the residu
+00014220: 616c 7320 2873 6176 6564 2076 616c 7565  als (saved value
+00014230: 7320 666f 7220 7468 6520 6261 636b 7761  s for the backwa
+00014240: 7264 292e 0a61 7567 6d65 6e74 6564 5f66  rd)..augmented_f
+00014250: 6f72 7761 7264 5f69 6d70 6c73 203d 207b  orward_impls = {
+00014260: 0a20 2020 2070 7269 6d73 2e50 7269 6d49  .    prims.PrimI
+00014270: 4473 2e41 434f 533a 206c 616d 6264 6120  Ds.ACOS: lambda 
+00014280: 783a 2028 7072 696d 732e 6163 6f73 2878  x: (prims.acos(x
+00014290: 292c 2028 782c 2929 2c0a 2020 2020 7072  ), (x,)),.    pr
+000142a0: 696d 732e 5072 696d 4944 732e 4143 4f53  ims.PrimIDs.ACOS
+000142b0: 483a 206c 616d 6264 6120 783a 2028 7072  H: lambda x: (pr
+000142c0: 696d 732e 6163 6f73 6828 7829 2c20 2878  ims.acosh(x), (x
+000142d0: 2c29 292c 0a20 2020 2070 7269 6d73 2e50  ,)),.    prims.P
+000142e0: 7269 6d49 4473 2e41 5349 4e3a 206c 616d  rimIDs.ASIN: lam
+000142f0: 6264 6120 783a 2028 7072 696d 732e 6173  bda x: (prims.as
+00014300: 696e 2878 292c 2028 782c 2929 2c0a 2020  in(x), (x,)),.  
+00014310: 2020 7072 696d 732e 5072 696d 4944 732e    prims.PrimIDs.
+00014320: 4153 494e 483a 206c 616d 6264 6120 783a  ASINH: lambda x:
+00014330: 2028 7072 696d 732e 6173 696e 6828 7829   (prims.asinh(x)
+00014340: 2c20 2878 2c29 292c 0a20 2020 2070 7269  , (x,)),.    pri
+00014350: 6d73 2e50 7269 6d49 4473 2e41 5441 4e3a  ms.PrimIDs.ATAN:
+00014360: 206c 616d 6264 6120 783a 2028 7072 696d   lambda x: (prim
+00014370: 732e 6174 616e 2878 292c 2028 782c 2929  s.atan(x), (x,))
+00014380: 2c0a 2020 2020 7072 696d 732e 5072 696d  ,.    prims.Prim
+00014390: 4944 732e 4154 414e 483a 206c 616d 6264  IDs.ATANH: lambd
+000143a0: 6120 783a 2028 7072 696d 732e 6174 616e  a x: (prims.atan
+000143b0: 6828 7829 2c20 2878 2c29 292c 0a20 2020  h(x), (x,)),.   
+000143c0: 2070 7269 6d73 2e50 7269 6d49 4473 2e41   prims.PrimIDs.A
+000143d0: 5441 4e32 3a20 6c61 6d62 6461 2078 2c20  TAN2: lambda x, 
+000143e0: 793a 2028 7072 696d 732e 6174 616e 3228  y: (prims.atan2(
+000143f0: 782c 2079 292c 2028 782c 2079 2929 2c0a  x, y), (x, y)),.
+00014400: 2020 2020 7072 696d 732e 5072 696d 4944      prims.PrimID
+00014410: 732e 434f 5348 3a20 6c61 6d62 6461 2078  s.COSH: lambda x
+00014420: 3a20 2870 7269 6d73 2e63 6f73 6828 7829  : (prims.cosh(x)
+00014430: 2c20 2878 2c29 292c 0a20 2020 2070 7269  , (x,)),.    pri
+00014440: 6d73 2e50 7269 6d49 4473 2e44 4947 414d  ms.PrimIDs.DIGAM
+00014450: 4d41 3a20 6c61 6d62 6461 2078 3a20 2870  MA: lambda x: (p
+00014460: 7269 6d73 2e64 6967 616d 6d61 2878 292c  rims.digamma(x),
+00014470: 2028 782c 2929 2c0a 2020 2020 7072 696d   (x,)),.    prim
+00014480: 732e 5072 696d 4944 732e 4552 4643 3a20  s.PrimIDs.ERFC: 
+00014490: 6c61 6d62 6461 2078 3a20 2870 7269 6d73  lambda x: (prims
+000144a0: 2e65 7266 6328 7829 2c20 2878 2c29 292c  .erfc(x), (x,)),
+000144b0: 0a20 2020 2070 7269 6d73 2e50 7269 6d49  .    prims.PrimI
+000144c0: 4473 2e45 5246 494e 563a 206c 616d 6264  Ds.ERFINV: lambd
+000144d0: 6120 783a 2028 7072 696d 732e 6572 6669  a x: (prims.erfi
+000144e0: 6e76 2878 292c 2028 7072 696d 732e 6572  nv(x), (prims.er
+000144f0: 6669 6e76 2878 292c 2929 2c0a 2020 2020  finv(x),)),.    
+00014500: 7072 696d 732e 5072 696d 4944 732e 4552  prims.PrimIDs.ER
+00014510: 4643 494e 563a 206c 616d 6264 6120 783a  FCINV: lambda x:
+00014520: 2028 7072 696d 732e 6572 6663 696e 7628   (prims.erfcinv(
+00014530: 7829 2c20 2870 7269 6d73 2e65 7266 6369  x), (prims.erfci
+00014540: 6e76 2878 292c 2929 2c0a 2020 2020 7072  nv(x),)),.    pr
+00014550: 696d 732e 5072 696d 4944 732e 4558 5032  ims.PrimIDs.EXP2
+00014560: 3a20 6c61 6d62 6461 2078 3a20 2870 7269  : lambda x: (pri
+00014570: 6d73 2e65 7870 3228 7829 2c20 2870 7269  ms.exp2(x), (pri
+00014580: 6d73 2e65 7870 3228 7829 2c29 292c 0a20  ms.exp2(x),)),. 
+00014590: 2020 2070 7269 6d73 2e50 7269 6d49 4473     prims.PrimIDs
+000145a0: 2e45 5850 4d31 3a20 6c61 6d62 6461 2078  .EXPM1: lambda x
+000145b0: 3a20 2870 7269 6d73 2e65 7870 6d31 2878  : (prims.expm1(x
+000145c0: 292c 2028 7072 696d 732e 6578 706d 3128  ), (prims.expm1(
+000145d0: 7829 2c29 292c 0a20 2020 2070 7269 6d73  x),)),.    prims
+000145e0: 2e50 7269 6d49 4473 2e4c 4741 4d4d 413a  .PrimIDs.LGAMMA:
+000145f0: 206c 616d 6264 6120 783a 2028 7072 696d   lambda x: (prim
+00014600: 732e 6c67 616d 6d61 2878 292c 2028 782c  s.lgamma(x), (x,
+00014610: 2929 2c0a 2020 2020 7072 696d 732e 5072  )),.    prims.Pr
+00014620: 696d 4944 732e 4e44 5452 493a 206c 616d  imIDs.NDTRI: lam
+00014630: 6264 6120 783a 2028 7072 696d 732e 6e64  bda x: (prims.nd
+00014640: 7472 6928 7829 2c20 2870 7269 6d73 2e6e  tri(x), (prims.n
+00014650: 6474 7269 2878 292c 2929 2c0a 2020 2020  dtri(x),)),.    
+00014660: 7072 696d 732e 5072 696d 4944 732e 5349  prims.PrimIDs.SI
+00014670: 4e48 3a20 6c61 6d62 6461 2078 3a20 2870  NH: lambda x: (p
+00014680: 7269 6d73 2e73 696e 6828 7829 2c20 2878  rims.sinh(x), (x
+00014690: 2c29 292c 0a20 2020 2070 7269 6d73 2e50  ,)),.    prims.P
+000146a0: 7269 6d49 4473 2e53 5152 543a 206c 616d  rimIDs.SQRT: lam
+000146b0: 6264 6120 783a 2028 7072 696d 732e 7371  bda x: (prims.sq
+000146c0: 7274 2878 292c 2028 7072 696d 732e 7371  rt(x), (prims.sq
+000146d0: 7274 2878 292c 2929 2c0a 2020 2020 7072  rt(x),)),.    pr
+000146e0: 696d 732e 5072 696d 4944 732e 4c4f 4731  ims.PrimIDs.LOG1
+000146f0: 303a 206c 616d 6264 6120 783a 2028 7072  0: lambda x: (pr
+00014700: 696d 732e 6c6f 6731 3028 7829 2c20 2878  ims.log10(x), (x
+00014710: 2c29 292c 0a20 2020 2070 7269 6d73 2e50  ,)),.    prims.P
+00014720: 7269 6d49 4473 2e4c 4f47 3150 3a20 6c61  rimIDs.LOG1P: la
+00014730: 6d62 6461 2078 3a20 2870 7269 6d73 2e6c  mbda x: (prims.l
+00014740: 6f67 3170 2878 292c 2028 782c 2929 2c0a  og1p(x), (x,)),.
+00014750: 2020 2020 7072 696d 732e 5072 696d 4944      prims.PrimID
+00014760: 732e 4c4f 4732 3a20 6c61 6d62 6461 2078  s.LOG2: lambda x
+00014770: 3a20 2870 7269 6d73 2e6c 6f67 3228 7829  : (prims.log2(x)
+00014780: 2c20 2878 2c29 292c 0a20 2020 2070 7269  , (x,)),.    pri
+00014790: 6d73 2e50 7269 6d49 4473 2e5a 4554 413a  ms.PrimIDs.ZETA:
+000147a0: 206c 616d 6264 6120 782c 2079 3a20 2870   lambda x, y: (p
+000147b0: 7269 6d73 2e7a 6574 6128 782c 2079 292c  rims.zeta(x, y),
+000147c0: 2028 782c 2079 2929 2c0a 2020 2020 7072   (x, y)),.    pr
+000147d0: 696d 732e 5072 696d 4944 732e 464d 4f44  ims.PrimIDs.FMOD
+000147e0: 3a20 6c61 6d62 6461 2078 2c20 793a 2028  : lambda x, y: (
+000147f0: 7072 696d 732e 666d 6f64 2878 2c20 7929  prims.fmod(x, y)
+00014800: 2c20 2878 2c20 7929 292c 0a20 2020 2070  , (x, y)),.    p
+00014810: 7269 6d73 2e50 7269 6d49 4473 2e43 4f50  rims.PrimIDs.COP
+00014820: 595f 3a20 6c61 6d62 6461 2078 2c20 793a  Y_: lambda x, y:
+00014830: 2028 7072 696d 732e 636f 7079 5f28 782c   (prims.copy_(x,
+00014840: 2079 292c 2074 7570 6c65 2829 292c 0a7d   y), tuple()),.}
+00014850: 0a0a 0a23 204d 6170 7069 6e67 2066 726f  ...# Mapping fro
+00014860: 6d20 7379 6d62 6f6c 7320 746f 2062 6163  m symbols to bac
+00014870: 6b77 6172 6420 6675 6e63 7469 6f6e 7320  kward functions 
+00014880: 7573 6564 2069 6e20 564a 500a 2320 5468  used in VJP.# Th
+00014890: 6520 6261 636b 7761 7264 2066 756e 6374  e backward funct
+000148a0: 696f 6e20 7461 6b65 7320 7468 6520 7265  ion takes the re
+000148b0: 7369 6475 616c 7320 616e 6420 636f 7461  siduals and cota
+000148c0: 6e67 656e 7473 2061 6e64 2072 6574 7572  ngents and retur
+000148d0: 6e73 2074 6865 0a23 2076 6563 746f 722d  ns the.# vector-
+000148e0: 4a61 636f 6269 616e 2070 726f 6475 6374  Jacobian product
+000148f0: 7320 666f 7220 6561 6368 2061 7267 756d  s for each argum
+00014900: 656e 742e 0a62 6163 6b77 6172 645f 696d  ent..backward_im
+00014910: 706c 7320 3d20 7b0a 2020 2020 7072 696d  pls = {.    prim
+00014920: 732e 5072 696d 4944 732e 4143 4f53 3a20  s.PrimIDs.ACOS: 
+00014930: 6c61 6d62 6461 2078 2c20 673a 202d 6720  lambda x, g: -g 
+00014940: 2f20 7072 696d 732e 7371 7274 2831 2e30  / prims.sqrt(1.0
+00014950: 202d 2078 202a 2078 292c 0a20 2020 2070   - x * x),.    p
+00014960: 7269 6d73 2e50 7269 6d49 4473 2e41 434f  rims.PrimIDs.ACO
+00014970: 5348 3a20 6c61 6d62 6461 2078 2c20 673a  SH: lambda x, g:
+00014980: 2067 202a 2070 7269 6d73 2e72 7371 7274   g * prims.rsqrt
+00014990: 2878 202a 2078 202d 2031 2e30 292c 0a20  (x * x - 1.0),. 
+000149a0: 2020 2070 7269 6d73 2e50 7269 6d49 4473     prims.PrimIDs
+000149b0: 2e41 5349 4e3a 206c 616d 6264 6120 782c  .ASIN: lambda x,
+000149c0: 2067 3a20 6720 2f20 7072 696d 732e 7371   g: g / prims.sq
+000149d0: 7274 2831 2e30 202d 2078 202a 2078 292c  rt(1.0 - x * x),
+000149e0: 0a20 2020 2070 7269 6d73 2e50 7269 6d49  .    prims.PrimI
+000149f0: 4473 2e41 5349 4e48 3a20 6c61 6d62 6461  Ds.ASINH: lambda
+00014a00: 2078 2c20 673a 2067 202a 2070 7269 6d73   x, g: g * prims
+00014a10: 2e72 7371 7274 2831 2e30 202b 2078 202a  .rsqrt(1.0 + x *
+00014a20: 2078 292c 0a20 2020 2070 7269 6d73 2e50   x),.    prims.P
+00014a30: 7269 6d49 4473 2e41 5441 4e3a 206c 616d  rimIDs.ATAN: lam
+00014a40: 6264 6120 782c 2067 3a20 6720 2f20 2831  bda x, g: g / (1
+00014a50: 2e30 202b 2078 202a 2078 292c 0a20 2020  .0 + x * x),.   
+00014a60: 2070 7269 6d73 2e50 7269 6d49 4473 2e41   prims.PrimIDs.A
+00014a70: 5441 4e48 3a20 6c61 6d62 6461 2078 2c20  TANH: lambda x, 
+00014a80: 673a 2067 202f 2028 312e 3020 2d20 7820  g: g / (1.0 - x 
+00014a90: 2a20 7829 2c0a 2020 2020 7072 696d 732e  * x),.    prims.
+00014aa0: 5072 696d 4944 732e 434f 5348 3a20 6c61  PrimIDs.COSH: la
+00014ab0: 6d62 6461 2078 2c20 673a 2070 7269 6d73  mbda x, g: prims
+00014ac0: 2e6d 756c 2867 2c20 7072 696d 732e 7369  .mul(g, prims.si
+00014ad0: 6e68 2878 2929 2c0a 2020 2020 7072 696d  nh(x)),.    prim
+00014ae0: 732e 5072 696d 4944 732e 4552 4643 3a20  s.PrimIDs.ERFC: 
+00014af0: 6c61 6d62 6461 2078 2c20 673a 202d 6720  lambda x, g: -g 
+00014b00: 2a20 322e 3020 2f20 6d61 7468 2e73 7172  * 2.0 / math.sqr
+00014b10: 7428 6d61 7468 2e70 6929 202a 2070 7269  t(math.pi) * pri
+00014b20: 6d73 2e65 7870 282d 7820 2a20 7829 2c0a  ms.exp(-x * x),.
+00014b30: 2020 2020 7072 696d 732e 5072 696d 4944      prims.PrimID
+00014b40: 732e 4552 4649 4e56 3a20 6c61 6d62 6461  s.ERFINV: lambda
+00014b50: 2072 6573 756c 742c 2067 3a20 6720 2a20   result, g: g * 
+00014b60: 302e 3520 2a20 6d61 7468 2e73 7172 7428  0.5 * math.sqrt(
+00014b70: 6d61 7468 2e70 6929 202a 2070 7269 6d73  math.pi) * prims
+00014b80: 2e65 7870 2872 6573 756c 742a 2a32 292c  .exp(result**2),
+00014b90: 0a20 2020 2070 7269 6d73 2e50 7269 6d49  .    prims.PrimI
+00014ba0: 4473 2e45 5246 4349 4e56 3a20 6c61 6d62  Ds.ERFCINV: lamb
+00014bb0: 6461 2072 6573 756c 742c 2067 3a20 2d67  da result, g: -g
+00014bc0: 202a 2030 2e35 202a 206d 6174 682e 7371   * 0.5 * math.sq
+00014bd0: 7274 286d 6174 682e 7069 2920 2a20 7072  rt(math.pi) * pr
+00014be0: 696d 732e 6578 7028 7265 7375 6c74 2a2a  ims.exp(result**
+00014bf0: 3229 2c0a 2020 2020 7072 696d 732e 5072  2),.    prims.Pr
+00014c00: 696d 4944 732e 4558 5032 3a20 6c61 6d62  imIDs.EXP2: lamb
+00014c10: 6461 2072 6573 756c 742c 2067 3a20 6720  da result, g: g 
+00014c20: 2a20 7265 7375 6c74 202a 206d 6174 682e  * result * math.
+00014c30: 6c6f 6728 322e 3029 2c0a 2020 2020 7072  log(2.0),.    pr
+00014c40: 696d 732e 5072 696d 4944 732e 4558 504d  ims.PrimIDs.EXPM
+00014c50: 313a 206c 616d 6264 6120 7265 7375 6c74  1: lambda result
+00014c60: 2c20 673a 2067 202a 2028 7265 7375 6c74  , g: g * (result
+00014c70: 202b 2031 2e30 292c 0a20 2020 2070 7269   + 1.0),.    pri
+00014c80: 6d73 2e50 7269 6d49 4473 2e4c 4741 4d4d  ms.PrimIDs.LGAMM
+00014c90: 413a 206c 616d 6264 6120 782c 2067 3a20  A: lambda x, g: 
+00014ca0: 6720 2a20 7072 696d 732e 6469 6761 6d6d  g * prims.digamm
+00014cb0: 6128 7829 2c0a 2020 2020 7072 696d 732e  a(x),.    prims.
+00014cc0: 5072 696d 4944 732e 4e44 5452 493a 206c  PrimIDs.NDTRI: l
+00014cd0: 616d 6264 6120 7265 7375 6c74 2c20 673a  ambda result, g:
+00014ce0: 2067 202a 2070 7269 6d73 2e65 7870 2830   g * prims.exp(0
+00014cf0: 2e35 202a 2072 6573 756c 742a 2a32 2920  .5 * result**2) 
+00014d00: 2a20 6d61 7468 2e73 7172 7428 322e 3020  * math.sqrt(2.0 
+00014d10: 2a20 6d61 7468 2e70 6929 2c0a 2020 2020  * math.pi),.    
+00014d20: 7072 696d 732e 5072 696d 4944 732e 5349  prims.PrimIDs.SI
+00014d30: 4e48 3a20 6c61 6d62 6461 2078 2c20 673a  NH: lambda x, g:
+00014d40: 2070 7269 6d73 2e6d 756c 2867 2c20 7072   prims.mul(g, pr
+00014d50: 696d 732e 636f 7368 2878 2929 2c0a 2020  ims.cosh(x)),.  
+00014d60: 2020 7072 696d 732e 5072 696d 4944 732e    prims.PrimIDs.
+00014d70: 5351 5254 3a20 6c61 6d62 6461 2072 6573  SQRT: lambda res
+00014d80: 756c 742c 2067 3a20 6720 2f20 2832 2e30  ult, g: g / (2.0
+00014d90: 202a 2072 6573 756c 7429 2c0a 2020 2020   * result),.    
+00014da0: 7072 696d 732e 5072 696d 4944 732e 4c4f  prims.PrimIDs.LO
+00014db0: 4731 303a 206c 616d 6264 6120 782c 2067  G10: lambda x, g
+00014dc0: 3a20 6720 2f20 2878 202a 2032 2e33 3032  : g / (x * 2.302
+00014dd0: 3538 3530 3932 3939 3430 3436 292c 0a20  585092994046),. 
+00014de0: 2020 2070 7269 6d73 2e50 7269 6d49 4473     prims.PrimIDs
+00014df0: 2e4c 4f47 3150 3a20 6c61 6d62 6461 2078  .LOG1P: lambda x
+00014e00: 2c20 673a 2067 202f 2028 7820 2b20 3129  , g: g / (x + 1)
+00014e10: 2c0a 2020 2020 7072 696d 732e 5072 696d  ,.    prims.Prim
+00014e20: 4944 732e 4c4f 4732 3a20 6c61 6d62 6461  IDs.LOG2: lambda
+00014e30: 2078 2c20 673a 2067 202f 2028 7820 2a20   x, g: g / (x * 
+00014e40: 302e 3639 3331 3437 3138 3035 3539 3934  0.69314718055994
+00014e50: 3533 292c 0a20 2020 2070 7269 6d73 2e50  53),.    prims.P
+00014e60: 7269 6d49 4473 2e46 4d4f 443a 206c 616d  rimIDs.FMOD: lam
+00014e70: 6264 6120 782c 2079 2c20 673a 2028 672c  bda x, y, g: (g,
+00014e80: 202d 6720 2a20 7072 696d 732e 7472 756e   -g * prims.trun
+00014e90: 6328 7820 2f20 7929 292c 0a20 2020 2023  c(x / y)),.    #
+00014ea0: 2054 6865 2063 6f70 7920 7368 6f75 6c64   The copy should
+00014eb0: 206e 6f74 2062 6520 6469 6666 6572 656e   not be differen
+00014ec0: 7469 6162 6c65 2e20 5765 2072 6574 7572  tiable. We retur
+00014ed0: 6e20 4e6f 6e65 2074 6f20 656e 6162 6c65  n None to enable
+00014ee0: 2074 6865 2067 656e 6572 6174 696f 6e20   the generation 
+00014ef0: 6f66 2074 6865 2062 6163 6b77 6172 6420  of the backward 
+00014f00: 6772 6170 6820 7468 726f 7567 6820 7468  graph through th
+00014f10: 656d 2e0a 2020 2020 7072 696d 732e 5072  em..    prims.Pr
+00014f20: 696d 4944 732e 434f 5059 5f3a 206c 616d  imIDs.COPY_: lam
+00014f30: 6264 6120 673a 2028 4e6f 6e65 2c20 4e6f  bda g: (None, No
+00014f40: 6e65 292c 0a7d 0a0a 0a64 6566 2072 6567  ne),.}...def reg
+00014f50: 6973 7465 725f 6175 676d 656e 7465 645f  ister_augmented_
+00014f60: 666f 7277 6172 6428 6f70 293a 0a20 2020  forward(op):.   
+00014f70: 2022 2222 4465 636f 7261 746f 7220 746f   """Decorator to
+00014f80: 2072 6567 6973 7465 7220 616e 2061 7567   register an aug
+00014f90: 6d65 6e74 6564 2066 6f72 7761 7264 2069  mented forward i
+00014fa0: 6d70 6c65 6d65 6e74 6174 696f 6e20 666f  mplementation fo
+00014fb0: 7220 6120 7379 6d62 6f6c 2e0a 0a20 2020  r a symbol...   
+00014fc0: 2041 7267 733a 0a20 2020 2020 2020 206f   Args:.        o
+00014fd0: 7020 284f 7073 293a 2053 796d 626f 6c20  p (Ops): Symbol 
+00014fe0: 666f 7220 7768 6963 6820 746f 2072 6567  for which to reg
+00014ff0: 6973 7465 7220 7468 6520 6175 676d 656e  ister the augmen
+00015000: 7465 6420 666f 7277 6172 6420 696d 706c  ted forward impl
+00015010: 656d 656e 7461 7469 6f6e 2e0a 0a20 2020  ementation...   
+00015020: 2052 6574 7572 6e73 3a0a 2020 2020 2020   Returns:.      
+00015030: 2020 4361 6c6c 6162 6c65 3a20 4465 636f    Callable: Deco
+00015040: 7261 746f 7220 6675 6e63 7469 6f6e 2e0a  rator function..
+00015050: 2020 2020 2222 220a 0a20 2020 2064 6566      """..    def
+00015060: 2064 6563 6f72 6174 6f72 2866 756e 6329   decorator(func)
+00015070: 3a0a 2020 2020 2020 2020 6175 676d 656e  :.        augmen
+00015080: 7465 645f 666f 7277 6172 645f 696d 706c  ted_forward_impl
+00015090: 735b 6f70 5d20 3d20 6675 6e63 0a20 2020  s[op] = func.   
+000150a0: 2020 2020 2072 6574 7572 6e20 6675 6e63       return func
+000150b0: 0a0a 2020 2020 7265 7475 726e 2064 6563  ..    return dec
+000150c0: 6f72 6174 6f72 0a0a 0a64 6566 2072 6567  orator...def reg
+000150d0: 6973 7465 725f 6261 636b 7761 7264 286f  ister_backward(o
+000150e0: 7029 3a0a 2020 2020 2222 2244 6563 6f72  p):.    """Decor
+000150f0: 6174 6f72 2074 6f20 7265 6769 7374 6572  ator to register
+00015100: 2061 2062 6163 6b77 6172 6420 696d 706c   a backward impl
+00015110: 656d 656e 7461 7469 6f6e 2066 6f72 2061  ementation for a
+00015120: 2073 796d 626f 6c2e 0a0a 2020 2020 4172   symbol...    Ar
+00015130: 6773 3a0a 2020 2020 2020 2020 6f70 2028  gs:.        op (
+00015140: 4f70 7329 3a20 5379 6d62 6f6c 2066 6f72  Ops): Symbol for
+00015150: 2077 6869 6368 2074 6f20 7265 6769 7374   which to regist
+00015160: 6572 2074 6865 2062 6163 6b77 6172 6420  er the backward 
+00015170: 696d 706c 656d 656e 7461 7469 6f6e 2e0a  implementation..
+00015180: 0a20 2020 2052 6574 7572 6e73 3a0a 2020  .    Returns:.  
+00015190: 2020 2020 2020 4361 6c6c 6162 6c65 3a20        Callable: 
+000151a0: 4465 636f 7261 746f 7220 6675 6e63 7469  Decorator functi
+000151b0: 6f6e 2e0a 2020 2020 2222 220a 0a20 2020  on..    """..   
+000151c0: 2064 6566 2064 6563 6f72 6174 6f72 2866   def decorator(f
+000151d0: 756e 6329 3a0a 2020 2020 2020 2020 6261  unc):.        ba
+000151e0: 636b 7761 7264 5f69 6d70 6c73 5b6f 705d  ckward_impls[op]
+000151f0: 203d 2066 756e 630a 2020 2020 2020 2020   = func.        
+00015200: 7265 7475 726e 2066 756e 630a 0a20 2020  return func..   
+00015210: 2072 6574 7572 6e20 6465 636f 7261 746f   return decorato
+00015220: 720a 0a0a 6465 6620 7265 7374 6f72 655f  r...def restore_
+00015230: 7265 6475 6365 645f 6469 6d73 2878 2c20  reduced_dims(x, 
+00015240: 7265 6475 6365 645f 6469 6d73 2c20 6f72  reduced_dims, or
+00015250: 6967 696e 616c 5f73 6861 7065 293a 0a20  iginal_shape):. 
+00015260: 2020 2022 2222 5265 7374 6f72 6573 2074     """Restores t
+00015270: 6865 2072 6564 7563 6564 2064 696d 656e  he reduced dimen
+00015280: 7369 6f6e 7320 6f66 2061 2074 656e 736f  sions of a tenso
+00015290: 722e 0a0a 2020 2020 4172 6773 3a0a 2020  r...    Args:.  
+000152a0: 2020 2020 2020 7820 2856 6172 6961 626c        x (Variabl
+000152b0: 6529 3a20 5465 6e73 6f72 2074 6f20 6265  e): Tensor to be
+000152c0: 2072 6573 6861 7065 642e 0a20 2020 2020   reshaped..     
+000152d0: 2020 2072 6564 7563 6564 5f64 696d 7320     reduced_dims 
+000152e0: 2854 7570 6c65 5b69 6e74 2c20 2e2e 2e5d  (Tuple[int, ...]
+000152f0: 293a 2054 7570 6c65 206f 6620 7265 6475  ): Tuple of redu
+00015300: 6365 6420 6469 6d65 6e73 696f 6e73 2e0a  ced dimensions..
+00015310: 2020 2020 2020 2020 6f72 6967 696e 616c          original
+00015320: 5f73 6861 7065 2028 5475 706c 655b 696e  _shape (Tuple[in
+00015330: 742c 202e 2e2e 5d29 3a20 4f72 6967 696e  t, ...]): Origin
+00015340: 616c 2073 6861 7065 206f 6620 7468 6520  al shape of the 
+00015350: 7465 6e73 6f72 2e0a 0a20 2020 2052 6574  tensor...    Ret
+00015360: 7572 6e73 3a0a 2020 2020 2020 2020 5661  urns:.        Va
+00015370: 7269 6162 6c65 3a20 5465 6e73 6f72 2077  riable: Tensor w
+00015380: 6974 6820 7468 6520 7265 6475 6365 6420  ith the reduced 
+00015390: 6469 6d65 6e73 696f 6e73 2072 6573 746f  dimensions resto
+000153a0: 7265 642e 0a20 2020 2022 2222 0a20 2020  red..    """.   
+000153b0: 2069 6620 6f72 6967 696e 616c 5f73 6861   if original_sha
+000153c0: 7065 203d 3d20 2829 3a20 2023 2073 6361  pe == ():  # sca
+000153d0: 6c61 720a 2020 2020 2020 2020 7265 7475  lar.        retu
+000153e0: 726e 2078 0a0a 2020 2020 756e 7371 7565  rn x..    unsque
+000153f0: 657a 6564 203d 2063 6c61 6e67 2e75 6e73  ezed = clang.uns
+00015400: 7175 6565 7a65 2878 2c20 7265 6475 6365  queeze(x, reduce
+00015410: 645f 6469 6d73 290a 2020 2020 7265 7475  d_dims).    retu
+00015420: 726e 2063 6c61 6e67 2e65 7870 616e 6428  rn clang.expand(
+00015430: 756e 7371 7565 657a 6564 2c20 6f72 6967  unsqueezed, orig
+00015440: 696e 616c 5f73 6861 7065 290a 0a0a 4072  inal_shape)...@r
+00015450: 6567 6973 7465 725f 6261 636b 7761 7264  egister_backward
+00015460: 2870 7269 6d73 2e50 7269 6d49 4473 2e5a  (prims.PrimIDs.Z
+00015470: 4554 4129 0a64 6566 207a 6574 615f 6261  ETA).def zeta_ba
+00015480: 636b 7761 7264 2878 2c20 792c 2067 293a  ckward(x, y, g):
+00015490: 0a20 2020 2023 2054 6865 2064 6572 6976  .    # The deriv
+000154a0: 6174 6976 6520 7772 7420 7468 6520 6669  ative wrt the fi
+000154b0: 7273 7420 6172 6775 6d65 6e74 2069 7320  rst argument is 
+000154c0: 6e6f 7420 6578 7072 6573 7369 626c 6520  not expressible 
+000154d0: 696e 2074 6572 6d73 206f 6620 7a65 7461  in terms of zeta
+000154e0: 206f 720a 2020 2020 2320 6f74 6865 7220   or.    # other 
+000154f0: 7370 6563 6961 6c20 6675 6e63 7469 6f6e  special function
+00015500: 730a 2020 2020 2320 5468 6572 6566 6f72  s.    # Therefor
+00015510: 652c 2077 6520 636f 6d70 7574 6520 6f6e  e, we compute on
+00015520: 6c79 2074 6865 2064 6572 6976 6174 6976  ly the derivativ
+00015530: 6520 7772 7420 7468 6520 7365 636f 6e64  e wrt the second
+00015540: 2061 7267 756d 656e 740a 2020 2020 6779   argument.    gy
+00015550: 203d 2067 202a 202d 7820 2a20 7072 696d   = g * -x * prim
+00015560: 732e 7a65 7461 2878 202b 2031 2e30 2c20  s.zeta(x + 1.0, 
+00015570: 7929 0a0a 2020 2020 2320 5265 7475 726e  y)..    # Return
+00015580: 2061 206d 6170 7070 696e 6720 6672 6f6d   a mappping from
+00015590: 2074 6865 2066 6f72 7761 7264 2061 7267   the forward arg
+000155a0: 756d 656e 7473 2074 6f20 7468 6520 6772  uments to the gr
+000155b0: 6164 6965 6e74 730a 2020 2020 7265 7475  adients.    retu
+000155c0: 726e 207b 2279 223a 2067 797d 0a0a 0a40  rn {"y": gy}...@
+000155d0: 7265 6769 7374 6572 5f62 6163 6b77 6172  register_backwar
+000155e0: 6428 7072 696d 732e 5072 696d 4944 732e  d(prims.PrimIDs.
+000155f0: 4449 4741 4d4d 4129 0a64 6566 2064 6967  DIGAMMA).def dig
+00015600: 616d 6d61 5f62 6163 6b77 6172 6428 613a  amma_backward(a:
+00015610: 2050 726f 7879 2c20 6729 3a0a 2020 2020   Proxy, g):.    
+00015620: 6672 6f6d 2074 6875 6e64 6572 2e74 6f72  from thunder.tor
+00015630: 6368 2069 6d70 6f72 7420 706f 6c79 6761  ch import polyga
+00015640: 6d6d 610a 0a20 2020 2072 6574 7572 6e20  mma..    return 
+00015650: 6720 2a20 706f 6c79 6761 6d6d 6128 312c  g * polygamma(1,
+00015660: 2061 290a 0a0a 4072 6567 6973 7465 725f   a)...@register_
+00015670: 6175 676d 656e 7465 645f 666f 7277 6172  augmented_forwar
+00015680: 6428 2274 6f72 6368 2e70 6f6c 7967 616d  d("torch.polygam
+00015690: 6d61 2229 0a64 6566 2070 6f6c 7967 616d  ma").def polygam
+000156a0: 6d61 5f61 7567 5f66 7764 286e 3a20 696e  ma_aug_fwd(n: in
+000156b0: 742c 2061 3a20 5072 6f78 7929 3a0a 2020  t, a: Proxy):.  
+000156c0: 2020 6672 6f6d 2074 6875 6e64 6572 2e74    from thunder.t
+000156d0: 6f72 6368 2069 6d70 6f72 7420 706f 6c79  orch import poly
+000156e0: 6761 6d6d 610a 0a20 2020 2070 7269 6d61  gamma..    prima
+000156f0: 6c20 3d20 706f 6c79 6761 6d6d 6128 6e2c  l = polygamma(n,
+00015700: 2061 290a 2020 2020 7265 7369 6475 616c   a).    residual
+00015710: 7320 3d20 286e 2c20 6129 0a20 2020 2072  s = (n, a).    r
+00015720: 6574 7572 6e20 564a 5044 7561 6c28 7072  eturn VJPDual(pr
+00015730: 696d 616c 2c20 7265 7369 6475 616c 7329  imal, residuals)
+00015740: 0a0a 0a40 7265 6769 7374 6572 5f62 6163  ...@register_bac
+00015750: 6b77 6172 6428 2274 6f72 6368 2e70 6f6c  kward("torch.pol
+00015760: 7967 616d 6d61 2229 0a64 6566 2070 6f6c  ygamma").def pol
+00015770: 7967 616d 6d61 5f62 6163 6b77 6172 6428  ygamma_backward(
+00015780: 6e3a 2069 6e74 2c20 613a 2050 726f 7879  n: int, a: Proxy
+00015790: 2c20 6729 3a0a 2020 2020 6672 6f6d 2074  , g):.    from t
+000157a0: 6875 6e64 6572 2e74 6f72 6368 2069 6d70  hunder.torch imp
+000157b0: 6f72 7420 706f 6c79 6761 6d6d 610a 0a20  ort polygamma.. 
+000157c0: 2020 2072 6574 7572 6e20 4e6f 6e65 2c20     return None, 
+000157d0: 6720 2a20 706f 6c79 6761 6d6d 6128 6e20  g * polygamma(n 
+000157e0: 2b20 312c 2061 290a 0a0a 4072 6567 6973  + 1, a)...@regis
+000157f0: 7465 725f 6261 636b 7761 7264 2870 7269  ter_backward(pri
+00015800: 6d73 2e50 7269 6d49 4473 2e41 5441 4e32  ms.PrimIDs.ATAN2
+00015810: 290a 6465 6620 6174 616e 325f 6261 636b  ).def atan2_back
+00015820: 7761 7264 2878 2c20 792c 2067 293a 0a20  ward(x, y, g):. 
+00015830: 2020 2061 6c70 6861 203d 2031 2e30 202f     alpha = 1.0 /
+00015840: 2028 7820 2a20 7820 2b20 7920 2a20 7929   (x * x + y * y)
+00015850: 0a20 2020 2067 7261 645f 7820 3d20 6720  .    grad_x = g 
+00015860: 2a20 7920 2a20 616c 7068 610a 2020 2020  * y * alpha.    
+00015870: 6772 6164 5f79 203d 2067 202a 202d 7820  grad_y = g * -x 
+00015880: 2a20 616c 7068 610a 2020 2020 7265 7475  * alpha.    retu
+00015890: 726e 2067 7261 645f 782c 2067 7261 645f  rn grad_x, grad_
+000158a0: 790a 0a0a 4072 6567 6973 7465 725f 6175  y...@register_au
+000158b0: 676d 656e 7465 645f 666f 7277 6172 6428  gmented_forward(
+000158c0: 7072 696d 732e 5072 696d 4944 732e 5641  prims.PrimIDs.VA
+000158d0: 5229 0a64 6566 2076 6172 5f61 7567 5f66  R).def var_aug_f
+000158e0: 7764 2861 2c20 6469 6d2c 202a 2c20 636f  wd(a, dim, *, co
+000158f0: 7272 6563 7469 6f6e 293a 0a20 2020 2076  rrection):.    v
+00015900: 203d 2070 7269 6d73 2e76 6172 2861 2c20   = prims.var(a, 
+00015910: 6469 6d2c 2063 6f72 7265 6374 696f 6e3d  dim, correction=
+00015920: 636f 7272 6563 7469 6f6e 290a 2020 2020  correction).    
+00015930: 7265 7475 726e 2056 4a50 4475 616c 2828  return VJPDual((
+00015940: 762c 292c 2028 612c 2064 696d 2c20 636f  v,), (a, dim, co
+00015950: 7272 6563 7469 6f6e 2c20 7629 290a 0a0a  rrection, v))...
+00015960: 2320 544f 444f 3a20 6669 7820 6469 7669  # TODO: fix divi
+00015970: 7369 6f6e 2062 7920 7a65 726f 2077 6865  sion by zero whe
+00015980: 6e20 6e5f 656c 656d 5f72 6564 7563 6564  n n_elem_reduced
+00015990: 203d 3d20 3020 6f72 2077 6865 6e20 762e   == 0 or when v.
+000159a0: 6e75 6d65 6c20 3d3d 2030 0a23 2062 7920  numel == 0.# by 
+000159b0: 7265 7475 726e 696e 6720 7a65 726f 735f  returning zeros_
+000159c0: 6c69 6b65 2861 2920 6f72 2073 696d 696c  like(a) or simil
+000159d0: 6172 2e0a 2320 544f 444f 3a20 6669 7820  ar..# TODO: fix 
+000159e0: 6772 6164 2077 6865 6e20 636f 7272 6563  grad when correc
+000159f0: 7469 6f6e 203e 206e 5f65 6c65 6d5f 7265  tion > n_elem_re
+00015a00: 6475 6365 642e 0a40 7265 6769 7374 6572  duced..@register
+00015a10: 5f62 6163 6b77 6172 6428 7072 696d 732e  _backward(prims.
+00015a20: 5072 696d 4944 732e 5641 5229 0a64 6566  PrimIDs.VAR).def
+00015a30: 2076 6172 5f62 6163 6b77 6172 6428 612c   var_backward(a,
+00015a40: 2064 696d 2c20 636f 7272 6563 7469 6f6e   dim, correction
+00015a50: 2c20 762c 2067 293a 0a20 2020 206e 5f65  , v, g):.    n_e
+00015a60: 6c65 6d5f 7265 6475 6365 6420 3d20 612e  lem_reduced = a.
+00015a70: 6e75 6d65 6c20 2f2f 2076 2e6e 756d 656c  numel // v.numel
+00015a80: 2069 6620 612e 6e75 6d65 6c20 213d 2030   if a.numel != 0
+00015a90: 2065 6c73 6520 310a 2020 2020 6e6f 726d   else 1.    norm
+00015aa0: 616c 697a 6174 696f 6e5f 7363 616c 6172  alization_scalar
+00015ab0: 203d 206e 5f65 6c65 6d5f 7265 6475 6365   = n_elem_reduce
+00015ac0: 6420 2d20 636f 7272 6563 7469 6f6e 0a20  d - correction. 
+00015ad0: 2020 2067 203d 2072 6573 746f 7265 5f72     g = restore_r
+00015ae0: 6564 7563 6564 5f64 696d 7328 672c 2064  educed_dims(g, d
+00015af0: 696d 2c20 612e 7368 6170 6529 0a20 2020  im, a.shape).   
+00015b00: 2069 6620 612e 6474 7970 6520 213d 2076   if a.dtype != v
+00015b10: 2e64 7479 7065 3a0a 2020 2020 2020 2020  .dtype:.        
+00015b20: 6120 3d20 7072 696d 732e 636f 6e76 6572  a = prims.conver
+00015b30: 745f 656c 656d 656e 745f 7479 7065 2861  t_element_type(a
+00015b40: 2c20 762e 6474 7970 6529 0a20 2020 206d  , v.dtype).    m
+00015b50: 6561 6e20 3d20 7072 696d 732e 7375 6d28  ean = prims.sum(
+00015b60: 612c 2064 696d 2920 2f20 6e5f 656c 656d  a, dim) / n_elem
+00015b70: 5f72 6564 7563 6564 0a20 2020 206d 6561  _reduced.    mea
+00015b80: 6e20 3d20 7265 7374 6f72 655f 7265 6475  n = restore_redu
+00015b90: 6365 645f 6469 6d73 286d 6561 6e2c 2064  ced_dims(mean, d
+00015ba0: 696d 2c20 612e 7368 6170 6529 0a20 2020  im, a.shape).   
+00015bb0: 2072 6574 7572 6e20 2832 202a 2067 202a   return (2 * g *
+00015bc0: 2028 6120 2d20 6d65 616e 2929 202f 206e   (a - mean)) / n
+00015bd0: 6f72 6d61 6c69 7a61 7469 6f6e 5f73 6361  ormalization_sca
+00015be0: 6c61 720a 0a0a 6465 6620 6e5f 656c 656d  lar...def n_elem
+00015bf0: 5f72 6564 7563 6564 2861 5f6e 6469 6d2c  _reduced(a_ndim,
+00015c00: 2061 5f73 6861 7065 2c20 6469 6d73 293a   a_shape, dims):
+00015c10: 0a20 2020 2064 696d 7320 3d20 7574 696c  .    dims = util
+00015c20: 732e 6361 6e6f 6e69 6361 6c69 7a65 5f64  s.canonicalize_d
+00015c30: 696d 7328 615f 6e64 696d 2c20 6469 6d73  ims(a_ndim, dims
+00015c40: 290a 2020 2020 7265 6475 6374 696f 6e5f  ).    reduction_
+00015c50: 7369 7a65 203d 2031 0a20 2020 2066 6f72  size = 1.    for
+00015c60: 2069 6478 2c20 7369 7a65 2069 6e20 656e   idx, size in en
+00015c70: 756d 6572 6174 6528 615f 7368 6170 6529  umerate(a_shape)
+00015c80: 3a0a 2020 2020 2020 2020 6966 2069 6478  :.        if idx
+00015c90: 2069 6e20 6469 6d73 3a0a 2020 2020 2020   in dims:.      
+00015ca0: 2020 2020 2020 7265 6475 6374 696f 6e5f        reduction_
+00015cb0: 7369 7a65 202a 3d20 7369 7a65 0a20 2020  size *= size.   
+00015cc0: 2072 6574 7572 6e20 7265 6475 6374 696f   return reductio
+00015cd0: 6e5f 7369 7a65 0a0a 0a64 6566 206d 6561  n_size...def mea
+00015ce0: 6e5f 6261 636b 7761 7264 2861 5f6e 6469  n_backward(a_ndi
+00015cf0: 6d2c 2061 5f73 6861 7065 2c20 6469 6d73  m, a_shape, dims
+00015d00: 2c20 6772 6164 293a 0a20 2020 206d 6561  , grad):.    mea
+00015d10: 6e5f 6c6f 6361 6c5f 6772 6164 203d 2031  n_local_grad = 1
+00015d20: 2e30 202f 206e 5f65 6c65 6d5f 7265 6475  .0 / n_elem_redu
+00015d30: 6365 6428 615f 6e64 696d 2c20 615f 7368  ced(a_ndim, a_sh
+00015d40: 6170 652c 2064 696d 7329 0a20 2020 2072  ape, dims).    r
+00015d50: 6574 7572 6e20 7265 7374 6f72 655f 7265  eturn restore_re
+00015d60: 6475 6365 645f 6469 6d73 2867 7261 642c  duced_dims(grad,
+00015d70: 2064 696d 732c 2061 5f73 6861 7065 2920   dims, a_shape) 
+00015d80: 2a20 6d65 616e 5f6c 6f63 616c 5f67 7261  * mean_local_gra
+00015d90: 640a 0a0a 4072 6567 6973 7465 725f 6175  d...@register_au
+00015da0: 676d 656e 7465 645f 666f 7277 6172 6428  gmented_forward(
+00015db0: 7072 696d 732e 5072 696d 4944 732e 5041  prims.PrimIDs.PA
+00015dc0: 4429 0a64 6566 2070 6164 5f61 7567 5f66  D).def pad_aug_f
+00015dd0: 7764 2861 2c20 7061 6464 696e 675f 7661  wd(a, padding_va
+00015de0: 6c75 652c 2070 6164 6469 6e67 5f63 6f6e  lue, padding_con
+00015df0: 6669 6729 3a0a 2020 2020 7265 7475 726e  fig):.    return
+00015e00: 2056 4a50 4475 616c 2828 7072 696d 732e   VJPDual((prims.
+00015e10: 7061 6428 612c 2070 6164 6469 6e67 5f76  pad(a, padding_v
+00015e20: 616c 7565 2c20 7061 6464 696e 675f 636f  alue, padding_co
+00015e30: 6e66 6967 292c 292c 2028 612c 2070 6164  nfig),), (a, pad
+00015e40: 6469 6e67 5f63 6f6e 6669 6729 290a 0a0a  ding_config))...
+00015e50: 4072 6567 6973 7465 725f 6261 636b 7761  @register_backwa
+00015e60: 7264 2870 7269 6d73 2e50 7269 6d49 4473  rd(prims.PrimIDs
+00015e70: 2e50 4144 290a 6465 6620 7061 645f 6261  .PAD).def pad_ba
+00015e80: 636b 7761 7264 2861 2c20 7061 6464 696e  ckward(a, paddin
+00015e90: 675f 636f 6e66 6967 2c20 6729 3a0a 2020  g_config, g):.  
+00015ea0: 2020 2320 5368 6f72 7420 6369 7263 7569    # Short circui
+00015eb0: 7420 6f6e 2065 6d70 7479 2069 6e70 7574  t on empty input
+00015ec0: 2e0a 2020 2020 6966 2061 6e79 2864 696d  ..    if any(dim
+00015ed0: 203d 3d20 3020 666f 7220 6469 6d20 696e   == 0 for dim in
+00015ee0: 2061 2e73 6861 7065 293a 0a20 2020 2020   a.shape):.     
+00015ef0: 2020 2072 6574 7572 6e20 6675 6c6c 5f6c     return full_l
+00015f00: 696b 6528 612c 2066 696c 6c5f 7661 6c75  ike(a, fill_valu
+00015f10: 653d 3029 0a0a 2020 2020 2320 556e 2d70  e=0)..    # Un-p
+00015f20: 6164 2062 7920 7061 6464 696e 6720 7769  ad by padding wi
+00015f30: 7468 207a 6572 6f20 7661 6c75 6573 0a20  th zero values. 
+00015f40: 2020 207a 6572 6f5f 7061 6464 696e 675f     zero_padding_
+00015f50: 636f 6e66 6967 203d 205b 282d 6c6f 2c20  config = [(-lo, 
+00015f60: 2d68 692c 2030 2920 666f 7220 6c6f 2c20  -hi, 0) for lo, 
+00015f70: 6869 2c20 5f20 696e 2070 6164 6469 6e67  hi, _ in padding
+00015f80: 5f63 6f6e 6669 675d 0a0a 2020 2020 6720  _config]..    g 
+00015f90: 3d20 7072 696d 732e 7061 6428 672c 2030  = prims.pad(g, 0
+00015fa0: 2e30 2c20 7a65 726f 5f70 6164 6469 6e67  .0, zero_padding
+00015fb0: 5f63 6f6e 6669 6729 0a0a 2020 2020 2320  _config)..    # 
+00015fc0: 556e 2d73 6c69 6365 2062 7920 736c 6963  Un-slice by slic
+00015fd0: 696e 6720 7769 7468 2061 2073 7472 6964  ing with a strid
+00015fe0: 6520 6f66 2076 616c 7565 2028 6469 6c61  e of value (dila
+00015ff0: 7469 6f6e 202b 2031 290a 2020 2020 666f  tion + 1).    fo
+00016000: 7220 6469 6d2c 2028 5f2c 205f 2c20 6429  r dim, (_, _, d)
+00016010: 2069 6e20 656e 756d 6572 6174 6528 7061   in enumerate(pa
+00016020: 6464 696e 675f 636f 6e66 6967 293a 0a20  dding_config):. 
+00016030: 2020 2020 2020 2067 203d 2073 6c69 6365         g = slice
+00016040: 5f69 6e5f 6469 6d28 672c 2030 2c20 672e  _in_dim(g, 0, g.
+00016050: 7368 6170 655b 6469 6d5d 2c20 7374 7269  shape[dim], stri
+00016060: 6465 3d64 202b 2031 2c20 6469 6d3d 6469  de=d + 1, dim=di
+00016070: 6d29 0a0a 2020 2020 7265 7475 726e 2067  m)..    return g
+00016080: 0a0a 0a40 7265 6769 7374 6572 5f61 7567  ...@register_aug
+00016090: 6d65 6e74 6564 5f66 6f72 7761 7264 2870  mented_forward(p
+000160a0: 7269 6d73 2e50 7269 6d49 4473 2e50 524f  rims.PrimIDs.PRO
+000160b0: 4429 0a64 6566 2070 726f 645f 6175 675f  D).def prod_aug_
+000160c0: 6677 6428 782c 2064 696d 7329 3a0a 2020  fwd(x, dims):.  
+000160d0: 2020 2222 2241 7567 6d65 6e74 6564 2070    """Augmented p
+000160e0: 726f 6420 6f70 6572 6174 696f 6e2e 0a0a  rod operation...
+000160f0: 2020 2020 4172 6773 3a0a 2020 2020 2020      Args:.      
+00016100: 2020 7820 2856 6172 6961 626c 6529 3a20    x (Variable): 
+00016110: 5465 6e73 6f72 2074 6f20 6265 206d 756c  Tensor to be mul
+00016120: 7469 706c 6965 642e 0a20 2020 2020 2020  tiplied..       
+00016130: 2064 696d 7320 2854 7570 6c65 5b69 6e74   dims (Tuple[int
+00016140: 2c20 2e2e 2e5d 293a 2044 696d 656e 7369  , ...]): Dimensi
+00016150: 6f6e 7320 746f 2062 6520 6d75 6c74 6970  ons to be multip
+00016160: 6c69 6564 2e0a 0a20 2020 2052 6574 7572  lied...    Retur
+00016170: 6e73 3a0a 2020 2020 2020 2020 564a 5044  ns:.        VJPD
+00016180: 7561 6c3a 2050 7269 6d61 6c20 616e 6420  ual: Primal and 
+00016190: 7265 7369 6475 616c 732e 0a20 2020 2022  residuals..    "
+000161a0: 2222 0a20 2020 2070 7269 6d61 6c20 3d20  "".    primal = 
+000161b0: 7072 696d 732e 7072 6f64 2878 2c20 6469  prims.prod(x, di
+000161c0: 6d73 290a 0a20 2020 2072 6573 6964 7561  ms)..    residua
+000161d0: 6c73 203d 2028 0a20 2020 2020 2020 2070  ls = (.        p
+000161e0: 7269 6d61 6c2c 0a20 2020 2020 2020 2078  rimal,.        x
+000161f0: 2c0a 2020 2020 2020 2020 782e 7368 6170  ,.        x.shap
+00016200: 652c 0a20 2020 2020 2020 2064 696d 732c  e,.        dims,
+00016210: 0a20 2020 2029 0a20 2020 2072 6574 7572  .    ).    retur
+00016220: 6e20 564a 5044 7561 6c28 7072 696d 616c  n VJPDual(primal
+00016230: 2c20 7265 7369 6475 616c 7329 0a0a 0a40  , residuals)...@
+00016240: 7265 6769 7374 6572 5f62 6163 6b77 6172  register_backwar
+00016250: 6428 7072 696d 732e 5072 696d 4944 732e  d(prims.PrimIDs.
+00016260: 5052 4f44 290a 6465 6620 7072 6f64 5f70  PROD).def prod_p
+00016270: 756c 6c62 6163 6b28 7072 696d 616c 2c20  ullback(primal, 
+00016280: 782c 2078 5f73 6861 7065 2c20 7265 6475  x, x_shape, redu
+00016290: 6365 645f 6469 6d73 2c20 6729 3a0a 2020  ced_dims, g):.  
+000162a0: 2020 7265 7475 726e 2070 7269 6d73 2e64    return prims.d
+000162b0: 6976 2872 6573 746f 7265 5f72 6564 7563  iv(restore_reduc
+000162c0: 6564 5f64 696d 7328 7072 696d 616c 202a  ed_dims(primal *
+000162d0: 2067 2c20 7265 6475 6365 645f 6469 6d73   g, reduced_dims
+000162e0: 2c20 785f 7368 6170 6529 2c20 7829 0a0a  , x_shape), x)..
+000162f0: 0a64 6566 206b 6565 7064 696d 5f72 6564  .def keepdim_red
+00016300: 7563 7469 6f6e 2872 6564 7563 7469 6f6e  uction(reduction
+00016310: 5f66 6e2c 2078 2c20 6469 6d73 293a 0a20  _fn, x, dims):. 
+00016320: 2020 2022 2222 4170 706c 6965 7320 7265     """Applies re
+00016330: 6475 6374 696f 6e20 616e 6420 6669 7865  duction and fixe
+00016340: 7320 6f75 7470 7574 2074 6f20 636f 6e66  s output to conf
+00016350: 6f72 6d20 746f 206b 6565 7064 696d 3d54  orm to keepdim=T
+00016360: 7275 6522 2222 0a20 2020 206f 7574 203d  rue""".    out =
+00016370: 2072 6564 7563 7469 6f6e 5f66 6e28 782c   reduction_fn(x,
+00016380: 2064 696d 7329 0a20 2020 2061 7267 6d61   dims).    argma
+00016390: 785f 7375 6d5f 6f75 745f 7368 6170 6520  x_sum_out_shape 
+000163a0: 3d20 5b78 2e73 6861 7065 5b69 5d20 6966  = [x.shape[i] if
+000163b0: 2069 206e 6f74 2069 6e20 6469 6d73 2065   i not in dims e
+000163c0: 6c73 6520 3120 666f 7220 6920 696e 2072  lse 1 for i in r
+000163d0: 616e 6765 2878 2e6e 6469 6d29 5d0a 2020  ange(x.ndim)].  
+000163e0: 2020 6272 6f61 6463 6173 745f 6469 6d73    broadcast_dims
+000163f0: 203d 205b 6920 666f 7220 6920 696e 2072   = [i for i in r
+00016400: 616e 6765 2878 2e6e 6469 6d29 2069 6620  ange(x.ndim) if 
+00016410: 6920 6e6f 7420 696e 2064 696d 735d 0a20  i not in dims]. 
+00016420: 2020 2072 6574 7572 6e20 7072 696d 732e     return prims.
+00016430: 6272 6f61 6463 6173 745f 696e 5f64 696d  broadcast_in_dim
+00016440: 286f 7574 2c20 6172 676d 6178 5f73 756d  (out, argmax_sum
+00016450: 5f6f 7574 5f73 6861 7065 2c20 6272 6f61  _out_shape, broa
+00016460: 6463 6173 745f 6469 6d73 290a 0a0a 2320  dcast_dims)...# 
+00016470: 496e 7370 6972 6564 2066 726f 6d20 6874  Inspired from ht
+00016480: 7470 733a 2f2f 6769 7468 7562 2e63 6f6d  tps://github.com
+00016490: 2f48 4950 532f 6175 746f 6772 6164 2f62  /HIPS/autograd/b
+000164a0: 6c6f 622f 6d61 7374 6572 2f61 7574 6f67  lob/master/autog
+000164b0: 7261 642f 6e75 6d70 792f 6e75 6d70 795f  rad/numpy/numpy_
+000164c0: 766a 7073 2e70 7923 4c33 3533 0a64 6566  vjps.py#L353.def
+000164d0: 2067 7261 645f 6368 6f6f 7365 725f 6261   grad_chooser_ba
+000164e0: 636b 7761 7264 2870 7269 6d61 6c2c 2078  ckward(primal, x
+000164f0: 2c20 785f 7368 6170 652c 2072 6564 7563  , x_shape, reduc
+00016500: 6564 5f64 696d 732c 2067 293a 0a20 2020  ed_dims, g):.   
+00016510: 2022 2222 4275 696c 6473 2067 7261 6469   """Builds gradi
+00016520: 656e 7420 6f66 2066 756e 6374 696f 6e73  ent of functions
+00016530: 2074 6861 7420 6368 6f6f 7365 2061 2073   that choose a s
+00016540: 696e 676c 6520 6974 656d 2c20 7375 6368  ingle item, such
+00016550: 2061 7320 6d69 6e20 6f72 206d 6178 2e22   as min or max."
+00016560: 2222 0a20 2020 2067 5f72 6570 6561 7465  "".    g_repeate
+00016570: 6420 3d20 7265 7374 6f72 655f 7265 6475  d = restore_redu
+00016580: 6365 645f 6469 6d73 2867 2c20 7265 6475  ced_dims(g, redu
+00016590: 6365 645f 6469 6d73 2c20 785f 7368 6170  ced_dims, x_shap
+000165a0: 6529 0a20 2020 2070 7269 6d61 6c5f 7265  e).    primal_re
+000165b0: 7065 6174 6564 203d 2072 6573 746f 7265  peated = restore
+000165c0: 5f72 6564 7563 6564 5f64 696d 7328 7072  _reduced_dims(pr
+000165d0: 696d 616c 2c20 7265 6475 6365 645f 6469  imal, reduced_di
+000165e0: 6d73 2c20 785f 7368 6170 6529 0a20 2020  ms, x_shape).   
+000165f0: 2061 7267 6d61 785f 6c6f 6361 7469 6f6e   argmax_location
+00016600: 7320 3d20 7820 3d3d 2070 7269 6d61 6c5f  s = x == primal_
+00016610: 7265 7065 6174 6564 0a20 2020 2061 7267  repeated.    arg
+00016620: 6d61 785f 7375 6d20 3d20 6b65 6570 6469  max_sum = keepdi
+00016630: 6d5f 7265 6475 6374 696f 6e28 7072 696d  m_reduction(prim
+00016640: 732e 7375 6d2c 2061 7267 6d61 785f 6c6f  s.sum, argmax_lo
+00016650: 6361 7469 6f6e 732c 2072 6564 7563 6564  cations, reduced
+00016660: 5f64 696d 7329 0a20 2020 206f 7574 203d  _dims).    out =
+00016670: 2067 5f72 6570 6561 7465 6420 2a20 6172   g_repeated * ar
+00016680: 676d 6178 5f6c 6f63 6174 696f 6e73 202f  gmax_locations /
+00016690: 2061 7267 6d61 785f 7375 6d0a 2020 2020   argmax_sum.    
+000166a0: 7265 7475 726e 206f 7574 0a0a 0a72 6567  return out...reg
+000166b0: 6973 7465 725f 6261 636b 7761 7264 2870  ister_backward(p
+000166c0: 7269 6d73 2e50 7269 6d49 4473 2e41 4d49  rims.PrimIDs.AMI
+000166d0: 4e29 2867 7261 645f 6368 6f6f 7365 725f  N)(grad_chooser_
+000166e0: 6261 636b 7761 7264 290a 0a0a 4072 6567  backward)...@reg
+000166f0: 6973 7465 725f 6175 676d 656e 7465 645f  ister_augmented_
+00016700: 666f 7277 6172 6428 7072 696d 732e 5072  forward(prims.Pr
+00016710: 696d 4944 732e 414d 494e 290a 6465 6620  imIDs.AMIN).def 
+00016720: 616d 696e 5f61 7567 5f66 7764 2878 2c20  amin_aug_fwd(x, 
+00016730: 6469 6d73 293a 0a20 2020 2022 2222 4175  dims):.    """Au
+00016740: 676d 656e 7465 6420 616d 696e 206f 7065  gmented amin ope
+00016750: 7261 7469 6f6e 2e0a 2020 2020 4172 6773  ration..    Args
+00016760: 3a0a 2020 2020 2020 2020 7820 2856 6172  :.        x (Var
+00016770: 6961 626c 6529 3a20 5465 6e73 6f72 2074  iable): Tensor t
+00016780: 6f20 636f 6d70 7574 6520 616d 696e 206f  o compute amin o
+00016790: 6e2e 0a20 2020 2020 2020 2064 696d 7320  n..        dims 
+000167a0: 2854 7570 6c65 5b69 6e74 2c20 2e2e 2e5d  (Tuple[int, ...]
+000167b0: 293a 2044 696d 656e 7369 6f6e 7320 746f  ): Dimensions to
+000167c0: 2063 6f6d 7075 7465 2061 6d69 6e20 6f76   compute amin ov
+000167d0: 6572 2e0a 2020 2020 5265 7475 726e 733a  er..    Returns:
+000167e0: 0a20 2020 2020 2020 2056 4a50 4475 616c  .        VJPDual
+000167f0: 3a20 5072 696d 616c 2061 6e64 2072 6573  : Primal and res
+00016800: 6964 7561 6c73 2e0a 2020 2020 2222 220a  iduals..    """.
+00016810: 2020 2020 7072 696d 616c 203d 2070 7269      primal = pri
+00016820: 6d73 2e61 6d69 6e28 782c 2064 696d 7329  ms.amin(x, dims)
+00016830: 0a0a 2020 2020 7265 7369 6475 616c 7320  ..    residuals 
+00016840: 3d20 280a 2020 2020 2020 2020 7072 696d  = (.        prim
+00016850: 616c 2c0a 2020 2020 2020 2020 782c 0a20  al,.        x,. 
+00016860: 2020 2020 2020 2078 2e73 6861 7065 2c0a         x.shape,.
+00016870: 2020 2020 2020 2020 6469 6d73 2c0a 2020          dims,.  
+00016880: 2020 290a 0a20 2020 2072 6574 7572 6e20    )..    return 
+00016890: 564a 5044 7561 6c28 7072 696d 616c 2c20  VJPDual(primal, 
+000168a0: 7265 7369 6475 616c 7329 0a0a 0a40 7265  residuals)...@re
+000168b0: 6769 7374 6572 5f61 7567 6d65 6e74 6564  gister_augmented
+000168c0: 5f66 6f72 7761 7264 2870 7269 6d73 2e50  _forward(prims.P
+000168d0: 7269 6d49 4473 2e50 4f57 290a 6465 6620  rimIDs.POW).def 
+000168e0: 706f 775f 6175 675f 6665 6428 782c 2079  pow_aug_fed(x, y
+000168f0: 293a 0a20 2020 2022 2222 4175 676d 656e  ):.    """Augmen
+00016900: 7465 6420 7468 6520 706f 7720 6f70 6572  ted the pow oper
+00016910: 6174 696f 6e2e 0a0a 2020 2020 4172 6773  ation...    Args
+00016920: 3a0a 2020 2020 2020 2020 7820 2856 6172  :.        x (Var
+00016930: 6961 626c 6529 3a20 5465 6e73 6f72 2077  iable): Tensor w
+00016940: 6974 6820 7468 6520 6261 7365 2074 6f20  ith the base to 
+00016950: 6265 2065 7870 6f6e 656e 7469 6174 6564  be exponentiated
+00016960: 2e0a 2020 2020 2020 2020 7920 2856 6172  ..        y (Var
+00016970: 6961 626c 6529 3a20 5465 6e73 6f72 2077  iable): Tensor w
+00016980: 6974 6820 706f 7765 7220 746f 2072 6169  ith power to rai
+00016990: 7365 2074 6f2e 0a0a 2020 2020 5265 7475  se to...    Retu
+000169a0: 726e 733a 0a20 2020 2020 2020 2056 4a50  rns:.        VJP
+000169b0: 4475 616c 3a20 5072 696d 616c 2061 6e64  Dual: Primal and
+000169c0: 2072 6573 6964 7561 6c73 2e0a 2020 2020   residuals..    
+000169d0: 2222 220a 2020 2020 7072 696d 616c 203d  """.    primal =
+000169e0: 2070 7269 6d73 2e70 6f77 2878 2c20 7929   prims.pow(x, y)
+000169f0: 0a20 2020 2072 6573 6964 7561 6c73 203d  .    residuals =
+00016a00: 2028 7072 696d 616c 2c20 782c 2079 290a   (primal, x, y).
+00016a10: 2020 2020 7265 7475 726e 2056 4a50 4475      return VJPDu
+00016a20: 616c 2870 7269 6d61 6c2c 2072 6573 6964  al(primal, resid
+00016a30: 7561 6c73 290a 0a0a 4072 6567 6973 7465  uals)...@registe
+00016a40: 725f 6261 636b 7761 7264 2870 7269 6d73  r_backward(prims
+00016a50: 2e50 7269 6d49 4473 2e50 4f57 290a 6465  .PrimIDs.POW).de
+00016a60: 6620 706f 775f 6261 636b 7761 7264 2872  f pow_backward(r
+00016a70: 6573 756c 742c 2078 2c20 792c 2067 293a  esult, x, y, g):
+00016a80: 0a20 2020 2069 6d70 6f72 7420 7468 756e  .    import thun
+00016a90: 6465 722e 636c 616e 6720 6173 2074 6c61  der.clang as tla
+00016aa0: 6e67 0a0a 2020 2020 6772 6573 756c 7420  ng..    gresult 
+00016ab0: 3d20 6720 2a20 7265 7375 6c74 2020 2320  = g * result  # 
+00016ac0: 7265 7573 6520 636f 6d6d 6f6e 2066 6163  reuse common fac
+00016ad0: 746f 720a 2020 2020 6478 203d 2067 202a  tor.    dx = g *
+00016ae0: 2079 202a 2078 202a 2a20 2879 202d 2031   y * x ** (y - 1
+00016af0: 290a 2020 2020 6479 203d 2067 7265 7375  ).    dy = gresu
+00016b00: 6c74 202a 2074 6c61 6e67 2e6c 6f67 2878  lt * tlang.log(x
+00016b10: 290a 2020 2020 7265 7475 726e 2064 782c  ).    return dx,
+00016b20: 2064 790a 0a0a 4072 6567 6973 7465 725f   dy...@register_
+00016b30: 6175 676d 656e 7465 645f 666f 7277 6172  augmented_forwar
+00016b40: 6428 7072 696d 732e 5072 696d 4944 732e  d(prims.PrimIDs.
+00016b50: 5441 4e29 0a64 6566 2074 616e 5f61 7567  TAN).def tan_aug
+00016b60: 5f66 7764 2878 293a 0a20 2020 2022 2222  _fwd(x):.    """
+00016b70: 4175 676d 656e 7465 6420 7461 6e20 6f70  Augmented tan op
+00016b80: 6572 6174 696f 6e2e 0a0a 2020 2020 4172  eration...    Ar
+00016b90: 6773 3a0a 2020 2020 2020 2020 7820 2856  gs:.        x (V
+00016ba0: 6172 6961 626c 6529 3a20 5465 6e73 6f72  ariable): Tensor
+00016bb0: 2074 6f20 6265 2070 6173 7365 6420 746f   to be passed to
+00016bc0: 2074 616e 2e0a 2020 2020 2222 220a 0a20   tan..    """.. 
+00016bd0: 2020 2070 7269 6d61 6c20 3d20 7072 696d     primal = prim
+00016be0: 732e 7461 6e28 7829 0a20 2020 2072 6573  s.tan(x).    res
+00016bf0: 6964 7561 6c73 203d 2028 7072 696d 616c  iduals = (primal
+00016c00: 2c29 0a20 2020 2072 6574 7572 6e20 564a  ,).    return VJ
+00016c10: 5044 7561 6c28 7072 696d 616c 2c20 7265  PDual(primal, re
+00016c20: 7369 6475 616c 7329 0a0a 0a40 7265 6769  siduals)...@regi
+00016c30: 7374 6572 5f62 6163 6b77 6172 6428 7072  ster_backward(pr
+00016c40: 696d 732e 5072 696d 4944 732e 5441 4e29  ims.PrimIDs.TAN)
+00016c50: 0a64 6566 2074 616e 5f62 6163 6b77 6172  .def tan_backwar
+00016c60: 6428 7265 7375 6c74 2c20 6729 3a0a 2020  d(result, g):.  
+00016c70: 2020 7265 7475 726e 2067 202a 2028 3120    return g * (1 
+00016c80: 2b20 7265 7375 6c74 202a 2072 6573 756c  + result * resul
+00016c90: 7429 0a0a 0a23 204e 4f54 453a 204a 6178  t)...# NOTE: Jax
+00016ca0: 2075 7365 7320 6e70 2e61 7267 736f 7274   uses np.argsort
+00016cb0: 2069 6e20 6974 7320 7472 616e 7370 6f73   in its transpos
+00016cc0: 6520 766a 7020 636f 6d70 7574 6174 696f  e vjp computatio
+00016cd0: 6e0a 6465 6620 5f61 7267 736f 7274 2873  n.def _argsort(s
+00016ce0: 6571 293a 0a20 2020 2072 6574 7572 6e20  eq):.    return 
+00016cf0: 736f 7274 6564 2872 616e 6765 286c 656e  sorted(range(len
+00016d00: 2873 6571 2929 2c20 6b65 793d 7365 712e  (seq)), key=seq.
+00016d10: 5f5f 6765 7469 7465 6d5f 5f29 0a0a 0a40  __getitem__)...@
+00016d20: 7265 6769 7374 6572 5f61 7567 6d65 6e74  register_augment
+00016d30: 6564 5f66 6f72 7761 7264 2870 7269 6d73  ed_forward(prims
+00016d40: 2e50 7269 6d49 4473 2e44 4556 4943 455f  .PrimIDs.DEVICE_
+00016d50: 5055 5429 0a64 6566 2064 6576 6963 655f  PUT).def device_
+00016d60: 7075 745f 6175 675f 6677 6428 613a 2054  put_aug_fwd(a: T
+00016d70: 656e 736f 7250 726f 7879 2c20 6465 7669  ensorProxy, devi
+00016d80: 6365 3a20 4465 7669 6365 2920 2d3e 2054  ce: Device) -> T
+00016d90: 656e 736f 7250 726f 7879 3a0a 2020 2020  ensorProxy:.    
+00016da0: 7072 696d 616c 203d 2070 7269 6d73 2e64  primal = prims.d
+00016db0: 6576 6963 655f 7075 7428 612c 2064 6576  evice_put(a, dev
+00016dc0: 6963 6529 0a20 2020 2072 6573 6964 7561  ice).    residua
+00016dd0: 6c73 203d 2028 612e 6465 7669 6365 2c29  ls = (a.device,)
+00016de0: 0a20 2020 2072 6574 7572 6e20 564a 5044  .    return VJPD
+00016df0: 7561 6c28 7072 696d 616c 2c20 7265 7369  ual(primal, resi
+00016e00: 6475 616c 7329 0a0a 0a40 7265 6769 7374  duals)...@regist
+00016e10: 6572 5f62 6163 6b77 6172 6428 7072 696d  er_backward(prim
+00016e20: 732e 5072 696d 4944 732e 4445 5649 4345  s.PrimIDs.DEVICE
+00016e30: 5f50 5554 290a 6465 6620 6465 7669 6365  _PUT).def device
+00016e40: 5f70 7574 5f62 6163 6b77 6172 6428 6f72  _put_backward(or
+00016e50: 6967 5f64 6576 6963 652c 2067 293a 0a20  ig_device, g):. 
+00016e60: 2020 2072 6574 7572 6e20 7072 696d 732e     return prims.
+00016e70: 6465 7669 6365 5f70 7574 2867 2c20 6f72  device_put(g, or
+00016e80: 6967 5f64 6576 6963 6529 2c20 4e6f 6e65  ig_device), None
+00016e90: 0a0a 0a40 7265 6769 7374 6572 5f61 7567  ...@register_aug
+00016ea0: 6d65 6e74 6564 5f66 6f72 7761 7264 2870  mented_forward(p
+00016eb0: 7269 6d73 2e50 7269 6d49 4473 2e43 4f4e  rims.PrimIDs.CON
+00016ec0: 564f 4c55 5449 4f4e 290a 6465 6620 636f  VOLUTION).def co
+00016ed0: 6e76 6f6c 7574 696f 6e5f 6175 675f 6677  nvolution_aug_fw
+00016ee0: 6428 0a20 2020 2061 3a20 5072 6f78 792c  d(.    a: Proxy,
+00016ef0: 0a20 2020 2077 6569 6768 742c 0a20 2020  .    weight,.   
+00016f00: 2062 6961 732c 0a20 2020 2073 7472 6964   bias,.    strid
+00016f10: 652c 0a20 2020 2070 6164 6469 6e67 2c0a  e,.    padding,.
+00016f20: 2020 2020 6469 6c61 7469 6f6e 2c0a 2020      dilation,.  
+00016f30: 2020 7472 616e 7370 6f73 6564 2c0a 2020    transposed,.  
+00016f40: 2020 6f75 7470 7574 5f70 6164 6469 6e67    output_padding
+00016f50: 2c0a 2020 2020 6772 6f75 7073 2c0a 293a  ,.    groups,.):
+00016f60: 0a20 2020 2070 7269 6d61 6c20 3d20 636f  .    primal = co
+00016f70: 6e76 6f6c 7574 696f 6e28 612c 2077 6569  nvolution(a, wei
+00016f80: 6768 742c 2062 6961 732c 2073 7472 6964  ght, bias, strid
+00016f90: 652c 2070 6164 6469 6e67 2c20 6469 6c61  e, padding, dila
+00016fa0: 7469 6f6e 2c20 7472 616e 7370 6f73 6564  tion, transposed
+00016fb0: 2c20 6f75 7470 7574 5f70 6164 6469 6e67  , output_padding
+00016fc0: 2c20 6772 6f75 7073 290a 2020 2020 7265  , groups).    re
+00016fd0: 7369 6475 616c 7320 3d20 2870 7269 6d61  siduals = (prima
+00016fe0: 6c2c 2061 2c20 7765 6967 6874 2c20 6269  l, a, weight, bi
+00016ff0: 6173 2c20 7374 7269 6465 2c20 7061 6464  as, stride, padd
+00017000: 696e 672c 2064 696c 6174 696f 6e2c 2074  ing, dilation, t
+00017010: 7261 6e73 706f 7365 642c 206f 7574 7075  ransposed, outpu
+00017020: 745f 7061 6464 696e 672c 2067 726f 7570  t_padding, group
+00017030: 7329 0a20 2020 2072 6574 7572 6e20 564a  s).    return VJ
+00017040: 5044 7561 6c28 7072 696d 616c 2c20 7265  PDual(primal, re
+00017050: 7369 6475 616c 7329 0a0a 0a40 7265 6769  siduals)...@regi
+00017060: 7374 6572 5f62 6163 6b77 6172 6428 7072  ster_backward(pr
+00017070: 696d 732e 5072 696d 4944 732e 434f 4e56  ims.PrimIDs.CONV
+00017080: 4f4c 5554 494f 4e29 0a64 6566 2063 6f6e  OLUTION).def con
+00017090: 766f 6c75 7469 6f6e 5f62 6163 6b77 6172  volution_backwar
+000170a0: 6428 0a20 2020 206f 7574 7075 743a 2050  d(.    output: P
+000170b0: 726f 7879 2c0a 2020 2020 696e 7075 743a  roxy,.    input:
+000170c0: 2050 726f 7879 2c0a 2020 2020 7765 6967   Proxy,.    weig
+000170d0: 6874 2c0a 2020 2020 6269 6173 2c0a 2020  ht,.    bias,.  
+000170e0: 2020 7374 7269 6465 2c0a 2020 2020 7061    stride,.    pa
+000170f0: 6464 696e 672c 0a20 2020 2064 696c 6174  dding,.    dilat
+00017100: 696f 6e2c 0a20 2020 2074 7261 6e73 706f  ion,.    transpo
+00017110: 7365 642c 0a20 2020 206f 7574 7075 745f  sed,.    output_
+00017120: 7061 6464 696e 672c 0a20 2020 2067 726f  padding,.    gro
+00017130: 7570 732c 0a20 2020 2067 7261 642c 0a29  ups,.    grad,.)
+00017140: 3a0a 2020 2020 2320 5472 616e 7370 6f73  :.    # Transpos
+00017150: 6564 2063 6f6e 766f 6c75 7469 6f6e 2069  ed convolution i
+00017160: 7320 6e6f 7420 7375 7070 6f72 7465 6421  s not supported!
+00017170: 0a20 2020 2061 7373 6572 7420 7472 616e  .    assert tran
+00017180: 7370 6f73 6564 203d 3d20 300a 0a20 2020  sposed == 0..   
+00017190: 2069 6e70 7574 5f67 7261 6420 3d20 4e6f   input_grad = No
+000171a0: 6e65 0a20 2020 2077 6569 6768 745f 6772  ne.    weight_gr
+000171b0: 6164 203d 204e 6f6e 650a 2020 2020 6269  ad = None.    bi
+000171c0: 6173 5f67 7261 6420 3d20 4e6f 6e65 0a0a  as_grad = None..
+000171d0: 2020 2020 2320 5368 6f72 7420 6369 7263      # Short circ
+000171e0: 7569 7420 6f6e 207a 6572 6f2d 6469 6d20  uit on zero-dim 
+000171f0: 6772 6164 0a20 2020 2069 6620 616e 7928  grad.    if any(
+00017200: 7320 3d3d 2030 2066 6f72 2073 2069 6e20  s == 0 for s in 
+00017210: 6772 6164 2e73 6861 7065 293a 0a20 2020  grad.shape):.   
+00017220: 2020 2020 2069 6e70 7574 5f67 7261 6420       input_grad 
+00017230: 3d20 6675 6c6c 5f6c 696b 6528 696e 7075  = full_like(inpu
+00017240: 742c 2066 696c 6c5f 7661 6c75 653d 3029  t, fill_value=0)
+00017250: 0a20 2020 2020 2020 2077 6569 6768 745f  .        weight_
+00017260: 6772 6164 203d 2066 756c 6c5f 6c69 6b65  grad = full_like
+00017270: 2877 6569 6768 742c 2066 696c 6c5f 7661  (weight, fill_va
+00017280: 6c75 653d 3029 0a20 2020 2020 2020 2069  lue=0).        i
+00017290: 6620 6269 6173 2069 7320 6e6f 7420 4e6f  f bias is not No
+000172a0: 6e65 3a0a 2020 2020 2020 2020 2020 2020  ne:.            
+000172b0: 6269 6173 5f67 7261 6420 3d20 6675 6c6c  bias_grad = full
+000172c0: 5f6c 696b 6528 6269 6173 2c20 6669 6c6c  _like(bias, fill
+000172d0: 5f76 616c 7565 3d30 290a 2020 2020 2020  _value=0).      
+000172e0: 2020 7265 7475 726e 2028 696e 7075 745f    return (input_
+000172f0: 6772 6164 2c20 7765 6967 6874 5f67 7261  grad, weight_gra
+00017300: 642c 2062 6961 735f 6772 6164 2920 2b20  d, bias_grad) + 
+00017310: 2828 4e6f 6e65 2c29 202a 2036 290a 0a20  ((None,) * 6).. 
+00017320: 2020 2062 6174 6368 2c20 696e 5f63 6861     batch, in_cha
+00017330: 6e6e 656c 732c 202a 7370 6174 6961 6c5f  nnels, *spatial_
+00017340: 6469 6d73 203d 2069 6e70 7574 2e73 6861  dims = input.sha
+00017350: 7065 0a20 2020 206f 7574 5f63 6861 6e6e  pe.    out_chann
+00017360: 656c 732c 2067 696e 5f63 6861 6e6e 656c  els, gin_channel
+00017370: 732c 202a 6b65 726e 656c 5f64 696d 7320  s, *kernel_dims 
+00017380: 3d20 7765 6967 6874 2e73 6861 7065 0a20  = weight.shape. 
+00017390: 2020 2064 696d 203d 206c 656e 2873 7061     dim = len(spa
+000173a0: 7469 616c 5f64 696d 7329 0a0a 2020 2020  tial_dims)..    
+000173b0: 6465 6620 6d61 7962 655f 6578 7061 6e64  def maybe_expand
+000173c0: 5f73 6571 2873 2c20 6469 6d29 3a0a 2020  _seq(s, dim):.  
+000173d0: 2020 2020 2020 6966 206c 656e 2873 2920        if len(s) 
+000173e0: 3d3d 2031 3a0a 2020 2020 2020 2020 2020  == 1:.          
+000173f0: 2020 7265 7475 726e 2028 735b 305d 2c29    return (s[0],)
+00017400: 202a 2064 696d 0a20 2020 2020 2020 2065   * dim.        e
+00017410: 6c73 653a 0a20 2020 2020 2020 2020 2020  lse:.           
+00017420: 2072 6574 7572 6e20 730a 0a20 2020 2073   return s..    s
+00017430: 7472 6964 6520 3d20 6d61 7962 655f 6578  tride = maybe_ex
+00017440: 7061 6e64 5f73 6571 2873 7472 6964 652c  pand_seq(stride,
+00017450: 2064 696d 290a 2020 2020 7061 6464 696e   dim).    paddin
+00017460: 6720 3d20 6d61 7962 655f 6578 7061 6e64  g = maybe_expand
+00017470: 5f73 6571 2870 6164 6469 6e67 2c20 6469  _seq(padding, di
+00017480: 6d29 0a20 2020 2064 696c 6174 696f 6e20  m).    dilation 
+00017490: 3d20 6d61 7962 655f 6578 7061 6e64 5f73  = maybe_expand_s
+000174a0: 6571 2864 696c 6174 696f 6e2c 2064 696d  eq(dilation, dim
+000174b0: 290a 0a20 2020 2064 6566 2063 6f6e 765f  )..    def conv_
+000174c0: 7472 616e 7370 6f73 6528 7429 3a0a 2020  transpose(t):.  
+000174d0: 2020 2020 2020 7265 7475 726e 2070 7269        return pri
+000174e0: 6d73 2e74 7261 6e73 706f 7365 2874 2c20  ms.transpose(t, 
+000174f0: 2831 2c20 3029 202b 2074 7570 6c65 2872  (1, 0) + tuple(r
+00017500: 616e 6765 2832 2c20 742e 6e64 696d 2929  ange(2, t.ndim))
+00017510: 290a 0a20 2020 2023 2069 6e70 7574 5f67  )..    # input_g
+00017520: 7261 6420 3d20 7b0a 2020 2020 6465 6620  rad = {.    def 
+00017530: 7472 616e 7370 6f73 655f 616e 645f 666c  transpose_and_fl
+00017540: 6970 5f77 6569 6768 7428 7765 6967 6874  ip_weight(weight
+00017550: 293a 0a20 2020 2020 2020 2023 2054 6865  ):.        # The
+00017560: 206c 696e 6573 2062 656c 6f77 2061 7265   lines below are
+00017570: 2074 7261 6e73 706f 7369 6e67 2074 6865   transposing the
+00017580: 2063 6861 6e6e 656c 7320 6469 6d73 2e0a   channels dims..
+00017590: 2020 2020 2020 2020 2320 5765 2061 6c73          # We als
+000175a0: 6f20 6e65 6564 2074 6f20 6578 7472 6163  o need to extrac
+000175b0: 7420 7468 6520 6772 6f75 7020 696e 666f  t the group info
+000175c0: 726d 6174 696f 6e20 616e 6420 6d65 7267  rmation and merg
+000175d0: 6520 6974 0a20 2020 2020 2020 2023 2077  e it.        # w
+000175e0: 6974 6820 7468 6520 6469 6d65 6e73 696f  ith the dimensio
+000175f0: 6e20 636f 7272 6573 706f 6e64 696e 6720  n corresponding 
+00017600: 746f 2074 6865 2022 6f75 745f 6368 616e  to the "out_chan
+00017610: 6e65 6c73 2220 6469 6d2e 0a20 2020 2020  nels" dim..     
+00017620: 2020 2023 2028 6f75 745f 6368 616e 6e65     # (out_channe
+00017630: 6c73 2c20 6769 6e5f 6368 616e 6e65 6c73  ls, gin_channels
+00017640: 2920 2d3e 2028 6769 6e5f 6368 616e 6e65  ) -> (gin_channe
+00017650: 6c73 2c20 6f75 745f 6368 616e 6e65 6c73  ls, out_channels
+00017660: 290a 2020 2020 2020 2020 7765 6967 6874  ).        weight
+00017670: 203d 2063 6f6e 765f 7472 616e 7370 6f73   = conv_transpos
+00017680: 6528 7765 6967 6874 290a 2020 2020 2020  e(weight).      
+00017690: 2020 2320 5370 6c69 7420 286f 7574 5f63    # Split (out_c
+000176a0: 6861 6e6e 656c 732c 2920 2d3e 2028 6772  hannels,) -> (gr
+000176b0: 6f75 7073 2c20 6f75 745f 6368 616e 6e65  oups, out_channe
+000176c0: 6c73 202f 2f20 6772 6f75 7073 290a 2020  ls // groups).  
+000176d0: 2020 2020 2020 7765 6967 6874 203d 2077        weight = w
+000176e0: 6569 6768 742e 7265 7368 6170 6528 5b67  eight.reshape([g
+000176f0: 696e 5f63 6861 6e6e 656c 732c 2067 726f  in_channels, gro
+00017700: 7570 732c 206f 7574 5f63 6861 6e6e 656c  ups, out_channel
+00017710: 7320 2f2f 2067 726f 7570 735d 202b 206b  s // groups] + k
+00017720: 6572 6e65 6c5f 6469 6d73 290a 2020 2020  ernel_dims).    
+00017730: 2020 2020 2320 4d6f 7669 6e67 2067 726f      # Moving gro
+00017740: 7570 7320 746f 2074 6865 206c 6566 742d  ups to the left-
+00017750: 6d6f 7374 2070 6f73 6974 696f 6e2e 0a20  most position.. 
+00017760: 2020 2020 2020 2023 2028 6769 6e5f 6368         # (gin_ch
+00017770: 616e 6e65 6c73 2c20 6772 6f75 7073 2c20  annels, groups, 
+00017780: 6f75 745f 6368 616e 6e65 6c73 202f 2f20  out_channels // 
+00017790: 6772 6f75 7073 2920 2d3e 2028 6772 6f75  groups) -> (grou
+000177a0: 7073 2c20 6769 6e5f 6368 616e 6e65 6c73  ps, gin_channels
+000177b0: 2c20 6f75 745f 6368 616e 6e65 6c73 202f  , out_channels /
+000177c0: 2f20 6772 6f75 7073 290a 2020 2020 2020  / groups).      
+000177d0: 2020 7765 6967 6874 203d 2063 6f6e 765f    weight = conv_
+000177e0: 7472 616e 7370 6f73 6528 7765 6967 6874  transpose(weight
+000177f0: 290a 2020 2020 2020 2020 2320 5371 7561  ).        # Squa
+00017800: 7368 2028 6772 6f75 7073 2c20 6769 6e5f  sh (groups, gin_
+00017810: 6368 616e 6e65 6c73 2920 2d3e 2028 696e  channels) -> (in
+00017820: 5f63 6861 6e6e 656c 7329 0a20 2020 2020  _channels).     
+00017830: 2020 2077 6569 6768 7420 3d20 7765 6967     weight = weig
+00017840: 6874 2e72 6573 6861 7065 285b 696e 5f63  ht.reshape([in_c
+00017850: 6861 6e6e 656c 732c 206f 7574 5f63 6861  hannels, out_cha
+00017860: 6e6e 656c 7320 2f2f 2067 726f 7570 735d  nnels // groups]
+00017870: 202b 206b 6572 6e65 6c5f 6469 6d73 290a   + kernel_dims).
+00017880: 0a20 2020 2020 2020 2023 2046 6c69 7020  .        # Flip 
+00017890: 7370 6174 6961 6c20 6469 6d65 6e73 696f  spatial dimensio
+000178a0: 6e73 0a20 2020 2020 2020 2077 6569 6768  ns.        weigh
+000178b0: 7420 3d20 7072 696d 732e 666c 6970 2877  t = prims.flip(w
+000178c0: 6569 6768 742c 2074 7570 6c65 2872 616e  eight, tuple(ran
+000178d0: 6765 2832 2c20 7765 6967 6874 2e6e 6469  ge(2, weight.ndi
+000178e0: 6d29 2929 0a20 2020 2020 2020 2072 6574  m))).        ret
+000178f0: 7572 6e20 7765 6967 6874 0a0a 2020 2020  urn weight..    
+00017900: 2320 5765 206e 6565 6420 746f 2070 6164  # We need to pad
+00017910: 2074 6865 2067 7261 6469 656e 7420 746f   the gradient to
+00017920: 2062 6520 6162 6c65 2074 6f20 6669 7420   be able to fit 
+00017930: 6b65 726e 656c 2077 696e 646f 7773 2e0a  kernel windows..
+00017940: 2020 2020 696e 6974 6961 6c5f 6772 6164      initial_grad
+00017950: 5f70 6164 6469 6e67 203d 205b 6420 2a20  _padding = [d * 
+00017960: 286b 202d 2031 2920 666f 7220 642c 206b  (k - 1) for d, k
+00017970: 2069 6e20 7a69 7028 6469 6c61 7469 6f6e   in zip(dilation
+00017980: 2c20 6b65 726e 656c 5f64 696d 7329 5d0a  , kernel_dims)].
+00017990: 0a20 2020 2069 6e70 7574 5f67 7261 6420  .    input_grad 
+000179a0: 3d20 636f 6e76 6f6c 7574 696f 6e28 0a20  = convolution(. 
+000179b0: 2020 2020 2020 2070 7269 6d73 2e70 6164         prims.pad
+000179c0: 280a 2020 2020 2020 2020 2020 2020 6772  (.            gr
+000179d0: 6164 2c0a 2020 2020 2020 2020 2020 2020  ad,.            
+000179e0: 302e 302c 0a20 2020 2020 2020 2020 2020  0.0,.           
+000179f0: 2023 2054 6865 2070 6978 6573 2061 7265   # The pixes are
+00017a00: 2073 7472 6964 6520 6177 6179 2066 726f   stride away fro
+00017a10: 6d20 6561 6368 206f 7468 6572 2069 6e20  m each other in 
+00017a20: 7468 6520 6f72 6967 696e 616c 2069 6e70  the original inp
+00017a30: 7574 2e0a 2020 2020 2020 2020 2020 2020  ut..            
+00017a40: 2320 4865 6e63 6520 7765 206e 6565 6420  # Hence we need 
+00017a50: 746f 2064 696c 6174 6520 7468 6520 6772  to dilate the gr
+00017a60: 6164 6965 6e74 2062 7920 6469 6c61 7469  adient by dilati
+00017a70: 6f6e 3d73 7472 6964 6520 2d20 310a 2020  on=stride - 1.  
+00017a80: 2020 2020 2020 2020 2020 2320 736f 2074            # so t
+00017a90: 6861 7420 7468 6572 6520 6172 6520 7374  hat there are st
+00017aa0: 7269 6465 202d 2031 207a 6572 6f73 2062  ride - 1 zeros b
+00017ab0: 6574 7765 656e 2074 6865 2070 6978 656c  etween the pixel
+00017ac0: 732e 0a20 2020 2020 2020 2020 2020 205b  s..            [
+00017ad0: 2830 2c20 302c 2030 292c 2028 302c 2030  (0, 0, 0), (0, 0
+00017ae0: 2c20 3029 5d20 2b20 5b28 302c 2030 2c20  , 0)] + [(0, 0, 
+00017af0: 7320 2d20 3129 2066 6f72 2073 2069 6e20  s - 1) for s in 
+00017b00: 7374 7269 6465 5d2c 0a20 2020 2020 2020  stride],.       
+00017b10: 2029 2c0a 2020 2020 2020 2020 7472 616e   ),.        tran
+00017b20: 7370 6f73 655f 616e 645f 666c 6970 5f77  spose_and_flip_w
+00017b30: 6569 6768 7428 7765 6967 6874 292c 0a20  eight(weight),. 
+00017b40: 2020 2020 2020 204e 6f6e 652c 0a20 2020         None,.   
+00017b50: 2020 2020 2023 2053 6574 7469 6e67 2073       # Setting s
+00017b60: 7472 6964 6520 746f 2031 2061 7320 7468  tride to 1 as th
+00017b70: 6520 6469 7374 616e 6365 2062 6574 7765  e distance betwe
+00017b80: 656e 2070 6978 656c 7320 6973 2074 616b  en pixels is tak
+00017b90: 656e 0a20 2020 2020 2020 2023 2063 6172  en.        # car
+00017ba0: 6520 6279 2074 6865 2070 6164 2072 6967  e by the pad rig
+00017bb0: 6874 2061 626f 7665 2e0a 2020 2020 2020  ht above..      
+00017bc0: 2020 2831 2c29 2c0a 2020 2020 2020 2020    (1,),.        
+00017bd0: 696e 6974 6961 6c5f 6772 6164 5f70 6164  initial_grad_pad
+00017be0: 6469 6e67 2c0a 2020 2020 2020 2020 6469  ding,.        di
+00017bf0: 6c61 7469 6f6e 2c0a 2020 2020 2020 2020  lation,.        
+00017c00: 7472 616e 7370 6f73 6564 2c0a 2020 2020  transposed,.    
+00017c10: 2020 2020 6f75 7470 7574 5f70 6164 6469      output_paddi
+00017c20: 6e67 2c0a 2020 2020 2020 2020 6772 6f75  ng,.        grou
+00017c30: 7073 2c0a 2020 2020 290a 0a20 2020 2064  ps,.    )..    d
+00017c40: 6566 2070 6164 5f74 6f5f 696e 7075 7428  ef pad_to_input(
+00017c50: 6772 6164 293a 0a20 2020 2020 2020 2023  grad):.        #
+00017c60: 2057 6520 6e65 6564 2074 6f20 756e 7061   We need to unpa
+00017c70: 6420 7468 6520 7061 6464 696e 6720 646f  d the padding do
+00017c80: 6e65 2074 6f20 7468 6520 696e 7075 7420  ne to the input 
+00017c90: 7072 696f 7220 746f 2074 6865 2063 6f6e  prior to the con
+00017ca0: 766f 6c75 7469 6f6e 2e0a 2020 2020 2020  volution..      
+00017cb0: 2020 2320 4e6f 7465 2074 6861 7420 6c6f    # Note that lo
+00017cc0: 7720 616e 6420 6869 6768 2070 6164 6469  w and high paddi
+00017cd0: 6e67 2061 7265 206e 6f74 206e 6563 6573  ng are not neces
+00017ce0: 7361 7269 6c79 2065 7175 616c 2c20 736f  sarily equal, so
+00017cf0: 2077 6520 6361 6e6e 6f74 0a20 2020 2020   we cannot.     
+00017d00: 2020 2023 2061 6273 6f72 6220 6974 2069     # absorb it i
+00017d10: 6e74 6f20 7468 6520 636f 6e76 6f6c 7574  nto the convolut
+00017d20: 696f 6e20 6a75 7374 2079 6574 2c20 756e  ion just yet, un
+00017d30: 6c65 7373 2074 6865 2041 5049 2069 7320  less the API is 
+00017d40: 6d6f 6469 6669 6564 2e0a 2020 2020 2020  modified..      
+00017d50: 2020 7061 645f 636f 6e66 6967 203d 205b    pad_config = [
+00017d60: 2830 2c20 302c 2030 292c 2028 302c 2030  (0, 0, 0), (0, 0
+00017d70: 2c20 3029 5d0a 2020 2020 2020 2020 666f  , 0)].        fo
+00017d80: 7220 6f2c 2069 2c20 672c 2070 2069 6e20  r o, i, g, p in 
+00017d90: 7a69 7028 6772 6164 2e73 6861 7065 5b32  zip(grad.shape[2
+00017da0: 3a5d 2c20 7370 6174 6961 6c5f 6469 6d73  :], spatial_dims
+00017db0: 2c20 696e 7075 745f 6772 6164 2e73 6861  , input_grad.sha
+00017dc0: 7065 5b32 3a5d 2c20 7061 6464 696e 6729  pe[2:], padding)
+00017dd0: 3a0a 2020 2020 2020 2020 2020 2020 6c6f  :.            lo
+00017de0: 203d 202d 700a 2020 2020 2020 2020 2020   = -p.          
+00017df0: 2020 2320 4e6f 7465 2074 6861 7420 2869    # Note that (i
+00017e00: 202b 2032 202a 2070 2920 6973 2074 6865   + 2 * p) is the
+00017e10: 2073 697a 6520 6f66 2074 6865 2070 6164   size of the pad
+00017e20: 6465 6420 696e 7075 742c 0a20 2020 2020  ded input,.     
+00017e30: 2020 2020 2020 2023 2073 6f20 7468 6520         # so the 
+00017e40: 7175 616e 7469 7479 2028 6920 2b20 3220  quantity (i + 2 
+00017e50: 2a20 7029 202d 2067 2074 656c 6c73 2075  * p) - g tells u
+00017e60: 7320 6279 2068 6f77 206d 7563 680a 2020  s by how much.  
+00017e70: 2020 2020 2020 2020 2020 2320 7765 206e            # we n
+00017e80: 6565 6420 746f 2070 6164 2074 6865 2067  eed to pad the g
+00017e90: 7261 6469 656e 7420 736f 2074 6861 7420  radient so that 
+00017ea0: 7468 6520 656c 656d 656e 7473 206f 7574  the elements out
+00017eb0: 7369 6465 0a20 2020 2020 2020 2020 2020  side.           
+00017ec0: 2023 206f 6620 7468 6520 636f 6e76 6f6c   # of the convol
+00017ed0: 7574 696f 6e20 7265 6365 6976 6520 7a65  ution receive ze
+00017ee0: 726f 2067 7261 6469 656e 742e 0a20 2020  ro gradient..   
+00017ef0: 2020 2020 2020 2020 2023 2070 2069 7320           # p is 
+00017f00: 6164 6469 7469 6f6e 616c 6c79 2073 7562  additionally sub
+00017f10: 7472 6163 7465 6420 746f 206e 6567 6174  tracted to negat
+00017f20: 6520 7468 6520 696e 7075 7427 7320 7061  e the input's pa
+00017f30: 640a 2020 2020 2020 2020 2020 2020 2320  d.            # 
+00017f40: 696e 2066 6f72 7761 7264 2e0a 2020 2020  in forward..    
+00017f50: 2020 2020 2020 2020 6869 203d 2028 6920          hi = (i 
+00017f60: 2b20 3220 2a20 7029 202d 2067 202d 2070  + 2 * p) - g - p
+00017f70: 0a20 2020 2020 2020 2020 2020 2070 6164  .            pad
+00017f80: 5f63 6f6e 6669 672e 6170 7065 6e64 2828  _config.append((
+00017f90: 6c6f 2c20 6869 2c20 3029 290a 2020 2020  lo, hi, 0)).    
+00017fa0: 2020 2020 7265 7475 726e 2070 7269 6d73      return prims
+00017fb0: 2e70 6164 2867 7261 642c 2030 2e30 2c20  .pad(grad, 0.0, 
+00017fc0: 7061 645f 636f 6e66 6967 290a 0a20 2020  pad_config)..   
+00017fd0: 2069 6e70 7574 5f67 7261 6420 3d20 7061   input_grad = pa
+00017fe0: 645f 746f 5f69 6e70 7574 2869 6e70 7574  d_to_input(input
+00017ff0: 5f67 7261 6429 0a20 2020 2023 207d 0a0a  _grad).    # }..
+00018000: 2020 2020 2320 6269 6173 5f67 7261 6420      # bias_grad 
+00018010: 3d20 7b0a 2020 2020 6966 2062 6961 7320  = {.    if bias 
+00018020: 6973 206e 6f74 204e 6f6e 653a 0a20 2020  is not None:.   
+00018030: 2020 2020 2069 6d70 6f72 7420 7468 756e       import thun
+00018040: 6465 722e 746f 7263 6820 6173 206c 746f  der.torch as lto
+00018050: 7263 680a 0a20 2020 2020 2020 2062 6961  rch..        bia
+00018060: 735f 6772 6164 203d 206c 746f 7263 682e  s_grad = ltorch.
+00018070: 7375 6d28 6772 6164 2c20 5b64 2066 6f72  sum(grad, [d for
+00018080: 2064 2069 6e20 7261 6e67 6528 6772 6164   d in range(grad
+00018090: 2e6e 6469 6d29 2069 6620 6420 213d 2031  .ndim) if d != 1
+000180a0: 5d29 0a20 2020 2023 207d 0a0a 2020 2020  ]).    # }..    
+000180b0: 2320 7765 6967 6874 2067 7261 6420 3d20  # weight grad = 
+000180c0: 7b0a 2020 2020 6465 6620 7061 645f 7472  {.    def pad_tr
+000180d0: 616e 7370 6f73 655f 616e 645f 7075 7368  anspose_and_push
+000180e0: 5f67 726f 7570 735f 696e 746f 5f62 6174  _groups_into_bat
+000180f0: 6368 6573 2874 293a 0a20 2020 2020 2020  ches(t):.       
+00018100: 2023 2046 6972 7374 2070 6164 2c2e 2e2e   # First pad,...
+00018110: 0a20 2020 2020 2020 2023 2050 6164 2061  .        # Pad a
+00018120: 7320 6e65 6365 7373 6172 7920 736f 2074  s necessary so t
+00018130: 6861 7420 696e 2063 6f6e 766f 6c75 7469  hat in convoluti
+00018140: 6f6e 7320 7765 206e 6576 6572 2061 6476  ons we never adv
+00018150: 616e 6365 0a20 2020 2020 2020 2023 2070  ance.        # p
+00018160: 6173 7420 7265 6c65 7661 6e74 2069 6e70  ast relevant inp
+00018170: 7574 732e 0a20 2020 2020 2020 2070 6164  uts..        pad
+00018180: 5f63 6f6e 6669 6720 3d20 5b28 302c 2030  _config = [(0, 0
+00018190: 2c20 3029 2c20 2830 2c20 302c 2030 295d  , 0), (0, 0, 0)]
+000181a0: 0a20 2020 2020 2020 2066 6f72 206f 2c20  .        for o, 
+000181b0: 692c 206b 2c20 702c 2073 2c20 6420 696e  i, k, p, s, d in
+000181c0: 207a 6970 2867 7261 642e 7368 6170 655b   zip(grad.shape[
+000181d0: 323a 5d2c 2073 7061 7469 616c 5f64 696d  2:], spatial_dim
+000181e0: 732c 206b 6572 6e65 6c5f 6469 6d73 2c20  s, kernel_dims, 
+000181f0: 7061 6464 696e 672c 2073 7472 6964 652c  padding, stride,
+00018200: 2064 696c 6174 696f 6e29 3a0a 2020 2020   dilation):.    
+00018210: 2020 2020 2020 2020 2320 5061 6464 696e          # Paddin
+00018220: 6720 6672 6f6d 2062 656c 6f77 2069 7320  g from below is 
+00018230: 7468 6520 7361 6d65 2e0a 2020 2020 2020  the same..      
+00018240: 2020 2020 2020 6c6f 203d 2070 0a20 2020        lo = p.   
+00018250: 2020 2020 2020 2020 2023 2054 6865 7265           # There
+00018260: 2069 7320 616c 7761 7973 2074 6865 206d   is always the m
+00018270: 6178 2069 6e64 6578 2069 6478 2069 6e20  ax index idx in 
+00018280: 7468 6520 696e 7075 740a 2020 2020 2020  the input.      
+00018290: 2020 2020 2020 2320 7468 6520 7661 6c75        # the valu
+000182a0: 6520 6f66 2077 6869 6368 2c20 696e 7075  e of which, inpu
+000182b0: 745b 6964 785d 2c20 7468 6520 6b65 726e  t[idx], the kern
+000182c0: 656c 2074 6f75 6368 6573 2e0a 2020 2020  el touches..    
+000182d0: 2020 2020 2020 2020 2320 5468 6520 6b65          # The ke
+000182e0: 726e 656c 2072 6561 6368 2c20 6f72 206b  rnel reach, or k
+000182f0: 5f72 6561 6368 2c20 6973 2065 7861 6374  _reach, is exact
+00018300: 6c79 2069 6478 202b 2031 2e0a 2020 2020  ly idx + 1..    
+00018310: 2020 2020 2020 2020 2320 5765 2075 7365          # We use
+00018320: 2069 7420 746f 2064 6563 6964 6520 6279   it to decide by
+00018330: 2068 6f77 206d 7563 6820 7765 206e 6565   how much we nee
+00018340: 6420 746f 2070 6164 2066 726f 6d20 6162  d to pad from ab
+00018350: 6f76 650a 2020 2020 2020 2020 2020 2020  ove.            
+00018360: 2320 6173 2074 6f20 6e6f 7420 6d6f 7665  # as to not move
+00018370: 2070 6173 7420 7265 6c65 7661 6e74 2076   past relevant v
+00018380: 616c 7565 732e 0a20 2020 2020 2020 2020  alues..         
+00018390: 2020 206b 5f72 6561 6368 203d 2028 6f20     k_reach = (o 
+000183a0: 2d20 3129 202a 2073 202b 2064 202a 2028  - 1) * s + d * (
+000183b0: 6b20 2d20 3129 202b 2031 0a20 2020 2020  k - 1) + 1.     
+000183c0: 2020 2020 2020 2023 2054 6865 2070 6164         # The pad
+000183d0: 2066 726f 6d20 6162 6f76 6520 6571 7561   from above equa
+000183e0: 6c73 206b 5f72 6561 6368 206d 696e 7573  ls k_reach minus
+000183f0: 2074 6865 206c 656e 6774 680a 2020 2020   the length.    
+00018400: 2020 2020 2020 2020 2320 6f66 2074 6865          # of the
+00018410: 2069 6e70 7574 2070 6164 6465 6420 6672   input padded fr
+00018420: 6f6d 2062 656c 6f77 2e0a 2020 2020 2020  om below..      
+00018430: 2020 2020 2020 6869 203d 206b 5f72 6561        hi = k_rea
+00018440: 6368 202d 2028 6920 2b20 7029 0a20 2020  ch - (i + p).   
+00018450: 2020 2020 2020 2020 2070 6164 5f63 6f6e           pad_con
+00018460: 6669 672e 6170 7065 6e64 2828 6c6f 2c20  fig.append((lo, 
+00018470: 6869 2c20 3029 290a 2020 2020 2020 2020  hi, 0)).        
+00018480: 7420 3d20 7072 696d 732e 7061 6428 742c  t = prims.pad(t,
+00018490: 2030 2e30 2c20 7061 645f 636f 6e66 6967   0.0, pad_config
+000184a0: 290a 0a20 2020 2020 2020 205f 2c20 5f2c  )..        _, _,
+000184b0: 202a 745f 7370 6174 6961 6c5f 6469 6d73   *t_spatial_dims
+000184c0: 203d 2074 2e73 6861 7065 0a0a 2020 2020   = t.shape..    
+000184d0: 2020 2020 2320 2e2e 2e20 7468 656e 2064      # ... then d
+000184e0: 6f20 7468 6520 7265 7374 2e0a 2020 2020  o the rest..    
+000184f0: 2020 2020 2320 742e 7368 6170 6520 3d3d      # t.shape ==
+00018500: 2028 6261 7463 682c 2069 6e5f 6368 616e   (batch, in_chan
+00018510: 6e65 6c73 2c20 2e2e 2e29 0a20 2020 2020  nels, ...).     
+00018520: 2020 2023 2054 6865 2072 6573 756c 7420     # The result 
+00018530: 6f66 2074 6869 7320 6675 6e63 7469 6f6e  of this function
+00018540: 2068 6173 2073 6861 7065 0a20 2020 2020   has shape.     
+00018550: 2020 2023 2028 696e 5f63 6861 6e6e 656c     # (in_channel
+00018560: 732c 2062 6174 6368 202a 2067 726f 7570  s, batch * group
+00018570: 7329 0a20 2020 2020 2020 2023 2028 6261  s).        # (ba
+00018580: 7463 682c 2069 6e5f 6368 616e 6e65 6c73  tch, in_channels
+00018590: 2920 2d3e 2028 696e 5f63 6861 6e6e 656c  ) -> (in_channel
+000185a0: 732c 2062 6174 6368 290a 2020 2020 2020  s, batch).      
+000185b0: 2020 7420 3d20 636f 6e76 5f74 7261 6e73    t = conv_trans
+000185c0: 706f 7365 2874 290a 2020 2020 2020 2020  pose(t).        
+000185d0: 2320 5370 6c69 7420 2869 6e5f 6368 616e  # Split (in_chan
+000185e0: 6e65 6c73 2c29 202d 3e20 2867 726f 7570  nels,) -> (group
+000185f0: 732c 2067 696e 5f63 6861 6e6e 656c 7329  s, gin_channels)
+00018600: 0a20 2020 2020 2020 2074 203d 2074 2e72  .        t = t.r
+00018610: 6573 6861 7065 285b 6772 6f75 7073 2c20  eshape([groups, 
+00018620: 6769 6e5f 6368 616e 6e65 6c73 2c20 6261  gin_channels, ba
+00018630: 7463 685d 202b 2074 5f73 7061 7469 616c  tch] + t_spatial
+00018640: 5f64 696d 7329 0a20 2020 2020 2020 2023  _dims).        #
+00018650: 2054 7261 6e73 706f 7365 2028 6772 6f75   Transpose (grou
+00018660: 7073 2c20 6769 6e5f 6368 616e 6e65 6c73  ps, gin_channels
+00018670: 2c20 6261 7463 6829 202d 3e20 2867 696e  , batch) -> (gin
+00018680: 5f63 6861 6e6e 656c 732c 2067 726f 7570  _channels, group
+00018690: 732c 2062 6174 6368 290a 2020 2020 2020  s, batch).      
+000186a0: 2020 7420 3d20 636f 6e76 5f74 7261 6e73    t = conv_trans
+000186b0: 706f 7365 2874 290a 2020 2020 2020 2020  pose(t).        
+000186c0: 2320 466c 6174 7465 6e20 2867 726f 7570  # Flatten (group
+000186d0: 732c 2062 6174 6368 2920 2d3e 2028 6772  s, batch) -> (gr
+000186e0: 6f75 7073 202a 2062 6174 6368 2c29 0a20  oups * batch,). 
+000186f0: 2020 2020 2020 2074 203d 2074 2e72 6573         t = t.res
+00018700: 6861 7065 285b 6769 6e5f 6368 616e 6e65  hape([gin_channe
+00018710: 6c73 2c20 6772 6f75 7073 202a 2062 6174  ls, groups * bat
+00018720: 6368 5d20 2b20 745f 7370 6174 6961 6c5f  ch] + t_spatial_
+00018730: 6469 6d73 290a 2020 2020 2020 2020 7265  dims).        re
+00018740: 7475 726e 2074 0a0a 2020 2020 2320 696e  turn t..    # in
+00018750: 7075 7420 7769 6c6c 2068 6176 6520 7368  put will have sh
+00018760: 6170 6520 2867 696e 5f63 6861 6e6e 656c  ape (gin_channel
+00018770: 732c 2067 726f 7570 7320 2a20 6261 7463  s, groups * batc
+00018780: 6829 0a20 2020 2069 6e70 7574 203d 2070  h).    input = p
+00018790: 6164 5f74 7261 6e73 706f 7365 5f61 6e64  ad_transpose_and
+000187a0: 5f70 7573 685f 6772 6f75 7073 5f69 6e74  _push_groups_int
+000187b0: 6f5f 6261 7463 6865 7328 696e 7075 7429  o_batches(input)
+000187c0: 0a20 2020 2023 2067 7261 6420 7769 6c6c  .    # grad will
+000187d0: 2068 6176 6520 7368 6170 6520 286f 7574   have shape (out
+000187e0: 5f63 6861 6e6e 656c 732c 2062 6174 6368  _channels, batch
+000187f0: 290a 2020 2020 2320 4e6f 7465 2074 6861  ).    # Note tha
+00018800: 7420 7468 6573 6520 7368 6170 6573 2061  t these shapes a
+00018810: 7265 2063 6f6d 7061 7469 626c 6520 666f  re compatible fo
+00018820: 7220 6120 6772 6f75 7020 636f 6e76 6f6c  r a group convol
+00018830: 7574 696f 6e2e 0a20 2020 2067 7261 6420  ution..    grad 
+00018840: 3d20 636f 6e76 5f74 7261 6e73 706f 7365  = conv_transpose
+00018850: 2867 7261 6429 0a0a 2020 2020 2320 5768  (grad)..    # Wh
+00018860: 7920 646f 2077 6520 666c 6970 2073 7472  y do we flip str
+00018870: 6964 6520 616e 6420 6469 6c61 7469 6f6e  ide and dilation
+00018880: 3f0a 2020 2020 2320 6b65 726e 656c 5b69  ?.    # kernel[i
+00018890: 5d20 616e 6420 6b65 726e 656c 5b69 202b  ] and kernel[i +
+000188a0: 2031 5d20 6172 6520 6469 6c61 7469 6f6e   1] are dilation
+000188b0: 2061 7061 7274 2066 726f 6d20 6561 6368   apart from each
+000188c0: 206f 7468 6572 2c0a 2020 2020 2320 736f   other,.    # so
+000188d0: 2064 696c 6174 696f 6e20 6265 636f 6d65   dilation become
+000188e0: 7320 7468 6520 6e65 7720 7374 7269 6465  s the new stride
+000188f0: 2e0a 2020 2020 2320 416c 6c20 7468 6520  ..    # All the 
+00018900: 656c 656d 656e 7473 2074 6861 7420 6b65  elements that ke
+00018910: 726e 656c 5b69 5d20 746f 7563 6865 7320  rnel[i] touches 
+00018920: 6172 6520 7374 7269 6465 2061 7761 7920  are stride away 
+00018930: 6672 6f6d 2065 6163 6820 6f74 6865 722c  from each other,
+00018940: 0a20 2020 2023 2068 656e 6365 2073 7472  .    # hence str
+00018950: 6964 6520 6265 636f 6d65 7320 7468 6520  ide becomes the 
+00018960: 6e65 7720 6469 6c61 7469 6f6e 2e0a 2020  new dilation..  
+00018970: 2020 7765 6967 6874 5f67 7261 6420 3d20    weight_grad = 
+00018980: 636f 6e76 6f6c 7574 696f 6e28 0a20 2020  convolution(.   
+00018990: 2020 2020 2069 6e70 7574 2c0a 2020 2020       input,.    
+000189a0: 2020 2020 6772 6164 2c0a 2020 2020 2020      grad,.      
+000189b0: 2020 4e6f 6e65 2c0a 2020 2020 2020 2020    None,.        
+000189c0: 6469 6c61 7469 6f6e 2c20 2023 2073 6574  dilation,  # set
+000189d0: 2073 7472 6964 653d 6469 6c61 7469 6f6e   stride=dilation
+000189e0: 0a20 2020 2020 2020 2028 302c 292c 0a20  .        (0,),. 
+000189f0: 2020 2020 2020 2073 7472 6964 652c 2020         stride,  
+00018a00: 2320 7365 7420 6469 6c61 7469 6f6e 3d73  # set dilation=s
+00018a10: 7472 6964 650a 2020 2020 2020 2020 7472  tride.        tr
+00018a20: 616e 7370 6f73 6564 2c0a 2020 2020 2020  ansposed,.      
+00018a30: 2020 6f75 7470 7574 5f70 6164 6469 6e67    output_padding
+00018a40: 2c0a 2020 2020 2020 2020 6772 6f75 7073  ,.        groups
+00018a50: 2c0a 2020 2020 290a 0a20 2020 2023 2054  ,.    )..    # T
+00018a60: 6865 2072 6573 756c 7420 6f66 2074 6865  he result of the
+00018a70: 2063 6f6e 766f 6c75 7469 6f6e 2068 6173   convolution has
+00018a80: 2073 6861 7065 2028 6769 6e5f 6368 616e   shape (gin_chan
+00018a90: 6e65 6c73 2c20 6f75 745f 6368 616e 6e65  nels, out_channe
+00018aa0: 6c73 292c 0a20 2020 2023 2073 6f20 7472  ls),.    # so tr
+00018ab0: 616e 7370 6f73 6974 696f 6e20 6973 2072  ansposition is r
+00018ac0: 6571 7569 7265 642e 0a20 2020 2077 6569  equired..    wei
+00018ad0: 6768 745f 6772 6164 203d 2063 6f6e 765f  ght_grad = conv_
+00018ae0: 7472 616e 7370 6f73 6528 7765 6967 6874  transpose(weight
+00018af0: 5f67 7261 6429 0a20 2020 2023 207d 0a0a  _grad).    # }..
+00018b00: 2020 2020 7265 7475 726e 2028 696e 7075      return (inpu
+00018b10: 745f 6772 6164 2c20 7765 6967 6874 5f67  t_grad, weight_g
+00018b20: 7261 642c 2062 6961 735f 6772 6164 290a  rad, bias_grad).
+00018b30: 0a0a 4072 6567 6973 7465 725f 6175 676d  ..@register_augm
+00018b40: 656e 7465 645f 666f 7277 6172 6428 2274  ented_forward("t
+00018b50: 6f72 6368 2e6c 6f67 5f73 6f66 746d 6178  orch.log_softmax
+00018b60: 2229 0a64 6566 206c 6f67 5f73 6f66 746d  ").def log_softm
+00018b70: 6178 5f61 7567 5f66 7764 2869 6e70 7574  ax_aug_fwd(input
+00018b80: 3a20 5465 6e73 6f72 5072 6f78 792c 2064  : TensorProxy, d
+00018b90: 696d 3a20 696e 742c 202a 2c20 6474 7970  im: int, *, dtyp
+00018ba0: 653d 4e6f 6e65 2920 2d3e 2056 4a50 4475  e=None) -> VJPDu
+00018bb0: 616c 3a0a 2020 2020 6672 6f6d 2074 6875  al:.    from thu
+00018bc0: 6e64 6572 2e74 6f72 6368 2069 6d70 6f72  nder.torch impor
+00018bd0: 7420 6c6f 675f 736f 6674 6d61 780a 0a20  t log_softmax.. 
+00018be0: 2020 2070 7269 6d61 6c20 3d20 6c6f 675f     primal = log_
+00018bf0: 736f 6674 6d61 7828 696e 7075 742c 2064  softmax(input, d
+00018c00: 696d 3d64 696d 2c20 6474 7970 653d 6474  im=dim, dtype=dt
+00018c10: 7970 6529 0a20 2020 2072 6573 6964 7561  ype).    residua
+00018c20: 6c73 203d 2028 7072 696d 616c 2c20 6469  ls = (primal, di
+00018c30: 6d2c 2069 6e70 7574 2e64 7479 7065 290a  m, input.dtype).
+00018c40: 2020 2020 7265 7475 726e 2056 4a50 4475      return VJPDu
+00018c50: 616c 2870 7269 6d61 6c2c 2072 6573 6964  al(primal, resid
+00018c60: 7561 6c73 290a 0a0a 4072 6567 6973 7465  uals)...@registe
+00018c70: 725f 6261 636b 7761 7264 2822 746f 7263  r_backward("torc
+00018c80: 682e 6c6f 675f 736f 6674 6d61 7822 290a  h.log_softmax").
+00018c90: 6465 6620 6c6f 675f 736f 6674 6d61 785f  def log_softmax_
+00018ca0: 6261 636b 7761 7264 2870 7269 6d61 6c2c  backward(primal,
+00018cb0: 2064 696d 2c20 6474 7970 652c 2067 293a   dim, dtype, g):
+00018cc0: 0a20 2020 2066 726f 6d20 7468 756e 6465  .    from thunde
+00018cd0: 722e 746f 7263 6820 696d 706f 7274 206c  r.torch import l
+00018ce0: 6f67 5f73 6f66 746d 6178 5f62 6163 6b77  og_softmax_backw
+00018cf0: 6172 640a 0a20 2020 2072 6574 7572 6e20  ard..    return 
+00018d00: 6c6f 675f 736f 6674 6d61 785f 6261 636b  log_softmax_back
+00018d10: 7761 7264 2867 2c20 7072 696d 616c 2c20  ward(g, primal, 
+00018d20: 6469 6d2c 2064 7479 7065 290a 0a0a 4072  dim, dtype)...@r
+00018d30: 6567 6973 7465 725f 6175 676d 656e 7465  egister_augmente
+00018d40: 645f 666f 7277 6172 6428 2274 6f72 6368  d_forward("torch
+00018d50: 2e6e 6e2e 6675 6e63 7469 6f6e 616c 2e6e  .nn.functional.n
+00018d60: 6c6c 5f6c 6f73 7322 290a 6465 6620 6e6c  ll_loss").def nl
+00018d70: 6c5f 6c6f 7373 5f61 7567 5f66 7764 280a  l_loss_aug_fwd(.
+00018d80: 2020 2020 696e 7075 743a 2050 726f 7879      input: Proxy
+00018d90: 2c0a 2020 2020 7461 7267 6574 3a20 5072  ,.    target: Pr
+00018da0: 6f78 792c 0a20 2020 2077 6569 6768 743a  oxy,.    weight:
+00018db0: 204e 6f6e 6520 7c20 5072 6f78 792c 0a20   None | Proxy,. 
+00018dc0: 2020 2069 676e 6f72 655f 696e 6465 783a     ignore_index:
+00018dd0: 2069 6e74 2c0a 2020 2020 7265 6475 6374   int,.    reduct
+00018de0: 696f 6e3a 2073 7472 2c0a 2920 2d3e 2056  ion: str,.) -> V
+00018df0: 4a50 4475 616c 3a0a 2020 2020 6672 6f6d  JPDual:.    from
+00018e00: 2074 6875 6e64 6572 2e74 6f72 6368 2069   thunder.torch i
+00018e10: 6d70 6f72 7420 5f6e 6c6c 5f6c 6f73 735f  mport _nll_loss_
+00018e20: 6865 6c70 6572 0a0a 2020 2020 7072 696d  helper..    prim
+00018e30: 616c 2c20 746f 7461 6c5f 7765 6967 6874  al, total_weight
+00018e40: 203d 205f 6e6c 6c5f 6c6f 7373 5f68 656c   = _nll_loss_hel
+00018e50: 7065 7228 0a20 2020 2020 2020 2069 6e70  per(.        inp
+00018e60: 7574 2c0a 2020 2020 2020 2020 7461 7267  ut,.        targ
+00018e70: 6574 2c0a 2020 2020 2020 2020 7765 6967  et,.        weig
+00018e80: 6874 2c0a 2020 2020 2020 2020 6967 6e6f  ht,.        igno
+00018e90: 7265 5f69 6e64 6578 2c0a 2020 2020 2020  re_index,.      
+00018ea0: 2020 7265 6475 6374 696f 6e2c 0a20 2020    reduction,.   
+00018eb0: 2029 0a20 2020 2072 6573 6964 7561 6c73   ).    residuals
+00018ec0: 203d 2028 696e 7075 742c 2074 6172 6765   = (input, targe
+00018ed0: 742c 2077 6569 6768 742c 2072 6564 7563  t, weight, reduc
+00018ee0: 7469 6f6e 2c20 6967 6e6f 7265 5f69 6e64  tion, ignore_ind
+00018ef0: 6578 2c20 746f 7461 6c5f 7765 6967 6874  ex, total_weight
+00018f00: 290a 2020 2020 7265 7475 726e 2056 4a50  ).    return VJP
+00018f10: 4475 616c 2870 7269 6d61 6c2c 2072 6573  Dual(primal, res
+00018f20: 6964 7561 6c73 290a 0a0a 4072 6567 6973  iduals)...@regis
+00018f30: 7465 725f 6261 636b 7761 7264 2822 746f  ter_backward("to
+00018f40: 7263 682e 6e6e 2e66 756e 6374 696f 6e61  rch.nn.functiona
+00018f50: 6c2e 6e6c 6c5f 6c6f 7373 2229 0a64 6566  l.nll_loss").def
+00018f60: 206e 6c6c 5f6c 6f73 735f 6261 636b 7761   nll_loss_backwa
+00018f70: 7264 2869 6e70 7574 2c20 7461 7267 6574  rd(input, target
+00018f80: 2c20 7765 6967 6874 2c20 7265 6475 6374  , weight, reduct
+00018f90: 696f 6e2c 2069 676e 6f72 655f 696e 6465  ion, ignore_inde
+00018fa0: 782c 2074 6f74 616c 5f77 6569 6768 742c  x, total_weight,
+00018fb0: 2067 293a 0a20 2020 2066 726f 6d20 7468   g):.    from th
+00018fc0: 756e 6465 722e 746f 7263 6820 696d 706f  under.torch impo
+00018fd0: 7274 206e 6c6c 5f6c 6f73 735f 6261 636b  rt nll_loss_back
+00018fe0: 7761 7264 0a0a 2020 2020 6769 6e70 7574  ward..    ginput
+00018ff0: 203d 206e 6c6c 5f6c 6f73 735f 6261 636b   = nll_loss_back
+00019000: 7761 7264 2867 2c20 696e 7075 742c 2074  ward(g, input, t
+00019010: 6172 6765 742c 2077 6569 6768 742c 2072  arget, weight, r
+00019020: 6564 7563 7469 6f6e 2c20 6967 6e6f 7265  eduction, ignore
+00019030: 5f69 6e64 6578 2c20 746f 7461 6c5f 7765  _index, total_we
+00019040: 6967 6874 290a 2020 2020 7265 7475 726e  ight).    return
+00019050: 2067 696e 7075 742c 202a 2828 4e6f 6e65   ginput, *((None
+00019060: 2c29 202a 2034 290a 0a0a 4072 6567 6973  ,) * 4)...@regis
+00019070: 7465 725f 6175 676d 656e 7465 645f 666f  ter_augmented_fo
+00019080: 7277 6172 6428 2274 6f72 6368 2e73 706c  rward("torch.spl
+00019090: 6974 2229 0a64 6566 2073 706c 6974 5f61  it").def split_a
+000190a0: 7567 5f66 7764 2861 3a20 5465 6e73 6f72  ug_fwd(a: Tensor
+000190b0: 5072 6f78 792c 2073 706c 6974 5f73 697a  Proxy, split_siz
+000190c0: 655f 6f72 5f73 6563 7469 6f6e 733a 2069  e_or_sections: i
+000190d0: 6e74 207c 2053 6571 7565 6e63 655b 696e  nt | Sequence[in
+000190e0: 745d 2c20 6469 6d3a 2069 6e74 203d 2030  t], dim: int = 0
+000190f0: 2920 2d3e 2056 4a50 4475 616c 3a0a 2020  ) -> VJPDual:.  
+00019100: 2020 6672 6f6d 2074 6875 6e64 6572 2e74    from thunder.t
+00019110: 6f72 6368 2069 6d70 6f72 7420 7370 6c69  orch import spli
+00019120: 740a 0a20 2020 2070 7269 6d61 6c20 3d20  t..    primal = 
+00019130: 7370 6c69 7428 612c 2073 706c 6974 5f73  split(a, split_s
+00019140: 697a 655f 6f72 5f73 6563 7469 6f6e 732c  ize_or_sections,
+00019150: 2064 696d 290a 2020 2020 7265 7369 6475   dim).    residu
+00019160: 616c 7320 3d20 2864 696d 2c29 0a20 2020  als = (dim,).   
+00019170: 2072 6574 7572 6e20 564a 5044 7561 6c28   return VJPDual(
+00019180: 7072 696d 616c 2c20 7265 7369 6475 616c  primal, residual
+00019190: 7329 0a0a 0a40 7265 6769 7374 6572 5f62  s)...@register_b
+000191a0: 6163 6b77 6172 6428 2274 6f72 6368 2e73  ackward("torch.s
+000191b0: 706c 6974 2229 0a64 6566 2073 706c 6974  plit").def split
+000191c0: 5f62 6163 6b77 6172 6428 6469 6d2c 202a  _backward(dim, *
+000191d0: 6772 6164 7329 3a0a 2020 2020 6672 6f6d  grads):.    from
+000191e0: 2074 6875 6e64 6572 2e74 6f72 6368 2069   thunder.torch i
+000191f0: 6d70 6f72 7420 6361 740a 0a20 2020 2072  mport cat..    r
+00019200: 6574 7572 6e20 6361 7428 6772 6164 732c  eturn cat(grads,
+00019210: 2064 696d 290a 0a0a 4072 6567 6973 7465   dim)...@registe
+00019220: 725f 6175 676d 656e 7465 645f 666f 7277  r_augmented_forw
+00019230: 6172 6428 2274 6f72 6368 2e6e 6e2e 6675  ard("torch.nn.fu
+00019240: 6e63 7469 6f6e 616c 2e65 6d62 6564 6469  nctional.embeddi
+00019250: 6e67 2229 0a64 6566 2065 6d62 6564 6469  ng").def embeddi
+00019260: 6e67 5f61 7567 5f66 7764 280a 2020 2020  ng_aug_fwd(.    
+00019270: 613a 2050 726f 7879 2c0a 2020 2020 7765  a: Proxy,.    we
+00019280: 6967 6874 3a20 5072 6f78 792c 0a20 2020  ight: Proxy,.   
+00019290: 2070 6164 6469 6e67 5f69 6478 3a20 696e   padding_idx: in
+000192a0: 7420 7c20 4e6f 6e65 2c0a 2020 2020 6d61  t | None,.    ma
+000192b0: 785f 6e6f 726d 3a20 666c 6f61 7420 7c20  x_norm: float | 
+000192c0: 4e6f 6e65 2c0a 2020 2020 6e6f 726d 5f74  None,.    norm_t
+000192d0: 7970 653a 2066 6c6f 6174 2c0a 2020 2020  ype: float,.    
+000192e0: 7363 616c 655f 6772 6164 5f62 795f 6672  scale_grad_by_fr
+000192f0: 6571 3a20 626f 6f6c 2c0a 2020 2020 7370  eq: bool,.    sp
+00019300: 6172 7365 3a20 626f 6f6c 2c0a 2920 2d3e  arse: bool,.) ->
+00019310: 2056 4a50 4475 616c 3a0a 2020 2020 6672   VJPDual:.    fr
+00019320: 6f6d 2074 6875 6e64 6572 2e74 6f72 6368  om thunder.torch
+00019330: 2069 6d70 6f72 7420 656d 6265 6464 696e   import embeddin
+00019340: 670a 0a20 2020 2070 7269 6d61 6c20 3d20  g..    primal = 
+00019350: 656d 6265 6464 696e 6728 0a20 2020 2020  embedding(.     
+00019360: 2020 2061 2c0a 2020 2020 2020 2020 7765     a,.        we
+00019370: 6967 6874 2c0a 2020 2020 2020 2020 7061  ight,.        pa
+00019380: 6464 696e 675f 6964 783d 7061 6464 696e  dding_idx=paddin
+00019390: 675f 6964 782c 0a20 2020 2020 2020 206d  g_idx,.        m
+000193a0: 6178 5f6e 6f72 6d3d 6d61 785f 6e6f 726d  ax_norm=max_norm
+000193b0: 2c0a 2020 2020 2020 2020 6e6f 726d 5f74  ,.        norm_t
+000193c0: 7970 653d 6e6f 726d 5f74 7970 652c 0a20  ype=norm_type,. 
+000193d0: 2020 2020 2020 2073 6361 6c65 5f67 7261         scale_gra
+000193e0: 645f 6279 5f66 7265 713d 7363 616c 655f  d_by_freq=scale_
+000193f0: 6772 6164 5f62 795f 6672 6571 2c0a 2020  grad_by_freq,.  
+00019400: 2020 2020 2020 7370 6172 7365 3d73 7061        sparse=spa
+00019410: 7273 652c 0a20 2020 2029 0a20 2020 2072  rse,.    ).    r
+00019420: 6573 6964 7561 6c73 203d 2028 612c 2077  esiduals = (a, w
+00019430: 6569 6768 742e 7368 6170 655b 305d 2c20  eight.shape[0], 
+00019440: 7061 6464 696e 675f 6964 782c 2073 6361  padding_idx, sca
+00019450: 6c65 5f67 7261 645f 6279 5f66 7265 712c  le_grad_by_freq,
+00019460: 2073 7061 7273 6529 0a20 2020 2072 6574   sparse).    ret
+00019470: 7572 6e20 564a 5044 7561 6c28 7072 696d  urn VJPDual(prim
+00019480: 616c 2c20 7265 7369 6475 616c 7329 0a0a  al, residuals)..
+00019490: 0a40 7265 6769 7374 6572 5f62 6163 6b77  .@register_backw
+000194a0: 6172 6428 2274 6f72 6368 2e6e 6e2e 6675  ard("torch.nn.fu
+000194b0: 6e63 7469 6f6e 616c 2e65 6d62 6564 6469  nctional.embeddi
+000194c0: 6e67 2229 0a64 6566 2065 6d62 6564 6469  ng").def embeddi
+000194d0: 6e67 5f62 6163 6b77 6172 6428 612c 206e  ng_backward(a, n
+000194e0: 756d 5f77 6569 6768 7473 2c20 7061 6464  um_weights, padd
+000194f0: 696e 675f 6964 782c 2073 6361 6c65 5f67  ing_idx, scale_g
+00019500: 7261 645f 6279 5f66 7265 712c 2073 7061  rad_by_freq, spa
+00019510: 7273 652c 2067 293a 0a20 2020 2066 726f  rse, g):.    fro
+00019520: 6d20 7468 756e 6465 722e 746f 7263 6820  m thunder.torch 
+00019530: 696d 706f 7274 2065 6d62 6564 6469 6e67  import embedding
+00019540: 5f62 6163 6b77 6172 640a 0a20 2020 2070  _backward..    p
+00019550: 6164 6469 6e67 5f69 6478 203d 202d 3120  adding_idx = -1 
+00019560: 6966 2070 6164 6469 6e67 5f69 6478 2069  if padding_idx i
+00019570: 7320 4e6f 6e65 2065 6c73 6520 7061 6464  s None else padd
+00019580: 696e 675f 6964 780a 2020 2020 6777 6569  ing_idx.    gwei
+00019590: 6768 7420 3d20 656d 6265 6464 696e 675f  ght = embedding_
+000195a0: 6261 636b 7761 7264 2867 2c20 612c 206e  backward(g, a, n
+000195b0: 756d 5f77 6569 6768 7473 2c20 7061 6464  um_weights, padd
+000195c0: 696e 675f 6964 782c 2073 6361 6c65 5f67  ing_idx, scale_g
+000195d0: 7261 645f 6279 5f66 7265 712c 2073 7061  rad_by_freq, spa
+000195e0: 7273 6529 0a20 2020 2072 6574 7572 6e20  rse).    return 
+000195f0: 6777 6569 6768 740a 0a0a 4072 6567 6973  gweight...@regis
+00019600: 7465 725f 6175 676d 656e 7465 645f 666f  ter_augmented_fo
+00019610: 7277 6172 6428 2274 6f72 6368 2e63 756d  rward("torch.cum
+00019620: 7375 6d22 290a 6465 6620 6375 6d73 756d  sum").def cumsum
+00019630: 5f61 7567 5f66 7764 2861 3a20 5072 6f78  _aug_fwd(a: Prox
+00019640: 792c 2064 696d 3a20 696e 742c 202a 2c20  y, dim: int, *, 
+00019650: 6474 7970 653a 204e 6f6e 6520 7c20 6474  dtype: None | dt
+00019660: 7970 6573 2e64 7479 7065 203d 204e 6f6e  ypes.dtype = Non
+00019670: 6529 202d 3e20 564a 5044 7561 6c3a 0a20  e) -> VJPDual:. 
+00019680: 2020 2066 726f 6d20 7468 756e 6465 722e     from thunder.
+00019690: 746f 7263 6820 696d 706f 7274 2063 756d  torch import cum
+000196a0: 7375 6d0a 0a20 2020 2070 7269 6d61 6c20  sum..    primal 
+000196b0: 3d20 6375 6d73 756d 2861 2c20 6469 6d2c  = cumsum(a, dim,
+000196c0: 2064 7479 7065 3d64 7479 7065 290a 2020   dtype=dtype).  
+000196d0: 2020 7265 7369 6475 616c 7320 3d20 280a    residuals = (.
+000196e0: 2020 2020 2020 2020 612e 6474 7970 652c          a.dtype,
+000196f0: 0a20 2020 2020 2020 2064 696d 2c0a 2020  .        dim,.  
+00019700: 2020 290a 2020 2020 7265 7475 726e 2056    ).    return V
+00019710: 4a50 4475 616c 2870 7269 6d61 6c2c 2072  JPDual(primal, r
+00019720: 6573 6964 7561 6c73 290a 0a0a 4072 6567  esiduals)...@reg
+00019730: 6973 7465 725f 6261 636b 7761 7264 2822  ister_backward("
+00019740: 746f 7263 682e 6375 6d73 756d 2229 0a64  torch.cumsum").d
+00019750: 6566 2063 756d 7375 6d5f 6261 636b 7761  ef cumsum_backwa
+00019760: 7264 2861 5f64 7479 7065 2c20 6469 6d2c  rd(a_dtype, dim,
+00019770: 2067 293a 0a20 2020 2067 203d 2067 2e74   g):.    g = g.t
+00019780: 6f28 615f 6474 7970 6529 0a20 2020 2069  o(a_dtype).    i
+00019790: 6620 672e 6e75 6d65 6c20 3c3d 2031 206f  f g.numel <= 1 o
+000197a0: 7220 672e 7368 6170 655b 6469 6d5d 203d  r g.shape[dim] =
+000197b0: 3d20 313a 0a20 2020 2020 2020 2072 6574  = 1:.        ret
+000197c0: 7572 6e20 670a 2020 2020 7265 7475 726e  urn g.    return
+000197d0: 2067 2e66 6c69 7028 6469 6d29 2e63 756d   g.flip(dim).cum
+000197e0: 7375 6d28 6469 6d29 2e66 6c69 7028 6469  sum(dim).flip(di
+000197f0: 6d29 0a0a 0a40 7265 6769 7374 6572 5f61  m)...@register_a
+00019800: 7567 6d65 6e74 6564 5f66 6f72 7761 7264  ugmented_forward
+00019810: 2822 746f 7263 682e 736f 6674 6d61 7822  ("torch.softmax"
+00019820: 290a 6465 6620 736f 6674 6d61 785f 6175  ).def softmax_au
+00019830: 675f 6677 6428 613a 2050 726f 7879 2c20  g_fwd(a: Proxy, 
+00019840: 6469 6d3a 2069 6e74 2c20 6474 7970 653a  dim: int, dtype:
+00019850: 2064 7479 7065 732e 6474 7970 6520 7c20   dtypes.dtype | 
+00019860: 4e6f 6e65 203d 204e 6f6e 6529 202d 3e20  None = None) -> 
+00019870: 564a 5044 7561 6c3a 0a20 2020 2066 726f  VJPDual:.    fro
+00019880: 6d20 7468 756e 6465 722e 746f 7263 6820  m thunder.torch 
+00019890: 696d 706f 7274 2073 6f66 746d 6178 0a0a  import softmax..
+000198a0: 2020 2020 7072 696d 616c 203d 2073 6f66      primal = sof
+000198b0: 746d 6178 2861 2c20 6469 6d2c 2064 7479  tmax(a, dim, dty
+000198c0: 7065 3d64 7479 7065 290a 2020 2020 7265  pe=dtype).    re
+000198d0: 7369 6475 616c 7320 3d20 2870 7269 6d61  siduals = (prima
+000198e0: 6c2c 2064 696d 290a 2020 2020 7265 7475  l, dim).    retu
+000198f0: 726e 2056 4a50 4475 616c 2870 7269 6d61  rn VJPDual(prima
+00019900: 6c2c 2072 6573 6964 7561 6c73 290a 0a0a  l, residuals)...
+00019910: 4072 6567 6973 7465 725f 6261 636b 7761  @register_backwa
+00019920: 7264 2822 746f 7263 682e 736f 6674 6d61  rd("torch.softma
+00019930: 7822 290a 6465 6620 736f 6674 6d61 785f  x").def softmax_
+00019940: 6261 636b 7761 7264 2870 7269 6d61 6c2c  backward(primal,
+00019950: 2064 696d 2c20 6729 3a0a 2020 2020 7265   dim, g):.    re
+00019960: 7475 726e 2070 7269 6d61 6c20 2a20 2867  turn primal * (g
+00019970: 202d 2028 7072 696d 616c 202a 2067 292e   - (primal * g).
+00019980: 7375 6d28 6469 6d2c 206b 6565 7064 696d  sum(dim, keepdim
+00019990: 3d54 7275 6529 290a 0a0a 6465 6620 6974  =True))...def it
+000199a0: 6572 5f62 6f75 6e64 5f73 796d 626f 6c73  er_bound_symbols
+000199b0: 2862 6f75 6e64 5f73 796d 626f 6c73 293a  (bound_symbols):
+000199c0: 0a20 2020 2022 2222 4974 6572 6174 6520  .    """Iterate 
+000199d0: 6f76 6572 2062 6f75 6e64 2073 796d 626f  over bound symbo
+000199e0: 6c73 2c20 736b 6970 7069 6e67 2073 796d  ls, skipping sym
+000199f0: 626f 6c73 2074 6861 7420 6172 6520 6e6f  bols that are no
+00019a00: 7420 7375 7070 6f72 7465 6420 6279 0a20  t supported by. 
+00019a10: 2020 2074 6865 2074 7261 6e73 666f 726d     the transform
+00019a20: 7320 696e 6672 6173 7472 7563 7475 7265  s infrastructure
+00019a30: 2e0a 0a20 2020 2041 7267 733a 0a20 2020  ...    Args:.   
+00019a40: 2020 2020 2062 6f75 6e64 5f73 796d 626f       bound_symbo
+00019a50: 6c73 2028 4c69 7374 5b42 6f75 6e64 5379  ls (List[BoundSy
+00019a60: 6d62 6f6c 5d29 3a20 4c69 7374 206f 6620  mbol]): List of 
+00019a70: 626f 756e 6420 7379 6d62 6f6c 730a 0a20  bound symbols.. 
+00019a80: 2020 2059 6965 6c64 733a 0a20 2020 2020     Yields:.     
+00019a90: 2020 2042 6f75 6e64 5379 6d62 6f6c 3a20     BoundSymbol: 
+00019aa0: 426f 756e 6420 7379 6d62 6f6c 7320 7468  Bound symbols th
+00019ab0: 6174 2061 7265 2073 7570 706f 7274 6564  at are supported
+00019ac0: 2062 7920 7468 6520 7472 616e 7366 6f72   by the transfor
+00019ad0: 6d73 0a20 2020 2020 2020 2069 6e66 7261  ms.        infra
+00019ae0: 7374 7275 6374 7572 650a 2020 2020 2222  structure.    ""
+00019af0: 220a 2020 2020 666f 7220 7379 6d62 6f6c  ".    for symbol
+00019b00: 2069 6e20 626f 756e 645f 7379 6d62 6f6c   in bound_symbol
+00019b10: 733a 0a20 2020 2020 2020 2069 6620 7379  s:.        if sy
+00019b20: 6d62 6f6c 2e73 796d 2e69 6420 696e 2074  mbol.sym.id in t
+00019b30: 7261 6e73 666f 726d 5f73 6b69 705f 6c69  ransform_skip_li
+00019b40: 7374 3a0a 2020 2020 2020 2020 2020 2020  st:.            
+00019b50: 636f 6e74 696e 7565 0a20 2020 2020 2020  continue.       
+00019b60: 2065 6c69 6620 7379 6d62 6f6c 2e6f 7574   elif symbol.out
+00019b70: 7075 7420 6973 204e 6f6e 653a 0a20 2020  put is None:.   
+00019b80: 2020 2020 2020 2020 2063 6f6e 7469 6e75           continu
+00019b90: 650a 2020 2020 2020 2020 656c 7365 3a0a  e.        else:.
+00019ba0: 2020 2020 2020 2020 2020 2020 7969 656c              yiel
+00019bb0: 6420 7379 6d62 6f6c 0a0a 0a64 6566 2064  d symbol...def d
+00019bc0: 6563 6f6e 7374 7275 6374 5f66 6f72 7761  econstruct_forwa
+00019bd0: 7264 5f65 6e76 5f66 6f72 5f62 6163 6b77  rd_env_for_backw
+00019be0: 6172 6428 7472 6163 652c 2065 6e76 293a  ard(trace, env):
+00019bf0: 0a20 2020 2023 204e 6f74 6520 5b53 6176  .    # Note [Sav
+00019c00: 696e 6720 7468 6520 666f 7277 6172 6420  ing the forward 
+00019c10: 656e 7669 726f 6e6d 656e 7420 696e 2074  environment in t
+00019c20: 6865 2062 6163 6b77 6172 6420 7275 6c65  he backward rule
+00019c30: 5d0a 2020 2020 2320 5765 2063 616e 6e6f  ].    # We canno
+00019c40: 7420 7361 7665 2074 6865 2074 7261 6365  t save the trace
+00019c50: 206f 626a 6563 7420 696e 2074 6865 2072   object in the r
+00019c60: 6573 6964 7561 6c73 2062 6563 6175 7365  esiduals because
+00019c70: 2065 7865 6375 746f 7273 206d 6179 206e   executors may n
+00019c80: 6f74 0a20 2020 2023 2062 6520 6162 6c65  ot.    # be able
+00019c90: 2074 6f20 7265 7475 726e 2069 7420 666f   to return it fo
+00019ca0: 7220 7468 6520 7370 6c69 7474 6564 2066  r the splitted f
+00019cb0: 6f72 7761 7264 2f62 6163 6b77 6172 6420  orward/backward 
+00019cc0: 7061 7373 6573 2e20 496e 7374 6561 642c  passes. Instead,
+00019cd0: 2077 650a 2020 2020 2320 7361 7665 2061   we.    # save a
+00019ce0: 7267 7320 616e 6420 6b77 6172 6773 206f  rgs and kwargs o
+00019cf0: 6620 7468 6520 6f72 6967 696e 616c 2066  f the original f
+00019d00: 756e 6374 696f 6e20 6361 6c6c 2061 6e64  unction call and
+00019d10: 2072 6563 6f6e 7374 7275 6374 2074 6865   reconstruct the
+00019d20: 0a20 2020 2023 2074 7261 6365 206f 626a  .    # trace obj
+00019d30: 6563 7420 616e 6420 6974 7320 656e 7669  ect and its envi
+00019d40: 726f 6e6d 656e 7420 6469 6374 2069 6e20  ronment dict in 
+00019d50: 7468 6520 6261 636b 7761 7264 2072 756c  the backward rul
+00019d60: 652e 2048 6572 6520 7765 2072 656c 790a  e. Here we rely.
+00019d70: 2020 2020 2320 6f6e 2074 6865 2066 6163      # on the fac
+00019d80: 7420 7468 6174 2074 6865 206f 7264 6572  t that the order
+00019d90: 206f 6620 7468 6520 7379 6d62 6f6c 7320   of the symbols 
+00019da0: 696e 2074 6865 2074 7261 6365 2069 7320  in the trace is 
+00019db0: 6465 7465 726d 696e 6973 7469 630a 2020  deterministic.  
+00019dc0: 2020 2320 616e 6420 616c 7761 7973 2074    # and always t
+00019dd0: 6865 2073 616d 6520 666f 7220 7468 6520  he same for the 
+00019de0: 7361 6d65 2066 756e 6374 696f 6e20 6361  same function ca
+00019df0: 6c6c 2061 6e64 2074 6865 2073 616d 6520  ll and the same 
+00019e00: 7365 7420 6f66 0a20 2020 2023 2061 7267  set of.    # arg
+00019e10: 756d 656e 7473 2e20 5365 6520 7465 7374  uments. See test
+00019e20: 5f67 7261 642e 7079 3a74 6573 745f 746f  _grad.py:test_to
+00019e30: 7263 685f 6175 746f 6772 6164 5f66 756e  rch_autograd_fun
+00019e40: 6374 696f 6e20 666f 7220 616e 2065 7861  ction for an exa
+00019e50: 6d70 6c65 0a20 2020 2023 2077 6865 7265  mple.    # where
+00019e60: 2074 6869 7320 6973 2074 6573 7465 642e   this is tested.
+00019e70: 0a20 2020 2062 6f75 6e64 5f73 796d 626f  .    bound_symbo
+00019e80: 6c73 203d 2069 7465 725f 626f 756e 645f  ls = iter_bound_
+00019e90: 7379 6d62 6f6c 7328 7472 6163 652e 626f  symbols(trace.bo
+00019ea0: 756e 645f 7379 6d62 6f6c 7329 0a20 2020  und_symbols).   
+00019eb0: 2073 6176 6564 5f66 6f72 5f62 6163 6b77   saved_for_backw
+00019ec0: 6172 6420 3d20 7475 706c 6528 656e 765b  ard = tuple(env[
+00019ed0: 7365 7175 656e 6369 6679 2873 796d 626f  sequencify(symbo
+00019ee0: 6c2e 6f75 7470 7574 295b 305d 2e6e 616d  l.output)[0].nam
+00019ef0: 655d 2e72 6573 6964 7561 6c73 2066 6f72  e].residuals for
+00019f00: 2073 796d 626f 6c20 696e 2062 6f75 6e64   symbol in bound
+00019f10: 5f73 796d 626f 6c73 290a 2020 2020 7265  _symbols).    re
+00019f20: 7475 726e 2073 6176 6564 5f66 6f72 5f62  turn saved_for_b
+00019f30: 6163 6b77 6172 640a 0a0a 6465 6620 7265  ackward...def re
+00019f40: 636f 6e73 7472 7563 745f 666f 7277 6172  construct_forwar
+00019f50: 645f 656e 765f 666f 725f 6261 636b 7761  d_env_for_backwa
+00019f60: 7264 2874 7261 6365 2c20 7361 7665 645f  rd(trace, saved_
+00019f70: 666f 725f 6261 636b 7761 7264 293a 0a20  for_backward):. 
+00019f80: 2020 2062 6f75 6e64 5f73 796d 626f 6c73     bound_symbols
+00019f90: 203d 2069 7465 725f 626f 756e 645f 7379   = iter_bound_sy
+00019fa0: 6d62 6f6c 7328 7472 6163 652e 626f 756e  mbols(trace.boun
+00019fb0: 645f 7379 6d62 6f6c 7329 0a0a 2020 2020  d_symbols)..    
+00019fc0: 7265 636f 6e73 7472 7563 7465 645f 656e  reconstructed_en
+00019fd0: 7620 3d20 7b7d 0a0a 2020 2020 666f 7220  v = {}..    for 
+00019fe0: 6964 782c 2073 796d 2069 6e20 656e 756d  idx, sym in enum
+00019ff0: 6572 6174 6528 626f 756e 645f 7379 6d62  erate(bound_symb
+0001a000: 6f6c 7329 3a0a 2020 2020 2020 2020 6b20  ols):.        k 
+0001a010: 3d20 7365 7175 656e 6369 6679 2873 796d  = sequencify(sym
+0001a020: 2e6f 7574 7075 7429 5b30 5d2e 6e61 6d65  .output)[0].name
+0001a030: 0a20 2020 2020 2020 2076 203d 2056 4a50  .        v = VJP
+0001a040: 4475 616c 284e 6f6e 652c 2073 6176 6564  Dual(None, saved
+0001a050: 5f66 6f72 5f62 6163 6b77 6172 645b 6964  _for_backward[id
+0001a060: 785d 290a 2020 2020 2020 2020 7265 636f  x]).        reco
+0001a070: 6e73 7472 7563 7465 645f 656e 765b 6b5d  nstructed_env[k]
+0001a080: 203d 2076 0a0a 2020 2020 7265 7475 726e   = v..    return
+0001a090: 2072 6563 6f6e 7374 7275 6374 6564 5f65   reconstructed_e
+0001a0a0: 6e76 0a0a 0a64 6566 2064 6563 6f6d 706f  nv...def decompo
+0001a0b0: 7365 645f 666e 5f61 7567 5f66 7764 5f72  sed_fn_aug_fwd_r
+0001a0c0: 756c 6528 2a61 7267 732c 2064 6563 6f6d  ule(*args, decom
+0001a0d0: 706f 7365 645f 666e 2c20 2a2a 6b77 6172  posed_fn, **kwar
+0001a0e0: 6773 293a 0a20 2020 2022 2222 4175 676d  gs):.    """Augm
+0001a0f0: 656e 7465 6420 666f 7277 6172 6420 7275  ented forward ru
+0001a100: 6c65 2066 6f72 2063 6f6d 706f 7369 7465  le for composite
+0001a110: 2066 756e 6374 696f 6e73 2069 6d70 6c65   functions imple
+0001a120: 6d65 6e74 6564 2069 6e20 7465 726d 7320  mented in terms 
+0001a130: 6f66 206f 7468 6572 2066 756e 6374 696f  of other functio
+0001a140: 6e73 2074 6861 7420 6172 650a 2020 2020  ns that are.    
+0001a150: 7375 7070 6f73 6564 2074 6f20 6265 2073  supposed to be s
+0001a160: 7570 706f 7274 6564 2062 7920 7468 6520  upported by the 
+0001a170: 564a 5020 696e 6672 6173 7472 7563 7475  VJP infrastructu
+0001a180: 7265 2e0a 0a20 2020 2041 7267 733a 0a20  re...    Args:. 
+0001a190: 2020 2020 2020 2064 6563 6f6d 706f 7365         decompose
+0001a1a0: 645f 666e 2028 4361 6c6c 6162 6c65 293a  d_fn (Callable):
+0001a1b0: 2064 6563 6f6d 706f 7365 6420 7665 7273   decomposed vers
+0001a1c0: 696f 6e20 6f66 2074 6865 2066 756e 6374  ion of the funct
+0001a1d0: 696f 6e0a 0a20 2020 2052 6574 7572 6e73  ion..    Returns
+0001a1e0: 3a0a 2020 2020 2020 2020 4361 6c6c 6162  :.        Callab
+0001a1f0: 6c65 3a20 4175 676d 656e 7465 6420 666f  le: Augmented fo
+0001a200: 7277 6172 6420 7275 6c65 2066 6f72 2074  rward rule for t
+0001a210: 6865 2063 6f6d 706f 7369 7465 2066 756e  he composite fun
+0001a220: 6374 696f 6e0a 2020 2020 2222 220a 2020  ction.    """.  
+0001a230: 2020 7472 6163 6520 3d20 636f 6e73 7472    trace = constr
+0001a240: 7563 745f 7472 6163 6528 2928 6465 636f  uct_trace()(deco
+0001a250: 6d70 6f73 6564 5f66 6e2c 202a 6172 6773  mposed_fn, *args
+0001a260: 2c20 2a2a 6b77 6172 6773 290a 2020 2020  , **kwargs).    
+0001a270: 7472 6163 6520 3d20 756e 7772 6170 5f6f  trace = unwrap_o
+0001a280: 6e65 5f6c 6576 656c 5f6f 665f 7375 6273  ne_level_of_subs
+0001a290: 796d 626f 6c73 2874 7261 6365 290a 2020  ymbols(trace).  
+0001a2a0: 2020 2320 5468 6572 6520 6d61 7920 6265    # There may be
+0001a2b0: 2061 2064 6561 6420 6e6f 6465 206c 696b   a dead node lik
+0001a2c0: 6520 225f 203d 2070 7269 6d73 2e63 6f6e  e "_ = prims.con
+0001a2d0: 7665 7274 5f65 6c65 6d65 6e74 5f74 7970  vert_element_typ
+0001a2e0: 6528 302c 2066 6c6f 6174 2922 0a20 2020  e(0, float)".   
+0001a2f0: 2023 2069 6e20 7468 6520 7472 6163 652e   # in the trace.
+0001a300: 2057 6520 6e65 6564 2074 6f20 7265 6d6f   We need to remo
+0001a310: 7665 2069 7420 6265 666f 7265 2077 6520  ve it before we 
+0001a320: 6361 6e20 7573 6520 7468 6520 7472 6163  can use the trac
+0001a330: 6520 666f 720a 2020 2020 2320 6175 676d  e for.    # augm
+0001a340: 656e 7465 645f 666f 7277 6172 645f 7061  ented_forward_pa
+0001a350: 7373 2e0a 2020 2020 7472 6163 6520 3d20  ss..    trace = 
+0001a360: 6463 6528 7472 6163 6529 0a20 2020 2072  dce(trace).    r
+0001a370: 6573 756c 742c 2065 6e76 203d 2061 7567  esult, env = aug
+0001a380: 6d65 6e74 6564 5f66 6f72 7761 7264 5f70  mented_forward_p
+0001a390: 6173 7328 2a61 7267 732c 2074 7261 6365  ass(*args, trace
+0001a3a0: 3d74 7261 6365 2c20 2a2a 6b77 6172 6773  =trace, **kwargs
+0001a3b0: 290a 2020 2020 7361 7665 645f 666f 725f  ).    saved_for_
+0001a3c0: 6261 636b 7761 7264 203d 2064 6563 6f6e  backward = decon
+0001a3d0: 7374 7275 6374 5f66 6f72 7761 7264 5f65  struct_forward_e
+0001a3e0: 6e76 5f66 6f72 5f62 6163 6b77 6172 6428  nv_for_backward(
+0001a3f0: 7472 6163 652c 2065 6e76 290a 2020 2020  trace, env).    
+0001a400: 2320 5374 6174 6963 2063 6163 6869 6e67  # Static caching
+0001a410: 2064 6f65 7320 6e6f 7420 7769 7468 2077   does not with w
+0001a420: 6974 6820 6b77 6172 6773 2064 6963 7473  ith kwargs dicts
+0001a430: 2c20 736f 2077 6527 7265 2063 6f6e 7665  , so we're conve
+0001a440: 7274 696e 6720 7468 656d 0a20 2020 2023  rting them.    #
+0001a450: 2074 6f20 4e6f 6e65 2066 6f72 206e 6f77   to None for now
+0001a460: 2077 6865 6e20 706f 7373 6962 6c65 2e0a   when possible..
+0001a470: 2020 2020 6b77 6172 6773 203d 204e 6f6e      kwargs = Non
+0001a480: 6520 6966 206e 6f74 206b 7761 7267 7320  e if not kwargs 
+0001a490: 656c 7365 206b 7761 7267 730a 2020 2020  else kwargs.    
+0001a4a0: 7265 7369 6475 616c 7320 3d20 2861 7267  residuals = (arg
+0001a4b0: 732c 206b 7761 7267 732c 2073 6176 6564  s, kwargs, saved
+0001a4c0: 5f66 6f72 5f62 6163 6b77 6172 6429 0a20  _for_backward). 
+0001a4d0: 2020 2072 6574 7572 6e20 564a 5044 7561     return VJPDua
+0001a4e0: 6c28 7265 7375 6c74 2c20 7265 7369 6475  l(result, residu
+0001a4f0: 616c 7329 0a0a 0a64 6566 2064 6563 6f6d  als)...def decom
+0001a500: 706f 7365 645f 666e 5f62 6163 6b77 6172  posed_fn_backwar
+0001a510: 645f 7275 6c65 2864 6563 6f6d 706f 7365  d_rule(decompose
+0001a520: 645f 666e 2c20 6172 6773 2c20 6b77 6172  d_fn, args, kwar
+0001a530: 6773 2c20 7361 7665 645f 666f 725f 6261  gs, saved_for_ba
+0001a540: 636b 7761 7264 2c20 2a67 7261 6473 293a  ckward, *grads):
+0001a550: 0a20 2020 206b 7761 7267 7320 3d20 7b7d  .    kwargs = {}
+0001a560: 2069 6620 6b77 6172 6773 2069 7320 4e6f   if kwargs is No
+0001a570: 6e65 2065 6c73 6520 6b77 6172 6773 0a20  ne else kwargs. 
+0001a580: 2020 2074 7261 6365 203d 2063 6f6e 7374     trace = const
+0001a590: 7275 6374 5f74 7261 6365 2829 2864 6563  ruct_trace()(dec
+0001a5a0: 6f6d 706f 7365 645f 666e 2c20 2a61 7267  omposed_fn, *arg
+0001a5b0: 732c 202a 2a6b 7761 7267 7329 0a20 2020  s, **kwargs).   
+0001a5c0: 2074 7261 6365 203d 2075 6e77 7261 705f   trace = unwrap_
+0001a5d0: 6f6e 655f 6c65 7665 6c5f 6f66 5f73 7562  one_level_of_sub
+0001a5e0: 7379 6d62 6f6c 7328 7472 6163 6529 0a20  symbols(trace). 
+0001a5f0: 2020 2074 7261 6365 203d 2064 6365 2874     trace = dce(t
+0001a600: 7261 6365 290a 2020 2020 2320 626f 756e  race).    # boun
+0001a610: 645f 7379 6d62 6f6c 7320 3d20 6974 6572  d_symbols = iter
+0001a620: 5f62 6f75 6e64 5f73 796d 626f 6c73 2874  _bound_symbols(t
+0001a630: 7261 6365 2e62 6f75 6e64 5f73 796d 626f  race.bound_symbo
+0001a640: 6c73 290a 2020 2020 2320 7265 636f 6e73  ls).    # recons
+0001a650: 7472 7563 7465 645f 656e 7620 3d20 7b0a  tructed_env = {.
+0001a660: 2020 2020 2320 2020 2020 7365 7175 656e      #     sequen
+0001a670: 6369 6679 2873 796d 626f 6c2e 6f75 7470  cify(symbol.outp
+0001a680: 7574 295b 305d 2e6e 616d 653a 2056 4a50  ut)[0].name: VJP
+0001a690: 4475 616c 284e 6f6e 652c 2073 6176 6564  Dual(None, saved
+0001a6a0: 5f66 6f72 5f62 6163 6b77 6172 645b 695d  _for_backward[i]
+0001a6b0: 290a 2020 2020 2320 2020 2020 666f 7220  ).    #     for 
+0001a6c0: 692c 2073 796d 626f 6c20 696e 2065 6e75  i, symbol in enu
+0001a6d0: 6d65 7261 7465 2862 6f75 6e64 5f73 796d  merate(bound_sym
+0001a6e0: 626f 6c73 290a 2020 2020 2320 7d0a 2020  bols).    # }.  
+0001a6f0: 2020 7265 636f 6e73 7472 7563 7465 645f    reconstructed_
+0001a700: 656e 7620 3d20 7265 636f 6e73 7472 7563  env = reconstruc
+0001a710: 745f 666f 7277 6172 645f 656e 765f 666f  t_forward_env_fo
+0001a720: 725f 6261 636b 7761 7264 2874 7261 6365  r_backward(trace
+0001a730: 2c20 7361 7665 645f 666f 725f 6261 636b  , saved_for_back
+0001a740: 7761 7264 290a 2020 2020 7265 7375 6c74  ward).    result
+0001a750: 203d 2062 6163 6b77 6172 645f 7061 7373   = backward_pass
+0001a760: 2872 6563 6f6e 7374 7275 6374 6564 5f65  (reconstructed_e
+0001a770: 6e76 2c20 7472 6163 652c 2067 7261 6473  nv, trace, grads
+0001a780: 290a 2020 2020 6966 206c 656e 2861 7267  ).    if len(arg
+0001a790: 7329 203d 3d20 313a 0a20 2020 2020 2020  s) == 1:.       
+0001a7a0: 2072 6574 7572 6e20 7265 7375 6c74 5b30   return result[0
+0001a7b0: 5d0a 2020 2020 2320 4261 636b 7761 7264  ].    # Backward
+0001a7c0: 2070 6173 7320 6d69 6768 7420 7265 7475   pass might retu
+0001a7d0: 726e 2061 2064 6963 7420 7769 7468 2067  rn a dict with g
+0001a7e0: 7261 6473 2062 7574 2063 7572 7265 6e74  rads but current
+0001a7f0: 2069 6e74 6572 6661 6365 206f 660a 2020   interface of.  
+0001a800: 2020 2320 6261 636b 7761 7264 2072 756c    # backward rul
+0001a810: 6520 646f 6573 206e 6f74 2073 7570 706f  e does not suppo
+0001a820: 7274 2069 742e 2053 6f20 7765 206a 7573  rt it. So we jus
+0001a830: 7420 6472 6f70 2069 7420 666f 7220 6e6f  t drop it for no
+0001a840: 772e 0a20 2020 2065 6c69 6620 6973 696e  w..    elif isin
+0001a850: 7374 616e 6365 2872 6573 756c 745b 2d31  stance(result[-1
+0001a860: 5d2c 2064 6963 7429 3a0a 2020 2020 2020  ], dict):.      
+0001a870: 2020 7265 7475 726e 2072 6573 756c 745b    return result[
+0001a880: 3a2d 315d 0a20 2020 2072 6574 7572 6e20  :-1].    return 
+0001a890: 7265 7375 6c74 0a0a 0a40 7265 6769 7374  result...@regist
+0001a8a0: 6572 5f61 7567 6d65 6e74 6564 5f66 6f72  er_augmented_for
+0001a8b0: 7761 7264 2822 746f 7263 682e 5465 6e73  ward("torch.Tens
+0001a8c0: 6f72 2e63 6f6e 7469 6775 6f75 7322 290a  or.contiguous").
+0001a8d0: 4072 6567 6973 7465 725f 6175 676d 656e  @register_augmen
+0001a8e0: 7465 645f 666f 7277 6172 6428 2274 6f72  ted_forward("tor
+0001a8f0: 6368 2e63 6f6e 7469 6775 6f75 7322 290a  ch.contiguous").
+0001a900: 6465 6620 636f 6e74 6967 756f 7573 5f61  def contiguous_a
+0001a910: 7567 5f66 7764 2878 3a20 5465 6e73 6f72  ug_fwd(x: Tensor
+0001a920: 5072 6f78 792c 202f 2c20 2a2c 206d 656d  Proxy, /, *, mem
+0001a930: 6f72 795f 666f 726d 6174 3a20 746f 7263  ory_format: torc
+0001a940: 682e 6d65 6d6f 7279 5f66 6f72 6d61 7420  h.memory_format 
+0001a950: 3d20 746f 7263 682e 636f 6e74 6967 756f  = torch.contiguo
+0001a960: 7573 5f66 6f72 6d61 7429 202d 3e20 564a  us_format) -> VJ
+0001a970: 5044 7561 6c3a 0a20 2020 2066 726f 6d20  PDual:.    from 
+0001a980: 7468 756e 6465 722e 746f 7263 6820 696d  thunder.torch im
+0001a990: 706f 7274 2063 6f6e 7469 6775 6f75 730a  port contiguous.
+0001a9a0: 0a20 2020 2072 6574 7572 6e20 564a 5044  .    return VJPD
+0001a9b0: 7561 6c28 636f 6e74 6967 756f 7573 2878  ual(contiguous(x
+0001a9c0: 2c20 6d65 6d6f 7279 5f66 6f72 6d61 743d  , memory_format=
+0001a9d0: 6d65 6d6f 7279 5f66 6f72 6d61 7429 2c20  memory_format), 
+0001a9e0: 7475 706c 6528 2929 0a0a 0a40 7265 6769  tuple())...@regi
+0001a9f0: 7374 6572 5f62 6163 6b77 6172 6428 2274  ster_backward("t
+0001aa00: 6f72 6368 2e54 656e 736f 722e 636f 6e74  orch.Tensor.cont
+0001aa10: 6967 756f 7573 2229 0a40 7265 6769 7374  iguous").@regist
+0001aa20: 6572 5f62 6163 6b77 6172 6428 2274 6f72  er_backward("tor
+0001aa30: 6368 2e63 6f6e 7469 6775 6f75 7322 290a  ch.contiguous").
+0001aa40: 6465 6620 636f 6e74 6967 756f 7573 5f62  def contiguous_b
+0001aa50: 6163 6b77 6172 6428 2a72 6573 6964 7561  ackward(*residua
+0001aa60: 6c73 5f61 6e64 5f67 7261 6429 202d 3e20  ls_and_grad) -> 
+0001aa70: 5465 6e73 6f72 5072 6f78 793a 0a20 2020  TensorProxy:.   
+0001aa80: 2023 2052 6573 6964 7561 6c73 2069 7320   # Residuals is 
+0001aa90: 6e6f 7420 656d 7074 7920 6265 6361 7573  not empty becaus
+0001aaa0: 6520 636f 6e74 6967 756f 7573 2073 796d  e contiguous sym
+0001aab0: 626f 6c20 6861 7320 7468 6520 7361 6d65  bol has the same
+0001aac0: 206f 7574 7075 7420 6173 2069 7473 2069   output as its i
+0001aad0: 6e70 7574 0a20 2020 2067 203d 2072 6573  nput.    g = res
+0001aae0: 6964 7561 6c73 5f61 6e64 5f67 7261 645b  iduals_and_grad[
+0001aaf0: 2d31 5d0a 2020 2020 7265 7475 726e 2067  -1].    return g
+0001ab00: 0a0a 0a64 6566 2072 6563 6970 726f 6361  ...def reciproca
+0001ab10: 6c5f 6175 675f 6677 6428 613a 2054 656e  l_aug_fwd(a: Ten
+0001ab20: 736f 7250 726f 7879 2920 2d3e 2056 4a50  sorProxy) -> VJP
+0001ab30: 4475 616c 3a0a 2020 2020 7072 696d 616c  Dual:.    primal
+0001ab40: 203d 2072 6563 6970 726f 6361 6c28 6129   = reciprocal(a)
+0001ab50: 0a20 2020 2072 6574 7572 6e20 564a 5044  .    return VJPD
+0001ab60: 7561 6c28 7072 696d 616c 2c20 2870 7269  ual(primal, (pri
+0001ab70: 6d61 6c2c 2929 0a0a 0a64 6566 2072 6563  mal,))...def rec
+0001ab80: 6970 726f 6361 6c5f 6261 636b 7761 7264  iprocal_backward
+0001ab90: 2870 7269 6d61 6c2c 2067 293a 0a20 2020  (primal, g):.   
+0001aba0: 2072 6574 7572 6e20 2d67 202a 2070 7269   return -g * pri
+0001abb0: 6d61 6c20 2a20 7072 696d 616c 0a0a 0a40  mal * primal...@
+0001abc0: 7061 7274 6961 6c28 7265 6769 7374 6572  partial(register
+0001abd0: 5f67 7261 642c 2070 7269 6d73 2e50 7269  _grad, prims.Pri
+0001abe0: 6d49 4473 2e52 4543 4950 524f 4341 4c29  mIDs.RECIPROCAL)
+0001abf0: 0a64 6566 2072 6563 6970 726f 6361 6c5f  .def reciprocal_
+0001ac00: 6a6f 696e 745f 666f 7277 6172 645f 6261  joint_forward_ba
+0001ac10: 636b 7761 7264 5f72 756c 6528 613a 2054  ckward_rule(a: T
+0001ac20: 656e 736f 7250 726f 7879 2920 2d3e 2054  ensorProxy) -> T
+0001ac30: 656e 736f 7250 726f 7879 3a0a 2020 2020  ensorProxy:.    
+0001ac40: 7265 7375 6c74 2c20 7361 7665 6420 3d20  result, saved = 
+0001ac50: 7265 6369 7072 6f63 616c 5f61 7567 5f66  reciprocal_aug_f
+0001ac60: 7764 2861 290a 2020 2020 6720 3d20 6765  wd(a).    g = ge
+0001ac70: 745f 6772 6164 2872 6573 756c 7429 0a20  t_grad(result). 
+0001ac80: 2020 2067 6120 3d20 7265 6369 7072 6f63     ga = reciproc
+0001ac90: 616c 5f62 6163 6b77 6172 6428 2a73 6176  al_backward(*sav
+0001aca0: 6564 2c20 6729 0a20 2020 2070 7574 5f67  ed, g).    put_g
+0001acb0: 7261 6428 612c 2067 6129 0a20 2020 2072  rad(a, ga).    r
+0001acc0: 6574 7572 6e20 7265 7375 6c74 0a0a 0a40  eturn result...@
+0001acd0: 7265 6769 7374 6572 5f61 7567 6d65 6e74  register_augment
+0001ace0: 6564 5f66 6f72 7761 7264 2822 746f 7263  ed_forward("torc
+0001acf0: 682e 696e 6465 785f 7075 7422 290a 6465  h.index_put").de
+0001ad00: 6620 696e 6465 785f 7075 745f 6175 675f  f index_put_aug_
+0001ad10: 6677 6428 0a20 2020 2061 3a20 5465 6e73  fwd(.    a: Tens
+0001ad20: 6f72 5072 6f78 792c 202f 2c20 696e 6469  orProxy, /, indi
+0001ad30: 6365 733a 2053 6571 7565 6e63 655b 5465  ces: Sequence[Te
+0001ad40: 6e73 6f72 5072 6f78 795d 2c20 7661 6c75  nsorProxy], valu
+0001ad50: 6573 3a20 5465 6e73 6f72 5072 6f78 792c  es: TensorProxy,
+0001ad60: 2061 6363 756d 756c 6174 653a 2062 6f6f   accumulate: boo
+0001ad70: 6c20 3d20 4661 6c73 650a 2920 2d3e 2056  l = False.) -> V
+0001ad80: 4a50 4475 616c 3a0a 2020 2020 7072 696d  JPDual:.    prim
+0001ad90: 616c 203d 2063 6c61 6e67 2e69 6e64 6578  al = clang.index
+0001ada0: 5f70 7574 2861 2c20 696e 6469 6365 732c  _put(a, indices,
+0001adb0: 2076 616c 7565 732c 2061 6363 756d 756c   values, accumul
+0001adc0: 6174 6529 0a20 2020 2072 6573 6964 7561  ate).    residua
+0001add0: 6c73 203d 2028 0a20 2020 2020 2020 2069  ls = (.        i
+0001ade0: 6e64 6963 6573 2c0a 2020 2020 2020 2020  ndices,.        
+0001adf0: 7661 6c75 6573 2c0a 2020 2020 2020 2020  values,.        
+0001ae00: 6163 6375 6d75 6c61 7465 2c0a 2020 2020  accumulate,.    
+0001ae10: 290a 2020 2020 7265 7475 726e 2056 4a50  ).    return VJP
+0001ae20: 4475 616c 2870 7269 6d61 6c2c 2072 6573  Dual(primal, res
+0001ae30: 6964 7561 6c73 290a 0a0a 6465 6620 7375  iduals)...def su
+0001ae40: 6d5f 746f 2861 3a20 5465 6e73 6f72 5072  m_to(a: TensorPr
+0001ae50: 6f78 792c 2073 6861 7065 3a20 5365 7175  oxy, shape: Sequ
+0001ae60: 656e 6365 5b69 6e74 5d29 202d 3e20 5465  ence[int]) -> Te
+0001ae70: 6e73 6f72 5072 6f78 793a 0a20 2020 2069  nsorProxy:.    i
+0001ae80: 6620 6e6f 7420 7368 6170 653a 0a20 2020  f not shape:.   
+0001ae90: 2020 2020 2072 6574 7572 6e20 612e 7375       return a.su
+0001aea0: 6d28 290a 2020 2020 6c65 6164 696e 675f  m().    leading_
+0001aeb0: 6469 6d73 203d 2061 2e6e 6469 6d20 2d20  dims = a.ndim - 
+0001aec0: 6c65 6e28 7368 6170 6529 0a20 2020 2072  len(shape).    r
+0001aed0: 6564 7563 655f 6469 6d73 203d 2074 7570  educe_dims = tup
+0001aee0: 6c65 2872 616e 6765 286c 6561 6469 6e67  le(range(leading
+0001aef0: 5f64 696d 7329 2920 2b20 7475 706c 6528  _dims)) + tuple(
+0001af00: 0a20 2020 2020 2020 2069 2066 6f72 2069  .        i for i
+0001af10: 2069 6e20 7261 6e67 6528 6c65 6164 696e   in range(leadin
+0001af20: 675f 6469 6d73 2c20 612e 6e64 696d 2920  g_dims, a.ndim) 
+0001af30: 6966 2073 6861 7065 5b69 202d 206c 6561  if shape[i - lea
+0001af40: 6469 6e67 5f64 696d 735d 203d 3d20 3120  ding_dims] == 1 
+0001af50: 616e 6420 612e 7368 6170 655b 695d 2021  and a.shape[i] !
+0001af60: 3d20 310a 2020 2020 290a 2020 2020 6120  = 1.    ).    a 
+0001af70: 3d20 6c74 6f72 6368 2e73 756d 2861 2c20  = ltorch.sum(a, 
+0001af80: 6469 6d3d 7265 6475 6365 5f64 696d 732c  dim=reduce_dims,
+0001af90: 206b 6565 7064 696d 3d54 7275 6529 0a20   keepdim=True). 
+0001afa0: 2020 2069 6620 6c65 6164 696e 675f 6469     if leading_di
+0001afb0: 6d73 203e 2030 3a0a 2020 2020 2020 2020  ms > 0:.        
+0001afc0: 7265 7475 726e 206c 746f 7263 682e 7669  return ltorch.vi
+0001afd0: 6577 2861 2c20 7368 6170 6529 0a20 2020  ew(a, shape).   
+0001afe0: 2072 6574 7572 6e20 610a 0a0a 4072 6567   return a...@reg
+0001aff0: 6973 7465 725f 6261 636b 7761 7264 2822  ister_backward("
+0001b000: 746f 7263 682e 696e 6465 785f 7075 7422  torch.index_put"
+0001b010: 290a 6465 6620 696e 6465 785f 7075 745f  ).def index_put_
+0001b020: 6261 636b 7761 7264 2869 6e64 6963 6573  backward(indices
+0001b030: 3a20 5365 7175 656e 6365 5b54 656e 736f  : Sequence[Tenso
+0001b040: 7250 726f 7879 5d2c 2076 616c 7565 733a  rProxy], values:
+0001b050: 2054 656e 736f 7250 726f 7879 2c20 6163   TensorProxy, ac
+0001b060: 6375 6d75 6c61 7465 3a20 626f 6f6c 2c20  cumulate: bool, 
+0001b070: 673a 2054 656e 736f 7250 726f 7879 293a  g: TensorProxy):
+0001b080: 0a20 2020 2067 5f76 616c 7565 7320 3d20  .    g_values = 
+0001b090: 675b 696e 6469 6365 735d 0a20 2020 2023  g[indices].    #
+0001b0a0: 2074 6f72 6368 2068 6173 2065 7874 7261   torch has extra
+0001b0b0: 206c 6f67 6963 2074 6f20 6861 6e64 6c65   logic to handle
+0001b0c0: 2074 6865 2065 7870 616e 6465 6420 7661   the expanded va
+0001b0d0: 6c75 6573 0a20 2020 2069 6620 6e6f 7420  lues.    if not 
+0001b0e0: 7574 696c 732e 7361 6d65 5f73 6861 7065  utils.same_shape
+0001b0f0: 2867 5f76 616c 7565 732e 7368 6170 652c  (g_values.shape,
+0001b100: 2076 616c 7565 732e 7368 6170 6529 3a0a   values.shape):.
+0001b110: 2020 2020 2020 2020 6966 2063 6c61 6e67          if clang
+0001b120: 2e63 6f6d 7075 7465 5f62 726f 6164 6361  .compute_broadca
+0001b130: 7374 5f73 6861 7065 2867 5f76 616c 7565  st_shape(g_value
+0001b140: 732e 7368 6170 652c 2076 616c 7565 732e  s.shape, values.
+0001b150: 7368 6170 6529 3a0a 2020 2020 2020 2020  shape):.        
+0001b160: 2020 2020 675f 7661 6c75 6573 203d 2073      g_values = s
+0001b170: 756d 5f74 6f28 675f 7661 6c75 6573 2c20  um_to(g_values, 
+0001b180: 7661 6c75 6573 2e73 6861 7065 290a 2020  values.shape).  
+0001b190: 2020 6966 2061 6363 756d 756c 6174 653a    if accumulate:
+0001b1a0: 0a20 2020 2020 2020 2072 6574 7572 6e20  .        return 
+0001b1b0: 672c 2067 5f76 616c 7565 730a 2020 2020  g, g_values.    
+0001b1c0: 7265 7475 726e 2063 6c61 6e67 2e69 6e64  return clang.ind
+0001b1d0: 6578 5f70 7574 2867 2c20 696e 6469 6365  ex_put(g, indice
+0001b1e0: 732c 206c 746f 7263 682e 7a65 726f 735f  s, ltorch.zeros_
+0001b1f0: 6c69 6b65 2876 616c 7565 7329 2c20 4661  like(values), Fa
+0001b200: 6c73 6529 2c20 675f 7661 6c75 6573 0a0a  lse), g_values..
+0001b210: 0a64 6566 2075 6e69 666f 726d 5f61 7567  .def uniform_aug
+0001b220: 5f66 7764 2873 6861 7065 2c20 6d69 6e76  _fwd(shape, minv
+0001b230: 616c 2c20 6d61 7876 616c 2c20 2a2c 2064  al, maxval, *, d
+0001b240: 6576 6963 652c 2064 7479 7065 293a 0a20  evice, dtype):. 
+0001b250: 2020 2070 7269 6d61 6c20 3d20 7072 696d     primal = prim
+0001b260: 732e 756e 6966 6f72 6d28 7368 6170 652c  s.uniform(shape,
+0001b270: 206d 696e 7661 6c2c 206d 6178 7661 6c2c   minval, maxval,
+0001b280: 2064 6576 6963 653d 6465 7669 6365 2c20   device=device, 
+0001b290: 6474 7970 653d 6474 7970 6529 0a20 2020  dtype=dtype).   
+0001b2a0: 2072 6574 7572 6e20 564a 5044 7561 6c28   return VJPDual(
+0001b2b0: 7072 696d 616c 2c20 2870 7269 6d61 6c2c  primal, (primal,
+0001b2c0: 206d 696e 7661 6c2c 206d 6178 7661 6c29   minval, maxval)
+0001b2d0: 290a 0a0a 6465 6620 756e 6966 6f72 6d5f  )...def uniform_
+0001b2e0: 6261 636b 7761 7264 2870 7269 6d61 6c2c  backward(primal,
+0001b2f0: 206d 696e 7661 6c2c 206d 6178 7661 6c2c   minval, maxval,
+0001b300: 2067 293a 0a20 2020 2023 2075 6e69 666f   g):.    # unifo
+0001b310: 726d 2069 7320 696d 706c 656d 656e 7465  rm is implemente
+0001b320: 6420 6173 2028 6d61 7876 616c 202d 206d  d as (maxval - m
+0001b330: 696e 7661 6c29 202a 2075 6e69 666f 726d  inval) * uniform
+0001b340: 2873 6861 7065 2c20 302c 2031 2920 2b20  (shape, 0, 1) + 
+0001b350: 6d69 6e76 616c 0a20 2020 2075 6e73 6361  minval.    unsca
+0001b360: 6c65 645f 7072 696d 616c 203d 2028 7072  led_primal = (pr
+0001b370: 696d 616c 202d 206d 696e 7661 6c29 202f  imal - minval) /
+0001b380: 2028 6d61 7876 616c 202d 206d 696e 7661   (maxval - minva
+0001b390: 6c29 0a20 2020 2072 6564 7563 655f 616c  l).    reduce_al
+0001b3a0: 6c5f 6469 6d73 203d 2074 7570 6c65 2872  l_dims = tuple(r
+0001b3b0: 616e 6765 2867 2e6e 6469 6d29 290a 2020  ange(g.ndim)).  
+0001b3c0: 2020 7375 6d20 3d20 7061 7274 6961 6c28    sum = partial(
+0001b3d0: 7072 696d 732e 7375 6d2c 2064 696d 733d  prims.sum, dims=
+0001b3e0: 7265 6475 6365 5f61 6c6c 5f64 696d 7329  reduce_all_dims)
+0001b3f0: 0a20 2020 2072 6574 7572 6e20 4e6f 6e65  .    return None
+0001b400: 2c20 7375 6d28 6720 2a20 2831 202d 2075  , sum(g * (1 - u
+0001b410: 6e73 6361 6c65 645f 7072 696d 616c 2929  nscaled_primal))
+0001b420: 2c20 7375 6d28 6720 2a20 756e 7363 616c  , sum(g * unscal
+0001b430: 6564 5f70 7269 6d61 6c29 0a0a 0a6e 6f6e  ed_primal)...non
+0001b440: 6469 6666 6572 656e 7469 6162 6c65 5f76  differentiable_v
+0001b450: 6a70 5f73 796d 626f 6c73 203d 2028 7072  jp_symbols = (pr
+0001b460: 696d 732e 5072 696d 4944 732e 4249 5457  ims.PrimIDs.BITW
+0001b470: 4953 455f 414e 442c 2070 7269 6d73 2e50  ISE_AND, prims.P
+0001b480: 7269 6d49 4473 2e53 4947 4e42 4954 2c20  rimIDs.SIGNBIT, 
+0001b490: 7072 696d 732e 5072 696d 4944 732e 4655  prims.PrimIDs.FU
+0001b4a0: 4c4c 290a 0a0a 6465 6620 6973 5f63 6f6e  LL)...def is_con
+0001b4b0: 7374 616e 745f 666f 725f 766a 7028 7379  stant_for_vjp(sy
+0001b4c0: 6d62 6f6c 3a20 7072 696d 732e 5379 6d62  mbol: prims.Symb
+0001b4d0: 6f6c 2920 2d3e 2062 6f6f 6c3a 0a20 2020  ol) -> bool:.   
+0001b4e0: 2022 2222 4368 6563 6b20 6966 2061 2073   """Check if a s
+0001b4f0: 796d 626f 6c20 6973 2063 6f6e 7374 616e  ymbol is constan
+0001b500: 7420 666f 7220 7468 6520 564a 5020 7472  t for the VJP tr
+0001b510: 616e 7366 6f72 6d2e 0a0a 2020 2020 4172  ansform...    Ar
+0001b520: 6773 3a0a 2020 2020 2020 2020 7379 6d62  gs:.        symb
+0001b530: 6f6c 2028 7072 696d 732e 5379 6d62 6f6c  ol (prims.Symbol
+0001b540: 293a 2053 796d 626f 6c20 746f 2063 6865  ): Symbol to che
+0001b550: 636b 2e0a 0a20 2020 2052 6574 7572 6e73  ck...    Returns
+0001b560: 3a0a 2020 2020 2020 2020 626f 6f6c 3a20  :.        bool: 
+0001b570: 5472 7565 2069 6620 7468 6520 7379 6d62  True if the symb
+0001b580: 6f6c 2069 7320 636f 6e73 7461 6e74 2c20  ol is constant, 
+0001b590: 4661 6c73 6520 6f74 6865 7277 6973 652e  False otherwise.
+0001b5a0: 0a20 2020 2022 2222 0a20 2020 2061 7265  .    """.    are
+0001b5b0: 5f61 6c6c 5f61 7267 735f 6e6f 6e5f 6469  _all_args_non_di
+0001b5c0: 6666 6572 656e 7469 6162 6c65 203d 206e  fferentiable = n
+0001b5d0: 6f74 2061 6e79 2869 7369 6e73 7461 6e63  ot any(isinstanc
+0001b5e0: 6528 6172 672c 2028 466c 6f61 7450 726f  e(arg, (FloatPro
+0001b5f0: 7879 2c20 5465 6e73 6f72 5072 6f78 7929  xy, TensorProxy)
+0001b600: 2920 666f 7220 6172 6720 696e 2073 796d  ) for arg in sym
+0001b610: 626f 6c2e 666c 6174 5f61 7267 7329 0a20  bol.flat_args). 
+0001b620: 2020 2072 6574 7572 6e20 280a 2020 2020     return (.    
+0001b630: 2020 2020 6172 655f 616c 6c5f 6172 6773      are_all_args
+0001b640: 5f6e 6f6e 5f64 6966 6665 7265 6e74 6961  _non_differentia
+0001b650: 626c 650a 2020 2020 2020 2020 6f72 2073  ble.        or s
+0001b660: 796d 626f 6c2e 6172 655f 616c 6c5f 6172  ymbol.are_all_ar
+0001b670: 6773 5f63 6f6e 7374 616e 740a 2020 2020  gs_constant.    
+0001b680: 2020 2020 6f72 2073 796d 626f 6c2e 7379      or symbol.sy
+0001b690: 6d2e 6964 2069 6e20 6e6f 6e64 6966 6665  m.id in nondiffe
+0001b6a0: 7265 6e74 6961 626c 655f 766a 705f 7379  rentiable_vjp_sy
+0001b6b0: 6d62 6f6c 730a 2020 2020 290a 0a0a 6465  mbols.    )...de
+0001b6c0: 6620 766a 705f 7379 6d62 6f6c 5f6d 6170  f vjp_symbol_map
+0001b6d0: 7065 7228 7379 6d62 6f6c 3a20 7072 696d  per(symbol: prim
+0001b6e0: 732e 5379 6d62 6f6c 2c20 2a61 7267 732c  s.Symbol, *args,
+0001b6f0: 202a 2a6b 7761 7267 7329 3a0a 2020 2020   **kwargs):.    
+0001b700: 2222 2253 796d 626f 6c20 6d61 7070 6572  """Symbol mapper
+0001b710: 2066 6f72 2074 6865 2056 4a50 2074 7261   for the VJP tra
+0001b720: 6e73 666f 726d 2e0a 0a20 2020 2041 7267  nsform...    Arg
+0001b730: 733a 0a20 2020 2020 2020 2073 796d 626f  s:.        symbo
+0001b740: 6c20 2870 7269 6d73 2e53 796d 626f 6c29  l (prims.Symbol)
+0001b750: 3a20 5379 6d62 6f6c 2074 6f20 6265 206d  : Symbol to be m
+0001b760: 6170 7065 642e 0a20 2020 2020 2020 2061  apped..        a
+0001b770: 7267 7320 2854 7570 6c65 5b56 6172 6961  rgs (Tuple[Varia
+0001b780: 626c 655d 293a 2041 7267 756d 656e 7473  ble]): Arguments
+0001b790: 2074 6f20 7468 6520 7379 6d62 6f6c 2e0a   to the symbol..
+0001b7a0: 2020 2020 2020 2020 6b77 6172 6773 2028          kwargs (
+0001b7b0: 4469 6374 5b73 7472 2c20 5661 7269 6162  Dict[str, Variab
+0001b7c0: 6c65 5d29 3a20 4b65 7977 6f72 6420 6172  le]): Keyword ar
+0001b7d0: 6775 6d65 6e74 7320 746f 2074 6865 2073  guments to the s
+0001b7e0: 796d 626f 6c2e 0a0a 2020 2020 5265 7475  ymbol...    Retu
+0001b7f0: 726e 733a 0a20 2020 2020 2020 2043 616c  rns:.        Cal
+0001b800: 6c61 626c 653a 2041 2066 756e 6374 696f  lable: A functio
+0001b810: 6e20 7468 6174 2063 6f6d 7075 7465 7320  n that computes 
+0001b820: 7468 6520 564a 5020 6f66 2074 6865 2073  the VJP of the s
+0001b830: 796d 626f 6c2e 0a20 2020 2022 2222 0a20  ymbol..    """. 
+0001b840: 2020 2023 2043 6f6e 7374 616e 7420 6361     # Constant ca
+0001b850: 7365 0a20 2020 2069 6620 6973 5f63 6f6e  se.    if is_con
+0001b860: 7374 616e 745f 666f 725f 766a 7028 7379  stant_for_vjp(sy
+0001b870: 6d62 6f6c 293a 0a0a 2020 2020 2020 2020  mbol):..        
+0001b880: 6465 6620 766a 705f 696d 706c 5f63 6f6e  def vjp_impl_con
+0001b890: 7374 2873 796d 626f 6c2c 202a 6172 6773  st(symbol, *args
+0001b8a0: 2c20 2a2a 6b77 6172 6773 293a 0a20 2020  , **kwargs):.   
+0001b8b0: 2020 2020 2020 2020 2061 7267 732c 206b           args, k
+0001b8c0: 7761 7267 7320 3d20 7472 6565 5f6d 6170  wargs = tree_map
+0001b8d0: 286c 616d 6264 6120 783a 2078 2e70 7269  (lambda x: x.pri
+0001b8e0: 6d61 6c20 6966 2069 7369 6e73 7461 6e63  mal if isinstanc
+0001b8f0: 6528 782c 2056 4a50 4475 616c 2920 656c  e(x, VJPDual) el
+0001b900: 7365 2078 2c20 2861 7267 732c 206b 7761  se x, (args, kwa
+0001b910: 7267 7329 290a 2020 2020 2020 2020 2020  rgs)).          
+0001b920: 2020 7072 696d 616c 7320 3d20 7379 6d62    primals = symb
+0001b930: 6f6c 5f74 6f5f 6576 616c 2873 796d 626f  ol_to_eval(symbo
+0001b940: 6c29 282a 6172 6773 2c20 2a2a 6b77 6172  l)(*args, **kwar
+0001b950: 6773 290a 2020 2020 2020 2020 2020 2020  gs).            
+0001b960: 6966 2069 7369 6e73 7461 6e63 6528 7072  if isinstance(pr
+0001b970: 696d 616c 732c 2053 6571 7565 6e63 6529  imals, Sequence)
+0001b980: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+0001b990: 2020 7265 7475 726e 2074 7265 655f 6d61    return tree_ma
+0001b9a0: 7028 6c61 6d62 6461 2078 3a20 564a 5044  p(lambda x: VJPD
+0001b9b0: 7561 6c28 782c 2074 7570 6c65 2829 292c  ual(x, tuple()),
+0001b9c0: 2070 7269 6d61 6c73 290a 2020 2020 2020   primals).      
+0001b9d0: 2020 2020 2020 7265 7475 726e 2056 4a50        return VJP
+0001b9e0: 4475 616c 2870 7269 6d61 6c73 2c20 7475  Dual(primals, tu
+0001b9f0: 706c 6528 2929 0a0a 2020 2020 2020 2020  ple())..        
+0001ba00: 7265 7475 726e 2070 6172 7469 616c 2876  return partial(v
+0001ba10: 6a70 5f69 6d70 6c5f 636f 6e73 742c 2073  jp_impl_const, s
+0001ba20: 796d 626f 6c29 0a0a 2020 2020 2320 4e6f  ymbol)..    # No
+0001ba30: 726d 616c 2063 6173 652c 2077 6520 6861  rmal case, we ha
+0001ba40: 7665 2061 2070 726f 7879 2074 616e 6765  ve a proxy tange
+0001ba50: 6e74 0a20 2020 2076 6a70 5f69 6d70 6c20  nt.    vjp_impl 
+0001ba60: 3d20 6175 676d 656e 7465 645f 666f 7277  = augmented_forw
+0001ba70: 6172 645f 696d 706c 732e 6765 7428 7379  ard_impls.get(sy
+0001ba80: 6d62 6f6c 2e73 796d 2e69 6429 0a0a 2020  mbol.sym.id)..  
+0001ba90: 2020 6966 205f 6765 745f 6772 6164 666e    if _get_gradfn
+0001baa0: 5f61 6e64 5f65 7865 6375 746f 7228 7379  _and_executor(sy
+0001bab0: 6d62 6f6c 295b 305d 2069 7320 6e6f 7420  mbol)[0] is not 
+0001bac0: 4e6f 6e65 3a0a 2020 2020 2020 2020 766a  None:.        vj
+0001bad0: 705f 696d 706c 2c20 6261 636b 7761 7264  p_impl, backward
+0001bae0: 5f66 6e20 3d20 6d61 6b65 5f61 7567 5f66  _fn = make_aug_f
+0001baf0: 6f72 7761 7264 5f61 6e64 5f62 6163 6b77  orward_and_backw
+0001bb00: 6172 6428 7379 6d62 6f6c 290a 0a20 2020  ard(symbol)..   
+0001bb10: 2069 6620 766a 705f 696d 706c 2069 7320   if vjp_impl is 
+0001bb20: 4e6f 6e65 3a0a 2020 2020 2020 2020 2320  None:.        # 
+0001bb30: 5765 2063 6f75 6c64 206e 6f74 2066 696e  We could not fin
+0001bb40: 6420 6120 564a 5020 666f 7220 7468 6973  d a VJP for this
+0001bb50: 2073 796d 626f 6c2c 2073 6f20 7765 2074   symbol, so we t
+0001bb60: 7279 2074 6f20 6465 636f 6d70 6f73 6520  ry to decompose 
+0001bb70: 6974 0a20 2020 2020 2020 2069 6620 6c65  it.        if le
+0001bb80: 6e28 7379 6d62 6f6c 2e73 7562 7379 6d62  n(symbol.subsymb
+0001bb90: 6f6c 7329 203e 2030 2061 6e64 206e 6f74  ols) > 0 and not
+0001bba0: 2069 7369 6e73 7461 6e63 6528 7379 6d62   isinstance(symb
+0001bbb0: 6f6c 2e73 796d 2e69 642c 2070 7269 6d73  ol.sym.id, prims
+0001bbc0: 2e50 7269 6d49 4473 293a 0a20 2020 2020  .PrimIDs):.     
+0001bbd0: 2020 2020 2020 2076 6a70 5f69 6d70 6c20         vjp_impl 
+0001bbe0: 3d20 7061 7274 6961 6c28 6465 636f 6d70  = partial(decomp
+0001bbf0: 6f73 6564 5f66 6e5f 6175 675f 6677 645f  osed_fn_aug_fwd_
+0001bc00: 7275 6c65 2c20 6465 636f 6d70 6f73 6564  rule, decomposed
+0001bc10: 5f66 6e3d 7379 6d62 6f6c 2e73 796d 290a  _fn=symbol.sym).
+0001bc20: 2020 2020 2020 2020 656c 7365 3a0a 2020          else:.  
+0001bc30: 2020 2020 2020 2020 2020 2320 5765 2063            # We c
+0001bc40: 6f75 6c64 206e 6f74 2066 696e 6420 6120  ould not find a 
+0001bc50: 564a 5020 666f 7220 7468 6973 2073 796d  VJP for this sym
+0001bc60: 626f 6c20 616e 6420 7765 2063 6f75 6c64  bol and we could
+0001bc70: 206e 6f74 2064 6563 6f6d 706f 7365 2069   not decompose i
+0001bc80: 740a 2020 2020 2020 2020 2020 2020 2320  t.            # 
+0001bc90: 4974 2063 6f75 6c64 2062 6520 6120 746f  It could be a to
+0001bca0: 7263 682e 6472 6f70 6f75 7420 7769 7468  rch.dropout with
+0001bcb0: 2030 2e30 2070 726f 6261 6269 6c69 7479   0.0 probability
+0001bcc0: 2c20 736f 2077 6520 736b 6970 2069 740a  , so we skip it.
+0001bcd0: 2020 2020 2020 2020 2020 2020 6966 2073              if s
+0001bce0: 796d 626f 6c2e 7379 6d2e 6964 203d 3d20  ymbol.sym.id == 
+0001bcf0: 2274 6f72 6368 2e6e 6e2e 6675 6e63 7469  "torch.nn.functi
+0001bd00: 6f6e 616c 2e64 726f 706f 7574 223a 0a20  onal.dropout":. 
+0001bd10: 2020 2020 2020 2020 2020 2020 2020 2072                 r
+0001bd20: 6574 7572 6e20 4e6f 6e65 0a20 2020 2020  eturn None.     
+0001bd30: 2020 2020 2020 2070 7269 6e74 2866 2256         print(f"V
+0001bd40: 4a50 2066 6f72 207b 7379 6d62 6f6c 7d20  JP for {symbol} 
+0001bd50: 6973 206e 6f74 2069 6d70 6c65 6d65 6e74  is not implement
+0001bd60: 6564 2229 0a20 2020 2020 2020 2020 2020  ed").           
+0001bd70: 2072 6169 7365 204e 6f74 496d 706c 656d   raise NotImplem
+0001bd80: 656e 7465 6445 7272 6f72 2866 2256 4a50  entedError(f"VJP
+0001bd90: 2066 6f72 207b 7379 6d62 6f6c 2e73 796d   for {symbol.sym
+0001bda0: 2e69 647d 2069 7320 6e6f 7420 696d 706c  .id} is not impl
+0001bdb0: 656d 656e 7465 6422 290a 0a20 2020 2064  emented")..    d
+0001bdc0: 6566 205f 766a 705f 696d 706c 282a 6172  ef _vjp_impl(*ar
+0001bdd0: 6773 2c20 2a2a 6b77 6172 6773 293a 0a20  gs, **kwargs):. 
+0001bde0: 2020 2020 2020 2070 7269 6d61 6c73 2c20         primals, 
+0001bdf0: 6b77 6172 6773 203d 2074 7265 655f 6d61  kwargs = tree_ma
+0001be00: 7028 6c61 6d62 6461 2078 3a20 782e 7072  p(lambda x: x.pr
+0001be10: 696d 616c 2069 6620 6973 696e 7374 616e  imal if isinstan
+0001be20: 6365 2878 2c20 564a 5044 7561 6c29 2065  ce(x, VJPDual) e
+0001be30: 6c73 6520 782c 2028 6172 6773 2c20 6b77  lse x, (args, kw
+0001be40: 6172 6773 2929 0a20 2020 2020 2020 206f  args)).        o
+0001be50: 7574 5f70 7269 6d61 6c2c 206f 7574 5f72  ut_primal, out_r
+0001be60: 6573 6964 7561 6c73 203d 2076 6a70 5f69  esiduals = vjp_i
+0001be70: 6d70 6c28 2a70 7269 6d61 6c73 2c20 2a2a  mpl(*primals, **
+0001be80: 6b77 6172 6773 290a 0a20 2020 2020 2020  kwargs)..       
+0001be90: 2023 2057 6520 6172 6520 7361 7669 6e67   # We are saving
+0001bea0: 2074 6865 2072 6573 6964 7561 6c73 2061   the residuals a
+0001beb0: 6e64 2070 756c 6c62 6163 6b20 6f6e 6c79  nd pullback only
+0001bec0: 2069 6e20 7468 6520 6669 7273 7420 6f75   in the first ou
+0001bed0: 7470 7574 0a20 2020 2020 2020 2023 2062  tput.        # b
+0001bee0: 6163 6b77 6172 645f 7061 7373 2074 6865  ackward_pass the
+0001bef0: 6e20 7265 7472 6965 7665 7320 7468 6520  n retrieves the 
+0001bf00: 7265 7369 6475 616c 7320 616e 6420 7075  residuals and pu
+0001bf10: 6c6c 6261 636b 2066 726f 6d20 7468 6520  llback from the 
+0001bf20: 6669 7273 7420 6f75 7470 7574 0a20 2020  first output.   
+0001bf30: 2020 2020 2069 6620 6973 696e 7374 616e       if isinstan
+0001bf40: 6365 286f 7574 5f70 7269 6d61 6c2c 2053  ce(out_primal, S
+0001bf50: 6571 7565 6e63 6529 3a0a 2020 2020 2020  equence):.      
+0001bf60: 2020 2020 2020 7265 7475 726e 2028 564a        return (VJ
+0001bf70: 5044 7561 6c28 6f75 745f 7072 696d 616c  PDual(out_primal
+0001bf80: 5b30 5d2c 206f 7574 5f72 6573 6964 7561  [0], out_residua
+0001bf90: 6c73 292c 202a 2856 4a50 4475 616c 286f  ls), *(VJPDual(o
+0001bfa0: 2c20 7475 706c 6528 2929 2066 6f72 206f  , tuple()) for o
+0001bfb0: 2069 6e20 6f75 745f 7072 696d 616c 5b31   in out_primal[1
+0001bfc0: 3a5d 2929 0a0a 2020 2020 2020 2020 7265  :]))..        re
+0001bfd0: 7475 726e 2028 564a 5044 7561 6c28 6f75  turn (VJPDual(ou
+0001bfe0: 745f 7072 696d 616c 2c20 6f75 745f 7265  t_primal, out_re
+0001bff0: 7369 6475 616c 7329 2c29 0a0a 2020 2020  siduals),)..    
+0001c000: 7265 7475 726e 205f 766a 705f 696d 706c  return _vjp_impl
+0001c010: 0a0a 0a64 6566 2063 6865 636b 5f62 7379  ...def check_bsy
+0001c020: 6d5f 666f 725f 766a 7028 6273 796d 293a  m_for_vjp(bsym):
+0001c030: 0a20 2020 2022 2222 0a20 2020 2043 6865  .    """.    Che
+0001c040: 636b 2069 6620 6120 626f 756e 6420 7379  ck if a bound sy
+0001c050: 6d62 6f6c 2069 7320 7375 7070 6f72 7465  mbol is supporte
+0001c060: 6420 6279 2076 6a70 2e0a 0a20 2020 2041  d by vjp...    A
+0001c070: 7267 733a 0a20 2020 2020 2020 2062 7379  rgs:.        bsy
+0001c080: 6d20 2842 6f75 6e64 5379 6d62 6f6c 293a  m (BoundSymbol):
+0001c090: 2054 6865 2062 6f75 6e64 2073 796d 626f   The bound symbo
+0001c0a0: 6c20 746f 2063 6865 636b 2e0a 0a20 2020  l to check...   
+0001c0b0: 2052 6574 7572 6e73 3a0a 2020 2020 2020   Returns:.      
+0001c0c0: 2020 626f 6f6c 3a20 5472 7565 2069 6620    bool: True if 
+0001c0d0: 7468 6520 626f 756e 6420 7379 6d62 6f6c  the bound symbol
+0001c0e0: 2069 7320 7375 7070 6f72 7465 6420 6279   is supported by
+0001c0f0: 2076 6a70 2c20 4661 6c73 6520 6f74 6865   vjp, False othe
+0001c100: 7277 6973 652e 0a20 2020 2022 2222 0a0a  rwise..    """..
+0001c110: 2020 2020 6966 2062 7379 6d2e 7379 6d2e      if bsym.sym.
+0001c120: 6964 2069 6e20 7472 616e 7366 6f72 6d5f  id in transform_
+0001c130: 736b 6970 5f6c 6973 743a 0a20 2020 2020  skip_list:.     
+0001c140: 2020 2072 6574 7572 6e20 5472 7565 0a0a     return True..
+0001c150: 2020 2020 6966 2062 7379 6d2e 7379 6d2e      if bsym.sym.
+0001c160: 6964 2069 6e20 6261 636b 7761 7264 5f69  id in backward_i
+0001c170: 6d70 6c73 2061 6e64 2062 7379 6d2e 7379  mpls and bsym.sy
+0001c180: 6d2e 6964 2069 6e20 6175 676d 656e 7465  m.id in augmente
+0001c190: 645f 666f 7277 6172 645f 696d 706c 733a  d_forward_impls:
+0001c1a0: 0a20 2020 2020 2020 2072 6574 7572 6e20  .        return 
+0001c1b0: 5472 7565 0a0a 2020 2020 6966 2062 7379  True..    if bsy
+0001c1c0: 6d2e 7379 6d2e 6964 2069 6e20 5f67 7261  m.sym.id in _gra
+0001c1d0: 645f 666e 5f6d 6170 3a0a 2020 2020 2020  d_fn_map:.      
+0001c1e0: 2020 7265 7475 726e 2054 7275 650a 0a20    return True.. 
+0001c1f0: 2020 2023 2057 6520 636f 756c 6420 6e6f     # We could no
+0001c200: 7420 6669 6e64 2061 2056 4a50 2066 6f72  t find a VJP for
+0001c210: 2074 6869 7320 7379 6d62 6f6c 2c20 736f   this symbol, so
+0001c220: 2077 6520 7472 7920 746f 2064 6563 6f6d   we try to decom
+0001c230: 706f 7365 2069 740a 2020 2020 2320 696e  pose it.    # in
+0001c240: 746f 2073 7562 2d73 796d 626f 6c73 2061  to sub-symbols a
+0001c250: 6e64 2063 6865 636b 2069 6620 7468 6579  nd check if they
+0001c260: 2061 7265 2073 7570 706f 7274 6564 0a20   are supported. 
+0001c270: 2020 2069 6620 6c65 6e28 6273 796d 2e73     if len(bsym.s
+0001c280: 7562 7379 6d62 6f6c 7329 203e 2030 2061  ubsymbols) > 0 a
+0001c290: 6e64 206e 6f74 2062 7379 6d2e 7379 6d2e  nd not bsym.sym.
+0001c2a0: 6973 5f70 7269 6d3a 0a20 2020 2020 2020  is_prim:.       
+0001c2b0: 2073 7562 7472 6163 6520 3d20 636f 6e73   subtrace = cons
+0001c2c0: 7472 7563 745f 7472 6163 6528 2928 6273  truct_trace()(bs
+0001c2d0: 796d 2e73 796d 2c20 2a62 7379 6d2e 6172  ym.sym, *bsym.ar
+0001c2e0: 6773 2c20 2a2a 6273 796d 2e6b 7761 7267  gs, **bsym.kwarg
+0001c2f0: 7329 0a20 2020 2020 2020 2073 7562 7472  s).        subtr
+0001c300: 6163 6520 3d20 756e 7772 6170 5f6f 6e65  ace = unwrap_one
+0001c310: 5f6c 6576 656c 5f6f 665f 7375 6273 796d  _level_of_subsym
+0001c320: 626f 6c73 2873 7562 7472 6163 6529 0a20  bols(subtrace). 
+0001c330: 2020 2020 2020 2061 6c6c 5f73 7570 706f         all_suppo
+0001c340: 7274 6564 203d 2061 6c6c 2863 6865 636b  rted = all(check
+0001c350: 5f62 7379 6d5f 666f 725f 766a 7028 7375  _bsym_for_vjp(su
+0001c360: 6262 7379 6d29 2066 6f72 2073 7562 6273  bbsym) for subbs
+0001c370: 796d 2069 6e20 7375 6274 7261 6365 2e62  ym in subtrace.b
+0001c380: 6f75 6e64 5f73 796d 626f 6c73 290a 2020  ound_symbols).  
+0001c390: 2020 2020 2020 7265 7475 726e 2061 6c6c        return all
+0001c3a0: 5f73 7570 706f 7274 6564 0a0a 2020 2020  _supported..    
+0001c3b0: 7265 7475 726e 2046 616c 7365 0a0a 0a64  return False...d
+0001c3c0: 6566 2061 7567 6d65 6e74 6564 5f66 6f72  ef augmented_for
+0001c3d0: 7761 7264 5f70 6173 7328 2a61 7267 732c  ward_pass(*args,
+0001c3e0: 2074 7261 6365 3a20 5472 6163 652c 202a   trace: Trace, *
+0001c3f0: 2a6b 7761 7267 7329 3a0a 2020 2020 2222  *kwargs):.    ""
+0001c400: 2241 7567 6d65 6e74 6564 2066 6f72 7761  "Augmented forwa
+0001c410: 7264 2070 6173 7320 666f 7220 7468 6520  rd pass for the 
+0001c420: 564a 5020 7472 616e 7366 6f72 6d2e 0a0a  VJP transform...
+0001c430: 2020 2020 5468 6520 6175 676d 656e 7465      The augmente
+0001c440: 6420 666f 7277 6172 6420 7061 7373 2069  d forward pass i
+0001c450: 7320 6120 666f 7277 6172 6420 7061 7373  s a forward pass
+0001c460: 2074 6861 7420 7265 7475 726e 7320 7468   that returns th
+0001c470: 6520 7265 7369 6475 616c 730a 2020 2020  e residuals.    
+0001c480: 6f66 2074 6865 2066 6f72 7761 7264 2070  of the forward p
+0001c490: 6173 732e 0a20 2020 2054 6865 7365 2072  ass..    These r
+0001c4a0: 6573 6964 7561 6c73 2061 7265 2075 7365  esiduals are use
+0001c4b0: 6420 696e 2074 6865 2062 6163 6b77 6172  d in the backwar
+0001c4c0: 6420 7061 7373 2074 6f20 636f 6d70 7574  d pass to comput
+0001c4d0: 6520 7468 6520 564a 5020 616e 6420 7468  e the VJP and th
+0001c4e0: 6579 0a20 2020 2061 7265 2072 6563 6f72  ey.    are recor
+0001c4f0: 6465 6420 696e 2074 6865 2065 6e76 6972  ded in the envir
+0001c500: 6f6e 6d65 6e74 2064 6963 7469 6f6e 6172  onment dictionar
+0001c510: 7920 666f 7220 6561 6368 2076 6172 6961  y for each varia
+0001c520: 626c 652e 0a0a 2020 2020 4172 6773 3a0a  ble...    Args:.
+0001c530: 2020 2020 2020 2020 6172 6773 2028 5475          args (Tu
+0001c540: 706c 655b 5661 7269 6162 6c65 5d29 3a20  ple[Variable]): 
+0001c550: 4172 6775 6d65 6e74 7320 746f 2074 6865  Arguments to the
+0001c560: 2066 756e 6374 696f 6e2e 0a20 2020 2020   function..     
+0001c570: 2020 2074 7261 6365 2028 5472 6163 6529     trace (Trace)
+0001c580: 3a20 5472 6163 6520 6f66 2074 6865 2066  : Trace of the f
+0001c590: 756e 6374 696f 6e2e 0a20 2020 2020 2020  unction..       
+0001c5a0: 206b 7761 7267 7320 2844 6963 745b 7374   kwargs (Dict[st
+0001c5b0: 722c 2056 6172 6961 626c 655d 293a 204b  r, Variable]): K
+0001c5c0: 6579 776f 7264 2061 7267 756d 656e 7473  eyword arguments
+0001c5d0: 2074 6f20 7468 6520 6675 6e63 7469 6f6e   to the function
+0001c5e0: 2e0a 0a20 2020 2052 6574 7572 6e73 3a0a  ...    Returns:.
+0001c5f0: 2020 2020 2020 2020 5475 706c 655b 416e          Tuple[An
+0001c600: 792c 2044 6963 745b 7374 722c 2041 6e79  y, Dict[str, Any
+0001c610: 5d5d 3a20 5475 706c 6520 6f66 2074 6865  ]]: Tuple of the
+0001c620: 2070 7269 6d61 6c20 6f75 7470 7574 7320   primal outputs 
+0001c630: 616e 6420 7468 6520 656e 7669 726f 6e6d  and the environm
+0001c640: 656e 742e 0a20 2020 2022 2222 0a20 2020  ent..    """.   
+0001c650: 2061 7267 732c 206b 7761 7267 7320 3d20   args, kwargs = 
+0001c660: 7472 6565 5f6d 6170 286c 616d 6264 6120  tree_map(lambda 
+0001c670: 783a 2056 4a50 4475 616c 2878 2c20 7475  x: VJPDual(x, tu
+0001c680: 706c 6528 2929 2c20 2861 7267 732c 206b  ple()), (args, k
+0001c690: 7761 7267 7329 290a 2020 2020 7265 7375  wargs)).    resu
+0001c6a0: 6c74 2c20 656e 7620 3d20 6576 616c 5f74  lt, env = eval_t
+0001c6b0: 7261 6365 280a 2020 2020 2020 2020 7472  race(.        tr
+0001c6c0: 6163 652c 0a20 2020 2020 2020 202a 6172  ace,.        *ar
+0001c6d0: 6773 2c0a 2020 2020 2020 2020 2a2a 6b77  gs,.        **kw
+0001c6e0: 6172 6773 2c0a 2020 2020 2020 2020 7769  args,.        wi
+0001c6f0: 7468 5f65 6e76 3d54 7275 652c 0a20 2020  th_env=True,.   
+0001c700: 2020 2020 2073 796d 626f 6c5f 6d61 7070       symbol_mapp
+0001c710: 6572 3d76 6a70 5f73 796d 626f 6c5f 6d61  er=vjp_symbol_ma
+0001c720: 7070 6572 2c0a 2020 2020 290a 2020 2020  pper,.    ).    
+0001c730: 7265 7375 6c74 203d 2074 7265 655f 6d61  result = tree_ma
+0001c740: 7028 6c61 6d62 6461 2078 3a20 782e 7072  p(lambda x: x.pr
+0001c750: 696d 616c 2069 6620 6973 696e 7374 616e  imal if isinstan
+0001c760: 6365 2878 2c20 564a 5044 7561 6c29 2065  ce(x, VJPDual) e
+0001c770: 6c73 6520 782c 2072 6573 756c 7429 0a20  lse x, result). 
+0001c780: 2020 2072 6574 7572 6e20 7265 7375 6c74     return result
+0001c790: 2c20 656e 760a 0a0a 2320 544f 444f 3a20  , env...# TODO: 
+0001c7a0: 496e 7374 6561 6420 6f66 2075 7369 6e67  Instead of using
+0001c7b0: 2074 6865 2065 6e76 6972 6f6e 6d65 6e74   the environment
+0001c7c0: 2064 6963 7469 6f6e 6172 792c 2077 6520   dictionary, we 
+0001c7d0: 636f 756c 6420 7573 6520 7468 6520 7472  could use the tr
+0001c7e0: 6163 650a 2320 7379 6d62 6f6c 7320 6f72  ace.# symbols or
+0001c7f0: 6465 7220 2874 6861 7420 7368 6f75 6c64  der (that should
+0001c800: 2062 6520 6465 7465 726d 696e 6973 7469   be deterministi
+0001c810: 6329 2074 6f20 7265 7472 6965 7665 2074  c) to retrieve t
+0001c820: 6865 2072 6573 6964 7561 6c73 206e 6565  he residuals nee
+0001c830: 6465 640a 2320 666f 7220 7468 6520 6261  ded.# for the ba
+0001c840: 636b 7761 7264 2070 6173 732e 0a64 6566  ckward pass..def
+0001c850: 2062 6163 6b77 6172 645f 7061 7373 2866   backward_pass(f
+0001c860: 6f72 7761 7264 5f65 6e76 2c20 7472 6163  orward_env, trac
+0001c870: 652c 2069 6e69 745f 636f 7461 6e67 656e  e, init_cotangen
+0001c880: 7473 293a 0a20 2020 2022 2222 4261 636b  ts):.    """Back
+0001c890: 7761 7264 2070 6173 7320 666f 7220 7468  ward pass for th
+0001c8a0: 6520 564a 5020 7472 616e 7366 6f72 6d2e  e VJP transform.
+0001c8b0: 0a0a 2020 2020 5468 6520 6261 636b 7761  ..    The backwa
+0001c8c0: 7264 2070 6173 7320 6973 2061 2072 6576  rd pass is a rev
+0001c8d0: 6572 7365 206d 6f64 6520 6175 746f 6d61  erse mode automa
+0001c8e0: 7469 6320 6469 6666 6572 656e 7469 6174  tic differentiat
+0001c8f0: 696f 6e20 7061 7373 2074 6861 740a 2020  ion pass that.  
+0001c900: 2020 636f 6d70 7574 6573 2074 6865 2076    computes the v
+0001c910: 6563 746f 722d 4a61 636f 6269 616e 2070  ector-Jacobian p
+0001c920: 726f 6475 6374 2028 564a 5029 206f 6620  roduct (VJP) of 
+0001c930: 7468 6520 6675 6e63 7469 6f6e 2e0a 0a20  the function... 
+0001c940: 2020 2041 7267 733a 0a20 2020 2020 2020     Args:.       
+0001c950: 2066 6f72 7761 7264 5f65 6e76 2028 4469   forward_env (Di
+0001c960: 6374 5b73 7472 2c20 416e 795d 293a 2045  ct[str, Any]): E
+0001c970: 6e76 6972 6f6e 6d65 6e74 206f 6620 7468  nvironment of th
+0001c980: 6520 666f 7277 6172 6420 7061 7373 2e0a  e forward pass..
+0001c990: 2020 2020 2020 2020 7472 6163 6520 2854          trace (T
+0001c9a0: 7261 6365 293a 2054 7261 6365 206f 6620  race): Trace of 
+0001c9b0: 7468 6520 6675 6e63 7469 6f6e 2e0a 2020  the function..  
+0001c9c0: 2020 2020 2020 696e 6974 5f63 6f74 616e        init_cotan
+0001c9d0: 6765 6e74 7320 2854 7570 6c65 5b56 6172  gents (Tuple[Var
+0001c9e0: 6961 626c 655d 293a 2049 6e69 7469 616c  iable]): Initial
+0001c9f0: 2063 6f74 616e 6765 6e74 732e 0a0a 2020   cotangents...  
+0001ca00: 2020 5265 7475 726e 733a 0a20 2020 2020    Returns:.     
+0001ca10: 2020 2054 7570 6c65 5b50 726f 7879 2c20     Tuple[Proxy, 
+0001ca20: 2e2e 2e5d 3a20 5475 706c 6520 6f66 2074  ...]: Tuple of t
+0001ca30: 6865 2072 6573 756c 7473 206f 6620 7468  he results of th
+0001ca40: 6520 6261 636b 7761 7264 2070 6173 7320  e backward pass 
+0001ca50: 666f 7220 6561 6368 2069 6e70 7574 2e0a  for each input..
+0001ca60: 2020 2020 2222 220a 2020 2020 656e 7620      """.    env 
+0001ca70: 3d20 7b7d 0a0a 2020 2020 6465 6620 6765  = {}..    def ge
+0001ca80: 745f 6772 6164 2878 3a20 5661 7269 6162  t_grad(x: Variab
+0001ca90: 6c65 293a 0a20 2020 2020 2020 2069 6620  le):.        if 
+0001caa0: 6973 696e 7374 616e 6365 2878 2c20 5661  isinstance(x, Va
+0001cab0: 7269 6162 6c65 293a 0a20 2020 2020 2020  riable):.       
+0001cac0: 2020 2020 2023 2052 6574 7572 6e20 4e6f       # Return No
+0001cad0: 6e65 2069 6620 7468 6520 7661 7269 6162  ne if the variab
+0001cae0: 6c65 2077 6173 206e 6f74 2075 7365 6420  le was not used 
+0001caf0: 696e 2074 6865 2063 6f6d 7075 7461 7469  in the computati
+0001cb00: 6f6e 2061 6e64 0a20 2020 2020 2020 2020  on and.         
+0001cb10: 2020 2023 2068 656e 6365 206e 6f74 2069     # hence not i
+0001cb20: 6e20 7468 6520 656e 760a 2020 2020 2020  n the env.      
+0001cb30: 2020 2020 2020 7265 7475 726e 2065 6e76        return env
+0001cb40: 2e67 6574 2878 2e6e 616d 652c 204e 6f6e  .get(x.name, Non
+0001cb50: 6529 0a20 2020 2020 2020 2065 6c73 653a  e).        else:
+0001cb60: 0a20 2020 2020 2020 2020 2020 2072 6574  .            ret
+0001cb70: 7572 6e20 780a 0a20 2020 2064 6566 2070  urn x..    def p
+0001cb80: 7574 5f67 7261 6428 763a 2056 6172 6961  ut_grad(v: Varia
+0001cb90: 626c 652c 2076 616c 3a20 416e 7929 202d  ble, val: Any) -
+0001cba0: 3e20 4e6f 6e65 3a0a 2020 2020 2020 2020  > None:.        
+0001cbb0: 6966 2069 7369 6e73 7461 6e63 6528 762c  if isinstance(v,
+0001cbc0: 2056 6172 6961 626c 6529 3a0a 2020 2020   Variable):.    
+0001cbd0: 2020 2020 2020 2020 6966 2076 2e6e 616d          if v.nam
+0001cbe0: 6520 696e 2065 6e76 3a0a 2020 2020 2020  e in env:.      
+0001cbf0: 2020 2020 2020 2020 2020 6966 2076 616c            if val
+0001cc00: 2069 7320 4e6f 6e65 3a0a 2020 2020 2020   is None:.      
+0001cc10: 2020 2020 2020 2020 2020 2020 2020 7265                re
+0001cc20: 7475 726e 0a20 2020 2020 2020 2020 2020  turn.           
+0001cc30: 2020 2020 2023 2041 6363 756d 756c 6174       # Accumulat
+0001cc40: 6520 636f 7461 6e67 656e 7473 0a20 2020  e cotangents.   
+0001cc50: 2020 2020 2020 2020 2020 2020 2065 6e76               env
+0001cc60: 5b76 2e6e 616d 655d 203d 2063 6c61 6e67  [v.name] = clang
+0001cc70: 2e61 6464 2865 6e76 5b76 2e6e 616d 655d  .add(env[v.name]
+0001cc80: 2c20 7661 6c29 2069 6620 656e 765b 762e  , val) if env[v.
+0001cc90: 6e61 6d65 5d20 6973 206e 6f74 204e 6f6e  name] is not Non
+0001cca0: 6520 656c 7365 2076 616c 0a20 2020 2020  e else val.     
+0001ccb0: 2020 2020 2020 2020 2020 2072 6574 7572             retur
+0001ccc0: 6e0a 2020 2020 2020 2020 2020 2020 656e  n.            en
+0001ccd0: 765b 762e 6e61 6d65 5d20 3d20 7661 6c0a  v[v.name] = val.
+0001cce0: 2020 2020 2020 2020 656c 6966 2069 7369          elif isi
+0001ccf0: 6e73 7461 6e63 6528 762c 2053 6571 7565  nstance(v, Seque
+0001cd00: 6e63 6529 2061 6e64 2061 6c6c 2869 7369  nce) and all(isi
+0001cd10: 6e73 7461 6e63 6528 782c 2069 6e74 2920  nstance(x, int) 
+0001cd20: 666f 7220 7820 696e 2076 293a 0a20 2020  for x in v):.   
+0001cd30: 2020 2020 2020 2020 2023 2054 4f44 4f3a           # TODO:
+0001cd40: 2072 656d 6f76 6520 7768 656e 2077 6520   remove when we 
+0001cd50: 6d6f 7665 2064 696d 7320 746f 206b 7761  move dims to kwa
+0001cd60: 7267 730a 2020 2020 2020 2020 2020 2020  rgs.            
+0001cd70: 7061 7373 0a20 2020 2020 2020 2065 6c69  pass.        eli
+0001cd80: 6620 6973 696e 7374 616e 6365 2876 2c20  f isinstance(v, 
+0001cd90: 7374 7229 3a0a 2020 2020 2020 2020 2020  str):.          
+0001cda0: 2020 656e 765b 765d 203d 2076 616c 0a20    env[v] = val. 
+0001cdb0: 2020 2020 2020 2065 6c69 6620 6973 696e         elif isin
+0001cdc0: 7374 616e 6365 2876 2c20 5365 7175 656e  stance(v, Sequen
+0001cdd0: 6365 2920 616e 6420 7661 6c20 6973 204e  ce) and val is N
+0001cde0: 6f6e 653a 0a20 2020 2020 2020 2020 2020  one:.           
+0001cdf0: 2023 2062 726f 6164 6361 7374 204e 6f6e   # broadcast Non
+0001ce00: 6520 746f 2074 6865 2072 6967 6874 2073  e to the right s
+0001ce10: 6861 7065 0a20 2020 2020 2020 2020 2020  hape.           
+0001ce20: 2073 6166 655f 6d61 7028 7075 745f 6772   safe_map(put_gr
+0001ce30: 6164 2c20 762c 205b 4e6f 6e65 5d20 2a20  ad, v, [None] * 
+0001ce40: 6c65 6e28 7629 290a 2020 2020 2020 2020  len(v)).        
+0001ce50: 656c 6966 2069 7369 6e73 7461 6e63 6528  elif isinstance(
+0001ce60: 762c 2053 6571 7565 6e63 6529 2061 6e64  v, Sequence) and
+0001ce70: 2069 7369 6e73 7461 6e63 6528 7661 6c2c   isinstance(val,
+0001ce80: 2053 6571 7565 6e63 6529 3a0a 2020 2020   Sequence):.    
+0001ce90: 2020 2020 2020 2020 7361 6665 5f6d 6170          safe_map
+0001cea0: 5f66 6c61 7428 7075 745f 6772 6164 2c20  _flat(put_grad, 
+0001ceb0: 762c 2076 616c 290a 2020 2020 2020 2020  v, val).        
+0001cec0: 656c 7365 3a0a 2020 2020 2020 2020 2020  else:.          
+0001ced0: 2020 2320 536b 6970 2077 7269 7469 6e67    # Skip writing
+0001cee0: 2074 6f20 636f 6e73 7461 6e74 730a 2020   to constants.  
+0001cef0: 2020 2020 2020 2020 2020 7061 7373 0a0a            pass..
+0001cf00: 2020 2020 6966 2069 7369 6e73 7461 6e63      if isinstanc
+0001cf10: 6528 696e 6974 5f63 6f74 616e 6765 6e74  e(init_cotangent
+0001cf20: 732c 2053 6571 7565 6e63 6529 2061 6e64  s, Sequence) and
+0001cf30: 206c 656e 2869 6e69 745f 636f 7461 6e67   len(init_cotang
+0001cf40: 656e 7473 2920 3d3d 2031 2061 6e64 206e  ents) == 1 and n
+0001cf50: 6f74 2069 7369 6e73 7461 6e63 6528 7472  ot isinstance(tr
+0001cf60: 6163 652e 6f75 7470 7574 2c20 5365 7175  ace.output, Sequ
+0001cf70: 656e 6365 293a 0a20 2020 2020 2020 2069  ence):.        i
+0001cf80: 6e69 745f 636f 7461 6e67 656e 7473 203d  nit_cotangents =
+0001cf90: 2069 6e69 745f 636f 7461 6e67 656e 7473   init_cotangents
+0001cfa0: 5b30 5d0a 2020 2020 7361 6665 5f6d 6170  [0].    safe_map
+0001cfb0: 5f66 6c61 7428 7075 745f 6772 6164 2c20  _flat(put_grad, 
+0001cfc0: 7472 6163 652e 6f75 7470 7574 2c20 696e  trace.output, in
+0001cfd0: 6974 5f63 6f74 616e 6765 6e74 7329 0a0a  it_cotangents)..
+0001cfe0: 2020 2020 666f 7220 7379 6d62 6f6c 2069      for symbol i
+0001cff0: 6e20 7265 7665 7273 6564 286c 6973 7428  n reversed(list(
+0001d000: 6974 6572 5f62 6f75 6e64 5f73 796d 626f  iter_bound_symbo
+0001d010: 6c73 2874 7261 6365 2e62 6f75 6e64 5f73  ls(trace.bound_s
+0001d020: 796d 626f 6c73 2929 293a 0a20 2020 2020  ymbols))):.     
+0001d030: 2020 2073 796d 626f 6c5f 6f75 7470 7574     symbol_output
+0001d040: 203d 2073 6571 7565 6e63 6966 7928 7379   = sequencify(sy
+0001d050: 6d62 6f6c 2e6f 7574 7075 7429 0a0a 2020  mbol.output)..  
+0001d060: 2020 2020 2020 636f 7461 6e67 656e 7473        cotangents
+0001d070: 203d 2074 7265 655f 6d61 7028 6765 745f   = tree_map(get_
+0001d080: 6772 6164 2c20 7379 6d62 6f6c 5f6f 7574  grad, symbol_out
+0001d090: 7075 7429 0a20 2020 2020 2020 2023 2048  put).        # H
+0001d0a0: 6176 696e 6720 6120 7369 6e67 6c65 2063  aving a single c
+0001d0b0: 6f74 616e 6765 6e74 2069 7320 6120 636f  otangent is a co
+0001d0c0: 6d6d 6f6e 2063 6173 652c 2073 6f20 7765  mmon case, so we
+0001d0d0: 2066 6c61 7474 656e 2069 740a 2020 2020   flatten it.    
+0001d0e0: 2020 2020 2320 4f74 6865 7277 6973 652c      # Otherwise,
+0001d0f0: 2077 6520 7769 6c6c 206e 6565 6420 746f   we will need to
+0001d100: 2072 6577 7269 7465 2074 6865 2070 756c   rewrite the pul
+0001d110: 6c62 6163 6b20 6675 6e63 7469 6f6e 730a  lback functions.
+0001d120: 2020 2020 2020 2020 636f 7461 6e67 656e          cotangen
+0001d130: 7473 203d 2074 7265 655f 666c 6174 7465  ts = tree_flatte
+0001d140: 6e28 636f 7461 6e67 656e 7473 295b 305d  n(cotangents)[0]
+0001d150: 0a20 2020 2020 2020 2072 6573 6964 7561  .        residua
+0001d160: 6c73 203d 2066 6f72 7761 7264 5f65 6e76  ls = forward_env
+0001d170: 5b73 796d 626f 6c5f 6f75 7470 7574 5b30  [symbol_output[0
+0001d180: 5d2e 6e61 6d65 5d2e 7265 7369 6475 616c  ].name].residual
+0001d190: 730a 2020 2020 2020 2020 6966 2069 735f  s.        if is_
+0001d1a0: 636f 6e73 7461 6e74 5f66 6f72 5f76 6a70  constant_for_vjp
+0001d1b0: 2873 796d 626f 6c29 3a0a 2020 2020 2020  (symbol):.      
+0001d1c0: 2020 2020 2020 2320 5765 2063 616e 2073        # We can s
+0001d1d0: 6b69 7020 7468 6520 7075 6c6c 6261 636b  kip the pullback
+0001d1e0: 2069 6620 616c 6c20 7468 6520 6172 6775   if all the argu
+0001d1f0: 6d65 6e74 7320 6172 6520 636f 6e73 7461  ments are consta
+0001d200: 6e74 0a20 2020 2020 2020 2020 2020 2063  nt.            c
+0001d210: 6f6e 7469 6e75 650a 0a20 2020 2020 2020  ontinue..       
+0001d220: 2069 6620 616c 6c28 636f 7461 6e67 656e   if all(cotangen
+0001d230: 7420 6973 204e 6f6e 6520 666f 7220 636f  t is None for co
+0001d240: 7461 6e67 656e 7420 696e 2063 6f74 616e  tangent in cotan
+0001d250: 6765 6e74 7329 3a0a 2020 2020 2020 2020  gents):.        
+0001d260: 2020 2020 2320 5765 2063 616e 2073 6b69      # We can ski
+0001d270: 7020 7468 6520 7075 6c6c 6261 636b 2069  p the pullback i
+0001d280: 6620 7468 6520 636f 7461 6e67 656e 7420  f the cotangent 
+0001d290: 6973 204e 6f6e 650a 2020 2020 2020 2020  is None.        
+0001d2a0: 2020 2020 7361 6665 5f6d 6170 2870 7574      safe_map(put
+0001d2b0: 5f67 7261 642c 2073 796d 626f 6c2e 6172  _grad, symbol.ar
+0001d2c0: 6773 2c20 284e 6f6e 652c 2920 2a20 6c65  gs, (None,) * le
+0001d2d0: 6e28 7379 6d62 6f6c 2e61 7267 7329 290a  n(symbol.args)).
 0001d2e0: 2020 2020 2020 2020 2020 2020 636f 6e74              cont
 0001d2f0: 696e 7565 0a0a 2020 2020 2020 2020 6966  inue..        if
-0001d300: 2061 6c6c 2863 6f74 616e 6765 6e74 2069   all(cotangent i
-0001d310: 7320 4e6f 6e65 2066 6f72 2063 6f74 616e  s None for cotan
-0001d320: 6765 6e74 2069 6e20 636f 7461 6e67 656e  gent in cotangen
-0001d330: 7473 293a 0a20 2020 2020 2020 2020 2020  ts):.           
-0001d340: 2023 2057 6520 6361 6e20 736b 6970 2074   # We can skip t
-0001d350: 6865 2070 756c 6c62 6163 6b20 6966 2074  he pullback if t
-0001d360: 6865 2063 6f74 616e 6765 6e74 2069 7320  he cotangent is 
-0001d370: 4e6f 6e65 0a20 2020 2020 2020 2020 2020  None.           
-0001d380: 2073 6166 655f 6d61 7028 7075 745f 6772   safe_map(put_gr
-0001d390: 6164 2c20 7379 6d62 6f6c 2e61 7267 732c  ad, symbol.args,
-0001d3a0: 2028 4e6f 6e65 2c29 202a 206c 656e 2873   (None,) * len(s
-0001d3b0: 796d 626f 6c2e 6172 6773 2929 0a20 2020  ymbol.args)).   
-0001d3c0: 2020 2020 2020 2020 2063 6f6e 7469 6e75           continu
-0001d3d0: 650a 0a20 2020 2020 2020 2069 6620 7379  e..        if sy
-0001d3e0: 6d62 6f6c 2e73 796d 2e69 6420 3d3d 2022  mbol.sym.id == "
-0001d3f0: 746f 7263 682e 6e6e 2e66 756e 6374 696f  torch.nn.functio
-0001d400: 6e61 6c2e 6472 6f70 6f75 7422 2061 6e64  nal.dropout" and
-0001d410: 206e 6f74 2073 796d 626f 6c2e 7375 6273   not symbol.subs
-0001d420: 796d 626f 6c73 3a0a 2020 2020 2020 2020  ymbols:.        
-0001d430: 2020 2020 2320 5765 2063 616e 2073 6b69      # We can ski
-0001d440: 7020 7468 6520 7075 6c6c 6261 636b 2069  p the pullback i
-0001d450: 6620 7468 6520 6472 6f70 6f75 7420 7072  f the dropout pr
-0001d460: 6f62 6162 696c 6974 7920 6973 2030 2e30  obability is 0.0
-0001d470: 0a20 2020 2020 2020 2020 2020 2023 2041  .            # A
-0001d480: 7373 756d 696e 6720 7468 6174 2074 6865  ssuming that the
-0001d490: 2064 726f 706f 7574 2073 796d 626f 6c20   dropout symbol 
-0001d4a0: 6861 7320 7468 6520 7361 6d65 206f 7574  has the same out
-0001d4b0: 7075 7420 616e 6420 6172 6775 6d65 6e74  put and argument
-0001d4c0: 0a20 2020 2020 2020 2020 2020 2061 7373  .            ass
-0001d4d0: 6572 7420 7379 6d62 6f6c 2e6f 7574 7075  ert symbol.outpu
-0001d4e0: 742e 6e61 6d65 203d 3d20 7379 6d62 6f6c  t.name == symbol
-0001d4f0: 2e61 7267 735b 305d 2e6e 616d 652c 2022  .args[0].name, "
-0001d500: 4472 6f70 6f75 7420 7379 6d62 6f6c 2068  Dropout symbol h
-0001d510: 6173 2061 2064 6966 6665 7265 6e74 206f  as a different o
-0001d520: 7574 7075 7420 616e 6420 6172 6775 6d65  utput and argume
-0001d530: 6e74 220a 2020 2020 2020 2020 2020 2020  nt".            
-0001d540: 6966 2073 796d 626f 6c2e 6172 6773 5b31  if symbol.args[1
-0001d550: 5d20 3d3d 2030 2e30 206f 7220 7379 6d62  ] == 0.0 or symb
-0001d560: 6f6c 2e61 7267 735b 325d 2069 7320 4661  ol.args[2] is Fa
-0001d570: 6c73 653a 0a20 2020 2020 2020 2020 2020  lse:.           
-0001d580: 2020 2020 2063 6f6e 7469 6e75 650a 0a20       continue.. 
-0001d590: 2020 2020 2020 2062 6163 6b77 6172 6420         backward 
-0001d5a0: 3d20 6261 636b 7761 7264 5f69 6d70 6c73  = backward_impls
-0001d5b0: 2e67 6574 2873 796d 626f 6c2e 7379 6d2e  .get(symbol.sym.
-0001d5c0: 6964 290a 2020 2020 2020 2020 6175 675f  id).        aug_
-0001d5d0: 666f 7277 6172 6420 3d20 6175 676d 656e  forward = augmen
-0001d5e0: 7465 645f 666f 7277 6172 645f 696d 706c  ted_forward_impl
-0001d5f0: 732e 6765 7428 7379 6d62 6f6c 2e73 796d  s.get(symbol.sym
-0001d600: 2e69 6429 0a0a 2020 2020 2020 2020 6966  .id)..        if
-0001d610: 205f 6765 745f 6772 6164 666e 5f61 6e64   _get_gradfn_and
-0001d620: 5f65 7865 6375 746f 7228 7379 6d62 6f6c  _executor(symbol
-0001d630: 295b 305d 2069 7320 6e6f 7420 4e6f 6e65  )[0] is not None
-0001d640: 3a0a 2020 2020 2020 2020 2020 2020 6175  :.            au
-0001d650: 675f 666f 7277 6172 642c 2062 6163 6b77  g_forward, backw
-0001d660: 6172 6420 3d20 6d61 6b65 5f61 7567 5f66  ard = make_aug_f
-0001d670: 6f72 7761 7264 5f61 6e64 5f62 6163 6b77  orward_and_backw
-0001d680: 6172 6428 7379 6d62 6f6c 290a 0a20 2020  ard(symbol)..   
-0001d690: 2020 2020 2069 6620 6261 636b 7761 7264       if backward
-0001d6a0: 2069 7320 4e6f 6e65 3a0a 2020 2020 2020   is None:.      
-0001d6b0: 2020 2020 2020 6966 206c 656e 2873 796d        if len(sym
-0001d6c0: 626f 6c2e 7375 6273 796d 626f 6c73 2920  bol.subsymbols) 
-0001d6d0: 3e20 3020 616e 6420 6e6f 7420 6973 696e  > 0 and not isin
-0001d6e0: 7374 616e 6365 2873 796d 626f 6c2e 7379  stance(symbol.sy
-0001d6f0: 6d2e 6964 2c20 7072 696d 732e 5072 696d  m.id, prims.Prim
-0001d700: 4944 7329 3a0a 2020 2020 2020 2020 2020  IDs):.          
-0001d710: 2020 2020 2020 2320 5765 2063 6f75 6c64        # We could
-0001d720: 206e 6f74 2066 696e 6420 6120 6261 636b   not find a back
-0001d730: 7761 7264 2066 6f72 2074 6869 7320 7379  ward for this sy
-0001d740: 6d62 6f6c 2c20 736f 2077 6520 7472 7920  mbol, so we try 
-0001d750: 746f 2064 6563 6f6d 706f 7365 2069 740a  to decompose it.
-0001d760: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001d770: 6261 636b 7761 7264 203d 2070 6172 7469  backward = parti
-0001d780: 616c 2864 6563 6f6d 706f 7365 645f 666e  al(decomposed_fn
-0001d790: 5f62 6163 6b77 6172 645f 7275 6c65 2c20  _backward_rule, 
-0001d7a0: 7379 6d62 6f6c 2e73 796d 290a 2020 2020  symbol.sym).    
-0001d7b0: 2020 2020 2020 2020 656c 7365 3a0a 2020          else:.  
-0001d7c0: 2020 2020 2020 2020 2020 2020 2020 2320                # 
-0001d7d0: 5765 2063 6f75 6c64 206e 6f74 2066 696e  We could not fin
-0001d7e0: 6420 6120 6261 636b 7761 7264 2066 6f72  d a backward for
-0001d7f0: 2074 6869 7320 7379 6d62 6f6c 2061 6e64   this symbol and
-0001d800: 2077 6520 636f 756c 6420 6e6f 7420 6465   we could not de
-0001d810: 636f 6d70 6f73 6520 6974 0a20 2020 2020  compose it.     
-0001d820: 2020 2020 2020 2020 2020 2072 6169 7365             raise
-0001d830: 204e 6f74 496d 706c 656d 656e 7465 6445   NotImplementedE
-0001d840: 7272 6f72 2866 2242 6163 6b77 6172 6420  rror(f"Backward 
-0001d850: 666f 7220 7b73 796d 626f 6c2e 7379 6d2e  for {symbol.sym.
-0001d860: 6964 7d20 6973 206e 6f74 2069 6d70 6c65  id} is not imple
-0001d870: 6d65 6e74 6564 2229 0a0a 2020 2020 2020  mented")..      
-0001d880: 2020 7265 7375 6c74 203d 2062 6163 6b77    result = backw
-0001d890: 6172 6428 2a72 6573 6964 7561 6c73 2c20  ard(*residuals, 
-0001d8a0: 2a63 6f74 616e 6765 6e74 7329 0a20 2020  *cotangents).   
-0001d8b0: 2020 2020 2069 6620 6973 696e 7374 616e       if isinstan
-0001d8c0: 6365 2872 6573 756c 742c 2064 6963 7429  ce(result, dict)
-0001d8d0: 3a0a 2020 2020 2020 2020 2020 2020 2320  :.            # 
-0001d8e0: 4966 2074 6865 2062 6163 6b77 6172 6420  If the backward 
-0001d8f0: 7265 7475 726e 7320 6120 6469 6374 2c20  returns a dict, 
-0001d900: 7765 2061 7373 756d 6520 7468 6174 2069  we assume that i
-0001d910: 7420 6973 2061 2064 6963 7420 6f66 0a20  t is a dict of. 
-0001d920: 2020 2020 2020 2020 2020 2023 2066 6f72             # for
-0001d930: 7761 7264 2061 7267 756d 656e 7473 2074  ward arguments t
-0001d940: 6f20 7468 6520 636f 7272 6573 706f 6e64  o the correspond
-0001d950: 696e 670a 2020 2020 2020 2020 2020 2020  ing.            
-0001d960: 2320 6772 6164 6965 6e74 732f 636f 7461  # gradients/cota
-0001d970: 6e67 656e 7473 2f61 646a 6f69 6e74 732f  ngents/adjoints/
-0001d980: 7365 6e73 6974 6976 6974 6965 732e 0a20  sensitivities.. 
-0001d990: 2020 2020 2020 2020 2020 2075 7365 645f             used_
-0001d9a0: 6e61 6d65 7320 3d20 7365 7428 290a 2020  names = set().  
-0001d9b0: 2020 2020 2020 2020 2020 666f 7220 692c            for i,
-0001d9c0: 2028 6b2c 2076 2920 696e 2065 6e75 6d65   (k, v) in enume
-0001d9d0: 7261 7465 2869 6e73 7065 6374 2e73 6967  rate(inspect.sig
-0001d9e0: 6e61 7475 7265 2861 7567 5f66 6f72 7761  nature(aug_forwa
-0001d9f0: 7264 292e 7061 7261 6d65 7465 7273 2e69  rd).parameters.i
-0001da00: 7465 6d73 2829 293a 0a20 2020 2020 2020  tems()):.       
-0001da10: 2020 2020 2020 2020 2069 6620 762e 6b69           if v.ki
-0001da20: 6e64 2069 6e20 2869 6e73 7065 6374 2e50  nd in (inspect.P
-0001da30: 6172 616d 6574 6572 2e50 4f53 4954 494f  arameter.POSITIO
-0001da40: 4e41 4c5f 4f4e 4c59 2c20 696e 7370 6563  NAL_ONLY, inspec
-0001da50: 742e 5061 7261 6d65 7465 722e 504f 5349  t.Parameter.POSI
-0001da60: 5449 4f4e 414c 5f4f 525f 4b45 5957 4f52  TIONAL_OR_KEYWOR
-0001da70: 4429 3a0a 2020 2020 2020 2020 2020 2020  D):.            
-0001da80: 2020 2020 2020 2020 7075 745f 6772 6164          put_grad
-0001da90: 2873 796d 626f 6c2e 6172 6773 5b69 5d2c  (symbol.args[i],
-0001daa0: 2072 6573 756c 742e 6765 7428 6b2c 204e   result.get(k, N
-0001dab0: 6f6e 6529 290a 2020 2020 2020 2020 2020  one)).          
-0001dac0: 2020 2020 2020 2020 2020 7573 6564 5f6e            used_n
-0001dad0: 616d 6573 2e61 6464 286b 290a 0a20 2020  ames.add(k)..   
-0001dae0: 2020 2020 2020 2020 2023 2046 6f72 2064           # For d
-0001daf0: 6576 656c 6f70 6572 2063 6f6e 7665 6e69  eveloper conveni
-0001db00: 656e 6365 2c20 7765 2061 6c6c 6f77 2075  ence, we allow u
-0001db10: 7369 6e67 2074 6865 206e 616d 6520 6672  sing the name fr
-0001db20: 6f6d 2074 6865 0a20 2020 2020 2020 2020  om the.         
-0001db30: 2020 2023 2066 6f72 7761 7264 206d 6574     # forward met
-0001db40: 6120 696e 2061 6464 6974 696f 6e20 746f  a in addition to
-0001db50: 2074 6865 206e 616d 6520 6672 6f6d 2074   the name from t
-0001db60: 6865 2061 7567 6d65 6e74 6564 2066 6f72  he augmented for
-0001db70: 7761 7264 0a20 2020 2020 2020 2020 2020  ward.           
-0001db80: 2023 2073 6967 6e61 7475 7265 2e0a 2020   # signature..  
-0001db90: 2020 2020 2020 2020 2020 2320 4966 2062            # If b
-0001dba0: 6f74 6820 6e61 6d65 7320 6172 6520 7573  oth names are us
-0001dbb0: 6564 2c20 7468 6520 6f6e 6520 6672 6f6d  ed, the one from
-0001dbc0: 2074 6865 2066 6f72 7761 7264 206d 6574   the forward met
-0001dbd0: 6120 7461 6b65 730a 2020 2020 2020 2020  a takes.        
-0001dbe0: 2020 2020 2320 7072 6563 6564 656e 6365      # precedence
-0001dbf0: 2e0a 2020 2020 2020 2020 2020 2020 666f  ..            fo
-0001dc00: 7220 692c 2028 6b2c 2076 2920 696e 2065  r i, (k, v) in e
-0001dc10: 6e75 6d65 7261 7465 2869 6e73 7065 6374  numerate(inspect
-0001dc20: 2e73 6967 6e61 7475 7265 2873 796d 626f  .signature(symbo
-0001dc30: 6c2e 7379 6d2e 6d65 7461 292e 7061 7261  l.sym.meta).para
-0001dc40: 6d65 7465 7273 2e69 7465 6d73 2829 293a  meters.items()):
-0001dc50: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0001dc60: 2069 6620 762e 6b69 6e64 2069 6e20 2869   if v.kind in (i
-0001dc70: 6e73 7065 6374 2e50 6172 616d 6574 6572  nspect.Parameter
-0001dc80: 2e50 4f53 4954 494f 4e41 4c5f 4f4e 4c59  .POSITIONAL_ONLY
-0001dc90: 2c20 696e 7370 6563 742e 5061 7261 6d65  , inspect.Parame
-0001dca0: 7465 722e 504f 5349 5449 4f4e 414c 5f4f  ter.POSITIONAL_O
-0001dcb0: 525f 4b45 5957 4f52 4429 3a0a 2020 2020  R_KEYWORD):.    
-0001dcc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001dcd0: 6966 206b 206e 6f74 2069 6e20 7573 6564  if k not in used
-0001dce0: 5f6e 616d 6573 3a0a 2020 2020 2020 2020  _names:.        
-0001dcf0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001dd00: 7075 745f 6772 6164 2873 796d 626f 6c2e  put_grad(symbol.
-0001dd10: 6172 6773 5b69 5d2c 2072 6573 756c 742e  args[i], result.
-0001dd20: 6765 7428 6b2c 204e 6f6e 6529 290a 2020  get(k, None)).  
-0001dd30: 2020 2020 2020 2020 2020 636f 6e74 696e            contin
-0001dd40: 7565 0a0a 2020 2020 2020 2020 6966 206e  ue..        if n
-0001dd50: 6f74 2069 7369 6e73 7461 6e63 6528 7265  ot isinstance(re
-0001dd60: 7375 6c74 2c20 5365 7175 656e 6365 293a  sult, Sequence):
-0001dd70: 0a20 2020 2020 2020 2020 2020 2072 6573  .            res
-0001dd80: 756c 7420 3d20 2872 6573 756c 742c 290a  ult = (result,).
-0001dd90: 0a20 2020 2020 2020 2064 6566 2069 735f  .        def is_
-0001dda0: 6469 6666 6572 656e 7469 6162 6c65 2861  differentiable(a
-0001ddb0: 7267 293a 0a20 2020 2020 2020 2020 2020  rg):.           
-0001ddc0: 206d 6174 6368 2061 7267 3a0a 2020 2020   match arg:.    
-0001ddd0: 2020 2020 2020 2020 2020 2020 6361 7365              case
-0001dde0: 2054 656e 736f 7250 726f 7879 2829 3a0a   TensorProxy():.
-0001ddf0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001de00: 2020 2020 7265 7475 726e 2064 7479 7065      return dtype
-0001de10: 732e 6973 5f69 6e65 7861 6374 5f64 7479  s.is_inexact_dty
-0001de20: 7065 2861 7267 2e64 7479 7065 290a 2020  pe(arg.dtype).  
-0001de30: 2020 2020 2020 2020 2020 2020 2020 6361                ca
-0001de40: 7365 2053 6571 7565 6e63 6528 293a 0a20  se Sequence():. 
-0001de50: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001de60: 2020 2072 6574 7572 6e20 6172 6720 616e     return arg an
-0001de70: 6420 616c 6c28 6973 696e 7374 616e 6365  d all(isinstance
-0001de80: 2878 2c20 5465 6e73 6f72 5072 6f78 7929  (x, TensorProxy)
-0001de90: 2061 6e64 2064 7479 7065 732e 6973 5f69   and dtypes.is_i
-0001dea0: 6e65 7861 6374 5f64 7479 7065 2878 2e64  nexact_dtype(x.d
-0001deb0: 7479 7065 2920 666f 7220 7820 696e 2061  type) for x in a
-0001dec0: 7267 290a 2020 2020 2020 2020 2020 2020  rg).            
-0001ded0: 2020 2020 6361 7365 205f 3a0a 2020 2020      case _:.    
-0001dee0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001def0: 7265 7475 726e 2046 616c 7365 0a0a 2020  return False..  
-0001df00: 2020 2020 2020 6966 206c 656e 2873 796d        if len(sym
-0001df10: 626f 6c2e 6172 6773 2920 213d 2028 6f72  bol.args) != (or
-0001df20: 6967 5f72 6573 5f6c 656e 203a 3d20 6c65  ig_res_len := le
-0001df30: 6e28 7265 7375 6c74 2929 3a0a 2020 2020  n(result)):.    
-0001df40: 2020 2020 2020 2020 6368 6563 6b28 0a20          check(. 
-0001df50: 2020 2020 2020 2020 2020 2020 2020 206f                 o
-0001df60: 7269 675f 7265 735f 6c65 6e20 3c3d 206c  rig_res_len <= l
-0001df70: 656e 2873 796d 626f 6c2e 6172 6773 292c  en(symbol.args),
-0001df80: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0001df90: 206c 616d 6264 613a 2066 2242 6163 6b77   lambda: f"Backw
-0001dfa0: 6172 6420 666f 7220 7b73 796d 626f 6c2e  ard for {symbol.
-0001dfb0: 7379 6d2e 6964 7d20 7265 7475 726e 6564  sym.id} returned
-0001dfc0: 207b 6f72 6967 5f72 6573 5f6c 656e 7d20   {orig_res_len} 
-0001dfd0: 7661 6c75 6573 2c20 220a 2020 2020 2020  values, ".      
-0001dfe0: 2020 2020 2020 2020 2020 2b20 6622 6275            + f"bu
-0001dff0: 7420 6578 7065 6374 6564 2061 7420 6d6f  t expected at mo
-0001e000: 7374 207b 6c65 6e28 7379 6d62 6f6c 2e61  st {len(symbol.a
-0001e010: 7267 7329 7d22 2c0a 2020 2020 2020 2020  rgs)}",.        
-0001e020: 2020 2020 290a 2020 2020 2020 2020 2020      ).          
-0001e030: 2020 2320 4173 7375 6d69 6e67 2074 6861    # Assuming tha
-0001e040: 7420 7468 6520 6e6f 6e2d 6469 6666 6572  t the non-differ
-0001e050: 656e 7469 6162 6c65 2061 7267 756d 656e  entiable argumen
-0001e060: 7473 2077 6572 6520 6472 6f70 7065 6420  ts were dropped 
-0001e070: 6672 6f6d 0a20 2020 2020 2020 2020 2020  from.           
-0001e080: 2023 2074 6865 2062 6163 6b77 6172 6420   # the backward 
-0001e090: 6675 6e63 7469 6f6e 2c20 7765 2061 7265  function, we are
-0001e0a0: 2067 6f69 6e67 2074 6f20 6170 7065 6e64   going to append
-0001e0b0: 204e 6f6e 6520 746f 2074 6865 2072 6573   None to the res
-0001e0c0: 756c 740a 2020 2020 2020 2020 2020 2020  ult.            
-0001e0d0: 2320 746f 206d 6174 6368 2074 6865 206e  # to match the n
-0001e0e0: 756d 6265 7220 6f66 2061 7267 756d 656e  umber of argumen
-0001e0f0: 7473 2e20 416c 7465 726e 6174 6976 656c  ts. Alternativel
-0001e100: 792c 2077 6520 636f 756c 6420 6a75 7374  y, we could just
-0001e110: 0a20 2020 2020 2020 2020 2020 2023 2068  .            # h
-0001e120: 6176 6520 6120 666f 722d 6c6f 6f70 2077  ave a for-loop w
-0001e130: 6974 6820 6120 636f 6e64 6974 696f 6e61  ith a conditiona
-0001e140: 6c20 7768 656e 2077 7269 7469 6e67 2074  l when writing t
-0001e150: 6f20 7468 650a 2020 2020 2020 2020 2020  o the.          
-0001e160: 2020 2320 656e 7669 726f 6e6d 656e 742e    # environment.
-0001e170: 0a0a 2020 2020 2020 2020 2020 2020 6974  ..            it
-0001e180: 6572 5f72 6573 756c 7420 3d20 6974 6572  er_result = iter
-0001e190: 2872 6573 756c 7429 0a20 2020 2020 2020  (result).       
-0001e1a0: 2020 2020 206e 5f64 6966 6665 7265 6e74       n_different
-0001e1b0: 6961 626c 655f 6172 6773 203d 2073 756d  iable_args = sum
-0001e1c0: 2862 6f6f 6c28 6973 5f64 6966 6665 7265  (bool(is_differe
-0001e1d0: 6e74 6961 626c 6528 6172 6729 2920 666f  ntiable(arg)) fo
-0001e1e0: 7220 6172 6720 696e 2073 796d 626f 6c2e  r arg in symbol.
-0001e1f0: 6172 6773 290a 2020 2020 2020 2020 2020  args).          
-0001e200: 2020 6368 6563 6b28 0a20 2020 2020 2020    check(.       
-0001e210: 2020 2020 2020 2020 206e 5f64 6966 6665           n_diffe
-0001e220: 7265 6e74 6961 626c 655f 6172 6773 203c  rentiable_args <
-0001e230: 3d20 6f72 6967 5f72 6573 5f6c 656e 2c0a  = orig_res_len,.
-0001e240: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001e250: 6c61 6d62 6461 3a20 6622 4261 636b 7761  lambda: f"Backwa
-0001e260: 7264 2066 6f72 207b 7379 6d62 6f6c 2e73  rd for {symbol.s
-0001e270: 796d 2e69 647d 2072 6574 7572 6e65 6420  ym.id} returned 
-0001e280: 7b6f 7269 675f 7265 735f 6c65 6e7d 2076  {orig_res_len} v
-0001e290: 616c 7565 2873 292c 2022 0a20 2020 2020  alue(s), ".     
-0001e2a0: 2020 2020 2020 2020 2020 202b 2066 2262             + f"b
-0001e2b0: 7574 2065 7870 6563 7465 6420 7b6e 5f64  ut expected {n_d
-0001e2c0: 6966 6665 7265 6e74 6961 626c 655f 6172  ifferentiable_ar
-0001e2d0: 6773 7d22 2c0a 2020 2020 2020 2020 2020  gs}",.          
-0001e2e0: 2020 290a 0a20 2020 2020 2020 2020 2020    )..           
-0001e2f0: 2072 6573 756c 7420 3d20 7475 706c 6528   result = tuple(
-0001e300: 6e65 7874 2869 7465 725f 7265 7375 6c74  next(iter_result
-0001e310: 2920 6966 2069 735f 6469 6666 6572 656e  ) if is_differen
-0001e320: 7469 6162 6c65 2861 7267 2920 656c 7365  tiable(arg) else
-0001e330: 204e 6f6e 6520 666f 7220 6172 6720 696e   None for arg in
-0001e340: 2073 796d 626f 6c2e 6172 6773 290a 0a20   symbol.args).. 
-0001e350: 2020 2020 2020 2023 2053 6565 2022 4261         # See "Ba
-0001e360: 636b 7761 7264 2069 6d70 6c20 666f 7220  ckward impl for 
-0001e370: 6f70 7320 6f66 2074 6865 2074 7970 6520  ops of the type 
-0001e380: 5365 7175 656e 6365 5b54 656e 736f 7250  Sequence[TensorP
-0001e390: 726f 7879 5d2c 202e 2e2e 202d 3e20 2e2e  roxy], ... -> ..
-0001e3a0: 2e20 7265 7375 6c74 7320 696e 204e 6f6e  . results in Non
-0001e3b0: 6520 6772 6164 732e 220a 2020 2020 2020  e grads.".      
-0001e3c0: 2020 2320 5468 6973 2069 7320 6120 7465    # This is a te
-0001e3d0: 6d70 6f72 6172 7920 776f 726b 6172 6f75  mporary workarou
-0001e3e0: 6e64 2e0a 2020 2020 2020 2020 6966 2073  nd..        if s
-0001e3f0: 796d 626f 6c2e 7379 6d2e 6964 2069 6e20  ymbol.sym.id in 
-0001e400: 2870 7269 6d73 2e50 7269 6d49 4473 2e43  (prims.PrimIDs.C
-0001e410: 4154 2c20 2274 6f72 6368 2e63 6174 222c  AT, "torch.cat",
-0001e420: 2022 746f 7263 682e 7374 6163 6b22 293a   "torch.stack"):
-0001e430: 0a20 2020 2020 2020 2020 2020 2073 6166  .            saf
-0001e440: 655f 6d61 705f 666c 6174 2870 7574 5f67  e_map_flat(put_g
-0001e450: 7261 642c 2073 796d 626f 6c2e 6172 6773  rad, symbol.args
-0001e460: 2c20 7265 7375 6c74 290a 2020 2020 2020  , result).      
-0001e470: 2020 656c 7365 3a0a 2020 2020 2020 2020    else:.        
-0001e480: 2020 2020 7361 6665 5f6d 6170 2870 7574      safe_map(put
-0001e490: 5f67 7261 642c 2073 796d 626f 6c2e 6172  _grad, symbol.ar
-0001e4a0: 6773 2c20 7265 7375 6c74 290a 0a20 2020  gs, result)..   
-0001e4b0: 2064 6566 2067 6574 5f69 6e65 7861 6374   def get_inexact
-0001e4c0: 5f64 7479 7065 5f6f 725f 6e6f 6e65 2878  _dtype_or_none(x
-0001e4d0: 293a 0a20 2020 2020 2020 2069 6620 6973  ):.        if is
-0001e4e0: 696e 7374 616e 6365 2878 2c20 2854 656e  instance(x, (Ten
-0001e4f0: 736f 7250 726f 7879 2c20 4675 7475 7265  sorProxy, Future
-0001e500: 5465 6e73 6f72 5072 6f78 7929 2920 616e  TensorProxy)) an
-0001e510: 6420 6474 7970 6573 2e69 735f 696e 6578  d dtypes.is_inex
-0001e520: 6163 745f 6474 7970 6528 782e 6474 7970  act_dtype(x.dtyp
-0001e530: 6529 3a0a 2020 2020 2020 2020 2020 2020  e):.            
-0001e540: 7265 7475 726e 2078 0a20 2020 2020 2020  return x.       
-0001e550: 2065 6c73 653a 0a20 2020 2020 2020 2020   else:.         
-0001e560: 2020 2072 6574 7572 6e20 4e6f 6e65 0a0a     return None..
-0001e570: 2020 2020 6761 7267 7320 3d20 7472 6565      gargs = tree
-0001e580: 5f6d 6170 2867 6574 5f67 7261 642c 2074  _map(get_grad, t
-0001e590: 7570 6c65 2874 7261 6365 2e61 7267 7329  uple(trace.args)
-0001e5a0: 290a 2020 2020 676b 7761 7267 7320 3d20  ).    gkwargs = 
-0001e5b0: 7472 6565 5f6d 6170 2867 6574 5f67 7261  tree_map(get_gra
-0001e5c0: 642c 2074 7261 6365 2e6b 7761 7267 7329  d, trace.kwargs)
-0001e5d0: 0a20 2020 2067 6b77 6172 6773 203d 207b  .    gkwargs = {
-0001e5e0: 6b3a 2076 2066 6f72 206b 2c20 7620 696e  k: v for k, v in
-0001e5f0: 2067 6b77 6172 6773 2e69 7465 6d73 2829   gkwargs.items()
-0001e600: 2069 6620 7620 6973 206e 6f74 204e 6f6e   if v is not Non
-0001e610: 657d 0a20 2020 2067 6172 6773 2c20 676b  e}.    gargs, gk
-0001e620: 7761 7267 7320 3d20 7472 6565 5f6d 6170  wargs = tree_map
-0001e630: 2867 6574 5f69 6e65 7861 6374 5f64 7479  (get_inexact_dty
-0001e640: 7065 5f6f 725f 6e6f 6e65 2c20 2867 6172  pe_or_none, (gar
-0001e650: 6773 2c20 676b 7761 7267 7329 290a 2020  gs, gkwargs)).  
-0001e660: 2020 7265 7475 726e 2067 6172 6773 202b    return gargs +
-0001e670: 2028 676b 7761 7267 732c 2920 6966 206c   (gkwargs,) if l
-0001e680: 656e 2867 6b77 6172 6773 2920 213d 2030  en(gkwargs) != 0
-0001e690: 2065 6c73 6520 6761 7267 730a 0a0a 6465   else gargs...de
-0001e6a0: 6620 766a 705f 6361 6c6c 5f6d 6574 6166  f vjp_call_metaf
-0001e6b0: 756e 6328 6465 7461 6368 6564 3a20 626f  unc(detached: bo
-0001e6c0: 6f6c 2c20 7072 696d 616c 732c 2063 6f74  ol, primals, cot
-0001e6d0: 616e 6765 6e74 732c 2074 7261 6365 3a20  angents, trace: 
-0001e6e0: 5472 6163 652c 202a 2a6b 7761 7267 7329  Trace, **kwargs)
-0001e6f0: 3a0a 2020 2020 2320 4173 7375 6d69 6e67  :.    # Assuming
-0001e700: 2070 7269 6d61 6c73 2069 7320 666c 6174   primals is flat
-0001e710: 0a0a 2020 2020 6966 206e 6f74 2069 7369  ..    if not isi
-0001e720: 6e73 7461 6e63 6528 7072 696d 616c 732c  nstance(primals,
-0001e730: 2053 6571 7565 6e63 6529 3a0a 2020 2020   Sequence):.    
-0001e740: 2020 2020 7072 696d 616c 7320 3d20 2870      primals = (p
-0001e750: 7269 6d61 6c73 2c29 0a0a 2020 2020 6374  rimals,)..    ct
-0001e760: 7820 3d20 6465 7461 6368 6564 5f74 7261  x = detached_tra
-0001e770: 6365 2829 2069 6620 6465 7461 6368 6564  ce() if detached
-0001e780: 2065 6c73 6520 6e75 6c6c 636f 6e74 6578   else nullcontex
-0001e790: 7428 290a 2020 2020 7769 7468 2063 7478  t().    with ctx
-0001e7a0: 3a0a 2020 2020 2020 2020 7265 7375 6c74  :.        result
-0001e7b0: 2c20 656e 7620 3d20 6175 676d 656e 7465  , env = augmente
-0001e7c0: 645f 666f 7277 6172 645f 7061 7373 282a  d_forward_pass(*
-0001e7d0: 7072 696d 616c 732c 2074 7261 6365 3d74  primals, trace=t
-0001e7e0: 7261 6365 2c20 2a2a 6b77 6172 6773 290a  race, **kwargs).
-0001e7f0: 2020 2020 2020 2020 6368 6563 6b28 0a20          check(. 
-0001e800: 2020 2020 2020 2020 2020 206c 656e 2872             len(r
-0001e810: 6573 756c 7429 203d 3d20 6c65 6e28 636f  esult) == len(co
-0001e820: 7461 6e67 656e 7473 2920 6966 2069 7369  tangents) if isi
-0001e830: 6e73 7461 6e63 6528 7265 7375 6c74 2c20  nstance(result, 
-0001e840: 5365 7175 656e 6365 2920 656c 7365 2054  Sequence) else T
-0001e850: 7275 652c 0a20 2020 2020 2020 2020 2020  rue,.           
-0001e860: 206c 616d 6264 613a 2066 2245 7870 6563   lambda: f"Expec
-0001e870: 7465 6420 636f 7461 6e67 656e 7473 2074  ted cotangents t
-0001e880: 6f20 6265 2061 2073 6571 7565 6e63 6520  o be a sequence 
-0001e890: 6f66 206c 656e 6774 6820 7b6c 656e 2872  of length {len(r
-0001e8a0: 6573 756c 7429 7d2c 2067 6f74 2061 2073  esult)}, got a s
-0001e8b0: 6571 7565 6e63 6520 6f66 206c 656e 6774  equence of lengt
-0001e8c0: 6820 7b6c 656e 2863 6f74 616e 6765 6e74  h {len(cotangent
-0001e8d0: 7329 7d22 2c0a 2020 2020 2020 2020 290a  s)}",.        ).
-0001e8e0: 2020 2020 2020 2020 7265 7475 726e 2072          return r
-0001e8f0: 6573 756c 742c 2062 6163 6b77 6172 645f  esult, backward_
-0001e900: 7061 7373 2865 6e76 2c20 7472 6163 652c  pass(env, trace,
-0001e910: 2063 6f74 616e 6765 6e74 7329 0a0a 0a23   cotangents)...#
-0001e920: 2054 4f44 4f3a 2043 616e 2774 2075 7365   TODO: Can't use
-0001e930: 2061 2053 796d 626f 6c20 6865 7265 2062   a Symbol here b
-0001e940: 6563 6175 7365 206d 6978 6564 2065 7865  ecause mixed exe
-0001e950: 6375 746f 7220 7379 6273 796d 626f 6c73  cutor sybsymbols
-0001e960: 2073 6565 6d20 746f 2062 650a 2320 756e   seem to be.# un
-0001e970: 7375 7070 6f72 7465 642e 2053 6565 2069  supported. See i
-0001e980: 7373 7565 2022 436f 756c 6420 6e6f 7420  ssue "Could not 
-0001e990: 6669 6e64 2061 6e20 6578 6563 7574 6f72  find an executor
-0001e9a0: 2066 6f72 2062 6f75 6e64 2073 796d 626f   for bound symbo
-0001e9b0: 6c20 7768 656e 2069 7473 2073 7562 7379  l when its subsy
-0001e9c0: 6d62 6f6c 730a 2320 6172 6520 6e6f 7420  mbols.# are not 
-0001e9d0: 6675 6c6c 7920 7375 7070 6f72 7465 6420  fully supported 
-0001e9e0: 6279 2061 2073 696e 676c 6520 6578 6563  by a single exec
-0001e9f0: 7574 6f72 220a 766a 705f 6361 6c6c 203d  utor".vjp_call =
-0001ea00: 2070 6172 7469 616c 280a 2020 2020 766a   partial(.    vj
-0001ea10: 705f 6361 6c6c 5f6d 6574 6166 756e 632c  p_call_metafunc,
-0001ea20: 2046 616c 7365 0a29 2020 2320 5379 6d62   False.)  # Symb
-0001ea30: 6f6c 2869 643d 5472 616e 7366 6f72 6d73  ol(id=Transforms
-0001ea40: 2e56 6a70 4f70 2c20 6e61 6d65 3d22 766a  .VjpOp, name="vj
-0001ea50: 705f 6361 6c6c 222c 206d 6574 613d 7061  p_call", meta=pa
-0001ea60: 7274 6961 6c28 766a 705f 6361 6c6c 5f6d  rtial(vjp_call_m
-0001ea70: 6574 6166 756e 632c 2046 616c 7365 2929  etafunc, False))
-0001ea80: 0a0a 0a64 6566 2076 6a70 2866 756e 6329  ...def vjp(func)
-0001ea90: 3a0a 2020 2020 2222 2243 6f6d 7075 7465  :.    """Compute
-0001eaa0: 7320 7468 6520 564a 5020 6f66 2061 2066  s the VJP of a f
-0001eab0: 756e 6374 696f 6e2e 0a0a 2020 2020 4172  unction...    Ar
-0001eac0: 6773 3a0a 2020 2020 2020 2020 6675 6e63  gs:.        func
-0001ead0: 2028 4361 6c6c 6162 6c65 293a 2046 756e   (Callable): Fun
-0001eae0: 6374 696f 6e20 746f 2062 6520 6469 6666  ction to be diff
-0001eaf0: 6572 656e 7469 6174 6564 2e0a 2020 2020  erentiated..    
-0001eb00: 2222 220a 0a20 2020 2064 6566 205f 766a  """..    def _vj
-0001eb10: 7028 7072 696d 616c 732c 2063 6f74 616e  p(primals, cotan
-0001eb20: 6765 6e74 732c 202a 2a6b 7761 7267 7329  gents, **kwargs)
-0001eb30: 3a0a 2020 2020 2020 2020 666c 6174 5f66  :.        flat_f
-0001eb40: 756e 632c 2066 6c61 745f 6172 6773 2c20  unc, flat_args, 
-0001eb50: 7370 6563 203d 2066 6c61 7474 656e 5f66  spec = flatten_f
-0001eb60: 756e 6328 6675 6e63 2c20 7072 696d 616c  unc(func, primal
-0001eb70: 732c 206b 7761 7267 7329 0a20 2020 2020  s, kwargs).     
-0001eb80: 2020 2074 7261 6365 203d 2063 6f6e 7374     trace = const
-0001eb90: 7275 6374 5f74 7261 6365 2829 2866 6c61  ruct_trace()(fla
-0001eba0: 745f 6675 6e63 2c20 2a66 6c61 745f 6172  t_func, *flat_ar
-0001ebb0: 6773 290a 2020 2020 2020 2020 7265 7375  gs).        resu
-0001ebc0: 6c74 2c20 766a 705f 7265 7375 6c74 203d  lt, vjp_result =
-0001ebd0: 2076 6a70 5f63 616c 6c28 666c 6174 5f61   vjp_call(flat_a
-0001ebe0: 7267 732c 2063 6f74 616e 6765 6e74 732c  rgs, cotangents,
-0001ebf0: 2074 7261 6365 3d74 7261 6365 290a 2020   trace=trace).  
-0001ec00: 2020 2020 2020 6770 7269 6d61 6c73 2c20        gprimals, 
-0001ec10: 676b 7761 7267 7320 3d20 7472 6565 5f75  gkwargs = tree_u
-0001ec20: 6e66 6c61 7474 656e 2876 6a70 5f72 6573  nflatten(vjp_res
-0001ec30: 756c 742c 2073 7065 6329 0a20 2020 2020  ult, spec).     
-0001ec40: 2020 2067 7261 6473 203d 2067 7072 696d     grads = gprim
-0001ec50: 616c 7320 2b20 2867 6b77 6172 6773 2c29  als + (gkwargs,)
-0001ec60: 2069 6620 6c65 6e28 676b 7761 7267 7329   if len(gkwargs)
-0001ec70: 2021 3d20 3020 656c 7365 2067 7072 696d   != 0 else gprim
-0001ec80: 616c 730a 2020 2020 2020 2020 7265 7475  als.        retu
-0001ec90: 726e 2072 6573 756c 742c 2067 7261 6473  rn result, grads
-0001eca0: 0a0a 2020 2020 7265 7475 726e 205f 766a  ..    return _vj
-0001ecb0: 700a 0a0a 6465 6620 7661 6c75 655f 616e  p...def value_an
-0001ecc0: 645f 6772 6164 2866 756e 6329 3a0a 2020  d_grad(func):.  
-0001ecd0: 2020 2222 2243 6f6d 7075 7465 7320 7468    """Computes th
-0001ece0: 6520 7661 6c75 6520 616e 6420 6772 6164  e value and grad
-0001ecf0: 6965 6e74 206f 6620 6120 6675 6e63 7469  ient of a functi
-0001ed00: 6f6e 2e0a 0a20 2020 2054 6869 7320 6973  on...    This is
-0001ed10: 2061 2063 6f6e 7665 6e69 656e 6365 2066   a convenience f
-0001ed20: 756e 6374 696f 6e20 7468 6174 2063 6f6d  unction that com
-0001ed30: 6269 6e65 7320 7468 6520 6675 6e63 7469  bines the functi
-0001ed40: 6f6e 616c 6974 7920 6f66 0a20 2020 2060  onality of.    `
-0001ed50: 766a 705f 6361 6c6c 6020 7769 7468 2069  vjp_call` with i
-0001ed60: 6d70 6c69 6369 7420 696e 6974 6961 6c69  mplicit initiali
-0001ed70: 7a61 7469 6f6e 206f 6620 7468 6520 636f  zation of the co
-0001ed80: 7461 6e67 656e 7420 746f 2031 2e0a 0a20  tangent to 1... 
-0001ed90: 2020 2041 7267 733a 0a20 2020 2020 2020     Args:.       
-0001eda0: 2066 756e 6320 2843 616c 6c61 626c 6529   func (Callable)
-0001edb0: 3a20 4675 6e63 7469 6f6e 2074 6f20 6265  : Function to be
-0001edc0: 2064 6966 6665 7265 6e74 6961 7465 642e   differentiated.
-0001edd0: 0a20 2020 2022 2222 0a0a 2020 2020 6465  .    """..    de
-0001ede0: 6620 6f6e 6573 5f6c 696b 6528 7829 3a0a  f ones_like(x):.
-0001edf0: 2020 2020 2020 2020 6966 2069 7369 6e73          if isins
-0001ee00: 7461 6e63 6528 782c 2054 656e 736f 7250  tance(x, TensorP
-0001ee10: 726f 7879 293a 0a20 2020 2020 2020 2020  roxy):.         
-0001ee20: 2020 2072 6574 7572 6e20 6675 6c6c 5f6c     return full_l
-0001ee30: 696b 6528 782c 2066 696c 6c5f 7661 6c75  ike(x, fill_valu
-0001ee40: 653d 3129 0a20 2020 2020 2020 2065 6c69  e=1).        eli
-0001ee50: 6620 6973 696e 7374 616e 6365 2878 2c20  f isinstance(x, 
-0001ee60: 4e75 6d62 6572 5072 6f78 7929 3a0a 2020  NumberProxy):.  
-0001ee70: 2020 2020 2020 2020 2020 7265 7475 726e            return
-0001ee80: 2074 7970 6528 782e 7661 6c75 6529 2831   type(x.value)(1
-0001ee90: 290a 2020 2020 2020 2020 656c 7365 3a0a  ).        else:.
-0001eea0: 2020 2020 2020 2020 2020 2020 7261 6973              rais
-0001eeb0: 6520 5661 6c75 6545 7272 6f72 2866 226f  e ValueError(f"o
-0001eec0: 6e65 735f 6c69 6b65 2069 6e73 6964 6520  nes_like inside 
-0001eed0: 7661 6c75 655f 616e 645f 6772 6164 2067  value_and_grad g
-0001eee0: 6f74 2061 6e20 756e 7375 7070 6f72 7465  ot an unsupporte
-0001eef0: 6420 7479 7065 207b 7479 7065 2878 297d  d type {type(x)}
-0001ef00: 2229 0a0a 2020 2020 6465 6620 5f76 616c  ")..    def _val
-0001ef10: 7565 5f61 6e64 5f67 7261 6428 2a61 7267  ue_and_grad(*arg
-0001ef20: 732c 202a 2a6b 7761 7267 7329 3a0a 2020  s, **kwargs):.  
-0001ef30: 2020 2020 2020 7472 6163 6520 3d20 636f        trace = co
-0001ef40: 6e73 7472 7563 745f 7472 6163 6528 2928  nstruct_trace()(
-0001ef50: 6675 6e63 2c20 2a61 7267 732c 202a 2a6b  func, *args, **k
-0001ef60: 7761 7267 7329 0a20 2020 2020 2020 2063  wargs).        c
-0001ef70: 6f74 616e 6765 6e74 7320 3d20 7472 6565  otangents = tree
-0001ef80: 5f6d 6170 286c 616d 6264 6120 763a 206f  _map(lambda v: o
-0001ef90: 6e65 735f 6c69 6b65 2876 292c 2074 7261  nes_like(v), tra
-0001efa0: 6365 2e6f 7574 7075 7429 0a20 2020 2020  ce.output).     
-0001efb0: 2020 2072 6574 7572 6e20 766a 7028 6675     return vjp(fu
-0001efc0: 6e63 2928 6172 6773 2c20 636f 7461 6e67  nc)(args, cotang
-0001efd0: 656e 7473 2c20 2a2a 6b77 6172 6773 290a  ents, **kwargs).
-0001efe0: 0a20 2020 2072 6574 7572 6e20 5f76 616c  .    return _val
-0001eff0: 7565 5f61 6e64 5f67 7261 640a 0a0a 466f  ue_and_grad...Fo
-0001f000: 7277 6172 6442 6163 6b77 6172 6454 7261  rwardBackwardTra
-0001f010: 6365 7320 3d20 6e61 6d65 6474 7570 6c65  ces = namedtuple
-0001f020: 2822 466f 7277 6172 6442 6163 6b77 6172  ("ForwardBackwar
-0001f030: 6454 7261 6365 7322 2c20 5b22 666f 7277  dTraces", ["forw
-0001f040: 6172 645f 7472 6163 6522 2c20 2262 6163  ard_trace", "bac
-0001f050: 6b77 6172 645f 7472 6163 6522 5d29 0a0a  kward_trace"])..
-0001f060: 0a64 6566 205f 7370 6c69 745f 7361 7665  .def _split_save
-0001f070: 645f 666f 725f 6261 636b 7761 7264 5f69  d_for_backward_i
-0001f080: 6e74 6f5f 7465 6e73 6f72 735f 616e 645f  nto_tensors_and_
-0001f090: 6f74 6865 7228 0a20 2020 2073 6176 6564  other(.    saved
-0001f0a0: 5f66 6f72 5f62 6163 6b77 6172 643a 2053  _for_backward: S
-0001f0b0: 6571 7565 6e63 655b 5661 7269 6162 6c65  equence[Variable
-0001f0c0: 5d2c 0a29 202d 3e20 7475 706c 655b 5365  ],.) -> tuple[Se
-0001f0d0: 7175 656e 6365 5b56 6172 6961 626c 655d  quence[Variable]
-0001f0e0: 2c20 5365 7175 656e 6365 5b56 6172 6961  , Sequence[Varia
-0001f0f0: 626c 655d 5d3a 0a20 2020 2022 2222 5370  ble]]:.    """Sp
-0001f100: 6c69 7473 2073 6176 6564 5f66 6f72 5f62  lits saved_for_b
-0001f110: 6163 6b77 6172 6420 696e 746f 2074 656e  ackward into ten
-0001f120: 736f 7273 2061 6e64 206f 7468 6572 2e0a  sors and other..
-0001f130: 0a20 2020 2041 7267 733a 0a20 2020 2020  .    Args:.     
-0001f140: 2020 2073 6176 6564 5f66 6f72 5f62 6163     saved_for_bac
-0001f150: 6b77 6172 6420 2853 6571 7565 6e63 655b  kward (Sequence[
-0001f160: 5661 7269 6162 6c65 5d29 3a20 5361 7665  Variable]): Save
-0001f170: 645f 666f 725f 6261 636b 7761 7264 2074  d_for_backward t
-0001f180: 6f20 7370 6c69 742e 0a0a 2020 2020 5265  o split...    Re
-0001f190: 7475 726e 733a 0a20 2020 2020 2020 2074  turns:.        t
-0001f1a0: 7570 6c65 5b53 6571 7565 6e63 655b 5661  uple[Sequence[Va
-0001f1b0: 7269 6162 6c65 5d2c 2053 6571 7565 6e63  riable], Sequenc
-0001f1c0: 655b 5661 7269 6162 6c65 5d5d 3a20 5475  e[Variable]]: Tu
-0001f1d0: 706c 6520 6f66 2074 656e 736f 7273 2061  ple of tensors a
-0001f1e0: 6e64 206f 7468 6572 2e0a 2020 2020 2222  nd other..    ""
-0001f1f0: 220a 2020 2020 6973 5f74 656e 736f 7220  ".    is_tensor 
-0001f200: 3d20 6c61 6d62 6461 2078 3a20 6973 696e  = lambda x: isin
-0001f210: 7374 616e 6365 2878 2c20 5465 6e73 6f72  stance(x, Tensor
-0001f220: 5072 6f78 7929 0a20 2020 206f 7468 6572  Proxy).    other
-0001f230: 2c20 7465 6e73 6f72 7320 3d20 7574 696c  , tensors = util
-0001f240: 732e 7061 7274 6974 696f 6e28 6973 5f74  s.partition(is_t
-0001f250: 656e 736f 722c 2073 6176 6564 5f66 6f72  ensor, saved_for
-0001f260: 5f62 6163 6b77 6172 6429 0a20 2020 2072  _backward).    r
-0001f270: 6574 7572 6e20 7475 706c 6528 7465 6e73  eturn tuple(tens
-0001f280: 6f72 7329 2c20 7475 706c 6528 6f74 6865  ors), tuple(othe
-0001f290: 7229 0a0a 0a64 6566 205f 7570 6461 7465  r)...def _update
-0001f2a0: 5f66 6f72 7761 7264 5f77 6974 685f 6e65  _forward_with_ne
-0001f2b0: 775f 7361 7665 645f 666f 725f 6261 636b  w_saved_for_back
-0001f2c0: 7761 7264 2866 6f72 7761 7264 5f74 7261  ward(forward_tra
-0001f2d0: 6365 3a20 5472 6163 652c 2073 6176 6564  ce: Trace, saved
-0001f2e0: 5f66 6f72 5f62 6163 6b77 6172 643a 2053  _for_backward: S
-0001f2f0: 6571 7565 6e63 655b 5661 7269 6162 6c65  equence[Variable
-0001f300: 5d29 202d 3e20 4e6f 6e65 3a0a 2020 2020  ]) -> None:.    
-0001f310: 2222 2255 7064 6174 6573 2074 6865 2066  """Updates the f
-0001f320: 6f72 7761 7264 2074 7261 6365 2077 6974  orward trace wit
-0001f330: 6820 6e65 7720 7361 7665 645f 666f 725f  h new saved_for_
-0001f340: 6261 636b 7761 7264 2e0a 0a20 2020 2054  backward...    T
-0001f350: 6869 7320 6973 206e 6563 6573 7361 7279  his is necessary
-0001f360: 2062 6563 6175 7365 2074 6865 2075 7064   because the upd
-0001f370: 6174 6564 2073 6176 6564 5f66 6f72 5f62  ated saved_for_b
-0001f380: 6163 6b77 6172 6420 6973 206e 6f74 2061  ackward is not a
-0001f390: 7661 696c 6162 6c65 0a20 2020 2077 6865  vailable.    whe
-0001f3a0: 6e20 7468 6520 666f 7277 6172 6420 616e  n the forward an
-0001f3b0: 6420 6261 636b 7761 7264 2074 7261 6365  d backward trace
-0001f3c0: 7320 6172 6520 636f 6e73 7472 7563 7465  s are constructe
-0001f3d0: 642e 0a0a 2020 2020 4172 6773 3a0a 2020  d...    Args:.  
-0001f3e0: 2020 2020 2020 666f 7277 6172 645f 7472        forward_tr
-0001f3f0: 6163 6520 2854 7261 6365 293a 2046 6f72  ace (Trace): For
-0001f400: 7761 7264 2074 7261 6365 2074 6f20 7570  ward trace to up
-0001f410: 6461 7465 2e0a 2020 2020 2020 2020 7361  date..        sa
-0001f420: 7665 645f 666f 725f 6261 636b 7761 7264  ved_for_backward
-0001f430: 2028 5365 7175 656e 6365 5b56 6172 6961   (Sequence[Varia
-0001f440: 626c 655d 293a 2053 6176 6564 5f66 6f72  ble]): Saved_for
-0001f450: 5f62 6163 6b77 6172 6420 746f 2075 7365  _backward to use
-0001f460: 2074 6f0a 2020 2020 2020 2020 2020 2020   to.            
-0001f470: 7570 6461 7465 2074 6865 2066 6f72 7761  update the forwa
-0001f480: 7264 2074 7261 6365 2e0a 2020 2020 2222  rd trace..    ""
-0001f490: 220a 2020 2020 7361 7665 645f 666f 725f  ".    saved_for_
-0001f4a0: 6261 636b 7761 7264 203d 2074 7265 655f  backward = tree_
-0001f4b0: 6d61 7028 6c61 6d62 6461 2078 3a20 782e  map(lambda x: x.
-0001f4c0: 7661 6c75 6520 6966 2069 7369 6e73 7461  value if isinsta
-0001f4d0: 6e63 6528 782c 204e 756d 6265 7250 726f  nce(x, NumberPro
-0001f4e0: 7879 2920 656c 7365 2078 2c20 7361 7665  xy) else x, save
-0001f4f0: 645f 666f 725f 6261 636b 7761 7264 290a  d_for_backward).
-0001f500: 2020 2020 7361 7665 645f 7465 6e73 6f72      saved_tensor
-0001f510: 732c 2073 6176 6564 5f6f 7468 6572 203d  s, saved_other =
-0001f520: 205f 7370 6c69 745f 7361 7665 645f 666f   _split_saved_fo
-0001f530: 725f 6261 636b 7761 7264 5f69 6e74 6f5f  r_backward_into_
-0001f540: 7465 6e73 6f72 735f 616e 645f 6f74 6865  tensors_and_othe
-0001f550: 7228 7361 7665 645f 666f 725f 6261 636b  r(saved_for_back
-0001f560: 7761 7264 290a 2020 2020 6173 7365 7274  ward).    assert
-0001f570: 2066 6f72 7761 7264 5f74 7261 6365 2e62   forward_trace.b
-0001f580: 6f75 6e64 5f73 796d 626f 6c73 5b2d 315d  ound_symbols[-1]
-0001f590: 2e73 796d 2e69 6420 3d3d 2070 7269 6d73  .sym.id == prims
-0001f5a0: 2e50 7269 6d49 4473 2e52 4554 5552 4e0a  .PrimIDs.RETURN.
-0001f5b0: 2020 2020 6e65 775f 7265 7475 726e 203d      new_return =
-0001f5c0: 2028 666f 7277 6172 645f 7472 6163 652e   (forward_trace.
-0001f5d0: 6f75 7470 7574 5b30 5d2c 2028 7361 7665  output[0], (save
-0001f5e0: 645f 7465 6e73 6f72 732c 2073 6176 6564  d_tensors, saved
-0001f5f0: 5f6f 7468 6572 2929 0a20 2020 2066 6f72  _other)).    for
-0001f600: 7761 7264 5f74 7261 6365 2e62 6f75 6e64  ward_trace.bound
-0001f610: 5f73 796d 626f 6c73 5b2d 315d 203d 2072  _symbols[-1] = r
-0001f620: 6570 6c61 6365 2866 6f72 7761 7264 5f74  eplace(forward_t
-0001f630: 7261 6365 2e62 6f75 6e64 5f73 796d 626f  race.bound_symbo
-0001f640: 6c73 5b2d 315d 2c20 6172 6773 3d6e 6577  ls[-1], args=new
-0001f650: 5f72 6574 7572 6e29 0a0a 0a64 6566 205f  _return)...def _
-0001f660: 7570 6461 7465 5f62 6163 6b77 6172 645f  update_backward_
-0001f670: 7769 7468 5f6e 6577 5f73 6176 6564 5f66  with_new_saved_f
-0001f680: 6f72 5f62 6163 6b77 6172 6428 6261 636b  or_backward(back
-0001f690: 7761 7264 5f74 7261 6365 3a20 5472 6163  ward_trace: Trac
-0001f6a0: 652c 2073 6176 6564 5f66 6f72 5f62 6163  e, saved_for_bac
-0001f6b0: 6b77 6172 643a 2053 6571 7565 6e63 655b  kward: Sequence[
-0001f6c0: 5661 7269 6162 6c65 5d29 202d 3e20 4e6f  Variable]) -> No
-0001f6d0: 6e65 3a0a 2020 2020 2222 2255 7064 6174  ne:.    """Updat
-0001f6e0: 6573 2074 6865 2062 6163 6b77 6172 6420  es the backward 
-0001f6f0: 7472 6163 6520 7769 7468 206e 6577 2073  trace with new s
-0001f700: 6176 6564 5f66 6f72 5f62 6163 6b77 6172  aved_for_backwar
-0001f710: 642e 0a0a 2020 2020 5468 6973 2069 7320  d...    This is 
-0001f720: 6e65 6365 7373 6172 7920 6265 6361 7573  necessary becaus
-0001f730: 6520 7468 6520 7570 6461 7465 6420 7361  e the updated sa
-0001f740: 7665 645f 666f 725f 6261 636b 7761 7264  ved_for_backward
-0001f750: 2069 730a 2020 2020 6e6f 7420 6176 6169   is.    not avai
-0001f760: 6c61 626c 6520 7768 656e 2074 6865 2062  lable when the b
-0001f770: 6163 6b77 6172 6420 7472 6163 6520 6973  ackward trace is
-0001f780: 2063 6f6e 7374 7275 6374 6564 2e0a 0a20   constructed... 
-0001f790: 2020 2041 7267 733a 0a20 2020 2020 2020     Args:.       
-0001f7a0: 2062 6163 6b77 6172 645f 7472 6163 6520   backward_trace 
-0001f7b0: 2854 7261 6365 293a 2042 6163 6b77 6172  (Trace): Backwar
-0001f7c0: 6420 7472 6163 6520 746f 2075 7064 6174  d trace to updat
-0001f7d0: 652e 0a20 2020 2020 2020 2073 6176 6564  e..        saved
-0001f7e0: 5f66 6f72 5f62 6163 6b77 6172 6420 2853  _for_backward (S
-0001f7f0: 6571 7565 6e63 655b 5661 7269 6162 6c65  equence[Variable
-0001f800: 5d29 3a20 5361 7665 645f 666f 725f 6261  ]): Saved_for_ba
-0001f810: 636b 7761 7264 2074 6f20 7573 6520 746f  ckward to use to
-0001f820: 0a20 2020 2020 2020 2020 2020 2075 7064  .            upd
-0001f830: 6174 6520 7468 6520 6261 636b 7761 7264  ate the backward
-0001f840: 2074 7261 6365 2e0a 2020 2020 2222 220a   trace..    """.
-0001f850: 0a20 2020 2064 6566 2075 6e70 6163 6b69  .    def unpacki
-0001f860: 6e67 5f66 6e28 7361 7665 645f 666f 725f  ng_fn(saved_for_
-0001f870: 6261 636b 7761 7264 2c20 636f 7461 6e67  backward, cotang
-0001f880: 656e 7473 293a 0a20 2020 2020 2020 2070  ents):.        p
-0001f890: 6173 730a 0a20 2020 2063 6f74 616e 6765  ass..    cotange
-0001f8a0: 6e74 7320 3d20 6261 636b 7761 7264 5f74  nts = backward_t
-0001f8b0: 7261 6365 2e61 7267 735b 315d 0a20 2020  race.args[1].   
-0001f8c0: 2073 6176 6564 5f74 656e 736f 7273 2c20   saved_tensors, 
-0001f8d0: 7361 7665 645f 6f74 6865 7220 3d20 5f73  saved_other = _s
-0001f8e0: 706c 6974 5f73 6176 6564 5f66 6f72 5f62  plit_saved_for_b
-0001f8f0: 6163 6b77 6172 645f 696e 746f 5f74 656e  ackward_into_ten
-0001f900: 736f 7273 5f61 6e64 5f6f 7468 6572 2873  sors_and_other(s
-0001f910: 6176 6564 5f66 6f72 5f62 6163 6b77 6172  aved_for_backwar
-0001f920: 6429 0a20 2020 2075 6e70 6163 6b69 6e67  d).    unpacking
-0001f930: 5f74 7261 6365 203d 2063 6f6e 7374 7275  _trace = constru
-0001f940: 6374 5f74 7261 6365 2872 656e 616d 655f  ct_trace(rename_
-0001f950: 7072 6f78 6965 733d 4661 6c73 652c 2075  proxies=False, u
-0001f960: 7365 5f64 6365 3d46 616c 7365 2928 0a20  se_dce=False)(. 
-0001f970: 2020 2020 2020 2075 6e70 6163 6b69 6e67         unpacking
-0001f980: 5f66 6e2c 2028 7361 7665 645f 7465 6e73  _fn, (saved_tens
-0001f990: 6f72 732c 2073 6176 6564 5f6f 7468 6572  ors, saved_other
-0001f9a0: 292c 2063 6f74 616e 6765 6e74 730a 2020  ), cotangents.  
-0001f9b0: 2020 290a 2020 2020 6173 7365 7274 2075    ).    assert u
-0001f9c0: 6e70 6163 6b69 6e67 5f74 7261 6365 2e62  npacking_trace.b
-0001f9d0: 6f75 6e64 5f73 796d 626f 6c73 5b2d 315d  ound_symbols[-1]
-0001f9e0: 2e73 796d 2e69 6420 3d3d 2070 7269 6d73  .sym.id == prims
-0001f9f0: 2e50 7269 6d49 4473 2e52 4554 5552 4e0a  .PrimIDs.RETURN.
-0001fa00: 0a20 2020 2062 6163 6b77 6172 645f 7472  .    backward_tr
-0001fa10: 6163 652e 6172 6773 203d 2075 6e70 6163  ace.args = unpac
-0001fa20: 6b69 6e67 5f74 7261 6365 2e61 7267 730a  king_trace.args.
-0001fa30: 2020 2020 6261 636b 7761 7264 5f74 7261      backward_tra
-0001fa40: 6365 5f62 7379 6d73 5f77 6974 686f 7574  ce_bsyms_without
-0001fa50: 5f75 6e70 6163 6b69 6e67 203d 2028 0a20  _unpacking = (. 
-0001fa60: 2020 2020 2020 2062 7379 6d0a 2020 2020         bsym.    
-0001fa70: 2020 2020 666f 7220 6273 796d 2069 6e20      for bsym in 
-0001fa80: 6261 636b 7761 7264 5f74 7261 6365 2e62  backward_trace.b
-0001fa90: 6f75 6e64 5f73 796d 626f 6c73 0a20 2020  ound_symbols.   
-0001faa0: 2020 2020 2069 6620 6273 796d 2e73 796d       if bsym.sym
-0001fab0: 2e69 640a 2020 2020 2020 2020 6e6f 7420  .id.        not 
-0001fac0: 696e 2028 0a20 2020 2020 2020 2020 2020  in (.           
-0001fad0: 2070 7269 6d73 2e50 7269 6d49 4473 2e55   prims.PrimIDs.U
-0001fae0: 4e50 4143 4b5f 454d 5054 595f 4449 4354  NPACK_EMPTY_DICT
-0001faf0: 2c0a 2020 2020 2020 2020 2020 2020 7072  ,.            pr
-0001fb00: 696d 732e 5072 696d 4944 732e 554e 5041  ims.PrimIDs.UNPA
-0001fb10: 434b 5f4b 4559 2c0a 2020 2020 2020 2020  CK_KEY,.        
-0001fb20: 2020 2020 7072 696d 732e 5072 696d 4944      prims.PrimID
-0001fb30: 732e 554e 5041 434b 5f53 4551 5545 4e43  s.UNPACK_SEQUENC
-0001fb40: 452c 0a20 2020 2020 2020 2020 2020 2070  E,.            p
-0001fb50: 7269 6d73 2e50 7269 6d49 4473 2e55 4e50  rims.PrimIDs.UNP
-0001fb60: 4143 4b5f 5452 4956 4941 4c2c 0a20 2020  ACK_TRIVIAL,.   
-0001fb70: 2020 2020 2029 0a20 2020 2029 0a20 2020       ).    ).   
-0001fb80: 2062 6163 6b77 6172 645f 7472 6163 652e   backward_trace.
-0001fb90: 626f 756e 645f 7379 6d62 6f6c 7320 3d20  bound_symbols = 
-0001fba0: 6c69 7374 2828 2a75 6e70 6163 6b69 6e67  list((*unpacking
-0001fbb0: 5f74 7261 6365 2e62 6f75 6e64 5f73 796d  _trace.bound_sym
-0001fbc0: 626f 6c73 5b3a 2d31 5d2c 202a 6261 636b  bols[:-1], *back
-0001fbd0: 7761 7264 5f74 7261 6365 5f62 7379 6d73  ward_trace_bsyms
-0001fbe0: 5f77 6974 686f 7574 5f75 6e70 6163 6b69  _without_unpacki
-0001fbf0: 6e67 2929 0a0a 0a23 204e 4f54 453a 2052  ng))...# NOTE: R
-0001fc00: 6574 7572 6e69 6e67 206e 616d 6564 7475  eturning namedtu
-0001fc10: 706c 6573 2066 726f 6d20 636f 6d70 696c  ples from compil
-0001fc20: 6564 2066 756e 6374 696f 6e73 2064 6f65  ed functions doe
-0001fc30: 736e 2774 2077 6f72 6b2e 2053 6565 3a0a  sn't work. See:.
-0001fc40: 2320 2241 6c6c 6f77 2072 6574 7572 6e69  # "Allow returni
-0001fc50: 6e67 206e 616d 6564 7475 706c 6573 2066  ng namedtuples f
-0001fc60: 726f 6d20 636f 6d70 696c 6564 2066 756e  rom compiled fun
-0001fc70: 6374 696f 6e73 220a 2320 4e6f 7465 205b  ctions".# Note [
-0001fc80: 4772 6164 2066 6f72 7761 7264 206f 7574  Grad forward out
-0001fc90: 7075 7420 7370 6563 5d0a 2320 4966 2069  put spec].# If i
-0001fca0: 7420 6469 6420 776f 726b 2069 7420 776f  t did work it wo
-0001fcb0: 756c 6420 6265 206e 6963 6520 746f 2075  uld be nice to u
-0001fcc0: 7365 2074 6869 7320 6e61 6d65 6474 7570  se this namedtup
-0001fcd0: 6c65 0a23 2069 6e73 7465 6164 206f 6620  le.# instead of 
-0001fce0: 7468 6520 706c 6169 6e20 7475 706c 6520  the plain tuple 
-0001fcf0: 6f72 2064 6963 7420 7468 6174 2077 6527  or dict that we'
-0001fd00: 7265 2075 7369 6e67 206e 6f77 2e0a 546f  re using now..To
-0001fd10: 7263 6841 7574 6f67 7261 6446 6f72 7761  rchAutogradForwa
-0001fd20: 7264 4461 7461 203d 206e 616d 6564 7475  rdData = namedtu
-0001fd30: 706c 6528 0a20 2020 2022 546f 7263 6841  ple(.    "TorchA
-0001fd40: 7574 6f67 7261 6446 6f72 7761 7264 4461  utogradForwardDa
-0001fd50: 7461 222c 0a20 2020 205b 226f 7574 7075  ta",.    ["outpu
-0001fd60: 7422 2c20 2266 6c61 745f 6172 6773 222c  t", "flat_args",
-0001fd70: 2022 666c 6174 5f6f 7574 7075 7422 5d2c   "flat_output"],
-0001fd80: 0a29 0a0a 0a64 6566 2066 6f72 7761 7264  .)...def forward
-0001fd90: 5f61 6e64 5f62 6163 6b77 6172 645f 6672  _and_backward_fr
-0001fda0: 6f6d 5f74 7261 6365 2874 7261 6365 3a20  om_trace(trace: 
-0001fdb0: 5472 6163 652c 2074 6f72 6368 5f61 7574  Trace, torch_aut
-0001fdc0: 6f67 7261 643d 4661 6c73 6529 202d 3e20  ograd=False) -> 
-0001fdd0: 466f 7277 6172 6442 6163 6b77 6172 6454  ForwardBackwardT
-0001fde0: 7261 6365 733a 0a20 2020 2022 2222 4765  races:.    """Ge
-0001fdf0: 6e65 7261 7465 7320 7468 6520 666f 7277  nerates the forw
-0001fe00: 6172 6420 616e 6420 6261 636b 7761 7264  ard and backward
-0001fe10: 2070 6173 7365 7320 6672 6f6d 2061 2074   passes from a t
-0001fe20: 7261 6365 2e0a 0a20 2020 2054 6869 7320  race...    This 
-0001fe30: 6973 2061 2063 6f6e 7665 6e69 656e 6365  is a convenience
-0001fe40: 2066 756e 6374 696f 6e20 7468 6174 2063   function that c
-0001fe50: 6f6d 6269 6e65 7320 7468 6520 6675 6e63  ombines the func
-0001fe60: 7469 6f6e 616c 6974 7920 6f66 0a20 2020  tionality of.   
-0001fe70: 2060 6175 676d 656e 7465 645f 666f 7277   `augmented_forw
-0001fe80: 6172 645f 7061 7373 6020 616e 6420 6062  ard_pass` and `b
-0001fe90: 6163 6b77 6172 645f 7061 7373 602e 2054  ackward_pass`. T
-0001fea0: 6865 206d 6169 6e20 6469 6666 6572 656e  he main differen
-0001feb0: 6365 2069 7320 7468 6174 0a20 2020 2074  ce is that.    t
-0001fec0: 6869 7320 6675 6e63 7469 6f6e 2064 6f65  his function doe
-0001fed0: 7320 6e6f 7420 7265 7175 6972 6520 7468  s not require th
-0001fee0: 6520 7573 6572 2074 6f20 7072 6f76 6964  e user to provid
-0001fef0: 6520 6e65 7720 696e 7075 7473 2066 6f72  e new inputs for
-0001ff00: 2074 6865 0a20 2020 2074 7261 6365 2065   the.    trace e
-0001ff10: 7661 6c75 6174 696f 6e2e 2049 6e73 7465  valuation. Inste
-0001ff20: 6164 2069 7420 7573 6573 2074 6865 2069  ad it uses the i
-0001ff30: 6e70 7574 7320 7468 6174 2077 6572 6520  nputs that were 
-0001ff40: 7573 6564 2074 6f20 636f 6e73 7472 7563  used to construc
-0001ff50: 740a 2020 2020 7468 6520 7472 6163 652e  t.    the trace.
-0001ff60: 0a0a 2020 2020 4172 6773 3a0a 2020 2020  ..    Args:.    
-0001ff70: 2020 2020 7472 6163 6520 2854 7261 6365      trace (Trace
-0001ff80: 293a 2054 7261 6365 2074 6f20 6765 6e65  ): Trace to gene
-0001ff90: 7261 7465 2074 6865 2066 6f72 7761 7264  rate the forward
-0001ffa0: 2061 6e64 2062 6163 6b77 6172 6420 7061   and backward pa
-0001ffb0: 7373 6573 2066 726f 6d2e 0a0a 2020 2020  sses from...    
-0001ffc0: 5265 7475 726e 733a 0a20 2020 2020 2020  Returns:.       
-0001ffd0: 2046 6f72 7761 7264 4261 636b 7761 7264   ForwardBackward
-0001ffe0: 5472 6163 6573 3a20 4120 6e61 6d65 6420  Traces: A named 
-0001fff0: 7475 706c 6520 636f 6e74 6169 6e69 6e67  tuple containing
-00020000: 2074 6865 2066 6f72 7761 7264 2061 6e64   the forward and
-00020010: 2062 6163 6b77 6172 640a 2020 2020 2020   backward.      
-00020020: 2020 2020 2020 7472 6163 6573 2e0a 0a20        traces... 
-00020030: 2020 2045 7861 6d70 6c65 3a0a 2020 2020     Example:.    
-00020040: 2020 2020 3e3e 3e20 696d 706f 7274 2074      >>> import t
-00020050: 6f72 6368 0a20 2020 2020 2020 203e 3e3e  orch.        >>>
-00020060: 2066 726f 6d20 7468 756e 6465 7220 696d   from thunder im
-00020070: 706f 7274 2063 6f6d 7069 6c65 2c20 6c61  port compile, la
-00020080: 7374 5f74 7261 6365 730a 2020 2020 2020  st_traces.      
-00020090: 2020 3e3e 3e20 6672 6f6d 2074 6875 6e64    >>> from thund
-000200a0: 6572 2e63 6f72 652e 7472 616e 7366 6f72  er.core.transfor
-000200b0: 6d73 2069 6d70 6f72 7420 666f 7277 6172  ms import forwar
-000200c0: 645f 616e 645f 6261 636b 7761 7264 5f66  d_and_backward_f
-000200d0: 726f 6d5f 7472 6163 650a 2020 2020 2020  rom_trace.      
-000200e0: 2020 3e3e 3e20 6465 6620 6628 7829 3a0a    >>> def f(x):.
-000200f0: 2020 2020 2020 2020 2e2e 2e20 2020 2020          ...     
-00020100: 7265 7475 726e 2074 6f72 6368 2e73 696e  return torch.sin
-00020110: 2878 290a 2020 2020 2020 2020 3e3e 3e20  (x).        >>> 
-00020120: 7820 3d20 746f 7263 682e 7465 6e73 6f72  x = torch.tensor
-00020130: 2833 2e30 290a 2020 2020 2020 2020 3e3e  (3.0).        >>
-00020140: 3e20 6366 203d 2063 6f6d 7069 6c65 2866  > cf = compile(f
-00020150: 290a 2020 2020 2020 2020 3e3e 3e20 6f75  ).        >>> ou
-00020160: 7420 3d20 6366 2878 290a 2020 2020 2020  t = cf(x).      
-00020170: 2020 3e3e 3e20 7472 6163 6520 3d20 6c61    >>> trace = la
-00020180: 7374 5f74 7261 6365 7328 6366 295b 305d  st_traces(cf)[0]
-00020190: 0a20 2020 2020 2020 203e 3e3e 2066 6f72  .        >>> for
-000201a0: 7761 7264 5f61 6e64 5f62 6163 6b77 6172  ward_and_backwar
-000201b0: 645f 6672 6f6d 5f74 7261 6365 2874 7261  d_from_trace(tra
-000201c0: 6365 290a 2020 2020 2020 2020 2e2e 2e20  ce).        ... 
-000201d0: 466f 7277 6172 6442 6163 6b77 6172 6454  ForwardBackwardT
-000201e0: 7261 6365 7328 0a20 2020 2020 2020 202e  races(.        .
-000201f0: 2e2e 2066 6f72 7761 7264 5f74 7261 6365  .. forward_trace
-00020200: 3d23 2069 6d70 6f72 7420 7468 756e 6465  =# import thunde
-00020210: 7220 6173 2074 6875 6e64 6572 0a20 2020  r as thunder.   
-00020220: 2020 2020 202e 2e2e 2023 2069 6d70 6f72       ... # impor
-00020230: 7420 7468 756e 6465 722e 636f 7265 2e70  t thunder.core.p
-00020240: 7269 6d73 2061 7320 7072 696d 730a 2020  rims as prims.  
-00020250: 2020 2020 2020 2e2e 2e20 696d 706f 7274        ... import
-00020260: 2074 6f72 6368 0a20 2020 2020 2020 202e   torch.        .
-00020270: 2e2e 0a20 2020 2020 2020 202e 2e2e 2040  ...        ... @
-00020280: 746f 7263 682e 6e6f 5f67 7261 6428 290a  torch.no_grad().
-00020290: 2020 2020 2020 2020 2e2e 2e20 6465 6620          ... def 
-000202a0: 6175 676d 656e 7465 645f 666f 7277 6172  augmented_forwar
-000202b0: 645f 666e 282a 6172 6773 293a 0a20 2020  d_fn(*args):.   
-000202c0: 2020 2020 202e 2e2e 2020 2023 2061 7267       ...   # arg
-000202d0: 733a 2022 436f 6c6c 6563 7469 6f6e 2220  s: "Collection" 
-000202e0: 3d20 2028 7430 2c29 2020 2874 7269 7669  =  (t0,)  (trivi
-000202f0: 616c 2075 6e70 6163 6b29 0a20 2020 2020  al unpack).     
-00020300: 2020 202e 2e2e 2020 2074 302c 205c 0a20     ...   t0, \. 
-00020310: 2020 2020 2020 202e 2e2e 2020 203d 2061         ...   = a
-00020320: 7267 730a 2020 2020 2020 2020 2e2e 2e20  rgs.        ... 
-00020330: 2020 7431 203d 2070 7269 6d73 2e73 696e    t1 = prims.sin
-00020340: 2874 3029 2020 2320 7431 3a20 2263 7075  (t0)  # t1: "cpu
-00020350: 2066 3332 5b5d 220a 2020 2020 2020 2020   f32[]".        
-00020360: 2e2e 2e20 2020 7265 7475 726e 2074 312c  ...   return t1,
-00020370: 2028 7430 2c29 2c0a 2020 2020 2020 2020   (t0,),.        
-00020380: 2e2e 2e20 6261 636b 7761 7264 5f74 7261  ... backward_tra
-00020390: 6365 3d23 2069 6d70 6f72 7420 7468 756e  ce=# import thun
-000203a0: 6465 7220 6173 2074 6875 6e64 6572 0a20  der as thunder. 
-000203b0: 2020 2020 2020 202e 2e2e 2023 2069 6d70         ... # imp
-000203c0: 6f72 7420 7468 756e 6465 722e 636f 7265  ort thunder.core
-000203d0: 2e70 7269 6d73 2061 7320 7072 696d 730a  .prims as prims.
-000203e0: 2020 2020 2020 2020 2e2e 2e20 696d 706f          ... impo
-000203f0: 7274 2074 6f72 6368 0a20 2020 2020 2020  rt torch.       
-00020400: 202e 2e2e 0a20 2020 2020 2020 202e 2e2e   ....        ...
-00020410: 2040 746f 7263 682e 6e6f 5f67 7261 6428   @torch.no_grad(
-00020420: 290a 2020 2020 2020 2020 2e2e 2e20 6465  ).        ... de
-00020430: 6620 6261 636b 7761 7264 5f66 6e28 7361  f backward_fn(sa
-00020440: 7665 645f 666f 725f 6261 636b 7761 7264  ved_for_backward
-00020450: 2c20 636f 7461 6e67 656e 7473 293a 0a20  , cotangents):. 
-00020460: 2020 2020 2020 202e 2e2e 2020 2023 2073         ...   # s
-00020470: 6176 6564 5f66 6f72 5f62 6163 6b77 6172  aved_for_backwar
-00020480: 643a 2022 436f 6c6c 6563 7469 6f6e 2220  d: "Collection" 
-00020490: 3d20 2028 7430 2c29 2020 2874 7269 7669  =  (t0,)  (trivi
-000204a0: 616c 2075 6e70 6163 6b29 0a20 2020 2020  al unpack).     
-000204b0: 2020 202e 2e2e 2020 2023 2063 6f74 616e     ...   # cotan
-000204c0: 6765 6e74 733a 2022 6370 7520 6633 325b  gents: "cpu f32[
-000204d0: 5d22 203d 2020 636f 7461 6e67 656e 7473  ]" =  cotangents
-000204e0: 2020 2874 7269 7669 616c 2075 6e70 6163    (trivial unpac
-000204f0: 6b29 0a20 2020 2020 2020 202e 2e2e 2020  k).        ...  
-00020500: 2074 302c 205c 0a20 2020 2020 2020 202e   t0, \.        .
-00020510: 2e2e 2020 203d 2073 6176 6564 5f66 6f72  ..   = saved_for
-00020520: 5f62 6163 6b77 6172 640a 2020 2020 2020  _backward.      
-00020530: 2020 2e2e 2e20 2020 7431 203d 2070 7269    ...   t1 = pri
-00020540: 6d73 2e63 6f73 2874 3029 2020 2320 7431  ms.cos(t0)  # t1
-00020550: 3a20 2263 7075 2066 3332 5b5d 220a 2020  : "cpu f32[]".  
-00020560: 2020 2020 2020 2e2e 2e20 2020 7432 203d        ...   t2 =
-00020570: 2070 7269 6d73 2e6d 756c 2863 6f74 616e   prims.mul(cotan
-00020580: 6765 6e74 732c 2074 3129 2020 2320 7432  gents, t1)  # t2
-00020590: 3a20 2263 7075 2066 3332 5b5d 220a 2020  : "cpu f32[]".  
-000205a0: 2020 2020 2020 2e2e 2e20 2020 7265 7475        ...   retu
-000205b0: 726e 2028 7432 2c29 290a 2020 2020 2222  rn (t2,)).    ""
-000205c0: 220a 0a20 2020 206f 7574 7075 745f 7370  "..    output_sp
-000205d0: 6563 203d 204e 6f6e 650a 0a20 2020 2064  ec = None..    d
-000205e0: 6566 2061 7567 6d65 6e74 6564 5f66 6f72  ef augmented_for
-000205f0: 7761 7264 5f66 6e28 2a61 7267 732c 202a  ward_fn(*args, *
-00020600: 2a6b 7761 7267 7329 3a0a 2020 2020 2020  *kwargs):.      
-00020610: 2020 7265 7375 6c74 2c20 656e 7620 3d20    result, env = 
-00020620: 6175 676d 656e 7465 645f 666f 7277 6172  augmented_forwar
-00020630: 645f 7061 7373 282a 6172 6773 2c20 7472  d_pass(*args, tr
-00020640: 6163 653d 7472 6163 652c 202a 2a6b 7761  ace=trace, **kwa
-00020650: 7267 7329 0a20 2020 2020 2020 2073 6176  rgs).        sav
-00020660: 6564 5f66 6f72 5f62 6163 6b77 6172 6420  ed_for_backward 
-00020670: 3d20 6465 636f 6e73 7472 7563 745f 666f  = deconstruct_fo
-00020680: 7277 6172 645f 656e 765f 666f 725f 6261  rward_env_for_ba
-00020690: 636b 7761 7264 2874 7261 6365 2c20 656e  ckward(trace, en
-000206a0: 7629 0a20 2020 2020 2020 2069 6620 746f  v).        if to
-000206b0: 7263 685f 6175 746f 6772 6164 3a0a 2020  rch_autograd:.  
-000206c0: 2020 2020 2020 2020 2020 6e6f 6e6c 6f63            nonloc
-000206d0: 616c 206f 7574 7075 745f 7370 6563 0a20  al output_spec. 
-000206e0: 2020 2020 2020 2020 2020 2066 6c61 745f             flat_
-000206f0: 6172 6773 2c20 5f20 3d20 7472 6565 5f66  args, _ = tree_f
-00020700: 6c61 7474 656e 2828 6172 6773 2c20 6b77  latten((args, kw
-00020710: 6172 6773 2929 0a20 2020 2020 2020 2020  args)).         
-00020720: 2020 2066 6c61 745f 6f75 7470 7574 2c20     flat_output, 
-00020730: 6f75 7470 7574 5f73 7065 6320 3d20 7472  output_spec = tr
-00020740: 6565 5f66 6c61 7474 656e 2872 6573 756c  ee_flatten(resul
-00020750: 7429 0a20 2020 2020 2020 2020 2020 2066  t).            f
-00020760: 6c61 745f 6f75 7470 7574 203d 2074 7570  lat_output = tup
-00020770: 6c65 2866 6c61 745f 6f75 7470 7574 290a  le(flat_output).
-00020780: 2020 2020 2020 2020 2020 2020 2320 5365              # Se
-00020790: 6520 4e6f 7465 205b 4772 6164 2066 6f72  e Note [Grad for
-000207a0: 7761 7264 206f 7574 7075 7420 7370 6563  ward output spec
-000207b0: 5d0a 2020 2020 2020 2020 2020 2020 666f  ].            fo
-000207c0: 725f 6175 746f 6772 6164 203d 2054 6f72  r_autograd = Tor
-000207d0: 6368 4175 746f 6772 6164 466f 7277 6172  chAutogradForwar
-000207e0: 6444 6174 6128 0a20 2020 2020 2020 2020  dData(.         
-000207f0: 2020 2020 2020 2072 6573 756c 742c 0a20         result,. 
-00020800: 2020 2020 2020 2020 2020 2020 2020 2066                 f
-00020810: 6c61 745f 6172 6773 2c0a 2020 2020 2020  lat_args,.      
-00020820: 2020 2020 2020 2020 2020 666c 6174 5f6f            flat_o
-00020830: 7574 7075 742c 0a20 2020 2020 2020 2020  utput,.         
-00020840: 2020 2029 2e5f 6173 6469 6374 2829 0a20     )._asdict(). 
-00020850: 2020 2020 2020 2020 2020 2072 6574 7572             retur
-00020860: 6e20 2866 6f72 5f61 7574 6f67 7261 642c  n (for_autograd,
-00020870: 2073 6176 6564 5f66 6f72 5f62 6163 6b77   saved_for_backw
-00020880: 6172 6429 0a20 2020 2020 2020 2072 6574  ard).        ret
-00020890: 7572 6e20 7265 7375 6c74 2c20 7361 7665  urn result, save
-000208a0: 645f 666f 725f 6261 636b 7761 7264 0a0a  d_for_backward..
-000208b0: 2020 2020 2320 436f 7079 2074 6865 2073      # Copy the s
-000208c0: 6967 6e61 7475 7265 206f 6620 7468 6520  ignature of the 
-000208d0: 6f72 6967 696e 616c 2066 756e 6374 696f  original functio
-000208e0: 6e20 736f 2074 6861 7420 7468 6520 6172  n so that the ar
-000208f0: 6775 6d65 6e74 7320 6172 650a 2020 2020  guments are.    
-00020900: 2320 6e61 6d65 6420 636f 7272 6563 746c  # named correctl
-00020910: 7920 696e 2074 6865 2061 7567 6d65 6e74  y in the augment
-00020920: 6564 2066 6f72 7761 7264 2070 6173 7320  ed forward pass 
-00020930: 696e 7374 6561 6420 6f66 2062 6569 6e67  instead of being
-00020940: 206e 616d 6564 0a20 2020 2023 2022 6172   named.    # "ar
-00020950: 6773 2220 616e 6420 226b 7761 7267 7322  gs" and "kwargs"
-00020960: 2e0a 2020 2020 6175 676d 656e 7465 645f  ..    augmented_
-00020970: 666f 7277 6172 645f 666e 2e5f 5f73 6967  forward_fn.__sig
-00020980: 6e61 7475 7265 5f5f 203d 2069 6e73 7065  nature__ = inspe
-00020990: 6374 2e73 6967 6e61 7475 7265 2874 7261  ct.signature(tra
-000209a0: 6365 2e66 6e20 6f72 2074 7261 6365 2e70  ce.fn or trace.p
-000209b0: 7974 686f 6e5f 6361 6c6c 6162 6c65 2829  ython_callable()
-000209c0: 290a 0a20 2020 2064 6566 206f 6e65 735f  )..    def ones_
-000209d0: 6c69 6b65 2878 293a 0a20 2020 2020 2020  like(x):.       
-000209e0: 2069 6620 6973 696e 7374 616e 6365 2878   if isinstance(x
-000209f0: 2c20 5465 6e73 6f72 5072 6f78 7929 3a0a  , TensorProxy):.
-00020a00: 2020 2020 2020 2020 2020 2020 7265 7475              retu
-00020a10: 726e 2066 756c 6c5f 6c69 6b65 2878 2c20  rn full_like(x, 
-00020a20: 6669 6c6c 5f76 616c 7565 3d31 290a 2020  fill_value=1).  
-00020a30: 2020 2020 2020 656c 6966 2069 7369 6e73        elif isins
-00020a40: 7461 6e63 6528 782c 204e 756d 6265 7250  tance(x, NumberP
-00020a50: 726f 7879 293a 0a20 2020 2020 2020 2020  roxy):.         
-00020a60: 2020 2072 6574 7572 6e20 7479 7065 2878     return type(x
-00020a70: 2e76 616c 7565 2928 3129 0a20 2020 2020  .value)(1).     
-00020a80: 2020 2065 6c73 653a 0a20 2020 2020 2020     else:.       
-00020a90: 2020 2020 2072 6574 7572 6e20 4e6f 6e65       return None
-00020aa0: 0a0a 2020 2020 666f 7277 6172 645f 7472  ..    forward_tr
-00020ab0: 6163 6520 3d20 636f 6e73 7472 7563 745f  ace = construct_
-00020ac0: 7472 6163 6528 2928 6175 676d 656e 7465  trace()(augmente
-00020ad0: 645f 666f 7277 6172 645f 666e 2c20 2a74  d_forward_fn, *t
-00020ae0: 7261 6365 2e61 7267 732c 202a 2a74 7261  race.args, **tra
-00020af0: 6365 2e6b 7761 7267 7329 0a20 2020 2023  ce.kwargs).    #
-00020b00: 2057 6520 7365 7420 666f 7277 6172 6420   We set forward 
-00020b10: 7472 6163 6520 746f 2063 6f6e 7374 7275  trace to constru
-00020b20: 6374 2070 726f 7869 6573 2062 6563 6175  ct proxies becau
-00020b30: 7365 2077 6520 6e65 6564 2074 6865 7365  se we need these
-00020b40: 2070 726f 7869 6573 2074 6f0a 2020 2020   proxies to.    
-00020b50: 2320 6861 7665 2064 6966 6665 7265 6e74  # have different
-00020b60: 206e 616d 6573 2074 6861 6e20 7468 6520   names than the 
-00020b70: 6f6e 6573 2069 6e20 7468 6520 666f 7277  ones in the forw
-00020b80: 6172 6420 7472 6163 652e 0a20 2020 2074  ard trace..    t
-00020b90: 7279 3a0a 2020 2020 2020 2020 7472 6163  ry:.        trac
-00020ba0: 6563 7478 5f74 6f6b 656e 203d 2073 6574  ectx_token = set
-00020bb0: 5f74 7261 6365 6374 7828 666f 7277 6172  _tracectx(forwar
-00020bc0: 645f 7472 6163 6529 0a20 2020 2020 2020  d_trace).       
-00020bd0: 2023 2057 6520 646f 6e27 7420 7761 6e74   # We don't want
-00020be0: 2074 6f20 7265 636f 7264 2074 686f 7365   to record those
-00020bf0: 206f 6e65 735f 6c69 6b65 2063 616c 6c73   ones_like calls
-00020c00: 2069 6e20 7468 6520 666f 7277 6172 6420   in the forward 
-00020c10: 7472 6163 652e 0a20 2020 2020 2020 2077  trace..        w
-00020c20: 6974 6820 6465 7461 6368 6564 5f74 7261  ith detached_tra
-00020c30: 6365 2829 3a0a 2020 2020 2020 2020 2020  ce():.          
-00020c40: 2020 6966 2074 6f72 6368 5f61 7574 6f67    if torch_autog
-00020c50: 7261 643a 0a20 2020 2020 2020 2020 2020  rad:.           
-00020c60: 2020 2020 2023 2049 7427 7320 6173 7375       # It's assu
-00020c70: 6d65 6420 7468 6174 2066 6f72 7761 7264  med that forward
-00020c80: 5f74 7261 6365 2e6f 7574 7075 745b 305d  _trace.output[0]
-00020c90: 2069 7320 6120 6469 6374 2066 726f 6d20   is a dict from 
-00020ca0: 546f 7263 6841 7574 6f67 7261 6446 6f72  TorchAutogradFor
-00020cb0: 7761 7264 4461 7461 0a20 2020 2020 2020  wardData.       
-00020cc0: 2020 2020 2020 2020 2066 6c61 745f 6f75           flat_ou
-00020cd0: 7470 7574 203d 2066 6f72 7761 7264 5f74  tput = forward_t
-00020ce0: 7261 6365 2e6f 7574 7075 745b 305d 5b22  race.output[0]["
-00020cf0: 666c 6174 5f6f 7574 7075 7422 5d0a 2020  flat_output"].  
-00020d00: 2020 2020 2020 2020 2020 2020 2020 636f                co
-00020d10: 7461 6e67 656e 7473 203d 2075 7469 6c73  tangents = utils
-00020d20: 2e73 6571 7565 6e63 6966 7928 7472 6565  .sequencify(tree
-00020d30: 5f6d 6170 286c 616d 6264 6120 763a 206f  _map(lambda v: o
-00020d40: 6e65 735f 6c69 6b65 2876 292c 2066 6c61  nes_like(v), fla
-00020d50: 745f 6f75 7470 7574 2929 0a20 2020 2020  t_output)).     
-00020d60: 2020 2020 2020 2065 6c73 653a 0a20 2020         else:.   
-00020d70: 2020 2020 2020 2020 2020 2020 2063 6f74               cot
-00020d80: 616e 6765 6e74 7320 3d20 7574 696c 732e  angents = utils.
-00020d90: 7365 7175 656e 6369 6679 2874 7265 655f  sequencify(tree_
-00020da0: 6d61 7028 6c61 6d62 6461 2076 3a20 6f6e  map(lambda v: on
-00020db0: 6573 5f6c 696b 6528 7629 2c20 7472 6163  es_like(v), trac
-00020dc0: 652e 6f75 7470 7574 2929 0a20 2020 2066  e.output)).    f
-00020dd0: 696e 616c 6c79 3a0a 2020 2020 2020 2020  inally:.        
-00020de0: 7265 7365 745f 7472 6163 6563 7478 2874  reset_tracectx(t
-00020df0: 7261 6365 6374 785f 746f 6b65 6e29 0a0a  racectx_token)..
-00020e00: 2020 2020 6465 6620 6261 636b 7761 7264      def backward
-00020e10: 5f66 6e28 7361 7665 645f 666f 725f 6261  _fn(saved_for_ba
-00020e20: 636b 7761 7264 2c20 636f 7461 6e67 656e  ckward, cotangen
-00020e30: 7473 293a 0a20 2020 2020 2020 2065 6e76  ts):.        env
-00020e40: 203d 2072 6563 6f6e 7374 7275 6374 5f66   = reconstruct_f
-00020e50: 6f72 7761 7264 5f65 6e76 5f66 6f72 5f62  orward_env_for_b
-00020e60: 6163 6b77 6172 6428 7472 6163 652c 2073  ackward(trace, s
-00020e70: 6176 6564 5f66 6f72 5f62 6163 6b77 6172  aved_for_backwar
-00020e80: 6429 0a20 2020 2020 2020 2069 6620 746f  d).        if to
-00020e90: 7263 685f 6175 746f 6772 6164 3a0a 2020  rch_autograd:.  
-00020ea0: 2020 2020 2020 2020 2020 636f 7461 6e67            cotang
-00020eb0: 656e 7473 203d 2074 7265 655f 756e 666c  ents = tree_unfl
-00020ec0: 6174 7465 6e28 636f 7461 6e67 656e 7473  atten(cotangents
-00020ed0: 2c20 6f75 7470 7574 5f73 7065 6329 0a20  , output_spec). 
-00020ee0: 2020 2020 2020 206f 7574 203d 2062 6163         out = bac
-00020ef0: 6b77 6172 645f 7061 7373 2865 6e76 2c20  kward_pass(env, 
-00020f00: 7472 6163 652c 2063 6f74 616e 6765 6e74  trace, cotangent
-00020f10: 7329 0a20 2020 2020 2020 2069 6620 746f  s).        if to
-00020f20: 7263 685f 6175 746f 6772 6164 3a0a 2020  rch_autograd:.  
-00020f30: 2020 2020 2020 2020 2020 676b 7761 7267            gkwarg
-00020f40: 7320 3d20 6f75 745b 2d31 5d20 6966 2069  s = out[-1] if i
-00020f50: 7369 6e73 7461 6e63 6528 6f75 745b 2d31  sinstance(out[-1
-00020f60: 5d2c 2064 6963 7429 2065 6c73 6520 7b7d  ], dict) else {}
-00020f70: 0a20 2020 2020 2020 2020 2020 2067 6172  .            gar
-00020f80: 6773 203d 206f 7574 5b3a 2d31 5d20 6966  gs = out[:-1] if
-00020f90: 2069 7369 6e73 7461 6e63 6528 6f75 745b   isinstance(out[
-00020fa0: 2d31 5d2c 2064 6963 7429 2065 6c73 6520  -1], dict) else 
-00020fb0: 6f75 740a 2020 2020 2020 2020 2020 2020  out.            
-00020fc0: 676b 7761 7267 7320 3d20 7b6b 3a20 676b  gkwargs = {k: gk
-00020fd0: 7761 7267 732e 6765 7428 6b2c 204e 6f6e  wargs.get(k, Non
-00020fe0: 6529 2066 6f72 206b 2069 6e20 7472 6163  e) for k in trac
-00020ff0: 652e 6b77 6172 6773 7d0a 2020 2020 2020  e.kwargs}.      
-00021000: 2020 2020 2020 6f75 7420 3d20 282a 6761        out = (*ga
-00021010: 7267 732c 2067 6b77 6172 6773 290a 2020  rgs, gkwargs).  
-00021020: 2020 2020 2020 2020 2020 6f75 7420 3d20            out = 
-00021030: 7472 6565 5f66 6c61 7474 656e 286f 7574  tree_flatten(out
-00021040: 295b 305d 0a20 2020 2020 2020 2072 6574  )[0].        ret
-00021050: 7572 6e20 6f75 740a 0a20 2020 2073 6176  urn out..    sav
-00021060: 6564 5f66 6f72 5f62 6163 6b77 6172 6420  ed_for_backward 
-00021070: 3d20 666f 7277 6172 645f 7472 6163 652e  = forward_trace.
-00021080: 6f75 7470 7574 5b31 5d0a 2020 2020 6261  output[1].    ba
-00021090: 636b 7761 7264 5f74 7261 6365 203d 2063  ckward_trace = c
-000210a0: 6f6e 7374 7275 6374 5f74 7261 6365 2872  onstruct_trace(r
-000210b0: 656e 616d 655f 7072 6f78 6965 733d 4661  ename_proxies=Fa
-000210c0: 6c73 6529 2862 6163 6b77 6172 645f 666e  lse)(backward_fn
-000210d0: 2c20 7361 7665 645f 666f 725f 6261 636b  , saved_for_back
-000210e0: 7761 7264 2c20 636f 7461 6e67 656e 7473  ward, cotangents
-000210f0: 290a 0a20 2020 2023 2057 6520 6172 6520  )..    # We are 
-00021100: 646f 6e65 2077 6974 6820 636f 6e73 7472  done with constr
-00021110: 7563 7469 6e67 2074 6865 2066 6f72 7761  ucting the forwa
-00021120: 7264 2061 6e64 2062 6163 6b77 6172 6420  rd and backward 
-00021130: 7061 7373 6573 2061 7420 7468 6973 0a20  passes at this. 
-00021140: 2020 2023 2073 7461 6765 2e20 5468 6520     # stage. The 
-00021150: 666f 6c6c 6f77 696e 6720 6973 206e 6f74  following is not
-00021160: 2073 7472 6963 746c 7920 6e65 6365 7373   strictly necess
-00021170: 6172 792c 2062 7574 2069 7427 7320 676f  ary, but it's go
-00021180: 6f64 2074 6f20 6669 6c74 6572 0a20 2020  od to filter.   
-00021190: 2023 206f 7574 2074 6865 2075 6e75 7365   # out the unuse
-000211a0: 6420 656c 656d 656e 7473 206f 6620 7468  d elements of th
-000211b0: 6520 7361 7665 645f 666f 725f 6261 636b  e saved_for_back
-000211c0: 7761 7264 2061 6e64 2066 6c61 7474 656e  ward and flatten
-000211d0: 2069 7420 666f 7220 6d6f 7265 0a20 2020   it for more.   
-000211e0: 2023 2063 6f6d 7061 6374 2062 6163 6b77   # compact backw
-000211f0: 6172 6420 7472 6163 652e 0a0a 2020 2020  ard trace...    
-00021200: 2320 4e6f 7720 7765 2063 616e 2064 6574  # Now we can det
-00021210: 6572 6d69 6e65 2065 7861 6374 6c79 2077  ermine exactly w
-00021220: 6861 7427 7320 7573 6564 2069 6e20 7468  hat's used in th
-00021230: 6520 6261 636b 7761 7264 2070 6173 7320  e backward pass 
-00021240: 6672 6f6d 2074 6865 0a20 2020 2023 2073  from the.    # s
-00021250: 6176 6564 5f66 6f72 5f62 6163 6b77 6172  aved_for_backwar
-00021260: 642e 2057 6520 6361 6e20 666c 6174 7465  d. We can flatte
-00021270: 6e20 616e 6420 6669 6c74 6572 2074 6865  n and filter the
-00021280: 2073 6176 6564 5f66 6f72 5f62 6163 6b77   saved_for_backw
-00021290: 6172 640a 2020 2020 636f 6e73 756d 6572  ard.    consumer
-000212a0: 7320 3d20 7574 696c 732e 636f 6e73 756d  s = utils.consum
-000212b0: 6572 7328 6261 636b 7761 7264 5f74 7261  ers(backward_tra
-000212c0: 6365 290a 0a20 2020 2023 2046 6f72 7761  ce)..    # Forwa
-000212d0: 7264 2773 2061 6e64 2062 6163 6b77 6172  rd's and backwar
-000212e0: 6427 7320 2273 6176 6564 5f66 6f72 5f62  d's "saved_for_b
-000212f0: 6163 6b77 6172 6422 2061 7265 206e 6f74  ackward" are not
-00021300: 206e 6563 6573 7361 7269 6c79 2074 6865   necessarily the
-00021310: 2073 616d 650a 2020 2020 2320 6173 2074   same.    # as t
-00021320: 6865 2073 6176 6564 5f66 6f72 5f62 6163  he saved_for_bac
-00021330: 6b77 6172 642c 2062 6563 6175 7365 2073  kward, because s
-00021340: 6f6d 6520 6f72 2061 6c6c 2065 6c65 6d65  ome or all eleme
-00021350: 6e74 7320 6f66 2074 6865 0a20 2020 2023  nts of the.    #
-00021360: 2073 6176 6564 5f66 6f72 5f62 6163 6b77   saved_for_backw
-00021370: 6172 6420 7265 7375 6c74 7320 6d69 6768  ard results migh
-00021380: 7420 6265 2072 652d 7072 6f78 6966 6965  t be re-proxifie
-00021390: 642e 0a20 2020 2062 775f 666c 6174 5f73  d..    bw_flat_s
-000213a0: 6176 6564 5f66 6f72 5f62 6163 6b77 6172  aved_for_backwar
-000213b0: 642c 2073 7065 6320 3d20 7472 6565 5f66  d, spec = tree_f
-000213c0: 6c61 7474 656e 2862 6163 6b77 6172 645f  latten(backward_
-000213d0: 7472 6163 652e 6172 6773 5b30 5d29 0a20  trace.args[0]). 
-000213e0: 2020 2066 775f 666c 6174 5f73 6176 6564     fw_flat_saved
-000213f0: 5f66 6f72 5f62 6163 6b77 6172 642c 205f  _for_backward, _
-00021400: 203d 2074 7265 655f 666c 6174 7465 6e28   = tree_flatten(
-00021410: 666f 7277 6172 645f 7472 6163 652e 6f75  forward_trace.ou
-00021420: 7470 7574 5b31 5d29 0a20 2020 2075 7365  tput[1]).    use
-00021430: 645f 6d61 736b 203d 206c 6973 7428 6c65  d_mask = list(le
-00021440: 6e28 636f 6e73 756d 6572 732e 6765 7428  n(consumers.get(
-00021450: 782c 2028 2929 2920 3e20 3020 666f 7220  x, ())) > 0 for 
-00021460: 7820 696e 2062 775f 666c 6174 5f73 6176  x in bw_flat_sav
-00021470: 6564 5f66 6f72 5f62 6163 6b77 6172 6429  ed_for_backward)
-00021480: 0a0a 2020 2020 2320 446f 6e27 7420 7573  ..    # Don't us
-00021490: 6520 7468 6520 7361 6d65 2076 6172 6961  e the same varia
-000214a0: 626c 6520 7477 6963 6520 696e 2074 6865  ble twice in the
-000214b0: 2062 6163 6b77 6172 6420 7061 7373 0a20   backward pass. 
-000214c0: 2020 2073 6565 6e20 3d20 7365 7428 290a     seen = set().
-000214d0: 2020 2020 6672 6f6d 2074 6875 6e64 6572      from thunder
-000214e0: 2e63 6f72 652e 7072 6f78 6965 7320 696d  .core.proxies im
-000214f0: 706f 7274 2056 6172 6961 626c 650a 0a20  port Variable.. 
-00021500: 2020 2066 6f72 2069 2c20 7820 696e 2065     for i, x in e
-00021510: 6e75 6d65 7261 7465 2866 775f 666c 6174  numerate(fw_flat
-00021520: 5f73 6176 6564 5f66 6f72 5f62 6163 6b77  _saved_for_backw
-00021530: 6172 6429 3a0a 2020 2020 2020 2020 7820  ard):.        x 
-00021540: 3d20 7661 7269 6162 6c65 6966 7928 7829  = variableify(x)
-00021550: 0a20 2020 2020 2020 2069 6620 6e6f 7420  .        if not 
-00021560: 6973 696e 7374 616e 6365 2878 2c20 5661  isinstance(x, Va
-00021570: 7269 6162 6c65 293a 0a20 2020 2020 2020  riable):.       
-00021580: 2020 2020 2063 6f6e 7469 6e75 650a 2020       continue.  
-00021590: 2020 2020 2020 6966 2078 2069 6e20 7365        if x in se
-000215a0: 656e 3a0a 2020 2020 2020 2020 2020 2020  en:.            
-000215b0: 7573 6564 5f6d 6173 6b5b 695d 203d 2046  used_mask[i] = F
-000215c0: 616c 7365 0a20 2020 2020 2020 2065 6c73  alse.        els
-000215d0: 653a 0a20 2020 2020 2020 2020 2020 2073  e:.            s
-000215e0: 6565 6e2e 6164 6428 7829 0a0a 2020 2020  een.add(x)..    
-000215f0: 6f6e 6c79 5f75 7365 645f 6677 5f73 6176  only_used_fw_sav
-00021600: 6564 5f66 6f72 5f62 6163 6b77 6172 6420  ed_for_backward 
-00021610: 3d20 7475 706c 6528 636f 6d70 7265 7373  = tuple(compress
-00021620: 2866 775f 666c 6174 5f73 6176 6564 5f66  (fw_flat_saved_f
-00021630: 6f72 5f62 6163 6b77 6172 642c 2075 7365  or_backward, use
-00021640: 645f 6d61 736b 2929 0a20 2020 206f 6e6c  d_mask)).    onl
-00021650: 795f 7573 6564 5f62 775f 7361 7665 645f  y_used_bw_saved_
-00021660: 666f 725f 6261 636b 7761 7264 203d 2074  for_backward = t
-00021670: 7570 6c65 2863 6f6d 7072 6573 7328 6277  uple(compress(bw
-00021680: 5f66 6c61 745f 7361 7665 645f 666f 725f  _flat_saved_for_
-00021690: 6261 636b 7761 7264 2c20 7573 6564 5f6d  backward, used_m
-000216a0: 6173 6b29 290a 0a20 2020 2023 2057 6520  ask))..    # We 
-000216b0: 6e65 6564 2074 6f20 7570 6461 7465 2074  need to update t
-000216c0: 6865 2074 7261 6365 7320 7769 7468 2074  he traces with t
-000216d0: 6865 206e 6577 2073 6176 6564 5f66 6f72  he new saved_for
-000216e0: 5f62 6163 6b77 6172 640a 2020 2020 5f75  _backward.    _u
-000216f0: 7064 6174 655f 666f 7277 6172 645f 7769  pdate_forward_wi
-00021700: 7468 5f6e 6577 5f73 6176 6564 5f66 6f72  th_new_saved_for
-00021710: 5f62 6163 6b77 6172 6428 666f 7277 6172  _backward(forwar
-00021720: 645f 7472 6163 652c 206f 6e6c 795f 7573  d_trace, only_us
-00021730: 6564 5f66 775f 7361 7665 645f 666f 725f  ed_fw_saved_for_
-00021740: 6261 636b 7761 7264 290a 2020 2020 5f75  backward).    _u
-00021750: 7064 6174 655f 6261 636b 7761 7264 5f77  pdate_backward_w
-00021760: 6974 685f 6e65 775f 7361 7665 645f 666f  ith_new_saved_fo
-00021770: 725f 6261 636b 7761 7264 2862 6163 6b77  r_backward(backw
-00021780: 6172 645f 7472 6163 652c 206f 6e6c 795f  ard_trace, only_
-00021790: 7573 6564 5f62 775f 7361 7665 645f 666f  used_bw_saved_fo
-000217a0: 725f 6261 636b 7761 7264 290a 2020 2020  r_backward).    
-000217b0: 666f 7277 6172 645f 7472 6163 652e 7365  forward_trace.se
-000217c0: 745f 7072 6f76 656e 616e 6365 2854 7261  t_provenance(Tra
-000217d0: 6365 5072 6f76 656e 616e 6365 2822 4175  ceProvenance("Au
-000217e0: 676d 656e 7465 6420 666f 7277 6172 6420  gmented forward 
-000217f0: 7061 7373 2229 290a 2020 2020 6261 636b  pass")).    back
-00021800: 7761 7264 5f74 7261 6365 2e73 6574 5f70  ward_trace.set_p
-00021810: 726f 7665 6e61 6e63 6528 5472 6163 6550  rovenance(TraceP
-00021820: 726f 7665 6e61 6e63 6528 2242 6163 6b77  rovenance("Backw
-00021830: 6172 6420 7061 7373 2229 290a 2020 2020  ard pass")).    
-00021840: 7265 7475 726e 2046 6f72 7761 7264 4261  return ForwardBa
-00021850: 636b 7761 7264 5472 6163 6573 2866 6f72  ckwardTraces(for
-00021860: 7761 7264 5f74 7261 6365 2c20 6261 636b  ward_trace, back
-00021870: 7761 7264 5f74 7261 6365 290a 0a0a 2320  ward_trace)...# 
-00021880: 646f 2077 6520 6861 7070 656e 2074 6f20  do we happen to 
-00021890: 7761 6e74 2074 6f20 7265 6769 7374 6572  want to register
-000218a0: 2060 6c74 6f72 6368 6020 6f70 7320 7375   `ltorch` ops su
-000218b0: 6368 2061 7320 606c 746f 7263 682e 6c61  ch as `ltorch.la
-000218c0: 7965 725f 6e6f 726d 6020 6173 2077 656c  yer_norm` as wel
-000218d0: 6c3f 0a61 7574 6f63 6173 745f 696d 706c  l?.autocast_impl
-000218e0: 733a 2064 6963 745b 7072 696d 732e 5072  s: dict[prims.Pr
-000218f0: 696d 4944 732c 2043 616c 6c61 626c 655d  imIDs, Callable]
-00021900: 203d 207b 7d0a 0a0a 6465 6620 7265 6769   = {}...def regi
-00021910: 7374 6572 5f61 7574 6f63 6173 745f 7275  ster_autocast_ru
-00021920: 6c65 286f 7029 3a0a 2020 2020 6465 6620  le(op):.    def 
-00021930: 6465 636f 7261 746f 7228 6675 6e63 293a  decorator(func):
-00021940: 0a20 2020 2020 2020 2061 7574 6f63 6173  .        autocas
-00021950: 745f 696d 706c 735b 6f70 5d20 3d20 6675  t_impls[op] = fu
-00021960: 6e63 0a20 2020 2020 2020 2072 6574 7572  nc.        retur
-00021970: 6e20 6675 6e63 0a0a 2020 2020 7265 7475  n func..    retu
-00021980: 726e 2064 6563 6f72 6174 6f72 0a0a 0a64  rn decorator...d
-00021990: 6566 206d 6179 6265 5f64 6f77 6e63 6173  ef maybe_downcas
-000219a0: 745f 746f 2864 7479 7065 2c20 6172 6773  t_to(dtype, args
-000219b0: 293a 0a20 2020 2061 6c6c 6f77 6564 5f64  ):.    allowed_d
-000219c0: 6f77 6e63 6173 745f 7479 7065 7320 3d20  owncast_types = 
-000219d0: 2864 7479 7065 732e 666c 6f61 7431 362c  (dtypes.float16,
-000219e0: 2064 7479 7065 732e 6266 6c6f 6174 3136   dtypes.bfloat16
-000219f0: 2c20 6474 7970 6573 2e66 6c6f 6174 3332  , dtypes.float32
-00021a00: 290a 0a20 2020 2064 6566 206d 6170 5f66  )..    def map_f
-00021a10: 6e28 6129 3a0a 2020 2020 2020 2020 6966  n(a):.        if
-00021a20: 2069 7369 6e73 7461 6e63 6528 612c 2054   isinstance(a, T
-00021a30: 656e 736f 7250 726f 7879 2920 616e 6420  ensorProxy) and 
-00021a40: 612e 6474 7970 6520 696e 2061 6c6c 6f77  a.dtype in allow
-00021a50: 6564 5f64 6f77 6e63 6173 745f 7479 7065  ed_downcast_type
-00021a60: 733a 0a20 2020 2020 2020 2020 2020 2072  s:.            r
-00021a70: 6574 7572 6e20 6d61 7962 655f 636f 6e76  eturn maybe_conv
-00021a80: 6572 745f 746f 5f64 7479 7065 2861 2c20  ert_to_dtype(a, 
-00021a90: 6474 7970 6529 0a20 2020 2020 2020 2072  dtype).        r
-00021aa0: 6574 7572 6e20 610a 0a20 2020 2072 6574  eturn a..    ret
-00021ab0: 7572 6e20 7472 6565 5f6d 6170 286d 6170  urn tree_map(map
-00021ac0: 5f66 6e2c 2061 7267 7329 0a0a 0a40 7265  _fn, args)...@re
-00021ad0: 6769 7374 6572 5f61 7574 6f63 6173 745f  gister_autocast_
-00021ae0: 7275 6c65 2822 746f 7263 682e 6d61 746d  rule("torch.matm
-00021af0: 756c 2229 0a40 7265 6769 7374 6572 5f61  ul").@register_a
-00021b00: 7574 6f63 6173 745f 7275 6c65 2870 7269  utocast_rule(pri
-00021b10: 6d73 2e50 7269 6d49 4473 2e4d 4154 4d55  ms.PrimIDs.MATMU
-00021b20: 4c29 0a64 6566 2061 7574 6f63 6173 745f  L).def autocast_
-00021b30: 6d61 746d 756c 5f72 756c 6528 612c 2062  matmul_rule(a, b
-00021b40: 2c20 6474 7970 6529 3a0a 2020 2020 2222  , dtype):.    ""
-00021b50: 2241 7574 6f63 6173 7420 7275 6c65 2066  "Autocast rule f
-00021b60: 6f72 206d 6174 6d75 6c22 2222 0a20 2020  or matmul""".   
-00021b70: 2072 6574 7572 6e20 7072 696d 732e 6d61   return prims.ma
-00021b80: 746d 756c 282a 286d 6179 6265 5f64 6f77  tmul(*(maybe_dow
-00021b90: 6e63 6173 745f 746f 2864 7479 7065 2c20  ncast_to(dtype, 
-00021ba0: 2861 2c20 6229 2929 290a 0a0a 4072 6567  (a, b))))...@reg
-00021bb0: 6973 7465 725f 6175 746f 6361 7374 5f72  ister_autocast_r
-00021bc0: 756c 6528 2274 6f72 6368 2e6e 6e2e 6675  ule("torch.nn.fu
-00021bd0: 6e63 7469 6f6e 616c 2e6c 696e 6561 7222  nctional.linear"
-00021be0: 290a 4072 6567 6973 7465 725f 6175 746f  ).@register_auto
-00021bf0: 6361 7374 5f72 756c 6528 7072 696d 732e  cast_rule(prims.
-00021c00: 5072 696d 4944 732e 4c49 4e45 4152 290a  PrimIDs.LINEAR).
-00021c10: 6465 6620 6175 746f 6361 7374 5f6c 696e  def autocast_lin
-00021c20: 6561 725f 7275 6c65 2861 2c20 772c 2062  ear_rule(a, w, b
-00021c30: 6961 732c 2064 7479 7065 293a 0a20 2020  ias, dtype):.   
-00021c40: 2069 6620 6269 6173 2069 7320 4e6f 6e65   if bias is None
-00021c50: 3a0a 2020 2020 2020 2020 2320 446f 6e27  :.        # Don'
-00021c60: 7420 7061 7373 2060 6269 6173 6020 746f  t pass `bias` to
-00021c70: 206d 6179 6265 5f64 6f77 6e63 6173 745f   maybe_downcast_
-00021c80: 746f 2e0a 2020 2020 2020 2020 646f 776e  to..        down
-00021c90: 6361 7374 5f61 7267 7320 3d20 6d61 7962  cast_args = mayb
-00021ca0: 655f 646f 776e 6361 7374 5f74 6f28 6474  e_downcast_to(dt
-00021cb0: 7970 652c 2028 612c 2077 2929 202b 2028  ype, (a, w)) + (
-00021cc0: 6269 6173 2c29 0a20 2020 2065 6c73 653a  bias,).    else:
-00021cd0: 0a20 2020 2020 2020 2064 6f77 6e63 6173  .        downcas
-00021ce0: 745f 6172 6773 203d 206d 6179 6265 5f64  t_args = maybe_d
-00021cf0: 6f77 6e63 6173 745f 746f 2864 7479 7065  owncast_to(dtype
-00021d00: 2c20 2861 2c20 772c 2062 6961 7329 290a  , (a, w, bias)).
-00021d10: 0a20 2020 2072 6574 7572 6e20 7072 696d  .    return prim
-00021d20: 732e 6c69 6e65 6172 282a 646f 776e 6361  s.linear(*downca
-00021d30: 7374 5f61 7267 7329 0a0a 0a40 7265 6769  st_args)...@regi
-00021d40: 7374 6572 5f61 7574 6f63 6173 745f 7275  ster_autocast_ru
-00021d50: 6c65 2822 746f 7263 682e 6e6e 2e66 756e  le("torch.nn.fun
-00021d60: 6374 696f 6e61 6c2e 7363 616c 6564 5f64  ctional.scaled_d
-00021d70: 6f74 5f70 726f 6475 6374 5f61 7474 656e  ot_product_atten
-00021d80: 7469 6f6e 2229 0a64 6566 2061 7574 6f63  tion").def autoc
-00021d90: 6173 745f 7363 616c 6564 5f64 6f74 5f70  ast_scaled_dot_p
-00021da0: 726f 6475 6374 5f61 7474 656e 7469 6f6e  roduct_attention
-00021db0: 280a 2020 2020 7175 6572 792c 0a20 2020  (.    query,.   
-00021dc0: 206b 6579 2c0a 2020 2020 7661 6c75 652c   key,.    value,
-00021dd0: 0a20 2020 2061 7474 6e5f 6d61 736b 2c0a  .    attn_mask,.
-00021de0: 2020 2020 6472 6f70 6f75 745f 702c 0a20      dropout_p,. 
-00021df0: 2020 2069 735f 6361 7573 616c 2c0a 2020     is_causal,.  
-00021e00: 2020 2a2c 0a20 2020 2064 7479 7065 2c0a    *,.    dtype,.
-00021e10: 2020 2020 7363 616c 652c 0a29 3a0a 2020      scale,.):.  
-00021e20: 2020 6672 6f6d 2074 6875 6e64 6572 2e74    from thunder.t
-00021e30: 6f72 6368 2069 6d70 6f72 7420 7363 616c  orch import scal
-00021e40: 6564 5f64 6f74 5f70 726f 6475 6374 5f61  ed_dot_product_a
-00021e50: 7474 656e 7469 6f6e 0a0a 2020 2020 712c  ttention..    q,
-00021e60: 206b 2c20 7620 3d20 6d61 7962 655f 646f   k, v = maybe_do
-00021e70: 776e 6361 7374 5f74 6f28 6474 7970 652c  wncast_to(dtype,
-00021e80: 2028 7175 6572 792c 206b 6579 2c20 7661   (query, key, va
-00021e90: 6c75 6529 290a 2020 2020 7265 7475 726e  lue)).    return
-00021ea0: 2073 6361 6c65 645f 646f 745f 7072 6f64   scaled_dot_prod
-00021eb0: 7563 745f 6174 7465 6e74 696f 6e28 712c  uct_attention(q,
-00021ec0: 206b 2c20 762c 2061 7474 6e5f 6d61 736b   k, v, attn_mask
-00021ed0: 2c20 6472 6f70 6f75 745f 702c 2069 735f  , dropout_p, is_
-00021ee0: 6361 7573 616c 2c20 7363 616c 653d 7363  causal, scale=sc
-00021ef0: 616c 6529 0a0a 0a64 6566 2061 7574 6f63  ale)...def autoc
-00021f00: 6173 745f 7379 6d62 6f6c 5f6d 6170 7065  ast_symbol_mappe
-00021f10: 7228 626f 756e 645f 7379 6d62 6f6c 3a20  r(bound_symbol: 
-00021f20: 426f 756e 6453 796d 626f 6c49 6e74 6572  BoundSymbolInter
-00021f30: 6661 6365 2c20 6474 7970 653a 2064 7479  face, dtype: dty
-00021f40: 7065 732e 6474 7970 6529 3a0a 2020 2020  pes.dtype):.    
-00021f50: 2222 2252 6574 7572 6e20 7468 6520 6361  """Return the ca
-00021f60: 6c6c 6162 6c65 2069 6d70 6c65 6d65 6e74  llable implement
-00021f70: 696e 6720 7468 6520 6175 746f 6361 7374  ing the autocast
-00021f80: 2072 756c 6520 666f 7220 7468 6520 7379   rule for the sy
-00021f90: 6d62 6f6c 2e0a 0a20 2020 2041 7267 733a  mbol...    Args:
-00021fa0: 0a20 2020 2020 2020 2062 6f75 6e64 5f73  .        bound_s
-00021fb0: 796d 626f 6c3a 204d 6170 7065 6420 746f  ymbol: Mapped to
-00021fc0: 2069 7473 2061 7574 6f63 6173 7420 7275   its autocast ru
-00021fd0: 6c65 2e0a 0a20 2020 2052 6574 7572 6e73  le...    Returns
-00021fe0: 3a0a 2020 2020 2020 2020 4361 6c6c 6162  :.        Callab
-00021ff0: 6c65 3a20 5468 6520 6361 6c6c 6162 6c65  le: The callable
-00022000: 2069 6d70 6c65 6d65 6e74 696e 6720 7468   implementing th
-00022010: 6520 6175 746f 6361 7374 2072 756c 6520  e autocast rule 
-00022020: 666f 7220 7468 6520 7379 6d62 6f6c 2e0a  for the symbol..
-00022030: 2020 2020 2222 220a 2020 2020 6175 746f      """.    auto
-00022040: 6361 7374 5f69 6d70 6c3a 2043 616c 6c61  cast_impl: Calla
-00022050: 626c 6520 7c20 4e6f 6e65 203d 2061 7574  ble | None = aut
-00022060: 6f63 6173 745f 696d 706c 732e 6765 7428  ocast_impls.get(
-00022070: 626f 756e 645f 7379 6d62 6f6c 2e73 796d  bound_symbol.sym
-00022080: 2e69 6429 0a20 2020 2072 6574 7572 6e20  .id).    return 
-00022090: 626f 756e 645f 7379 6d62 6f6c 2e73 796d  bound_symbol.sym
-000220a0: 2069 6620 6175 746f 6361 7374 5f69 6d70   if autocast_imp
-000220b0: 6c20 6973 204e 6f6e 6520 656c 7365 2070  l is None else p
-000220c0: 6172 7469 616c 2861 7574 6f63 6173 745f  artial(autocast_
-000220d0: 696d 706c 2c20 6474 7970 653d 6474 7970  impl, dtype=dtyp
-000220e0: 6529 0a0a 0a64 6566 2061 7574 6f63 6173  e)...def autocas
-000220f0: 7428 6675 6e63 3a20 4361 6c6c 6162 6c65  t(func: Callable
-00022100: 2c20 6474 7970 653a 2064 7479 7065 732e  , dtype: dtypes.
-00022110: 6474 7970 6529 3a0a 2020 2020 2222 2254  dtype):.    """T
-00022120: 7261 6e73 666f 726d 7320 6120 6675 6e63  ransforms a func
-00022130: 7469 6f6e 2074 6f20 6175 746f 6361 7374  tion to autocast
-00022140: 2063 6572 7461 696e 206f 7065 7261 7469   certain operati
-00022150: 6f6e 732e 0a0a 2020 2020 4172 6773 3a0a  ons...    Args:.
-00022160: 2020 2020 2020 2020 6675 6e63 3a20 5468          func: Th
-00022170: 6520 6675 6e63 7469 6f6e 2074 6f20 6265  e function to be
-00022180: 2074 7261 6e73 666f 726d 6564 2e0a 2020   transformed..  
-00022190: 2020 2020 2020 6474 7970 653a 2054 6865        dtype: The
-000221a0: 2064 6174 6120 7479 7065 2074 6f20 7768   data type to wh
-000221b0: 6963 6820 6172 6775 6d65 6e74 7320 6f66  ich arguments of
-000221c0: 2074 6865 2066 756e 6374 696f 6e20 6f72   the function or
-000221d0: 2073 7562 2066 756e 6374 696f 6e73 2063   sub functions c
-000221e0: 6f75 6c64 2067 6574 2063 6173 7420 6966  ould get cast if
-000221f0: 0a20 2020 2020 2020 2020 2020 2074 6865  .            the
-00022200: 7920 6172 6520 6064 7479 7065 732e 666c  y are `dtypes.fl
-00022210: 6f61 7433 3260 2e0a 0a20 2020 2052 6574  oat32`...    Ret
-00022220: 7572 6e73 3a0a 2020 2020 2020 2020 4361  urns:.        Ca
-00022230: 6c6c 6162 6c65 3a20 5468 6520 7472 616e  llable: The tran
-00022240: 7366 6f72 6d65 6420 6675 6e63 7469 6f6e  sformed function
-00022250: 0a20 2020 2022 2222 0a0a 2020 2020 6966  .    """..    if
-00022260: 206e 6f74 2069 7369 6e73 7461 6e63 6528   not isinstance(
-00022270: 6474 7970 652c 2064 7479 7065 732e 6474  dtype, dtypes.dt
-00022280: 7970 6529 3a0a 2020 2020 2020 2020 7261  ype):.        ra
-00022290: 6973 6520 5661 6c75 6545 7272 6f72 2866  ise ValueError(f
-000222a0: 2260 6474 7970 6560 2069 7320 6578 7065  "`dtype` is expe
-000222b0: 6374 6564 2074 6f20 6265 2060 7468 756e  cted to be `thun
-000222c0: 6465 722e 6474 7970 652e 6474 7970 6560  der.dtype.dtype`
-000222d0: 2062 7574 207b 7479 7065 2864 7479 7065   but {type(dtype
-000222e0: 297d 2229 0a20 2020 2069 6620 6474 7970  )}").    if dtyp
-000222f0: 6520 6e6f 7420 696e 207b 6474 7970 6573  e not in {dtypes
-00022300: 2e66 6c6f 6174 3136 2c20 6474 7970 6573  .float16, dtypes
-00022310: 2e62 666c 6f61 7431 367d 3a0a 2020 2020  .bfloat16}:.    
-00022320: 2020 2020 7261 6973 6520 5661 6c75 6545      raise ValueE
-00022330: 7272 6f72 2866 2260 6474 7970 6560 2069  rror(f"`dtype` i
-00022340: 7320 6578 7065 6374 6564 2074 6f20 6265  s expected to be
-00022350: 2065 6974 6865 7220 6074 6875 6e64 6572   either `thunder
-00022360: 2e66 6c6f 6174 3136 6020 6f72 2060 7468  .float16` or `th
-00022370: 756e 6465 722e 6266 6c6f 6174 3136 602c  under.bfloat16`,
-00022380: 2062 7574 207b 6474 7970 657d 2229 0a0a   but {dtype}")..
-00022390: 2020 2020 4077 7261 7073 2866 756e 6329      @wraps(func)
-000223a0: 0a20 2020 2064 6566 2077 7261 7070 6572  .    def wrapper
-000223b0: 282a 6172 6773 2c20 2a2a 6b77 6172 6773  (*args, **kwargs
-000223c0: 293a 0a20 2020 2020 2020 2074 7261 6365  ):.        trace
-000223d0: 203d 2063 6f6e 7374 7275 6374 5f74 7261   = construct_tra
-000223e0: 6365 2829 2866 756e 632c 202a 6172 6773  ce()(func, *args
-000223f0: 2c20 2a2a 6b77 6172 6773 290a 2020 2020  , **kwargs).    
-00022400: 2020 2020 7265 7475 726e 2065 7661 6c5f      return eval_
-00022410: 7472 6163 6528 7472 6163 652c 202a 6172  trace(trace, *ar
-00022420: 6773 2c20 2a2a 6b77 6172 6773 2c20 7379  gs, **kwargs, sy
-00022430: 6d62 6f6c 5f6d 6170 7065 723d 7061 7274  mbol_mapper=part
-00022440: 6961 6c28 6175 746f 6361 7374 5f73 796d  ial(autocast_sym
-00022450: 626f 6c5f 6d61 7070 6572 2c20 6474 7970  bol_mapper, dtyp
-00022460: 653d 6474 7970 6529 290a 0a20 2020 2072  e=dtype))..    r
-00022470: 6574 7572 6e20 7772 6170 7065 720a       eturn wrapper.
+0001d300: 2073 796d 626f 6c2e 7379 6d2e 6964 203d   symbol.sym.id =
+0001d310: 3d20 2274 6f72 6368 2e6e 6e2e 6675 6e63  = "torch.nn.func
+0001d320: 7469 6f6e 616c 2e64 726f 706f 7574 2220  tional.dropout" 
+0001d330: 616e 6420 6e6f 7420 7379 6d62 6f6c 2e73  and not symbol.s
+0001d340: 7562 7379 6d62 6f6c 733a 0a20 2020 2020  ubsymbols:.     
+0001d350: 2020 2020 2020 2023 2057 6520 6361 6e20         # We can 
+0001d360: 736b 6970 2074 6865 2070 756c 6c62 6163  skip the pullbac
+0001d370: 6b20 6966 2074 6865 2064 726f 706f 7574  k if the dropout
+0001d380: 2070 726f 6261 6269 6c69 7479 2069 7320   probability is 
+0001d390: 302e 300a 2020 2020 2020 2020 2020 2020  0.0.            
+0001d3a0: 2320 4173 7375 6d69 6e67 2074 6861 7420  # Assuming that 
+0001d3b0: 7468 6520 6472 6f70 6f75 7420 7379 6d62  the dropout symb
+0001d3c0: 6f6c 2068 6173 2074 6865 2073 616d 6520  ol has the same 
+0001d3d0: 6f75 7470 7574 2061 6e64 2061 7267 756d  output and argum
+0001d3e0: 656e 740a 2020 2020 2020 2020 2020 2020  ent.            
+0001d3f0: 6173 7365 7274 2073 796d 626f 6c2e 6f75  assert symbol.ou
+0001d400: 7470 7574 2e6e 616d 6520 3d3d 2073 796d  tput.name == sym
+0001d410: 626f 6c2e 6172 6773 5b30 5d2e 6e61 6d65  bol.args[0].name
+0001d420: 2c20 2244 726f 706f 7574 2073 796d 626f  , "Dropout symbo
+0001d430: 6c20 6861 7320 6120 6469 6666 6572 656e  l has a differen
+0001d440: 7420 6f75 7470 7574 2061 6e64 2061 7267  t output and arg
+0001d450: 756d 656e 7422 0a20 2020 2020 2020 2020  ument".         
+0001d460: 2020 2069 6620 7379 6d62 6f6c 2e61 7267     if symbol.arg
+0001d470: 735b 315d 203d 3d20 302e 3020 6f72 2073  s[1] == 0.0 or s
+0001d480: 796d 626f 6c2e 6172 6773 5b32 5d20 6973  ymbol.args[2] is
+0001d490: 2046 616c 7365 3a0a 2020 2020 2020 2020   False:.        
+0001d4a0: 2020 2020 2020 2020 636f 6e74 696e 7565          continue
+0001d4b0: 0a0a 2020 2020 2020 2020 6261 636b 7761  ..        backwa
+0001d4c0: 7264 203d 2062 6163 6b77 6172 645f 696d  rd = backward_im
+0001d4d0: 706c 732e 6765 7428 7379 6d62 6f6c 2e73  pls.get(symbol.s
+0001d4e0: 796d 2e69 6429 0a20 2020 2020 2020 2061  ym.id).        a
+0001d4f0: 7567 5f66 6f72 7761 7264 203d 2061 7567  ug_forward = aug
+0001d500: 6d65 6e74 6564 5f66 6f72 7761 7264 5f69  mented_forward_i
+0001d510: 6d70 6c73 2e67 6574 2873 796d 626f 6c2e  mpls.get(symbol.
+0001d520: 7379 6d2e 6964 290a 0a20 2020 2020 2020  sym.id)..       
+0001d530: 2069 6620 5f67 6574 5f67 7261 6466 6e5f   if _get_gradfn_
+0001d540: 616e 645f 6578 6563 7574 6f72 2873 796d  and_executor(sym
+0001d550: 626f 6c29 5b30 5d20 6973 206e 6f74 204e  bol)[0] is not N
+0001d560: 6f6e 653a 0a20 2020 2020 2020 2020 2020  one:.           
+0001d570: 2061 7567 5f66 6f72 7761 7264 2c20 6261   aug_forward, ba
+0001d580: 636b 7761 7264 203d 206d 616b 655f 6175  ckward = make_au
+0001d590: 675f 666f 7277 6172 645f 616e 645f 6261  g_forward_and_ba
+0001d5a0: 636b 7761 7264 2873 796d 626f 6c29 0a0a  ckward(symbol)..
+0001d5b0: 2020 2020 2020 2020 6966 2062 6163 6b77          if backw
+0001d5c0: 6172 6420 6973 204e 6f6e 653a 0a20 2020  ard is None:.   
+0001d5d0: 2020 2020 2020 2020 2069 6620 6c65 6e28           if len(
+0001d5e0: 7379 6d62 6f6c 2e73 7562 7379 6d62 6f6c  symbol.subsymbol
+0001d5f0: 7329 203e 2030 2061 6e64 206e 6f74 2069  s) > 0 and not i
+0001d600: 7369 6e73 7461 6e63 6528 7379 6d62 6f6c  sinstance(symbol
+0001d610: 2e73 796d 2e69 642c 2070 7269 6d73 2e50  .sym.id, prims.P
+0001d620: 7269 6d49 4473 293a 0a20 2020 2020 2020  rimIDs):.       
+0001d630: 2020 2020 2020 2020 2023 2057 6520 636f           # We co
+0001d640: 756c 6420 6e6f 7420 6669 6e64 2061 2062  uld not find a b
+0001d650: 6163 6b77 6172 6420 666f 7220 7468 6973  ackward for this
+0001d660: 2073 796d 626f 6c2c 2073 6f20 7765 2074   symbol, so we t
+0001d670: 7279 2074 6f20 6465 636f 6d70 6f73 6520  ry to decompose 
+0001d680: 6974 0a20 2020 2020 2020 2020 2020 2020  it.             
+0001d690: 2020 2062 6163 6b77 6172 6420 3d20 7061     backward = pa
+0001d6a0: 7274 6961 6c28 6465 636f 6d70 6f73 6564  rtial(decomposed
+0001d6b0: 5f66 6e5f 6261 636b 7761 7264 5f72 756c  _fn_backward_rul
+0001d6c0: 652c 2073 796d 626f 6c2e 7379 6d29 0a20  e, symbol.sym). 
+0001d6d0: 2020 2020 2020 2020 2020 2065 6c73 653a             else:
+0001d6e0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0001d6f0: 2023 2057 6520 636f 756c 6420 6e6f 7420   # We could not 
+0001d700: 6669 6e64 2061 2062 6163 6b77 6172 6420  find a backward 
+0001d710: 666f 7220 7468 6973 2073 796d 626f 6c20  for this symbol 
+0001d720: 616e 6420 7765 2063 6f75 6c64 206e 6f74  and we could not
+0001d730: 2064 6563 6f6d 706f 7365 2069 740a 2020   decompose it.  
+0001d740: 2020 2020 2020 2020 2020 2020 2020 7261                ra
+0001d750: 6973 6520 4e6f 7449 6d70 6c65 6d65 6e74  ise NotImplement
+0001d760: 6564 4572 726f 7228 6622 4261 636b 7761  edError(f"Backwa
+0001d770: 7264 2066 6f72 207b 7379 6d62 6f6c 2e73  rd for {symbol.s
+0001d780: 796d 2e69 647d 2069 7320 6e6f 7420 696d  ym.id} is not im
+0001d790: 706c 656d 656e 7465 6422 290a 0a20 2020  plemented")..   
+0001d7a0: 2020 2020 2072 6573 756c 7420 3d20 6261       result = ba
+0001d7b0: 636b 7761 7264 282a 7265 7369 6475 616c  ckward(*residual
+0001d7c0: 732c 202a 636f 7461 6e67 656e 7473 290a  s, *cotangents).
+0001d7d0: 2020 2020 2020 2020 6966 2069 7369 6e73          if isins
+0001d7e0: 7461 6e63 6528 7265 7375 6c74 2c20 6469  tance(result, di
+0001d7f0: 6374 293a 0a20 2020 2020 2020 2020 2020  ct):.           
+0001d800: 2023 2049 6620 7468 6520 6261 636b 7761   # If the backwa
+0001d810: 7264 2072 6574 7572 6e73 2061 2064 6963  rd returns a dic
+0001d820: 742c 2077 6520 6173 7375 6d65 2074 6861  t, we assume tha
+0001d830: 7420 6974 2069 7320 6120 6469 6374 206f  t it is a dict o
+0001d840: 660a 2020 2020 2020 2020 2020 2020 2320  f.            # 
+0001d850: 666f 7277 6172 6420 6172 6775 6d65 6e74  forward argument
+0001d860: 7320 746f 2074 6865 2063 6f72 7265 7370  s to the corresp
+0001d870: 6f6e 6469 6e67 0a20 2020 2020 2020 2020  onding.         
+0001d880: 2020 2023 2067 7261 6469 656e 7473 2f63     # gradients/c
+0001d890: 6f74 616e 6765 6e74 732f 6164 6a6f 696e  otangents/adjoin
+0001d8a0: 7473 2f73 656e 7369 7469 7669 7469 6573  ts/sensitivities
+0001d8b0: 2e0a 2020 2020 2020 2020 2020 2020 7573  ..            us
+0001d8c0: 6564 5f6e 616d 6573 203d 2073 6574 2829  ed_names = set()
+0001d8d0: 0a20 2020 2020 2020 2020 2020 2066 6f72  .            for
+0001d8e0: 2069 2c20 286b 2c20 7629 2069 6e20 656e   i, (k, v) in en
+0001d8f0: 756d 6572 6174 6528 696e 7370 6563 742e  umerate(inspect.
+0001d900: 7369 676e 6174 7572 6528 6175 675f 666f  signature(aug_fo
+0001d910: 7277 6172 6429 2e70 6172 616d 6574 6572  rward).parameter
+0001d920: 732e 6974 656d 7328 2929 3a0a 2020 2020  s.items()):.    
+0001d930: 2020 2020 2020 2020 2020 2020 6966 2076              if v
+0001d940: 2e6b 696e 6420 696e 2028 696e 7370 6563  .kind in (inspec
+0001d950: 742e 5061 7261 6d65 7465 722e 504f 5349  t.Parameter.POSI
+0001d960: 5449 4f4e 414c 5f4f 4e4c 592c 2069 6e73  TIONAL_ONLY, ins
+0001d970: 7065 6374 2e50 6172 616d 6574 6572 2e50  pect.Parameter.P
+0001d980: 4f53 4954 494f 4e41 4c5f 4f52 5f4b 4559  OSITIONAL_OR_KEY
+0001d990: 574f 5244 293a 0a20 2020 2020 2020 2020  WORD):.         
+0001d9a0: 2020 2020 2020 2020 2020 2070 7574 5f67             put_g
+0001d9b0: 7261 6428 7379 6d62 6f6c 2e61 7267 735b  rad(symbol.args[
+0001d9c0: 695d 2c20 7265 7375 6c74 2e67 6574 286b  i], result.get(k
+0001d9d0: 2c20 4e6f 6e65 2929 0a20 2020 2020 2020  , None)).       
+0001d9e0: 2020 2020 2020 2020 2020 2020 2075 7365               use
+0001d9f0: 645f 6e61 6d65 732e 6164 6428 6b29 0a0a  d_names.add(k)..
+0001da00: 2020 2020 2020 2020 2020 2020 2320 466f              # Fo
+0001da10: 7220 6465 7665 6c6f 7065 7220 636f 6e76  r developer conv
+0001da20: 656e 6965 6e63 652c 2077 6520 616c 6c6f  enience, we allo
+0001da30: 7720 7573 696e 6720 7468 6520 6e61 6d65  w using the name
+0001da40: 2066 726f 6d20 7468 650a 2020 2020 2020   from the.      
+0001da50: 2020 2020 2020 2320 666f 7277 6172 6420        # forward 
+0001da60: 6d65 7461 2069 6e20 6164 6469 7469 6f6e  meta in addition
+0001da70: 2074 6f20 7468 6520 6e61 6d65 2066 726f   to the name fro
+0001da80: 6d20 7468 6520 6175 676d 656e 7465 6420  m the augmented 
+0001da90: 666f 7277 6172 640a 2020 2020 2020 2020  forward.        
+0001daa0: 2020 2020 2320 7369 676e 6174 7572 652e      # signature.
+0001dab0: 0a20 2020 2020 2020 2020 2020 2023 2049  .            # I
+0001dac0: 6620 626f 7468 206e 616d 6573 2061 7265  f both names are
+0001dad0: 2075 7365 642c 2074 6865 206f 6e65 2066   used, the one f
+0001dae0: 726f 6d20 7468 6520 666f 7277 6172 6420  rom the forward 
+0001daf0: 6d65 7461 2074 616b 6573 0a20 2020 2020  meta takes.     
+0001db00: 2020 2020 2020 2023 2070 7265 6365 6465         # precede
+0001db10: 6e63 652e 0a20 2020 2020 2020 2020 2020  nce..           
+0001db20: 2066 6f72 2069 2c20 286b 2c20 7629 2069   for i, (k, v) i
+0001db30: 6e20 656e 756d 6572 6174 6528 696e 7370  n enumerate(insp
+0001db40: 6563 742e 7369 676e 6174 7572 6528 7379  ect.signature(sy
+0001db50: 6d62 6f6c 2e73 796d 2e6d 6574 6129 2e70  mbol.sym.meta).p
+0001db60: 6172 616d 6574 6572 732e 6974 656d 7328  arameters.items(
+0001db70: 2929 3a0a 2020 2020 2020 2020 2020 2020  )):.            
+0001db80: 2020 2020 6966 2076 2e6b 696e 6420 696e      if v.kind in
+0001db90: 2028 696e 7370 6563 742e 5061 7261 6d65   (inspect.Parame
+0001dba0: 7465 722e 504f 5349 5449 4f4e 414c 5f4f  ter.POSITIONAL_O
+0001dbb0: 4e4c 592c 2069 6e73 7065 6374 2e50 6172  NLY, inspect.Par
+0001dbc0: 616d 6574 6572 2e50 4f53 4954 494f 4e41  ameter.POSITIONA
+0001dbd0: 4c5f 4f52 5f4b 4559 574f 5244 293a 0a20  L_OR_KEYWORD):. 
+0001dbe0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001dbf0: 2020 2069 6620 6b20 6e6f 7420 696e 2075     if k not in u
+0001dc00: 7365 645f 6e61 6d65 733a 0a20 2020 2020  sed_names:.     
+0001dc10: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001dc20: 2020 2070 7574 5f67 7261 6428 7379 6d62     put_grad(symb
+0001dc30: 6f6c 2e61 7267 735b 695d 2c20 7265 7375  ol.args[i], resu
+0001dc40: 6c74 2e67 6574 286b 2c20 4e6f 6e65 2929  lt.get(k, None))
+0001dc50: 0a20 2020 2020 2020 2020 2020 2063 6f6e  .            con
+0001dc60: 7469 6e75 650a 0a20 2020 2020 2020 2069  tinue..        i
+0001dc70: 6620 6e6f 7420 6973 696e 7374 616e 6365  f not isinstance
+0001dc80: 2872 6573 756c 742c 2053 6571 7565 6e63  (result, Sequenc
+0001dc90: 6529 3a0a 2020 2020 2020 2020 2020 2020  e):.            
+0001dca0: 7265 7375 6c74 203d 2028 7265 7375 6c74  result = (result
+0001dcb0: 2c29 0a0a 2020 2020 2020 2020 6465 6620  ,)..        def 
+0001dcc0: 6973 5f64 6966 6665 7265 6e74 6961 626c  is_differentiabl
+0001dcd0: 6528 6172 6729 3a0a 2020 2020 2020 2020  e(arg):.        
+0001dce0: 2020 2020 6d61 7463 6820 6172 673a 0a20      match arg:. 
+0001dcf0: 2020 2020 2020 2020 2020 2020 2020 2063                 c
+0001dd00: 6173 6520 5465 6e73 6f72 5072 6f78 7928  ase TensorProxy(
+0001dd10: 293a 0a20 2020 2020 2020 2020 2020 2020  ):.             
+0001dd20: 2020 2020 2020 2072 6574 7572 6e20 6474         return dt
+0001dd30: 7970 6573 2e69 735f 696e 6578 6163 745f  ypes.is_inexact_
+0001dd40: 6474 7970 6528 6172 672e 6474 7970 6529  dtype(arg.dtype)
+0001dd50: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0001dd60: 2063 6173 6520 5365 7175 656e 6365 2829   case Sequence()
+0001dd70: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+0001dd80: 2020 2020 2020 7265 7475 726e 2061 7267        return arg
+0001dd90: 2061 6e64 2061 6c6c 2869 7369 6e73 7461   and all(isinsta
+0001dda0: 6e63 6528 782c 2054 656e 736f 7250 726f  nce(x, TensorPro
+0001ddb0: 7879 2920 616e 6420 6474 7970 6573 2e69  xy) and dtypes.i
+0001ddc0: 735f 696e 6578 6163 745f 6474 7970 6528  s_inexact_dtype(
+0001ddd0: 782e 6474 7970 6529 2066 6f72 2078 2069  x.dtype) for x i
+0001dde0: 6e20 6172 6729 0a20 2020 2020 2020 2020  n arg).         
+0001ddf0: 2020 2020 2020 2063 6173 6520 5f3a 0a20         case _:. 
+0001de00: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001de10: 2020 2072 6574 7572 6e20 4661 6c73 650a     return False.
+0001de20: 0a20 2020 2020 2020 2069 6620 6c65 6e28  .        if len(
+0001de30: 7379 6d62 6f6c 2e61 7267 7329 2021 3d20  symbol.args) != 
+0001de40: 286f 7269 675f 7265 735f 6c65 6e20 3a3d  (orig_res_len :=
+0001de50: 206c 656e 2872 6573 756c 7429 293a 0a20   len(result)):. 
+0001de60: 2020 2020 2020 2020 2020 2063 6865 636b             check
+0001de70: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
+0001de80: 2020 6f72 6967 5f72 6573 5f6c 656e 203c    orig_res_len <
+0001de90: 3d20 6c65 6e28 7379 6d62 6f6c 2e61 7267  = len(symbol.arg
+0001dea0: 7329 2c0a 2020 2020 2020 2020 2020 2020  s),.            
+0001deb0: 2020 2020 6c61 6d62 6461 3a20 6622 4261      lambda: f"Ba
+0001dec0: 636b 7761 7264 2066 6f72 207b 7379 6d62  ckward for {symb
+0001ded0: 6f6c 2e73 796d 2e69 647d 2072 6574 7572  ol.sym.id} retur
+0001dee0: 6e65 6420 7b6f 7269 675f 7265 735f 6c65  ned {orig_res_le
+0001def0: 6e7d 2076 616c 7565 732c 2022 0a20 2020  n} values, ".   
+0001df00: 2020 2020 2020 2020 2020 2020 202b 2066               + f
+0001df10: 2262 7574 2065 7870 6563 7465 6420 6174  "but expected at
+0001df20: 206d 6f73 7420 7b6c 656e 2873 796d 626f   most {len(symbo
+0001df30: 6c2e 6172 6773 297d 222c 0a20 2020 2020  l.args)}",.     
+0001df40: 2020 2020 2020 2029 0a20 2020 2020 2020         ).       
+0001df50: 2020 2020 2023 2041 7373 756d 696e 6720       # Assuming 
+0001df60: 7468 6174 2074 6865 206e 6f6e 2d64 6966  that the non-dif
+0001df70: 6665 7265 6e74 6961 626c 6520 6172 6775  ferentiable argu
+0001df80: 6d65 6e74 7320 7765 7265 2064 726f 7070  ments were dropp
+0001df90: 6564 2066 726f 6d0a 2020 2020 2020 2020  ed from.        
+0001dfa0: 2020 2020 2320 7468 6520 6261 636b 7761      # the backwa
+0001dfb0: 7264 2066 756e 6374 696f 6e2c 2077 6520  rd function, we 
+0001dfc0: 6172 6520 676f 696e 6720 746f 2061 7070  are going to app
+0001dfd0: 656e 6420 4e6f 6e65 2074 6f20 7468 6520  end None to the 
+0001dfe0: 7265 7375 6c74 0a20 2020 2020 2020 2020  result.         
+0001dff0: 2020 2023 2074 6f20 6d61 7463 6820 7468     # to match th
+0001e000: 6520 6e75 6d62 6572 206f 6620 6172 6775  e number of argu
+0001e010: 6d65 6e74 732e 2041 6c74 6572 6e61 7469  ments. Alternati
+0001e020: 7665 6c79 2c20 7765 2063 6f75 6c64 206a  vely, we could j
+0001e030: 7573 740a 2020 2020 2020 2020 2020 2020  ust.            
+0001e040: 2320 6861 7665 2061 2066 6f72 2d6c 6f6f  # have a for-loo
+0001e050: 7020 7769 7468 2061 2063 6f6e 6469 7469  p with a conditi
+0001e060: 6f6e 616c 2077 6865 6e20 7772 6974 696e  onal when writin
+0001e070: 6720 746f 2074 6865 0a20 2020 2020 2020  g to the.       
+0001e080: 2020 2020 2023 2065 6e76 6972 6f6e 6d65       # environme
+0001e090: 6e74 2e0a 0a20 2020 2020 2020 2020 2020  nt...           
+0001e0a0: 2069 7465 725f 7265 7375 6c74 203d 2069   iter_result = i
+0001e0b0: 7465 7228 7265 7375 6c74 290a 2020 2020  ter(result).    
+0001e0c0: 2020 2020 2020 2020 6e5f 6469 6666 6572          n_differ
+0001e0d0: 656e 7469 6162 6c65 5f61 7267 7320 3d20  entiable_args = 
+0001e0e0: 7375 6d28 626f 6f6c 2869 735f 6469 6666  sum(bool(is_diff
+0001e0f0: 6572 656e 7469 6162 6c65 2861 7267 2929  erentiable(arg))
+0001e100: 2066 6f72 2061 7267 2069 6e20 7379 6d62   for arg in symb
+0001e110: 6f6c 2e61 7267 7329 0a20 2020 2020 2020  ol.args).       
+0001e120: 2020 2020 2063 6865 636b 280a 2020 2020       check(.    
+0001e130: 2020 2020 2020 2020 2020 2020 6e5f 6469              n_di
+0001e140: 6666 6572 656e 7469 6162 6c65 5f61 7267  fferentiable_arg
+0001e150: 7320 3c3d 206f 7269 675f 7265 735f 6c65  s <= orig_res_le
+0001e160: 6e2c 0a20 2020 2020 2020 2020 2020 2020  n,.             
+0001e170: 2020 206c 616d 6264 613a 2066 2242 6163     lambda: f"Bac
+0001e180: 6b77 6172 6420 666f 7220 7b73 796d 626f  kward for {symbo
+0001e190: 6c2e 7379 6d2e 6964 7d20 7265 7475 726e  l.sym.id} return
+0001e1a0: 6564 207b 6f72 6967 5f72 6573 5f6c 656e  ed {orig_res_len
+0001e1b0: 7d20 7661 6c75 6528 7329 2c20 220a 2020  } value(s), ".  
+0001e1c0: 2020 2020 2020 2020 2020 2020 2020 2b20                + 
+0001e1d0: 6622 6275 7420 6578 7065 6374 6564 207b  f"but expected {
+0001e1e0: 6e5f 6469 6666 6572 656e 7469 6162 6c65  n_differentiable
+0001e1f0: 5f61 7267 737d 222c 0a20 2020 2020 2020  _args}",.       
+0001e200: 2020 2020 2029 0a0a 2020 2020 2020 2020       )..        
+0001e210: 2020 2020 7265 7375 6c74 203d 2074 7570      result = tup
+0001e220: 6c65 286e 6578 7428 6974 6572 5f72 6573  le(next(iter_res
+0001e230: 756c 7429 2069 6620 6973 5f64 6966 6665  ult) if is_diffe
+0001e240: 7265 6e74 6961 626c 6528 6172 6729 2065  rentiable(arg) e
+0001e250: 6c73 6520 4e6f 6e65 2066 6f72 2061 7267  lse None for arg
+0001e260: 2069 6e20 7379 6d62 6f6c 2e61 7267 7329   in symbol.args)
+0001e270: 0a0a 2020 2020 2020 2020 2320 5365 6520  ..        # See 
+0001e280: 2242 6163 6b77 6172 6420 696d 706c 2066  "Backward impl f
+0001e290: 6f72 206f 7073 206f 6620 7468 6520 7479  or ops of the ty
+0001e2a0: 7065 2053 6571 7565 6e63 655b 5465 6e73  pe Sequence[Tens
+0001e2b0: 6f72 5072 6f78 795d 2c20 2e2e 2e20 2d3e  orProxy], ... ->
+0001e2c0: 202e 2e2e 2072 6573 756c 7473 2069 6e20   ... results in 
+0001e2d0: 4e6f 6e65 2067 7261 6473 2e22 0a20 2020  None grads.".   
+0001e2e0: 2020 2020 2023 2054 6869 7320 6973 2061       # This is a
+0001e2f0: 2074 656d 706f 7261 7279 2077 6f72 6b61   temporary worka
+0001e300: 726f 756e 642e 0a20 2020 2020 2020 2069  round..        i
+0001e310: 6620 7379 6d62 6f6c 2e73 796d 2e69 6420  f symbol.sym.id 
+0001e320: 696e 2028 7072 696d 732e 5072 696d 4944  in (prims.PrimID
+0001e330: 732e 4341 542c 2022 746f 7263 682e 6361  s.CAT, "torch.ca
+0001e340: 7422 2c20 2274 6f72 6368 2e73 7461 636b  t", "torch.stack
+0001e350: 2229 3a0a 2020 2020 2020 2020 2020 2020  "):.            
+0001e360: 7361 6665 5f6d 6170 5f66 6c61 7428 7075  safe_map_flat(pu
+0001e370: 745f 6772 6164 2c20 7379 6d62 6f6c 2e61  t_grad, symbol.a
+0001e380: 7267 732c 2072 6573 756c 7429 0a20 2020  rgs, result).   
+0001e390: 2020 2020 2065 6c73 653a 0a20 2020 2020       else:.     
+0001e3a0: 2020 2020 2020 2073 6166 655f 6d61 7028         safe_map(
+0001e3b0: 7075 745f 6772 6164 2c20 7379 6d62 6f6c  put_grad, symbol
+0001e3c0: 2e61 7267 732c 2072 6573 756c 7429 0a0a  .args, result)..
+0001e3d0: 2020 2020 6465 6620 6765 745f 696e 6578      def get_inex
+0001e3e0: 6163 745f 6474 7970 655f 6f72 5f6e 6f6e  act_dtype_or_non
+0001e3f0: 6528 7829 3a0a 2020 2020 2020 2020 6966  e(x):.        if
+0001e400: 2069 7369 6e73 7461 6e63 6528 782c 2028   isinstance(x, (
+0001e410: 5465 6e73 6f72 5072 6f78 792c 2046 7574  TensorProxy, Fut
+0001e420: 7572 6554 656e 736f 7250 726f 7879 2929  ureTensorProxy))
+0001e430: 2061 6e64 2064 7479 7065 732e 6973 5f69   and dtypes.is_i
+0001e440: 6e65 7861 6374 5f64 7479 7065 2878 2e64  nexact_dtype(x.d
+0001e450: 7479 7065 293a 0a20 2020 2020 2020 2020  type):.         
+0001e460: 2020 2072 6574 7572 6e20 780a 2020 2020     return x.    
+0001e470: 2020 2020 656c 7365 3a0a 2020 2020 2020      else:.      
+0001e480: 2020 2020 2020 7265 7475 726e 204e 6f6e        return Non
+0001e490: 650a 0a20 2020 2067 6172 6773 203d 2074  e..    gargs = t
+0001e4a0: 7265 655f 6d61 7028 6765 745f 6772 6164  ree_map(get_grad
+0001e4b0: 2c20 7475 706c 6528 7472 6163 652e 6172  , tuple(trace.ar
+0001e4c0: 6773 2929 0a20 2020 2067 6b77 6172 6773  gs)).    gkwargs
+0001e4d0: 203d 2074 7265 655f 6d61 7028 6765 745f   = tree_map(get_
+0001e4e0: 6772 6164 2c20 7472 6163 652e 6b77 6172  grad, trace.kwar
+0001e4f0: 6773 290a 2020 2020 676b 7761 7267 7320  gs).    gkwargs 
+0001e500: 3d20 7b6b 3a20 7620 666f 7220 6b2c 2076  = {k: v for k, v
+0001e510: 2069 6e20 676b 7761 7267 732e 6974 656d   in gkwargs.item
+0001e520: 7328 2920 6966 2076 2069 7320 6e6f 7420  s() if v is not 
+0001e530: 4e6f 6e65 7d0a 2020 2020 6761 7267 732c  None}.    gargs,
+0001e540: 2067 6b77 6172 6773 203d 2074 7265 655f   gkwargs = tree_
+0001e550: 6d61 7028 6765 745f 696e 6578 6163 745f  map(get_inexact_
+0001e560: 6474 7970 655f 6f72 5f6e 6f6e 652c 2028  dtype_or_none, (
+0001e570: 6761 7267 732c 2067 6b77 6172 6773 2929  gargs, gkwargs))
+0001e580: 0a20 2020 2072 6574 7572 6e20 6761 7267  .    return garg
+0001e590: 7320 2b20 2867 6b77 6172 6773 2c29 2069  s + (gkwargs,) i
+0001e5a0: 6620 6c65 6e28 676b 7761 7267 7329 2021  f len(gkwargs) !
+0001e5b0: 3d20 3020 656c 7365 2067 6172 6773 0a0a  = 0 else gargs..
+0001e5c0: 0a64 6566 2076 6a70 5f63 616c 6c5f 6d65  .def vjp_call_me
+0001e5d0: 7461 6675 6e63 2864 6574 6163 6865 643a  tafunc(detached:
+0001e5e0: 2062 6f6f 6c2c 2070 7269 6d61 6c73 2c20   bool, primals, 
+0001e5f0: 636f 7461 6e67 656e 7473 2c20 7472 6163  cotangents, trac
+0001e600: 653a 2054 7261 6365 2c20 2a2a 6b77 6172  e: Trace, **kwar
+0001e610: 6773 293a 0a20 2020 2023 2041 7373 756d  gs):.    # Assum
+0001e620: 696e 6720 7072 696d 616c 7320 6973 2066  ing primals is f
+0001e630: 6c61 740a 0a20 2020 2069 6620 6e6f 7420  lat..    if not 
+0001e640: 6973 696e 7374 616e 6365 2870 7269 6d61  isinstance(prima
+0001e650: 6c73 2c20 5365 7175 656e 6365 293a 0a20  ls, Sequence):. 
+0001e660: 2020 2020 2020 2070 7269 6d61 6c73 203d         primals =
+0001e670: 2028 7072 696d 616c 732c 290a 0a20 2020   (primals,)..   
+0001e680: 2063 7478 203d 2064 6574 6163 6865 645f   ctx = detached_
+0001e690: 7472 6163 6528 2920 6966 2064 6574 6163  trace() if detac
+0001e6a0: 6865 6420 656c 7365 206e 756c 6c63 6f6e  hed else nullcon
+0001e6b0: 7465 7874 2829 0a20 2020 2077 6974 6820  text().    with 
+0001e6c0: 6374 783a 0a20 2020 2020 2020 2072 6573  ctx:.        res
+0001e6d0: 756c 742c 2065 6e76 203d 2061 7567 6d65  ult, env = augme
+0001e6e0: 6e74 6564 5f66 6f72 7761 7264 5f70 6173  nted_forward_pas
+0001e6f0: 7328 2a70 7269 6d61 6c73 2c20 7472 6163  s(*primals, trac
+0001e700: 653d 7472 6163 652c 202a 2a6b 7761 7267  e=trace, **kwarg
+0001e710: 7329 0a20 2020 2020 2020 2063 6865 636b  s).        check
+0001e720: 280a 2020 2020 2020 2020 2020 2020 6c65  (.            le
+0001e730: 6e28 7265 7375 6c74 2920 3d3d 206c 656e  n(result) == len
+0001e740: 2863 6f74 616e 6765 6e74 7329 2069 6620  (cotangents) if 
+0001e750: 6973 696e 7374 616e 6365 2872 6573 756c  isinstance(resul
+0001e760: 742c 2053 6571 7565 6e63 6529 2065 6c73  t, Sequence) els
+0001e770: 6520 5472 7565 2c0a 2020 2020 2020 2020  e True,.        
+0001e780: 2020 2020 6c61 6d62 6461 3a20 6622 4578      lambda: f"Ex
+0001e790: 7065 6374 6564 2063 6f74 616e 6765 6e74  pected cotangent
+0001e7a0: 7320 746f 2062 6520 6120 7365 7175 656e  s to be a sequen
+0001e7b0: 6365 206f 6620 6c65 6e67 7468 207b 6c65  ce of length {le
+0001e7c0: 6e28 7265 7375 6c74 297d 2c20 676f 7420  n(result)}, got 
+0001e7d0: 6120 7365 7175 656e 6365 206f 6620 6c65  a sequence of le
+0001e7e0: 6e67 7468 207b 6c65 6e28 636f 7461 6e67  ngth {len(cotang
+0001e7f0: 656e 7473 297d 222c 0a20 2020 2020 2020  ents)}",.       
+0001e800: 2029 0a20 2020 2020 2020 2072 6574 7572   ).        retur
+0001e810: 6e20 7265 7375 6c74 2c20 6261 636b 7761  n result, backwa
+0001e820: 7264 5f70 6173 7328 656e 762c 2074 7261  rd_pass(env, tra
+0001e830: 6365 2c20 636f 7461 6e67 656e 7473 290a  ce, cotangents).
+0001e840: 0a0a 2320 544f 444f 3a20 4361 6e27 7420  ..# TODO: Can't 
+0001e850: 7573 6520 6120 5379 6d62 6f6c 2068 6572  use a Symbol her
+0001e860: 6520 6265 6361 7573 6520 6d69 7865 6420  e because mixed 
+0001e870: 6578 6563 7574 6f72 2073 7962 7379 6d62  executor sybsymb
+0001e880: 6f6c 7320 7365 656d 2074 6f20 6265 0a23  ols seem to be.#
+0001e890: 2075 6e73 7570 706f 7274 6564 2e20 5365   unsupported. Se
+0001e8a0: 6520 6973 7375 6520 2243 6f75 6c64 206e  e issue "Could n
+0001e8b0: 6f74 2066 696e 6420 616e 2065 7865 6375  ot find an execu
+0001e8c0: 746f 7220 666f 7220 626f 756e 6420 7379  tor for bound sy
+0001e8d0: 6d62 6f6c 2077 6865 6e20 6974 7320 7375  mbol when its su
+0001e8e0: 6273 796d 626f 6c73 0a23 2061 7265 206e  bsymbols.# are n
+0001e8f0: 6f74 2066 756c 6c79 2073 7570 706f 7274  ot fully support
+0001e900: 6564 2062 7920 6120 7369 6e67 6c65 2065  ed by a single e
+0001e910: 7865 6375 746f 7222 0a76 6a70 5f63 616c  xecutor".vjp_cal
+0001e920: 6c20 3d20 7061 7274 6961 6c28 0a20 2020  l = partial(.   
+0001e930: 2076 6a70 5f63 616c 6c5f 6d65 7461 6675   vjp_call_metafu
+0001e940: 6e63 2c20 4661 6c73 650a 2920 2023 2053  nc, False.)  # S
+0001e950: 796d 626f 6c28 6964 3d54 7261 6e73 666f  ymbol(id=Transfo
+0001e960: 726d 732e 566a 704f 702c 206e 616d 653d  rms.VjpOp, name=
+0001e970: 2276 6a70 5f63 616c 6c22 2c20 6d65 7461  "vjp_call", meta
+0001e980: 3d70 6172 7469 616c 2876 6a70 5f63 616c  =partial(vjp_cal
+0001e990: 6c5f 6d65 7461 6675 6e63 2c20 4661 6c73  l_metafunc, Fals
+0001e9a0: 6529 290a 0a0a 6465 6620 766a 7028 6675  e))...def vjp(fu
+0001e9b0: 6e63 293a 0a20 2020 2022 2222 436f 6d70  nc):.    """Comp
+0001e9c0: 7574 6573 2074 6865 2056 4a50 206f 6620  utes the VJP of 
+0001e9d0: 6120 6675 6e63 7469 6f6e 2e0a 0a20 2020  a function...   
+0001e9e0: 2041 7267 733a 0a20 2020 2020 2020 2066   Args:.        f
+0001e9f0: 756e 6320 2843 616c 6c61 626c 6529 3a20  unc (Callable): 
+0001ea00: 4675 6e63 7469 6f6e 2074 6f20 6265 2064  Function to be d
+0001ea10: 6966 6665 7265 6e74 6961 7465 642e 0a20  ifferentiated.. 
+0001ea20: 2020 2022 2222 0a0a 2020 2020 6465 6620     """..    def 
+0001ea30: 5f76 6a70 2870 7269 6d61 6c73 2c20 636f  _vjp(primals, co
+0001ea40: 7461 6e67 656e 7473 2c20 2a2a 6b77 6172  tangents, **kwar
+0001ea50: 6773 293a 0a20 2020 2020 2020 2066 6c61  gs):.        fla
+0001ea60: 745f 6675 6e63 2c20 666c 6174 5f61 7267  t_func, flat_arg
+0001ea70: 732c 2073 7065 6320 3d20 666c 6174 7465  s, spec = flatte
+0001ea80: 6e5f 6675 6e63 2866 756e 632c 2070 7269  n_func(func, pri
+0001ea90: 6d61 6c73 2c20 6b77 6172 6773 290a 2020  mals, kwargs).  
+0001eaa0: 2020 2020 2020 7472 6163 6520 3d20 636f        trace = co
+0001eab0: 6e73 7472 7563 745f 7472 6163 6528 2928  nstruct_trace()(
+0001eac0: 666c 6174 5f66 756e 632c 202a 666c 6174  flat_func, *flat
+0001ead0: 5f61 7267 7329 0a20 2020 2020 2020 2072  _args).        r
+0001eae0: 6573 756c 742c 2076 6a70 5f72 6573 756c  esult, vjp_resul
+0001eaf0: 7420 3d20 766a 705f 6361 6c6c 2866 6c61  t = vjp_call(fla
+0001eb00: 745f 6172 6773 2c20 636f 7461 6e67 656e  t_args, cotangen
+0001eb10: 7473 2c20 7472 6163 653d 7472 6163 6529  ts, trace=trace)
+0001eb20: 0a20 2020 2020 2020 2067 7072 696d 616c  .        gprimal
+0001eb30: 732c 2067 6b77 6172 6773 203d 2074 7265  s, gkwargs = tre
+0001eb40: 655f 756e 666c 6174 7465 6e28 766a 705f  e_unflatten(vjp_
+0001eb50: 7265 7375 6c74 2c20 7370 6563 290a 2020  result, spec).  
+0001eb60: 2020 2020 2020 6772 6164 7320 3d20 6770        grads = gp
+0001eb70: 7269 6d61 6c73 202b 2028 676b 7761 7267  rimals + (gkwarg
+0001eb80: 732c 2920 6966 206c 656e 2867 6b77 6172  s,) if len(gkwar
+0001eb90: 6773 2920 213d 2030 2065 6c73 6520 6770  gs) != 0 else gp
+0001eba0: 7269 6d61 6c73 0a20 2020 2020 2020 2072  rimals.        r
+0001ebb0: 6574 7572 6e20 7265 7375 6c74 2c20 6772  eturn result, gr
+0001ebc0: 6164 730a 0a20 2020 2072 6574 7572 6e20  ads..    return 
+0001ebd0: 5f76 6a70 0a0a 0a64 6566 2076 616c 7565  _vjp...def value
+0001ebe0: 5f61 6e64 5f67 7261 6428 6675 6e63 293a  _and_grad(func):
+0001ebf0: 0a20 2020 2022 2222 436f 6d70 7574 6573  .    """Computes
+0001ec00: 2074 6865 2076 616c 7565 2061 6e64 2067   the value and g
+0001ec10: 7261 6469 656e 7420 6f66 2061 2066 756e  radient of a fun
+0001ec20: 6374 696f 6e2e 0a0a 2020 2020 5468 6973  ction...    This
+0001ec30: 2069 7320 6120 636f 6e76 656e 6965 6e63   is a convenienc
+0001ec40: 6520 6675 6e63 7469 6f6e 2074 6861 7420  e function that 
+0001ec50: 636f 6d62 696e 6573 2074 6865 2066 756e  combines the fun
+0001ec60: 6374 696f 6e61 6c69 7479 206f 660a 2020  ctionality of.  
+0001ec70: 2020 6076 6a70 5f63 616c 6c60 2077 6974    `vjp_call` wit
+0001ec80: 6820 696d 706c 6963 6974 2069 6e69 7469  h implicit initi
+0001ec90: 616c 697a 6174 696f 6e20 6f66 2074 6865  alization of the
+0001eca0: 2063 6f74 616e 6765 6e74 2074 6f20 312e   cotangent to 1.
+0001ecb0: 0a0a 2020 2020 4172 6773 3a0a 2020 2020  ..    Args:.    
+0001ecc0: 2020 2020 6675 6e63 2028 4361 6c6c 6162      func (Callab
+0001ecd0: 6c65 293a 2046 756e 6374 696f 6e20 746f  le): Function to
+0001ece0: 2062 6520 6469 6666 6572 656e 7469 6174   be differentiat
+0001ecf0: 6564 2e0a 2020 2020 2222 220a 0a20 2020  ed..    """..   
+0001ed00: 2064 6566 206f 6e65 735f 6c69 6b65 2878   def ones_like(x
+0001ed10: 293a 0a20 2020 2020 2020 2069 6620 6973  ):.        if is
+0001ed20: 696e 7374 616e 6365 2878 2c20 5465 6e73  instance(x, Tens
+0001ed30: 6f72 5072 6f78 7929 3a0a 2020 2020 2020  orProxy):.      
+0001ed40: 2020 2020 2020 7265 7475 726e 2066 756c        return ful
+0001ed50: 6c5f 6c69 6b65 2878 2c20 6669 6c6c 5f76  l_like(x, fill_v
+0001ed60: 616c 7565 3d31 290a 2020 2020 2020 2020  alue=1).        
+0001ed70: 656c 6966 2069 7369 6e73 7461 6e63 6528  elif isinstance(
+0001ed80: 782c 204e 756d 6265 7250 726f 7879 293a  x, NumberProxy):
+0001ed90: 0a20 2020 2020 2020 2020 2020 2072 6574  .            ret
+0001eda0: 7572 6e20 7479 7065 2878 2e76 616c 7565  urn type(x.value
+0001edb0: 2928 3129 0a20 2020 2020 2020 2065 6c73  )(1).        els
+0001edc0: 653a 0a20 2020 2020 2020 2020 2020 2072  e:.            r
+0001edd0: 6169 7365 2056 616c 7565 4572 726f 7228  aise ValueError(
+0001ede0: 6622 6f6e 6573 5f6c 696b 6520 696e 7369  f"ones_like insi
+0001edf0: 6465 2076 616c 7565 5f61 6e64 5f67 7261  de value_and_gra
+0001ee00: 6420 676f 7420 616e 2075 6e73 7570 706f  d got an unsuppo
+0001ee10: 7274 6564 2074 7970 6520 7b74 7970 6528  rted type {type(
+0001ee20: 7829 7d22 290a 0a20 2020 2064 6566 205f  x)}")..    def _
+0001ee30: 7661 6c75 655f 616e 645f 6772 6164 282a  value_and_grad(*
+0001ee40: 6172 6773 2c20 2a2a 6b77 6172 6773 293a  args, **kwargs):
+0001ee50: 0a20 2020 2020 2020 2074 7261 6365 203d  .        trace =
+0001ee60: 2063 6f6e 7374 7275 6374 5f74 7261 6365   construct_trace
+0001ee70: 2829 2866 756e 632c 202a 6172 6773 2c20  ()(func, *args, 
+0001ee80: 2a2a 6b77 6172 6773 290a 2020 2020 2020  **kwargs).      
+0001ee90: 2020 636f 7461 6e67 656e 7473 203d 2074    cotangents = t
+0001eea0: 7265 655f 6d61 7028 6c61 6d62 6461 2076  ree_map(lambda v
+0001eeb0: 3a20 6f6e 6573 5f6c 696b 6528 7629 2c20  : ones_like(v), 
+0001eec0: 7472 6163 652e 6f75 7470 7574 290a 2020  trace.output).  
+0001eed0: 2020 2020 2020 7265 7475 726e 2076 6a70        return vjp
+0001eee0: 2866 756e 6329 2861 7267 732c 2063 6f74  (func)(args, cot
+0001eef0: 616e 6765 6e74 732c 202a 2a6b 7761 7267  angents, **kwarg
+0001ef00: 7329 0a0a 2020 2020 7265 7475 726e 205f  s)..    return _
+0001ef10: 7661 6c75 655f 616e 645f 6772 6164 0a0a  value_and_grad..
+0001ef20: 0a46 6f72 7761 7264 4261 636b 7761 7264  .ForwardBackward
+0001ef30: 5472 6163 6573 203d 206e 616d 6564 7475  Traces = namedtu
+0001ef40: 706c 6528 2246 6f72 7761 7264 4261 636b  ple("ForwardBack
+0001ef50: 7761 7264 5472 6163 6573 222c 205b 2266  wardTraces", ["f
+0001ef60: 6f72 7761 7264 5f74 7261 6365 222c 2022  orward_trace", "
+0001ef70: 6261 636b 7761 7264 5f74 7261 6365 225d  backward_trace"]
+0001ef80: 290a 0a0a 6465 6620 5f73 706c 6974 5f73  )...def _split_s
+0001ef90: 6176 6564 5f66 6f72 5f62 6163 6b77 6172  aved_for_backwar
+0001efa0: 645f 696e 746f 5f74 656e 736f 7273 5f61  d_into_tensors_a
+0001efb0: 6e64 5f6f 7468 6572 280a 2020 2020 7361  nd_other(.    sa
+0001efc0: 7665 645f 666f 725f 6261 636b 7761 7264  ved_for_backward
+0001efd0: 3a20 5365 7175 656e 6365 5b56 6172 6961  : Sequence[Varia
+0001efe0: 626c 655d 2c0a 2920 2d3e 2074 7570 6c65  ble],.) -> tuple
+0001eff0: 5b53 6571 7565 6e63 655b 5661 7269 6162  [Sequence[Variab
+0001f000: 6c65 5d2c 2053 6571 7565 6e63 655b 5661  le], Sequence[Va
+0001f010: 7269 6162 6c65 5d5d 3a0a 2020 2020 2222  riable]]:.    ""
+0001f020: 2253 706c 6974 7320 7361 7665 645f 666f  "Splits saved_fo
+0001f030: 725f 6261 636b 7761 7264 2069 6e74 6f20  r_backward into 
+0001f040: 7465 6e73 6f72 7320 616e 6420 6f74 6865  tensors and othe
+0001f050: 722e 0a0a 2020 2020 4172 6773 3a0a 2020  r...    Args:.  
+0001f060: 2020 2020 2020 7361 7665 645f 666f 725f        saved_for_
+0001f070: 6261 636b 7761 7264 2028 5365 7175 656e  backward (Sequen
+0001f080: 6365 5b56 6172 6961 626c 655d 293a 2053  ce[Variable]): S
+0001f090: 6176 6564 5f66 6f72 5f62 6163 6b77 6172  aved_for_backwar
+0001f0a0: 6420 746f 2073 706c 6974 2e0a 0a20 2020  d to split...   
+0001f0b0: 2052 6574 7572 6e73 3a0a 2020 2020 2020   Returns:.      
+0001f0c0: 2020 7475 706c 655b 5365 7175 656e 6365    tuple[Sequence
+0001f0d0: 5b56 6172 6961 626c 655d 2c20 5365 7175  [Variable], Sequ
+0001f0e0: 656e 6365 5b56 6172 6961 626c 655d 5d3a  ence[Variable]]:
+0001f0f0: 2054 7570 6c65 206f 6620 7465 6e73 6f72   Tuple of tensor
+0001f100: 7320 616e 6420 6f74 6865 722e 0a20 2020  s and other..   
+0001f110: 2022 2222 0a20 2020 2069 735f 7465 6e73   """.    is_tens
+0001f120: 6f72 203d 206c 616d 6264 6120 783a 2069  or = lambda x: i
+0001f130: 7369 6e73 7461 6e63 6528 782c 2054 656e  sinstance(x, Ten
+0001f140: 736f 7250 726f 7879 290a 2020 2020 6f74  sorProxy).    ot
+0001f150: 6865 722c 2074 656e 736f 7273 203d 2075  her, tensors = u
+0001f160: 7469 6c73 2e70 6172 7469 7469 6f6e 2869  tils.partition(i
+0001f170: 735f 7465 6e73 6f72 2c20 7361 7665 645f  s_tensor, saved_
+0001f180: 666f 725f 6261 636b 7761 7264 290a 2020  for_backward).  
+0001f190: 2020 7265 7475 726e 2074 7570 6c65 2874    return tuple(t
+0001f1a0: 656e 736f 7273 292c 2074 7570 6c65 286f  ensors), tuple(o
+0001f1b0: 7468 6572 290a 0a0a 6465 6620 5f75 7064  ther)...def _upd
+0001f1c0: 6174 655f 666f 7277 6172 645f 7769 7468  ate_forward_with
+0001f1d0: 5f6e 6577 5f73 6176 6564 5f66 6f72 5f62  _new_saved_for_b
+0001f1e0: 6163 6b77 6172 6428 666f 7277 6172 645f  ackward(forward_
+0001f1f0: 7472 6163 653a 2054 7261 6365 2c20 7361  trace: Trace, sa
+0001f200: 7665 645f 666f 725f 6261 636b 7761 7264  ved_for_backward
+0001f210: 3a20 5365 7175 656e 6365 5b56 6172 6961  : Sequence[Varia
+0001f220: 626c 655d 2920 2d3e 204e 6f6e 653a 0a20  ble]) -> None:. 
+0001f230: 2020 2022 2222 5570 6461 7465 7320 7468     """Updates th
+0001f240: 6520 666f 7277 6172 6420 7472 6163 6520  e forward trace 
+0001f250: 7769 7468 206e 6577 2073 6176 6564 5f66  with new saved_f
+0001f260: 6f72 5f62 6163 6b77 6172 642e 0a0a 2020  or_backward...  
+0001f270: 2020 5468 6973 2069 7320 6e65 6365 7373    This is necess
+0001f280: 6172 7920 6265 6361 7573 6520 7468 6520  ary because the 
+0001f290: 7570 6461 7465 6420 7361 7665 645f 666f  updated saved_fo
+0001f2a0: 725f 6261 636b 7761 7264 2069 7320 6e6f  r_backward is no
+0001f2b0: 7420 6176 6169 6c61 626c 650a 2020 2020  t available.    
+0001f2c0: 7768 656e 2074 6865 2066 6f72 7761 7264  when the forward
+0001f2d0: 2061 6e64 2062 6163 6b77 6172 6420 7472   and backward tr
+0001f2e0: 6163 6573 2061 7265 2063 6f6e 7374 7275  aces are constru
+0001f2f0: 6374 6564 2e0a 0a20 2020 2041 7267 733a  cted...    Args:
+0001f300: 0a20 2020 2020 2020 2066 6f72 7761 7264  .        forward
+0001f310: 5f74 7261 6365 2028 5472 6163 6529 3a20  _trace (Trace): 
+0001f320: 466f 7277 6172 6420 7472 6163 6520 746f  Forward trace to
+0001f330: 2075 7064 6174 652e 0a20 2020 2020 2020   update..       
+0001f340: 2073 6176 6564 5f66 6f72 5f62 6163 6b77   saved_for_backw
+0001f350: 6172 6420 2853 6571 7565 6e63 655b 5661  ard (Sequence[Va
+0001f360: 7269 6162 6c65 5d29 3a20 5361 7665 645f  riable]): Saved_
+0001f370: 666f 725f 6261 636b 7761 7264 2074 6f20  for_backward to 
+0001f380: 7573 6520 746f 0a20 2020 2020 2020 2020  use to.         
+0001f390: 2020 2075 7064 6174 6520 7468 6520 666f     update the fo
+0001f3a0: 7277 6172 6420 7472 6163 652e 0a20 2020  rward trace..   
+0001f3b0: 2022 2222 0a20 2020 2073 6176 6564 5f66   """.    saved_f
+0001f3c0: 6f72 5f62 6163 6b77 6172 6420 3d20 7472  or_backward = tr
+0001f3d0: 6565 5f6d 6170 286c 616d 6264 6120 783a  ee_map(lambda x:
+0001f3e0: 2078 2e76 616c 7565 2069 6620 6973 696e   x.value if isin
+0001f3f0: 7374 616e 6365 2878 2c20 4e75 6d62 6572  stance(x, Number
+0001f400: 5072 6f78 7929 2065 6c73 6520 782c 2073  Proxy) else x, s
+0001f410: 6176 6564 5f66 6f72 5f62 6163 6b77 6172  aved_for_backwar
+0001f420: 6429 0a20 2020 2073 6176 6564 5f74 656e  d).    saved_ten
+0001f430: 736f 7273 2c20 7361 7665 645f 6f74 6865  sors, saved_othe
+0001f440: 7220 3d20 5f73 706c 6974 5f73 6176 6564  r = _split_saved
+0001f450: 5f66 6f72 5f62 6163 6b77 6172 645f 696e  _for_backward_in
+0001f460: 746f 5f74 656e 736f 7273 5f61 6e64 5f6f  to_tensors_and_o
+0001f470: 7468 6572 2873 6176 6564 5f66 6f72 5f62  ther(saved_for_b
+0001f480: 6163 6b77 6172 6429 0a20 2020 2061 7373  ackward).    ass
+0001f490: 6572 7420 666f 7277 6172 645f 7472 6163  ert forward_trac
+0001f4a0: 652e 626f 756e 645f 7379 6d62 6f6c 735b  e.bound_symbols[
+0001f4b0: 2d31 5d2e 7379 6d2e 6964 203d 3d20 7072  -1].sym.id == pr
+0001f4c0: 696d 732e 5072 696d 4944 732e 5245 5455  ims.PrimIDs.RETU
+0001f4d0: 524e 0a20 2020 206e 6577 5f72 6574 7572  RN.    new_retur
+0001f4e0: 6e20 3d20 2866 6f72 7761 7264 5f74 7261  n = (forward_tra
+0001f4f0: 6365 2e6f 7574 7075 745b 305d 2c20 2873  ce.output[0], (s
+0001f500: 6176 6564 5f74 656e 736f 7273 2c20 7361  aved_tensors, sa
+0001f510: 7665 645f 6f74 6865 7229 290a 2020 2020  ved_other)).    
+0001f520: 666f 7277 6172 645f 7472 6163 652e 626f  forward_trace.bo
+0001f530: 756e 645f 7379 6d62 6f6c 735b 2d31 5d20  und_symbols[-1] 
+0001f540: 3d20 7265 706c 6163 6528 666f 7277 6172  = replace(forwar
+0001f550: 645f 7472 6163 652e 626f 756e 645f 7379  d_trace.bound_sy
+0001f560: 6d62 6f6c 735b 2d31 5d2c 2061 7267 733d  mbols[-1], args=
+0001f570: 6e65 775f 7265 7475 726e 290a 0a0a 6465  new_return)...de
+0001f580: 6620 5f75 7064 6174 655f 6261 636b 7761  f _update_backwa
+0001f590: 7264 5f77 6974 685f 6e65 775f 7361 7665  rd_with_new_save
+0001f5a0: 645f 666f 725f 6261 636b 7761 7264 2862  d_for_backward(b
+0001f5b0: 6163 6b77 6172 645f 7472 6163 653a 2054  ackward_trace: T
+0001f5c0: 7261 6365 2c20 7361 7665 645f 666f 725f  race, saved_for_
+0001f5d0: 6261 636b 7761 7264 3a20 5365 7175 656e  backward: Sequen
+0001f5e0: 6365 5b56 6172 6961 626c 655d 2920 2d3e  ce[Variable]) ->
+0001f5f0: 204e 6f6e 653a 0a20 2020 2022 2222 5570   None:.    """Up
+0001f600: 6461 7465 7320 7468 6520 6261 636b 7761  dates the backwa
+0001f610: 7264 2074 7261 6365 2077 6974 6820 6e65  rd trace with ne
+0001f620: 7720 7361 7665 645f 666f 725f 6261 636b  w saved_for_back
+0001f630: 7761 7264 2e0a 0a20 2020 2054 6869 7320  ward...    This 
+0001f640: 6973 206e 6563 6573 7361 7279 2062 6563  is necessary bec
+0001f650: 6175 7365 2074 6865 2075 7064 6174 6564  ause the updated
+0001f660: 2073 6176 6564 5f66 6f72 5f62 6163 6b77   saved_for_backw
+0001f670: 6172 6420 6973 0a20 2020 206e 6f74 2061  ard is.    not a
+0001f680: 7661 696c 6162 6c65 2077 6865 6e20 7468  vailable when th
+0001f690: 6520 6261 636b 7761 7264 2074 7261 6365  e backward trace
+0001f6a0: 2069 7320 636f 6e73 7472 7563 7465 642e   is constructed.
+0001f6b0: 0a0a 2020 2020 4172 6773 3a0a 2020 2020  ..    Args:.    
+0001f6c0: 2020 2020 6261 636b 7761 7264 5f74 7261      backward_tra
+0001f6d0: 6365 2028 5472 6163 6529 3a20 4261 636b  ce (Trace): Back
+0001f6e0: 7761 7264 2074 7261 6365 2074 6f20 7570  ward trace to up
+0001f6f0: 6461 7465 2e0a 2020 2020 2020 2020 7361  date..        sa
+0001f700: 7665 645f 666f 725f 6261 636b 7761 7264  ved_for_backward
+0001f710: 2028 5365 7175 656e 6365 5b56 6172 6961   (Sequence[Varia
+0001f720: 626c 655d 293a 2053 6176 6564 5f66 6f72  ble]): Saved_for
+0001f730: 5f62 6163 6b77 6172 6420 746f 2075 7365  _backward to use
+0001f740: 2074 6f0a 2020 2020 2020 2020 2020 2020   to.            
+0001f750: 7570 6461 7465 2074 6865 2062 6163 6b77  update the backw
+0001f760: 6172 6420 7472 6163 652e 0a20 2020 2022  ard trace..    "
+0001f770: 2222 0a0a 2020 2020 6465 6620 756e 7061  ""..    def unpa
+0001f780: 636b 696e 675f 666e 2873 6176 6564 5f66  cking_fn(saved_f
+0001f790: 6f72 5f62 6163 6b77 6172 642c 2063 6f74  or_backward, cot
+0001f7a0: 616e 6765 6e74 7329 3a0a 2020 2020 2020  angents):.      
+0001f7b0: 2020 7061 7373 0a0a 2020 2020 636f 7461    pass..    cota
+0001f7c0: 6e67 656e 7473 203d 2062 6163 6b77 6172  ngents = backwar
+0001f7d0: 645f 7472 6163 652e 6172 6773 5b31 5d0a  d_trace.args[1].
+0001f7e0: 2020 2020 7361 7665 645f 7465 6e73 6f72      saved_tensor
+0001f7f0: 732c 2073 6176 6564 5f6f 7468 6572 203d  s, saved_other =
+0001f800: 205f 7370 6c69 745f 7361 7665 645f 666f   _split_saved_fo
+0001f810: 725f 6261 636b 7761 7264 5f69 6e74 6f5f  r_backward_into_
+0001f820: 7465 6e73 6f72 735f 616e 645f 6f74 6865  tensors_and_othe
+0001f830: 7228 7361 7665 645f 666f 725f 6261 636b  r(saved_for_back
+0001f840: 7761 7264 290a 2020 2020 756e 7061 636b  ward).    unpack
+0001f850: 696e 675f 7472 6163 6520 3d20 636f 6e73  ing_trace = cons
+0001f860: 7472 7563 745f 7472 6163 6528 7265 6e61  truct_trace(rena
+0001f870: 6d65 5f70 726f 7869 6573 3d46 616c 7365  me_proxies=False
+0001f880: 2c20 7573 655f 6463 653d 4661 6c73 6529  , use_dce=False)
+0001f890: 280a 2020 2020 2020 2020 756e 7061 636b  (.        unpack
+0001f8a0: 696e 675f 666e 2c20 2873 6176 6564 5f74  ing_fn, (saved_t
+0001f8b0: 656e 736f 7273 2c20 7361 7665 645f 6f74  ensors, saved_ot
+0001f8c0: 6865 7229 2c20 636f 7461 6e67 656e 7473  her), cotangents
+0001f8d0: 0a20 2020 2029 0a20 2020 2061 7373 6572  .    ).    asser
+0001f8e0: 7420 756e 7061 636b 696e 675f 7472 6163  t unpacking_trac
+0001f8f0: 652e 626f 756e 645f 7379 6d62 6f6c 735b  e.bound_symbols[
+0001f900: 2d31 5d2e 7379 6d2e 6964 203d 3d20 7072  -1].sym.id == pr
+0001f910: 696d 732e 5072 696d 4944 732e 5245 5455  ims.PrimIDs.RETU
+0001f920: 524e 0a0a 2020 2020 6261 636b 7761 7264  RN..    backward
+0001f930: 5f74 7261 6365 2e61 7267 7320 3d20 756e  _trace.args = un
+0001f940: 7061 636b 696e 675f 7472 6163 652e 6172  packing_trace.ar
+0001f950: 6773 0a20 2020 2062 6163 6b77 6172 645f  gs.    backward_
+0001f960: 7472 6163 655f 6273 796d 735f 7769 7468  trace_bsyms_with
+0001f970: 6f75 745f 756e 7061 636b 696e 6720 3d20  out_unpacking = 
+0001f980: 280a 2020 2020 2020 2020 6273 796d 0a20  (.        bsym. 
+0001f990: 2020 2020 2020 2066 6f72 2062 7379 6d20         for bsym 
+0001f9a0: 696e 2062 6163 6b77 6172 645f 7472 6163  in backward_trac
+0001f9b0: 652e 626f 756e 645f 7379 6d62 6f6c 730a  e.bound_symbols.
+0001f9c0: 2020 2020 2020 2020 6966 2062 7379 6d2e          if bsym.
+0001f9d0: 7379 6d2e 6964 0a20 2020 2020 2020 206e  sym.id.        n
+0001f9e0: 6f74 2069 6e20 280a 2020 2020 2020 2020  ot in (.        
+0001f9f0: 2020 2020 7072 696d 732e 5072 696d 4944      prims.PrimID
+0001fa00: 732e 554e 5041 434b 5f45 4d50 5459 5f44  s.UNPACK_EMPTY_D
+0001fa10: 4943 542c 0a20 2020 2020 2020 2020 2020  ICT,.           
+0001fa20: 2070 7269 6d73 2e50 7269 6d49 4473 2e55   prims.PrimIDs.U
+0001fa30: 4e50 4143 4b5f 4b45 592c 0a20 2020 2020  NPACK_KEY,.     
+0001fa40: 2020 2020 2020 2070 7269 6d73 2e50 7269         prims.Pri
+0001fa50: 6d49 4473 2e55 4e50 4143 4b5f 5345 5155  mIDs.UNPACK_SEQU
+0001fa60: 454e 4345 2c0a 2020 2020 2020 2020 2020  ENCE,.          
+0001fa70: 2020 7072 696d 732e 5072 696d 4944 732e    prims.PrimIDs.
+0001fa80: 554e 5041 434b 5f54 5249 5649 414c 2c0a  UNPACK_TRIVIAL,.
+0001fa90: 2020 2020 2020 2020 290a 2020 2020 290a          ).    ).
+0001faa0: 2020 2020 6261 636b 7761 7264 5f74 7261      backward_tra
+0001fab0: 6365 2e62 6f75 6e64 5f73 796d 626f 6c73  ce.bound_symbols
+0001fac0: 203d 206c 6973 7428 282a 756e 7061 636b   = list((*unpack
+0001fad0: 696e 675f 7472 6163 652e 626f 756e 645f  ing_trace.bound_
+0001fae0: 7379 6d62 6f6c 735b 3a2d 315d 2c20 2a62  symbols[:-1], *b
+0001faf0: 6163 6b77 6172 645f 7472 6163 655f 6273  ackward_trace_bs
+0001fb00: 796d 735f 7769 7468 6f75 745f 756e 7061  yms_without_unpa
+0001fb10: 636b 696e 6729 290a 0a0a 2320 4e4f 5445  cking))...# NOTE
+0001fb20: 3a20 5265 7475 726e 696e 6720 6e61 6d65  : Returning name
+0001fb30: 6474 7570 6c65 7320 6672 6f6d 2063 6f6d  dtuples from com
+0001fb40: 7069 6c65 6420 6675 6e63 7469 6f6e 7320  piled functions 
+0001fb50: 646f 6573 6e27 7420 776f 726b 2e20 5365  doesn't work. Se
+0001fb60: 653a 0a23 2022 416c 6c6f 7720 7265 7475  e:.# "Allow retu
+0001fb70: 726e 696e 6720 6e61 6d65 6474 7570 6c65  rning namedtuple
+0001fb80: 7320 6672 6f6d 2063 6f6d 7069 6c65 6420  s from compiled 
+0001fb90: 6675 6e63 7469 6f6e 7322 0a23 204e 6f74  functions".# Not
+0001fba0: 6520 5b47 7261 6420 666f 7277 6172 6420  e [Grad forward 
+0001fbb0: 6f75 7470 7574 2073 7065 635d 0a23 2049  output spec].# I
+0001fbc0: 6620 6974 2064 6964 2077 6f72 6b20 6974  f it did work it
+0001fbd0: 2077 6f75 6c64 2062 6520 6e69 6365 2074   would be nice t
+0001fbe0: 6f20 7573 6520 7468 6973 206e 616d 6564  o use this named
+0001fbf0: 7475 706c 650a 2320 696e 7374 6561 6420  tuple.# instead 
+0001fc00: 6f66 2074 6865 2070 6c61 696e 2074 7570  of the plain tup
+0001fc10: 6c65 206f 7220 6469 6374 2074 6861 7420  le or dict that 
+0001fc20: 7765 2772 6520 7573 696e 6720 6e6f 772e  we're using now.
+0001fc30: 0a54 6f72 6368 4175 746f 6772 6164 466f  .TorchAutogradFo
+0001fc40: 7277 6172 6444 6174 6120 3d20 6e61 6d65  rwardData = name
+0001fc50: 6474 7570 6c65 280a 2020 2020 2254 6f72  dtuple(.    "Tor
+0001fc60: 6368 4175 746f 6772 6164 466f 7277 6172  chAutogradForwar
+0001fc70: 6444 6174 6122 2c0a 2020 2020 5b22 6f75  dData",.    ["ou
+0001fc80: 7470 7574 222c 2022 666c 6174 5f61 7267  tput", "flat_arg
+0001fc90: 7322 2c20 2266 6c61 745f 6f75 7470 7574  s", "flat_output
+0001fca0: 225d 2c0a 290a 0a0a 6465 6620 666f 7277  "],.)...def forw
+0001fcb0: 6172 645f 616e 645f 6261 636b 7761 7264  ard_and_backward
+0001fcc0: 5f66 726f 6d5f 7472 6163 6528 7472 6163  _from_trace(trac
+0001fcd0: 653a 2054 7261 6365 2c20 746f 7263 685f  e: Trace, torch_
+0001fce0: 6175 746f 6772 6164 3d46 616c 7365 2920  autograd=False) 
+0001fcf0: 2d3e 2046 6f72 7761 7264 4261 636b 7761  -> ForwardBackwa
+0001fd00: 7264 5472 6163 6573 3a0a 2020 2020 2222  rdTraces:.    ""
+0001fd10: 2247 656e 6572 6174 6573 2074 6865 2066  "Generates the f
+0001fd20: 6f72 7761 7264 2061 6e64 2062 6163 6b77  orward and backw
+0001fd30: 6172 6420 7061 7373 6573 2066 726f 6d20  ard passes from 
+0001fd40: 6120 7472 6163 652e 0a0a 2020 2020 5468  a trace...    Th
+0001fd50: 6973 2069 7320 6120 636f 6e76 656e 6965  is is a convenie
+0001fd60: 6e63 6520 6675 6e63 7469 6f6e 2074 6861  nce function tha
+0001fd70: 7420 636f 6d62 696e 6573 2074 6865 2066  t combines the f
+0001fd80: 756e 6374 696f 6e61 6c69 7479 206f 660a  unctionality of.
+0001fd90: 2020 2020 6061 7567 6d65 6e74 6564 5f66      `augmented_f
+0001fda0: 6f72 7761 7264 5f70 6173 7360 2061 6e64  orward_pass` and
+0001fdb0: 2060 6261 636b 7761 7264 5f70 6173 7360   `backward_pass`
+0001fdc0: 2e20 5468 6520 6d61 696e 2064 6966 6665  . The main diffe
+0001fdd0: 7265 6e63 6520 6973 2074 6861 740a 2020  rence is that.  
+0001fde0: 2020 7468 6973 2066 756e 6374 696f 6e20    this function 
+0001fdf0: 646f 6573 206e 6f74 2072 6571 7569 7265  does not require
+0001fe00: 2074 6865 2075 7365 7220 746f 2070 726f   the user to pro
+0001fe10: 7669 6465 206e 6577 2069 6e70 7574 7320  vide new inputs 
+0001fe20: 666f 7220 7468 650a 2020 2020 7472 6163  for the.    trac
+0001fe30: 6520 6576 616c 7561 7469 6f6e 2e20 496e  e evaluation. In
+0001fe40: 7374 6561 6420 6974 2075 7365 7320 7468  stead it uses th
+0001fe50: 6520 696e 7075 7473 2074 6861 7420 7765  e inputs that we
+0001fe60: 7265 2075 7365 6420 746f 2063 6f6e 7374  re used to const
+0001fe70: 7275 6374 0a20 2020 2074 6865 2074 7261  ruct.    the tra
+0001fe80: 6365 2e0a 0a20 2020 2041 7267 733a 0a20  ce...    Args:. 
+0001fe90: 2020 2020 2020 2074 7261 6365 2028 5472         trace (Tr
+0001fea0: 6163 6529 3a20 5472 6163 6520 746f 2067  ace): Trace to g
+0001feb0: 656e 6572 6174 6520 7468 6520 666f 7277  enerate the forw
+0001fec0: 6172 6420 616e 6420 6261 636b 7761 7264  ard and backward
+0001fed0: 2070 6173 7365 7320 6672 6f6d 2e0a 0a20   passes from... 
+0001fee0: 2020 2052 6574 7572 6e73 3a0a 2020 2020     Returns:.    
+0001fef0: 2020 2020 466f 7277 6172 6442 6163 6b77      ForwardBackw
+0001ff00: 6172 6454 7261 6365 733a 2041 206e 616d  ardTraces: A nam
+0001ff10: 6564 2074 7570 6c65 2063 6f6e 7461 696e  ed tuple contain
+0001ff20: 696e 6720 7468 6520 666f 7277 6172 6420  ing the forward 
+0001ff30: 616e 6420 6261 636b 7761 7264 0a20 2020  and backward.   
+0001ff40: 2020 2020 2020 2020 2074 7261 6365 732e           traces.
+0001ff50: 0a0a 2020 2020 4578 616d 706c 653a 0a20  ..    Example:. 
+0001ff60: 2020 2020 2020 203e 3e3e 2069 6d70 6f72         >>> impor
+0001ff70: 7420 746f 7263 680a 2020 2020 2020 2020  t torch.        
+0001ff80: 3e3e 3e20 6672 6f6d 2074 6875 6e64 6572  >>> from thunder
+0001ff90: 2069 6d70 6f72 7420 636f 6d70 696c 652c   import compile,
+0001ffa0: 206c 6173 745f 7472 6163 6573 0a20 2020   last_traces.   
+0001ffb0: 2020 2020 203e 3e3e 2066 726f 6d20 7468       >>> from th
+0001ffc0: 756e 6465 722e 636f 7265 2e74 7261 6e73  under.core.trans
+0001ffd0: 666f 726d 7320 696d 706f 7274 2066 6f72  forms import for
+0001ffe0: 7761 7264 5f61 6e64 5f62 6163 6b77 6172  ward_and_backwar
+0001fff0: 645f 6672 6f6d 5f74 7261 6365 0a20 2020  d_from_trace.   
+00020000: 2020 2020 203e 3e3e 2064 6566 2066 2878       >>> def f(x
+00020010: 293a 0a20 2020 2020 2020 202e 2e2e 2020  ):.        ...  
+00020020: 2020 2072 6574 7572 6e20 746f 7263 682e     return torch.
+00020030: 7369 6e28 7829 0a20 2020 2020 2020 203e  sin(x).        >
+00020040: 3e3e 2078 203d 2074 6f72 6368 2e74 656e  >> x = torch.ten
+00020050: 736f 7228 332e 3029 0a20 2020 2020 2020  sor(3.0).       
+00020060: 203e 3e3e 2063 6620 3d20 636f 6d70 696c   >>> cf = compil
+00020070: 6528 6629 0a20 2020 2020 2020 203e 3e3e  e(f).        >>>
+00020080: 206f 7574 203d 2063 6628 7829 0a20 2020   out = cf(x).   
+00020090: 2020 2020 203e 3e3e 2074 7261 6365 203d       >>> trace =
+000200a0: 206c 6173 745f 7472 6163 6573 2863 6629   last_traces(cf)
+000200b0: 5b30 5d0a 2020 2020 2020 2020 3e3e 3e20  [0].        >>> 
+000200c0: 666f 7277 6172 645f 616e 645f 6261 636b  forward_and_back
+000200d0: 7761 7264 5f66 726f 6d5f 7472 6163 6528  ward_from_trace(
+000200e0: 7472 6163 6529 0a20 2020 2020 2020 202e  trace).        .
+000200f0: 2e2e 2046 6f72 7761 7264 4261 636b 7761  .. ForwardBackwa
+00020100: 7264 5472 6163 6573 280a 2020 2020 2020  rdTraces(.      
+00020110: 2020 2e2e 2e20 666f 7277 6172 645f 7472    ... forward_tr
+00020120: 6163 653d 2320 696d 706f 7274 2074 6875  ace=# import thu
+00020130: 6e64 6572 2061 7320 7468 756e 6465 720a  nder as thunder.
+00020140: 2020 2020 2020 2020 2e2e 2e20 2320 696d          ... # im
+00020150: 706f 7274 2074 6875 6e64 6572 2e63 6f72  port thunder.cor
+00020160: 652e 7072 696d 7320 6173 2070 7269 6d73  e.prims as prims
+00020170: 0a20 2020 2020 2020 202e 2e2e 2069 6d70  .        ... imp
+00020180: 6f72 7420 746f 7263 680a 2020 2020 2020  ort torch.      
+00020190: 2020 2e2e 2e0a 2020 2020 2020 2020 2e2e    ....        ..
+000201a0: 2e20 4074 6f72 6368 2e6e 6f5f 6772 6164  . @torch.no_grad
+000201b0: 2829 0a20 2020 2020 2020 202e 2e2e 2064  ().        ... d
+000201c0: 6566 2061 7567 6d65 6e74 6564 5f66 6f72  ef augmented_for
+000201d0: 7761 7264 5f66 6e28 2a61 7267 7329 3a0a  ward_fn(*args):.
+000201e0: 2020 2020 2020 2020 2e2e 2e20 2020 2320          ...   # 
+000201f0: 6172 6773 3a20 2243 6f6c 6c65 6374 696f  args: "Collectio
+00020200: 6e22 203d 2020 2874 302c 2920 2028 7472  n" =  (t0,)  (tr
+00020210: 6976 6961 6c20 756e 7061 636b 290a 2020  ivial unpack).  
+00020220: 2020 2020 2020 2e2e 2e20 2020 7430 2c20        ...   t0, 
+00020230: 5c0a 2020 2020 2020 2020 2e2e 2e20 2020  \.        ...   
+00020240: 3d20 6172 6773 0a20 2020 2020 2020 202e  = args.        .
+00020250: 2e2e 2020 2074 3120 3d20 7072 696d 732e  ..   t1 = prims.
+00020260: 7369 6e28 7430 2920 2023 2074 313a 2022  sin(t0)  # t1: "
+00020270: 6370 7520 6633 325b 5d22 0a20 2020 2020  cpu f32[]".     
+00020280: 2020 202e 2e2e 2020 2072 6574 7572 6e20     ...   return 
+00020290: 7431 2c20 2874 302c 292c 0a20 2020 2020  t1, (t0,),.     
+000202a0: 2020 202e 2e2e 2062 6163 6b77 6172 645f     ... backward_
+000202b0: 7472 6163 653d 2320 696d 706f 7274 2074  trace=# import t
+000202c0: 6875 6e64 6572 2061 7320 7468 756e 6465  hunder as thunde
+000202d0: 720a 2020 2020 2020 2020 2e2e 2e20 2320  r.        ... # 
+000202e0: 696d 706f 7274 2074 6875 6e64 6572 2e63  import thunder.c
+000202f0: 6f72 652e 7072 696d 7320 6173 2070 7269  ore.prims as pri
+00020300: 6d73 0a20 2020 2020 2020 202e 2e2e 2069  ms.        ... i
+00020310: 6d70 6f72 7420 746f 7263 680a 2020 2020  mport torch.    
+00020320: 2020 2020 2e2e 2e0a 2020 2020 2020 2020      ....        
+00020330: 2e2e 2e20 4074 6f72 6368 2e6e 6f5f 6772  ... @torch.no_gr
+00020340: 6164 2829 0a20 2020 2020 2020 202e 2e2e  ad().        ...
+00020350: 2064 6566 2062 6163 6b77 6172 645f 666e   def backward_fn
+00020360: 2873 6176 6564 5f66 6f72 5f62 6163 6b77  (saved_for_backw
+00020370: 6172 642c 2063 6f74 616e 6765 6e74 7329  ard, cotangents)
+00020380: 3a0a 2020 2020 2020 2020 2e2e 2e20 2020  :.        ...   
+00020390: 2320 7361 7665 645f 666f 725f 6261 636b  # saved_for_back
+000203a0: 7761 7264 3a20 2243 6f6c 6c65 6374 696f  ward: "Collectio
+000203b0: 6e22 203d 2020 2874 302c 2920 2028 7472  n" =  (t0,)  (tr
+000203c0: 6976 6961 6c20 756e 7061 636b 290a 2020  ivial unpack).  
+000203d0: 2020 2020 2020 2e2e 2e20 2020 2320 636f        ...   # co
+000203e0: 7461 6e67 656e 7473 3a20 2263 7075 2066  tangents: "cpu f
+000203f0: 3332 5b5d 2220 3d20 2063 6f74 616e 6765  32[]" =  cotange
+00020400: 6e74 7320 2028 7472 6976 6961 6c20 756e  nts  (trivial un
+00020410: 7061 636b 290a 2020 2020 2020 2020 2e2e  pack).        ..
+00020420: 2e20 2020 7430 2c20 5c0a 2020 2020 2020  .   t0, \.      
+00020430: 2020 2e2e 2e20 2020 3d20 7361 7665 645f    ...   = saved_
+00020440: 666f 725f 6261 636b 7761 7264 0a20 2020  for_backward.   
+00020450: 2020 2020 202e 2e2e 2020 2074 3120 3d20       ...   t1 = 
+00020460: 7072 696d 732e 636f 7328 7430 2920 2023  prims.cos(t0)  #
+00020470: 2074 313a 2022 6370 7520 6633 325b 5d22   t1: "cpu f32[]"
+00020480: 0a20 2020 2020 2020 202e 2e2e 2020 2074  .        ...   t
+00020490: 3220 3d20 7072 696d 732e 6d75 6c28 636f  2 = prims.mul(co
+000204a0: 7461 6e67 656e 7473 2c20 7431 2920 2023  tangents, t1)  #
+000204b0: 2074 323a 2022 6370 7520 6633 325b 5d22   t2: "cpu f32[]"
+000204c0: 0a20 2020 2020 2020 202e 2e2e 2020 2072  .        ...   r
+000204d0: 6574 7572 6e20 2874 322c 2929 0a20 2020  eturn (t2,)).   
+000204e0: 2022 2222 0a0a 2020 2020 6f75 7470 7574   """..    output
+000204f0: 5f73 7065 6320 3d20 4e6f 6e65 0a0a 2020  _spec = None..  
+00020500: 2020 6465 6620 6175 676d 656e 7465 645f    def augmented_
+00020510: 666f 7277 6172 645f 666e 282a 6172 6773  forward_fn(*args
+00020520: 2c20 2a2a 6b77 6172 6773 293a 0a20 2020  , **kwargs):.   
+00020530: 2020 2020 2072 6573 756c 742c 2065 6e76       result, env
+00020540: 203d 2061 7567 6d65 6e74 6564 5f66 6f72   = augmented_for
+00020550: 7761 7264 5f70 6173 7328 2a61 7267 732c  ward_pass(*args,
+00020560: 2074 7261 6365 3d74 7261 6365 2c20 2a2a   trace=trace, **
+00020570: 6b77 6172 6773 290a 2020 2020 2020 2020  kwargs).        
+00020580: 7361 7665 645f 666f 725f 6261 636b 7761  saved_for_backwa
+00020590: 7264 203d 2064 6563 6f6e 7374 7275 6374  rd = deconstruct
+000205a0: 5f66 6f72 7761 7264 5f65 6e76 5f66 6f72  _forward_env_for
+000205b0: 5f62 6163 6b77 6172 6428 7472 6163 652c  _backward(trace,
+000205c0: 2065 6e76 290a 2020 2020 2020 2020 6966   env).        if
+000205d0: 2074 6f72 6368 5f61 7574 6f67 7261 643a   torch_autograd:
+000205e0: 0a20 2020 2020 2020 2020 2020 206e 6f6e  .            non
+000205f0: 6c6f 6361 6c20 6f75 7470 7574 5f73 7065  local output_spe
+00020600: 630a 2020 2020 2020 2020 2020 2020 666c  c.            fl
+00020610: 6174 5f61 7267 732c 205f 203d 2074 7265  at_args, _ = tre
+00020620: 655f 666c 6174 7465 6e28 2861 7267 732c  e_flatten((args,
+00020630: 206b 7761 7267 7329 290a 2020 2020 2020   kwargs)).      
+00020640: 2020 2020 2020 666c 6174 5f6f 7574 7075        flat_outpu
+00020650: 742c 206f 7574 7075 745f 7370 6563 203d  t, output_spec =
+00020660: 2074 7265 655f 666c 6174 7465 6e28 7265   tree_flatten(re
+00020670: 7375 6c74 290a 2020 2020 2020 2020 2020  sult).          
+00020680: 2020 666c 6174 5f6f 7574 7075 7420 3d20    flat_output = 
+00020690: 7475 706c 6528 666c 6174 5f6f 7574 7075  tuple(flat_outpu
+000206a0: 7429 0a20 2020 2020 2020 2020 2020 2023  t).            #
+000206b0: 2053 6565 204e 6f74 6520 5b47 7261 6420   See Note [Grad 
+000206c0: 666f 7277 6172 6420 6f75 7470 7574 2073  forward output s
+000206d0: 7065 635d 0a20 2020 2020 2020 2020 2020  pec].           
+000206e0: 2066 6f72 5f61 7574 6f67 7261 6420 3d20   for_autograd = 
+000206f0: 546f 7263 6841 7574 6f67 7261 6446 6f72  TorchAutogradFor
+00020700: 7761 7264 4461 7461 280a 2020 2020 2020  wardData(.      
+00020710: 2020 2020 2020 2020 2020 7265 7375 6c74            result
+00020720: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+00020730: 2020 666c 6174 5f61 7267 732c 0a20 2020    flat_args,.   
+00020740: 2020 2020 2020 2020 2020 2020 2066 6c61               fla
+00020750: 745f 6f75 7470 7574 2c0a 2020 2020 2020  t_output,.      
+00020760: 2020 2020 2020 292e 5f61 7364 6963 7428        )._asdict(
+00020770: 290a 2020 2020 2020 2020 2020 2020 7265  ).            re
+00020780: 7475 726e 2028 666f 725f 6175 746f 6772  turn (for_autogr
+00020790: 6164 2c20 7361 7665 645f 666f 725f 6261  ad, saved_for_ba
+000207a0: 636b 7761 7264 290a 2020 2020 2020 2020  ckward).        
+000207b0: 7265 7475 726e 2072 6573 756c 742c 2073  return result, s
+000207c0: 6176 6564 5f66 6f72 5f62 6163 6b77 6172  aved_for_backwar
+000207d0: 640a 0a20 2020 2023 2043 6f70 7920 7468  d..    # Copy th
+000207e0: 6520 7369 676e 6174 7572 6520 6f66 2074  e signature of t
+000207f0: 6865 206f 7269 6769 6e61 6c20 6675 6e63  he original func
+00020800: 7469 6f6e 2073 6f20 7468 6174 2074 6865  tion so that the
+00020810: 2061 7267 756d 656e 7473 2061 7265 0a20   arguments are. 
+00020820: 2020 2023 206e 616d 6564 2063 6f72 7265     # named corre
+00020830: 6374 6c79 2069 6e20 7468 6520 6175 676d  ctly in the augm
+00020840: 656e 7465 6420 666f 7277 6172 6420 7061  ented forward pa
+00020850: 7373 2069 6e73 7465 6164 206f 6620 6265  ss instead of be
+00020860: 696e 6720 6e61 6d65 640a 2020 2020 2320  ing named.    # 
+00020870: 2261 7267 7322 2061 6e64 2022 6b77 6172  "args" and "kwar
+00020880: 6773 222e 0a20 2020 2061 7567 6d65 6e74  gs"..    augment
+00020890: 6564 5f66 6f72 7761 7264 5f66 6e2e 5f5f  ed_forward_fn.__
+000208a0: 7369 676e 6174 7572 655f 5f20 3d20 696e  signature__ = in
+000208b0: 7370 6563 742e 7369 676e 6174 7572 6528  spect.signature(
+000208c0: 7472 6163 652e 666e 206f 7220 7472 6163  trace.fn or trac
+000208d0: 652e 7079 7468 6f6e 5f63 616c 6c61 626c  e.python_callabl
+000208e0: 6528 2929 0a0a 2020 2020 6465 6620 6f6e  e())..    def on
+000208f0: 6573 5f6c 696b 6528 7829 3a0a 2020 2020  es_like(x):.    
+00020900: 2020 2020 6966 2069 7369 6e73 7461 6e63      if isinstanc
+00020910: 6528 782c 2054 656e 736f 7250 726f 7879  e(x, TensorProxy
+00020920: 293a 0a20 2020 2020 2020 2020 2020 2072  ):.            r
+00020930: 6574 7572 6e20 6675 6c6c 5f6c 696b 6528  eturn full_like(
+00020940: 782c 2066 696c 6c5f 7661 6c75 653d 3129  x, fill_value=1)
+00020950: 0a20 2020 2020 2020 2065 6c69 6620 6973  .        elif is
+00020960: 696e 7374 616e 6365 2878 2c20 4e75 6d62  instance(x, Numb
+00020970: 6572 5072 6f78 7929 3a0a 2020 2020 2020  erProxy):.      
+00020980: 2020 2020 2020 7265 7475 726e 2074 7970        return typ
+00020990: 6528 782e 7661 6c75 6529 2831 290a 2020  e(x.value)(1).  
+000209a0: 2020 2020 2020 656c 7365 3a0a 2020 2020        else:.    
+000209b0: 2020 2020 2020 2020 7265 7475 726e 204e          return N
+000209c0: 6f6e 650a 0a20 2020 2066 6f72 7761 7264  one..    forward
+000209d0: 5f74 7261 6365 203d 2063 6f6e 7374 7275  _trace = constru
+000209e0: 6374 5f74 7261 6365 2829 2861 7567 6d65  ct_trace()(augme
+000209f0: 6e74 6564 5f66 6f72 7761 7264 5f66 6e2c  nted_forward_fn,
+00020a00: 202a 7472 6163 652e 6172 6773 2c20 2a2a   *trace.args, **
+00020a10: 7472 6163 652e 6b77 6172 6773 290a 2020  trace.kwargs).  
+00020a20: 2020 2320 5765 2073 6574 2066 6f72 7761    # We set forwa
+00020a30: 7264 2074 7261 6365 2074 6f20 636f 6e73  rd trace to cons
+00020a40: 7472 7563 7420 7072 6f78 6965 7320 6265  truct proxies be
+00020a50: 6361 7573 6520 7765 206e 6565 6420 7468  cause we need th
+00020a60: 6573 6520 7072 6f78 6965 7320 746f 0a20  ese proxies to. 
+00020a70: 2020 2023 2068 6176 6520 6469 6666 6572     # have differ
+00020a80: 656e 7420 6e61 6d65 7320 7468 616e 2074  ent names than t
+00020a90: 6865 206f 6e65 7320 696e 2074 6865 2066  he ones in the f
+00020aa0: 6f72 7761 7264 2074 7261 6365 2e0a 2020  orward trace..  
+00020ab0: 2020 7472 793a 0a20 2020 2020 2020 2074    try:.        t
+00020ac0: 7261 6365 6374 785f 746f 6b65 6e20 3d20  racectx_token = 
+00020ad0: 7365 745f 7472 6163 6563 7478 2866 6f72  set_tracectx(for
+00020ae0: 7761 7264 5f74 7261 6365 290a 2020 2020  ward_trace).    
+00020af0: 2020 2020 2320 5765 2064 6f6e 2774 2077      # We don't w
+00020b00: 616e 7420 746f 2072 6563 6f72 6420 7468  ant to record th
+00020b10: 6f73 6520 6f6e 6573 5f6c 696b 6520 6361  ose ones_like ca
+00020b20: 6c6c 7320 696e 2074 6865 2066 6f72 7761  lls in the forwa
+00020b30: 7264 2074 7261 6365 2e0a 2020 2020 2020  rd trace..      
+00020b40: 2020 7769 7468 2064 6574 6163 6865 645f    with detached_
+00020b50: 7472 6163 6528 293a 0a20 2020 2020 2020  trace():.       
+00020b60: 2020 2020 2069 6620 746f 7263 685f 6175       if torch_au
+00020b70: 746f 6772 6164 3a0a 2020 2020 2020 2020  tograd:.        
+00020b80: 2020 2020 2020 2020 2320 4974 2773 2061          # It's a
+00020b90: 7373 756d 6564 2074 6861 7420 666f 7277  ssumed that forw
+00020ba0: 6172 645f 7472 6163 652e 6f75 7470 7574  ard_trace.output
+00020bb0: 5b30 5d20 6973 2061 2064 6963 7420 6672  [0] is a dict fr
+00020bc0: 6f6d 2054 6f72 6368 4175 746f 6772 6164  om TorchAutograd
+00020bd0: 466f 7277 6172 6444 6174 610a 2020 2020  ForwardData.    
+00020be0: 2020 2020 2020 2020 2020 2020 666c 6174              flat
+00020bf0: 5f6f 7574 7075 7420 3d20 666f 7277 6172  _output = forwar
+00020c00: 645f 7472 6163 652e 6f75 7470 7574 5b30  d_trace.output[0
+00020c10: 5d5b 2266 6c61 745f 6f75 7470 7574 225d  ]["flat_output"]
+00020c20: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00020c30: 2063 6f74 616e 6765 6e74 7320 3d20 7574   cotangents = ut
+00020c40: 696c 732e 7365 7175 656e 6369 6679 2874  ils.sequencify(t
+00020c50: 7265 655f 6d61 7028 6c61 6d62 6461 2076  ree_map(lambda v
+00020c60: 3a20 6f6e 6573 5f6c 696b 6528 7629 2c20  : ones_like(v), 
+00020c70: 666c 6174 5f6f 7574 7075 7429 290a 2020  flat_output)).  
+00020c80: 2020 2020 2020 2020 2020 656c 7365 3a0a            else:.
+00020c90: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00020ca0: 636f 7461 6e67 656e 7473 203d 2075 7469  cotangents = uti
+00020cb0: 6c73 2e73 6571 7565 6e63 6966 7928 7472  ls.sequencify(tr
+00020cc0: 6565 5f6d 6170 286c 616d 6264 6120 763a  ee_map(lambda v:
+00020cd0: 206f 6e65 735f 6c69 6b65 2876 292c 2074   ones_like(v), t
+00020ce0: 7261 6365 2e6f 7574 7075 7429 290a 2020  race.output)).  
+00020cf0: 2020 6669 6e61 6c6c 793a 0a20 2020 2020    finally:.     
+00020d00: 2020 2072 6573 6574 5f74 7261 6365 6374     reset_tracect
+00020d10: 7828 7472 6163 6563 7478 5f74 6f6b 656e  x(tracectx_token
+00020d20: 290a 0a20 2020 2064 6566 2062 6163 6b77  )..    def backw
+00020d30: 6172 645f 666e 2873 6176 6564 5f66 6f72  ard_fn(saved_for
+00020d40: 5f62 6163 6b77 6172 642c 2063 6f74 616e  _backward, cotan
+00020d50: 6765 6e74 7329 3a0a 2020 2020 2020 2020  gents):.        
+00020d60: 656e 7620 3d20 7265 636f 6e73 7472 7563  env = reconstruc
+00020d70: 745f 666f 7277 6172 645f 656e 765f 666f  t_forward_env_fo
+00020d80: 725f 6261 636b 7761 7264 2874 7261 6365  r_backward(trace
+00020d90: 2c20 7361 7665 645f 666f 725f 6261 636b  , saved_for_back
+00020da0: 7761 7264 290a 2020 2020 2020 2020 6966  ward).        if
+00020db0: 2074 6f72 6368 5f61 7574 6f67 7261 643a   torch_autograd:
+00020dc0: 0a20 2020 2020 2020 2020 2020 2063 6f74  .            cot
+00020dd0: 616e 6765 6e74 7320 3d20 7472 6565 5f75  angents = tree_u
+00020de0: 6e66 6c61 7474 656e 2863 6f74 616e 6765  nflatten(cotange
+00020df0: 6e74 732c 206f 7574 7075 745f 7370 6563  nts, output_spec
+00020e00: 290a 2020 2020 2020 2020 6f75 7420 3d20  ).        out = 
+00020e10: 6261 636b 7761 7264 5f70 6173 7328 656e  backward_pass(en
+00020e20: 762c 2074 7261 6365 2c20 636f 7461 6e67  v, trace, cotang
+00020e30: 656e 7473 290a 2020 2020 2020 2020 6966  ents).        if
+00020e40: 2074 6f72 6368 5f61 7574 6f67 7261 643a   torch_autograd:
+00020e50: 0a20 2020 2020 2020 2020 2020 2067 6b77  .            gkw
+00020e60: 6172 6773 203d 206f 7574 5b2d 315d 2069  args = out[-1] i
+00020e70: 6620 6973 696e 7374 616e 6365 286f 7574  f isinstance(out
+00020e80: 5b2d 315d 2c20 6469 6374 2920 656c 7365  [-1], dict) else
+00020e90: 207b 7d0a 2020 2020 2020 2020 2020 2020   {}.            
+00020ea0: 6761 7267 7320 3d20 6f75 745b 3a2d 315d  gargs = out[:-1]
+00020eb0: 2069 6620 6973 696e 7374 616e 6365 286f   if isinstance(o
+00020ec0: 7574 5b2d 315d 2c20 6469 6374 2920 656c  ut[-1], dict) el
+00020ed0: 7365 206f 7574 0a20 2020 2020 2020 2020  se out.         
+00020ee0: 2020 2067 6b77 6172 6773 203d 207b 6b3a     gkwargs = {k:
+00020ef0: 2067 6b77 6172 6773 2e67 6574 286b 2c20   gkwargs.get(k, 
+00020f00: 4e6f 6e65 2920 666f 7220 6b20 696e 2074  None) for k in t
+00020f10: 7261 6365 2e6b 7761 7267 737d 0a20 2020  race.kwargs}.   
+00020f20: 2020 2020 2020 2020 206f 7574 203d 2028           out = (
+00020f30: 2a67 6172 6773 2c20 676b 7761 7267 7329  *gargs, gkwargs)
+00020f40: 0a20 2020 2020 2020 2020 2020 206f 7574  .            out
+00020f50: 203d 2074 7265 655f 666c 6174 7465 6e28   = tree_flatten(
+00020f60: 6f75 7429 5b30 5d0a 2020 2020 2020 2020  out)[0].        
+00020f70: 7265 7475 726e 206f 7574 0a0a 2020 2020  return out..    
+00020f80: 7361 7665 645f 666f 725f 6261 636b 7761  saved_for_backwa
+00020f90: 7264 203d 2066 6f72 7761 7264 5f74 7261  rd = forward_tra
+00020fa0: 6365 2e6f 7574 7075 745b 315d 0a20 2020  ce.output[1].   
+00020fb0: 2062 6163 6b77 6172 645f 7472 6163 6520   backward_trace 
+00020fc0: 3d20 636f 6e73 7472 7563 745f 7472 6163  = construct_trac
+00020fd0: 6528 7265 6e61 6d65 5f70 726f 7869 6573  e(rename_proxies
+00020fe0: 3d46 616c 7365 2928 6261 636b 7761 7264  =False)(backward
+00020ff0: 5f66 6e2c 2073 6176 6564 5f66 6f72 5f62  _fn, saved_for_b
+00021000: 6163 6b77 6172 642c 2063 6f74 616e 6765  ackward, cotange
+00021010: 6e74 7329 0a0a 2020 2020 2320 5765 2061  nts)..    # We a
+00021020: 7265 2064 6f6e 6520 7769 7468 2063 6f6e  re done with con
+00021030: 7374 7275 6374 696e 6720 7468 6520 666f  structing the fo
+00021040: 7277 6172 6420 616e 6420 6261 636b 7761  rward and backwa
+00021050: 7264 2070 6173 7365 7320 6174 2074 6869  rd passes at thi
+00021060: 730a 2020 2020 2320 7374 6167 652e 2054  s.    # stage. T
+00021070: 6865 2066 6f6c 6c6f 7769 6e67 2069 7320  he following is 
+00021080: 6e6f 7420 7374 7269 6374 6c79 206e 6563  not strictly nec
+00021090: 6573 7361 7279 2c20 6275 7420 6974 2773  essary, but it's
+000210a0: 2067 6f6f 6420 746f 2066 696c 7465 720a   good to filter.
+000210b0: 2020 2020 2320 6f75 7420 7468 6520 756e      # out the un
+000210c0: 7573 6564 2065 6c65 6d65 6e74 7320 6f66  used elements of
+000210d0: 2074 6865 2073 6176 6564 5f66 6f72 5f62   the saved_for_b
+000210e0: 6163 6b77 6172 6420 616e 6420 666c 6174  ackward and flat
+000210f0: 7465 6e20 6974 2066 6f72 206d 6f72 650a  ten it for more.
+00021100: 2020 2020 2320 636f 6d70 6163 7420 6261      # compact ba
+00021110: 636b 7761 7264 2074 7261 6365 2e0a 0a20  ckward trace... 
+00021120: 2020 2023 204e 6f77 2077 6520 6361 6e20     # Now we can 
+00021130: 6465 7465 726d 696e 6520 6578 6163 746c  determine exactl
+00021140: 7920 7768 6174 2773 2075 7365 6420 696e  y what's used in
+00021150: 2074 6865 2062 6163 6b77 6172 6420 7061   the backward pa
+00021160: 7373 2066 726f 6d20 7468 650a 2020 2020  ss from the.    
+00021170: 2320 7361 7665 645f 666f 725f 6261 636b  # saved_for_back
+00021180: 7761 7264 2e20 5765 2063 616e 2066 6c61  ward. We can fla
+00021190: 7474 656e 2061 6e64 2066 696c 7465 7220  tten and filter 
+000211a0: 7468 6520 7361 7665 645f 666f 725f 6261  the saved_for_ba
+000211b0: 636b 7761 7264 0a20 2020 2063 6f6e 7375  ckward.    consu
+000211c0: 6d65 7273 203d 2075 7469 6c73 2e63 6f6e  mers = utils.con
+000211d0: 7375 6d65 7273 2862 6163 6b77 6172 645f  sumers(backward_
+000211e0: 7472 6163 6529 0a0a 2020 2020 2320 466f  trace)..    # Fo
+000211f0: 7277 6172 6427 7320 616e 6420 6261 636b  rward's and back
+00021200: 7761 7264 2773 2022 7361 7665 645f 666f  ward's "saved_fo
+00021210: 725f 6261 636b 7761 7264 2220 6172 6520  r_backward" are 
+00021220: 6e6f 7420 6e65 6365 7373 6172 696c 7920  not necessarily 
+00021230: 7468 6520 7361 6d65 0a20 2020 2023 2061  the same.    # a
+00021240: 7320 7468 6520 7361 7665 645f 666f 725f  s the saved_for_
+00021250: 6261 636b 7761 7264 2c20 6265 6361 7573  backward, becaus
+00021260: 6520 736f 6d65 206f 7220 616c 6c20 656c  e some or all el
+00021270: 656d 656e 7473 206f 6620 7468 650a 2020  ements of the.  
+00021280: 2020 2320 7361 7665 645f 666f 725f 6261    # saved_for_ba
+00021290: 636b 7761 7264 2072 6573 756c 7473 206d  ckward results m
+000212a0: 6967 6874 2062 6520 7265 2d70 726f 7869  ight be re-proxi
+000212b0: 6669 6564 2e0a 2020 2020 6277 5f66 6c61  fied..    bw_fla
+000212c0: 745f 7361 7665 645f 666f 725f 6261 636b  t_saved_for_back
+000212d0: 7761 7264 2c20 7370 6563 203d 2074 7265  ward, spec = tre
+000212e0: 655f 666c 6174 7465 6e28 6261 636b 7761  e_flatten(backwa
+000212f0: 7264 5f74 7261 6365 2e61 7267 735b 305d  rd_trace.args[0]
+00021300: 290a 2020 2020 6677 5f66 6c61 745f 7361  ).    fw_flat_sa
+00021310: 7665 645f 666f 725f 6261 636b 7761 7264  ved_for_backward
+00021320: 2c20 5f20 3d20 7472 6565 5f66 6c61 7474  , _ = tree_flatt
+00021330: 656e 2866 6f72 7761 7264 5f74 7261 6365  en(forward_trace
+00021340: 2e6f 7574 7075 745b 315d 290a 2020 2020  .output[1]).    
+00021350: 7573 6564 5f6d 6173 6b20 3d20 6c69 7374  used_mask = list
+00021360: 286c 656e 2863 6f6e 7375 6d65 7273 2e67  (len(consumers.g
+00021370: 6574 2878 2c20 2829 2929 203e 2030 2066  et(x, ())) > 0 f
+00021380: 6f72 2078 2069 6e20 6277 5f66 6c61 745f  or x in bw_flat_
+00021390: 7361 7665 645f 666f 725f 6261 636b 7761  saved_for_backwa
+000213a0: 7264 290a 0a20 2020 2023 2044 6f6e 2774  rd)..    # Don't
+000213b0: 2075 7365 2074 6865 2073 616d 6520 7661   use the same va
+000213c0: 7269 6162 6c65 2074 7769 6365 2069 6e20  riable twice in 
+000213d0: 7468 6520 6261 636b 7761 7264 2070 6173  the backward pas
+000213e0: 730a 2020 2020 7365 656e 203d 2073 6574  s.    seen = set
+000213f0: 2829 0a20 2020 2066 726f 6d20 7468 756e  ().    from thun
+00021400: 6465 722e 636f 7265 2e70 726f 7869 6573  der.core.proxies
+00021410: 2069 6d70 6f72 7420 5661 7269 6162 6c65   import Variable
+00021420: 0a0a 2020 2020 666f 7220 692c 2078 2069  ..    for i, x i
+00021430: 6e20 656e 756d 6572 6174 6528 6677 5f66  n enumerate(fw_f
+00021440: 6c61 745f 7361 7665 645f 666f 725f 6261  lat_saved_for_ba
+00021450: 636b 7761 7264 293a 0a20 2020 2020 2020  ckward):.       
+00021460: 2078 203d 2076 6172 6961 626c 6569 6679   x = variableify
+00021470: 2878 290a 2020 2020 2020 2020 6966 206e  (x).        if n
+00021480: 6f74 2069 7369 6e73 7461 6e63 6528 782c  ot isinstance(x,
+00021490: 2056 6172 6961 626c 6529 3a0a 2020 2020   Variable):.    
+000214a0: 2020 2020 2020 2020 636f 6e74 696e 7565          continue
+000214b0: 0a20 2020 2020 2020 2069 6620 7820 696e  .        if x in
+000214c0: 2073 6565 6e3a 0a20 2020 2020 2020 2020   seen:.         
+000214d0: 2020 2075 7365 645f 6d61 736b 5b69 5d20     used_mask[i] 
+000214e0: 3d20 4661 6c73 650a 2020 2020 2020 2020  = False.        
+000214f0: 656c 7365 3a0a 2020 2020 2020 2020 2020  else:.          
+00021500: 2020 7365 656e 2e61 6464 2878 290a 0a20    seen.add(x).. 
+00021510: 2020 206f 6e6c 795f 7573 6564 5f66 775f     only_used_fw_
+00021520: 7361 7665 645f 666f 725f 6261 636b 7761  saved_for_backwa
+00021530: 7264 203d 2074 7570 6c65 2863 6f6d 7072  rd = tuple(compr
+00021540: 6573 7328 6677 5f66 6c61 745f 7361 7665  ess(fw_flat_save
+00021550: 645f 666f 725f 6261 636b 7761 7264 2c20  d_for_backward, 
+00021560: 7573 6564 5f6d 6173 6b29 290a 2020 2020  used_mask)).    
+00021570: 6f6e 6c79 5f75 7365 645f 6277 5f73 6176  only_used_bw_sav
+00021580: 6564 5f66 6f72 5f62 6163 6b77 6172 6420  ed_for_backward 
+00021590: 3d20 7475 706c 6528 636f 6d70 7265 7373  = tuple(compress
+000215a0: 2862 775f 666c 6174 5f73 6176 6564 5f66  (bw_flat_saved_f
+000215b0: 6f72 5f62 6163 6b77 6172 642c 2075 7365  or_backward, use
+000215c0: 645f 6d61 736b 2929 0a0a 2020 2020 2320  d_mask))..    # 
+000215d0: 5765 206e 6565 6420 746f 2075 7064 6174  We need to updat
+000215e0: 6520 7468 6520 7472 6163 6573 2077 6974  e the traces wit
+000215f0: 6820 7468 6520 6e65 7720 7361 7665 645f  h the new saved_
+00021600: 666f 725f 6261 636b 7761 7264 0a20 2020  for_backward.   
+00021610: 205f 7570 6461 7465 5f66 6f72 7761 7264   _update_forward
+00021620: 5f77 6974 685f 6e65 775f 7361 7665 645f  _with_new_saved_
+00021630: 666f 725f 6261 636b 7761 7264 2866 6f72  for_backward(for
+00021640: 7761 7264 5f74 7261 6365 2c20 6f6e 6c79  ward_trace, only
+00021650: 5f75 7365 645f 6677 5f73 6176 6564 5f66  _used_fw_saved_f
+00021660: 6f72 5f62 6163 6b77 6172 6429 0a20 2020  or_backward).   
+00021670: 205f 7570 6461 7465 5f62 6163 6b77 6172   _update_backwar
+00021680: 645f 7769 7468 5f6e 6577 5f73 6176 6564  d_with_new_saved
+00021690: 5f66 6f72 5f62 6163 6b77 6172 6428 6261  _for_backward(ba
+000216a0: 636b 7761 7264 5f74 7261 6365 2c20 6f6e  ckward_trace, on
+000216b0: 6c79 5f75 7365 645f 6277 5f73 6176 6564  ly_used_bw_saved
+000216c0: 5f66 6f72 5f62 6163 6b77 6172 6429 0a20  _for_backward). 
+000216d0: 2020 2066 6f72 7761 7264 5f74 7261 6365     forward_trace
+000216e0: 2e73 6574 5f70 726f 7665 6e61 6e63 6528  .set_provenance(
+000216f0: 5472 6163 6550 726f 7665 6e61 6e63 6528  TraceProvenance(
+00021700: 2241 7567 6d65 6e74 6564 2066 6f72 7761  "Augmented forwa
+00021710: 7264 2070 6173 7322 2929 0a20 2020 2062  rd pass")).    b
+00021720: 6163 6b77 6172 645f 7472 6163 652e 7365  ackward_trace.se
+00021730: 745f 7072 6f76 656e 616e 6365 2854 7261  t_provenance(Tra
+00021740: 6365 5072 6f76 656e 616e 6365 2822 4261  ceProvenance("Ba
+00021750: 636b 7761 7264 2070 6173 7322 2929 0a20  ckward pass")). 
+00021760: 2020 2072 6574 7572 6e20 466f 7277 6172     return Forwar
+00021770: 6442 6163 6b77 6172 6454 7261 6365 7328  dBackwardTraces(
+00021780: 666f 7277 6172 645f 7472 6163 652c 2062  forward_trace, b
+00021790: 6163 6b77 6172 645f 7472 6163 6529 0a0a  ackward_trace)..
+000217a0: 0a23 2064 6f20 7765 2068 6170 7065 6e20  .# do we happen 
+000217b0: 746f 2077 616e 7420 746f 2072 6567 6973  to want to regis
+000217c0: 7465 7220 606c 746f 7263 6860 206f 7073  ter `ltorch` ops
+000217d0: 2073 7563 6820 6173 2060 6c74 6f72 6368   such as `ltorch
+000217e0: 2e6c 6179 6572 5f6e 6f72 6d60 2061 7320  .layer_norm` as 
+000217f0: 7765 6c6c 3f0a 6175 746f 6361 7374 5f69  well?.autocast_i
+00021800: 6d70 6c73 3a20 6469 6374 5b70 7269 6d73  mpls: dict[prims
+00021810: 2e50 7269 6d49 4473 2c20 4361 6c6c 6162  .PrimIDs, Callab
+00021820: 6c65 5d20 3d20 7b7d 0a0a 0a64 6566 2072  le] = {}...def r
+00021830: 6567 6973 7465 725f 6175 746f 6361 7374  egister_autocast
+00021840: 5f72 756c 6528 6f70 293a 0a20 2020 2064  _rule(op):.    d
+00021850: 6566 2064 6563 6f72 6174 6f72 2866 756e  ef decorator(fun
+00021860: 6329 3a0a 2020 2020 2020 2020 6175 746f  c):.        auto
+00021870: 6361 7374 5f69 6d70 6c73 5b6f 705d 203d  cast_impls[op] =
+00021880: 2066 756e 630a 2020 2020 2020 2020 7265   func.        re
+00021890: 7475 726e 2066 756e 630a 0a20 2020 2072  turn func..    r
+000218a0: 6574 7572 6e20 6465 636f 7261 746f 720a  eturn decorator.
+000218b0: 0a0a 6465 6620 6d61 7962 655f 646f 776e  ..def maybe_down
+000218c0: 6361 7374 5f74 6f28 6474 7970 652c 2061  cast_to(dtype, a
+000218d0: 7267 7329 3a0a 2020 2020 616c 6c6f 7765  rgs):.    allowe
+000218e0: 645f 646f 776e 6361 7374 5f74 7970 6573  d_downcast_types
+000218f0: 203d 2028 6474 7970 6573 2e66 6c6f 6174   = (dtypes.float
+00021900: 3136 2c20 6474 7970 6573 2e62 666c 6f61  16, dtypes.bfloa
+00021910: 7431 362c 2064 7479 7065 732e 666c 6f61  t16, dtypes.floa
+00021920: 7433 3229 0a0a 2020 2020 6465 6620 6d61  t32)..    def ma
+00021930: 705f 666e 2861 293a 0a20 2020 2020 2020  p_fn(a):.       
+00021940: 2069 6620 6973 696e 7374 616e 6365 2861   if isinstance(a
+00021950: 2c20 5465 6e73 6f72 5072 6f78 7929 2061  , TensorProxy) a
+00021960: 6e64 2061 2e64 7479 7065 2069 6e20 616c  nd a.dtype in al
+00021970: 6c6f 7765 645f 646f 776e 6361 7374 5f74  lowed_downcast_t
+00021980: 7970 6573 3a0a 2020 2020 2020 2020 2020  ypes:.          
+00021990: 2020 7265 7475 726e 206d 6179 6265 5f63    return maybe_c
+000219a0: 6f6e 7665 7274 5f74 6f5f 6474 7970 6528  onvert_to_dtype(
+000219b0: 612c 2064 7479 7065 290a 2020 2020 2020  a, dtype).      
+000219c0: 2020 7265 7475 726e 2061 0a0a 2020 2020    return a..    
+000219d0: 7265 7475 726e 2074 7265 655f 6d61 7028  return tree_map(
+000219e0: 6d61 705f 666e 2c20 6172 6773 290a 0a0a  map_fn, args)...
+000219f0: 4072 6567 6973 7465 725f 6175 746f 6361  @register_autoca
+00021a00: 7374 5f72 756c 6528 2274 6f72 6368 2e6d  st_rule("torch.m
+00021a10: 6174 6d75 6c22 290a 4072 6567 6973 7465  atmul").@registe
+00021a20: 725f 6175 746f 6361 7374 5f72 756c 6528  r_autocast_rule(
+00021a30: 7072 696d 732e 5072 696d 4944 732e 4d41  prims.PrimIDs.MA
+00021a40: 544d 554c 290a 6465 6620 6175 746f 6361  TMUL).def autoca
+00021a50: 7374 5f6d 6174 6d75 6c5f 7275 6c65 2861  st_matmul_rule(a
+00021a60: 2c20 622c 2064 7479 7065 293a 0a20 2020  , b, dtype):.   
+00021a70: 2022 2222 4175 746f 6361 7374 2072 756c   """Autocast rul
+00021a80: 6520 666f 7220 6d61 746d 756c 2222 220a  e for matmul""".
+00021a90: 2020 2020 7265 7475 726e 2070 7269 6d73      return prims
+00021aa0: 2e6d 6174 6d75 6c28 2a28 6d61 7962 655f  .matmul(*(maybe_
+00021ab0: 646f 776e 6361 7374 5f74 6f28 6474 7970  downcast_to(dtyp
+00021ac0: 652c 2028 612c 2062 2929 2929 0a0a 0a40  e, (a, b))))...@
+00021ad0: 7265 6769 7374 6572 5f61 7574 6f63 6173  register_autocas
+00021ae0: 745f 7275 6c65 2822 746f 7263 682e 6e6e  t_rule("torch.nn
+00021af0: 2e66 756e 6374 696f 6e61 6c2e 6c69 6e65  .functional.line
+00021b00: 6172 2229 0a40 7265 6769 7374 6572 5f61  ar").@register_a
+00021b10: 7574 6f63 6173 745f 7275 6c65 2870 7269  utocast_rule(pri
+00021b20: 6d73 2e50 7269 6d49 4473 2e4c 494e 4541  ms.PrimIDs.LINEA
+00021b30: 5229 0a64 6566 2061 7574 6f63 6173 745f  R).def autocast_
+00021b40: 6c69 6e65 6172 5f72 756c 6528 612c 2077  linear_rule(a, w
+00021b50: 2c20 6269 6173 2c20 6474 7970 6529 3a0a  , bias, dtype):.
+00021b60: 2020 2020 6966 2062 6961 7320 6973 204e      if bias is N
+00021b70: 6f6e 653a 0a20 2020 2020 2020 2023 2044  one:.        # D
+00021b80: 6f6e 2774 2070 6173 7320 6062 6961 7360  on't pass `bias`
+00021b90: 2074 6f20 6d61 7962 655f 646f 776e 6361   to maybe_downca
+00021ba0: 7374 5f74 6f2e 0a20 2020 2020 2020 2064  st_to..        d
+00021bb0: 6f77 6e63 6173 745f 6172 6773 203d 206d  owncast_args = m
+00021bc0: 6179 6265 5f64 6f77 6e63 6173 745f 746f  aybe_downcast_to
+00021bd0: 2864 7479 7065 2c20 2861 2c20 7729 2920  (dtype, (a, w)) 
+00021be0: 2b20 2862 6961 732c 290a 2020 2020 656c  + (bias,).    el
+00021bf0: 7365 3a0a 2020 2020 2020 2020 646f 776e  se:.        down
+00021c00: 6361 7374 5f61 7267 7320 3d20 6d61 7962  cast_args = mayb
+00021c10: 655f 646f 776e 6361 7374 5f74 6f28 6474  e_downcast_to(dt
+00021c20: 7970 652c 2028 612c 2077 2c20 6269 6173  ype, (a, w, bias
+00021c30: 2929 0a0a 2020 2020 7265 7475 726e 2070  ))..    return p
+00021c40: 7269 6d73 2e6c 696e 6561 7228 2a64 6f77  rims.linear(*dow
+00021c50: 6e63 6173 745f 6172 6773 290a 0a0a 4072  ncast_args)...@r
+00021c60: 6567 6973 7465 725f 6175 746f 6361 7374  egister_autocast
+00021c70: 5f72 756c 6528 2274 6f72 6368 2e6e 6e2e  _rule("torch.nn.
+00021c80: 6675 6e63 7469 6f6e 616c 2e73 6361 6c65  functional.scale
+00021c90: 645f 646f 745f 7072 6f64 7563 745f 6174  d_dot_product_at
+00021ca0: 7465 6e74 696f 6e22 290a 6465 6620 6175  tention").def au
+00021cb0: 746f 6361 7374 5f73 6361 6c65 645f 646f  tocast_scaled_do
+00021cc0: 745f 7072 6f64 7563 745f 6174 7465 6e74  t_product_attent
+00021cd0: 696f 6e28 0a20 2020 2071 7565 7279 2c0a  ion(.    query,.
+00021ce0: 2020 2020 6b65 792c 0a20 2020 2076 616c      key,.    val
+00021cf0: 7565 2c0a 2020 2020 6174 746e 5f6d 6173  ue,.    attn_mas
+00021d00: 6b2c 0a20 2020 2064 726f 706f 7574 5f70  k,.    dropout_p
+00021d10: 2c0a 2020 2020 6973 5f63 6175 7361 6c2c  ,.    is_causal,
+00021d20: 0a20 2020 202a 2c0a 2020 2020 6474 7970  .    *,.    dtyp
+00021d30: 652c 0a20 2020 2073 6361 6c65 2c0a 293a  e,.    scale,.):
+00021d40: 0a20 2020 2066 726f 6d20 7468 756e 6465  .    from thunde
+00021d50: 722e 746f 7263 6820 696d 706f 7274 2073  r.torch import s
+00021d60: 6361 6c65 645f 646f 745f 7072 6f64 7563  caled_dot_produc
+00021d70: 745f 6174 7465 6e74 696f 6e0a 0a20 2020  t_attention..   
+00021d80: 2071 2c20 6b2c 2076 203d 206d 6179 6265   q, k, v = maybe
+00021d90: 5f64 6f77 6e63 6173 745f 746f 2864 7479  _downcast_to(dty
+00021da0: 7065 2c20 2871 7565 7279 2c20 6b65 792c  pe, (query, key,
+00021db0: 2076 616c 7565 2929 0a20 2020 2072 6574   value)).    ret
+00021dc0: 7572 6e20 7363 616c 6564 5f64 6f74 5f70  urn scaled_dot_p
+00021dd0: 726f 6475 6374 5f61 7474 656e 7469 6f6e  roduct_attention
+00021de0: 2871 2c20 6b2c 2076 2c20 6174 746e 5f6d  (q, k, v, attn_m
+00021df0: 6173 6b2c 2064 726f 706f 7574 5f70 2c20  ask, dropout_p, 
+00021e00: 6973 5f63 6175 7361 6c2c 2073 6361 6c65  is_causal, scale
+00021e10: 3d73 6361 6c65 290a 0a0a 6465 6620 6175  =scale)...def au
+00021e20: 746f 6361 7374 5f73 796d 626f 6c5f 6d61  tocast_symbol_ma
+00021e30: 7070 6572 2862 6f75 6e64 5f73 796d 626f  pper(bound_symbo
+00021e40: 6c3a 2042 6f75 6e64 5379 6d62 6f6c 496e  l: BoundSymbolIn
+00021e50: 7465 7266 6163 652c 2064 7479 7065 3a20  terface, dtype: 
+00021e60: 6474 7970 6573 2e64 7479 7065 293a 0a20  dtypes.dtype):. 
+00021e70: 2020 2022 2222 5265 7475 726e 2074 6865     """Return the
+00021e80: 2063 616c 6c61 626c 6520 696d 706c 656d   callable implem
+00021e90: 656e 7469 6e67 2074 6865 2061 7574 6f63  enting the autoc
+00021ea0: 6173 7420 7275 6c65 2066 6f72 2074 6865  ast rule for the
+00021eb0: 2073 796d 626f 6c2e 0a0a 2020 2020 4172   symbol...    Ar
+00021ec0: 6773 3a0a 2020 2020 2020 2020 626f 756e  gs:.        boun
+00021ed0: 645f 7379 6d62 6f6c 3a20 4d61 7070 6564  d_symbol: Mapped
+00021ee0: 2074 6f20 6974 7320 6175 746f 6361 7374   to its autocast
+00021ef0: 2072 756c 652e 0a0a 2020 2020 5265 7475   rule...    Retu
+00021f00: 726e 733a 0a20 2020 2020 2020 2043 616c  rns:.        Cal
+00021f10: 6c61 626c 653a 2054 6865 2063 616c 6c61  lable: The calla
+00021f20: 626c 6520 696d 706c 656d 656e 7469 6e67  ble implementing
+00021f30: 2074 6865 2061 7574 6f63 6173 7420 7275   the autocast ru
+00021f40: 6c65 2066 6f72 2074 6865 2073 796d 626f  le for the symbo
+00021f50: 6c2e 0a20 2020 2022 2222 0a20 2020 2061  l..    """.    a
+00021f60: 7574 6f63 6173 745f 696d 706c 3a20 4361  utocast_impl: Ca
+00021f70: 6c6c 6162 6c65 207c 204e 6f6e 6520 3d20  llable | None = 
+00021f80: 6175 746f 6361 7374 5f69 6d70 6c73 2e67  autocast_impls.g
+00021f90: 6574 2862 6f75 6e64 5f73 796d 626f 6c2e  et(bound_symbol.
+00021fa0: 7379 6d2e 6964 290a 2020 2020 7265 7475  sym.id).    retu
+00021fb0: 726e 2062 6f75 6e64 5f73 796d 626f 6c2e  rn bound_symbol.
+00021fc0: 7379 6d20 6966 2061 7574 6f63 6173 745f  sym if autocast_
+00021fd0: 696d 706c 2069 7320 4e6f 6e65 2065 6c73  impl is None els
+00021fe0: 6520 7061 7274 6961 6c28 6175 746f 6361  e partial(autoca
+00021ff0: 7374 5f69 6d70 6c2c 2064 7479 7065 3d64  st_impl, dtype=d
+00022000: 7479 7065 290a 0a0a 6465 6620 6175 746f  type)...def auto
+00022010: 6361 7374 2866 756e 633a 2043 616c 6c61  cast(func: Calla
+00022020: 626c 652c 2064 7479 7065 3a20 6474 7970  ble, dtype: dtyp
+00022030: 6573 2e64 7479 7065 293a 0a20 2020 2022  es.dtype):.    "
+00022040: 2222 5472 616e 7366 6f72 6d73 2061 2066  ""Transforms a f
+00022050: 756e 6374 696f 6e20 746f 2061 7574 6f63  unction to autoc
+00022060: 6173 7420 6365 7274 6169 6e20 6f70 6572  ast certain oper
+00022070: 6174 696f 6e73 2e0a 0a20 2020 2041 7267  ations...    Arg
+00022080: 733a 0a20 2020 2020 2020 2066 756e 633a  s:.        func:
+00022090: 2054 6865 2066 756e 6374 696f 6e20 746f   The function to
+000220a0: 2062 6520 7472 616e 7366 6f72 6d65 642e   be transformed.
+000220b0: 0a20 2020 2020 2020 2064 7479 7065 3a20  .        dtype: 
+000220c0: 5468 6520 6461 7461 2074 7970 6520 746f  The data type to
+000220d0: 2077 6869 6368 2061 7267 756d 656e 7473   which arguments
+000220e0: 206f 6620 7468 6520 6675 6e63 7469 6f6e   of the function
+000220f0: 206f 7220 7375 6220 6675 6e63 7469 6f6e   or sub function
+00022100: 7320 636f 756c 6420 6765 7420 6361 7374  s could get cast
+00022110: 2069 660a 2020 2020 2020 2020 2020 2020   if.            
+00022120: 7468 6579 2061 7265 2060 6474 7970 6573  they are `dtypes
+00022130: 2e66 6c6f 6174 3332 602e 0a0a 2020 2020  .float32`...    
+00022140: 5265 7475 726e 733a 0a20 2020 2020 2020  Returns:.       
+00022150: 2043 616c 6c61 626c 653a 2054 6865 2074   Callable: The t
+00022160: 7261 6e73 666f 726d 6564 2066 756e 6374  ransformed funct
+00022170: 696f 6e0a 2020 2020 2222 220a 0a20 2020  ion.    """..   
+00022180: 2069 6620 6e6f 7420 6973 696e 7374 616e   if not isinstan
+00022190: 6365 2864 7479 7065 2c20 6474 7970 6573  ce(dtype, dtypes
+000221a0: 2e64 7479 7065 293a 0a20 2020 2020 2020  .dtype):.       
+000221b0: 2072 6169 7365 2056 616c 7565 4572 726f   raise ValueErro
+000221c0: 7228 6622 6064 7479 7065 6020 6973 2065  r(f"`dtype` is e
+000221d0: 7870 6563 7465 6420 746f 2062 6520 6074  xpected to be `t
+000221e0: 6875 6e64 6572 2e64 7479 7065 2e64 7479  hunder.dtype.dty
+000221f0: 7065 6020 6275 7420 7b74 7970 6528 6474  pe` but {type(dt
+00022200: 7970 6529 7d22 290a 2020 2020 6966 2064  ype)}").    if d
+00022210: 7479 7065 206e 6f74 2069 6e20 7b64 7479  type not in {dty
+00022220: 7065 732e 666c 6f61 7431 362c 2064 7479  pes.float16, dty
+00022230: 7065 732e 6266 6c6f 6174 3136 7d3a 0a20  pes.bfloat16}:. 
+00022240: 2020 2020 2020 2072 6169 7365 2056 616c         raise Val
+00022250: 7565 4572 726f 7228 6622 6064 7479 7065  ueError(f"`dtype
+00022260: 6020 6973 2065 7870 6563 7465 6420 746f  ` is expected to
+00022270: 2062 6520 6569 7468 6572 2060 7468 756e   be either `thun
+00022280: 6465 722e 666c 6f61 7431 3660 206f 7220  der.float16` or 
+00022290: 6074 6875 6e64 6572 2e62 666c 6f61 7431  `thunder.bfloat1
+000222a0: 3660 2c20 6275 7420 7b64 7479 7065 7d22  6`, but {dtype}"
+000222b0: 290a 0a20 2020 2040 7772 6170 7328 6675  )..    @wraps(fu
+000222c0: 6e63 290a 2020 2020 6465 6620 7772 6170  nc).    def wrap
+000222d0: 7065 7228 2a61 7267 732c 202a 2a6b 7761  per(*args, **kwa
+000222e0: 7267 7329 3a0a 2020 2020 2020 2020 7472  rgs):.        tr
+000222f0: 6163 6520 3d20 636f 6e73 7472 7563 745f  ace = construct_
+00022300: 7472 6163 6528 2928 6675 6e63 2c20 2a61  trace()(func, *a
+00022310: 7267 732c 202a 2a6b 7761 7267 7329 0a20  rgs, **kwargs). 
+00022320: 2020 2020 2020 2072 6574 7572 6e20 6576         return ev
+00022330: 616c 5f74 7261 6365 2874 7261 6365 2c20  al_trace(trace, 
+00022340: 2a61 7267 732c 202a 2a6b 7761 7267 732c  *args, **kwargs,
+00022350: 2073 796d 626f 6c5f 6d61 7070 6572 3d70   symbol_mapper=p
+00022360: 6172 7469 616c 2861 7574 6f63 6173 745f  artial(autocast_
+00022370: 7379 6d62 6f6c 5f6d 6170 7065 722c 2064  symbol_mapper, d
+00022380: 7479 7065 3d64 7479 7065 2929 0a0a 2020  type=dtype))..  
+00022390: 2020 7265 7475 726e 2077 7261 7070 6572    return wrapper
+000223a0: 0a                                       .
```

### Comparing `lightning_thunder-0.2.0.dev20240428/thunder/core/utils.py` & `lightning_thunder-0.2.0.dev20240505/thunder/core/utils.py`

 * *Files identical despite different names*

### Comparing `lightning_thunder-0.2.0.dev20240428/thunder/core/vjp_utils.py` & `lightning_thunder-0.2.0.dev20240505/thunder/core/vjp_utils.py`

 * *Files identical despite different names*

### Comparing `lightning_thunder-0.2.0.dev20240428/thunder/cudagraphs/__init__.py` & `lightning_thunder-0.2.0.dev20240505/thunder/cudagraphs/__init__.py`

 * *Files identical despite different names*

### Comparing `lightning_thunder-0.2.0.dev20240428/thunder/distributed/__init__.py` & `lightning_thunder-0.2.0.dev20240505/thunder/distributed/__init__.py`

 * *Files 7% similar despite different names*

```diff
@@ -80,23 +80,54 @@
         # The ordinary jitted module branch
         process_group = cd.process_group_for_ddp
     else:
         raise RuntimeError(
             f"Expected `{type(module).__name__}` to have been jitted or to contain a `process_group_for_ddp` attribute"
         )
 
-    params_with_grad = [p for p in module.parameters() if p.grad is not None]
-    if not params_with_grad:
-        return
-    grads = [p.grad for p in params_with_grad]
-    torch._foreach_div_(grads, process_group.size())
-    with tdist.distributed_c10d._coalescing_manager(group=process_group, async_ops=True) as cm:
-        for g in grads:
-            tdist.distributed_c10d.all_reduce(g)
-    cm.wait()
+    if getattr(module, "use_ddp", False):
+        params_with_grad = [p for p in module.parameters() if p.grad is not None]
+        if not params_with_grad:
+            return
+        grads = [p.grad for p in params_with_grad]
+        torch._foreach_div_(grads, process_group.size())
+        with tdist.distributed_c10d._coalescing_manager(group=process_group, async_ops=True) as cm:
+            for g in grads:
+                tdist.distributed_c10d.all_reduce(g)
+        cm.wait()
+    elif getattr(module, "use_fsdp", False):
+
+        def prep_shard(
+            g: torch.Tensor,
+            rank: int,
+            world_size: int,
+        ) -> torch.Tensor:
+            chunk_size = g.size(0) // world_size
+            return g.narrow(0, rank * chunk_size, chunk_size)
+
+        rank: int = tdist.distributed_c10d.get_rank(process_group)
+        world_size: int = tdist.distributed_c10d.get_world_size(process_group)
+        params_with_grad = tuple(filter(lambda p: hasattr(p, "_thunder_fsdp_unsharded_grad"), module.parameters()))
+        if not params_with_grad:
+            return
+        unsharded_grads = [p._thunder_fsdp_unsharded_grad for p in params_with_grad]
+        sharded_grads = [prep_shard(g, rank, world_size) for g in unsharded_grads]
+        with tdist.distributed_c10d._coalescing_manager(group=process_group, async_ops=True) as cm:
+            for u, s in zip(unsharded_grads, sharded_grads):
+                tdist.distributed_c10d.reduce_scatter_tensor(s, u, op=tdist.distributed_c10d.ReduceOp.AVG)
+        cm.wait()
+        for p, g in zip(params_with_grad, sharded_grads):
+            p.grad = g
+            del p._thunder_fsdp_unsharded_grad
+    else:
+        import warnings
+
+        warnings.warn(
+            "No op since neither `use_ddp` nor `use_fsdp` set. Have you applied either `thunder.distributed.ddp` or `thunder.distributed.fsdp`?"
+        )
 
 
 # TODO Verify parameters are not partially initialized
 # TODO Handle buffers
 # TODO Improve initial broadcast logic
 # Syncs a module's parameters across multiple processes
 #   broadcast_from is the rank to broadcast tensors from
```

### Comparing `lightning_thunder-0.2.0.dev20240428/thunder/distributed/bucketing.py` & `lightning_thunder-0.2.0.dev20240505/thunder/distributed/bucketing.py`

 * *Files identical despite different names*

### Comparing `lightning_thunder-0.2.0.dev20240428/thunder/distributed/checkpoint.py` & `lightning_thunder-0.2.0.dev20240505/thunder/distributed/checkpoint.py`

 * *Files identical despite different names*

### Comparing `lightning_thunder-0.2.0.dev20240428/thunder/distributed/prims.py` & `lightning_thunder-0.2.0.dev20240505/thunder/distributed/prims.py`

 * *Files 3% similar despite different names*

```diff
@@ -1,32 +1,38 @@
+from __future__ import annotations
 from enum import auto, Enum
 from numbers import Number
+from typing import TYPE_CHECKING
 
 import torch.distributed
 
 import thunder.core.utils as utils
 from thunder.core.prims import make_prim
 
 from thunder.core.proxies import DDPType, FutureTensorProxy, pytype, TensorProxy
 from thunder.core.transforms import register_augmented_forward, register_backward
 
+if TYPE_CHECKING:
+    from thunder.common import CompileData
+
 
 class PrimIDs(Enum):
     # Distributed prims (Experimental!)
     ALL_GATHER = auto()
     ALL_REDUCE = auto()
     BROADCAST = auto()
     REDUCE_SCATTER = auto()
     SYNCHRONIZE = auto()
     WAIT = auto()
     PACK = auto()
     UNPACK = auto()
     UNPACK_FOR_FSDP = auto()
     UPDATE_BUCKET_VIEW = auto()
     PACK_FOR_FSDP = auto()
+    STASH_GRAD_FOR_FSDP = auto()
 
 
 # This enum describes what all_reduce (below) will actually do
 #   These operations are performed elementwise on all the "versions" of
 #   the tensor across processes.
 class DistributedReduceOps(Enum):
     SUM = auto()
@@ -240,25 +246,46 @@
     return result
 
 
 def update_bucket_view_meta(tensor: TensorProxy, index_of_dst_view: int, bucket_key: str) -> TensorProxy:
     return TensorProxy(like=tensor)
 
 
+# [NOTE - shape of output]
+# `ThunderFunction.backward` replaces outputs of this function with None, so the shape wouldn't matter a lot.
+# TODO(crcrpar): Update this to return `None`
+def stash_grad_for_fsdp_meta(
+    grad: TensorProxy,
+    param_fqn: str,
+    compile_data: CompileData,
+) -> TensorProxy:
+    from thunder.common import CompileData
+
+    utils.check_type(grad, TensorProxy)
+    utils.check_type(param_fqn, str)
+    utils.check_type(compile_data, CompileData)
+    return TensorProxy(like=grad)
+
+
 all_gather = make_prim(PrimIDs.ALL_GATHER, "all_gather", meta=all_gather_meta)
 all_reduce = make_prim(PrimIDs.ALL_REDUCE, "all_reduce", meta=all_reduce_meta)
 broadcast = make_prim(PrimIDs.BROADCAST, "broadcast", meta=broadcast_meta)
 reduce_scatter = make_prim(PrimIDs.REDUCE_SCATTER, "reduce_scatter", meta=reduce_scatter)
 synchronize = make_prim(PrimIDs.SYNCHRONIZE, "synchronize", meta=synchronize_meta)
 wait = make_prim(PrimIDs.WAIT, "wait", meta=wait_meta)
 pack = make_prim(PrimIDs.PACK, "pack", meta=pack_meta)
 pack_for_fsdp = make_prim(PrimIDs.PACK_FOR_FSDP, "pack_for_fsdp", meta=pack_for_fsdp_meta)
 unpack = make_prim(PrimIDs.UNPACK, "unpack", meta=unpack_meta)
 unpack_for_fsdp = make_prim(PrimIDs.UNPACK_FOR_FSDP, "unpack_for_fsdp", meta=unpack_for_fsdp_meta)
 update_bucket_view = make_prim(PrimIDs.UPDATE_BUCKET_VIEW, "update_bucket_view", meta=update_bucket_view_meta)
+stash_grad_for_fsdp = make_prim(
+    PrimIDs.STASH_GRAD_FOR_FSDP,
+    "stash_grad_for_fsdp",
+    meta=stash_grad_for_fsdp_meta,
+)
 
 
 @register_augmented_forward(PrimIDs.SYNCHRONIZE)
 def synchronize_augmented_forward_rule(
     a: TensorProxy, group: torch.distributed.ProcessGroup
 ) -> tuple[TensorProxy, tuple]:
     match a.ddp_type:
```

### Comparing `lightning_thunder-0.2.0.dev20240428/thunder/distributed/transforms/ddp.py` & `lightning_thunder-0.2.0.dev20240505/thunder/distributed/transforms/ddp.py`

 * *Files 19% similar despite different names*

```diff
@@ -5,29 +5,33 @@
 
 from thunder.core import dtypes
 from thunder.core import devices
 from thunder.core import prims
 from thunder.core.prims import PrimIDs
 from thunder.core.proxies import FutureTensorProxy
 from thunder.core.proxies import TensorProxy
+from thunder.core.proxies import variableify
 from thunder.core.pytree import tree_flatten
 from thunder.core.pytree import tree_unflatten
+from thunder.core.trace import from_trace
+from thunder.core.trace import TraceProvenance
 from thunder.core.transforms import visitor_transform
 from thunder.core.transforms import VISIT_TYPE
 from thunder.core import utils
 from thunder.distributed import get_skip_data_parallel_grad_sync
 from thunder.distributed.bucketing import GradBuckets
 from thunder.distributed import prims as dist_prims
 
 if TYPE_CHECKING:
     from typing import Any
     from torch.distributed import ProcessGroup
     from thunder.core.symbol import Symbol
     from thunder.core.symbol import BoundSymbol
     from thunder.core.trace import TraceCtx
+    from thunder.core.trace import VariableInterface
     from thunder.common import CompileData
 
 
 __all__ = [
     "optimize_allreduce_in_ddp_backward",
 ]
 
@@ -46,14 +50,46 @@
     if prod_bsym.sym.id == dist_prims.PrimIDs.WAIT:
         return prod_bsym
     t = prod_bsym.flat_proxy_args[0]
     utils.check_type(t, (TensorProxy, FutureTensorProxy))
     return get_bsym_of_wait(t, producers)
 
 
+def remove_grad_sync(backward_trace_with_grad_sync: TraceCtx) -> TraceCtx:
+    flat_synced_grads, _ = tree_flatten(backward_trace_with_grad_sync.output)
+    producers = utils.producers(backward_trace_with_grad_sync)
+    synced_to_unsynced: dict[VariableInterface, TensorProxy] = {}
+    bsym_to_remove: list[BoundSymbol] = []
+    for synced_grad in flat_synced_grads:
+        if not isinstance(synced_grad, TensorProxy):
+            continue
+        bsym_of_allreduce = get_bsym_of_allreduce_of_grad(synced_grad, producers)
+        bsym_of_wait = get_bsym_of_wait(synced_grad, producers)
+        bsym_of_preaveraging: BoundSymbol = producers[bsym_of_allreduce.flat_proxy_args[0]]
+        utils.check(
+            bsym_of_preaveraging.sym.id in {PrimIDs.DIV, "torch.true_divide"},
+            lambda: f"expected to be either of {(PrimIDs.DIV, 'torch.true_divide')} but {bsym_of_preaveraging.sym.id=} for {synced_grad=}",
+        )
+        bsym_to_remove.extend([bsym_of_allreduce, bsym_of_wait, bsym_of_preaveraging])
+        synced_to_unsynced[variableify(synced_grad)] = bsym_of_preaveraging.flat_proxy_args[0]
+    bsym_denylist = set(bsym_to_remove)
+
+    backward_trace = from_trace(backward_trace_with_grad_sync)
+    bsym: BoundSymbol
+    for bsym in backward_trace_with_grad_sync.bound_symbols:
+        if bsym in bsym_denylist:
+            continue
+        if bsym.sym.id == PrimIDs.RETURN:
+            backward_trace.add_bound_symbol(bsym.from_bsym_swap_proxies(swap_map=synced_to_unsynced))
+        else:
+            backward_trace.add_bound_symbol(bsym)
+    backward_trace.set_provenance(TraceProvenance("remove grad sync comms"))
+    return backward_trace
+
+
 @dataclass
 class MakeAllReduceInplace:
     allreduce_bsyms: dict[BoundSymbol, FutureTensorProxy]
     # note: This would be error prone, so it might make sense to turn all_reduce's
     # op, group, do_async, and skip_clone into keyword-only args
 
     def __call__(self, bsym: BoundSymbol) -> VISIT_TYPE:
@@ -157,15 +193,15 @@
         compile_data:
 
     Returns:
         :class:`TraceCtx`
     """
 
     if get_skip_data_parallel_grad_sync():
-        return backward_trace
+        return remove_grad_sync(backward_trace)
 
     # Map from preaveraged grad to index in trace.output
     producers = utils.producers(backward_trace)
     preaveraged_grads: list[TensorProxy] = []
     preaveraged_to_index = utils.ProxyDict()
     for i, t in enumerate(tree_flatten(backward_trace.output)[0]):
         if isinstance(t, TensorProxy):
```

### Comparing `lightning_thunder-0.2.0.dev20240428/thunder/distributed/transforms/fsdp.py` & `lightning_thunder-0.2.0.dev20240505/thunder/distributed/transforms/fsdp.py`

 * *Files 5% similar despite different names*

```diff
@@ -15,33 +15,35 @@
 from thunder.core.proxies import TensorProxy
 from thunder.core.proxies import FutureTensorProxy
 from thunder.core.pytree import tree_flatten
 from thunder.core.pytree import tree_unflatten
 from thunder.core.symbol import BoundSymbol
 from thunder.core.trace import VariableInterface
 from thunder.core.trace import from_trace
+from thunder.core.trace import TraceCtx
 from thunder.core.transforms import VISIT_TYPE
 from thunder.core.transforms import visitor_transform
 from thunder.distributed import FSDPBucketingStrategy
 from thunder.distributed import FSDPType
 from thunder.distributed import get_extract_bucket_name_from_tensor_proxy
+from thunder.distributed import get_skip_data_parallel_grad_sync
 from thunder.distributed.bucketing import FSDPBackwardBucket
 from thunder.distributed.bucketing import FSDPForwardBucket
 from thunder.distributed import prims as dist_prims
 from thunder.executors.torchex import all_gather_prim_impl
 from thunder.executors.torchex import pack_prim_impl
 from thunder.executors.torchex import pack_for_fsdp_prim_impl
 from thunder.executors.torchex import reduce_scatter_prim_impl
 from thunder.executors.torchex import unpack_prim_impl
 from thunder.executors.torchex import unpack_for_fsdp_prim_impl
 from thunder.executors.torchex import wait_prim_impl
 
 if TYPE_CHECKING:
+    from collections.abc import Callable
     from thunder import CompileData
-    from thunder.core.trace import TraceCtx
     from thunder.distributed.bucketing import Bucket
 
 
 __all__ = [
     "FSDPCommBucketing",
 ]
 
@@ -111,14 +113,82 @@
         map_from_sharded_to_unsharded[s] = u
     if return_proxy_lists:
         return map_from_sharded_to_unsharded, (params_before_comm, params_after_comm)
     else:
         return map_from_sharded_to_unsharded
 
 
+def stash_unsharded_grads_and_return_none_as_grads(
+    fsdp_bwd_trace: TraceCtx,
+    compile_data: CompileData,
+    index_to_fqn: dict[int, str],
+) -> TraceCtx:
+    """Set or accumulate unsharded grads to ``param._thunder_fsdp_unsharded_grad``
+
+    This function removes :func:`~thunder.distributed.prims.reduce_scatter`s and following :func:`~thunder.distributed.prims.wait`
+    and inserts :func:`~thunder.distributed.prims.stash_grad_for_fsdp` so that the unsharded gradients are stored and accumulated
+    when :class:`~thunder.ThunderModule` is called in the context of :func:`~thunder.ThunderModule.no_sync`.
+
+    Args:
+        fsdp_bwd_trace:
+        compile_data:
+        index_to_fqn: A dictionary from index to :class:`~torch.nn.Module`'s :class:`~torch.nn.Parameter`'s name given by :func:`~torch.nn.Module.named_parameters`.
+
+    Returns:
+        - TraceCtx
+
+    """
+    producers, consumers = utils.producers_and_consumers(fsdp_bwd_trace)
+    bsyms_of_unsharded_grad_to_index_and_fqn_of_param: dict[BoundSymbol, tuple[int, str]] = {}
+    bsyms_to_skip: dict[BoundSymbol, BoundSymbol] = {}
+
+    flat_outputs, output_spec = tree_flatten(fsdp_bwd_trace.output)
+    for index, output_proxy in enumerate(flat_outputs):
+        if isinstance(output_proxy, TensorProxy):
+            reduce_scatter_bsym = get_bsym_of_reduce_scatter(output_proxy, producers)
+            preaverage_bsym: BoundSymbol = producers[reduce_scatter_bsym.flat_proxy_args[0]]
+            prod_of_unsharded_grad = producers[preaverage_bsym.flat_proxy_args[0]]
+            utils.check(
+                preaverage_bsym.sym.id in {PrimIDs.DIV, "torch.true_divide"},
+                lambda: f"expected to be either of {(PrimIDs.DIV, 'torch.true_divide')} but {preaverage_bsym.sym.id=} for {output_proxy=}",
+            )
+            wait_bsym = consumers[reduce_scatter_bsym.flat_proxy_outs[0]][0]
+
+            bsyms_to_skip[reduce_scatter_bsym] = reduce_scatter_bsym
+            bsyms_to_skip[preaverage_bsym] = preaverage_bsym
+            bsyms_to_skip[wait_bsym] = wait_bsym
+
+            param_fqn = index_to_fqn[index]
+            bsyms_of_unsharded_grad_to_index_and_fqn_of_param[prod_of_unsharded_grad] = (index, param_fqn)
+
+    index_to_new_grad = {}
+
+    def visit(bsym: BoundSymbol) -> VISIT_TYPE:
+        if bsym in bsyms_to_skip:
+            return VISIT_TYPE.REPLACE
+        elif bsym in bsyms_of_unsharded_grad_to_index_and_fqn_of_param:
+            unsharded_grad = bsym.flat_proxy_outs[0]
+            index, param_fqn = bsyms_of_unsharded_grad_to_index_and_fqn_of_param[bsym]
+            stashed_grad = dist_prims.stash_grad_for_fsdp(unsharded_grad, param_fqn, compile_data)
+            index_to_new_grad[index] = stashed_grad
+            return VISIT_TYPE.INSERT_AFTER
+        elif bsym.sym.id == prims.PrimIDs.RETURN:
+            new_return_args = [index_to_new_grad.get(i, g) for i, g in enumerate(flat_outputs)]
+            prims.python_return(tree_unflatten(new_return_args, output_spec))
+            return VISIT_TYPE.REPLACE
+        else:
+            return VISIT_TYPE.NO_OP
+
+    return visitor_transform(
+        fsdp_bwd_trace,
+        visit,
+        provenance="Remove grad sync of fsdp",
+    )
+
+
 @dataclass
 class FSDPCommBucketingTransformVisitor:
     group: ProcessGroup
     original_params: Sequence[TensorProxy]
     param_to_bucket: utils.ProxyDict
     param_to_unsharded: utils.ProxyDict
     comm_to_bucket: dist_prims.PrimIDs
@@ -377,14 +447,15 @@
     ``AllGather``s are also updated if ``sharding_strategy`` is ``FSDPType.ZERO3``.
 
     """
 
     def __init__(
         self,
         compile_data: CompileData,
+        computation_trc: TraceCtx | Callable,
     ) -> None:
         self.compile_data = compile_data
         utils.check(
             hasattr(compile_data.fn, "process_group_for_ddp")
             and hasattr(compile_data.fn, "bucketing_strategy")
             and hasattr(compile_data.fn, "sharding_strategy"),
             lambda: f"Given module does not seem to have all the attributes of `process_group_for_ddp`, `bucketing_strategy`, and `sharding_strategy`, {hasattr(compile_data.fn, 'bucketing_strategy')=}, {hasattr(compile_data.fn, 'sharding_strategy')=}",
@@ -392,14 +463,47 @@
         self.bucketing_strategy: FSDPBucketingStrategy = compile_data.fn.bucketing_strategy
         self.apply_bucketing = self.bucketing_strategy != FSDPBucketingStrategy.NONE
         self.bucket_naming_func = get_extract_bucket_name_from_tensor_proxy(self.bucketing_strategy)
         self.group: ProcessGroup = compile_data.fn.process_group_for_ddp
 
         self.requires_bwd_bucketing_allgather = compile_data.fn.sharding_strategy == FSDPType.ZERO3
 
+        # Information for no_sync transform: `index_to_fqn`.
+        self.computation_trc = computation_trc
+        if not isinstance(self.computation_trc, TraceCtx):
+            import warnings
+
+            warnings.warn("`computation_trc` is not `TraceCtx`")
+            self.computation_trc_flat_args = []
+            self.computation_trc_flat_args_spec = None
+            self.index_to_fqn: dict[int, str] = {}
+        else:
+            self.computation_trc_flat_args, self._computation_trc_flat_args_spec = tree_flatten(
+                (self.computation_trc.args, self.computation_trc.kwargs)
+            )
+            rev_fqn_to_proxy_name: dict[str, str] = {}
+            fqn: str
+            for fqn, _ in compile_data.fn.named_parameters():
+                proxy_name = fqn.replace(".", "_")
+                rev_fqn_to_proxy_name[proxy_name] = fqn
+
+            index_to_fqn: dict[int, str] = {}
+            for index, proxy in enumerate(self.computation_trc_flat_args):
+                if not isinstance(proxy, TensorProxy):
+                    continue
+                proxy_name = proxy.name
+                fqn: str
+                if proxy_name in rev_fqn_to_proxy_name:
+                    index_to_fqn[index] = rev_fqn_to_proxy_name[proxy_name]
+                elif proxy_name.startswith("t_"):
+                    tmp_name = proxy_name[2:]
+                    if tmp_name in rev_fqn_to_proxy_name:
+                        index_to_fqn[index] = rev_fqn_to_proxy_name[tmp_name]
+            self.index_to_fqn = index_to_fqn
+
     def update_name_set(self, backward_trace: TraceCtx) -> TraceCtx:
         if not self.apply_bucketing:
             return
         utils.check(
             hasattr(self, "fsdp_fwd_trace"),
             lambda: "This method must be called after :func:`FSDPCommsOptimizer.apply_bucketing_to_forward_trace`",
         )
@@ -517,14 +621,16 @@
         )
 
         bwd_trace = visitor_transform(fsdp_bwd_trace, visitor, provenance="Merge Collective Comms")
         check_num_comm_and_wait(bwd_trace, _ALL_GATHER_SYM_IDS | _REDUCE_SCATTER_SYM_IDS)
         return bwd_trace
 
     def _apply_bucketing_to_backward_all_gather(self, fsdp_bwd_trace: TraceCtx) -> TraceCtx:
+        if not self.apply_bucketing:
+            return fsdp_bwd_trace
         fwd_trace_flat_args = self._collect_sharded_parameters(self.fsdp_fwd_trace)
         arg_to_index_in_flat_args = utils.ProxyDict()
         for i, a in enumerate(fwd_trace_flat_args):
             if isinstance(a, TensorProxy):
                 arg_to_index_in_flat_args[a] = i
 
         target_allgather_bsyms: tuple[BoundSymbol, ...] = tuple(
@@ -617,14 +723,27 @@
             compile_data:
             index_in_flat_args_to_bucket:
 
         Returns:
             - :class:`TraceCtx`
         """
 
+        if get_skip_data_parallel_grad_sync():
+            utils.check(
+                self.index_to_fqn,
+                lambda: f"`computation_trc` passed to the dunder init expected to be a `TraceCtx`",
+            )
+            if self.requires_bwd_bucketing_allgather:
+                fsdp_bwd_trace = self._apply_bucketing_to_backward_all_gather(fsdp_bwd_trace)
+            return stash_unsharded_grads_and_return_none_as_grads(
+                fsdp_bwd_trace,
+                self.compile_data,
+                self.index_to_fqn,
+            )
+
         if not self.apply_bucketing:
             return fsdp_bwd_trace
 
         # Apply bucketing to parameter unsharding (= AllGather)
         if self.requires_bwd_bucketing_allgather:
             fsdp_bwd_trace = self._apply_bucketing_to_backward_all_gather(fsdp_bwd_trace)
```

### Comparing `lightning_thunder-0.2.0.dev20240428/thunder/distributed/utils.py` & `lightning_thunder-0.2.0.dev20240505/thunder/distributed/utils.py`

 * *Files identical despite different names*

### Comparing `lightning_thunder-0.2.0.dev20240428/thunder/examine/__init__.py` & `lightning_thunder-0.2.0.dev20240505/thunder/examine/__init__.py`

 * *Files identical despite different names*

### Comparing `lightning_thunder-0.2.0.dev20240428/thunder/examine/memory_caculation.py` & `lightning_thunder-0.2.0.dev20240505/thunder/examine/memory_caculation.py`

 * *Files identical despite different names*

### Comparing `lightning_thunder-0.2.0.dev20240428/thunder/executors/__init__.py` & `lightning_thunder-0.2.0.dev20240505/thunder/executors/__init__.py`

 * *Files identical despite different names*

### Comparing `lightning_thunder-0.2.0.dev20240428/thunder/executors/apex_entropyex.py` & `lightning_thunder-0.2.0.dev20240505/thunder/executors/apex_entropyex.py`

 * *Files identical despite different names*

### Comparing `lightning_thunder-0.2.0.dev20240428/thunder/executors/cudnn_layernormex.py` & `lightning_thunder-0.2.0.dev20240505/thunder/executors/cudnn_layernormex.py`

 * *Files identical despite different names*

### Comparing `lightning_thunder-0.2.0.dev20240428/thunder/executors/cudnnex.py` & `lightning_thunder-0.2.0.dev20240505/thunder/executors/cudnnex.py`

 * *Files identical despite different names*

### Comparing `lightning_thunder-0.2.0.dev20240428/thunder/executors/data_dependent_partition.py` & `lightning_thunder-0.2.0.dev20240505/thunder/executors/data_dependent_partition.py`

 * *Files identical despite different names*

### Comparing `lightning_thunder-0.2.0.dev20240428/thunder/executors/nvfuserex.py` & `lightning_thunder-0.2.0.dev20240505/thunder/executors/nvfuserex.py`

 * *Files 19% similar despite different names*

```diff
@@ -1,13 +1,13 @@
 import torch
 from looseversion import LooseVersion
 
 from thunder.extend import FusionExecutor
 
-__all__ = ["nvfuser_version", "required_nvfuser_version", "nvfuser_available" "nvfuserex"]
+__all__ = ["nvfuser_version", "required_nvfuser_version", "nvfuser_available", "nvfuserex"]
 
 
 #
 # Functions for detecting nvFuser and its version
 #
 def nvfuser_version() -> LooseVersion | None:
     # Short-circuits if CUDA isn't available
```

### Comparing `lightning_thunder-0.2.0.dev20240428/thunder/executors/nvfuserex_impl.py` & `lightning_thunder-0.2.0.dev20240505/thunder/executors/nvfuserex_impl.py`

 * *Files 2% similar despite different names*

```diff
@@ -2190,7 +2190,75 @@
     rrctrace.bound_symbols = nbsyms
 
     end_time_ns = time.time_ns()
     elapsed_time_ns = end_time_ns - start_time_ns
     elapsed_time_millis = elapsed_time_ns // 1000000
     rrctrace.set_provenance(TraceProvenance(f"Remove redundant casts (took {elapsed_time_millis} milliseconds)"))
     return rrctrace
+
+
+def _linear_check(a: TensorProxy, b: TensorProxy, bias: TensorProxy | None) -> bool:
+    if nv_version < LooseVersion("0.2.3"):
+        return False
+
+    enable_linear: None | bool = get_compile_option("nv_enable_linear", "Enable nvFuser matmul.")
+    if not enable_linear:
+        return False
+    # Verify linear inputs and bias (optional) are supported tensors.
+    if not are_supported_tensors(a, b):
+        return False
+    if bias is not None and not is_supported_tensor(bias):
+        return False
+
+    # nvFuser only supports 2D inputs in v0.2.3.
+    if not a.ndim == 2:
+        return False
+    return True
+
+
+def linear(
+    a: TensorProxy,
+    b: TensorProxy,
+    bias: TensorProxy | None,
+    *,
+    fd: FusionDefinition,
+    lc_to_nv_map: dict,
+) -> Any:
+    nva = getnv(a, fd, lc_to_nv_map)
+    nvb = getnv(b, fd, lc_to_nv_map)
+    nvbias = None if bias is None else getnv(bias, fd, lc_to_nv_map)
+    return fd.ops.linear(nva, nvb, nvbias)
+
+
+register_supported(PrimIDs.LINEAR, linear, _linear_check)
+
+
+def _matmul_check(
+    a: TensorProxy,
+    b: TensorProxy,
+) -> bool:
+    if nv_version < LooseVersion("0.2.2"):
+        return False
+
+    enable_matmul: None | bool = get_compile_option("nv_enable_matmul", "Enable nvFuser matmul.")
+    if not enable_matmul:
+        return False
+    if not are_supported_tensors(a, b):
+        return False
+    if not (a.ndim == b.ndim and a.ndim == 2):
+        return False
+    return True
+
+
+def matmul(
+    a: TensorProxy,
+    b: TensorProxy,
+    *,
+    fd: FusionDefinition,
+    lc_to_nv_map: dict,
+) -> Any:
+    nva = getnv(a, fd, lc_to_nv_map)
+    nvb = getnv(b, fd, lc_to_nv_map)
+    return fd.ops.matmul(nva, nvb)
+
+
+register_supported(PrimIDs.MATMUL, matmul, _matmul_check)
```

### Comparing `lightning_thunder-0.2.0.dev20240428/thunder/executors/passes.py` & `lightning_thunder-0.2.0.dev20240505/thunder/executors/passes.py`

 * *Files identical despite different names*

### Comparing `lightning_thunder-0.2.0.dev20240428/thunder/executors/pythonex.py` & `lightning_thunder-0.2.0.dev20240505/thunder/executors/pythonex.py`

 * *Files identical despite different names*

### Comparing `lightning_thunder-0.2.0.dev20240428/thunder/executors/sdpaex.py` & `lightning_thunder-0.2.0.dev20240505/thunder/executors/sdpaex.py`

 * *Files identical despite different names*

### Comparing `lightning_thunder-0.2.0.dev20240428/thunder/executors/torch_autograd.py` & `lightning_thunder-0.2.0.dev20240505/thunder/executors/torch_autograd.py`

 * *Files 3% similar despite different names*

```diff
@@ -16,16 +16,19 @@
 from thunder.core.symbol import BoundSymbol, BoundSymbolRHS, Symbol
 from thunder.core.trace import TraceCtx
 from thunder.core.transform_common import replace_redundant_inputs
 
 
 class ThunderFunction(torch.autograd.Function):
     @staticmethod
-    def forward(ctx, compiled_backward, saved_tensors, saved_other, flat_output, *flat_args):
+    def forward(
+        ctx, return_none_instead_of_grads, compiled_backward, saved_tensors, saved_other, flat_output, *flat_args
+    ):
         # Here we just propagate the tensors through the autograd graph
+        ctx.return_none_instead_of_grads = return_none_instead_of_grads
         ctx.saved_other = saved_other
         ctx.compiled_backward = compiled_backward
 
         # We must save tensors using ctx.save_for_backward
         ctx.save_for_backward(*saved_tensors)
         return flat_output
 
@@ -48,15 +51,19 @@
         # This is an undocumented API, but it's the only way to clear the
         # reference to the saved tensors in the context
         ctx.maybe_clear_saved_tensors()  # Delete the reference to all saved tensors in the context
         grads = ctx.compiled_backward([saved_tensors_list, ctx.saved_other], args)
 
         # Inside the compiled backward we must clear the saved_tensors_list
         assert not saved_tensors_list, "saved_tensors_list must be empty after calling compiled_backward"
-        return (None, None, None, None, *grads)
+        # TODO(crcrpar): Remove if-else once `dist_prims.stash_grad_for_fsdp` starts to return `None`
+        # NOTE(crcrpar): In fsdp no-sync, unsharded gradients are attached and accumulated to their parameters as the attr of `_thunder_fsdp_unsharded_grad` in order to avoid shape mismatch of a param and its grad. When exiting the no_sync context, the accumulated, unsharded gradients are reduce-scattered into the attr of `grad` and `_thunder_fsdp_unsharded_grad` is removed.
+        if ctx.return_none_instead_of_grads:
+            return (None, None, None, None, None, *([None] * len(grads)))
+        return (None, None, None, None, None, *grads)
 
 
 def split_forward_backward(computation_trc: TraceCtx, compile_data, compile_stats, /, *flat_args):
     from thunder.core.rematerialization import rematerialize_all_gather, rematerialize_forward_and_backward
     from thunder.core.transforms import forward_and_backward_from_trace
     from thunder.distributed.transforms import FSDPCommBucketing
     from thunder.distributed.utils import sort_data_parallel_syncs, sort_waits, sort_waits_for_zero3
@@ -105,15 +112,15 @@
     )
 
     # autograd.Function.backward expects a flat tuple of gradients
     bw_trace.bound_symbols[-1] = replace(bw_trace.bound_symbols[-1], args=(filtered_grads,))
 
     _fsdp_comm_bucketing: FSDPCommBucketing | None = None
     if getattr(compile_data.fn, "use_fsdp", False):
-        _fsdp_comm_bucketing = FSDPCommBucketing(compile_data)
+        _fsdp_comm_bucketing = FSDPCommBucketing(compile_data, computation_trc)
         fw_trace = _fsdp_comm_bucketing.apply_bucketing_to_forward_trace(fw_trace, bw_trace.names)
         _fsdp_comm_bucketing.update_name_set(bw_trace)
 
     # Now we can run the optimization passes on the forward trace
     # TODO Restore request for no rematerialization
     fw_extrace = transform_for_execution(
         fw_trace,
```

### Comparing `lightning_thunder-0.2.0.dev20240428/thunder/executors/torch_compile.py` & `lightning_thunder-0.2.0.dev20240505/thunder/executors/torch_compile.py`

 * *Files 10% similar despite different names*

```diff
@@ -4,19 +4,21 @@
 from typing import Any
 
 import torch
 from lightning_utilities import compare_version
 
 from thunder.core import prims, utils
 from thunder.core.proxies import Proxy, unvariableify, Variable
+from thunder.core.rematerialization import rematerialize
 from thunder.core.symbol import BoundSymbol, Symbol
 from thunder.core.trace import from_trace, TraceCtx, TraceProvenance
-
+from thunder.core.transform_common import dce
+from thunder.executors.passes import update_fusion_call_ctx
 from thunder.executors.utils import Region
-from thunder.extend import FusionExecutor, register_executor
+from thunder.extend import FusionExecutor, register_executor, ImplInfo
 
 _TORCH_GREATER_EQUAL_2_3 = compare_version("torch", operator.ge, "2.3.0", use_base_version=True)
 
 
 def to_torch_translator(bsym: BoundSymbol) -> Callable:
     """Translates a BoundSymbol to a corresponding traceable by Thunder and
     executable by PyTorch callable.
@@ -105,16 +107,17 @@
             if orig is not None:
                 torch._dynamo.eval_frame.guarded_backend_cache.skip_backend_check_for_run_only_mode = orig
 
     return compiled_func_wrapper
 
 
 class TorchCompileExecutor(FusionExecutor):
-    def __init__(self):
-        super().__init__("torchcompile", version=torch.__version__)
+    def __init__(self, name: Hashable, required_ops: set | None = None):
+        super().__init__(name, version=torch.__version__)
+        self.required_ops = required_ops
 
     def fuse(self, region: Region, fusion_counter: int) -> BoundSymbol:
         def keyfn(x: Variable) -> str:
             return x.proxy.name
 
         sorted_unique_inputs: list[Proxy] = list(unvariableify(x) for x in sorted(region.inputs, key=keyfn))
         sorted_unique_outputs: list[Proxy] = list(unvariableify(x) for x in sorted(region.outputs, key=keyfn))
@@ -136,83 +139,90 @@
         start_time_ns: int = time.time_ns()
 
         fusedtrace: TraceCtx = from_trace(trace)
 
         producers, consumers = utils.producers_and_consumers(trace)
         from thunder.executors.data_dependent_partition import fuse_bound_symbols, Node
 
-        fused_bsyms = []
-
-        # NOTE: Currently the goal is to fuse rotary positional embeddings
-        required_ops = {
-            "torch.cat",
-            prims.cat.id,
-            prims.pad.id,
-            prims.slice_prim.id,
-        }
-
         def _should_fuse(a: Node, b: Node):
             def _can_fuse_node(n: Node):
                 if len(n.group_bsyms) > 1:
                     return True
                 bsym: BoundSymbol = n.group_bsyms[0]
                 return self.can_fuse(bsym)
 
             return _can_fuse_node(a) and _can_fuse_node(b)
 
         bound_symbol_groups = fuse_bound_symbols(trace, _should_fuse)
 
+        fused_bsyms = []
         # Counts how many fusions (per executor) have been constructed
         fusion_counter: int = 0
         for bsyms in bound_symbol_groups:
             if len(bsyms) == 1:
                 bsym: BoundSymbol = bsyms[0]
                 if not self.can_fuse(bsym):
                     fused_bsyms.append(bsym)
                     continue
 
-            include_required_ops = any(bsym.sym.id in required_ops for bsym in bsyms)
-            if include_required_ops:
+            # TODO: this could use `get_fuel()` like nvfuserex does
+            if self.required_ops is None or any(bsym.sym.id in self.required_ops for bsym in bsyms):
                 region = Region(producers, consumers, bsyms)
                 fusion_bsym: BoundSymbol = self.fuse(region, fusion_counter)
                 fusion_counter += 1
                 fused_bsyms.append(fusion_bsym)
             else:
                 fused_bsyms.extend(bsyms)
 
         fusedtrace.bound_symbols = fused_bsyms
 
+        fusedtrace = rematerialize(fusedtrace)
+        fusedtrace = dce(fusedtrace)
+        fusedtrace = update_fusion_call_ctx(fusedtrace)
+
         end_time_ns: int = time.time_ns()
         elapsed_time_ns: int = end_time_ns - start_time_ns
         elapsed_time_millis: int = elapsed_time_ns // 1000000
         fusedtrace.set_provenance(TraceProvenance(f"Fusion (took {elapsed_time_millis} milliseconds)"))
 
         return fusedtrace
 
 
-torch_compile_executor = TorchCompileExecutor()
-register_executor(torch_compile_executor)
-
-
-def register_supported(_id: Hashable):
-    torch_compile_executor.register_supported(_id, checker=None)
+from thunder.executors.torchex import ex as pytorch_ex
 
 
-# This is an initial list to support rotary positional embeddings
+# NOTE: [torch_compile_cat_ex vs torch_compile_ex]
+# The former only relies on `torch.compile` for the operators where it shines the most and is meant to be used
+# together with the nvfuser executor. Its current goal is only to fuse RoPE but the set of ops fused will change as each
+# of the fusion backends evolve.
+# The latter will try to `torch.compile` all the torch operators and is meant to be used without the nvfuser_executor
+# since they would be competing over fusion opportunities. The advantage over simply doing `torch.compile` is that you
+# still get all of Thunder's advantages, like enabling custom executors (e.g. with custom triton kernels) before it.
+required_ops = {
+    "torch.cat",
+    prims.cat.id,
+    prims.pad.id,
+    prims.slice_prim.id,
+}
+torch_compile_cat_ex = TorchCompileExecutor(name="torchcompile_cat", required_ops=required_ops)
+register_executor(torch_compile_cat_ex)
 # TODO: Carefully enable more ops checking that they do improve performance
 supported_ops = {
     "torch.split",
-    prims.add,
-    prims.broadcast_in_dim,
-    prims.cat,
-    prims.convert_element_type,
-    prims.full,
-    prims.mul,
-    prims.neg,
-    prims.pad,
-    prims.reshape,
-    prims.slice_prim,
-    prims.transpose,
+    prims.add.id,
+    prims.broadcast_in_dim.id,
+    prims.cat.id,
+    prims.convert_element_type.id,
+    prims.full.id,
+    prims.mul.id,
+    prims.neg.id,
+    prims.pad.id,
+    prims.reshape.id,
+    prims.slice_prim.id,
+    prims.transpose.id,
 }
+torch_compile_cat_ex._implmap = {op: ImplInfo() for op in pytorch_ex.implmap if op in supported_ops}
+
 
-for op in supported_ops:
-    register_supported(op)
+torch_compile_ex = TorchCompileExecutor(name="torchcompile")
+register_executor(torch_compile_ex)
+torch_compile_ex._implmap = {op: ImplInfo() for op in pytorch_ex.implmap}
```

### Comparing `lightning_thunder-0.2.0.dev20240428/thunder/executors/torchex.py` & `lightning_thunder-0.2.0.dev20240505/thunder/executors/torchex.py`

 * *Files 1% similar despite different names*

```diff
@@ -1,16 +1,17 @@
+from __future__ import annotations
 import operator
 import importlib
 from dataclasses import replace
 from contextlib import ContextDecorator
 from functools import wraps, partial
 from inspect import signature
 from itertools import groupby
 from numbers import Number
-from typing import Union, Any, Tuple, Optional
+from typing import TYPE_CHECKING
 from collections.abc import Callable
 from collections.abc import Hashable, Sequence
 from collections.abc import Sequence
 from types import ModuleType
 from enum import Enum, auto
 
 import torch
@@ -38,14 +39,17 @@
 from thunder.extend import OperatorExecutor, register_executor, add_always_executor
 
 from thunder.core.transforms import (
     get_grad,
     put_grad,
 )
 
+if TYPE_CHECKING:
+    from thunder.common import CompileData
+
 ex = OperatorExecutor("torch", version=torch.__version__)
 register_executor(ex)
 add_always_executor(ex)
 
 # Common annotations
 TensorLike = TensorProxy
 FutureTensorLike = FutureTensorProxy
@@ -1888,14 +1892,29 @@
     ) -> torch.Tensor:
         if bucket_key not in _key_to_bucket_and_views:
             return tensor
         _, views = _key_to_bucket_and_views[bucket_key]
         views[index_of_dst_view].copy_(tensor)
         return tensor
 
+    # TODO(crcrpar): Update to return None instead
+    def _stash_grad_for_fsdp_prim_impl(
+        grad: torch.Tensor,
+        param_fqn: str,
+        compile_data: CompileData,
+    ) -> None:
+        grad_name = "_thunder_fsdp_unsharded_grad"
+        param = compile_data.fn.get_parameter(param_fqn)
+        if torch.is_tensor(unsharded_grad := getattr(param, grad_name, None)):
+            unsharded_grad += grad
+        else:
+            setattr(param, grad_name, grad)
+
+        return grad
+
     all_gather_prim_impl = ex.register_operator(
         "torch_all_gather_prim_impl", meta=dist_prims.all_gather.meta, fn=_all_gather_prim_impl
     )
     _register_implementation(dist_prims.all_gather, all_gather_prim_impl, checker=_always_executable)
     all_reduce_prim_impl = ex.register_operator(
         "torch_all_reduce_prim_impl", meta=dist_prims.all_reduce.meta, fn=_all_reduce_prim_impl
     )
@@ -1932,14 +1951,25 @@
     )
     _register_implementation(
         dist_prims.pack_for_fsdp,
         pack_for_fsdp_prim_impl,
         checker=_always_executable,
     )
 
+    stash_grad_for_fsdp_prim_impl = ex.register_operator(
+        "torch_stash_grad_for_fsdp_prim_impl",
+        meta=dist_prims.stash_grad_for_fsdp.meta,
+        fn=_stash_grad_for_fsdp_prim_impl,
+    )
+    _register_implementation(
+        dist_prims.stash_grad_for_fsdp,
+        stash_grad_for_fsdp_prim_impl,
+        checker=_always_executable,
+    )
+
 # Memory access operations
 item = _register_torch_operation("item", module=torch.Tensor)
 _register_implementation(prims.item, item, checker=_always_executable)
 
 
 has_einops = importlib.util.find_spec("einops") is not None
 if has_einops:
```

### Comparing `lightning_thunder-0.2.0.dev20240428/thunder/executors/transformer_engineex.py` & `lightning_thunder-0.2.0.dev20240505/thunder/executors/transformer_engineex.py`

 * *Files identical despite different names*

### Comparing `lightning_thunder-0.2.0.dev20240428/thunder/executors/triton_crossentropy_impl.py` & `lightning_thunder-0.2.0.dev20240505/thunder/executors/triton_crossentropy_impl.py`

 * *Files identical despite different names*

### Comparing `lightning_thunder-0.2.0.dev20240428/thunder/executors/utils.py` & `lightning_thunder-0.2.0.dev20240505/thunder/executors/utils.py`

 * *Files identical despite different names*

### Comparing `lightning_thunder-0.2.0.dev20240428/thunder/extend/__init__.py` & `lightning_thunder-0.2.0.dev20240505/thunder/extend/__init__.py`

 * *Files 1% similar despite different names*

```diff
@@ -136,17 +136,14 @@
 
 class FUEL_LEVEL(enum.Enum):
     UNLIMITED = enum.auto()
 
 
 # To implement a FusionExecutor, create a subclass of it that implements the fusion_pass method
 class FusionExecutor(Executor):
-    def __init__(self, name: Hashable, *, version: None | Any = None):
-        super().__init__(name, version=version)
-
     # Optimization fuel is a concept introduced by David B.
     # Whalley (https://dl.acm.org/doi/pdf/10.1145/186025.186103) to isolate
     # compiler bugs.
     #
     # A FusionExecutor keeps track of its own optimization fuel as the number
     # of remaining optimizations it can do. Each fusion pass can call
     # `get_fuel` to acquire a certain amount of optimization fuel, and, only if
```

### Comparing `lightning_thunder-0.2.0.dev20240428/thunder/functional.py` & `lightning_thunder-0.2.0.dev20240505/thunder/functional.py`

 * *Files identical despite different names*

### Comparing `lightning_thunder-0.2.0.dev20240428/thunder/numpy/__init__.py` & `lightning_thunder-0.2.0.dev20240505/thunder/numpy/__init__.py`

 * *Files identical despite different names*

### Comparing `lightning_thunder-0.2.0.dev20240428/thunder/numpy/langctx.py` & `lightning_thunder-0.2.0.dev20240505/thunder/numpy/langctx.py`

 * *Files identical despite different names*

### Comparing `lightning_thunder-0.2.0.dev20240428/thunder/torch/__init__.py` & `lightning_thunder-0.2.0.dev20240505/thunder/torch/__init__.py`

 * *Files identical despite different names*

### Comparing `lightning_thunder-0.2.0.dev20240428/thunder/torch/langctx.py` & `lightning_thunder-0.2.0.dev20240505/thunder/torch/langctx.py`

 * *Files identical despite different names*

