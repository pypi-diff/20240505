# Comparing `tmp/msanic-1.0.17-py3-none-any.whl.zip` & `tmp/msanic-1.0.18-py3-none-any.whl.zip`

## zipinfo {}

```diff
@@ -1,44 +1,44 @@
-Zip file size: 56812 bytes, number of entries: 42
+Zip file size: 57061 bytes, number of entries: 42
 -rw-rw-rw-  2.0 fat        0 b- defN 24-Mar-19 13:56 msanic/__init__.py
 -rw-rw-rw-  2.0 fat     3462 b- defN 24-Apr-15 07:17 msanic/base_blue.py
 -rw-rw-rw-  2.0 fat     8536 b- defN 24-Mar-28 08:50 msanic/base_conf.py
 -rw-rw-rw-  2.0 fat     3241 b- defN 24-Mar-25 14:10 msanic/base_server.py
--rw-rw-rw-  2.0 fat     9187 b- defN 24-Apr-28 09:19 msanic/base_ws.py
+-rw-rw-rw-  2.0 fat     9749 b- defN 24-May-05 02:25 msanic/base_ws.py
 -rw-rw-rw-  2.0 fat     2908 b- defN 24-Apr-28 08:44 msanic/exception.py
 -rw-rw-rw-  2.0 fat     7677 b- defN 24-Apr-15 07:12 msanic/handler_http.py
--rw-rw-rw-  2.0 fat     3115 b- defN 24-Apr-28 08:44 msanic/handler_ws.py
+-rw-rw-rw-  2.0 fat     2724 b- defN 24-May-04 17:16 msanic/handler_ws.py
 -rw-rw-rw-  2.0 fat      576 b- defN 24-Apr-12 02:20 msanic/middleware.py
--rw-rw-rw-  2.0 fat    10187 b- defN 24-Apr-15 07:18 msanic/mult_creator.py
+-rw-rw-rw-  2.0 fat    10352 b- defN 24-May-05 02:34 msanic/mult_creator.py
 -rw-rw-rw-  2.0 fat     8531 b- defN 24-Mar-21 14:40 msanic/verify.py
 -rw-rw-rw-  2.0 fat        0 b- defN 24-Mar-19 13:56 msanic/libs/__init__.py
 -rw-rw-rw-  2.0 fat     7656 b- defN 24-Mar-21 14:40 msanic/libs/base_timed.py
 -rw-rw-rw-  2.0 fat     1276 b- defN 24-Apr-12 09:22 msanic/libs/component.py
 -rw-rw-rw-  2.0 fat     3151 b- defN 24-Apr-28 08:45 msanic/libs/consts.py
 -rw-rw-rw-  2.0 fat     1578 b- defN 24-Mar-21 14:40 msanic/libs/crypto.py
 -rw-rw-rw-  2.0 fat     3171 b- defN 24-Mar-21 14:40 msanic/libs/decorator.py
 -rw-rw-rw-  2.0 fat     1125 b- defN 24-Mar-21 14:40 msanic/libs/file_type.py
--rw-rw-rw-  2.0 fat     1735 b- defN 24-Mar-25 14:04 msanic/libs/manager.py
+-rw-rw-rw-  2.0 fat     1765 b- defN 24-May-05 02:07 msanic/libs/manager.py
 -rw-rw-rw-  2.0 fat     2495 b- defN 24-Mar-21 14:40 msanic/libs/mult_log.py
 -rw-rw-rw-  2.0 fat     5263 b- defN 24-Mar-21 14:40 msanic/libs/random_maker.py
 -rw-rw-rw-  2.0 fat     8453 b- defN 24-Apr-15 07:12 msanic/libs/rds_client.py
 -rw-rw-rw-  2.0 fat     1116 b- defN 24-Apr-03 08:13 msanic/libs/rds_locker.py
 -rw-rw-rw-  2.0 fat     6985 b- defN 24-Apr-28 09:19 msanic/libs/tool.py
 -rw-rw-rw-  2.0 fat     5014 b- defN 24-Mar-25 15:32 msanic/libs/tool_dt.py
 -rw-rw-rw-  2.0 fat     3070 b- defN 24-Mar-21 14:40 msanic/libs/tool_jwt.py
--rw-rw-rw-  2.0 fat     1871 b- defN 24-Apr-28 09:19 msanic/libs/tool_ws.py
+-rw-rw-rw-  2.0 fat     2031 b- defN 24-May-04 15:37 msanic/libs/tool_ws.py
 -rw-rw-rw-  2.0 fat        0 b- defN 24-Mar-20 12:48 msanic/orm/__init__.py
 -rw-rw-rw-  2.0 fat      730 b- defN 24-Mar-19 13:56 msanic/orm/db_index.py
 -rw-rw-rw-  2.0 fat    18726 b- defN 24-Apr-28 08:44 msanic/orm/db_model.py
 -rw-rw-rw-  2.0 fat    11698 b- defN 24-Apr-03 07:45 msanic/orm/mssql_generator.py
 -rw-rw-rw-  2.0 fat    11743 b- defN 24-Apr-28 08:44 msanic/orm/mysql_generator.py
 -rw-rw-rw-  2.0 fat    11720 b- defN 24-Apr-03 07:45 msanic/orm/pgsql_generator.py
 -rw-rw-rw-  2.0 fat     5098 b- defN 24-Apr-12 02:19 msanic/orm/rc_model.py
 -rw-rw-rw-  2.0 fat        0 b- defN 24-Mar-19 13:56 test/__init__.py
--rw-rw-rw-  2.0 fat      715 b- defN 24-Mar-25 15:29 test/test_unit.py
--rw-rw-rw-  2.0 fat     1090 b- defN 24-Apr-28 09:19 msanic-1.0.17.dist-info/LICENSE
--rw-rw-rw-  2.0 fat      878 b- defN 24-Apr-28 09:19 msanic-1.0.17.dist-info/METADATA
--rw-rw-rw-  2.0 fat       92 b- defN 24-Apr-28 09:19 msanic-1.0.17.dist-info/WHEEL
--rw-rw-rw-  2.0 fat       52 b- defN 24-Apr-28 09:19 msanic-1.0.17.dist-info/entry_points.txt
--rw-rw-rw-  2.0 fat       12 b- defN 24-Apr-28 09:19 msanic-1.0.17.dist-info/top_level.txt
--rw-rw-r--  2.0 fat     3313 b- defN 24-Apr-28 09:19 msanic-1.0.17.dist-info/RECORD
-42 files, 177246 bytes uncompressed, 51618 bytes compressed:  70.9%
+-rw-rw-rw-  2.0 fat      701 b- defN 24-May-04 15:15 test/test_unit.py
+-rw-rw-rw-  2.0 fat     1090 b- defN 24-May-05 02:34 msanic-1.0.18.dist-info/LICENSE
+-rw-rw-rw-  2.0 fat      878 b- defN 24-May-05 02:34 msanic-1.0.18.dist-info/METADATA
+-rw-rw-rw-  2.0 fat       92 b- defN 24-May-05 02:34 msanic-1.0.18.dist-info/WHEEL
+-rw-rw-rw-  2.0 fat       52 b- defN 24-May-05 02:34 msanic-1.0.18.dist-info/entry_points.txt
+-rw-rw-rw-  2.0 fat       12 b- defN 24-May-05 02:34 msanic-1.0.18.dist-info/top_level.txt
+-rw-rw-r--  2.0 fat     3313 b- defN 24-May-05 02:34 msanic-1.0.18.dist-info/RECORD
+42 files, 177758 bytes uncompressed, 51867 bytes compressed:  70.8%
```

## zipnote {}

```diff
@@ -102,26 +102,26 @@
 
 Filename: test/__init__.py
 Comment: 
 
 Filename: test/test_unit.py
 Comment: 
 
-Filename: msanic-1.0.17.dist-info/LICENSE
+Filename: msanic-1.0.18.dist-info/LICENSE
 Comment: 
 
-Filename: msanic-1.0.17.dist-info/METADATA
+Filename: msanic-1.0.18.dist-info/METADATA
 Comment: 
 
-Filename: msanic-1.0.17.dist-info/WHEEL
+Filename: msanic-1.0.18.dist-info/WHEEL
 Comment: 
 
-Filename: msanic-1.0.17.dist-info/entry_points.txt
+Filename: msanic-1.0.18.dist-info/entry_points.txt
 Comment: 
 
-Filename: msanic-1.0.17.dist-info/top_level.txt
+Filename: msanic-1.0.18.dist-info/top_level.txt
 Comment: 
 
-Filename: msanic-1.0.17.dist-info/RECORD
+Filename: msanic-1.0.18.dist-info/RECORD
 Comment: 
 
 Zip file comment:
```

## msanic/base_ws.py

```diff
@@ -1,26 +1,27 @@
 import asyncio
 import os
 import traceback
 from typing import Union
 
 from sanic import Request
 from sanic.exceptions import WebsocketClosed
+from sanic.server.protocols.websocket_protocol import WebSocketProtocol
 
 from msanic.libs.component import ConfDI
 from msanic.base_conf import BaseConf
-from msanic.libs import tool, tool_ws
+from msanic.libs import tool, tool_ws, tool_dt
 from msanic.libs.manager import WsConnector
 
 
 class RdsWS(ConfDI):
     CMD_MAP = {}
     '''服务命令映射'''
     conf: BaseConf = None
-    conn_manager: WsConnector = None
+    ws_manager = WsConnector
 
     dft_type: Union[int, str] = 1
     '''系统默认消息类型'''
     beat_code: Union[int, str] = 1
     '''心跳消息标码'''
     reject_code: Union[int, str] = 2
     '''弹回消息标码'''
@@ -90,60 +91,58 @@
         return [c_type, c_code, data, u]
 
     async def listen_msg(self, ws, uinfo):
         while 1:
             c_type, c_code, data, extra = self.fun_parse_msg(await ws.recv(), log_fun=self.log.error)
             if c_type and (c_type == self.dft_type) and (c_code == self.beat_code):
                 await ws.send(self.fun_pack_msg(
-                    self.dft_type, self.beat_code, data=data, sta_code=self.conf.STA_CODE.PASS.val, req=extra))
+                    self.dft_type, self.beat_code, data=data, code=self.conf.STA_CODE.PASS, req=extra))
             fun = self.CMD_MAP.get(c_type)
             if fun and callable(fun.funapi):
                 msg_arr = None
                 try:
                     msg_arr = await fun.funapi(c_code, uinfo, data)
                     await ws.send(self.fun_pack_msg(c_type, *msg_arr, req=extra))
                 except WebsocketClosed:
                     msg_arr and await self.__save_as_history(uinfo, self.fun_pack_msg(c_type, *msg_arr, req=extra))
                     return await self.on_offline(uinfo)
                 except Exception as err:
                     msg_arr and await self.__save_as_history(uinfo, self.fun_pack_msg(c_type, *msg_arr, req=extra))
                     self.log.error(f'{err}:{traceback.format_exc()}')
                     await ws.send(self.fun_pack_msg(
-                        c_code, c_type, sta_code=self.conf.STA_CODE.FAIL.val, req=extra, hint='A error cause failed'))
+                        c_type, c_code, code=self.conf.STA_CODE.FAIL, req=extra, hint='A error cause failed'))
             else:
                 await ws.send(self.fun_pack_msg(
-                    self.dft_type, self.reject_code, sta_code=self.conf.STA_CODE.FAIL.vval, hint='Unspecified message'))
+                    self.dft_type, self.reject_code, code=self.conf.STA_CODE.FAIL, hint='Unspecified message'))
 
     async def wsrouter(self, req: Request, ws):
         """Websocket路由服务"""
         uinfo = await self.wsauth(req, ws)
-        await self.check_ws_conn(uinfo, req, ws)
+        if not uinfo:
+            return await ws.close()
+        if not await self.check_ws_conn(uinfo, req, ws):
+            return await ws.close()
         await self.update_status(uinfo)
         await self.__filter_history_msg(ws, uinfo)
         await self.listen_msg(ws, uinfo)
-        # loop = asyncio.get_running_loop()
-        # print('连接完成')
-        # loop.create_task(self.listen_msg(ws, uinfo))
-        # loop.run_forever()
-        # print('连接完成2')
 
     async def __save_as_history(self, uinfo, msg):
         """处理未发送成功的消息"""
         if not isinstance(msg, str):
             msg = tool.json_encode(msg, u_byte=True)
         if msg:
             ukey = self.get_ukey(uinfo)
             key_name = self.history_queue(ukey)
             await self.rds.lqpush(key_name, [msg])
             if await self.rds.qlen(key_name) > self.max_history_queue:
                 _ = await self.rds.rqpop(key_name)
 
     async def __filter_history_msg(self, ws, uinfo):
         ukey = self.get_ukey(uinfo)
-        msg_list = await self.rds.rqpop(self.history_queue(ukey), count=self.max_history_queue)
+        msg_list = await self.rds.qrpop(self.history_queue(ukey), count=self.max_history_queue)
         if not msg_list:
             return
         if isinstance(msg_list, str):
             msg_list = [msg_list]
         for msg in msg_list:
             if msg:
                 try:
@@ -154,58 +153,74 @@
                     break
 
     async def on_receive_channel_msg(self, c_type: Union[int, str], c_code, data, receiver):
         """接收处理指定频道的订阅消息"""
         if not receiver:
             return
         if receiver == -1:
-            for ws in self.conn_manager.all_ws():
+            for ws in self.ws_manager.all_ws():
                 try:
                     ws and (await ws.send(
-                        self.fun_pack_msg(c_type, c_code, data=data, sta_code=self.conf.STA_CODE.PASS.val)))
+                        self.fun_pack_msg(c_type, c_code, data=data, code=self.conf.STA_CODE.PASS)))
                 except Exception as err:
                     self.log.info(f'公共消息推送失败：{err}')
                     pass
             return
-        ws = self.conn_manager.get_ws(receiver)
+        ws = self.ws_manager.get_ws(receiver)
         if not ws:
             return await self.__save_as_history(
-                receiver, self.fun_pack_msg(c_type, c_code, data=data, sta_code=self.conf.STA_CODE.PASS.val))
+                receiver, self.fun_pack_msg(c_type, c_code, data=data, code=self.conf.STA_CODE.PASS))
         try:
-            return await ws.send(self.fun_pack_msg(c_type, c_code,  data=data, sta_code=self.conf.STA_CODE.PASS.val))
+            return await ws.send(self.fun_pack_msg(c_type, c_code,  data=data, code=self.conf.STA_CODE.PASS))
         except Exception as err:
             self.log.info(f'发送目标消息失败,receiver:{receiver},data:{data},错误信息：{err}')
         return await self.__save_as_history(
-            receiver, self.fun_pack_msg(c_type, c_code, data=data, sta_code=self.conf.STA_CODE.PASS.val))
+            receiver, self.fun_pack_msg(c_type, c_code, data=data, code=self.conf.STA_CODE.PASS))
 
     async def on_offline(self, uinfo):
         """用户掉线处理逻辑"""
         ukey = self.get_ukey(uinfo)
         await self.rds.drop_hash(self.conf.WS_ONLINE_INFO, ukey)
-        await self.conn_manager.close_ws(ukey)
+        await self.ws_manager.close_ws(ukey)
 
     async def check_ws_conn(self, uinfo, req, ws):
         timestamp = req.headers.get('Timestamp') or req.args.get('Timestamp')
         if not timestamp:
             await ws.send(self.fun_pack_msg(
-                self.dft_type, self.reject_code, sta_code=self.conf.STA_CODE.FAIL.val, hint='missing params,reject'))
-            return await ws.close()
+                self.dft_type, self.reject_code, code=self.conf.STA_CODE.FAIL, hint='missing params,reject'))
+            return
         ukey = self.get_ukey(uinfo)
+        timestamp = int(timestamp)
+        if timestamp > int(tool_dt.cur_dt().timestamp()):
+            await ws.send(self.fun_pack_msg(
+                self.dft_type, self.reject_code, code=self.conf.STA_CODE.FAIL, hint='error params,reject'))
+            return
         old_info = await self.rds.get_hash(self.conf.WS_ONLINE_INFO, ukey)
         if old_info:
-            old_arr = old_info.split('--')
-            if int(old_arr[1]) >= int(timestamp):
-                await ws.send(self.fun_pack_msg(self.dft_type, self.reject_code, sta_code=self.conf.STA_CODE.FAIL.val,
-                                                hint='invalid connection,reject'))
-                return await ws.close()
+            old_arr = old_info.split(b'--' if isinstance(old_info, bytes) else '--')
+            if int(old_arr[1]) >= timestamp:
+                await ws.send(self.fun_pack_msg(
+                    self.dft_type, self.reject_code, code=self.conf.STA_CODE.FAIL, hint='invalid connection,reject'))
+                return
+        setattr(ws, 'uinfo', ukey)
         await self.rds.set_hash(self.conf.WS_ONLINE_INFO, ukey, f'{self.channel}--{timestamp}')
-        await self.conn_manager.set_ws(ukey, ws)
+        await self.ws_manager.set_ws(ukey, ws)
+        return True
 
     async def update_status(self, uinfo):
         """更新用户监听的频道信息 更新连接状态等相关内容写在这里"""
         pass
 
     async def wsauth(self, req, ws) -> (object, dict, str, int):
         """基础接口认证处理 接入/认证等"""
         print(ws, req)
         raise Exception(f'接口未指定授权，不允许访问,当前监听：{self.channel}')
         pass
+
+
+class WsProtocol(WebSocketProtocol):
+
+    def connection_lost(self, exc):
+        super(WsProtocol, self).connection_lost(exc)
+        if (self.websocket is not None) and hasattr(self.websocket, 'uinfo'):
+            for item in RdsWS.CMD_MAP.values():
+                hasattr(item, 'off_line') and asyncio.run(item.off_line(self.websocket.uinfo))
```

## msanic/handler_ws.py

```diff
@@ -1,7 +1,9 @@
+from typing import Union
+
 from msanic.exception import WsRpsMsg
 from msanic.base_conf import BaseConf
 from msanic.libs.component import ConfDI
 from msanic import verify
 from msanic.libs.consts import Code
 
 
@@ -18,47 +20,42 @@
 
     async def funapi(self, cmd, uinfo, data):
         fun = self.CMD_FUN_MAP.get(cmd)
         if fun:
             try:
                 data = await fun(uinfo, data)
             except WsRpsMsg as msg:
-                return cmd, msg.data, msg.code.val, msg.hint
+                return cmd, msg.data, msg.code, msg.hint
             else:
-                return cmd, data, self.sta_code.FAIL.val, ''
-        return cmd, None, self.conf.STA_CODE.FAIL.val, 'unspecified message.'
+                return cmd, data, self.sta_code.FAIL, ''
+        return cmd, None, self.conf.STA_CODE.FAIL, 'unspecified message.'
+
+    async def off_line(self, ukey: Union[int, str]):
+        """掉线处理逻辑"""
+        pass
 
     def sendmsg(self, code: Code = None, data: dict or list = None, hint='success'):
         if not code:
             code = self.sta_code.PASS
         raise WsRpsMsg(code, data, hint=hint)
 
-    def verify_str(self, val, require=False, default='', turn=0, minlen: int = None, maxlen: int = None, p_name=''):
+    def vf_str(self, val, require=False, default='', turn=0, minlen: int = None, maxlen: int = None, p_name=''):
         sta, val_info = verify.vstr(
             val, require=require, default=default, turn=turn, minlen=minlen, maxlen=maxlen, p_name=p_name)
         return val_info if sta else self.sendmsg(code=self.conf.STA_CODE.ERR_ARG, hint=val_info)
 
-    def verify_int(self, v, require=False, default=0, minval: int = None, maxval: int = None, inner=True, p_name=''):
+    def vf_int(self, v, require=False, default=0, minval: int = None, maxval: int = None, inner=True, p_name=''):
         sta, val_info = verify.vint(
             v, require=require, default=default, minval=minval, maxval=maxval, inner=inner, p_name=p_name)
         return val_info if sta else self.sendmsg(code=self.conf.STA_CODE.ERR_ARG, hint=val_info)
 
-    def verify_float(self, val, require=False, default=None, keep_val=3, minval: float or int = None,
-                     maxval: float or int = None, inner=True, p_name=''):
+    def vf_float(self, val, require=False, default=None, keep_val=3, minval: float or int = None,
+                 maxval: float or int = None, inner=True, p_name=''):
         sta, val_info = verify.vfloat(
             val, require=require, default=default, keep_val=keep_val, minval=minval, maxval=maxval,
             inner=inner, p_name=p_name)
         return val_info if sta else self.sendmsg(code=self.conf.STA_CODE.ERR_ARG, hint=val_info)
 
-    def verify_type(self, val, type_fun, require=False, default=None, is_int=True, p_name=''):
-        val = self.verify_int(val, require=require, default=default, p_name=p_name) if is_int else \
-            self.verify_str(val, require=require, default=default, p_name=p_name)
-        if val is None:
-            return default
-        if type_fun(val):
-            return val
-        return self.sendmsg(code=self.conf.STA_CODE.ERR_ARG, hint=f'{p_name}参数不在限定范围')
-
-    def verify_time(self, val, require=False, default=None, time_min=None, time_max=None, inner=True, p_name=''):
+    def vf_time(self, val, require=False, default=None, time_min=None, time_max=None, inner=True, p_name=''):
         sta, val_info = verify.vdatetime(
             val, require=require, default=default, time_min=time_min, time_max=time_max, inner=inner, p_name=p_name)
         return val_info if sta else self.sendmsg(code=self.conf.STA_CODE.ERR_ARG, hint=val_info)
```

## msanic/mult_creator.py

```diff
@@ -93,18 +93,18 @@
         return None
     if re.match(r'^[a-zA-Z0-9][a-zA-Z0-9.]*[a-zA-Z0-9]$', val):
         return val
     print('是否使用接口版本控制参数只能在数字、大小写字母和点之间选择，并且已数字或字母开头、以及结尾')
 
 
 engine_map = {
-    '1': ('tortoise.backends.asyncmy', 'python -m pip install tortoise-orm[asyncmy]'),
+    '1': ('tortoise.backends.mysql', 'python -m pip install tortoise-orm[asyncmy]'),
     '2': ('tortoise.backends.asyncpg', 'python -m pip install tortoise-orm[asyncpg]'),
-    '3': ('tortoise.backends.aiosqlite', 'python -m pip install tortoise-orm[aiosqlite]'),
-    '4': ('tortoise.backends.asyncodbc', 'python -m pip install tortoise-orm[asyncodbc]'),
+    # '3': ('tortoise.backends.aiosqlite', 'python -m pip install tortoise-orm[aiosqlite]'),
+    # '4': ('tortoise.backends.asyncodbc', 'python -m pip install tortoise-orm[asyncodbc]'),
 }
 
 
 def check_use_engine(val):
     val = val.strip()
     if not val:
         return '2'
@@ -149,15 +149,15 @@
 s_name = input_fun(check_name, tips='请输入服务名称(建议小写并用下划线连接，长度不超过20字)：')
 base_path = os.getcwd()
 server_path = add_module(base_path, s_name)
 if not server_path:
     raise FileExistsError('指定服务已存在，不能重复创建')
 s_id = input_fun(check_id, tips='请输入服务ID(三到六位，不区分大小写，默认随机)：')
 use_db = input_fun(check_db, tips='是否使用数据库(y(默认)/n)：')
-use_engine = input_fun(check_use_engine, tips='请选择使用的数据库存储引擎(1-mysql/2-pgsql(默认)/3-sqlite/4-sqlserver)：')
+use_engine = input_fun(check_use_engine, tips='请选择使用的数据库存储引擎(1-mysql/2-pgsql(默认))：')
 m_list = input_fun(check_m_list, tips='指定迁移模型文件名(多个请用分号隔开，默认使用main)：')
 o_list = input_fun(check_m_list, tips='指定不做迁移的模型文件名(多个请用分号隔开，默认使用extra)：')
 use_redis = input_fun(check_redis, tips='是否使用redis缓存(y(默认)/n)：')
 port = input_fun(check_port, tips='指定服务运行的端口号(80到65535之间的数字，默认8888)：')
 use_fast = input_fun(check_use_fast, tips='是否使用自动服务进程配置(y(默认)/n)：')
 use_ver = input_fun(check_ctrl_version, tips='接口版本控制默认版本(n(默认不启用)/数字字母或点的任意组合)：')
 use_mode = input_fun(check_use_mode, tips='指定的服务模式(1-http(默认),2-websocket,3-混合模式)：')
@@ -235,29 +235,29 @@
 
 conf_srv = {class_conf}()
 migrate_db = conf_srv.migrate_db()
 '''
 add_file(os.path.join(dir_config, '__init__.py'), content=init_data)
 
 enum_data = '''# coding=utf-8
-from msanic.libs.const import BaseEnum
+from msanic.libs.consts import BaseEnum
 
 
 # 请在此处创建枚举对象
 
 '''
 add_file(os.path.join(dir_config, 'consts.py'), content=enum_data)
 
 
 ws_model = '''from msanic.base_ws import RdsWS
 from msanic.libs.manager import WsConnector''' if use_mode in (2, 3) else ''
 ws_base = f'''\n\n\nclass BaseWS(RdsWS):
 
     conf = conf_srv
-    conn_manager = WsConnector''' if use_mode in (2, 3) else ''
+    ws_manager = WsConnector''' if use_mode in (2, 3) else ''
 api_data = f'''# coding=utf-8
 from msanic.handler_http import BaseHttpApi
 {ws_model}
 from {s_name}.config import conf_srv, ConfSrv
 
 
 class BaseApi(BaseHttpApi):
@@ -286,28 +286,30 @@
     # 路由请添加在这里
     DEFAULT_APIS = [
         # 结构为: 接口路由地址, 接口视图处理器, 版本号(可选), 接口命名(可选)
         Urls("/testapi", TestApi),
     ]
 '''
 add_file(os.path.join(server_path, 'url_main.py'), content=url_data)
-
+ws_proto = 'from msanic.base_ws import WsProtocol' if use_mode in (2, 3) else ''
+ws_run = 'main_server.run(protocol=WsProtocol)' if use_mode in (2, 3) else 'main_server.run()'
 start_data = '''# coding=utf-8
 from msanic.base_server import InitServer
 from msanic.exception import CatchExpt
 from msanic.middleware import CorsMiddle
+{1}
 from {0}.config import conf_srv as conf
 from {0}.url_main import MainBp
 
 signal_map = {{}}
 
 main_server = InitServer(conf, mws=[CorsMiddle], bps=[MainBp], excps=[CatchExpt])
 main_server.add_signal(signal_map)
 
 
 if __name__ == '__main__':
-    main_server.run()
-'''.format(s_name)
+    {2}
+'''.format(s_name, ws_proto, ws_run)
 add_file(os.path.join(base_path, f'{service_map.get(use_mode)}_{s_name}.py'), content=start_data)
 if use_db == 'y':
     os.system(engine_map.get(use_engine)[1])
     os.system('pip install aerich')
```

## msanic/libs/manager.py

```diff
@@ -1,32 +1,35 @@
+from typing import Union
+
+
 class WsConnector:
     """Websocket连接管理器"""
 
-    __COMM_MAP = {}
+    _WS_MAP = {}
 
     @classmethod
     def all_ws(cls):
-        return cls.__COMM_MAP.values()
+        return cls._WS_MAP.values()
 
     @classmethod
-    def get_ws(cls, key: (str, int, bytes)):
-        return cls.__COMM_MAP.get(key)
+    def get_ws(cls, key: Union[str, int, bytes]):
+        return cls._WS_MAP.get(key)
 
     @classmethod
     async def set_ws(cls, key: (str, int, bytes), ws):
         """更新连接，如果存在旧连接会关闭旧连接"""
         old_ws = cls.get_ws(key)
-        cls.__COMM_MAP[key] = ws
+        cls._WS_MAP[key] = ws
         old_ws and await old_ws.close()
 
     @classmethod
-    async def close_ws(cls, key: (str, int, bytes), msg: (str, bytes) = None):
+    async def close_ws(cls, key: Union[str, int, bytes], msg: Union[str, bytes] = None):
         ws = cls.get_ws(key)
         if ws:
-            cls.__COMM_MAP.pop(key)
+            cls._WS_MAP.pop(key)
             msg and await ws.send(msg)
             await ws.close()
 
 
 class HeaderSet:
 
     RESP_TYPE = {
```

## msanic/libs/tool_ws.py

```diff
@@ -1,40 +1,43 @@
 from typing import Union
 
+from sanic.server.protocols.websocket_protocol import WebSocketProtocol
+
+from msanic.libs.consts import Code, StaCode
 from msanic.libs.tool import json_encode, json_parse
 
 
 def pack_msg(
-        cmd_type: (int, str),
-        cmd_code: (int, str),
+        cmd_type: Union[int, str],
+        cmd_code: Union[int, str],
         data: Union[dict, list] = None,
-        sta_code: int = 0,
+        code: Code = StaCode.PASS,
         hint='',
         req=None,
         log_fun=None):
     """
     WS打包消息
     :param cmd_type: 消息命令类型
     :param cmd_code: 消息标识位
     :param data: 消息体数据
-    :param sta_code: 响应状态码
+    :param code: 响应状态码
     :param hint: 提示信息
     :param req: 客户端消息标记
     :param log_fun: 日志记录方法
     """
     cmd = None
     if isinstance(cmd_code, int) and isinstance(cmd_type, int):
         if 0 <= cmd_code < 1000:
             cmd = cmd_type * 1000 + cmd_code
     if isinstance(cmd_code, str) or isinstance(cmd_type, str):
         cmd = f'{cmd_type}.{cmd_code}'
     if cmd:
-        return json_encode(
-            {'cmd': cmd, 'data': data, 'code': sta_code, 'req': req, 'hint': hint}, use_byte=True, log_fun=log_fun)
-    err_info = f'打包消息出错,消息结构错误: {cmd_type}, {cmd_code},{data},{sta_code},{sta_code},{req}'
+        body = {'cmd': cmd, 'data': data, 'code': code.val, 'req': req, 'hint': hint or code.msg}
+        return json_encode(body, u_byte=True, log_fun=log_fun)
+    err_info = f'打包消息出错,消息结构错误: {cmd_type}, {cmd_code},{data},{code.val},{hint or code.msg},{req}'
     log_fun(err_info) if callable(log_fun) else print(err_info)
     return None
 
 
 def parse_msg(data, log_fun=None):
     """消息解析"""
     msg = json_parse(data, log_fun=log_fun)
```

## test/test_unit.py

```diff
@@ -1,15 +1,15 @@
 import asyncio
 import inspect
 
 from msanic.libs import tool_dt
 from msanic.libs.tool import json_encode
 
 
-a = json_encode({'a': 12321, '': "啊得到完全的撒", 'dtr': tool_dt.cur_dt().date()}, e_ascii=True)
+a = json_encode({'a': 12321, '': "啊得到完全的撒", 'dtr': tool_dt.cur_dt().date()})
 print(a)
 
 
 async def test1():
     print('test1')
     await asyncio.sleep(1)
```

## Comparing `msanic-1.0.17.dist-info/LICENSE` & `msanic-1.0.18.dist-info/LICENSE`

 * *Files identical despite different names*

## Comparing `msanic-1.0.17.dist-info/METADATA` & `msanic-1.0.18.dist-info/METADATA`

 * *Files 14% similar despite different names*

```diff
@@ -1,10 +1,10 @@
 Metadata-Version: 2.1
 Name: msanic
-Version: 1.0.17
+Version: 1.0.18
 Summary: A web framework who is use sanic + tortoise-orm + redis to quick create http&websocket server
 Author: DHDONG
 Author-email: zscych@qq.com
 License: MIT
 Keywords: WebServer,Sanic,WebSite Develop,Web Framework
 Classifier: Programming Language :: Python :: 3.9
 Classifier: Programming Language :: Python :: 3.10
```

## Comparing `msanic-1.0.17.dist-info/RECORD` & `msanic-1.0.18.dist-info/RECORD`

 * *Files 10% similar despite different names*

```diff
@@ -1,42 +1,42 @@
 msanic/__init__.py,sha256=47DEQpj8HBSa-_TImW-5JCeuQeRkm5NMpJWZG3hSuFU,0
 msanic/base_blue.py,sha256=ZTQRdgkmmjhcSHMjXHj0gypj3QDu3uKMrZ-LetvkmT4,3462
 msanic/base_conf.py,sha256=JXPyw_0GQ8mLCxzHWXS3EReWCxINDB40BfBVVa8JxvI,8536
 msanic/base_server.py,sha256=zqY89X4amLX-xIEr-jZliSTmVnAUH4amWCYwaTmJTSE,3241
-msanic/base_ws.py,sha256=spxJhcgItgnosRk1HW3Xp0E6PdyBw10drhM81i9Grhs,9187
+msanic/base_ws.py,sha256=lYo1WzMKQPDQWGJ22sA4kdga6_yoJnezggXgPlZFsf8,9749
 msanic/exception.py,sha256=iz1kGBWkcYQ3zwUjreEjojQ9BLFkCabqRTe70ttgBUQ,2908
 msanic/handler_http.py,sha256=MgyJSiwHAPkCP_dVqLZGaDCrVnz86_utqpg7e1-9UGE,7677
-msanic/handler_ws.py,sha256=KUGB6MJxbS6nOpKppCOTbg_voDmzWWvKGSd1AGEfZT0,3115
+msanic/handler_ws.py,sha256=n31R_rd97bnmsrodRsg3gLzgxBk42Jg3kjDthXt4MmE,2724
 msanic/middleware.py,sha256=YCgWTJlELPWWYdMbaHNUIgFFiKHQezMgko3b0g09m-A,576
-msanic/mult_creator.py,sha256=_6vgmPuIJVEAGaNUkCy_LfKpJt9wuSoTI9uwsTZtMCE,10187
+msanic/mult_creator.py,sha256=PrgZRUyHRXmDyQ5QmARhAKcszyVJ_xq45aXKTUxi9ew,10352
 msanic/verify.py,sha256=JVpivos9g7uBE6a08jI4BfhhsqJMWE-71tdrh2awRwc,8531
 msanic/libs/__init__.py,sha256=47DEQpj8HBSa-_TImW-5JCeuQeRkm5NMpJWZG3hSuFU,0
 msanic/libs/base_timed.py,sha256=IoPAOt_pRxA4_mQKOu_CMd1Mcu7ditijeKERTvzUZ0A,7656
 msanic/libs/component.py,sha256=21DIgD6RU6u36H2kuN0oA1uBdidULpYiZhpMqRX8hxk,1276
 msanic/libs/consts.py,sha256=OHIOgaLY8R8jZRiwDeEDg_3NN7kj-gZ_7HnP6Ccoq4c,3151
 msanic/libs/crypto.py,sha256=rCuzGGGYSZimdd8OhQCfIdZBUbBnX0FdPNO3sivy1L4,1578
 msanic/libs/decorator.py,sha256=SrQWbiYrUBE_0xHb9SF8-_KwUUqyRQvozQD3PIve_dM,3171
 msanic/libs/file_type.py,sha256=4OBdtXoNedXYpucs_99VdPfQw_Of6d8XFsRtTbGi8k0,1125
-msanic/libs/manager.py,sha256=eMjQTkJ5TNFrSkLkdidwyjbZTLSQ9Mi0EojEN-XH4uY,1735
+msanic/libs/manager.py,sha256=gEVyTayNazDUpurrb7NzmINZUZJyCNuIc0PAbnox5jA,1765
 msanic/libs/mult_log.py,sha256=wN-Wu2Q8byarCyu34mBmeBJUPIvmYZy6BVauifRoZDQ,2495
 msanic/libs/random_maker.py,sha256=-7ybIY0LrQ4eqvrCYc9kHBgnzqaEyRAYo57KOXKtRCA,5263
 msanic/libs/rds_client.py,sha256=QP9npHM0ixcBNEUf1lLmz85_ZJXzT-GDymzW2ZARWXQ,8453
 msanic/libs/rds_locker.py,sha256=Q8UkKAyHz4xdoG_oL0j5BfsBpTeKbW8sy7yDXwO62_E,1116
 msanic/libs/tool.py,sha256=7Bp0KkNMiuLnSATXccaBdW5Qz3FWaPykVNemfGu-Xb0,6985
 msanic/libs/tool_dt.py,sha256=ymTQBwxoUHigSX_L06LHDjzGBNmKjKXTLLAQBv_ssA8,5014
 msanic/libs/tool_jwt.py,sha256=cCdHNB16fp3MZfDT77ocUtHFtOrQjKu1qZL9x2iCI0A,3070
-msanic/libs/tool_ws.py,sha256=KCK8vBFl8OpDX6KxaIrfsVStRIqf4DFmTNmhYZK4nd8,1871
+msanic/libs/tool_ws.py,sha256=17HCilJU6_DC9BUnSxWzySVlcqa5h3KYAnIXR1UDFNo,2031
 msanic/orm/__init__.py,sha256=47DEQpj8HBSa-_TImW-5JCeuQeRkm5NMpJWZG3hSuFU,0
 msanic/orm/db_index.py,sha256=LmqneAZnHPfWsWNS4wH6F8iyZ56xtXtczglRFOZtgHA,730
 msanic/orm/db_model.py,sha256=Gd9Zm7DjiEH4xGEqM19Iar-2tTMY5lziRfaBlWOBLZ0,18726
 msanic/orm/mssql_generator.py,sha256=c9q71hljWqBxoNriG0OefwD48w3gVTb62HnFKjreom4,11698
 msanic/orm/mysql_generator.py,sha256=6AMVa9twa7GRCuTlEga5g2zHJvkCD9YocUwGGcvLQ4Q,11743
 msanic/orm/pgsql_generator.py,sha256=BMNDAZ-2X9dPbUOBlhR5UJBfqXWpl23KRgTozleKCCQ,11720
 msanic/orm/rc_model.py,sha256=NcgSVW34eSx_TiMYE9DYrA6Bt_qitTRH5pX3UYqa6ok,5098
 test/__init__.py,sha256=47DEQpj8HBSa-_TImW-5JCeuQeRkm5NMpJWZG3hSuFU,0
-test/test_unit.py,sha256=mJHn2hOiYpjez2oG3-56nFm66qZ7CMnBoYOtrwL9cug,715
-msanic-1.0.17.dist-info/LICENSE,sha256=GSAKapQH5ZIGWlpQTA7v5YrfECyaxaohUb1vJX-qepw,1090
-msanic-1.0.17.dist-info/METADATA,sha256=nMlu8QJD8kIeKv-l6JUms6eKNkVW0Q1YEx1gTZjlTbQ,878
-msanic-1.0.17.dist-info/WHEEL,sha256=GJ7t_kWBFywbagK5eo9IoUwLW6oyOeTKmQ-9iHFVNxQ,92
-msanic-1.0.17.dist-info/entry_points.txt,sha256=CAoZ_qtmP0HhzVmX9w0oN-KSxoCpdqxjDC4pljoU-l4,52
-msanic-1.0.17.dist-info/top_level.txt,sha256=lT96LXfr87NYrx1PR9GraMGNX9KQ6ImvR88MTHEhBkM,12
-msanic-1.0.17.dist-info/RECORD,,
+test/test_unit.py,sha256=zIZWr20nXYmLsKZpGZv-dmRuwQTJXyTcAcUDbx3FdF0,701
+msanic-1.0.18.dist-info/LICENSE,sha256=GSAKapQH5ZIGWlpQTA7v5YrfECyaxaohUb1vJX-qepw,1090
+msanic-1.0.18.dist-info/METADATA,sha256=CvXikghdmJ0xcXyDz6qXhC1mAngMEcK3ZIOA8t6vYds,878
+msanic-1.0.18.dist-info/WHEEL,sha256=GJ7t_kWBFywbagK5eo9IoUwLW6oyOeTKmQ-9iHFVNxQ,92
+msanic-1.0.18.dist-info/entry_points.txt,sha256=CAoZ_qtmP0HhzVmX9w0oN-KSxoCpdqxjDC4pljoU-l4,52
+msanic-1.0.18.dist-info/top_level.txt,sha256=lT96LXfr87NYrx1PR9GraMGNX9KQ6ImvR88MTHEhBkM,12
+msanic-1.0.18.dist-info/RECORD,,
```

